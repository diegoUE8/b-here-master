/**
 * @license b-here-master v1.0.0
 * (c) 2021 Luca Zampetti <lzampetti@gmail.com>
 * License: MIT
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("rxcomp"),require("rxcomp-form"),require("rxjs/operators"),require("rxjs"),require("three"),require("html2canvas")):"function"==typeof define&&define.amd?define(["rxcomp","rxcomp-form","rxjs/operators","rxjs","three","html2canvas"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).rxcomp,t.rxcomp.form,t.rxjs.operators,t.rxjs,t.THREE,t.html2canvas)}(this,(function(t,e,n,i,o,r){"use strict";function s(t,e,n,i,o,r,s){try{var a=t[r](s),u=a.value}catch(t){return void n(t)}a.done?e(u):Promise.resolve(u).then(i,o)}function a(t){return function(){var e=this,n=arguments;return new Promise((function(i,o){var r=t.apply(e,n);function a(t){s(r,i,o,a,u,"next",t)}function u(t){s(r,i,o,a,u,"throw",t)}a(void 0)}))}}function u(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function l(t,e,n){return e&&u(t.prototype,e),n&&u(t,n),t}function c(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function d(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function h(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}function p(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}r=r&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r;var m,f=function(){function t(){}return t.merge=function(t,e){var n=this;return"object"==typeof e&&Object.keys(e).forEach((function(i){var o=e[i];"object"!=typeof o||Array.isArray(o)?t[i]=o:t[i]=n.merge(t[i],o)})),t},t}(),v="undefined"!=typeof module&&module.exports,g=null!=(v?{get:function(){}}:new URLSearchParams(window.location.search)).get("debug"),b=v?null:document.querySelector("base").getAttribute("href"),y=!v&&(window&&-1!==window.location.host.indexOf("herokuapp")),w=!v&&(y||window&&("41789"===window.location.port||"5000"===window.location.port||"6443"===window.location.port||"diegoUE8.github.io"===window.location.host)),E=!v&&(window&&-1!==["localhost","127.0.0.1","0.0.0.0"].indexOf(window.location.host.split(":")[0])),x={STATIC:w,DEVELOPMENT:E,PRODUCTION:!E},T=function(){var t=e.prototype;function e(t){if(t){if("object"==typeof t.url){var e=t.language||"",n=t.market||"";Object.keys(t.url).forEach((function(i){t.url[i]=e+n+t.url[i]}))}Object.assign(this,t)}}return t.getAbsoluteUrl=function(t,e){var n=""+window.location.origin+t;return Object.keys(e).forEach((function(t){n=n.replace("$"+t,e[t])})),n},t.getPath=function(t){return this.isLocal(t)?this.href+t:t},t.isLocal=function(t){return-1===t.indexOf("://")},l(e,[{key:"STATIC",get:function(){return x.STATIC},set:function(t){x.STATIC=!0===t||"true"===t,console.log("Environment.STATIC.set",x.STATIC)}},{key:"href",get:function(){return y?this.githubDocs:b}}]),e}(),I=window.STATIC?{appKey:"865af1430a854af5b01733ff9b725a2b",channelName:"BHere",flags:{production:!1,useProxy:!1,useToken:!1,selfService:!0,guidedTourRequest:!0,editor:!0,ar:!0,menu:!0,attendee:!0,streamer:!0,viewer:!0,maxQuality:!1},logo:"/b-here/img/logo.png",background:{image:"/b-here/img/background.jpg",video:"/b-here/img/background.mp4"},colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},editor:{disabledViewTypes:["waiting-room","room-3d"],disabledViewItemTypes:["texture"]},assets:"./",worker:"./js/workers/image.service.worker.js",githubDocs:"https://raw.githubusercontent.com/diegoUE8/b-here-master/heroesvalley/docs/",language:"",market:"",url:{index:"/",access:"/",editor:"/editor",selfServiceTour:"/self-service-tour",guidedTour:"/guided-tour"},template:{tryInAr:"/try-in-ar.html?viewId=$viewId",modal:{controlRequest:"/control-request-modal.html",tryInAr:"/try-in-ar-modal.html",view:{panorama:"/panorama-modal.html","panorama-grid":"/panorama-grid-modal.html","room-3d":"/room-3d-modal.html",model:"/model-modal.html"},viewItem:{nav:"/nav-modal.html",plane:"/plane-modal.html","curved-plane":"/curved-plane-modal.html",texture:"/texture-modal.html",model:"/item-model-modal.html"},remove:"/remove-modal.html"}}}:{appKey:"865af1430a854af5b01733ff9b725a2b",channelName:"BHere",flags:{production:!0,useProxy:!1,useToken:!1,selfService:!0,guidedTourRequest:!0,editor:!1,ar:!0,menu:!0,attendee:!0,streamer:!0,viewer:!0,maxQuality:!1},logo:"/Modules/B-Here/Client/docs/img/logo.png",background:{image:"/Modules/B-Here/Client/docs/img/background.jpg",video:"/Modules/B-Here/Client/docs/img/background.mp4"},colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},editor:{disabledViewTypes:["waiting-room","room-3d"],disabledViewItemTypes:["texture"]},assets:"/Modules/B-Here/Client/docs/",worker:"/Modules/B-Here/Client/docs/js/workers/image.service.worker.js",githubDocs:"https://raw.githubusercontent.com/diegoUE8/b-here-master/heroesvalley/docs/",language:"/it",market:"/it",url:{index:"/",access:"/",editor:"/editor",selfServiceTour:"/self-service-tour",guidedTour:"/guided-tour"},template:{tryInAr:"/template/modules/b-here/try-in-ar.cshtml?viewId=$viewId",modal:{controlRequest:"/template/modules/b-here/control-request-modal.cshtml",tryInAr:"/template/modules/b-here/try-in-ar-modal.cshtml",view:{panorama:"/template/modules/b-here/panorama-modal.cshtml","panorama-grid":"/template/modules/b-here/panorama-grid-modal.cshtml","room-3d":"/template/modules/b-here/room-3d-modal.cshtml",model:"/template/modules/b-here/model-modal.cshtml"},viewItem:{nav:"/template/modules/b-here/nav-modal.cshtml",plane:"/template/modules/b-here/plane-modal.cshtml","curved-plane":"/template/modules/b-here/curved-plane-modal.cshtml",texture:"/template/modules/b-here/texture-modal.cshtml",model:"/template/modules/b-here/item-model-modal.cshtml"},remove:"/template/modules/b-here/remove-modal.cshtml"}}},R=Object.assign({port:5e3,fontFamily:"GT Walsheim, sans-serif",colors:{menuBackground:"#000000",menuForeground:"#ffffff",menuOverBackground:"#0099ff",menuOverForeground:"#ffffff",menuBackBackground:"#0099ff",menuBackForeground:"#000000",menuBackOverBackground:"#0099ff",menuBackOverForeground:"#ffffff"},editor:{disabledViewTypes:["waiting-room","room-3d"],disabledViewItemTypes:["texture"]},renderOrder:{panorama:0,model:10,plane:20,tile:30,banner:40,nav:50,panel:60,menu:70,debug:80,pointer:90}},{channelName:"BHere",flags:{production:!1,useProxy:!1,useToken:!1,selfService:!0,guidedTourRequest:!0,editor:!0,ar:!0,menu:!0,attendee:!0,streamer:!0,viewer:!0,maxQuality:!1}},I),C=new T(R=f.merge(R,window.bhere));console.log("environment",C);var k=f.merge(((m={browse:"Browse",cancel:"Cancel",drag_and_drop_images:"Drag And Drop your images here",error_email:"Invalid email",error_match:"Fields do not match",error_required:"Field is required",loading:"loading",remove:"Remove",required:"Required",select:"Select",select_file:"Select a file...",update:"Update",upload:"Upload",waiting_host:"waiting host",editor_image:"Image",editor_video:"Video",editor_model:"Model",editor_publisher_stream:"Publisher Stream",editor_next_attendee_stream:"Next Attendee Stream",editor_waiting_room:"Waiting Room",editor_panorama:"Panorama",editor_panorama_grid:"Panorama Grid",editor_room_3d:"Room 3D"}).editor_model="Model",m.editor_nav="Nav Tooltip",m.editor_gltf="Gltf Model",m.editor_plane="Plane",m.editor_curved_plane="Curved Plane",m.editor_texture="Texture",m),window.labels),M=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.transform=function(t){return k[t]||"#"+t+"#"},e.getKeys=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return this.transform(e.map((function(t){return t.replace("-","_")})).join("_"))},e}(t.Pipe);M.meta={name:"label"};var S=function(){function t(){}return t.http$=function(t,e,o,r){var s=this,a=null;return i.from(fetch(e,{method:t,headers:{Accept:"application/json","Content-Type":"application/json"},body:-1!==["POST","PUT","PATCH"].indexOf(t)?JSON.stringify(o):void 0}).then((function(t){a=t;try{var e,n=t.headers.get("content-type");return e=n&&-1!==n.indexOf("application/json")?t.json():t.text(),t.ok?e:e.then((function(t){return Promise.reject(t)}))}catch(e){return t.ok?(console.warn("HttpService.http$","Cannot parse response"),Promise.resolve()):Promise.reject(e)}}))).pipe(n.catchError((function(t){return i.throwError(s.getError(t,a))})))},t.get$=function(t,e,n){var i=this.query(e);return this.http$("GET",""+t+i,void 0,n)},t.delete$=function(t){return this.http$("DELETE",t)},t.post$=function(t,e){return this.http$("POST",t,e)},t.put$=function(t,e){return this.http$("PUT",t,e)},t.patch$=function(t,e){return this.http$("PATCH",t,e)},t.query=function(t){return""},t.getError=function(t,e){var n="object"==typeof t?t:{};return n.status||(n.status=e?e.status:0),n.statusCode||(n.statusCode=e?e.status:0),n.statusMessage||(n.statusMessage=e?e.statusText:t),n},t}(),$={Publisher:"publisher",Attendee:"attendee",Streamer:"streamer",Viewer:"viewer",SelfService:"self-service"},H=function(t){t&&Object.assign(this,t)},A=function(){function t(){}return t.setUser=function(t){this.user$.next(t)},t.me$=function(){var t=this;return S.get$("/api/user/me").pipe(n.map((function(e){return t.mapUser(e)})),n.catchError((function(t){if(404===t.status||404===t.statusCode)return i.of(null);throw t})),n.switchMap((function(e){return t.setUser(e),t.user$})))},t.login$=function(t){var e=this;return S.post$("/api/user/login",t).pipe(n.map((function(t){return e.mapUser(t)})),n.tap((function(t){return e.setUser(t)})))},t.logout$=function(){var t=this;return S.get$("/api/user/logout").pipe(n.map((function(e){return t.mapUser(e)})),n.tap((function(e){return t.setUser(null)})))},t.guidedTour$=function(t){var e=this;return S.post$("/api/user/guided-tour",t).pipe(n.map((function(t){return e.mapUser(t)})),n.tap((function(t){return e.setUser(t)})))},t.selfServiceTour$=function(t){var e=this;return S.post$("/api/user/self-service-tour",t).pipe(n.map((function(t){return e.mapUser(t)})),n.tap((function(t){return e.setUser(t)})))},t.resolve$=function(t,e){return"login"===e?this.login$(t):"guided-tour"===e?this.guidedTour$(t):"self-service-tour"===e?this.selfServiceTour$(t):void 0},t.log$=function(t){return S.post$("/api/user/log",t)},t.mapUser=function(t){return new H(t)},t}();A.user$=new i.BehaviorSubject(null);var P=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var o=i.prototype;return o.onInit=function(){this.env=C,this.state={status:"access"}},o.onSelfServiceTourRequest=function(){this.initRequestForm(),this.state.status="self-service-tour",this.pushChanges(),w&&-1!==window.navigator.userAgent.indexOf("OculusBrowser")&&(this.test(),this.onSubmit())},o.onGuidedTourRequest=function(){this.initRequestForm(),this.state.status="guided-tour",this.pushChanges()},o.onGuidedTourAccess=function(){A.logout$().pipe(n.first()).subscribe((function(){window.location.href=C.url.guidedTour}))},o.onLogin=function(){this.initLoginForm(),this.state.status="login",this.pushChanges()},o.initRequestForm=function(){var t=this;this.formSubscription&&this.formSubscription.unsubscribe();var i=this.form=new e.FormGroup({firstName:new e.FormControl(null,e.Validators.RequiredValidator()),lastName:new e.FormControl(null,e.Validators.RequiredValidator()),email:new e.FormControl(null,[e.Validators.RequiredValidator(),e.Validators.EmailValidator()]),role:new e.FormControl(null,e.Validators.RequiredValidator()),privacy:new e.FormControl(null,e.Validators.RequiredTrueValidator()),checkRequest:window.antiforgery||"",checkField:""}),o=this.data=window.data||{roles:[{id:1,name:"Show room"},{id:2,name:"Architetto"},{id:3,name:"Interior designer"},{id:4,name:"Privato"},{id:5,name:"Altro"}]},r=this.controls=i.controls,s=o.roles.slice();s.unshift({id:null,name:M.transform("select")}),r.role.options=s,this.formSubscription=i.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.pushChanges()})),this.error=null},o.initLoginForm=function(){var t=this;this.formSubscription&&this.formSubscription.unsubscribe();var i=this.form=new e.FormGroup({username:new e.FormControl(null,e.Validators.RequiredValidator()),password:new e.FormControl(null,e.Validators.RequiredValidator()),checkRequest:window.antiforgery||"",checkField:""});this.controls=i.controls;this.formSubscription=i.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.pushChanges()})),this.error=null},o.test=function(){"login"===this.state.status?this.form.patch({username:"publisher",password:"publisher",checkRequest:window.antiforgery||"",checkField:""}):this.form.patch({firstName:"Jhon",lastName:"Appleseed",email:"jhonappleseed@gmail.com",role:this.controls.role.options.find((function(t){return null!==t.id})).id,privacy:!0,checkRequest:window.antiforgery||"",checkField:""})},o.reset=function(){this.form.reset()},o.onBack=function(){this.state.status="access",this.pushChanges()},o.onSubmit=function(){var t=this;if(this.form.valid){this.form.submitted=!0;var e=this.form.value,i=this.state.status;A.resolve$(e,i).pipe(n.first()).subscribe((function(e){switch(console.log("AccessComponent.onSubmit",e),i){case"guided-tour":t.state.status="guided-tour-success",t.pushChanges();break;case"self-service-tour":window.location.href=C.url.selfServiceTour;break;case"login":window.location.href=C.url.guidedTour}t.form.reset()}),(function(e){console.log("AccessComponent.error",e),t.error=e,t.pushChanges()}))}else this.form.touched=!0},o.isValid=function(){var t=this.form.valid;return t},i}(t.Component);P.meta={selector:"[access-component]"};var _=function(){function t(){}return t.addSource=function(t){var e=t instanceof MediaStream?t.id:t;return this.sources_[e]||(t instanceof MediaStream?this.sources_[e]=this.context.createMediaStreamSource(t.clone()):this.sources_[e]=this.context.createMediaElementSource(t)),this.sources_[e]},t.removeSource=function(t){var e=t instanceof MediaStream?t.id:t;return this.removeSourceKey(e)},t.removeSourceKey=function(t){var e;return this.sources_[t]&&(e=this.sources_[t],this.analyser&&e.disconnect(this.analyser),e.disconnect(),delete this.sources_[t]),e},t.frequency$=function(e,o){var r=this;if(void 0===o&&(o=64),o%2==1)throw o;var s=new Uint8Array(o/2);if(this.context){var a=this.analyser;a.fftSize=o,this.addSource(e).connect(a);var u=new i.BehaviorSubject(s);return t.frame$.pipe(n.withLatestFrom(u),n.map((function(t){t[0];var e=t[1];return a.getByteFrequencyData(e),e})),n.tap((function(t){return u.next(t)})),n.finalize((function(){r.removeSource(e)})))}return i.of(s)},t.volume$=function(e){var o=this,r={volume:0,clipped:!1};if(this.context){var s=this.addSource(e),a=t.audioMeterCreate();s.connect(a);var u=new i.BehaviorSubject(r);return t.frame$.pipe(n.withLatestFrom(u),n.map((function(t){t[0];var e=t[1];return e.clipped=a.checkClipping(),e.volume=a.volume,e})),n.tap((function(t){return u.next(t)})),n.finalize((function(){o.removeSource(e)})))}return i.of(r)},t.audioMeterCreate=function(t,e,n){void 0===t&&(t=.98),void 0===e&&(e=.95),void 0===n&&(n=750);var i=this.context;if(i){var o=i.createScriptProcessor(512);return o.onaudioprocess=this.audioMeterProcess,o.checkClipping=this.audioMeterClip,o.dispose=this.audioMeterDispose,o.clipping=!1,o.lastClip=0,o.volume=0,o.clipLevel=t,o.averaging=e,o.clipLag=n,o.connect(i.destination),o}},t.audioMeterProcess=function(t){for(var e,n=t.inputBuffer.getChannelData(0),i=n.length,o=0,r=0;r<i;r++)e=n[r],Math.abs(e)>=this.clipLevel&&(this.clipping=!0,this.lastClip=window.performance.now()),o+=e*e;var s=Math.sqrt(o/i);this.volume=Math.max(s,this.volume*this.averaging)},t.audioMeterClip=function(){return!!this.clipping&&(this.lastClip+this.clipLag<window.performance.now()&&(this.clipping=!1),this.clipping)},t.audioMeterDispose=function(){this.disconnect(),this.onaudioprocess=null},t.step$=function(t){return i.Observable.create((function(e){requestAnimationFrame((function(n){var i=t?(n-t.startTime)/1e3:0;e.next({startTime:n,deltaTime:i})}))})).pipe(n.map((function(t){return t.deltaTime>1/30&&(t.deltaTime=1/30),t})))},t.dispose=function(){var t=this,e=this.analyser;Object.keys(this.sources_).forEach((function(e){t.removeSourceKey(e)})),e.disconnect(),this.sources_={}},l(t,null,[{key:"context",get:function(){return!this.context_&&"AudioContext"in window&&(this.context_=new AudioContext),this.context_}},{key:"analyser",get:function(){return this.analyser_||(this.analyser_=this.context.createAnalyser()),this.analyser_}}]),t}();_.sources_={},_.frame$=i.of(void 0).pipe(n.expand((function(t){return _.step$(t)})),n.filter((function(t){return void 0!==t})),n.map((function(t){return t.deltaTime})),n.share());var O="unknown",L="ios",U="android",V="windowsPhone",D="vrHeadset",F=function(){function t(){}return t.getDevicePlatform=function(){var t=navigator.userAgent||navigator.vendor||window.opera;return/windows phone/i.test(t)?V:/android/i.test(t)?U:this.isIOS?L:this.isVRHeadset?D:O},l(t,null,[{key:"platform",get:function(){return this.platform_||(this.platform_=this.getDevicePlatform()),this.platform_}},{key:"isIOS",get:function(){return-1!==["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].indexOf(navigator.platform)||-1!==navigator.userAgent.indexOf("Mac")&&"ontouchend"in document}},{key:"isVRHeadset",get:function(){return-1!==navigator.userAgent.indexOf("VR")||-1!==navigator.userAgent.indexOf("Quest")||-1!==navigator.userAgent.indexOf("Oculus")}}]),t}(),j=function(){function t(){}return t.patchState=function(t){t=Object.assign({},this.state,t),this.state=t},l(t,null,[{key:"state",set:function(t){this.state$.next(t)},get:function(){return this.state$.getValue()}}]),t}();c(j,"state$",new i.BehaviorSubject({}));var B=[{profile:"4K",resolution:{width:3840,height:2160},frameRate:{min:15,max:30},bitrate:{min:8910,max:13500}},{profile:"1440p",resolution:{width:2560,height:1440},frameRate:{min:15,max:30},bitrate:{min:4850,max:7350}},{profile:"1080p",resolution:{width:1920,height:1080},frameRate:{min:15,max:30},bitrate:{min:2080,max:4780}},{profile:"720p_3",resolution:{width:1280,height:720},frameRate:{min:15,max:30},bitrate:{min:1130,max:1710}},{profile:"240p_1",resolution:{width:320,height:240},frameRate:{min:15,max:15},bitrate:{min:140,max:200}}];function G(t){var e=B[B.length-1],n=C.flags.maxQuality?B[0]:B[B.length-2];return t.role===$.Publisher?n:e}var z="link",q="name",N="device",W="should-connect",K="connecting",X="connected",Y="agoraEvent",Q="requestControl",J="requestControlAccepted",Z="requestControlRejected",tt="requestControlDismiss",et="requestControlDismissed",nt="requestPeerInfo",it="requestPeerInfoResult",ot="requestInfo",rt="requestInfoResult",st="requestInfoDismiss",at="requestInfoDismissed",ut="requestInfoRejected",lt="controlInfo",ct="addLike",dt="showPanel",ht="playMedia",pt="navToView",mt="navToGrid",ft="vrStarted",vt="vrEnded",gt="vrState",bt="menuToggle",yt=function(t){Object.assign(this,t)},wt=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(yt),Et=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(yt),xt=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(yt),Tt=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(yt),It=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(yt),Rt=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(yt),Ct=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(yt),kt=function(e){function i(){return e.apply(this,arguments)||this}h(i,e);var o=i.prototype;return o.onInit=function(){this.platform=F.platform;var e=t.getContext(this).node,n=this.preview=e.querySelector("video");this.onLoadedMetadata=this.onLoadedMetadata.bind(this),n.addEventListener("loadedmetadata",this.onLoadedMetadata);var i=e.querySelector(".audio");if(this.hasPreview)this.bars=new Array(32).fill(0).map((function(t){var e=document.createElement("div");return e.classList.add("bar"),i.appendChild(e),e}))},o.onDestroy=function(){this.preview.removeEventListener("loadedmetadata",this.onLoadedMetadata),this.hasPreview&&_.dispose()},o.initStream=function(){var t=this,e=this.preview;if(this.preview)if(this.video_||this.audio_){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var n=G(j.state),i={video:!!this.video_&&{deviceId:this.video_,width:{ideal:n.resolution.width},height:{ideal:n.resolution.height},frameRate:{ideal:n.frameRate.min,max:n.frameRate.max}},audio:!!this.audio_&&{deviceId:this.audio_}};console.log("AgoraDevicePreviewComponent.initStream.getUserMedia",i),navigator.mediaDevices.getUserMedia(i).then((function(n){t.hasPreview?("srcObject"in e?e.srcObject=n:e.src=window.URL.createObjectURL(n),t.audio_&&t.analyzeData(n),t.loadingStream_=n):t.stream.next(n)})).catch((function(e){console.log("AgoraDevicePreviewComponent.initStream.error",e.name,e.message),t.stream.next(null)}))}}else this.hasPreview&&("srcObject"in e?e.srcObject=null:e.src=null,this.analyzeData(null)),this.stream.next(null)},o.onLoadedMetadata=function(t){this.preview.play(),this.stream.next(this.loadingStream_)},o.analyzeData=function(t){var e=this;this.frequencySubscription&&this.frequencySubscription.unsubscribe(),t&&(this.frequencySubscription=_.frequency$(t,64).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.bars.forEach((function(e,n){var i=Math.min(100,5+t[n])/100;e.style.left=3.125*n+"%",e.style.transform="scale(1,"+i+")",e.style.opacity=i}))})))},l(i,[{key:"video",get:function(){return this.video_},set:function(t){this.video_!==t&&(this.video_=t,this.change&&(this.change.next(),this.initStream()))}},{key:"audio",get:function(){return this.audio_},set:function(t){this.audio_!==t&&(this.audio_=t,this.change&&(this.change.next(),this.initStream()))}},{key:"hasPreview",get:function(){return this.platform!==L&&this.platform!==D}}]),i}(t.Component);kt.meta={selector:"[agora-device-preview]",outputs:["stream","change"],inputs:["video","audio"]};var Mt=function(){function t(){this.events={}}var e=t.prototype;return e.on=function(t,e){var n=this,i=this.events[t]=this.events[t]||[];return i.push(e),function(){n.events[t]=i.filter((function(t){return t!==e}))}},e.off=function(t,e){var n=this.events[t];n&&(this.events[t]=n.filter((function(t){return t!==e})))},e.once=function(t,e){var n=this,i=function i(o){e(o),n.off(t,i)};this.on(t,i)},e.emit=function(t,e){var n=this.events[t];n&&n.forEach((function(t){t(e)}));var i=this.events.broadcast;i&&i.forEach((function(n){n(t,e)}))},e.has=function(t){var e=this.events[t];return e&&e.length},t}(),St=function(){function t(){}return t.message=function(t){this.message$.next(t)},t.in=function(t){this.in$.next(t)},t.sendBack=function(t){t=Object.assign({},t,{remoteId:t.clientId}),this.in$.next(t)},t.out=function(t){this.out$.next(t)},t}();c(St,"message$",new i.ReplaySubject(1)),c(St,"in$",new i.ReplaySubject(1)),c(St,"send",St.in),c(St,"out$",new i.ReplaySubject(1));var $t="client",Ht="editor",At=function(){function t(){}return t.orderedRemotes$=function(){return i.combineLatest([t.remotes$,i.interval(1e3)]).pipe(n.map((function(t){var e=[];return t[0].forEach((function(t){t.clientInfo&&(t.clientInfo.audioLevel=t.getAudioLevel(),t.clientInfo.peekAudioLevel=Math.max(t.clientInfo.audioLevel,.2)),e.push(t)})),e.sort((function(t,e){return t.clientInfo&&e.clientInfo?t.clientInfo.role===$.Publisher?-1:e.clientInfo.role===$.Publisher?1:e.clientInfo.peekAudioLevel-t.clientInfo.peekAudioLevel||(t.clientInfo.order||0)-(e.clientInfo.order||0):0})),e.forEach((function(t,e){t.clientInfo&&(t.clientInfo.order=e)})),e.length=Math.min(e.length,8),e})),n.distinctUntilChanged((function(t,e){return t.map((function(t){return t.clientInfo?t.clientInfo.uid:""})).join("|")===e.map((function(t){return t.clientInfo?t.clientInfo.uid:""})).join("|")})))},t.editorStreams$=function(){var t=this;return i.of(null).pipe(n.switchMap((function(){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&t.mode===Ht){var e=document.querySelector("body"),n=document.createElement("div"),i=document.createElement("video");n.setAttribute("id","stream-editor"),n.setAttribute("style","position:absolute; top: 5000px; line-height: 0;"),n.appendChild(i),e.appendChild(n),navigator.mediaDevices.getUserMedia({video:{width:800,height:450}}).then((function(e){"srcObject"in i?i.srcObject=e:i.src=window.URL.createObjectURL(e),i.oncanplay=function(){var e={getId:function(){return"editor"},clientInfo:{role:$.Publisher}},n={getId:function(){return"editor"},clientInfo:{role:$.Attendee}};t.editor$.next([e,n,n,n,n])},i.play()})).catch((function(t){console.log("EditorComponent.getUserMedia.error",t.name,t.message)}))}return t.editor$})),n.shareReplay(1))},t.getPublisherStreamId$=function(){var t=this,e=this.publisherStreamId;return e?i.of(e):this.streams$.pipe(n.map((function(){return t.publisherStreamId})),n.filter((function(t){return t})))},t.getRemoteById=function(e){var n=t.remotes.find((function(t){return t.getId()===e}));if(n)return n},l(t,null,[{key:"editor",set:function(t){this.editor$.next(t)},get:function(){return this.editor$.getValue()}},{key:"local",set:function(t){this.local$.next(t)},get:function(){return this.local$.getValue()}},{key:"remotes",set:function(t){this.remotes$.next(t)},get:function(){return this.remotes$.getValue()}},{key:"peers",set:function(t){this.peers$.next(t)},get:function(){return this.peers$.getValue()}},{key:"publisherStreamId",get:function(){var t=this.remotes.slice(),e=this.local;e&&t.unshift(e);var n=t.find((function(t){return t.clientInfo&&t.clientInfo.role===$.Publisher}));return n?n.getId():null}}]),t}();c(At,"mode",$t),c(At,"editor$",new i.BehaviorSubject(null)),c(At,"local$",new i.BehaviorSubject(null)),c(At,"remotes$",new i.BehaviorSubject([])),c(At,"peers$",new i.BehaviorSubject([])),c(At,"streams$",i.combineLatest([At.local$,At.remotes$,At.editorStreams$()]).pipe(n.map((function(t){var e,n=t[0],i=t[1],o=t[2],r=i;(n&&(r=r.slice()).push(n),o)&&(e=r).push.apply(e,o);return r})),n.shareReplay(1)));var Pt=function(t){function e(n){var i;if(e.AGORA)throw"AgoraService is a singleton";(i=t.call(this)||this).onStreamPublished=i.onStreamPublished.bind(p(i)),i.onStreamUnpublished=i.onStreamUnpublished.bind(p(i)),i.onStreamAdded=i.onStreamAdded.bind(p(i)),i.onStreamRemoved=i.onStreamRemoved.bind(p(i)),i.onStreamSubscribed=i.onStreamSubscribed.bind(p(i)),i.onMuteVideo=i.onMuteVideo.bind(p(i)),i.onUnmuteVideo=i.onUnmuteVideo.bind(p(i)),i.onMuteAudio=i.onMuteAudio.bind(p(i)),i.onUnmuteAudio=i.onUnmuteAudio.bind(p(i)),i.onVolumeIndicator=i.onVolumeIndicator.bind(p(i)),i.onPeerConnect=i.onPeerConnect.bind(p(i)),i.onPeerLeaved=i.onPeerLeaved.bind(p(i)),i.onConnectionStateChange=i.onConnectionStateChange.bind(p(i)),i.onTokenPrivilegeWillExpire=i.onTokenPrivilegeWillExpire.bind(p(i)),i.onTokenPrivilegeDidExpire=i.onTokenPrivilegeDidExpire.bind(p(i)),i.onMessage=i.onMessage.bind(p(i));var o=j.state;return j.patchState({devices:o.role!==$.Attendee&&n?n:{videos:[],audios:[]},quality:G(o),membersCount:0}),i}h(e,t),e.getSingleton=function(t){if(!g)return this.AGORA||(this.AGORA=new e(t)),this.AGORA};var o=e.prototype;return o.addStreamDevice=function(t){this.removeStreamDevice();var e={deviceId:"video-stream",label:"videostream",kind:"videostream",src:t},n={deviceId:"audio-stream",label:"videostream",kind:"videostream",src:t},i=j.state.devices;i.videos.push(e),i.audios.push(n),j.patchState({devices:i})},o.removeStreamDevice=function(){var t=j.state.devices;t.videos=t.videos.filter((function(t){return"videostream"!==t.kind})),t.audios=t.audios.filter((function(t){return"videostream"!==t.kind})),j.patchState({devices:t})},o.devices$=function(){var t=j.state.devices,e=this.defaultVideos=this.defaultVideos||t.videos.slice(),n=this.defaultAudios=this.defaultAudios||t.videos.slice();return t.videos=e.slice(),t.audios=n.slice(),i.from(new Promise((function(e,n){var i=function(){AgoraRTC.getDevices((function(i){o.close();for(var r=0;r<i.length;r++){var s=i[r];"videoinput"===s.kind&&s.deviceId&&t.videos.push({label:s.label||"camera-"+t.videos.length,deviceId:s.deviceId,kind:s.kind}),"audioinput"===s.kind&&s.deviceId&&t.audios.push({label:s.label||"microphone-"+t.audios.length,deviceId:s.deviceId,kind:s.kind})}t.videos.length>0||t.audios.length>0?e(t):n(t)}))},o=AgoraRTC.createStream({audio:!0,video:!0});o.init((function(){i()}),(function(){i()}))})))},o.connect$=function(t){var e=this,n=j.state.devices;return t&&(n.video=t.video,n.audio=t.audio),j.state.connecting||(j.patchState({status:K,connecting:!0,devices:n}),setTimeout((function(){e.createClient((function(){var t=e.getChannelNameLink();e.rtcToken$(t).subscribe((function(n){e.join(n.token,t)}))}))}),250)),j.state$},o.membersCount$=function(t){var e=this.messageClient;return i.interval(2e3).pipe(n.switchMap((function(){return i.from(e.getChannelMemberCount([t]))})),n.map((function(e){return e[t]})),n.distinctUntilChanged())},o.observeMemberCount=function(){this.unobserveMemberCount(),this.membersCountSubscription=this.membersCount$(j.state.channelNameLink).subscribe((function(t){j.patchState({membersCount:t})}))},o.unobserveMemberCount=function(){this.membersCountSubscription&&(this.membersCountSubscription.unsubscribe(),this.membersCountSubscription=null,j.patchState({membersCount:0}))},o.rtcToken$=function(t){return C.flags.useToken?S.post$("/api/token/rtc",{channelName:t,uid:null}):i.of({token:null})},o.rtmToken$=function(t){return C.flags.useToken?S.post$("/api/token/rtm",{uid:t}):i.of({token:null})},o.createClient=function(t){var e=this;this.client&&t(),AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.NONE);var n=this.client=AgoraRTC.createClient({mode:"live",codec:"h264"}),i=function(){C.flags.useProxy&&n.startProxyServer(),n.init(C.appKey,(function(){t()}),(function(t){e.client=null}))};j.state.role===$.Viewer?n.setClientRole("audience",(function(t){t||i()})):i(),n.on("stream-published",this.onStreamPublished),n.on("stream-unpublished",this.onStreamUnpublished),n.on("stream-added",this.onStreamAdded),n.on("stream-subscribed",this.onStreamSubscribed),n.on("mute-video",this.onMuteVideo),n.on("unmute-video",this.onUnmuteVideo),n.on("mute-audio",this.onMuteAudio),n.on("unmute-audio",this.onUnmuteAudio),n.on("error",this.onError),n.on("peer-online",this.onPeerConnect),n.on("peer-leave",this.onPeerLeaved),n.on("stream-removed",this.onStreamRemoved),n.on("onTokenPrivilegeWillExpire",this.onTokenPrivilegeWillExpire),n.on("onTokenPrivilegeDidExpire",this.onTokenPrivilegeDidExpire),(this.messageClient=AgoraRTM.createInstance(C.appKey,{logFilter:AgoraRTM.LOG_FILTER_OFF})).setParameters({logFilter:AgoraRTM.LOG_FILTER_OFF})},o.getChannelNameLink=function(){var t=j.state.link||"",e=t.match(/(\d{9})-(\d{4})-(\d{13})/);return e&&(t=e[1]+"-"+e[3]),j.state.channelName+"-"+t},o.join=function(t,e){var n=this;this.channel=null;this.client.join(t,e,null,(function(t){j.patchState({status:X,channelNameLink:e,connected:!0,uid:t}),n.rtmToken$(t).subscribe((function(e){n.joinMessageChannel(e.token,t).then((function(e){j.state.role!==$.Viewer&&(n.autoDetectDevice(),n.createMediaStream(t,j.state.devices.video,j.state.devices.audio)),n.observeMemberCount()}),(function(t){console.log("joinMessageChannel.error",t)}))}))}),(function(t){console.log("AgoraService.join.error",t),"DYNAMIC_KEY_EXPIRED"===t&&n.rtcToken$(e).subscribe((function(t){n.join(t.token,e)}))}))},o.joinMessageChannel=function(t,e){var n,i=this;return new Promise((function(o,r){var s=i.messageClient;s.login({token:t,uid:e.toString()}).then((function(){return(n=s.createChannel(j.state.channelNameLink)).join()})).then((function(){n.on("ChannelMessage",i.onMessage),i.channel=n,i.emit("channel",n),o(e)})).catch(r)}))},o.detectDevices=function(t){AgoraRTC.getDevices((function(e){for(var n=[],i=[],o=0;o<e.length;o++){var r=e[o];"videoinput"==r.kind&&n.push({label:r.label||"camera-"+n.length,deviceId:r.deviceId,kind:r.kind}),"audioinput"==r.kind&&i.push({label:r.label||"microphone-"+n.length,deviceId:r.deviceId,kind:r.kind})}t({videos:n,audios:i})}))},o.getVideoOptions=function(t,e){return new Promise((function(n,i){if(e)if("videostream"===e.kind){var o=document.querySelector("#"+e.deviceId);o.crossOrigin="anonymous";var r=new Hls;r.attachMedia(o),r.on(Hls.Events.MEDIA_ATTACHED,(function(){r.loadSource(e.src),r.on(Hls.Events.MANIFEST_PARSED,(function(e,i){o.play().then((function(e){var i=o.captureStream();t.videoSource=i.getVideoTracks()[0],n(t)}),(function(t){console.log("AgoraService.getVideoOptions.error",t)}))}))}))}else if("videoplayer"===e.kind||"videostream"===e.kind){var s=document.querySelector("#"+e.deviceId);s.crossOrigin="anonymous";var a=s.captureStream();t.videoSource=a.getVideoTracks()[0],n(t)}else t.cameraId=e.deviceId,n(t);else n(t)}))},o.getAudioOptions=function(t,e){return new Promise((function(n,i){if(e)if("videostream"===e.kind){var o=document.querySelector("#"+e.deviceId);o.crossOrigin="anonymous";var r=new Hls;r.attachMedia(o),r.on(Hls.Events.MEDIA_ATTACHED,(function(){r.loadSource(e.src),r.on(Hls.Events.MANIFEST_PARSED,(function(e,i){r.loadLevel=i.levels.length-1,o.play().then((function(e){var i=o.captureStream();t.audioSource=i.getAudioTracks()[0],n(t)}),(function(t){console.log("AgoraService.getAudioOptions.error",t)}))}))}))}else if("videoplayer"===e.kind||"videostream"===e.kind){var s=document.querySelector("#"+e.deviceId);s.crossOrigin="anonymous";var a=s.captureStream();t.audioSource=a.getAudioTracks()[0],n(t)}else t.microphoneId=e.deviceId,n(t);else n(t)}))},o.autoDetectDevice=function(){},o.createMediaStream=function(t,e,n){var i=this,o={streamID:t,video:Boolean(e),audio:Boolean(n),screen:!1};Promise.all([this.getVideoOptions(o,e),this.getAudioOptions(o,n)]).then((function(t){var e=Object.assign({},j.state.quality);i.createLocalStreamWithOptions(o,e)}))},o.createLocalStreamWithOptions=function(t,e){var n=this,i=AgoraRTC.createStream(t);e&&(i.setVideoProfile(e.profile),i.setVideoEncoderConfiguration(e)),i.init((function(){At.local=i,setTimeout((function(){n.publishLocalStream()}),1)}),(function(t){console.log("AgoraService.initLocalStream.init.error",t)}))},o.initLocalStream=function(){var t=this;At.local.init((function(){t.publishLocalStream()}),(function(t){console.log("AgoraService.initLocalStream.init.error",t)}))},o.publishLocalStream=function(){var t=this.client,e=At.local;t.publish(e,(function(t){console.log("AgoraService.publishLocalStream.error",e.getId(),t)})),e.clientInfo={role:j.state.role,name:j.state.name,uid:j.state.uid},At.local=e},o.unpublishLocalStream=function(){var t=this.client,e=At.local;e&&t.unpublish(e,(function(t){console.log("AgoraService.unpublishLocalStream.error",e.getId(),t)})),At.local=null},o.leaveChannel=function(){var t=this;return j.patchState({connecting:!1}),this.unpublishLocalStream(),At.remotes=[],At.peers=[],new Promise((function(e,n){t.leaveMessageChannel().then((function(){var i=t.client;i.leave((function(){t.client=null,C.flags.useProxy&&i.stopProxyServer(),e()}),(function(t){console.log("AgoraService.leaveChannel.error",t),n(t)}))}),n)}))},o.leaveMessageChannel=function(){var t=this;return new Promise((function(e,n){t.unobserveMemberCount();var i=t.channel,o=t.messageClient;i.leave().then((function(){t.channel=null,o.logout().then((function(){t.messageClient=null,e()}),n)}),n)}))},o.toggleCamera=function(){var t=At.local;t&&t.video&&(t.userMuteVideo?(t.unmuteVideo(),j.patchState({cameraMuted:!1}),this.broadcastEvent(new Tt({streamId:t.getId()}))):(t.muteVideo(),j.patchState({cameraMuted:!0}),this.broadcastEvent(new xt({streamId:t.getId()}))))},o.toggleAudio=function(){var t=At.local;t&&t.audio&&(t.userMuteAudio?(t.unmuteAudio(),j.patchState({audioMuted:!1}),this.broadcastEvent(new Rt({streamId:t.getId()}))):(t.muteAudio(),j.patchState({audioMuted:!0}),this.broadcastEvent(new It({streamId:t.getId()}))))},o.toggleControl=function(){var t=this;j.state.control?this.sendRemoteControlDismiss().then((function(t){j.patchState({control:!t})})):j.state.spying?this.sendRemoteInfoDismiss(j.state.spying).then((function(e){j.patchState({spying:!1}),t.sendRemoteControlRequest().then((function(t){j.patchState({control:t})}))})):this.sendRemoteControlRequest().then((function(t){j.patchState({control:t})}))},o.toggleSpy=function(t){var e=this;j.state.control?this.sendRemoteControlDismiss().then((function(n){j.patchState({control:!1}),e.sendSpyRemoteRequestInfo(t).then((function(e){j.patchState({spying:t})}))})):j.state.spying?this.sendRemoteInfoDismiss(j.state.spying).then((function(n){j.state.spying!==t?e.sendSpyRemoteRequestInfo(t).then((function(e){j.patchState({spying:t})})):j.patchState({spying:!1})})):this.sendSpyRemoteRequestInfo(t).then((function(e){j.patchState({spying:t})}))},o.newMessageId=function(){return j.state.uid+"-"+Date.now().toString()},o.sendRemoteControlDismiss=function(){var t=this;return new Promise((function(e,n){t.sendMessage({type:tt,messageId:t.newMessageId()}).then((function(t){t.type===et?e(!0):t.type===Z&&e(!1)}))}))},o.sendRemoteControlRequest=function(){var t=this;return new Promise((function(e,n){t.sendMessage({type:Q,messageId:t.newMessageId()}).then((function(t){t.type===J?e(!0):t.type===Z&&e(!1)}))}))},o.sendRemoteRequestPeerInfo=function(t){var e=this;return new Promise((function(n,i){e.sendMessage({type:nt,messageId:e.newMessageId(),remoteId:t}).then((function(t){if(t.type===it){if(t.clientInfo.role===$.Publisher){var i={hosted:!0};!0===t.clientInfo.control&&(i.locked=!0,e.sendControlRemoteRequestInfo(t.clientInfo.uid)),j.patchState(i)}n(t)}}))}))},o.sendControlRemoteRequestInfo=function(t){var e=this;return new Promise((function(n,i){e.sendMessage({type:ot,messageId:e.newMessageId(),remoteId:t}).then((function(t){t.type===rt&&n(t)}))}))},o.sendSpyRemoteRequestInfo=function(t){var e=this;return new Promise((function(n,i){e.sendMessage({type:ot,messageId:e.newMessageId(),remoteId:t}).then((function(e){e.type===rt&&(j.patchState({spying:t}),n(e))}))}))},o.sendRemoteInfoDismiss=function(t){var e=this;return new Promise((function(n,i){e.sendMessage({type:st,messageId:e.newMessageId(),remoteId:t}).then((function(t){t.type===at?n(!0):t.type===ut&&n(!1)}))}))},o.navToView=function(t){(j.state.control||j.state.spyed)&&this.sendMessage({type:pt,viewId:t})},o.getSessionStats=function(){this.client.getSessionStats((function(t){console.log("Current Session Duration: "+t.Duration),console.log("Current Session UserCount: "+t.UserCount),console.log("Current Session SendBytes: "+t.SendBytes),console.log("Current Session RecvBytes: "+t.RecvBytes),console.log("Current Session SendBitrate: "+t.SendBitrate),console.log("Current Session RecvBitrate: "+t.RecvBitrate)}))},o.getSystemStats=function(){this.client.getSystemStats((function(t){console.log("Current battery level: "+t.BatteryLevel)}))},o.sendMessage=function(t){var e=this;return new Promise((function(n,i){if(j.state.connected){switch(t.clientId=j.state.uid,t.type){case lt:case mt:case dt:case ht:if(!j.state.control&&!j.state.spyed)return}var o=function(t,i){try{var o=JSON.stringify(t);t.messageId&&e.once("message-"+t.messageId,(function(t){n(t)})),i.sendMessage({text:o}).then((function(){t.messageId||n(t)})).catch((function(t){console.log("AgoraService.sendMessage.error",t)}))}catch(t){console.log("AgoraService.sendMessage.error",t)}},r=e.channel;if(r)o(t,r);else try{e.once("channel",(function(e){o(t,e)}))}catch(t){i(t)}}}))},o.checkBroadcastMessage=function(t){switch(t.type){case tt:j.patchState({locked:!1}),this.sendMessage({type:et,messageId:t.messageId});break;case st:j.patchState({spyed:!1}),this.sendMessage({type:at,messageId:t.messageId,remoteId:t.remoteId});break;case rt:(j.state.role===$.Publisher||j.state.locked)&&this.broadcastMessage(t);break;case lt:case dt:case ht:case pt:case mt:(j.state.locked||j.state.spying&&j.state.spying===t.clientId)&&this.broadcastMessage(t);break;default:this.broadcastMessage(t)}},o.broadcastMessage=function(t){St.out(t)},o.broadcastEvent=function(t){St.out({type:Y,event:t})},o.onMessage=function(t,e){if(e!==j.state.uid){var n=JSON.parse(t.text);if(n.messageId&&this.has("message-"+n.messageId)&&this.emit("message-"+n.messageId,n),n.remoteId&&n.remoteId!==j.state.uid)return;if(n.type===ft){var i=document.createElement("div");i.classList.add("player__vr"),n.container=i}this.checkBroadcastMessage(n)}},o.onError=function(t){console.log("AgoraService.onError",t)},o.onStreamPublished=function(t){var e=At.local;e.clientInfo={role:j.state.role,name:j.state.name,uid:j.state.uid},At.local=e},o.onStreamUnpublished=function(t){At.local=null},o.onStreamAdded=function(t){var e=this.client,n=t.stream;n&&(n.getId()!==j.state.uid&&e.subscribe(n,(function(t){console.log("AgoraService.onStreamAdded.subscribe.error",t)})))},o.onStreamRemoved=function(t){var e=t.stream.getId();e!==j.state.uid&&this.remoteRemove(e)},o.onStreamSubscribed=function(t){this.remoteAdd(t.stream)},o.onPeerConnect=function(t){this.peerAdd(t)},o.onPeerLeaved=function(t){var e=t.uid;if(e!==j.state.uid){var n=this.remoteRemove(e);n.clientInfo&&(n.clientInfo.role===$.Publisher?j.patchState({hosted:!1,locked:!1,control:!1,spyed:!1}):j.state.spying===e&&j.patchState({spying:!1}))}this.peerRemove(e)},o.peerAdd=function(t){var e={uid:t.uid},n=At.peers;n.push(e),At.peers=n,this.broadcastEvent(new wt({peer:e}))},o.peerRemove=function(t){var e=At.peers,n=e.find((function(e){return e.uid===t}));n&&(e.splice(e.indexOf(n),1),At.peers=e)},o.remoteAdd=function(t){var e=At.remotes;e.push(t),At.remotes=e,this.broadcastEvent(new Et({stream:t}));var n=t.getId();this.sendRemoteRequestPeerInfo(n).then((function(t){var e=At.remotes,i=e.find((function(t){return t.getId()===n}));i&&(i.clientInfo=t.clientInfo),At.remotes=e}))},o.remoteRemove=function(t){var e=At.remotes,n=e.find((function(e){return e.getId()===t}));return n&&(n.isPlaying()&&n.stop(),e.splice(e.indexOf(n),1),At.remotes=e,n.clientInfo&&n.clientInfo.role===$.Publisher&&j.patchState({hosted:!1})),n},o.onMuteVideo=function(t){this.broadcastEvent(new xt({streamId:t.uid}))},o.onUnmuteVideo=function(t){this.broadcastEvent(new Tt({streamId:t.uid}))},o.onMuteAudio=function(t){this.broadcastEvent(new It({streamId:t.uid}))},o.onUnmuteAudio=function(t){this.broadcastEvent(new Rt({streamId:t.uid}))},o.onVolumeIndicator=function(t){var e=t.attr.map((function(t){return{streamId:t.uid,level:t.level}}));this.broadcastEvent(new Ct({streams:e}))},o.onConnectionStateChange=function(t){console.log("AgoraService.onConnectionStateChange",t)},o.onTokenPrivilegeWillExpire=function(t){console.log("AgoraService.onTokenPrivilegeWillExpire");var e=this.client,n=this.getChannelNameLink();this.rtcToken$(n).subscribe((function(t){t.token&&(e.renewToken(t.token),console.log("AgoraService.onTokenPrivilegeWillExpire.renewed"))}))},o.onTokenPrivilegeDidExpire=function(t){console.log("AgoraService.onTokenPrivilegeDidExpire");var e=this.client,n=this.getChannelNameLink();this.rtcToken$(n).subscribe((function(t){t.token&&(e.renewToken(t.token),console.log("AgoraService.onTokenPrivilegeDidExpire.renewed"))}))},e}(Mt),_t=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var o=i.prototype;return o.onInit=function(){var t=this;if(this.platform=F.platform,this.isHttps="https:"===window.location.protocol,this.state={},this.devices={videos:[],audios:[]},this.stream=null,this.form=null,this.isHttps){var e=this.agora=Pt.getSingleton();j.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.state=e,t.pushChanges()})),e&&e.devices$().subscribe((function(e){t.devices=e,t.initForm(e),t.pushChanges()}))}},o.openHttps=function(t){window.location.href=window.location.href.replace("http://","https://").replace(":5000",":6443")},o.initForm=function(t){var i=this,o=this.form=new e.FormGroup({video:new e.FormControl(null,t.videos.length?e.Validators.RequiredValidator():void 0),audio:new e.FormControl(null,t.audios.length?e.Validators.RequiredValidator():void 0)}),r=this.controls=o.controls,s=t.videos.map((function(t){return{id:t.deviceId,name:t.label}}));s.length>0&&s.unshift({id:null,name:M.transform("bhere_select_video")}),r.video.options=s;var a=t.audios.map((function(t){return{id:t.deviceId,name:t.label}}));a.length>0&&a.unshift({id:null,name:M.transform("bhere_select_audio")}),r.audio.options=a,o.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){i.pushChanges()}))},o.onStreamDidChange=function(t){this.stream=null,this.pushChanges()},o.onStream=function(t){this.stream=t,this.pushChanges()},o.isValid=function(){var t=this.form.valid&&(this.stream||!this.hasPreview);return t},o.onEnter=function(t){var e=this.form.value,n=this.devices;n.video=n.videos.find((function(t){return t.deviceId===e.video})),n.audio=n.audios.find((function(t){return t.deviceId===e.audio})),this.enter.next(n)},l(i,[{key:"hasPreview",get:function(){return this.platform!==L&&this.platform!==D}}]),i}(t.Component);_t.meta={selector:"[agora-device]",outputs:["enter"]};var Ot=function(){function t(){}return t.has=function(t){return new URLSearchParams(window.location.search).has(t)},t.get=function(t){return new URLSearchParams(window.location.search).get(t)},t.set=function(t,e){var n=new URLSearchParams(window.location.search);"string"==typeof t?n.set(t,e):n.set(t,""),this.replace(n)},t.replace=function(t){if(window.history&&window.history.pushState){var e=document.title,n=window.location.href.split("?")[0]+"?"+t.toString();window.history.pushState(t.toString(),e,n)}},t.deserialize=function(t){var e=this.get("params");return this.decode(t,e)},t.serialize=function(t,e){var n=this.deserialize(),i=this.encode(t,e,n);this.set("params",i)},t.decode=function(t,e){var n=null;if(e){var i=window.atob(e);n=JSON.parse(i)}return t&&n&&(n=n[t]),n||null},t.encode=function(t,e,n){n=n||{};"string"==typeof t?n[t]=e:n=t;var i=JSON.stringify(n);return window.btoa(i)},t}(),Lt=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var o=i.prototype;return o.onInit=function(){var t=this;this.flags=C.flags,this.editorLink=C.url.editor,this.state={};var i=this.form=new e.FormGroup({link:new e.FormControl(null,[e.Validators.PatternValidator(/^\d{9}-\d{4}-\d{13}$/),e.Validators.RequiredValidator()]),linkAttendee:null,linkStreamer:null,linkViewer:null});this.controls=i.controls;i.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.pushChanges()})),j.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.state=e,t.pushChanges()}))},o.onGenerateMeetingId=function(t){var e=(new Date).valueOf().toString();this.form.patch({link:this.getRoleMeetingId(e,$.Publisher),linkAttendee:this.getRoleMeetingId(e,$.Attendee),linkStreamer:this.getRoleMeetingId(e,$.Streamer),linkViewer:this.getRoleMeetingId(e,$.Viewer)})},o.replaceRoleMeetingId=function(t,e){var n=t.split("-");return n[1]=this.padded(this.getRoleIndex(e),4),n.join("-")},o.onInputDidChange=function(t){var e=this;"publisher"===this.state.role&&setTimeout((function(){if(e.form.get("link").valid){var t=e.form.get("link").value;e.form.patch({link:e.setRoleMeetingId(t,$.Publisher),linkAttendee:e.setRoleMeetingId(t,$.Attendee),linkStreamer:e.setRoleMeetingId(t,$.Streamer),linkViewer:e.setRoleMeetingId(t,$.Viewer)})}else e.form.get("linkAttendee").reset(),e.form.get("linkStreamer").reset(),e.form.get("linkViewer").reset()}),1)},o.setRoleMeetingId=function(t,e){var n=t.split("-");return n[0]+"-"+this.padded(this.getRoleIndex(e),4)+"-"+n[2]},o.getRoleMeetingId=function(t,e){return this.padded(this.state.user.id,9)+"-"+this.padded(this.getRoleIndex(e),4)+"-"+t},o.getRoleIndex=function(t){return Object.keys($).reduce((function(e,n,i){return $[n]===t?i:e}),-1)},o.onCopyToClipBoard=function(t){var e=document.createElement("input");e.style.position="absolute",e.style.top="1000vh",document.querySelector("body").appendChild(e),e.value=this.getUrl(t,!0),e.focus(),e.select(),e.setSelectionRange(0,99999),document.execCommand("copy"),e.parentNode.removeChild(e),alert("link copiato!\n "+e.value)},o.isValid=function(){var t=this.form.valid;return t},o.onNext=function(t){var e=this.controls.link.value;this.replaceUrl(e),this.link.next(e)},o.getUrl=function(t,e){void 0===e&&(e=!1);var n=Ot.get("role")||null,i=Ot.get("name")||null;return""+window.location.origin+window.location.pathname+"?link="+t+(i?"&name="+i:"")+(n&&!e?"&role="+n:"")},o.replaceUrl=function(t){if("history"in window){var e=this.getUrl(t);window.history.replaceState({pageTitle:window.pageTitle},"",e)}},o.padded=function(t,e){var n="000000000"+t;return n.substr(n.length-e)},l(i,[{key:"heroku",get:function(){return y}}]),i}(t.Component);Lt.meta={selector:"[agora-link]",outputs:["link"]};var Ut=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var o=i.prototype;return o.onInit=function(){var t=this,i=Ot.get("name")||null;this.state={};var o=this.form=new e.FormGroup({name:new e.FormControl(i,[e.Validators.PatternValidator(/^\w{2,}\s\w{2,}/),e.Validators.RequiredValidator()])});this.controls=o.controls;o.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.pushChanges()})),j.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.state=e,t.pushChanges()}))},o.isValid=function(){var t=this.form.valid;return t},o.onNext=function(t){this.replaceUrl(),this.name.next(this.controls.name.value)},o.replaceUrl=function(){if("history"in window){var t=Ot.get("role")||null,e=Ot.get("link")||null,n=""+window.location.origin+window.location.pathname+"?link="+e+"&name="+this.controls.name.value+(t?"&role="+t:"");window.history.replaceState({pageTitle:window.pageTitle},"",n)}},i}(t.Component);Ut.meta={selector:"[agora-name]",outputs:["name"]};var Vt=function(e){function i(){return e.apply(this,arguments)||this}h(i,e);var o=i.prototype;return o.onInit=function(){var t=this;this.videoMuted=!1,this.audioMuted=!1,this.shouldUseResumeGesture=!1,this.state={},j.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.state=e,t.pushChanges()})),St.out$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){switch(e.type){case Y:var n=e.event;t.streamId&&n.streamId===t.streamId&&(n instanceof xt&&(t.videoMuted=!0),n instanceof Tt&&(t.videoMuted=!1),n instanceof It&&(t.audioMuted=!0),n instanceof Rt&&(t.audioMuted=!1));break;case ft:t.streamId===e.clientId&&(t.vrContainer=e.container);break;case vt:t.streamId===e.clientId&&(t.vrContainer=null)}}))},o.setMediaStream=function(t){var e=this.videoNode;"srcObject"in e?e.srcObject=t:e.src=t?window.URL.createObjectURL(t):null},o.onLoadedMetadata=function(t){this.videoNode.play().then((function(t){}),(function(t){console.log("AgoraStreamComponent.play.error",t)}))},o.onToggleSpy=function(t){this.toggleSpy.next(t)},l(i,[{key:"videoMuted",set:function(e){if(this.videoMuted_!==e){this.videoMuted_=e;var n=t.getContext(this).node;e?n.classList.add("video--muted"):n.classList.remove("video--muted")}}},{key:"audioMuted",set:function(e){if(this.audioMuted_!==e){this.audioMuted_=e;var n=t.getContext(this).node;e?n.classList.add("audio--muted"):n.classList.remove("audio--muted")}}},{key:"streamId",get:function(){return this.streamId_},set:function(t){this.streamId_=t}},{key:"stream",get:function(){return this.stream_},set:function(e){if(this.stream_!==e){for(var n=t.getContext(this).node,i=this.player=n.querySelector(".agora-stream__player");i.childElementCount>0;)i.removeChild(i.firstElementChild);this.stream_&&this.stream_.isPlaying()&&this.stream_.player.div.parentNode===i&&this.stream_.stop(),this.stream_=e,e&&(this.videoMuted=e.userMuteVideo,this.audioMuted=e.userMuteAudio);var o=e?e.getId():null;if(this.streamId=o,o){var r="stream-"+o;i.setAttribute("id",r);var s=this;e.isPlaying()?i.appendChild(e.player.div):(this.shouldUseResumeGesture=!1,e.play(r,{fit:"cover"},(function(t){t&&"aborted"!==t.status&&(s.shouldUseResumeGesture=!0,s.pushChanges())})))}else i.removeAttribute("id")}}},{key:"vrContainer",set:function(t){this.vrContainer_!==t&&(this.vrContainer_=t,t?(this.stream_.vrContainer=t,this.player.appendChild(t)):this.stream_.vrContainer&&this.stream_.vrContainer.parentNode&&(this.stream_.vrContainer.parentNode.removeChild(this.stream_.vrContainer),this.stream_.vrContainer=null))}},{key:"videoNode",get:function(){var e=this.videoNode_;if(!e){var n=t.getContext(this).node.querySelector(".agora-stream__player");e=document.createElement("video"),this.onLoadedMetadata=this.onLoadedMetadata.bind(this),e.addEventListener("loadedmetadata",this.onLoadedMetadata),n.appendChild(e),this.videoNode_=e}return e}}]),i}(t.Component);Vt.meta={selector:"[agora-stream]",outputs:["toggleSpy"],inputs:["stream"]};var Dt=function(){function t(){}return t.push=function(t){return function(t){(window.dataLayer||[]).push(t),console.log("GtmService.dataLayer",t)}(t)},t}(),Ft=function(t){this.data=t},jt=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(Ft),Bt=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(Ft),Gt=function(){function t(){}return t.open$=function(t){var e=this;return this.getTemplate$(t.src).pipe(n.map((function(n){return{node:e.getNode(n),data:t.data,modal:t}})),n.tap((function(t){return e.modal$.next(t)})),n.switchMap((function(t){return e.events$})))},t.load$=function(t){},t.getTemplate$=function(t){return i.from(fetch(t).then((function(t){return t.text()})))},t.getNode=function(t){var e=document.createElement("div");return e.innerHTML=t,e.firstElementChild},t.reject=function(t){this.modal$.next(null),this.events$.next(new Bt(t))},t.resolve=function(t){this.modal$.next(null),this.events$.next(new jt(t))},t}();Gt.modal$=new i.Subject,Gt.events$=new i.Subject;var zt=function(e){function i(){return e.apply(this,arguments)||this}h(i,e);var o=i.prototype;return o.onInit=function(){var e=this,i=t.getContext(this).node;this.modalNode=i.querySelector(".modal-outlet__modal"),Gt.modal$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.modal=t}))},o.reject=function(t){Gt.reject()},l(i,[{key:"modal",get:function(){return this.modal_},set:function(e){var n=t.getContext(this).module;if(this.modal_&&this.modal_.node&&(n.remove(this.modal_.node,this),this.modalNode.removeChild(this.modal_.node)),e&&e.node){this.modal_=e,this.modalNode.appendChild(e.node);n.compile(e.node)}this.modal_=e,this.pushChanges()}}]),i}(t.Component);zt.meta={selector:"[modal-outlet]",template:'\n\t<div class="modal-outlet__container" [class]="{ active: modal }">\n\t\t<div class="modal-outlet__background" (click)="reject($event)"></div>\n\t\t<div class="modal-outlet__modal"></div>\n\t</div>\n\t'};var qt=function(e){function n(){return e.apply(this,arguments)||this}h(n,e);var i=n.prototype;return i.onInit=function(){e.prototype.onInit.call(this);var i=t.getContext(this),o=i.parentInstance,r=i.node;if(o instanceof zt){var s=this.data=o.modal.data;if(s&&s.ar){var a=n.getUrl(s);new QRious({element:r.querySelector(".qrcode"),value:a,size:256})}}},i.close=function(){Gt.reject()},n.getUrl=function(t){var e=C.getAbsoluteUrl(C.template.tryInAr,{viewId:t.id});return console.log("TryInARModalComponent.getUrl",e),e},n.openInAR=function(t){var e=this.getUrl(t);window.open(e,"_blank")},n}(t.Component);qt.meta={selector:"[try-in-ar-modal]"};var Nt={WaitingRoom:{id:1,name:"waiting-room"},Panorama:{id:2,name:"panorama"},PanoramaGrid:{id:3,name:"panorama-grid"},Room3d:{id:4,name:"room-3d"},Model:{id:5,name:"model"}},Wt={Nav:{id:1,name:"nav"},Plane:{id:2,name:"plane"},CurvedPlane:{id:3,name:"curved-plane"},Model:{id:4,name:"model"},Texture:{id:5,name:"texture"}},Kt=function(){function t(t){t&&(Object.assign(this,t),this.updateIndices(t.items)),this.items=(this.items||[]).map((function(t){return ne(t)})),this.tiles&&(this.tiles=this.tiles.map((function(t){return ie(t)}))),this.originalItems=this.items.slice()}return t.prototype.updateIndices=function(t){if(t){var e=0;t.forEach((function(t,n){t.index=n,t.asset&&"nextAttendeeStream"===t.asset.file&&(t.asset.index=e++)}))}},l(t,[{key:"payload",get:function(){var e=this,n={};return Object.keys(this).forEach((function(i){if(-1!==t.allowedProps.indexOf(i))switch(i){case"items":n[i]=e[i].map((function(t){return ne(t).payload}));break;case"tiles":n[i]=e[i].map((function(t){return ie(t).payload}));break;default:n[i]=e[i]}})),n}},{key:"shortType",get:function(){return this.type?this.type.split("-").map((function(t){return t.substring(0,1).toUpperCase()})).join(""):"??"}}]),t}();c(Kt,"allowedProps",["id","type","name","hidden","likes","asset","items","orientation","zoom","ar","tiles","invertAxes","flipAxes"]);var Xt=function(t){function e(e){return t.call(this,e)||this}return h(e,t),e}(Kt),Yt=function(t){function e(n){var o;return n.tiles=e.mapTiles(n.tiles,n.flipAxes,n.invertAxes,n.asset?n.asset.folder:""),(o=t.call(this,n)||this).index_=0,o.index$=new i.Subject,o.tiles.forEach((function(t,e){return t.selected=0===e})),o.tiles.length&&(o.items=o.originalItems.concat(o.tiles[0].navs),o.asset=o.tiles[0].asset),o}h(e,t),e.mapTiles=function(t,e,n,i){void 0===t&&(t=[]),void 0===e&&(e=!1),void 0===n&&(n=!1),void 0===i&&(i="");var o=e?-1:1;return t.map((function(t,e){var r=new THREE.Vector2;return(t="string"==typeof t?{id:e+1,asset:{folder:i,file:t},navs:[]}:t).asset.file.replace(/_x([-|\d]+)_y([-|\d]+)/g,(function(t,e,i){n?(r.y=parseInt(e),r.x=parseInt(i)*o):(r.x=parseInt(e),r.y=parseInt(i)*o)})),{id:t.id,asset:t.asset,navs:t.navs||[],indices:r}}))},l(e,[{key:"index",set:function(t){this.index_!==t&&(this.index_=t,this.tiles.forEach((function(e,n){return e.selected=n===t})),this.updateCurrentItems(),this.index$.next(t))},get:function(){return this.index_}}]);var n=e.prototype;return n.updateCurrentItems=function(){this.items=this.originalItems.concat(this.tiles[this.index_].navs)},n.getTileIndex=function(t,e){return this.tiles.reduce((function(n,i,o){return i.indices.x===t&&i.indices.y===e?o:n}),-1)},n.hasTile=function(t,e){return-1!==this.getTileIndex(t,e)},n.getTile=function(t,e){var n=this.getTileIndex(t,e);if(-1!==n)return this.index=n,this.tiles[n]},e}(Kt),Qt=function(t){function e(e){return t.call(this,e)||this}return h(e,t),e}(Kt),Jt=function(){function t(t){t&&Object.assign(this,t)}return l(t,[{key:"payload",get:function(){var e=this,n={};return Object.keys(this).forEach((function(i){-1!==t.allowedProps.indexOf(i)&&(n[i]=e[i])})),!n.link||n.link.title&&n.link.href||delete n.link,n}},{key:"hasPanel",get:function(){return this.type.name===Wt.Nav.name&&(this.title&&""!==this.title||this.abstract&&""!==this.abstract||this.asset||this.link)}}]),t}();c(Jt,"allowedProps",["id","type","title","abstract","asset","link","viewId","keepOrientation","position","rotation","scale","radius","height","arc"]);var Zt=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(Jt),te=function(){function t(t){t&&Object.assign(this,t),this.navs=(this.navs||[]).map((function(t){return ne(t)})),this.originalItems=this.navs.slice()}return l(t,[{key:"payload",get:function(){var e=this,n={};return Object.keys(this).forEach((function(i){if(-1!==t.allowedProps.indexOf(i))switch(i){case"navs":n[i]=e[i].map((function(t){return ne(t).payload}));break;default:n[i]=e[i]}})),n}}]),t}();function ee(t){switch(t.type.name){case Nt.Panorama.name:t=new Xt(t);break;case Nt.PanoramaGrid.name:t=new Yt(t);break;case Nt.Model.name:t=new Qt(t);break;default:t=new Kt(t)}return t}function ne(t){switch(t.type.name){case Wt.Nav.name:t=new Zt(t);break;default:t=new Jt(t)}return t}function ie(t){return new te(t)}c(te,"allowedProps",["id","asset","navs"]);var oe=function(){function t(){}return t.data$=function(){if(!this.data$_){var t=C.flags.production?"/api/view":"./api/data.json";this.data$_=S.get$(t).pipe(n.map((function(t){return t.views=t.views.map((function(t){return ee(t)})),t})),n.shareReplay(1))}return this.data$_},t.view$=function(t,e){var i=this,o=e?t.views:t.views.filter((function(t){return"waiting-room"!==t.type.name})),r=Ot.has("viewId")?parseInt(Ot.get("viewId")):o.length?o[0].id:null;return this.viewId$_.next(r),this.viewId$_.pipe(n.distinctUntilChanged(),n.map((function(e){return t.views.find((function(t){return t.id===e}))||i.getWaitingRoom(t)})))},t.hostedView$=function(t){var e=this.getWaitingRoom(t);return i.combineLatest([this.view$(t),this.hosted$()]).pipe(n.map((function(t){var n=t[0];return t[1]?n:e})),n.tap((function(t){t.id!==e.id&&Ot.set("viewId",t.id)})))},t.editorView$=function(t){var e=this.getWaitingRoom(t);return this.view$(t,!0).pipe(n.tap((function(t){t.id!==e.id&&Ot.set("viewId",t.id)})))},t.hosted$=function(){return j.state$.pipe(n.map((function(t){return t.hosted})),n.distinctUntilChanged())},t.viewById$=function(t){return this.data$().pipe(n.map((function(e){return e.views.find((function(e){return e.id===t}))})))},t.viewLike$=function(t){return t.liked?i.of(null):(t.liked=!0,C.flags.production?S.get$("/api/view/"+t.id+"/like"):(t.likes=t.likes||0,t.likes++,i.of(t)))},t.setViewLike$=function(t){return this.viewById$(t.viewId).pipe(n.tap((function(e){e&&(e.likes=t.likes)})))},t.getWaitingRoom=function(t){return t&&t.views.find((function(t){return"waiting-room"===t.type.name}))||{id:"waiting-room",type:{id:1,name:"waiting-room"},name:"Waiting Room",likes:0,liked:!1,asset:{type:{id:1,name:"image"},folder:"/textures/waiting-room/",file:"waiting-room.jpg"},items:[],orientation:{latitude:0,longitude:0}}},l(t,null,[{key:"viewId",set:function(t){this.viewId$_.next(t)},get:function(){return this.viewId$_.getValue()}}]),t}();c(oe,"viewId$_",new i.BehaviorSubject(null));var re="waiting",se="enabled",ae="ended",ue="started",le="disabled",ce="needs-https",de="unavailable",he=function(){function t(){var e=this;if(t.service_)throw"VRService is a singleton class!";var n=this.state_={camera:{position:new THREE.Vector3,quaternion:new THREE.Quaternion,scale:new THREE.Vector3,array:new Array(10).fill(0)}};this.onSessionStarted=this.onSessionStarted.bind(this),this.onSessionEnded=this.onSessionEnded.bind(this),this.status$=new i.BehaviorSubject(re),this.session$=new i.Subject,this.state$=new i.BehaviorSubject(n),this.currentSession=null,"xr"in navigator?navigator.xr.isSessionSupported("immersive-vr").then((function(t){t?e.status$.next(se):e.status$.next(le)})):!1===window.isSecureContext?this.status$.next(ce):this.status$.next(de)}t.getService=function(){return this.service_||(this.service_=new t),this.service_},l(t,[{key:"status",get:function(){return this.status$.getValue()}},{key:"state",get:function(){return this.state$.getValue()}}]);var e=t.prototype;return e.onSessionStarted=function(t){t.addEventListener("end",this.onSessionEnded),this.currentSession=t,this.session$.next(t),this.status$.next(ue)},e.onSessionEnded=function(){this.currentSession.removeEventListener("end",this.onSessionEnded),this.currentSession=null,this.session$.next(null),this.status$.next(ae)},e.toggleVR=function(t){if(null===this.currentSession){navigator.xr.requestSession("immersive-vr",{optionalFeatures:["local-floor","bounded-floor"]}).then(this.onSessionStarted)}else this.currentSession.end()},e.isDisabled=function(){switch(this.status$.getValue()){case re:case le:case ce:case de:return!0;default:return!1}},e.getLabel=function(){var t;switch(this.status$.getValue()){case re:t="Waiting VR";break;case se:case ae:t="Enter VR";break;case ue:t="Exit VR";break;case le:t="VR Disabled";break;case ce:t="VR Needs Https";break;case de:t="VR Unavailable"}return t},e.updateState=function(t){if(this.status===ue){t.renderer,t.scene;var e=t.camera,n=this.state_;e.matrixWorld.decompose(n.camera.position,n.camera.quaternion,n.camera.scale),n.camera.array[0]=n.camera.position.x,n.camera.array[1]=n.camera.position.y,n.camera.array[2]=n.camera.position.z,n.camera.array[3]=n.camera.quaternion.x,n.camera.array[4]=n.camera.quaternion.y,n.camera.array[5]=n.camera.quaternion.z,n.camera.array[6]=n.camera.quaternion.w,n.camera.array[7]=n.camera.scale.x,n.camera.array[8]=n.camera.scale.y,n.camera.array[9]=n.camera.scale.z,this.state$.next(n)}},t}(),pe=function(e){function i(){return e.apply(this,arguments)||this}h(i,e);var o=i.prototype;return o.onInit=function(){var e=this;t.getContext(this).node.classList.remove("hidden"),this.env=C,this.platform=F.platform,this.state={},this.hosted=null,this.data=null,this.views=null,this.view=null,this.form=null,this.local=null,this.remotes=[],(this.vrService=he.getService()).status$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){return e.pushChanges()})),this.resolveUser()},o.getLinkRole=function(){var t=null,e=(Ot.get("link")||"").match(/\d{9}-(\d{4})-\d{13}/);if(e){var n=parseInt(e[1]);t=Object.keys($).reduce((function(t,e,i){return i===n?$[e]:t}),null)}return t},o.resolveUser=function(){var t=this;A.me$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){var n=t.getLinkRole();!e||n&&n!==e.type?n===$.Publisher||n===$.Attendee?window.location.href=C.url.access:t.initWithUser({type:n}):t.initWithUser(e)}))},o.initWithUser=function(t){var e=this;console.log("AgoraComponent.initWithUser",t);var i=t.firstName&&t.lastName?t.firstName+" "+t.lastName:null,o=Ot.get("role")||t.type,r=Ot.get("name")||i,s=Ot.get("link")||null,a=o===$.Publisher,u=!g&&o!==$.SelfService,l={user:t,role:o,name:r,link:s,channelName:C.channelName,uid:null,status:"idle",connecting:!1,connected:!1,locked:!1,control:!1,spyed:!1,hosted:a,live:u,cameraMuted:!1,audioMuted:!1};j.state=l,j.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.state=t,e.hosted=t.hosted,e.pushChanges()})),this.loadView()},o.loadView=function(){var t=this;this.initAgora(),oe.data$().pipe(n.switchMap((function(e){return t.data=e,t.views=e.views.filter((function(t){return"waiting-room"!==t.type.name})),oe.hostedView$(e)})),n.takeUntil(this.unsubscribe$),n.tap((function(e){t.agora&&t.agora.navToView(e.id),t.view=e,t.pushChanges()}))).subscribe((function(t){console.log("AgoraComponent.hostedView$",t)}))},o.initAgora=function(){var t,e=this,i=null;g||this.state.role===$.SelfService?j.patchState({status:X,hosted:!0}):(i=this.agora=Pt.getSingleton(),t=this.state.link?this.state.name?this.state.role!==$.Viewer?N:W:q:z,j.patchState({status:t}));At.local$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.local=t,e.pushChanges()})),At.orderedRemotes$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.remotes=t,e.pushChanges()})),St.out$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){switch(t.type){case nt:t.type=it,t.clientInfo={role:j.state.role,name:j.state.name,uid:j.state.uid,control:j.state.control},St.sendBack(t);break;case Q:console.log("AgoraComponent","MessageType.RequestControlAccepted"),t.type=J,St.sendBack(t),j.patchState({locked:!0}),e.agora&&e.agora.sendControlRemoteRequestInfo(t.clientId);break;case pt:if(t.viewId&&oe.viewId!==t.viewId&&(oe.viewId=t.viewId,void 0!==t.gridIndex)){var i=e.data.views.find((function(e){return e.id===t.viewId}));i instanceof Yt&&(i.index=t.gridIndex)}break;case ct:oe.setViewLike$(t).pipe(n.first()).subscribe((function(t){return e.showLove(t)}))}})),St.in$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){i&&i.sendMessage(t)})),i&&j.state.status===W&&this.connect()},o.onLink=function(t){j.state.name?j.state.role===$.Viewer?this.connect():j.patchState({link:t,status:N}):j.patchState({link:t,status:q})},o.onName=function(t){j.state.role===$.Viewer?this.connect():j.patchState({name:t,status:N})},o.onEnter=function(t){this.connect(t)},o.connect=function(t){if(this.agora.connect$(t).pipe(n.takeUntil(this.unsubscribe$)).subscribe(),this.state.role!==$.SelfService){var e=this.state.link.replace(/-\d+-/,"-"),i={meetingId:this.state.link,sharedMeetingId:e,fullName:this.state.name,userType:this.state.role};A.log$(i).pipe(n.first()).subscribe(),Dt.push({action:"b-here-meeting",meetingId:this.state.link,sharedMeetingId:e,userType:this.state.role})}},o.disconnect=function(){this.agora?this.agora.leaveChannel().then((function(){window.location.href=window.location.href}),console.log):this.patchState({connecting:!1,connected:!1})},o.onNavTo=function(t){oe.viewId=t},o.patchState=function(t){this.state=Object.assign({},this.state,t),this.pushChanges()},o.toggleCamera=function(){this.agora?this.agora.toggleCamera():this.patchState({cameraMuted:!this.state.cameraMuted})},o.toggleAudio=function(){this.agora?this.agora.toggleAudio():this.patchState({audioMuted:!this.state.audioMuted})},o.onToggleVolume=function(){var t=!this.state.volumeMuted;j.patchState({volumeMuted:t})},o.onToggleControl=function(){this.agora?this.agora.toggleControl():this.state.control&&this.patchState({control:!1})},o.onToggleSpy=function(t){this.agora?this.agora.toggleSpy(t):this.patchState({spying:!this.state.spying,control:!1})},o.addLike=function(){var t=this;oe.viewLike$(this.view).pipe(n.first()).subscribe((function(e){e&&(t.view.liked=!0,t.showLove(e),St.send({type:ct,viewId:t.view.id,likes:t.view.likes}))}))},o.showLove=function(t){var e=this;if(t&&this.view.id===t.id){var n=this.view.showLove;this.view.likes=t.likes,this.view.showLove=!0,this.pushChanges(),n||setTimeout((function(){e.view.showLove=!1,e.pushChanges()}),3100)}},o.tryInAr=function(){this.platform===L||this.platform===U?qt.openInAR(this.view):Gt.open$({src:C.template.modal.tryInAr,data:this.view}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){}))},i}(t.Component);pe.meta={selector:"[agora-component]"};var me=function(e){function n(){return e.apply(this,arguments)||this}return h(n,e),n.prototype.onInit=function(){t.getContext(this).node.classList.remove("hidden")},n}(t.Component);me.meta={selector:"[app-component]"};var fe=["jpeg","jpg","png"],ve=["mp4","webm"],ge=["fbx","gltf","glb","usdz"],be={Image:{id:1,name:"image"},Video:{id:2,name:"video"},Model:{id:3,name:"model"},PublisherStream:{id:4,name:"publisher-stream"},NextAttendeeStream:{id:5,name:"next-attendee-stream"}},ye={ImageOrVideo:{id:1,name:"Image or Video",ids:[1,2]},Publisher:{id:3,name:"Publisher",ids:[4]},Attendee:{id:4,name:"Attendee",ids:[5]}};function we(t){var e;return t&&t.asset&&(e=Object.keys(ye).find((function(e){return-1!==ye[e].ids.indexOf(t.asset.type.id)}))),ye[e||"ImageOrVideo"]}function Ee(t){var e=t.split(".").pop().toLowerCase();return-1!==fe.indexOf(e)?be.Image:-1!==ve.indexOf(e)?be.Video:-1!==ge.indexOf(e)?be.Model:void 0}var xe=function(){function t(t){t&&Object.assign(this,t)}return t.fromUrl=function(e){var n=e.split("/"),i=n.pop(),o=n.join("/")+"/";return new t({type:Ee(i),folder:o,file:i})},l(t,[{key:"payload",get:function(){var e=this,n={};return Object.keys(this).forEach((function(i){-1!==t.allowedProps.indexOf(i)&&(n[i]=e[i])})),n}}]),t}();function Te(t){return t.type,t=new xe(t)}c(xe,"allowedProps",["id","type","folder","file","linkedPlayId","chromaKeyColor"]);var Ie=["bmp","gif","ico","jpeg","jpg","png","svg","tif","tiff","webp"],Re=["mp4","avi","mpeg","ogv","ts","webm","3gp","3g2"],Ce=["fbx","gltf","glb","obj","usdz"],ke=["publisherStream","nextAttendeeStream"];var Me=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.transform=function(t,e){if(void 0===e&&(e=null),null!=e&&(t=t.type.name===e?t:null),t){switch(t.type.name){case be.Image.name:case be.Video.name:case be.Model.name:t=t.folder+t.file,t=C.getPath(t);break;case be.PublisherStream.name:case be.NextAttendeeStream.name:t=C.getPath(t.file);break;default:n=t.file,new RegExp("/.("+Ie.join("|")+")$/i").test(n)||function(t){return new RegExp("/.("+Re.join("|")+")$/i").test(t)}(t.file)?(t=t.folder+t.file,t=C.getPath(t)):!function(t){return new RegExp("/.("+Ce.join("|")+")$/i").test(t)}(t.file)?function(t){return-1!==ke.indexOf(t)}(t.file)&&(t=t.file):(t=t.folder+t.file,t=C.getPath(t))}t=t}else t=null;var n;return t},e}(t.Pipe);Me.meta={name:"asset"};var Se=function(e){function n(){return e.apply(this,arguments)||this}h(n,e);var i=n.prototype;return i.onInit=function(){e.prototype.onInit.call(this);var n=t.getContext(this).parentInstance;n instanceof zt&&(this.data=n.modal.data)},i.onAccept=function(t){Gt.resolve()},i.onReject=function(t){Gt.reject()},i.close=function(){Gt.reject()},n}(t.Component);Se.meta={selector:"[control-request-modal]"};var $e=function(e){function o(){return e.apply(this,arguments)||this}return h(o,e),o.prototype.onInit=function(){var e=t.getContext(this),o=e.module,r=e.node,s=e.parentInstance,a=(e.selector,"drop"),u=i.fromEvent(r,a).pipe(n.shareReplay(1)),l=r.getAttribute("(drop)");if(l){var c=o.makeFunction(l,["$event"]);u.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){o.resolve(c,s,t)})),i.fromEvent(r,"dragover").pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){return t.preventDefault()}))}else s.drop$=u},o}(t.Directive);$e.meta={selector:"[(drop)]"};var He=1e6,Ae=function(e){function i(){return e.apply(this,arguments)||this}h(i,e);var o=i.prototype;return o.onInit=function(){var e=this,o=t.getContext(this).node,r=o.getAttribute("dropdown-trigger");this.trigger=r?o.querySelector(r):o,this.opened=null,this.onClick=this.onClick.bind(this),this.onDocumentClick=this.onDocumentClick.bind(this),this.openDropdown=this.openDropdown.bind(this),this.closeDropdown=this.closeDropdown.bind(this),this.addListeners(),i.dropdown$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.id===t?o.classList.add("dropped"):o.classList.remove("dropped")}))},o.onClick=function(e){var n=t.getContext(this).node;null===this.opened?this.openDropdown():n.querySelector("[dropdown-item]")||this.closeDropdown()},o.onDocumentClick=function(e){var n=t.getContext(this).node;n===e.target||n.contains(e.target)||this.closeDropdown()},o.openDropdown=function(){null===this.opened&&(this.opened=!0,this.addDocumentListeners(),i.dropdown$.next(this.id),this.dropped.next(this.id))},o.closeDropdown=function(){null!==this.opened&&(this.removeDocumentListeners(),this.opened=null,i.dropdown$.getValue()===this.id&&(i.dropdown$.next(null),this.dropped.next(null)))},o.addListeners=function(){this.trigger.addEventListener("click",this.onClick)},o.addDocumentListeners=function(){document.addEventListener("click",this.onDocumentClick)},o.removeListeners=function(){this.trigger.removeEventListener("click",this.onClick)},o.removeDocumentListeners=function(){document.removeEventListener("click",this.onDocumentClick)},o.onDestroy=function(){this.removeListeners(),this.removeDocumentListeners()},i.nextId=function(){return He++},l(i,[{key:"id",get:function(){return this.dropdown||this.id_||(this.id_=i.nextId())}}]),i}(t.Directive);Ae.meta={selector:"[dropdown]",inputs:["dropdown","dropdown-trigger"],outputs:["dropped"]},Ae.dropdown$=new i.BehaviorSubject(null);var Pe=function(e){function i(){return e.apply(this,arguments)||this}return h(i,e),i.prototype.onInit=function(){var e=this,i=t.getContext(this).node;i.classList.add("dropdown-item"),Ae.dropdown$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.id===t?i.classList.add("dropped"):i.classList.remove("dropped")}))},l(i,[{key:"id",get:function(){return this["dropdown-item"]}}]),i}(t.Directive);Pe.meta={selector:"[dropdown-item], [[dropdown-item]]",inputs:["dropdown-item"]};var _e=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}((function(t){this.toast=t})),Oe=function(){function t(){}return t.open$=function(t){var e=this;return t.id=(new Date).getTime(),this.toast$.next(t),setTimeout((function(){e.resolve(t)}),t.duration||3e3),this.events$},t.resolve=function(t){this.toast$.next(null),this.events$.next(new _e(t))},t}();Oe.toast$=new i.Subject,Oe.events$=new i.Subject;var Le=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.prototype.onInit=function(){var t=this;this.toast=null,this.lastMessage="",Oe.toast$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){e&&(t.lastMessage=e.message),t.toast=e,t.pushChanges()}))},e}(t.Component);Le.meta={selector:"[toast-outlet]",template:'\n\t<div class="toast-outlet__container" [class]="{ active: toast }">\n\t\t<div class="toast-outlet__toast" [innerHTML]="lastMessage"></div>\n\t</div>\n\t'};var Ue=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var n=e.prototype;return n.onInit=function(){this.mode=1,this.viewTypes=Object.keys(Nt).map((function(t){var e=Nt[t];return{type:e,name:M.getKeys("editor",e.name),disabled:-1!==C.editor.disabledViewTypes.indexOf(e.name)}})),this.viewItemTypes=Object.keys(Wt).map((function(t){var e=Wt[t];return{type:e,name:M.getKeys("editor",e.name),disabled:-1!==C.editor.disabledViewItemTypes.indexOf(e.name)}})),this.setSupportedViewTypes(),this.setSupportedViewItemTypes()},n.onChanges=function(){this.setSupportedViewTypes(),this.setSupportedViewItemTypes()},n.setSupportedViewTypes=function(){var t=this;this.supportedViewTypes=this.viewTypes.filter((function(e){return t.supportedViewType(e.type.name)})).sort((function(t,e){return t.disabled===e.disabled?0:t.disabled?1:-1}))},n.setSupportedViewItemTypes=function(){var t=this;this.view?this.supportedViewItemTypes=this.viewItemTypes.filter((function(e){return t.supportedViewItemType(t.view.type.name,e.type.name)})).sort((function(t,e){return t.disabled===e.disabled?0:t.disabled?1:-1})):this.supportedViewItemTypes=[]},n.setMode=function(t){this.mode!==t&&(this.mode=t,this.pushChanges())},n.supportedViewType=function(t){return-1!==[Nt.Panorama.name,Nt.PanoramaGrid.name,Nt.Room3d.name,Nt.Model.name].indexOf(t)},n.supportedViewItemType=function(t,e){var n;switch(t){case Nt.WaitingRoom.name:n=!1;break;case Nt.Panorama.name:case Nt.PanoramaGrid.name:n=-1!==[Wt.Nav.name,Wt.Model.name,Wt.Plane.name,Wt.CurvedPlane.name].indexOf(e);break;case Nt.Room3d.name:n=-1!==[Wt.Nav.name,Wt.Model.name,Wt.Texture.name].indexOf(e);break;case Nt.Model.name:n=-1!==[Wt.Nav.name,Wt.Model.name,Wt.Plane.name,Wt.CurvedPlane.name].indexOf(e)}return n},n.onSelect=function(t){this.select.next(t)},n.onUpdate=function(t){this.update.next(t)},n.onDelete=function(t){this.delete.next(t)},e}(t.Component);Ue.meta={selector:"[aside]",outputs:["select","update","delete"],inputs:["view"]};var Ve=function(){function t(){}return t.data$=function(){return this.data$_||(this.data$_=S.get$("/api/view").pipe(n.map((function(t){return t.views=t.views.map((function(t){return ee(t)})),t})),n.shareReplay(1))),this.data$_},t.viewIdOptions$=function(){return this.data$().pipe(n.map((function(t){var e=t.views.map((function(t){return{id:t.id,name:t.name}}));return e.unshift({id:null,name:M.transform("select")}),e})))},t.viewCreate$=function(t){return S.post$("/api/view",t).pipe(n.map((function(t){return ee(t)})))},t.viewUpdate$=function(t){return S.put$("/api/view/"+t.id,t.payload).pipe(n.map((function(t){return ee(t)})))},t.viewDelete$=function(t){return S.delete$("/api/view/"+t.id)},t.getTile=function(t){var e;return t.type.name===Nt.PanoramaGrid.name&&(e=t.tiles[t.index]),e},t.inferItemCreate$=function(t,e){var n=this.getTile(t);return n?this.tileItemCreate$(t,n,e):this.itemCreate$(t,e)},t.inferItemUpdate$=function(t,e){var n=this.getTile(t);return n?this.tileItemUpdate$(t,n,e):this.itemUpdate$(t,e)},t.inferItemDelete$=function(t,e){var n=this.getTile(t);return n?this.tileItemDelete$(t,n,e):this.itemDelete$(t,e)},t.inferItemUpdateResult$=function(t,e){var n,i=this.getTile(t);(n=i?i.navs.find((function(t){return t.id===e.id})):t.items.find((function(t){return t.id===e.id})))&&Object.assign(n,e)},t.inferItemDeleteResult$=function(t,e){var n,i=this.getTile(t);if(n=i?i.navs:t.items){var o=n.indexOf(e);-1!==o&&n.splice(o,1),i&&t.updateCurrentItems()}},t.itemCreate$=function(t,e){return S.post$("/api/view/"+t.id+"/item",e).pipe(n.map((function(t){return ne(t)})))},t.itemUpdate$=function(t,e){return S.put$("/api/view/"+t.id+"/item/"+e.id,e.payload).pipe(n.map((function(t){return ne(t)})))},t.itemDelete$=function(t,e){return S.delete$("/api/view/"+t.id+"/item/"+e.id)},t.tileItemCreate$=function(t,e,i){return S.post$("/api/view/"+t.id+"/tile/"+e.id+"/item",i).pipe(n.map((function(t){return ne(t)})))},t.tileItemUpdate$=function(t,e,i){return S.put$("/api/view/"+t.id+"/tile/"+e.id+"/item/"+i.id,i.payload).pipe(n.map((function(t){return ne(t)})))},t.tileItemDelete$=function(t,e,n){return S.delete$("/api/view/"+t.id+"/tile/"+e.id+"/item/"+n.id)},t}(),De=function(e){function o(){return e.apply(this,arguments)||this}h(o,e);var r=o.prototype;return r.onInit=function(){var e=this;t.getContext(this).node.classList.remove("hidden"),this.flags=C.flags,this.aside=!1,this.settings=!1,this.state={},this.data=null,this.views=null,this.view=null,this.form=null,this.local=null,this.remotes=[],this.viewHit=new i.Subject,(this.vrService=he.getService()).status$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){return e.pushChanges()})),this.resolveUser()},r.resolveUser=function(){var t=this;A.me$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){e&&e.type===$.Publisher?(t.user=e,t.initState()):window.location.href=C.url.access}))},r.initState=function(){var t=this,e=this.user,i={user:e,role:e.type,name:e.firstName&&e.lastName?e.firstName+" "+e.lastName:null,link:null,channelName:C.channelName,uid:null,status:X,connecting:!1,connected:!0,locked:!1,control:!1,spyed:!1,hosted:!0,live:!1,cameraMuted:!1,audioMuted:!1};j.state=i,j.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.state=e,t.hosted=e.hosted,t.pushChanges()})),this.loadView(),At.mode=Ht},r.getUserMedia=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var t=document.querySelector("body"),e=document.createElement("div"),n=document.createElement("video");e.setAttribute("id","stream-editor"),e.setAttribute("style","position:absolute; top: 5000px; line-height: 0;"),e.appendChild(n),t.appendChild(e),navigator.mediaDevices.getUserMedia({video:{width:800,height:450}}).then((function(t){"srcObject"in n?n.srcObject=t:n.src=window.URL.createObjectURL(t),n.play();var e={getId:function(){return"editor"},clientInfo:{role:$.Publisher}},i={getId:function(){return"editor"},clientInfo:{role:$.Attendee}};At.editor=[e,i,i,i,i]})).catch((function(t){console.log("EditorComponent.getUserMedia.error",t.name,t.message)}))}},r.loadView=function(){var t=this;Ve.data$().pipe(n.switchMap((function(e){return t.data=e,t.views=e.views.filter((function(t){return"waiting-room"!==t.type.name})),oe.editorView$(e)})),n.takeUntil(this.unsubscribe$),n.tap((function(e){t.view=null,t.pushChanges()})),n.delay(1),n.tap((function(e){t.view=e,t.pushChanges()}))).subscribe((function(t){}))},r.onNavTo=function(t){this.data.views.find((function(e){return e.id===t}))&&(oe.viewId=t)},r.onRemoteControlRequest=function(t){var e=this;Gt.open$({src:C.template.modal.controlRequest,data:null}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){t instanceof jt?e.patchState({control:!0,spying:!1}):e.patchState({control:!1,spying:!1})}))},r.patchState=function(t){this.state=Object.assign({},this.state,t),this.pushChanges()},r.tryInAr=function(){Gt.open$({src:C.template.modal.tryInAr,data:this.view}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){}))},r.replaceUrl=function(){if("history"in window){var t=new URLSearchParams(window.location.search),e=t.get("debug")||null,n=t.get("editor")||null,i=t.get("role")||null,o=t.get("link")||null,r=t.get("name")||null,s=""+window.location.origin+window.location.pathname+"?link="+o+(r?"&name="+r:"")+(i?"&role="+i:"")+(e?"&debug":"")+(n?"&editor":"");window.history.replaceState({pageTitle:window.pageTitle},"",s)}},r.onToggleAside=function(){this.aside=!this.aside,this.pushChanges(),window.dispatchEvent(new Event("resize"))},r.onToggleSettings=function(){this.settings=!this.settings,this.pushChanges()},r.onViewHit=function(t){this.viewHit.next(t)},r.onViewHitted=function(t){this.viewHitSubscription&&(this.viewHitSubscription.unsubscribe(),this.viewHitSubscription=null),"function"==typeof t&&(this.viewHitSubscription=this.viewHit.pipe(n.first()).subscribe((function(e){return t(e)})))},r.onDragEnd=function(t){var e=this;Ve.inferItemUpdate$(this.view,t.item).pipe(n.first()).subscribe((function(t){e.pushChanges()}),(function(t){return console.log("EditorComponent.onDragEnd.inferItemUpdate$.error",t)}))},r.onResizeEnd=function(t){console.log("EditorComponent.onResizeEnd")},r.onWorldSelect=function(t){this.view&&(this.view.items.forEach((function(t){return t.showPanel=!1})),this.view.items.forEach((function(e){return e.selected=e===t.item})),this.view.selected=void 0===this.view.items.find((function(t){return t.selected})),this.pushChanges())},r.onOpenModal=function(t,e){var i=this;Gt.open$({src:C.template.modal[t.type][t.value],data:e}).pipe(n.first()).subscribe((function(e){if(e instanceof jt)switch(console.log("EditorComponent.onOpenModal.resolve",e),t.value){case Wt.Nav.name:case Wt.Plane.name:case Wt.CurvedPlane.name:case Wt.Model.name:var n=Ve.getTile(i.view);if(n){var o=n.navs||[];o.push(e.data),Object.assign(n,{navs:o}),i.view.updateCurrentItems()}else{var r=i.view.items||[];r.push(e.data),Object.assign(i.view,{items:r})}i.pushChanges();break;case Nt.Panorama.name:case Nt.PanoramaGrid.name:case Nt.Model.name:i.data.views.push(e.data),oe.viewId=e.data.id,i.pushChanges()}i.pushChanges()}))},r.onAsideSelect=function(t){var e=this;if(t.value)switch(t.value){case Wt.Nav.name:case Wt.Plane.name:case Wt.CurvedPlane.name:this.onViewHitted((function(n){e.onOpenModal(t,{view:e.view,position:n})})),Oe.open$({message:"Click a point on the view"});break;case Wt.Model.name:if("viewItem"===t.type){if(this.view.type.name===Nt.Model.name)return;this.onViewHitted((function(n){e.onOpenModal(t,{view:e.view,position:n})})),Oe.open$({message:"Click a point on the view"})}else this.onOpenModal(t,{view:this.view});break;default:this.onOpenModal(t,{view:this.view})}else if(t.view&&(t.item||null===t.item))t.view.selected=!1,t.view.items.forEach((function(e){return e.selected=e===t.item})),this.pushChanges();else if(t.view&&(t.tile||null===t.tile))t.view.selected=!1,t.view.tiles.forEach((function(e){return e.selected=e===t.tile})),this.pushChanges();else if(t.view||null===t.view){this.view.selected=this.view===t.view,this.view.items.forEach((function(t){return t.selected=!1}));var n=Ve.getTile(this.view);n&&this.view.tiles.forEach((function(t){return t.selected=t===n})),this.pushChanges()}},r.onAsideUpdate=function(t){if(t.item&&t.view)this.pushChanges();else if(t.tile&&t.view);else if(t.view){var e=this.view.asset.id!==t.view.asset.id;Object.assign(this.view,t.view),e?oe.viewId=t.view.id:this.pushChanges()}},r.onAsideDelete=function(t){var e=this;console.log("onAsideDelete",t),t.item&&t.view?Ve.inferItemDelete$(t.view,t.item).pipe(n.first()).subscribe((function(n){Ve.inferItemDeleteResult$(t.view,t.item),e.pushChanges()}),(function(t){return console.log("EditorComponent.onAsideDelete.inferItemDelete$.error",t)})):t.view&&Ve.viewDelete$(t.view).pipe(n.first()).subscribe((function(n){var i=e.data.views.indexOf(t.view);-1!==i&&e.data.views.splice(i,1),e.views=e.data.views.slice(),oe.viewId=e.views[0].id}),(function(t){return console.log("EditorComponent.onAsideDelete.viewDelete$.error",t)}))},o}(t.Component);De.meta={selector:"[editor-component]"};var Fe=0,je=function(){function t(){}return t.menu$=function(){var t=this;return this.getMenu$().pipe(n.switchMap((function(e){return t.menu$_.next(e),t.menu$_})))},t.getMenu$=function(){return S.get$("/api/menu").pipe(n.map((function(t){return t.menu.sort((function(t,e){return t.order-e.order})),t.menu})))},t.updateMenu$=function(t){return S.put$("/api/menu",t)},t.createMenuItem$=function(t,e){void 0===t&&(t=null),void 0===e&&(e=0);var n={parentId:t,viewId:null,order:10*e,name:"Folder "+ ++Fe};return S.post$("/api/menu",n)},t.updateMenuItem$=function(t){return S.put$("/api/menu/"+t.id,t)},t.deleteMenuItem$=function(t){return S.delete$("/api/menu/"+t.id)},t.getModelMenu$=function(t,e){var i=this;return void 0===e&&(e=!1),this.menu$().pipe(n.map((function(n){if(n&&n.length)return i.mapMenuItems(n);var o={};return t.forEach((function(t){if(t.type.name!==Nt.WaitingRoom.name&&(!t.hidden||e)){var n=o[t.type.name];n||(n=o[t.type.name]=[]),n.push(t)}})),Object.keys(o).map((function(n){var i="Button";switch(n){case Nt.WaitingRoom.name:i="Waiting Room";break;case Nt.Panorama.name:i="Experience";break;case Nt.PanoramaGrid.name:i="Virtual Tour";break;case Nt.Room3d.name:i="Stanze 3D";break;case Nt.Model.name:i="Modelli 3D"}return{name:i,type:{name:"menu-group"},items:t.filter((function(t){return t.type.name===n&&(!t.hidden||e)}))}}))})))},t.mapMenuItem=function(t,e){return t.viewId?{id:t.viewId,name:t.name,type:{name:"panorama"}}:{name:t.name,type:{name:"menu-group"},items:this.mapMenuItems(e,t.id)}},t.mapMenuItems=function(t,e){var n=this;return void 0===e&&(e=null),t.filter((function(t){return(t.parentId||null)===e})).map((function(e){return n.mapMenuItem(e,t)}))},t}();c(je,"menu$_",new i.BehaviorSubject([]));var Be=function(){function t(){}return t.assetCreate$=function(t){return S.post$("/api/asset",t).pipe(n.map((function(t){return Te(t)})))},t.assetUpdate$=function(t){return S.put$("/api/asset/"+t.id,t).pipe(n.map((function(t){return Te(t)})))},t.assetDelete$=function(t){return t&&t.id?S.delete$("/api/asset/"+t.id).pipe(n.map((function(){return null}))):i.of(null)},t.upload$=function(t){var e=new FormData;t.forEach((function(t){return e.append("file",t,t.name)}));var o=new XMLHttpRequest,r=i.merge(i.fromEvent(o.upload,"loadstart"),i.fromEvent(o.upload,"progress"),i.fromEvent(o.upload,"load"),i.fromEvent(o,"readystatechange")).pipe(n.map((function(t){switch(t.type){case"readystatechange":return 4===o.readyState?JSON.parse(o.responseText):null;default:return null}})),n.filter((function(t){return null!==t})));return o.open("POST","/api/upload/",!0),o.send(e),r},t}(),Ge=function(e){function n(){return e.apply(this,arguments)||this}return h(n,e),n.prototype.onChanges=function(){var e=t.getContext(this).node,n=this.control.flags;Object.keys(n).forEach((function(t){n[t]?e.classList.add(t):e.classList.remove(t)}))},n}(t.Component);Ge.meta={selector:"[control]",inputs:["control"]};var ze=function(e){function o(){return e.apply(this,arguments)||this}h(o,e);var r=o.prototype;return r.onInit=function(){var e=this;this.label=this.label||"label",this.disabled=this.disabled||!1,this.accept=this.accept||"image/png, image/jpeg",this.previews=[];var i=t.getContext(this).node.querySelector("input");i.setAttribute("accept",this.accept),this.drop$(i).pipe(n.takeUntil(this.unsubscribe$)).subscribe(),this.change$(i).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.control.value=t[0]}))},r.change$=function(e){var o=this;return t.isPlatformBrowser&&e?i.fromEvent(e,"change").pipe(n.filter((function(t){return e.files&&e.files.length})),n.switchMap((function(t){var r=Array.from(e.files);o.previews=r.map((function(){return null}));var s=r.map((function(t,e){return o.read$(t,e).pipe(n.switchMap((function(){return Be.upload$([t])})),n.switchMap((function(t){var e=t[0],n=xe.fromUrl(e.url);return Be.assetCreate$(n)})))}));return i.combineLatest(s)}))):i.EMPTY},r.read$=function(t,e){var o=this,r=new FileReader,s=i.fromEvent(r,"load").pipe(n.tap((function(t){var n=t.target.result;o.resize_(n,(function(t){o.previews[e]=t,o.pushChanges()}))})));return r.readAsDataURL(t),s},r.drop$=function(e){if(t.isPlatformBrowser&&e){var o=document.querySelector("body");return i.merge(i.fromEvent(o,"drop"),i.fromEvent(o,"dragover")).pipe(n.map((function(t){console.log("ControlAssetComponent.drop$",t),t.preventDefault(),t.target===e&&(e.files=t.dataTransfer.files)})))}return i.EMPTY},r.resize_=function(t,e){if("function"==typeof e){var n=document.createElement("img");n.onload=function(){var t=document.createElement("canvas"),i=t.getContext("2d"),o=n.width,r=n.height;o>r?o>320&&(r*=320/o,o=320):r>240&&(o*=240/r,r=240),t.width=o,t.height=r,i.drawImage(n,0,0,o,r);var s=t.toDataURL("image/jpeg",.9);e(s)},n.src=t}},l(o,[{key:"image",get:function(){var t=null;return this.control.value?t=""+this.control.value.folder+this.control.value.file:this.previews&&this.previews.length&&(t=this.previews[0]),t}}]),o}(Ge);ze.meta={selector:"[control-asset]",inputs:["control","label","disabled","accept"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="group--picture">\n\t\t\t\t<div class="group--picture__info">\n\t\t\t\t\t\x3c!-- <svg class="icon--image"><use xlink:href="#image"></use></svg> --\x3e\n\t\t\t\t\t<span [innerHTML]="\'browse\' | label"></span>\n\t\t\t\t</div>\n\t\t\t\t<img [lazy]="control.value | asset" [size]="{ width: 320, height: 240 }" *if="control.value && control.value.type.name === \'image\'" />\n\t\t\t\t<video [src]="control.value | asset" *if="control.value && control.value.type.name === \'video\'"></video>\n\t\t\t\t<input type="file">\n\t\t\t</div>\n\t\t\t<div class="file-name" *if="control.value" [innerHTML]="control.value.file"></div>\n\t\t\t\x3c!--\n\t\t\t<input type="text" class="control--text" [formControl]="control" [placeholder]="label" [disabled]="disabled" />\n\t\t\t--\x3e\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};var qe=function(t){function i(){return t.apply(this,arguments)||this}h(i,t),i.itemToFormGroup=function(t){return new e.FormGroup({id:t.id,parentId:t.parentId,viewId:t.viewId,name:t.name,items:new e.FormArray})};var o=i.prototype;return o.onInit=function(){var t=this;this.dropdownId=Ae.nextId(),this.controls=this.control.controls,Ve.viewIdOptions$().pipe(n.first()).subscribe((function(e){t.controls.viewId.options=e}))},o.onAddItem=function(){var t=this;je.createMenuItem$(this.controls.id.value,this.controls.items.length).pipe(n.first()).subscribe((function(e){t.controls.items.push(i.itemToFormGroup(e))}))},o.onRemoveItem=function(){this.remove.next(this.control)},o.onRemoveControl=function(t){var e=this;je.deleteMenuItem$(t.value).pipe(n.first()).subscribe((function(){e.controls.items.remove(t)}))},o.onLinkItem=function(){this.link.next(this.control)},o.onLinkControl=function(t){this.link.next(t)},o.onItemUp=function(){this.up.next(this.control)},o.onItemDown=function(){this.down.next(this.control)},o.onUpControl=function(t){var e=this.controls.items,n=e.controls.length,i=e.controls.indexOf(t);e.controls.splice(i,1),i>0?i--:i=n-1,e.insert(t,i)},o.onDownControl=function(t){var e=this.controls.items,n=e.controls.length,i=e.controls.indexOf(t);e.controls.splice(i,1),i<n-1?i++:i=0,e.insert(t,i)},o.setView=function(t){var e=this;console.log("ControlMenuComponent.setView",t.id);var i=Object.assign({},this.control.value);i.viewId=t.id,t.id&&(i.name=t.name),je.updateMenuItem$(i).pipe(n.first()).subscribe((function(){e.controls.viewId.value=t.id,t.id&&(e.controls.name.value=t.name,e.controls.items.controls=[],e.controls.items.switchSubjects_())}))},o.onTextDidChange=function(t){console.log("ControlMenuComponent.onTextDidChange",this.controls.name.value),je.updateMenuItem$(this.control.value).pipe(n.first()).subscribe()},o.hasOption=function(t){return this.controls.viewId.value===t.id},o.onDropped=function(t){},i}(ze);qe.meta={selector:"[control-menu]",outputs:["remove","link","up","down"],inputs:["control"],template:'\n\t\t<div class="group--form">\n\t\t\t<button type="button" class="control-menu__link" [class]="{ active: control.controls.viewId.value }" (click)="onLinkItem($event)" [dropdown]="dropdownId" (dropped)="onDropped($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#link"></use></svg>\n\t\t\t\t<div class="dropdown" [dropdown-item]="dropdownId">\n\t\t\t\t\t<div class="category">View</div>\n\t\t\t\t\t<ul class="nav--dropdown">\n\t\t\t\t\t\t<li (click)="setView(item)" [class]="{ empty: item.id == null }" *for="let item of control.controls.viewId.options">\n\t\t\t\t\t\t\t<span [class]="{ active: hasOption(item) }" [innerHTML]="item.name"></span>\n\t\t\t\t\t\t</li>\n\t\t\t\t\t</ul>\n\t\t\t\t</div>\n\t\t\t</button>\n\t\t\t<input type="text" class="control--text" [formControl]="control.controls.name" placeholder="Name" (change)="onTextDidChange($event)" />\n\t\t\t\x3c!--\n\t\t\t<button type="button" class="control-menu__add" (click)="onAddItem($event)">\n\t\t\t\t<span [innerHTML]="control.controls.viewId.value"></span>\n\t\t\t</button>\n\t\t\t--\x3e\n\t\t\t\x3c!--\n\t\t\t<select class="control--select" [formControl]="control.controls.viewId">\n\t\t\t\t<option [value]="item.id" *for="let item of control.controls.viewId.options" [innerHTML]="item.name"></option>\n\t\t\t</select>\n\t\t\t--\x3e\n\t\t\t<button type="button" class="control-menu__up" (click)="onItemUp($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#up"></use></svg>\n\t\t\t</button>\n\t\t\t<button type="button" class="control-menu__down" (click)="onItemDown($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#down"></use></svg>\n\t\t\t</button>\n\t\t\t<button type="button" class="control-menu__add" (click)="onAddItem($event)" *if="!control.controls.viewId.value">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#add"></use></svg>\n\t\t\t</button>\n\t\t\t<button type="button" class="control-menu__remove" (click)="onRemoveItem($event)">\n\t\t\t\t<svg width="24" height="24" viewBox="0 0 24 24"><use xlink:href="#remove"></use></svg>\n\t\t\t</button>\n\t\t</div>\n\t\t<div class="group--items">\n\t\t\t<div control-menu *for="let sub of control.controls.items.controls" [control]="sub" (remove)="onRemoveControl($event)" (link)="onLinkControl($event)" (up)="onUpControl($event)" (down)="onDownControl($event)"></div>\n\t\t</div>\n\t'};var Ne=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var o=i.prototype;return o.onInit=function(){var t=this;this.changes=0,this.form=null,je.getMenu$().pipe(n.first()).subscribe((function(e){return t.initForm(e)}))},o.initForm=function(t){var i=this;void 0===t&&(t=[]);var o=this.menuToControls(t),r=this.form=new e.FormGroup({items:o});this.controls=r.controls;r.changes$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){i.changes++,i.pushChanges()}))},o.onLinkControl=function(t){},o.onUpControl=function(t){var e=this.controls.items,n=e.controls.length,i=e.controls.indexOf(t);e.controls.splice(i,1),i>0?i--:i=n-1,e.insert(t,i)},o.onDownControl=function(t){var e=this.controls.items,n=e.controls.length,i=e.controls.indexOf(t);e.controls.splice(i,1),i<n-1?i++:i=0,e.insert(t,i)},o.onAddItem=function(){var t=this;je.createMenuItem$(null,this.controls.items.length).pipe(n.first()).subscribe((function(e){t.controls.items.push(qe.itemToFormGroup(e))}))},o.onRemoveControl=function(t){var e=this;je.deleteMenuItem$(t.value).pipe(n.first()).subscribe((function(){e.controls.items.remove(t)}))},o.isValid=function(){var t=this.form.valid;return t},o.onSubmit=function(t){if(this.form.valid){var e=this.form.value,n=this.controlsToMenu(e);je.updateMenu$(n)}else this.form.touched=!0},o.menuToControls=function(t,n){var i=this;return void 0===n&&(n=null),new e.FormArray(t.filter((function(t){return(t.parentId||null)===n})).map((function(n){var o=i.menuToControls(t,n.id);return new e.FormGroup({id:n.id,parentId:n.parentId,viewId:n.viewId,name:n.name,items:o})})))},o.controlsToMenu=function(t){var e=[];return function t(n){n&&n.forEach((function(n,i){var o=Object.assign({},n);o.order=10*i,delete o.items,e.push(o),t(n.items)}))}(t.items),e},i}(t.Component);Ne.meta={selector:"[menu-builder]",inputs:["views"]};var We=function(i){function o(){return i.apply(this,arguments)||this}h(o,i);var r=o.prototype;return r.onInit=function(){var t=this,n=new THREE.Object3D;n.position.copy(this.position),n.lookAt(o.ORIGIN);var i=this.form=new e.FormGroup({type:Wt.CurvedPlane,position:new e.FormControl(this.position.multiplyScalar(20).toArray(),e.RequiredValidator()),rotation:new e.FormControl(n.rotation.toArray(),e.RequiredValidator()),scale:new e.FormControl([1,1,1],e.RequiredValidator()),radius:new e.FormControl(35,e.RequiredValidator()),height:new e.FormControl(20,e.RequiredValidator()),arc:new e.FormControl(90,e.RequiredValidator()),asset:null});this.controls=i.controls,i.changes$.subscribe((function(e){t.pushChanges()}))},r.onSubmit=function(){if(this.form.valid){var t=Object.assign({},this.form.value);console.log("CurvedPlaneModalComponent.onSubmit",this.view,t),Ve.inferItemCreate$(this.view,t).pipe(n.first()).subscribe((function(t){console.log("CurvedPlaneModalComponent.onSubmit.success",t),Gt.resolve(t)}),(function(t){return console.log("CurvedPlaneModalComponent.onSubmit.error",t)}))}else this.form.touched=!0},r.close=function(){Gt.reject()},l(o,[{key:"data",get:function(){var e=null,n=t.getContext(this).parentInstance;return n instanceof zt&&(e=n.modal.data),e}},{key:"view",get:function(){var t=null,e=this.data;return e&&(t=e.view),t}},{key:"position",get:function(){var t=null,e=this.data;return e&&(t=e.position),t}}]),o}(t.Component);We.ORIGIN=new THREE.Vector3,We.meta={selector:"[curved-plane-modal]"};var Ke=function(i){function o(){return i.apply(this,arguments)||this}h(o,i);var r=o.prototype;return r.onInit=function(){var t=this,n=this.form=new e.FormGroup({type:Wt.Model,position:new e.FormControl(this.position.multiplyScalar(4).toArray(),e.RequiredValidator()),rotation:new e.FormControl([0,0,0],e.RequiredValidator()),scale:new e.FormControl([1,1,1],e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=n.controls,n.changes$.subscribe((function(e){t.pushChanges()}))},r.onSubmit=function(){if(this.form.valid){var t=Object.assign({},this.form.value);console.log("ItemModelModalComponent.onSubmit",this.view,t),Ve.inferItemCreate$(this.view,t).pipe(n.first()).subscribe((function(t){console.log("ItemModelModalComponent.onSubmit.success",t),Gt.resolve(t)}),(function(t){return console.log("ItemModelModalComponent.onSubmit.error",t)}))}else this.form.touched=!0},r.close=function(){Gt.reject()},l(o,[{key:"data",get:function(){var e=null,n=t.getContext(this).parentInstance;return n instanceof zt&&(e=n.modal.data),e}},{key:"view",get:function(){var t=null,e=this.data;return e&&(t=e.view),t}},{key:"position",get:function(){var t=null,e=this.data;return e&&(t=e.position),t}}]),o}(t.Component);Ke.ORIGIN=new THREE.Vector3,Ke.meta={selector:"[item-model-modal]"};var Xe=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var o=i.prototype;return o.onInit=function(){var t=this;this.error=null;var n=this.form=new e.FormGroup({type:Nt.Model,name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator()),model:new e.FormControl(null,e.RequiredValidator())});this.controls=n.controls,n.changes$.subscribe((function(e){t.pushChanges()}))},o.onSubmit=function(){var t=this;if(this.form.valid){this.form.submitted=!0;var e=this.form.value,i={type:e.type,name:e.name,asset:e.asset,orientation:{latitude:0,longitude:0},zoom:75};return console.log("ModelModalComponent.onSubmit.view",i),Ve.viewCreate$(i).pipe(n.switchMap((function(t){var i={type:Wt.Model,asset:e.model};return Ve.itemCreate$(t,i).pipe(n.map((function(e){return t.items=[e],t})))})),n.first()).subscribe((function(t){console.log("ModelModalComponent.onSubmit.success",t),Gt.resolve(t)}),(function(e){console.log("ModelModalComponent.onSubmit.error",e),t.error=e,t.form.reset()}))}this.form.touched=!0},o.close=function(){Gt.reject()},i}(t.Component);Xe.meta={selector:"[model-modal]"};var Ye=function(i){function o(){return i.apply(this,arguments)||this}h(o,i);var r=o.prototype;return r.onInit=function(){var t=this;this.error=null;var i=this.form=new e.FormGroup({type:Wt.Nav,title:null,abstract:null,viewId:new e.FormControl(null,e.RequiredValidator()),position:this.position.toArray(),asset:null,link:new e.FormGroup({title:new e.FormControl(null),href:new e.FormControl(null),target:"_blank"})});this.controls=i.controls,i.changes$.subscribe((function(e){t.pushChanges()})),Ve.viewIdOptions$().pipe(n.first()).subscribe((function(e){t.controls.viewId.options=e,t.pushChanges()}))},r.onSubmit=function(){var t=this;if(this.form.valid){this.form.submitted=!0;var e=Object.assign({},this.form.value);e.viewId=parseInt(e.viewId),!e.link||e.link.title&&e.link.href||(e.link=null),Ve.inferItemCreate$(this.view,e).pipe(n.first()).subscribe((function(t){console.log("NavModalComponent.onSubmit.success",t),Gt.resolve(t)}),(function(e){console.log("NavModalComponent.onSubmit.error",e),t.error=e,t.form.submitted=!1}))}else this.form.touched=!0},r.close=function(){Gt.reject()},l(o,[{key:"data",get:function(){var e=null,n=t.getContext(this).parentInstance;return n instanceof zt&&(e=n.modal.data),e}},{key:"view",get:function(){var t=null,e=this.data;return e&&(t=e.view),t}},{key:"position",get:function(){var t=null,e=this.data;return e&&(t=e.position),t}}]),o}(t.Component);Ye.meta={selector:"[nav-modal]"};var Qe=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var o=i.prototype;return o.onInit=function(){var t=this;this.error=null;var n=this.form=new e.FormGroup({type:Nt.PanoramaGrid,name:new e.FormControl(null,e.RequiredValidator()),assets:new e.FormControl(null,e.RequiredValidator())});this.controls=n.controls,n.changes$.subscribe((function(e){t.pushChanges()}))},o.onSubmit=function(){var t=this;if(this.form.valid){this.form.submitted=!0,console.log("PanoramaGridModalComponent.onSubmit",this.form.value);var e=this.form.value.assets,i=Yt.mapTiles(e.map((function(t){return{asset:t,navs:[]}})),!1,!0);i.sort((function(t,e){return 1e4*t.indices.x+t.indices.y-(1e4*e.indices.x+e.indices.y)})),console.log("PanoramaGridModalComponent.onSubmit",i);var o=i[0].asset,r={type:this.form.value.type,name:this.form.value.name,asset:o,tiles:i,invertAxes:!0,flipAxes:!1,orientation:{latitude:0,longitude:0},zoom:75};Ve.viewCreate$(r).pipe(n.first()).subscribe((function(t){console.log("PanoramaGridModalComponent.onSubmit.success",t),Gt.resolve(t)}),(function(e){console.log("PanoramaGridModalComponent.onSubmit.error",e),t.error=e,t.form.reset()}))}else this.form.touched=!0},o.close=function(){Gt.reject()},i}(t.Component);Qe.meta={selector:"[panorama-grid-modal]"};var Je=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var o=i.prototype;return o.onInit=function(){var t=this;this.error=null;var n=this.form=new e.FormGroup({type:Nt.Panorama,name:new e.FormControl(null,e.RequiredValidator()),asset:new e.FormControl(null,e.RequiredValidator())});this.controls=n.controls,n.changes$.subscribe((function(e){t.pushChanges()}))},o.onSubmit=function(){var t=this;if(this.form.valid){this.form.submitted=!0;var e=this.form.value,i={type:e.type,name:e.name,asset:e.asset,orientation:{latitude:0,longitude:0},zoom:75};return console.log("PanoramaModalComponent.onSubmit.view",i),Ve.viewCreate$(i).pipe(n.first()).subscribe((function(t){console.log("PanoramaModalComponent.onSubmit.success",t),Gt.resolve(t)}),(function(e){console.log("PanoramaModalComponent.onSubmit.error",e),t.error=e,t.form.reset()}))}this.form.touched=!0},o.close=function(){Gt.reject()},i}(t.Component);Je.meta={selector:"[panorama-modal]"};var Ze=function(i){function o(){return i.apply(this,arguments)||this}h(o,i);var r=o.prototype;return r.onInit=function(){var t=this,n=new THREE.Object3D;n.position.copy(this.position),n.lookAt(o.ORIGIN);var i=this.form=new e.FormGroup({type:Wt.Plane,position:new e.FormControl(this.position.multiplyScalar(20).toArray(),e.RequiredValidator()),rotation:new e.FormControl(n.rotation.toArray(),e.RequiredValidator()),scale:new e.FormControl([12,6.75,1],e.RequiredValidator()),asset:null});this.controls=i.controls,i.changes$.subscribe((function(e){t.pushChanges()}))},r.onSubmit=function(){if(this.form.valid){var t=Object.assign({},this.form.value);console.log("PlaneModalComponent.onSubmit",this.view,t),Ve.inferItemCreate$(this.view,t).pipe(n.first()).subscribe((function(t){console.log("PlaneModalComponent.onSubmit.success",t),Gt.resolve(t)}),(function(t){return console.log("PlaneModalComponent.onSubmit.error",t)}))}else this.form.touched=!0},r.close=function(){Gt.reject()},l(o,[{key:"data",get:function(){var e=null,n=t.getContext(this).parentInstance;return n instanceof zt&&(e=n.modal.data),e}},{key:"view",get:function(){var t=null,e=this.data;return e&&(t=e.view),t}},{key:"position",get:function(){var t=null,e=this.data;return e&&(t=e.position),t}}]),o}(t.Component);Ze.ORIGIN=new THREE.Vector3,Ze.meta={selector:"[plane-modal]"};var tn=function(e){function n(){return e.apply(this,arguments)||this}h(n,e);var i=n.prototype;return i.onRemove=function(){Gt.resolve()},i.onCancel=function(){Gt.reject()},i.close=function(){Gt.reject()},l(n,[{key:"data",get:function(){var e=null,n=t.getContext(this).parentInstance;return n instanceof zt&&(e=n.modal.data),e}},{key:"item",get:function(){var t=null,e=this.data;return e&&(t=e.item),t}}]),n}(t.Component);tn.meta={selector:"[remove-modal]"};var en=function(t){function o(){return t.apply(this,arguments)||this}h(o,t);var r=o.prototype;return r.onInit=function(){var t=this;this.busy=!1,this.active=!1;var n=this.form=new e.FormGroup;this.controls=n.controls;var i=this.item;this.originalItem=Object.assign({},i),i.hasChromaKeyColor=!(!i.asset||!i.asset.chromaKeyColor),i.assetType=we(i).id,this.doUpdateForm(),n.changes$.subscribe((function(e){t.doUpdateItem(e),t.pushChanges()}))},r.getAssetDidChange=function(t){var e=this.item,n=e.asset?e.asset.id:null,i=t.asset?t.asset.id:null,o=!0===e.hasChromaKeyColor,r=!0===t.hasChromaKeyColor;return n!==i||o!==r},r.doUpdateItem=function(t){var e=this,o=this.item,r=this.getAssetDidChange(t);(Object.assign(o,t),o.asset&&(o.asset.chromaKeyColor=o.hasChromaKeyColor?[0,1,0]:null),r)&&((o.asset?Be.assetUpdate$(o.asset):i.of(null)).pipe(n.switchMap((function(){return Ve.inferItemUpdate$(e.view,o)})),n.first()).subscribe(),this.view.updateIndices(this.view.items),"function"==typeof o.onUpdateAsset&&o.onUpdateAsset());"function"==typeof o.onUpdate&&o.onUpdate()},r.doUpdateForm=function(){var t=this,i=this.item,o=this.form;if(this.type&&this.type.name===i.type.name)Object.keys(this.controls).forEach((function(e){switch(e){case"link":var n=i.link?i.link.title:null,o=i.link?i.link.href:null;t.controls[e].value={title:n,href:o,target:"_blank"};break;case"hasChromaKeyColor":t.controls[e].value=!(!i.asset||!i.asset.chromaKeyColor);break;case"assetType":t.controls[e].value=we(i).id;break;default:t.controls[e].value=null!=i[e]?i[e]:null}}));else{var r;switch(this.type=i.type,Object.keys(this.controls).forEach((function(t){o.removeKey(t)})),i.type.name){case Wt.Nav.name:r=["id","type","title?","abstract?","viewId","keepOrientation?","position","asset?","link?"];break;case Wt.Plane.name:r=["id","type","position","rotation","scale","assetType?","asset?","hasChromaKeyColor?"];break;case Wt.CurvedPlane.name:r=["id","type","position","rotation","scale","radius","height","arc","assetType?","asset?","hasChromaKeyColor?"];break;case Wt.Texture.name:r=["id","type","assetType?","asset?","hasChromaKeyColor?"];break;case Wt.Model.name:r=this.view.type.name===Nt.Model?["id","type","asset?"]:["id","type","position","rotation","asset?"];break;default:r=["id","type"]}r.forEach((function(r){var s=-1!==r.indexOf("?");r=r.replace("?","");var a,u=null!=i[r]?i[r]:null;switch(r){case"viewId":a=new e.FormControl(u,s?void 0:e.RequiredValidator()),Ve.viewIdOptions$().pipe(n.first()).subscribe((function(e){a.options=e,a.value=a.value||null,t.pushChanges()}));break;case"assetType":(a=new e.FormControl(u,s?void 0:e.RequiredValidator())).options=Object.keys(ye).map((function(t){return ye[t]}));break;case"link":var l=i.link?i.link.title:null,c=i.link?i.link.href:null;a=new e.FormGroup({title:new e.FormControl(l),href:new e.FormControl(c),target:"_blank"});break;default:a=new e.FormControl(u,s?void 0:e.RequiredValidator())}o.add(a,r)})),this.controls=o.controls}},r.onAssetTypeDidChange=function(t){var e=this,o=this.item,r=we(o).id;if(t!==r){o.assetType=t;var s=i.of(null);t!==ye.ImageOrVideo.id&&(s=s.pipe(n.switchMap((function(){var e,n,i,o=(n=(e=t)===ye.Publisher.id?be.PublisherStream:be.NextAttendeeStream,i=e===ye.Publisher.id?"publisherStream":"nextAttendeeStream",new xe({type:n,folder:"",file:i}));return Be.assetCreate$(o)})))),s.pipe(n.first()).subscribe((function(t){e.controls.asset.value=t}))}},r.onChanges=function(t){this.doUpdateForm()},r.onSubmit=function(){var t=this;if(!this.busy&&this.form.valid){this.busy=!0,this.pushChanges();var e=this.form.value,i=Object.assign({},e),o=this.view,r=new Jt(i);Ve.inferItemUpdate$(o,r).pipe(n.first()).subscribe((function(e){Ve.inferItemUpdateResult$(o,r),t.update.next({view:o,item:r}),setTimeout((function(){t.busy=!1,t.pushChanges()}),300)}),(function(t){return console.log("UpdateViewItemComponent.onSubmit.inferItemUpdate$.error",t)}))}else this.form.touched=!0},r.onRemove=function(t){var e=this;Gt.open$({src:C.template.modal.remove,data:{item:this.item}}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){t instanceof jt&&e.delete.next({view:e.view,item:e.item})}))},r.onSelect=function(t){this.select.next({view:this.view,item:this.item.selected?null:this.item})},r.getTitle=function(t){return M.getKeys("editor",t.type.name)},o}(t.Component);en.meta={selector:"update-view-item",outputs:["select","update","delete"],inputs:["view","item"],template:'\n\t\t<div class="group--headline" [class]="{ active: item.selected }" (click)="onSelect($event)">\n\t\t\t\x3c!-- <div class="id" [innerHTML]="item.id"></div> --\x3e\n\t\t\t<div class="icon">\n\t\t\t\t<svg-icon [name]="item.type.name"></svg-icon>\n\t\t\t</div>\n\t\t\t<div class="title" [innerHTML]="getTitle(item)"></div>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off" *if="item.selected">\n\t\t\t<div class="form-controls">\n\t\t\t\t<div control-text [control]="controls.id" label="Id" [disabled]="true"></div>\n\t\t\t\t\x3c!-- <div control-text [control]="controls.type" label="Type" [disabled]="true"></div> --\x3e\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'nav\'">\n\t\t\t\t<div control-text [control]="controls.title" label="Title"></div>\n\t\t\t\t<div control-textarea [control]="controls.abstract" label="Abstract"></div>\n\t\t\t\t<div control-custom-select [control]="controls.viewId" label="NavToView"></div>\n\t\t\t\t\x3c!-- <div control-checkbox [control]="controls.keepOrientation" label="Keep Orientation"></div> --\x3e\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="3"></div>\n\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/jpeg, image/png"></div>\n\t\t\t\t<div control-text [control]="controls.link.controls.title" label="Link Title"></div>\n\t\t\t\t<div control-text [control]="controls.link.controls.href" label="Link Url"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'plane\'">\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="1"></div>\n\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360"></div>\n\t\t\t\t<div control-vector [control]="controls.scale" label="Scale" [precision]="2"></div>\n\t\t\t\t<div control-custom-select [control]="controls.assetType" label="Asset" (change)="onAssetTypeDidChange($event)"></div>\n\t\t\t\t<div control-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4" *if="controls.assetType.value == 1"></div>\n\t\t\t\t<div control-checkbox [control]="controls.hasChromaKeyColor" label="Use Green Screen" *if="item.asset"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'curved-plane\'">\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="1"></div>\n\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360"></div>\n\t\t\t\t\x3c!-- <div control-vector [control]="controls.scale" label="Scale" [precision]="2" [disabled]="true"></div> --\x3e\n\t\t\t\t<div control-number [control]="controls.radius" label="Radius" [precision]="2"></div>\n\t\t\t\t<div control-number [control]="controls.height" label="Height" [precision]="2"></div>\n\t\t\t\t<div control-number [control]="controls.arc" label="Arc" [precision]="0"></div>\n\t\t\t\t<div control-custom-select [control]="controls.assetType" label="Asset" (change)="onAssetTypeDidChange($event)"></div>\n\t\t\t\t<div control-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4" *if="controls.assetType.value == 1"></div>\n\t\t\t\t<div control-checkbox [control]="controls.hasChromaKeyColor" label="Use Green Screen" *if="item.asset"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'model\'">\n\t\t\t\t<div control-vector [control]="controls.position" label="Position" [precision]="1" *if="view.type.name !== \'model\'"></div>\n\t\t\t\t<div control-vector [control]="controls.rotation" label="Rotation" [precision]="3" [increment]="Math.PI / 360" *if="view.type.name !== \'model\'"></div>\n\t\t\t\t<div control-model [control]="controls.asset" label="Model (.glb)" accept=".glb"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="item.type.name == \'texture\'">\n\t\t\t\t<div control-custom-select [control]="controls.assetType" label="Asset" (change)="onAssetTypeDidChange($event)"></div>\n\t\t\t\t<div control-asset [control]="controls.asset" label="Image or Video" accept="image/jpeg, video/mp4" *if="controls.assetType.value == 1"></div>\n\t\t\t\t<div control-checkbox [control]="controls.hasChromaKeyColor" label="Use Green Screen" *if="item.asset"></div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<button type="submit" class="btn--update" [class]="{ busy: busy }">\n\t\t\t\t\t<span [innerHTML]="\'update\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--remove" (click)="onRemove($event)">\n\t\t\t\t\t<span [innerHTML]="\'remove\' | label"></span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</form>\n\t'};var nn=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var o=i.prototype;return o.onInit=function(){var t=this;this.busy=!1,this.active=!1;var n=this.form=new e.FormGroup({id:new e.FormControl(this.tile.id,e.RequiredValidator()),asset:new e.FormControl(this.tile.asset,e.RequiredValidator()),navs:new e.FormControl(this.tile.navs,e.RequiredValidator())});this.controls=n.controls,n.changes$.subscribe((function(e){var n=t.tile;Object.assign(n,e),"function"==typeof n.onUpdate&&n.onUpdate(),t.pushChanges()})),console.log("UpdateViewTileComponent.onInit",this.view,this.tile)},o.onSubmit=function(){var t=this;if(!this.busy&&this.form.valid){this.busy=!0,this.pushChanges();var e=Object.assign({},this.form.value),n=this.view,i=e;this.update.next({view:n,tile:i}),setTimeout((function(){t.busy=!1,t.pushChanges()}),300)}else this.form.touched=!0},o.onRemove=function(t){var e=this;Gt.open$({src:C.template.modal.remove,data:{tile:this.tile}}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){t instanceof jt&&e.delete.next({view:e.view,tile:e.tile})}))},o.onSelect=function(t){this.select.next({view:this.view,tile:this.tile.selected?null:this.tile})},i}(t.Component);nn.meta={selector:"update-view-tile",outputs:["select","update","delete"],inputs:["view","tile"],template:'\n\t\t<div class="group--headline" [class]="{ active: tile.selected }" (click)="onSelect($event)">\n\t\t\t<div class="icon">\n\t\t\t\t<svg-icon name="tile"></svg-icon>\n\t\t\t</div>\n\t\t\t<div class="title">Tile {{tile.id}}</div>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off" *if="tile.selected">\n\t\t\t<div class="form-controls">\n\t\t\t\t<div control-text [control]="controls.id" label="Id" [disabled]="true"></div>\n\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/jpeg, image/png"></div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<button type="submit" class="btn--update" [class]="{ busy: busy }">\n\t\t\t\t\t<span [innerHTML]="\'update\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t\x3c!--\n\t\t\t\t<button type="button" class="btn--remove" (click)="onRemove($event)">\n\t\t\t\t\t<span [innerHTML]="\'remove\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t--\x3e\n\t\t\t</div>\n\t\t</form>\n\t'};var on=function(t){function i(){return t.apply(this,arguments)||this}h(i,t);var o=i.prototype;return o.onInit=function(){var t=this;this.busy=!1,this.flags=C.flags;var i=this.form=new e.FormGroup;this.controls=i.controls,i.changes$.subscribe((function(e){t.pushChanges()})),this.doUpdateForm(),St.in$.pipe(n.auditTime(500),n.takeUntil(this.unsubscribe$)).subscribe((function(e){switch(e.type){case lt:switch(t.view.type.name){case Nt.Panorama.name:case Nt.PanoramaGrid.name:case Nt.Model.name:t.form.patch({latitude:e.orientation.latitude,longitude:e.orientation.longitude,zoom:e.zoom})}}}))},o.doUpdateForm=function(){var t=this.view;if(!this.type||this.type.name!==t.type.name){this.type=t.type;var n,i=this.form;switch(Object.keys(this.controls).forEach((function(t){i.removeKey(t)})),t.type.name){case Nt.WaitingRoom.name:n=["id","type","name","latitude","longitude","zoom","asset"];break;case Nt.Panorama.name:n=["id","type","name","hidden?","latitude","longitude","zoom","asset"];break;case Nt.PanoramaGrid.name:n=["id","type","name","hidden?","latitude","longitude","zoom"];break;case Nt.Model.name:n=["id","type","name","hidden?","latitude","longitude","zoom","asset"];break;default:n=["id","type","name"]}t.type.name!==Nt.WaitingRoom.name&&C.flags.ar&&(n.push("usdz?"),n.push("gltf?")),n.forEach((function(n){var o=-1!==n.indexOf("?");switch(n=n.replace("?","")){case"latitude":case"longitude":var r=t.orientation||{latitude:0,longitude:0};i.add(new e.FormControl(r[n],e.RequiredValidator()),n);break;case"usdz":case"gltf":i.add(new e.FormControl(t.ar&&t.ar[n]||null,o?void 0:e.RequiredValidator()),n);break;default:i.add(new e.FormControl(null!=t[n]?t[n]:null,o?void 0:e.RequiredValidator()),n)}})),this.controls=i.controls}},o.onChanges=function(t){this.doUpdateForm()},o.onSubmit=function(){var t=this;if(!this.busy&&this.form.valid){this.busy=!0,this.pushChanges();var e=Object.assign({},this.view,this.form.value);null!=e.latitude&&(e.orientation={latitude:e.latitude,longitude:e.longitude},delete e.latitude,delete e.longitude),null==e.usdz&&null==e.gltf||(e.ar={usdz:e.usdz||null,gltf:e.gltf||null},delete e.usdz,delete e.gltf);var i=new Kt(e);Ve.viewUpdate$(i).pipe(n.first()).subscribe((function(e){t.update.next({view:i}),setTimeout((function(){t.busy=!1,t.pushChanges()}),300)}),(function(t){return console.log("UpdateViewComponent.onSubmit.viewUpdate$.error",t)}))}else this.form.touched=!0},o.onRemove=function(t){var e=this;Gt.open$({src:C.template.modal.remove,data:{item:this.item}}).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){t instanceof jt&&e.delete.next({view:e.view})}))},o.onSelect=function(t){this.select.next({view:this.view.selected?null:this.view})},o.getTitle=function(t){return M.getKeys("editor",t.type.name)},i}(t.Component);on.meta={selector:"update-view",outputs:["select","update","delete"],inputs:["view"],template:'\n\t\t<div class="group--headline" [class]="{ active: view.selected }" (click)="onSelect($event)">\n\t\t\t\x3c!-- <div class="id" [innerHTML]="view.id"></div> --\x3e\n\t\t\t<div class="icon">\n\t\t\t\t<svg-icon [name]="view.type.name"></svg-icon>\n\t\t\t</div>\n\t\t\t<div class="title" [innerHTML]="getTitle(view)"></div>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<form [formGroup]="form" (submit)="onSubmit()" name="form" role="form" novalidate autocomplete="off" *if="view.selected">\n\t\t\t<div class="form-controls">\n\t\t\t\t<div control-text [control]="controls.id" label="Id" [disabled]="true"></div>\n\t\t\t\t\x3c!-- <div control-text [control]="controls.type" label="Type" [disabled]="true"></div> --\x3e\n\t\t\t\t<div control-text [control]="controls.name" label="Name"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'waiting-room\'">\n\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/jpeg"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'panorama\'">\n\t\t\t\t<div control-checkbox [control]="controls.hidden" label="Hide from menu"></div>\n\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/jpeg, video/mp4"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'panorama-grid\'">\n\t\t\t\t<div control-checkbox [control]="controls.hidden" label="Hide from menu"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name == \'model\'">\n\t\t\t\t<div control-checkbox [control]="controls.hidden" label="Hide from menu"></div>\n\t\t\t\t<div control-asset [control]="controls.asset" label="Image" accept="image/jpeg"></div>\n\t\t\t\t<div control-text [control]="controls.latitude" label="Latitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.longitude" label="Longitude" [disabled]="true"></div>\n\t\t\t\t<div control-text [control]="controls.zoom" label="Zoom" [disabled]="true"></div>\n\t\t\t</div>\n\t\t\t<div class="form-controls" *if="view.type.name != \'waiting-room\' && flags.ar">\n\t\t\t\t<div control-model [control]="controls.usdz" label="AR IOS (.usdz)" accept=".usdz"></div>\n\t\t\t\t<div control-model [control]="controls.gltf" label="AR Android (.glb)" accept=".glb"></div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<button type="submit" class="btn--update" [class]="{ busy: busy }">\n\t\t\t\t\t<span [innerHTML]="\'update\' | label"></span>\n\t\t\t\t</button>\n\t\t\t\t<button type="button" class="btn--remove" *if="view.type.name != \'waiting-room\'" (click)="onRemove($event)">\n\t\t\t\t\t<span [innerHTML]="\'remove\' | label"></span>\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</form>\n\t'};var rn=[Ue,We,De,Ke,Ne,Xe,Ye,Je,Qe,Ze,tn,Le,en,nn,on],sn=[],an=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(t.Module);an.meta={imports:[],declarations:[].concat(rn,sn),exports:[].concat(rn,sn)};var un=function(t){this.file=t,this.name=t.name,this.type=Ee(t.name),this.progress=0,this.size=t.size,this.uploading=!1,this.paused=!1,this.success=!1,this.complete=!1,this.error=null,this.preview=null},ln=function(t){t&&Object.assign(this,t)},cn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(ln),dn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(ln),hn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(ln),pn=function(){function e(){this.concurrent$=new i.BehaviorSubject(0),this.items$=new i.BehaviorSubject([]),this.events$=new i.ReplaySubject(1)}var o=e.prototype;return o.upload$=function(){var t=this,e=this.items$.getValue().filter((function(t){return!t.uploading}));return i.combineLatest(e.map((function(e){return t.uploadItem$(e)})))},o.uploadItem$=function(t){var e=this;t.uploading=!0,this.events$.next(new cn({item:t}));var o=[t.file];return i.of(o).pipe(n.delayWhen((function(){return e.concurrent$.pipe(n.filter((function(t){return t<4})))})),n.tap((function(){return e.concurrent$.next(e.concurrent$.getValue()+1)})),n.first(),n.switchMap((function(t){return Be.upload$(t)})),n.switchMap((function(i){var o=i[0];t.uploading=!1,t.complete=!0;var r=xe.fromUrl(o.url);return e.events$.next(new dn({item:t,asset:r})),Be.assetCreate$(r).pipe(n.tap((function(n){e.remove(t),e.events$.next(new hn({item:t,asset:n})),e.concurrent$.next(e.concurrent$.getValue()-1)})))})))},o.addItems=function(t){if(t&&t.length){var e=this.items$.getValue(),n=Array.from(t).map((function(t){return new un(t)}));e.push.apply(e,n),this.items$.next(e)}},o.remove=function(t){var e=this.items$.getValue(),n=e.indexOf(t);-1!==n&&e.splice(n,1),this.items$.next(e)},o.removeAll=function(){this.items$.next([])},o.drop$=function(e,o){var r=this;if(t.isPlatformBrowser&&e){o=o||e;var s=document.querySelector("body");return i.merge(i.fromEvent(s,"drop"),i.fromEvent(s,"dragover")).pipe(n.map((function(t){return t.preventDefault(),t.target===o&&r.addItems(t.dataTransfer.files),r.items$})))}return i.EMPTY},o.change$=function(e){var o=this;return t.isPlatformBrowser&&e?i.fromEvent(e,"change").pipe(n.switchMap((function(t){return e.files.length&&(o.addItems(e.files),e.value=""),o.items$}))):i.EMPTY},o.files$=function(t){var e=this;return i.combineLatest(Array.from(t).map((function(t,n){return e.file$(t,n)})))},o.file$=function(t,e){var i=this;return this.read$(t,e).pipe(n.switchMap((function(){return i.uploadFile$(t)})))},o.read$=function(t,e){var o=this,r=new FileReader,s=i.fromEvent(r,"load").pipe(n.tap((function(t){var n=t.target.result;o.resize(n,(function(t){o.previews[e]=t,o.pushChanges()}))})));return r.readAsDataURL(t),s},o.uploadFile$=function(t){return Be.upload$([t]).pipe(n.switchMap((function(t){var e=t[0],n=xe.fromUrl(e.url);return Be.assetCreate$(n)})))},o.resize=function(t,e){if("function"==typeof e){var n=document.createElement("img");n.onload=function(){var t=document.createElement("canvas"),i=t.getContext("2d"),o=n.width,r=n.height;o>r?o>320&&(r*=320/o,o=320):r>240&&(o*=240/r,r=240),t.width=o,t.height=r,i.drawImage(n,0,0,o,r);var s=t.toDataURL("image/jpeg",.9);e(s)},n.src=t}},o.supported=function(){return(e=document.createElement("input")).type="file","files"in e&&!!((t=new XMLHttpRequest)&&"upload"in t&&"onprogress"in t.upload)&&!!window.FormData;var t,e},e}(),mn=function(e){function i(){return e.apply(this,arguments)||this}h(i,e);var o=i.prototype;return o.onInit=function(){var e=this;this.label=this.label||"label",this.accept=this.accept||"image/png, image/jpeg",this.multiple=!1!==this.multiple,this.items=[],this.assets=this.control.value||[],this.hasFiles=!1;var i=t.getContext(this).node,o=i.querySelector("input");o.setAttribute("accept",this.accept);var r=i.querySelector(".upload-drop"),s=this.service=new pn;s.drop$(o,r).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.items=t,e.pushChanges()})),s.change$(o).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.items=t,e.pushChanges()})),s.events$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){t instanceof hn&&(e.assets.push(t.asset),e.control.value=e.assets),e.items=e.items,e.pushChanges()}))},o.onUpload=function(){this.service.upload$().pipe(n.first()).subscribe()},o.onCancel=function(){this.service.removeAll()},o.onItemPause=function(t){},o.onItemResume=function(t){},o.onItemCancel=function(t){},o.onItemRemove=function(t){this.service.remove(t)},l(i,[{key:"items",get:function(){return this.items_},set:function(t){this.items_=t,this.uploadCount=t.reduce((function(t,e){return t+(e.uploading||e.completed?0:1)}),0)}}]),i}(Ge);mn.meta={selector:"[control-assets]",inputs:["control","label","multiple"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="listing--assets">\n\t\t\t\t<div class="listing__item" *for="let item of assets">\n\t\t\t\t\t<div class="upload-item">\n\t\t\t\t\t\t<div class="picture">\n\t\t\t\t\t\t\t<img [lazy]="item | asset" [size]="{ width: 320, height: 240 }" *if="item.type.name === \'image\'" />\n\t\t\t\t\t\t\t<video [src]="item | asset" *if="item.type.name === \'video\'"></video>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="name" [innerHTML]="item.file"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="listing__item" *for="let item of items">\n\t\t\t\t\t<div upload-item [item]="item" (pause)="onItemPause($event)" (resume)="onItemResume($event)" (cancel)="onItemCancel($event)" (remove)="onItemRemove($event)"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="group--cta">\n\t\t\t\t<div class="btn--browse">\n\t\t\t\t\t<span [innerHTML]="\'browse\' | label"></span>\n\t\t\t\t\t<input type="file" accept="image/jpeg" multiple />\n\t\t\t\t</div>\n\t\t\t\t<div class="btn--upload" (click)="onUpload()" *if="uploadCount > 0" [innerHTML]="\'upload\' | label"></div>\n\t\t\t\t<div class="btn--cancel" (click)="onCancel()" *if="uploadCount > 0" [innerHTML]="\'cancel\' | label"></div>\n\t\t\t</div>\n\t\t\t<div class="upload-drop">\n    \t\t\t<span [innerHTML]="\'drag_and_drop_images\' | label"></span>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};var fn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.prototype.onInit=function(){this.label=this.label||"label"},e}(Ge);fn.meta={selector:"[control-checkbox]",inputs:["control","label"],template:'\n\t\t<div class="group--form--checkbox" [class]="{ required: control.validators.length }">\n\t\t\t<label>\n\t\t\t\t<input type="checkbox" class="control--checkbox" [formControl]="control" [value]="true" />\n\t\t\t\t<span [innerHTML]="label | html"></span>\n\t\t\t</label>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};var vn=function(){function t(){}return t.keydown$=function(){return this.keydown$_||(this.keydown$_=i.fromEvent(window,"keydown").pipe(n.shareReplay(1))),this.keydown$_},t.keyup$=function(){return this.keyup$_||(this.keyup$_=i.fromEvent(window,"keyup").pipe(n.shareReplay(1))),this.keyup$_},t.keys$=function(){var t=this;return this.keys$_||(this.keys$_=i.merge(this.keydown$(),this.keyup$()).pipe(n.map((function(e){var n=t.keys;return"keydown"===e.type?n[e.key]=!0:delete n[e.key],t.keys})),n.startWith(this.keys),n.shareReplay(1))),this.keys$_},t.key$=function(){if(!this.key$_){var t=/\w/;this.key$_=this.keydown$().pipe(n.filter((function(e){return e.key&&e.key.match(t)})),n.map((function(t){return t.key})),n.shareReplay(1))}return this.key$_},t.typing$=function(){if(!this.typing$_){var t,e="";this.typing$_=this.key$().pipe(n.map((function(n){return t&&clearTimeout(t),e+=n,t=setTimeout((function(){e=""}),1500),e})),n.shareReplay(1))}return this.typing$_},t}();c(vn,"keys",{});var gn=function(e){function i(){return e.apply(this,arguments)||this}h(i,e);var o=i.prototype;return o.onInit=function(){var t=this;this.label=this.label||"label",this.dropped=!1,this.dropdownId=Ae.nextId(),vn.typing$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.scrollToWord(e)}))},o.scrollToWord=function(e){for(var n=this.control.options||[],i=-1,o=0;o<n.length;o++){if(0===n[o].name.toLowerCase().indexOf(e.toLowerCase())){i=o;break}}if(-1!==i){var r=t.getContext(this).node,s=r.querySelector(".dropdown"),a=r.querySelector(".nav--dropdown").children[i];s.scrollTo(0,a.offsetTop)}},o.setOption=function(t){var e;if(this.isMultiple){var n=this.control.value||[],i=n.indexOf(t.id);-1!==i?n.splice(i,1):n.push(t.id),function(t){throw new Error('"'+t+'" is read-only')}("value"),n=n.length?n.slice():null}else e=t.id;this.control.value=e,this.change.next(e)},o.hasOption=function(t){return this.isMultiple?-1!==(this.control.value||[]).indexOf(t.id):this.control.value===t.id},o.getLabel=function(){var t=this.control.value,e=this.control.options||[];if(this.isMultiple)return(t=t||[]).length?t.map((function(t){var n=e.find((function(e){return e.id===t||e.name===t}));return n?n.name:""})).join(", "):M.transform("select");var n=e.find((function(e){return e.id===t||e.name===t}));return n?n.name:M.transform("select")},o.onDropped=function(t){this.dropped&&null===t&&(this.control.touched=!0),this.dropped=t===this.dropdownId},l(i,[{key:"isMultiple",get:function(){return this.multiple&&!1!==this.multiple&&"false"!==this.multiple}}]),i}(Ge);gn.meta={selector:"[control-custom-select]",outputs:["change"],inputs:["control","label","multiple"],template:'\n\t\t<div class="group--form--select" [class]="{ required: control.validators.length, multiple: isMultiple }" [dropdown]="dropdownId" (dropped)="onDropped($event)">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<span class="control--custom-select" [innerHTML]="getLabel()"></span>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t\t<div class="dropdown" [dropdown-item]="dropdownId">\n\t\t\t<div class="category" [innerHTML]="label"></div>\n\t\t\t<ul class="nav--dropdown" [class]="{ multiple: isMultiple }">\n\t\t\t\t<li (click)="setOption(item)" [class]="{ empty: item.id == null }" *for="let item of control.options">\n\t\t\t\t\t<span [class]="{ active: hasOption(item) }" [innerHTML]="item.name"></span>\n\t\t\t\t</li>\n\t\t\t</ul>\n\t\t</div>\n\t'};var bn=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var n=e.prototype;return n.onInit=function(){var t=this;this.label=this.label||"label",this.disabled=this.disabled||!1;var e=getContext(this).node,n=this.input=e.querySelector("input");merge(fromEvent(n,"input")).pipe(takeUntil(this.unsubscribe$)).subscribe((function(e){return t.onInputDidChange(e)})),fromEvent(n,"blur").pipe(takeUntil(this.unsubscribe$)).subscribe((function(e){return t.onInputDidBlur(e)}))},n.onInputDidChange=function(t){console.log("ControlLinkComponent.onInputDidChange",t.target.value)},n.onInputDidBlur=function(t){console.log("ControlLinkComponent.onInputDidBlur",t.target.value),this.control.touched=!0,this.value=this.input.value},e}(Ge);bn.meta={selector:"[control-link]",inputs:["control","label","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<input type="text" class="control--text" [formControl]="control" [placeholder]="label" [disabled]="disabled" />\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};var yn=function(e){function o(){return e.apply(this,arguments)||this}h(o,e);var r=o.prototype;return r.onInit=function(){var e=this;this.label=this.label||"label",this.disabled=this.disabled||!1,this.accept=this.accept||".glb";var i=t.getContext(this).node,o=this.input=i.querySelector("input");o.setAttribute("accept",this.accept),this.change$(o).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){console.log("ControlModelComponent.change$",t),e.control.value=t[0]}))},r.onRemove=function(t){this.control.value=null,this.input.value=null},r.read$=function(t,e){return i.of(t)},o}(ze);yn.meta={selector:"[control-model]",inputs:["control","label","disabled","accept"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="group--model">\n\t\t\t\t<div class="file-name" *if="!control.value" [innerHTML]="\'select_file\' | label"></div>\n\t\t\t\t<div class="file-name" *if="control.value" [innerHTML]="control.value.file"></div>\n\t\t\t\t<div class="btn--upload"><input type="file"><span [innerHTML]="\'browse\' | label"></span></div>\n\t\t\t\t<div class="btn--remove" *if="control.value" (click)="onRemove($event)"><span [innerHTML]="\'remove\' | label"></span></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};var wn=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var n=e.prototype;return n.onInit=function(){this.label=this.label||"label",this.precision=this.precision||3,this.increment=this.increment||1/Math.pow(10,this.precision),this.disabled=this.disabled||!1},n.updateValue=function(t){this.control.value=t},e}(Ge);wn.meta={selector:"[control-number]",inputs:["control","label","precision","increment","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="control--content control--number">\n\t\t\t\t<input-value label="" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value" (update)="updateValue($event)"></input-value>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};var En=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.prototype.onInit=function(){this.label=this.label||"label"},e}(Ge);En.meta={selector:"[control-password]",inputs:["control","label"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<input type="password" class="control--text" [formControl]="control" [placeholder]="label" />\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};var xn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.prototype.onInit=function(){this.label=this.label||"label"},e}(Ge);xn.meta={selector:"[control-select]",inputs:["control","label"],template:'\n\t\t<div class="group--form--select" [class]="{ required: control.validators.length }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<select class="control--select" [formControl]="control" required>\n\t\t\t\t<option [value]="null" [innerHTML]="\'select\' | label"></option>\n\t\t\t\t<option [value]="item.id" *for="let item of control.options" [innerHTML]="item.name"></option>\n\t\t\t</select>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t<svg class="icon--caret-down"><use xlink:href="#caret-down"></use></svg>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};var Tn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.prototype.onInit=function(){this.label=this.label||"label",this.disabled=this.disabled||!1},e}(Ge);Tn.meta={selector:"[control-text]",inputs:["control","label","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t<input type="text" class="control--text" [formControl]="control" [placeholder]="label" [disabled]="disabled" />\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};var In=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.prototype.onInit=function(){this.label=this.label||"label",this.disabled=this.disabled||!1},e}(Ge);In.meta={selector:"[control-textarea]",inputs:["control","label","disabled"],template:'\n\t\t<div class="group--form--textarea" [class]="{ required: control.validators.length, disabled: disabled }">\n\t\t\t<label [innerHTML]="label"></label>\n\t\t\t<textarea class="control--text" [formControl]="control" [placeholder]="label" [innerHTML]="label" rows="6" [disabled]="disabled"></textarea>\n\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};var Rn=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var n=e.prototype;return n.onInit=function(){this.label=this.label||"label",this.precision=this.precision||3,this.increment=this.increment||1/Math.pow(10,this.precision),this.disabled=this.disabled||!1},n.updateValue=function(t,e){var n=this.control.value;n[t]=e,this.control.value=n.slice()},e}(Ge);Rn.meta={selector:"[control-vector]",inputs:["control","label","precision","increment","disabled"],template:'\n\t\t<div class="group--form" [class]="{ required: control.validators.length }">\n\t\t\t<div class="control--head">\n\t\t\t\t<label [innerHTML]="label"></label>\n\t\t\t\t<span class="required__badge" [innerHTML]="\'required\' | label"></span>\n\t\t\t</div>\n\t\t\t<div class="control--content control--vector">\n\t\t\t\t<input-value label="x" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value[0]" (update)="updateValue(0, $event)"></input-value>\n\t\t\t\t<input-value label="y" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value[1]" (update)="updateValue(1, $event)"></input-value>\n\t\t\t\t<input-value label="z" [precision]="precision" [increment]="increment" [disabled]="disabled" [value]="control.value[2]" (update)="updateValue(2, $event)"></input-value>\n\t\t\t</div>\n\t\t</div>\n\t\t<errors-component [control]="control"></errors-component>\n\t'};var Cn=function(e){function n(){return e.apply(this,arguments)||this}return h(n,e),n.prototype.onChanges=function(){var e=t.getContext(this).node;!0===this.disabled?(e.disabled=this.disabled,e.setAttribute("disabled",this.disabled)):(delete e.disabled,e.removeAttribute("disabled"))},n}(t.Directive);Cn.meta={selector:"input[disabled],textarea[disabled]",inputs:["disabled"]};var kn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.prototype.getLabel=function(t,e){return M.transform("error_"+t)},e}(Ge);kn.meta={selector:"errors-component",inputs:["control"],template:'\n\t<div class="inner" [style]="{ display: control.invalid && control.touched ? \'block\' : \'none\' }">\n\t\t<div class="error" *for="let [key, value] of control.errors">\n\t\t\t<span [innerHTML]="getLabel(key, value)"></span>\n\t\t\t\x3c!-- <span class="key" [innerHTML]="key"></span> <span class="value" [innerHTML]="value | json"></span> --\x3e\n\t\t</div>\n\t</div>\n\t'};var Mn=function(e){function o(){return e.apply(this,arguments)||this}h(o,e);var r=o.prototype;return r.onInit=function(){var e=this;this.label=this.label||"label",this.value=this.value||0,this.precision=this.precision||3,this.increment=this.increment||1/Math.pow(10,this.precision),this.disabled=this.disabled||!1,this.increment$(".btn--more",1).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.value+=t,e.update.next(e.value),e.pushChanges()})),this.increment$(".btn--less",-1).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.value+=t,e.update.next(e.value),e.pushChanges()}));var o=t.getContext(this).node,r=this.input=o.querySelector("input");i.merge(i.fromEvent(r,"input")).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){return e.onInputDidChange(t)})),i.fromEvent(r,"blur").pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){return e.onInputDidBlur(t)}))},r.onInputDidChange=function(t){t.target.value=t.target.value.replace(/[^\d|\.]/g,"")},r.onInputDidBlur=function(t){var e=parseFloat(this.input.value);this.value!==e&&(NaN!==e?(this.value=e,this.update.next(this.value)):this.input.value=this.getValue())},r.increment$=function(e,o){var r,s,a=this,u=t.getContext(this).node.querySelector(e);return i.race(i.fromEvent(u,"mousedown"),i.fromEvent(u,"touchstart")).pipe(n.tap((function(){s=a.increment,r=32})),n.switchMap((function(t){return i.interval(30).pipe(n.filter((function(t){return t%r==0})),n.map((function(){var t=s*o;return r=Math.max(1,Math.floor(.85*r)),t})),n.takeUntil(i.race(i.fromEvent(u,"mouseup"),i.fromEvent(u,"touchend"))))})))},r.getValue=function(){return this.value.toFixed(this.precision)},r.setValue=function(t){this.value+=this.increment*t,this.update.next(this.value),this.pushChanges()},o}(t.Component);Mn.meta={selector:"input-value",outputs:["update"],inputs:["value","label","precision","increment","disabled"],template:'\n\t\t<div class="group--control" [class]="{ disabled: disabled }">\n\t\t\t<input type="text" class="control--text" [placeholder]="label" [value]="getValue()" [disabled]="disabled" />\n\t\t\t<div class="control--trigger">\n\t\t\t\t<div class="btn--more" (click)="setValue(1)">+</div>\n\t\t\t\t<div class="btn--less" (click)="setValue(-1)">-</div>\n\t\t\t</div>\n\t\t</div>\n\t'};var Sn=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var n=e.prototype;return n.onInit=function(){this.env=x},n.onTest=function(t){this.test.next(t)},n.onReset=function(t){this.reset.next(t)},e}(t.Component);Sn.meta={selector:"test-component",inputs:["form"],outputs:["test","reset"],template:'\n\t<div class="group--form--results" *if="env.DEVELOPMENT">\n\t\t<code [innerHTML]="form.value | json"></code>\n\t\t<button type="button" class="btn--mode" (click)="onTest($event)"><span>test</span></button>\n\t\t<button type="button" class="btn--mode" (click)="onReset($event)"><span>reset</span></button>\n\t</div>\n\t'};var $n=function(e){function n(){return e.apply(this,arguments)||this}return h(n,e),n.prototype.onChanges=function(e){var n=t.getContext(this).node;n.value=this.value,n.setAttribute("value",this.value)},n}(t.Directive);$n.meta={selector:"[value]",inputs:["value"]};var Hn=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e.transform=function(t){if(t){t=t.replace(/&#(\d+);/g,(function(t,e){return String.fromCharCode(parseInt(e))}));var e=['"',"&","'","<",">"," ","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","&","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""],n=new RegExp("(&"+["quot","amp","apos","lt","gt","nbsp","iexcl","cent","pound","curren","yen","brvbar","sect","uml","copy","ordf","laquo","not","shy","reg","macr","deg","plusmn","sup2","sup3","acute","micro","para","middot","cedil","sup1","ordm","raquo","frac14","frac12","frac34","iquest","Agrave","Aacute","Acirc","Atilde","Auml","Aring","AElig","Ccedil","Egrave","Eacute","Ecirc","Euml","Igrave","Iacute","Icirc","Iuml","ETH","Ntilde","Ograve","Oacute","Ocirc","Otilde","Ouml","times","Oslash","Ugrave","Uacute","Ucirc","Uuml","Yacute","THORN","szlig","agrave","aacute","atilde","auml","aring","aelig","ccedil","egrave","eacute","ecirc","euml","igrave","iacute","icirc","iuml","eth","ntilde","ograve","oacute","ocirc","otilde","ouml","divide","oslash","ugrave","uacute","ucirc","uuml","yacute","thorn","yuml","amp","bull","deg","infin","permil","sdot","plusmn","dagger","mdash","not","micro","perp","par","euro","pound","yen","cent","copy","reg","trade","alpha","beta","gamma","delta","epsilon","zeta","eta","theta","iota","kappa","lambda","mu","nu","xi","omicron","pi","rho","sigma","tau","upsilon","phi","chi","psi","omega","Alpha","Beta","Gamma","Delta","Epsilon","Zeta","Eta","Theta","Iota","Kappa","Lambda","Mu","Nu","Xi","Omicron","Pi","Rho","Sigma","Tau","Upsilon","Phi","Chi","Psi","Omega"].join(";)|(&")+";)","g");return t=t.replace(n,(function(){for(var t=1;t<arguments.length;t++)if(arguments[t])return e[t-1]}))}},e}(t.Pipe);Hn.meta={name:"html"};var An=function(e){function n(){return e.apply(this,arguments)||this}return h(n,e),n.prototype.onChanges=function(){t.getContext(this).node.setAttribute("id",this.id)},n}(t.Directive);An.meta={selector:"[id]",inputs:["id"]};var Pn=0,_n="progress",On="complete",Ln=function(){function t(){}return t.worker=function(){return this.worker_||(this.worker_=new Worker(C.worker)),this.worker_},t.events$=function(t,e){if(!("Worker"in window)||this.isBlob(t)||this.isCors(t))return i.of({type:On,data:t});var o=++Pn,r=this.worker();return r.postMessage({src:t,id:o,size:e}),i.fromEvent(r,"message").pipe(n.map((function(t){return t.data})),n.filter((function(e){return e.src===t})),n.auditTime(100),n.map((function(t){if(t.type===On&&t.data instanceof Blob){var e=URL.createObjectURL(t.data);t.data=e}return t})),n.takeWhile((function(t){return t.type!==On}),!0),n.finalize((function(){r.postMessage({id:o})})))},t.load$=function(t,e){return this.events$(t,e).pipe(n.filter((function(t){return t.type===On})),n.map((function(t){return t.data})))},t.isCors=function(t){return!1},t.isBlob=function(t){return 0===t.indexOf("blob:")},t}(),Un=function(){function t(){}return t.observer=function(){var t=this;return this.observer_||(this.readySubject_=new i.BehaviorSubject(!1),this.observerSubject_=new i.Subject,this.observer_=new IntersectionObserver((function(e){t.observerSubject_.next(e)}))),this.observer_},t.intersection$=function(t){if("IntersectionObserver"in window){var e=this.observer();return e.observe(t),this.observerSubject_.pipe(n.map((function(e){return e.find((function(e){return e.target===t}))})),n.filter((function(t){return void 0!==t&&t.isIntersecting})),n.first(),n.finalize((function(){return e.unobserve(t)})))}return i.of({target:t})},t}(),Vn=function(){function t(){}return t.get=function(t){return this.cache[t]},t.set=function(t,e){this.cache[t]=e;var n=Object.keys(this.cache);n.length>100&&this.remove(n[0])},t.remove=function(t){delete this.cache[t]},l(t,null,[{key:"cache",get:function(){return this.cache_||(this.cache_={}),this.cache_}}]),t}(),Dn=function(e){function o(){return e.apply(this,arguments)||this}h(o,e);var r=o.prototype;return r.onInit=function(){var e=this,o=t.getContext(this).node;o.classList.add("lazy"),this.input$=(new i.Subject).pipe(n.distinctUntilChanged(),n.switchMap((function(t){var n=Vn.get(t);return n?i.of(n):(o.classList.remove("lazyed"),e.lazy$(t))})),n.takeUntil(this.unsubscribe$)),this.input$.subscribe((function(t){Vn.set(e.lazy,t),o.setAttribute("src",t),o.classList.add("lazyed")}))},r.onChanges=function(){this.input$.next(this.lazy)},r.lazy$=function(e){var i=this,o=t.getContext(this).node;return Un.intersection$(o).pipe(n.switchMap((function(){return Ln.load$(e,i.size)})),n.first())},o}(t.Directive);Dn.meta={selector:"[lazy],[[lazy]]",inputs:["lazy","size"]};var Fn=function(e){function n(){return e.apply(this,arguments)||this}h(n,e);var i=n.prototype;return i.onInit=function(){var e=t.getContext(this).parentInstance;e instanceof zt&&(this.data=e.modal.data)},i.close=function(){Gt.reject()},n}(t.Component);Fn.meta={selector:"[modal]"};var jn=function(e){function n(){return e.apply(this,arguments)||this}h(n,e);var i=n.prototype;return i.onInit=function(){this.update()},i.onChanges=function(){this.update()},i.update=function(){if(this.name_!==this.name){this.name_=this.name;var e=t.getContext(this).node;if(e.parentNode){var n,i=document.createElementNS("http://www.w3.org/2000/svg","svg"),o=this.width||24,r=this.height||24;i.setAttribute("class","icon--"+this.name),i.setAttributeNS(null,"viewBox","0 0 "+o+" "+r),i.innerHTML='<use xlink:href="#'+this.name+'"></use>',i.rxcompId=e.rxcompId,(n=i.classList).add.apply(n,e.classList),e.parentNode.replaceChild(i,e)}}},n}(t.Structure);jn.meta={selector:"svg-icon",inputs:["name","width","height"]};var Bn=function(e){function i(){return e.apply(this,arguments)||this}h(i,e);var o=i.prototype;return o.onInit=function(){var e=this;this.platform=F.platform,this.missingAr=!1,this.missingUsdz=!1,this.missingGltf=!1;var i=this.viewId=this.getViewId();i&&oe.viewById$(i).pipe(n.first()).subscribe((function(n){if(!n.ar)return e.missingAr=!0,void e.pushChanges();if(e.platform===L){var i=e.getUsdzSrc(n);i?window.location.href=i:(e.missingUsdz=!0,e.pushChanges())}else if(null!==e.getGltfSrc(n)){var o=e.getModelViewerNode(n);t.getContext(e).node.appendChild(o)}else e.missingGltf=!0,e.pushChanges()}))},o.getUsdzSrc=function(t){return t.ar&&t.ar.usdz?C.getPath(t.ar.usdz.folder+t.ar.usdz.file):null},o.getGltfSrc=function(t){return t.ar&&t.ar.gltf?C.getPath(t.ar.gltf.folder+t.ar.gltf.file):null},o.getViewId=function(){var t=Ot.get("viewId")||null;return t&&(t=parseInt(t)),t},o.getModelViewerNode=function(t){var e=C.getPath(t.asset.folder+t.asset.file),n=this.getUsdzSrc(t),i=this.getGltfSrc(t),o='\n\t\t\t<model-viewer alt="'+t.name+'" skybox-image="'+e+'" ios-src="'+n+'" src="'+i+'" ar ar-modes="webxr scene-viewer quick-look" ar-scale="auto" camera-controls></model-viewer>\n\t\t',r=document.createElement("div");return r.innerHTML=o,r.firstElementChild},i}(t.Component);Bn.meta={selector:"[try-in-ar]"};var Gn=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var o=e.prototype;return o.onInit=function(){var t=this;null===this.item.preview&&this.read$(this.item.file).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.item.preview=e,t.pushChanges()}))},o.read$=function(t){var e=this,o=new FileReader,r=i.fromEvent(o,"load").pipe(n.switchMap((function(t){var n=t.target.result;return e.item.type.name===be.Image.name?e.resize$(n):i.of(n)})));return o.readAsDataURL(t),r},o.resize$=function(t){return new Promise((function(e,n){var i=document.createElement("img");i.onload=function(){var t=document.createElement("canvas"),n=t.getContext("2d"),o=i.width,r=i.height;o>r?o>320&&(r*=320/o,o=320):r>240&&(o*=240/r,r=240),t.width=o,t.height=r,n.drawImage(i,0,0,o,r);var s=t.toDataURL("image/jpeg",.9);e(s)},i.onerror=function(t){n(t)},i.src=t}))},o.onPause=function(){this.pause.next(this.item)},o.onResume=function(){this.resume.next(this.item)},o.onCancel=function(){this.cancel.next(this.item)},o.onRemove=function(){this.remove.next(this.item)},e}(t.Component);Gn.meta={selector:"[upload-item]",outputs:["pause","resume","cancel","remove"],inputs:["item"],template:'\n\t<div class="upload-item" [class]="{ \'error\': item.error, \'success\': item.success }">\n\t\t<div class="picture">\n\t\t\t<img [lazy]="item.preview" [size]="{ width: 320, height: 240 }" *if="item.preview && item.type.name === \'image\'" />\n\t\t\t<video [src]="item.preview" *if="item.preview && item.type.name === \'video\'"></video>\n\t\t\t<svg class="spinner" width="24" height="24" viewBox="0 0 24 24" [class]="{ uploading: item.uploading }" *if="item.uploading"><use xlink:href="#spinner"></use></svg>\n\t\t</div>\n\t\t<div class="name">{{item.name}}</div>\n\t\t\x3c!--\n\t\t<div class="group--info">\n\t\t\t<div>progress: {{item.progress}}</div>\n\t\t\t<div>size: {{item.size}} bytes</div>\n\t\t\t<div>current speed: {{item.currentSpeed}} bytes/s</div>\n\t\t\t<div>average speed: {{item.averageSpeed}} bytes/s</div>\n\t\t\t<div>time ramining: {{item.timeRemaining}}s</div>\n\t\t\t<div>paused: {{item.paused}}</div>\n\t\t\t<div>success: {{item.success}}</div>\n\t\t\t<div>complete: {{item.complete}}</div>\n\t\t\t<div>error: {{item.error}}</div>\n\t\t</div>\n\t\t--\x3e\n\t\t\x3c!--\n\t\t<div class="group--cta" *if="!item.complete && item.uploading">\n\t\t\t<div class="btn--pause" (click)="onPause()">pause</div>\n\t\t\t<div class="btn--resume" (click)="onResume()">resume</div>\n\t\t\t<div class="btn--cancel" (click)="onCancel()">cancel</div>\n\t\t</div>\n\t\t--\x3e\n\t\t<div class="group--cta">\n\t\t\t<div class="btn--remove" (click)="onRemove()" *if="!item.complete">remove</div>\n\t\t</div>\n\t</div>\n\t'};var zn=function(e){function n(){return e.apply(this,arguments)||this}return h(n,e),n.prototype.play=function(e){var n=t.getContext(this).node;if(Hls.isSupported()){var i=new Hls;i.attachMedia(n),i.on(Hls.Events.MEDIA_ATTACHED,(function(){i.loadSource(e),i.on(Hls.Events.MANIFEST_PARSED,(function(t,e){n.play()}))}))}},l(n,[{key:"hls",set:function(t){this.hls_!==t&&(this.hls_=t,this.play(t))},get:function(){return this.hls_}}]),n}(t.Directive);zn.meta={selector:"[[hls]]",inputs:["hls"]};var qn=0,Nn=function(){function t(){}return t.switchLoaders=function(){var t=this,e=Object.keys(this.items).map((function(e){return t.items[e]})),n=e.length?i.combineLatest(e):i.of(e);this.progress$.next(n)},t.getRef=function(){var t=++qn;return this.items[t]=new i.BehaviorSubject({loaded:0,total:1}),this.switchLoaders(),t},t.setProgress=function(t,e,n){var i=this;void 0===n&&(n=1);var o=this.items[t];o&&o.next({loaded:e,total:n}),e>=n&&setTimeout((function(){delete i.items[t],i.switchLoaders()}),300),this.switchLoaders()},t}();c(Nn,"progress",{value:0,loaded:0,total:0,count:0,title:""}),c(Nn,"items",{}),c(Nn,"progress$",new i.ReplaySubject(1).pipe(n.switchAll(),n.map((function(){var t=Object.keys(Nn.items).map((function(t){return Nn.items[t]})),e=t.reduce((function(t,e,n,i){var o=e.getValue(),r=o.loaded||0,s=o.total||1,a=r/s;return t.value+=a,t.loaded+=r,t.total+=s,t}),{value:0,loaded:0,total:0});return e.count=t.length,t.length&&(e.value/=e.count),e.title=Math.round(100*e.value)+"%",Nn.progress=e,e}))));var Wn=function(){function t(){}return t.load=function(t,e,n){if(this.video=null,t.asset)return t.asset.type.name===be.PublisherStream.name?this.loadPublisherStreamBackground(e,n):-1!==t.asset.file.indexOf(".mp4")||-1!==t.asset.file.indexOf(".webm")?this.loadVideoBackground(C.getPath(t.asset.folder),t.asset.file,e,n):-1!==t.asset.file.indexOf(".m3u8")?this.loadHlslVideoBackground(t.asset.file,e,n):-1!==t.asset.file.indexOf(".hdr")?this.loadRgbeBackground(C.getPath(t.asset.folder),t.asset.file,e,n):this.loadBackgroundImageService(C.getPath(t.asset.folder),t.asset.file,e,n)},t.loadBackground=function(t,e,n,i){var o=new THREE.PMREMGenerator(n);o.compileEquirectangularShader();var r=Nn.getRef(),s=new THREE.TextureLoader;return s.setPath(t).load(e,(function(t){var e=o.fromEquirectangular(t).texture;o.dispose(),"function"==typeof i&&i(e,t,!1),Nn.setProgress(r,1)}),(function(t){console.log(t.loaded,t.total),Nn.setProgress(r,t.loaded,t.total)})),s},t.loadBackgroundImageService=function(t,e,o,r){var s=new THREE.PMREMGenerator(o);s.compileEquirectangularShader();var a=Nn.getRef(),u=new Image;Ln.events$(t+e).pipe(n.tap((function(t){t.type===_n&&Nn.setProgress(a,t.data.loaded,t.data.total)})),n.filter((function(t){return t.type===On})),n.switchMap((function(t){var e=i.fromEvent(u,"load");return u.crossOrigin="anonymous",u.src=t.data,e})),n.takeWhile((function(t){return t.type!==On}),!0)).subscribe((function(t){URL.revokeObjectURL(t.data);var e=new THREE.Texture(u),n=s.fromEquirectangular(e).texture;s.dispose(),"function"==typeof r&&r(n,e,!1),Nn.setProgress(a,1)}))},t.loadRgbeBackground=function(t,e,n,i){var o=new THREE.PMREMGenerator(n);o.compileEquirectangularShader();var r=Nn.getRef(),s=new THREE.RGBELoader;return s.setDataType(THREE.UnsignedByteType).setPath(t).load(e,(function(t){var e=o.fromEquirectangular(t).texture;o.dispose(),"function"==typeof i&&i(e,t,!0),Nn.setProgress(r,1)}),(function(t){Nn.setProgress(r,t.loaded,t.total)})),s},t.loadHlslVideoBackground=function(t,e,n){var i=Nn.getRef(),o=document.createElement("video");if(o.oncanplay=function(){!function(){o.oncanplay=null;var t=new THREE.VideoTexture(o);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.format=THREE.RGBFormat,t.needsUpdate=!0;var r=new THREE.WebGLCubeRenderTarget(1024,{generateMipmaps:!0,minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,mapping:THREE.UVMapping,format:THREE.RGBFormat}).fromEquirectangularTexture(e,t);"function"==typeof n&&n(r.texture,t,!1),Nn.setProgress(i,1)}()},Hls.isSupported()){var r=new Hls;r.attachMedia(o),r.on(Hls.Events.MEDIA_ATTACHED,(function(){r.loadSource(t),r.on(Hls.Events.MANIFEST_PARSED,(function(t,e){o.play()}))}))}},t.loadVideoBackground=function(t,e,n,i){var o=this,r=Nn.getRef();this.video=!0;var s=this.video;s.oncanplay=function(){!function(){s.oncanplay=null;var t=new THREE.VideoTexture(s);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.format=THREE.RGBFormat,t.needsUpdate=!0;var e=o.cubeRenderTarget=new THREE.WebGLCubeRenderTarget(1024,{generateMipmaps:!0,minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,mapping:THREE.UVMapping,format:THREE.RGBFormat}).fromEquirectangularTexture(n,t);"function"==typeof i&&i(e.texture,t,!1),Nn.setProgress(r,1)}()},s.src=t+e,s.load(),s.play().then((function(){}),(function(t){console.log("EnvMapLoader.loadVideoBackground.play.error",t)}))},t.loadPublisherStreamBackground=function(t,e){var i=this;At.getPublisherStreamId$().pipe(n.first()).subscribe((function(n){return function(n){var o="#stream-"+n,r=document.querySelector(o+" video");if(r){var s=function(){var n=i.texture=new THREE.VideoTexture(r);n.minFilter=THREE.LinearFilter,n.magFilter=THREE.LinearFilter,n.mapping=THREE.UVMapping,n.format=THREE.RGBFormat,n.needsUpdate=!0;var o=i.cubeRenderTarget=new THREE.WebGLCubeRenderTarget(1024,{generateMipmaps:!0,minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,mapping:THREE.UVMapping,format:THREE.RGBFormat}).fromEquirectangularTexture(t,n);"function"==typeof e&&e(o.texture,n,!1)};r.crossOrigin="anonymous",r.readyState>=r.HAVE_FUTURE_DATA?s():r.oncanplay=function(){s()}}}(n)}))},l(t,null,[{key:"video",get:function(){return this.video_},set:function(t){if(this.video_&&(this.video_.muted=!0,this.video_.pause(),this.video_.parentNode&&this.video_.parentNode.removeChild(this.video_),this.video_=null),t){var e=this.video_=document.createElement("video");e.loop=!0,e.playsInline=!0,e.crossOrigin="anonymous"}}},{key:"muted",get:function(){return this.muted_},set:function(t){this.muted_=t,this.video&&(this.video.muted=!0===t)}},{key:"cubeRenderTarget",set:function(t){this.cubeRenderTarget_&&(this.cubeRenderTarget_.texture.dispose(),this.cubeRenderTarget_.dispose()),this.cubeRenderTarget_=t}},{key:"texture",set:function(t){this.texture_&&this.texture_.dispose(),this.texture_=t}}]),t}(),Kn=function(t){function e(e,n){var i;return e=e||new THREE.BoxBufferGeometry(5,5,5),n=n||new THREE.MeshBasicMaterial({color:16711935}),(i=t.call(this,e,n)||this).events={},i}h(e,t);var n=e.prototype;return n.on=function(t,e){var n=this,i=this.events[t]=this.events[t]||[];return i.push(e),function(){n.events[t]=i.filter((function(t){return t!==e}))}},n.off=function(t,e){var n=this.events[t];n&&(this.events[t]=n.filter((function(t){return t!==e})))},n.emit=function(t,e){var n=this.events[t];n&&n.forEach((function(t){t(e)}));var i=this.events.broadcast;i&&i.forEach((function(n){n(t,e)}))},e}(function(t){function e(e,n){var i;return e=e||new THREE.BoxBufferGeometry(5,5,5),n=n||new THREE.MeshBasicMaterial({color:16711935}),(i=t.call(this,e,n)||this).freezed=!1,i}h(e,t),l(e,[{key:"freezed",get:function(){return this.freezed_},set:function(t){this.freezed_=t,this.children.filter((function(t){return t.__lookupGetter__("freezed")})).forEach((function(e){return e.freezed=t}))}}]);var n=e.prototype;return n.freeze=function(){this.freezed=!0},n.unfreeze=function(){this.freezed=!1},e}(THREE.Mesh)),Xn=function(){};Xn.items=[],Xn.hittest=function(t,e,n){var i=this;void 0===e&&(e=!1);var o=!1;this.down!==e&&(this.down=e,this.lock=!1,o=!0);var r,s,a=this.items.filter((function(t){return!t.freezed})),u=t.intersectObjects(a),l={};u.forEach((function(t,e){var n=t.object;r=n.uuid,0===e&&(i.lastIntersectedObject!==n||o?(i.lastIntersectedObject=n,s=n):n.intersection&&(Math.abs(n.intersection.point.x-t.point.x)>.01||Math.abs(n.intersection.point.y-t.point.y)>.01)&&(n.intersection=t,n.emit("move",n))),l[r]=t})),0===u.length&&(this.lastIntersectedObject=null);return a.forEach((function(t){t.intersection=l[t.uuid],t.over=t===i.lastIntersectedObject||t.intersection&&!t.depthTest&&(!i.lastIntersectedObject||i.lastIntersectedObject.depthTest),t.down=e&&t.over&&!i.lock,t.down&&(i.lock=!0)})),s}.bind(Xn),Xn.dispose=function(t){if(t){var e=this.items.indexOf(t);-1!==e&&this.items.splice(e,1)}}.bind(Xn);var Yn=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this).depthTest=!0,i.over_=!1,i.down_=!1,Xn.items.push(p(i)),i}return h(e,t),l(e,[{key:"over",get:function(){return this.over_},set:function(t){this.over_!=t&&(this.over_=t,t?this.emit("over",this):this.emit("out",this))}},{key:"down",get:function(){return this.down_},set:function(t){t=t&&this.over,this.down_!=t&&(this.down_=t,t?this.emit("down",this):this.emit("up",this))}}]),e}(Kn);function Qn(t,e,n,i,r,s,a,u,l){o.Texture.call(this,t,e,n,i,r,s,a,u,l),this.format=void 0!==a?a:THREE.RGBFormat,this.minFilter=void 0!==s?s:THREE.LinearFilter,this.magFilter=void 0!==r?r:THREE.LinearFilter,this.mapping=THREE.UVMapping,this.generateMipmaps=!1}Qn.prototype=Object.assign(Object.create(o.Texture.prototype),{constructor:Qn,isVideoTexture:!0,update:function(){var t=this.image;t.readyState>=t.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}});var Jn=function(){function t(){this.muted_=!1,this.subscription=j.state$.subscribe((function(t){return Wn.muted=t.volumeMuted})),this.tween=0,this.create()}var e=t.prototype;return e.create=function(){var t=new THREE.SphereBufferGeometry(101,60,40);t.scale(-1,1,1),t.rotateY(Math.PI);var e=new THREE.ShaderMaterial({depthWrite:!1,vertexShader:"\n#extension GL_EXT_frag_depth : enable\n\nvarying vec2 vUv;\nvoid main() {\n\tvUv = uv;\n\t// gl_PointSize = 8.0;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",fragmentShader:"\n#extension GL_EXT_frag_depth : enable\n\nvarying vec2 vUv;\nuniform vec2 resolution;\nuniform float tween;\nuniform bool rgbe;\nuniform sampler2D texture;\n\nvec3 ACESFilmicToneMapping_( vec3 color ) {\n\tcolor *= 1.8;\n\treturn saturate( ( color * ( 2.51 * color + 0.03 ) ) / ( color * ( 2.43 * color + 0.59 ) + 0.14 ) );\n}\n\nvec4 getColor(vec2 p) {\n\treturn texture2D(texture, p);\n}\n\nvec3 encodeColor(vec4 color) {\n\treturn ACESFilmicToneMapping_(RGBEToLinear(color).rgb);\n}\n\nfloat rand(vec2 co){\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\nvec4 Blur(vec2 st, vec4 color) {\n\tconst float directions = 16.0;\n\tconst float quality = 3.0;\n\tfloat size = 16.0;\n\tconst float PI2 = 6.28318530718;\n\tconst float qq = 1.0;\n\tconst float q = 1.0 / quality;\n\tvec2 radius = size / resolution.xy;\n\tfor (float d = 0.0; d < PI2; d += PI2 / directions) {\n\t\tfor (float i = q; i <= qq; i += q) {\n\t\t\tvec2 dUv = vec2(cos(d), sin(d)) * radius * i;\n\t\t\tcolor += getColor(st + dUv);\n        }\n\t}\n\treturn color /= quality * directions - 15.0 + rand(st) * 4.0;\n}\n\nvoid main() {\n\tvec4 color = texture2D(texture, vUv);\n\t// color = Blur(vUv, color);\n\tif (rgbe) {\n\t\tcolor = vec4(encodeColor(color) * tween + rand(vUv) * 0.01, 1.0);\n\t} else {\n\t\tcolor = vec4(color.rgb * tween + rand(vUv) * 0.01, 1.0);\n\t}\n\tgl_FragColor = color;\n}\n",uniforms:{texture:{type:"t",value:null},resolution:{value:new THREE.Vector2},tween:{value:0},rgbe:{value:!1}}});(this.mesh=new Yn(t,e)).name="[panorama]"},e.change=function(t,e,n,i){var o=t instanceof Yt?t.tiles[t.index_]:t,r=this.mesh.material;this.load(o,e,(function(e,o,s){"function"==typeof i&&i(t),r.uniforms.tween.value=1,r.needsUpdate=!0,setTimeout((function(){"function"==typeof n&&n(e,o,s)}),100)}))},e.crossfade=function(t,e,n){var i=this.mesh.material;this.load(t,e,(function(t,e,o){i.uniforms.tween.value=1,i.needsUpdate=!0,"function"==typeof n&&n(t,e,o)}))},e.load=function(t,e,n){var i=this;if(t.asset){this.currentAsset=t.asset.folder+t.asset.file;var o=this.mesh.material;Wn.load(t,e,(function(e,r,s,a,u){t.asset.folder+t.asset.file===i.currentAsset?(o.uniforms.texture.value&&(o.uniforms.texture.value.dispose(),o.uniforms.texture.value=null),r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,r.mapping=THREE.UVMapping,r.needsUpdate=!0,o.uniforms.texture.value=r,o.uniforms.resolution.value=new THREE.Vector2(r.width,r.height),o.uniforms.tween.value=0,o.uniforms.rgbe.value=s,o.needsUpdate=!0,"function"==typeof n&&n(e,r,s)):r.dispose()}))}},e.loadVideo=function(t){var e=document.createElement("video");e.src=t,e.volume=.8,e.muted=!0,e.playsInline=!0,e.crossOrigin="anonymous",e.play(),this.setVideo(e)},e.setVideo=function(t){var e=this;if(t){t.crossOrigin="anonymous",t.oncanplay=function(){!function(){var n=new Qn(t);n.minFilter=THREE.LinearFilter,n.magFilter=THREE.LinearFilter,n.mapping=THREE.UVMapping,n.format=THREE.RGBFormat,n.needsUpdate=!0;var i=e.mesh.material;i.map=n,i.uniforms.texture.value=n,i.uniforms.resolution.value=new THREE.Vector2(n.width,n.height),i.needsUpdate=!0}()}}},e.dispose=function(){this.subscription.unsubscribe()},t}(),Zn=function(){function t(t){this.x=0,this.y=0,this.top=0,this.right=0,this.bottom=0,this.left=0,this.width=0,this.height=0,this.set(t)}t.contains=function(t,e,n){return t.top<=n&&n<=t.bottom&&t.left<=e&&e<=t.right},t.intersectRect=function(t,e){return!(e.left>t.right||e.right<t.left||e.top>t.bottom||e.bottom<t.top)},t.fromNode=function(e){if(e){var n=e.rect_||(e.rect_=new t);if(!e.getClientRects().length)return n;var i=e.getBoundingClientRect();return n.x=i.left,n.y=i.top,n.top=i.top,n.left=i.left,n.width=i.width,n.height=i.height,n.right=n.left+n.width,n.bottom=n.top+n.height,n.setCenter(),n}};var e=t.prototype;return e.set=function(t){t&&(Object.assign(this,t),this.right=this.left+this.width,this.bottom=this.top+this.height),this.setCenter()},e.setSize=function(t,e){this.width=t,this.height=e,this.right=this.left+this.width,this.bottom=this.top+this.height,this.setCenter()},e.setCenter=function(){var t=this.center||(this.center={});t.top=this.top+this.height/2,t.left=this.left+this.width/2,t.x=t.left,t.y=t.top},e.contains=function(e,n){return t.contains(this,e,n)},e.intersect=function(e){return t.intersectRect(this,e)},e.intersection=function(t){var e=this.intersection_||(this.intersection_={left:0,top:0,width:0,height:0,x:0,y:0,pow:{x:-1,y:-1},offset:function(t){return t=t||0,(this.top-this.rect.height/2+t)/-this.height},scroll:function(t){return t=t||0,(this.top-this.rect.height/2+t)/-this.height}});e.left=this.left,e.top=this.top,e.width=this.width,e.height=this.height,e.x=this.left+this.width/2,e.y=this.top+this.height/2,e.rect=t;var n=e.offset(0);return e.pow.y=n,e},t}(),ti=[16763904,65484,52479,13434624,13369599,16777215],ei=function(){function t(t){var e=this.clientId=t.clientId,n=this.container=t.container,i=this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!1,premultipliedAlpha:!0});i.setClearColor(0,1),i.setPixelRatio(window.devicePixelRatio),i.setSize(320,240),i.toneMapping=THREE.ACESFilmicToneMapping,i.toneMappingExposure=.8,i.outputEncoding=THREE.sRGBEncoding,n.appendChild(i.domElement);var o=this.camera=new THREE.PerspectiveCamera(70,320/240,.01,1e3);o.position.set(0,0,-.5),o.target=new THREE.Vector3,o.lookAt(o.target);var r=this.scene=new THREE.Scene,s=this.light=new THREE.PointLight(16777215,1,100);s.position.set(0,2,-2),r.add(s);var a=this.head=this.addHead();r.add(a);this.remote=At.getRemoteById(e)}l(t,null,[{key:"headGeometry",get:function(){return this.headGeometry_||(this.headGeometry_=new THREE.SphereBufferGeometry(.2,48,48)),this.headGeometry_}}]);var e=t.prototype;return e.addHead=function(){var e=t.headGeometry,n=this.canvas=document.createElement("canvas");n.width=1024,n.height=512;this.ctx=this.canvas.getContext("2d");var i=this.map=new THREE.CanvasTexture(n);i.offset.x=-.25;var o=ti[this.clientId%ti.length],r=new THREE.MeshStandardMaterial({map:i,color:o});return this.chalk(0),new THREE.Mesh(e,r)},e.render=function(){this.tick_?++this.tick_:this.tick_=1;if(this.remote){var t=12*this.remote.getAudioLevel();this.chalk(t)}var e=this.renderer,n=this.scene,i=this.camera;e.render(n,i)},e.update=function(t){var e=t.camera;this.head.quaternion.set(e[3],e[4],e[5],e[6])},e.dispose=function(){this.subscription&&this.subscription.unsubscribe()},e.chalk=function(t){t=(t+.5*Math.PI)%(2*Math.PI);var e=30*Math.sin(t),n=10*Math.cos(t),i=256,o=this.ctx;o.fillStyle="#888888",o.fillRect(0,0,1024,512),o.fillStyle="white",o.beginPath(),o.arc(472,206,7,0,2*Math.PI),o.arc(552,206,7,0,2*Math.PI),o.closePath(),o.fill(),o.beginPath(),o.moveTo(472-n,286),o.bezierCurveTo(472-n,316,552+n,316,552+n,286),o.bezierCurveTo(552+n,i+e,472-n,i+e,472-n,286),o.closePath(),o.fill(),this.map.needsUpdate=!0},t}(),ni=function(t){function e(e,n,i,o,r){var s;return void 0===e&&(e=70),void 0===n&&(n=1),void 0===i&&(i=.01),void 0===o&&(o=1e3),(s=t.call(this,e,n,i,o)||this).target=new THREE.Vector3,s.box=new THREE.Group,s.add(s.box),s}return h(e,t),e}(THREE.PerspectiveCamera),ii=function(t,e){this.src=t,this.id=e},oi=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(ii),ri=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(ii),si=function(){function t(t){var e=this;this.item=t,this.toggle=this.toggle.bind(this),this.muted_=!1,this.subscription=j.state$.subscribe((function(t){return e.muted=t.volumeMuted}))}t.getLoader=function(){return t.loader||(t.loader=new THREE.TextureLoader)},t.getPath=function(t){return C.getPath(t.asset.folder+t.asset.file)},t.loadTexture=function(e,n){var i=t.getPath(e);return t.getLoader().load(i,n)},t.isVideo=function(t){return t.asset&&t.asset.file&&(-1!==t.asset.file.indexOf(".mp4")||-1!==t.asset.file.indexOf(".webm"))},t.isPublisherStream=function(t){return t.asset&&t.asset.type.name===be.PublisherStream.name},t.isNextAttendeeStream=function(t){return t.asset&&t.asset.type.name===be.NextAttendeeStream.name},l(t,[{key:"isVideo",get:function(){return t.isVideo(this.item)}},{key:"isPublisherStream",get:function(){return t.isPublisherStream(this.item)}},{key:"isNextAttendeeStream",get:function(){return t.isNextAttendeeStream(this.item)}},{key:"isPlayableVideo",get:function(){return this.isVideo&&!this.item.asset.autoplay}},{key:"isAutoplayVideo",get:function(){return this.isPublisherStream||this.isNextAttendeeStream||this.isVideo&&null!=this.item.asset.autoplay}},{key:"muted",get:function(){return this.muted_},set:function(t){this.muted_=t,this.video&&(this.video.muted=!0===t)}}]);var e=t.prototype;return e.load=function(e){var n,i=this,o=this.item;if((this.isPublisherStream||this.isNextAttendeeStream)&&o.streamId){var r="#stream-"+o.streamId,s=document.querySelector(r+" video");if(!s)return;var a=function t(){s.removeEventListener("canplay",t),(n=i.texture=new THREE.VideoTexture(s)).minFilter=THREE.LinearFilter,n.magFilter=THREE.LinearFilter,n.mapping=THREE.UVMapping,n.format=THREE.RGBFormat,n.needsUpdate=!0,"function"==typeof e&&e(n,i)};s.crossOrigin="anonymous",s.readyState>=s.HAVE_FUTURE_DATA?a():s.addEventListener("canplay",a)}else if(this.isVideo){var u=this.video=document.createElement("video");u.preload="metadata",u.volume=.8,u.muted=!0,u.playsInline=!0,u.crossOrigin="anonymous",o.asset&&o.asset.autoplay&&(u.loop=!0);u.oncanplay=function(){u.oncanplay=null,(n=new THREE.VideoTexture(u)).minFilter=THREE.LinearFilter,n.magFilter=THREE.LinearFilter,n.mapping=THREE.UVMapping,n.format=THREE.RGBFormat,n.needsUpdate=!0,o.asset&&o.asset.autoplay||u.pause(),"function"==typeof e&&e(n,i)},u.src=t.getPath(o),u.load(),this.play(!0)}else o.asset?t.loadTexture(o,(function(t){t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,"function"==typeof e&&e(t,i)})):e(null,this);return this},e.play=function(e){var n=this;this.video&&(this.video.play().then((function(){}),(function(t){console.log("MediaLoader.play.error",n.item.asset.file,t)})),e||t.events$.next(new oi(this.video.src,this.item.id)))},e.pause=function(e){this.video&&(this.video.muted=!0,this.video.pause(),e||t.events$.next(new ri(this.video.src,this.item.id)))},e.toggle=function(){if(this.video)return this.video.paused?(this.video.muted=this.muted_,this.play(),!0):(this.pause(),!1)},e.dispose=function(){this.subscription.unsubscribe(),this.pause(),delete this.video},t}();si.events$=new i.ReplaySubject(1);var ai,ui="\n#extension GL_EXT_frag_depth : enable\n\nvarying vec2 vUv;\nvoid main() {\n\tvUv = uv;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",li="\n#extension GL_EXT_frag_depth : enable\n\n#define threshold 0.55\n#define padding 0.05\n\nvarying vec2 vUv;\nuniform bool video;\nuniform float opacity;\nuniform float overlay;\nuniform float tween;\nuniform sampler2D textureA;\nuniform sampler2D textureB;\nuniform vec2 resolutionA;\nuniform vec2 resolutionB;\nuniform vec3 chromaKeyColor;\nuniform vec3 overlayColor;\n\nvoid main() {\n\tvec4 color;\n\tvec4 colorA = texture2D(textureA, vUv);\n\tvec4 chromaKey = vec4(chromaKeyColor, 1.0);\n    vec3 chromaKeyDiff = colorA.rgb - chromaKey.rgb;\n    float chromaKeyValue = smoothstep(threshold - padding, threshold + padding, dot(chromaKeyDiff, chromaKeyDiff));\n\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2), opacity * chromaKeyValue);\n\tgl_FragColor = color;\n}\n",ci=function(t){function e(n,i,o){var r,s=e.getMaterialByItem(n);(r=t.call(this,o,s)||this).item=n,r.items=i,r.renderOrder=C.renderOrder.plane,r.uniforms=e.getUniformsByItem(n);r.mediaLoader=new si(n);return r}h(e,t),e.getMaterial=function(t){return new THREE.ShaderMaterial({depthTest:!1,depthWrite:!1,transparent:!0,vertexShader:ui,fragmentShader:t?li:"\n#extension GL_EXT_frag_depth : enable\n\nvarying vec2 vUv;\nuniform bool video;\nuniform float opacity;\nuniform float overlay;\nuniform float tween;\nuniform sampler2D textureA;\nuniform sampler2D textureB;\nuniform vec2 resolutionA;\nuniform vec2 resolutionB;\nuniform vec3 overlayColor;\n\nvoid main() {\n\tvec4 color;\n\tvec4 colorA = texture2D(textureA, vUv);\n\tif (video) {\n\t\tvec4 colorB = texture2D(textureB, vUv);\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2) + (colorB.rgb * tween * colorB.a), opacity);\n\t} else {\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2), opacity);\n\t}\n\tgl_FragColor = color;\n}\n",uniforms:{video:{value:!1},textureA:{type:"t",value:null},textureB:{type:"t",value:null},resolutionA:{value:new THREE.Vector2},resolutionB:{value:new THREE.Vector2},overlayColor:{value:new THREE.Color("#000000")},overlay:{value:0},tween:{value:1},opacity:{value:0}}})},e.getChromaKeyMaterial=function(t){return void 0===t&&(t=[0,1,0]),new THREE.ShaderMaterial({depthTest:!1,depthWrite:!1,transparent:!0,vertexShader:ui,fragmentShader:li,uniforms:{video:{value:!1},textureA:{type:"t",value:null},textureB:{type:"t",value:null},resolutionA:{value:new THREE.Vector2},resolutionB:{value:new THREE.Vector2},chromaKeyColor:{value:new THREE.Vector3(t[0],t[1],t[2])},overlayColor:{value:new THREE.Color("#000000")},overlay:{value:0},tween:{value:1},opacity:{value:0}},side:THREE.DoubleSide})},e.getStreamId$=function(t){if(!t.asset)return i.of(null);var e=t.asset.type,o=t.asset.file;return e.name!==be.PublisherStream.name&&e.name!==be.NextAttendeeStream.name?i.of(o):At.streams$.pipe(n.map((function(n){var i;if(e.name===be.PublisherStream.name)i=n.find((function(t){return t.clientInfo&&t.clientInfo.role===$.Publisher}));else if(e.name===be.NextAttendeeStream.name){var o=0;n.forEach((function(e){e.clientInfo&&e.clientInfo.role===$.Attendee&&(o===t.asset.index&&(i=e),o++)}))}return i?i.getId():null})))},e.getMaterialByItem=function(t){return t.asset&&t.asset.chromaKeyColor?e.getChromaKeyMaterial(t.asset.chromaKeyColor):t.asset?e.getMaterial():new THREE.MeshBasicMaterial({color:8947848})},e.getUniformsByItem=function(t){var e=null;return t.asset&&(e={overlay:0,tween:1,opacity:0}),e};var o=e.prototype;return o.load=function(t){var e=this;if(!this.item.asset)return this.onAppear(),void("function"==typeof t&&t(this));var n=this.material,i=this.mediaLoader;i.load((function(o){o&&(n.uniforms.textureA.value=o,n.uniforms.resolutionA.value=new THREE.Vector2(o.image.width||o.image.videoWidth,o.image.height||o.image.videoHeight),n.needsUpdate=!0,i.isPlayableVideo&&e.createTextureB(o,(function(t){t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.wrapS=THREE.RepeatWrapping,t.wrapT=THREE.RepeatWrapping,n.uniforms.textureB.value=t,n.uniforms.resolutionB.value=new THREE.Vector2(t.image.width,t.image.height),n.needsUpdate=!0}))),e.onAppear(),i.isPlayableVideo&&(n.uniforms.video.value=!0,e.onOver=e.onOver.bind(e),e.onOut=e.onOut.bind(e),e.onToggle=e.onToggle.bind(e),e.on("over",e.onOver),e.on("out",e.onOut),e.on("down",e.onToggle)),"function"==typeof t&&t(e)}))},o.createTextureB=function(t,e){var n=t.image.width||t.image.videoWidth,i=t.image.height||t.image.videoHeight,o=n/i,r=document.createElement("canvas");r.width=n,r.height=i;var s=r.getContext("2d");s.imageSmoothingEnabled=!0,s.imageSmoothingQuality="high";var a=new Image;a.onload=function(){var t,u,l=a.width/a.height;o>l?u=(t=.32*i)/l:t=(u=.32*n)*l,s.drawImage(a,n/2-t/2,i/2-u/2,t,u);var c=new THREE.CanvasTexture(r);"function"==typeof e&&e(c)},a.crossOrigin="anonymous",a.src=C.getPath("textures/ui/play.png")},o.events$=function(){var t=this,e=this.item,i=this.items;return e.asset&&e.asset.linkedPlayId&&this.freeze(),si.events$.pipe(n.map((function(n){e.asset&&e.asset.linkedPlayId&&(i.find((function(t){return t.asset&&-1!==n.src.indexOf(t.asset.file)&&n.id===e.asset.linkedPlayId}))&&(n instanceof oi?t.play():n instanceof ri&&t.pause()));return n})))},o.onAppear=function(){var t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,opacity:1,ease:Power2.easeInOut,onUpdate:function(){e.uniforms.opacity.value=t.opacity,e.needsUpdate=!0}})},o.onDisappear=function(){var t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,opacity:0,ease:Power2.easeInOut,onUpdate:function(){e.uniforms.opacity.value=t.opacity,e.needsUpdate=!0}})},o.onOver=function(){var t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,overlay:1,tween:this.playing?0:1,opacity:1,ease:Power2.easeInOut,overwrite:!0,onUpdate:function(){e.uniforms.overlay.value=t.overlay,e.uniforms.tween.value=t.tween,e.uniforms.opacity.value=t.opacity,e.needsUpdate=!0}})},o.onOut=function(){var t=this.uniforms,e=this.material;e.uniforms&&gsap.to(t,{duration:.4,overlay:0,tween:this.playing?0:1,opacity:1,ease:Power2.easeInOut,overwrite:!0,onUpdate:function(){e.uniforms.overlay.value=t.overlay,e.uniforms.tween.value=t.tween,e.uniforms.opacity.value=t.opacity,e.needsUpdate=!0}})},o.onToggle=function(){this.playing=this.mediaLoader.toggle(),this.emit("playing",this.playing),this.onOut()},o.play=function(){this.mediaLoader.play(),this.playing=!0,this.emit("playing",!0),this.onOut()},o.pause=function(){this.mediaLoader.pause(),this.playing=!1,this.emit("playing",!1),this.onOut()},o.setPlayingState=function(t){this.playing!==t&&(this.playing=t,t?this.mediaLoader.play():this.mediaLoader.pause(),this.onOut())},o.updateByItem=function(t){this.disposeMaterial(),this.disposeMediaLoader(),this.material=e.getMaterialByItem(t),this.uniforms=e.getUniformsByItem(t),this.mediaLoader=new si(t)},o.disposeMaterial=function(){this.material&&(this.material.map&&!1!==this.material.map.disposable&&this.material.map.dispose(),this.material.dispose(),this.material=null)},o.disposeMediaLoader=function(){var t=this.mediaLoader;t&&(t.isPlayableVideo&&(this.off("over",this.onOver),this.off("out",this.onOut),this.off("down",this.onToggle)),t.dispose(),this.mediaLoader=null)},o.dispose=function(){this.disposeMediaLoader()},e}(Yn),di=function(){this.x=0,this.y=0},hi=function(t){t&&Object.assign(this,t)},pi=function(t){function e(e){var n;return(n=t.call(this,e)||this).distance=new di,n.strength=new di,n.speed=new di,n}return h(e,t),e}(hi),mi=function(t){function e(e){var n;return(n=t.call(this,e)||this).distance=new di,n.strength=new di,n.speed=new di,n}return h(e,t),e}(hi),fi=function(t){function e(e){return t.call(this,e)||this}return h(e,t),e}(hi),vi=function(){function t(){}return t.getPosition=function(t,e){return t instanceof MouseEvent?e?(e.x=t.clientX,e.y=t.clientY):e={x:t.clientX,y:t.clientY}:window.TouchEvent&&t instanceof TouchEvent&&t.touches.length>0&&(e?(e.x=t.touches[0].pageX,e.y=t.touches[0].pageY):e={x:t.touches[0].pageX,y:t.touches[0].pageY}),e},t.down$=function(t,e){var o,r=this;return i.merge(i.fromEvent(t,"mousedown").pipe(n.filter((function(t){return 0===t.button}))),i.fromEvent(t,"touchstart")).pipe(n.map((function(n){if((o=o||new pi).node=t,o.target=n.target,o.originalEvent=n,o.down=r.getPosition(n,o.down),o.down)return o.distance=new di,o.strength=new di,o.speed=new di,e.next(o),o})),n.filter((function(t){return void 0!==t})))},t.move$=function(t,e,o,r){var s,a=this;return i.fromEvent(document,r.originalEvent instanceof MouseEvent?"mousemove":"touchmove").pipe(n.startWith(r),n.map((function(n){if((s=s||new mi).node=t,s.target=n.target,s.originalEvent=n,s.position=a.getPosition(n,s.position),void 0!==r.down&&void 0!==s.position)return s.distance.x=s.position.x-r.down.x,s.distance.y=s.position.y-r.down.y,s.strength.x=s.distance.x/window.innerWidth*2,s.strength.y=s.distance.y/window.innerHeight*2,s.speed.x=r.speed.x+.1*(s.strength.x-r.strength.x),s.speed.y=r.speed.y+.1*(s.strength.y-r.strength.y),r.distance.x=s.distance.x,r.distance.y=s.distance.y,r.speed.x=s.speed.x,r.speed.y=s.speed.y,r.strength.x=s.strength.x,r.strength.y=s.strength.y,e.next(s),s})))},t.dismissEvent=function(t,e,n,i){return ai=ai||new fi,e.next(ai),n.next(),i&&Math.abs(i.distance.x)>10&&(t.preventDefault(),t.stopImmediatePropagation()),ai},t.up$=function(t,e,o,r){var s=this;return i.fromEvent(document,r.originalEvent instanceof MouseEvent?"mouseup":"touchend").pipe(n.map((function(t){return s.dismissEvent(t,e,o,r)})))},t.observe$=function(e){var o=this;e=e||document;var r=t.events$=new i.ReplaySubject(1),s=t.dismiss$=new i.Subject;return this.down$(e,r).pipe(n.switchMap((function(a){return t.downEvent=a,i.merge(o.move$(e,r,s,a),o.up$(e,r,s,a)).pipe(n.takeUntil(s))})),n.switchMap((function(){return r})))},t}(),gi="panorama",bi="model",yi=function(){},wi=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(yi),Ei=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(yi),xi=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(yi),Ti=new xi,Ii=new wi,Ri=new Ei,Ci=function(){var t=e.prototype;function e(t){this.mode_=e.mode=gi,this.dolly_=70,this.zoom_=70,this.longitude=0,this.latitude=0,this.direction=1,this.radius=101,this.position=new THREE.Vector3,this.inertia=new THREE.Vector2,this.rotation=new THREE.Euler(0,0,0,"XYZ"),this.target=new THREE.Vector3,this.updatePosition=new THREE.Vector3,this.updateTarget=new THREE.Vector3,this.camera=t,this.setLongitudeLatitude(0,0),this.events$=new i.ReplaySubject(1)}return t.getDollyValue=function(){return 1-(this.dolly_-15)/60-.5},t.getZoomValue=function(){return 2-(this.zoom_-15)/60},l(e,[{key:"dolly",get:function(){return this.dolly_},set:function(t){var e=THREE.Math.clamp(t,15,75);this.dolly_!==e&&(this.dolly_=e,this.update())}},{key:"zoom",get:function(){return this.zoom_},set:function(t){var e=THREE.Math.clamp(t,15,75);this.zoom_!==e&&(this.zoom_=e,this.update())}},{key:"mode",get:function(){return this.mode_},set:function(t){this.mode_!==t&&(this.mode_=t,e.mode=t,this.update())}}]),t.setOrientation=function(t){t&&(this.setLongitudeLatitude(t.longitude,t.latitude),this.update())},t.getOrientation=function(){return{latitude:this.latitude,longitude:this.longitude}},t.setLongitudeLatitude=function(t,e){e=Math.max(-80,Math.min(80,e)),this.longitude=(t<0?360+t:t)%360,this.latitude=e;var n=THREE.Math.degToRad(90-e),i=THREE.Math.degToRad(t);this.phi=n,this.theta=i},t.observe$=function(t){var e,o,r=this;return i.combineLatest([vn.keys$(),vi.observe$(t)]).pipe(n.filter((function(t){return!j.state.locked&&!j.state.spying})),n.map((function(t){var n=t[0],i=t[1];if(i instanceof pi)e=r.latitude,o=r.longitude;else if(i instanceof mi)if(n.Shift)r.events$.next(Ii);else if(n.Control)r.events$.next(Ri);else{var s=r.mode_===bi?-1:1;r.setLongitudeLatitude(o-.1*i.distance.x*s,e+.1*i.distance.y)}return i})),n.filter((function(t){return t instanceof mi})),n.startWith({latitude:this.latitude,longitude:this.longitude}),n.tap((function(t){return r.update()})),n.switchMap((function(t){return r.events$})))},t.update=function(){var t,e=this.updatePosition,n=this.updateTarget,i=this.getZoomValue(),o=(this.getDollyValue(),THREE.MathUtils.degToRad(90-this.latitude)),r=THREE.MathUtils.degToRad(this.longitude),s=this.camera;switch(this.mode_){case bi:t=3,e.copy(this.position),n.x=this.position.x+t*Math.sin(o)*Math.cos(r),n.y=this.position.y+t*Math.cos(o),n.z=this.position.z+t*Math.sin(o)*Math.sin(r),s.target.copy(e),s.position.copy(n);break;default:t=this.radius,n.x=this.position.x+t*Math.sin(o)*Math.cos(r),n.y=this.position.y+t*Math.cos(o),n.z=this.position.z+t*Math.sin(o)*Math.sin(r),e.copy(this.position),s.position.copy(e),s.target.copy(n)}s.zoom=i,s.lookAt(s.target),s.updateProjectionMatrix(),this.events$.next(Ti)},t.render=function(){this.longitude+=.025,this.update()},t.walk=function(t,e){var n,i=this;switch(this.mode_){case bi:n=3;break;default:n=this.radius}var o=new THREE.Vector2(t.x,t.y).normalize().multiplyScalar(n),r=Math.atan2(o.y,o.x),s=THREE.MathUtils.radToDeg(r);s=(s<0?360+s:s)%360;var a=this.latitude,u=this.longitude,l=s-u;l=Math.abs(l)>180?l-l/Math.abs(l)*360:l;var c=0-a;c=Math.abs(c)>90?c-c/Math.abs(c)*90:c;var d={tween:0};gsap.to(d,{duration:.7,tween:1,delay:0,ease:Power2.easeInOut,onUpdate:function(){i.setLongitudeLatitude(u+l*d.tween,a+c*d.tween),i.position.set(t.x*d.tween,0,t.y*d.tween),i.update()},onComplete:function(){"function"==typeof e&&e(s,0)}})},t.walkComplete=function(t,e){this.setLongitudeLatitude(t,e),this.position.set(0,0,0),this.update()},t.lookAt=function(t){if(t){var e,n=t.position;switch(this.mode_){case bi:e=3;break;default:e=this.radius}var i=new THREE.Vector3(n.x,n.z,n.y).normalize().multiplyScalar(e),o=Math.atan2(i.y,i.x),r=Math.acos(i.z/e),s=THREE.MathUtils.radToDeg(o);s=(s<0?360+s:s)%360;var a=90-THREE.MathUtils.radToDeg(r);a=Math.max(-80,Math.min(80,a)),this.setLongitudeLatitude(s,a),this.update()}},t.setVRCamera=function(t){if(t){var e=this.radius,n=new THREE.Vector3(0,0,-e),i=new THREE.Quaternion(t[3],t[4],t[5],t[6]);n.applyQuaternion(i);var o=new THREE.Vector3(n.x,n.z,n.y).normalize().multiplyScalar(e),r=Math.atan2(o.y,o.x),s=Math.acos(o.z/e),a=THREE.MathUtils.radToDeg(r);a=(a<0?360+a:a)%360;var u=90-THREE.MathUtils.radToDeg(s);u=Math.max(-80,Math.min(80,u)),this.setLongitudeLatitude(a,u),this.update()}},e}(),ki=4/3,Mi=[16777215,16763904,65484,52479,13434624,13369599],Si=function(){var t=e.prototype;function e(){var t=e.geometry,n=new THREE.MeshStandardMaterial({color:16777215,side:THREE.DoubleSide});this.plane=new THREE.Mesh(t,n)}return t.setRemote=function(t,e,n){var i=this;this.remote=t;var o,r,s,a,u,l,c;n<4?(r=0,s=e,l=0,c=(u=(a=.12*(o=1))/ki)/2-n*u/2,this.plane.position.set(l,c+u*e,.005)):(o=.5,r=e%2,s=Math.floor(e/2),l=-(a=.12*o)/2,c=(u=a/ki)/2-Math.ceil(n/2)*u/2,this.plane.position.set(l+r*a,c+s*u,.005)),this.plane.scale.set(o,o,o),"number"==typeof t?this.plane.material.color.set(Mi[e%Mi.length]):t.texture?(this.plane.material.map=t.texture,this.plane.material.needsUpdate=!0):this.addStreamTexture(t.getId(),(function(e){t.texture=e,i.plane.material.map=e,i.plane.material.needsUpdate=!0}))},t.addStreamTexture=function(t,e){var n="#stream-"+t,i=document.querySelector(n+" video");if(i){var o=function(){var t=new THREE.VideoTexture(i);t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.mapping=THREE.UVMapping,t.format=THREE.RGBFormat,t.needsUpdate=!0,"function"==typeof e&&e(t)};i.crossOrigin="anonymous",i.readyState>=i.HAVE_FUTURE_DATA?o():i.oncanplay=function(){o()}}},l(e,null,[{key:"geometry",get:function(){return new THREE.PlaneBufferGeometry(.12,.09,2,2)}}]),e}(),$i=function(){function t(){var t=this,e=this.mesh=new THREE.Group,n=this.phone=this.create();e.add(n);this.streams=[];At.remotes$.subscribe((function(e){t.remotes=e}))}return l(t,[{key:"remotes",set:function(t){var e=this;t.forEach((function(n,i){var o=e.streams[i];o||(o=new Si),o.setRemote(n,i,t.length),e.phone.add(o.plane),e.streams[i]=o}));for(var n=t.length;n<this.streams.length;n++)this.phone.remove(this.streams[n].plane);this.streams.length=t.length}}]),t.prototype.create=function(){var t=new THREE.BoxBufferGeometry(.12,.27,.005,2,2,1),e=new THREE.MeshStandardMaterial({color:2105376}),n=new THREE.Mesh(t,e);return n.rotation.set(-Math.PI/4,0,0),n},t}(),Hi=new THREE.Vector3,Ai=function(){function t(t){void 0===t&&(t="#ffffff");var e=new THREE.PlaneBufferGeometry(1.2,1.2,2,2),n=(new THREE.TextureLoader).load(C.getPath("textures/ui/nav-point.png")),i=new THREE.MeshBasicMaterial({color:new THREE.Color(t),depthTest:!1,depthWrite:!1,map:n,transparent:!0,opacity:.9}),o=this.mesh=new THREE.Mesh(e,i);o.renderOrder=C.renderOrder.pointer,o.position.set(-1e5,-1e5,-1e5)}var e=t.prototype;return e.update=function(){if(Xn.lastIntersectedObject){var t=this.mesh,e=Xn.lastIntersectedObject.intersection.point.multiplyScalar(.99);t.position.set(e.x,e.y,e.z);var n=t.position.length()/80;t.scale.set(n,n,n),t.lookAt(Hi)}},e.setPosition=function(t,e,n){var i=this.mesh;i.position.set(t,e,n).multiplyScalar(80);var o=i.position.length()/80;i.scale.set(o,o,o),i.lookAt(Hi)},t}(),Pi=function(t){function e(e){var n;return(n=t.call(this)||this).gamepad=e,n.buttons={},n.axes={},n}h(e,t);var n=e.prototype;return n.update=function(){this.updateButtons(),this.updateAxes()},n.updateButtons=function(){var t=this;this.gamepad.buttons.forEach((function(e,n){var i=e.pressed,o=t.buttons[n]||(t.buttons[n]=new _i(n,t));o.pressed!==i&&(o.pressed=i,i?t.emit("press",o):void 0!==status&&t.emit("release",o))}))},n.updateAxes=function(){for(var t=this.gamepad.axes,e=0;e<t.length;e+=2){var n=Math.floor(e/2),i=this.axes[n]||(this.axes[n]=new Oi(n,this)),o=t[e],r=t[e+1];if(i.x!==o||i.y!==r){if(i.x=o,i.y=r,Math.abs(o)>Math.abs(r)){var s=o<-.85,a=o>.85;i.left!==s&&(i.left=s,this.emit(s?"left":"none",i)),i.right!==a&&(i.right=a,this.emit(a?"right":"none",i))}else{var u=r<-.85,l=r>.85;i.up!==u&&(i.up=u,this.emit(u?"up":"none",i)),i.down!==l&&(i.down=l,this.emit(l?"down":"none",i))}this.emit("axis",i)}}},n.feedback=function(t,e){void 0===t&&(t=.1),void 0===e&&(e=50);var n=this.gamepad.hapticActuators;return n&&n.length?n[0].pulse(t,e):Promise.reject()},e}(function(){function t(){this.events={}}var e=t.prototype;return e.on=function(t,e){var n=this,i=this.events[t]=this.events[t]||[];return i.push(e),function(){n.events[t]=i.filter((function(t){return t!==e}))}},e.off=function(t,e){var n=this.events[t];n&&(this.events[t]=n.filter((function(t){return t!==e})))},e.emit=function(t,e){var n=this.events[t];n&&n.forEach((function(t){t(e)}));var i=this.events.broadcast;i&&i.forEach((function(n){n(t,e)}))},t}()),_i=function(t,e){this.index=t,this.gamepad=e,this.pressed=!1},Oi=function(t){function e(e,n){var i;return(i=t.call(this)||this).index=e,i.gamepad=n,i.left=i.right=i.up=i.down=!1,i}return h(e,t),e}(THREE.Vector2),Li={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};function Ui(t){return Vi.apply(this,arguments)}function Vi(){return(Vi=a(regeneratorRuntime.mark((function t(e){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,fetch(e);case 2:if((n=t.sent).ok){t.next=7;break}throw new Error(n.statusText);case 7:return t.abrupt("return",n.json());case 8:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function Di(t){return Fi.apply(this,arguments)}function Fi(){return(Fi=a(regeneratorRuntime.mark((function t(e){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e){t.next=2;break}throw new Error("No basePath supplied");case 2:return"profilesList.json",t.next=5,Ui(e+"/profilesList.json");case 5:return n=t.sent,t.abrupt("return",n);case 7:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function ji(){return(ji=a(regeneratorRuntime.mark((function t(e,n,i,o){var r,s,a,u,l,c;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0===i&&(i=null),void 0===o&&(o=!0),e){t.next=4;break}throw new Error("No xrInputSource supplied");case 4:if(n){t.next=6;break}throw new Error("No basePath supplied");case 6:return t.next=8,Di(n);case 8:if(r=t.sent,e.profiles.some((function(t){var e=r[t];return e&&(s={profileId:t,profilePath:n+"/"+e.path,deprecated:!!e.deprecated}),!!s})),s){t.next=17;break}if(i){t.next=13;break}throw new Error("No matching profile name found");case 13:if(a=r[i]){t.next=16;break}throw new Error('No matching profile name found and default profile "'+i+'" missing.');case 16:s={profileId:i,profilePath:n+"/"+a.path,deprecated:!!a.deprecated};case 17:return t.next=19,Ui(s.profilePath);case 19:if(u=t.sent,!o){t.next=25;break}if(c="any"===e.handedness?u.layouts[Object.keys(u.layouts)[0]]:u.layouts[e.handedness]){t.next=24;break}throw new Error("No matching handedness, "+e.handedness+", in profile "+s.profileId);case 24:c.assetPath&&(l=s.profilePath.replace("profile.json",c.assetPath));case 25:return t.abrupt("return",{profile:u,assetPath:l});case 26:case"end":return t.stop()}}),t)})))).apply(this,arguments)}var Bi={xAxis:0,yAxis:0,button:0,state:Li.ComponentState.DEFAULT};var Gi=function(){function t(t){this.componentProperty=t.componentProperty,this.states=t.states,this.valueNodeName=t.valueNodeName,this.valueNodeProperty=t.valueNodeProperty,this.valueNodeProperty===Li.VisualResponseProperty.TRANSFORM&&(this.minNodeName=t.minNodeName,this.maxNodeName=t.maxNodeName),this.value=0,this.updateFromComponent(Bi)}return t.prototype.updateFromComponent=function(t){var e=t.xAxis,n=t.yAxis,i=t.button,o=t.state,r=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);var n=t,i=e;if(Math.sqrt(t*t+e*e)>1){var o=Math.atan2(e,t);n=Math.cos(o),i=Math.sin(o)}return{normalizedXAxis:.5*n+.5,normalizedYAxis:.5*i+.5}}(e,n),s=r.normalizedXAxis,a=r.normalizedYAxis;switch(this.componentProperty){case Li.ComponentProperty.X_AXIS:this.value=this.states.includes(o)?s:.5;break;case Li.ComponentProperty.Y_AXIS:this.value=this.states.includes(o)?a:.5;break;case Li.ComponentProperty.BUTTON:this.value=this.states.includes(o)?i:0;break;case Li.ComponentProperty.STATE:this.valueNodeProperty===Li.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(o):this.value=this.states.includes(o)?1:0;break;default:throw new Error("Unexpected visualResponse componentProperty "+this.componentProperty)}},t}(),zi=function(){function t(t,e){var n=this;if(!(t&&e&&e.visualResponses&&e.gamepadIndices&&0!==Object.keys(e.gamepadIndices).length))throw new Error("Invalid arguments supplied");this.id=t,this.type=e.type,this.rootNodeName=e.rootNodeName,this.touchPointNodeName=e.touchPointNodeName,this.visualResponses={},Object.keys(e.visualResponses).forEach((function(t){var i=new Gi(e.visualResponses[t]);n.visualResponses[t]=i})),this.gamepadIndices=Object.assign({},e.gamepadIndices),this.values={state:Li.ComponentState.DEFAULT,button:void 0!==this.gamepadIndices.button?0:void 0,xAxis:void 0!==this.gamepadIndices.xAxis?0:void 0,yAxis:void 0!==this.gamepadIndices.yAxis?0:void 0}}return t.prototype.updateFromGamepad=function(t){var e=this;if(this.values.state=Li.ComponentState.DEFAULT,void 0!==this.gamepadIndices.button&&t.buttons.length>this.gamepadIndices.button){var n=t.buttons[this.gamepadIndices.button];this.values.button=n.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,n.pressed||1===this.values.button?this.values.state=Li.ComponentState.PRESSED:(n.touched||this.values.button>Li.ButtonTouchThreshold)&&(this.values.state=Li.ComponentState.TOUCHED)}void 0!==this.gamepadIndices.xAxis&&t.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=t.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===Li.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>Li.AxisTouchThreshold&&(this.values.state=Li.ComponentState.TOUCHED)),void 0!==this.gamepadIndices.yAxis&&t.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=t.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===Li.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>Li.AxisTouchThreshold&&(this.values.state=Li.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach((function(t){t.updateFromComponent(e.values)}))},l(t,[{key:"data",get:function(){return function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?d(Object(n),!0).forEach((function(e){c(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):d(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}({id:this.id},this.values)}}]),t}(),qi=function(){function t(t,e,n){var i=this;if(!t)throw new Error("No xrInputSource supplied");if(!e)throw new Error("No profile supplied");this.xrInputSource=t,this.assetUrl=n,this.id=e.profileId,this.layoutDescription=e.layouts[t.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach((function(t){var e=i.layoutDescription.components[t];i.components[t]=new zi(t,e)})),this.updateFromGamepad()}return t.prototype.updateFromGamepad=function(){var t=this;Object.values(this.components).forEach((function(e){e.updateFromGamepad(t.xrInputSource.gamepad)}))},l(t,[{key:"gripSpace",get:function(){return this.xrInputSource.gripSpace}},{key:"targetRaySpace",get:function(){return this.xrInputSource.targetRaySpace}},{key:"data",get:function(){var t=[];return Object.values(this.components).forEach((function(e){t.push(e.data)})),t}}]),t}();function Ni(){THREE.Object3D.call(this),this.motionController=null,this.envMap=null}function Wi(t,e){!function(t,e){Object.values(t.components).forEach((function(t){var n=t.type,i=t.touchPointNodeName,o=t.visualResponses;if(n===Li.ComponentType.TOUCHPAD)if(t.touchPointNode=e.getObjectByName(i),t.touchPointNode){var r=new THREE.SphereBufferGeometry(.001),s=new THREE.MeshBasicMaterial({color:255}),a=new THREE.Mesh(r,s);t.touchPointNode.add(a)}else console.warn("Could not find touch dot, "+t.touchPointNodeName+", in touchpad component "+t.id);Object.values(o).forEach((function(t){var n=t.valueNodeName,i=t.minNodeName,o=t.maxNodeName;if(t.valueNodeProperty===Li.VisualResponseProperty.TRANSFORM){if(t.minNode=e.getObjectByName(i),t.maxNode=e.getObjectByName(o),!t.minNode)return void console.warn("Could not find "+i+" in the model");if(!t.maxNode)return void console.warn("Could not find "+o+" in the model")}t.valueNode=e.getObjectByName(n),t.valueNode||console.warn("Could not find "+n+" in the model")}))}))}(t.motionController,e),t.envMap&&e.traverse((function(e){e.isMesh&&(e.material.envMap=t.envMap,e.material.needsUpdate=!0)})),t.add(e)}Ni.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:Ni,setEnvironmentMap:function(t){var e=this;return this.envMap==t||(this.envMap=t,this.traverse((function(t){t.isMesh&&(t.material.envMap=e.envMap,t.material.needsUpdate=!0)}))),this},updateMatrixWorld:function(t){THREE.Object3D.prototype.updateMatrixWorld.call(this,t),this.motionController&&(this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach((function(t){Object.values(t.visualResponses).forEach((function(t){var e=t.valueNode,n=t.minNode,i=t.maxNode,o=t.value,r=t.valueNodeProperty;e&&(r===Li.VisualResponseProperty.VISIBILITY?e.visible=o:r===Li.VisualResponseProperty.TRANSFORM&&(THREE.Quaternion.slerp(n.quaternion,i.quaternion,e.quaternion,o),e.position.lerpVectors(n.position,i.position,o)))}))})))}});var Ki=function(){function t(t){void 0===t&&(t=null),this.gltfLoader=t,this.path="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",this._assetCache={},this.gltfLoader||(this.gltfLoader=new THREE.GLTFLoader)}return t.prototype={constructor:t,createControllerModel:function(t){var e=this,n=new Ni,i=null;return t.addEventListener("connected",(function(t){var o=t.data;"tracked-pointer"===o.targetRayMode&&o.gamepad&&function(t,e,n,i){return ji.apply(this,arguments)}(o,e.path,"generic-trigger").then((function(t){var r=t.profile,s=t.assetPath;n.motionController=new qi(o,r,s);var a=e._assetCache[n.motionController.assetUrl];if(a)i=a.scene.clone(),Wi(n,i);else{if(!e.gltfLoader)throw new Error("GLTFLoader not set.");e.gltfLoader.setPath(""),e.gltfLoader.load(n.motionController.assetUrl,(function(t){e._assetCache[n.motionController.assetUrl]=t,i=t.scene.clone(),Wi(n,i)}),null,(function(){throw new Error("Asset "+n.motionController.assetUrl+" missing or malformed.")}))}})).catch((function(t){console.warn(t)}))})),t.addEventListener("disconnected",(function(){n.motionController=null,n.remove(i),i=null})),n}},t}(),Xi=new THREE.Vector3,Yi=(M.transform("loading"),M.transform("waiting_host"),function(e){function o(){return e.apply(this,arguments)||this}h(o,e);var r=o.prototype;return r.onInit=function(){var t=this;this.index=0,this.error_=null,this.loading=null,this.waiting=null,this.avatars={},this.createScene(),this.setView(),this.addListeners(),this.animate(),vn.keys$().pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.keys=e}))},r.onChanges=function(){if(this.view){var t=this.view.items.find((function(t){return t.selected}));t&&t.mesh&&"model"!==this.view.type.name&&this.orbit.lookAt(t.mesh)}},r.onDestroy=function(){this.removeListeners(),this.renderer.setAnimationLoop((function(){}))},r.createScene=function(){var e=t.getContext(this).node;this.size={left:0,top:0,width:0,height:0,aspect:0},this.mouse=new THREE.Vector2,this.controllerMatrix_=new THREE.Matrix4,this.controllerWorldPosition_=new THREE.Vector3,this.controllerWorldDirection_=new THREE.Vector3;var n=this.container=e,i=(this.info=e.querySelector(".world__info"),this.worldRect=Zn.fromNode(n),this.cameraRect=new Zn,this.cameraGroup=new THREE.Group),o=this.camera=new ni(70,n.offsetWidth/n.offsetHeight,.01,1e3);i.add(o),i.target=new THREE.Vector3;this.orbit=new Ci(o);var r=this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!1,premultipliedAlpha:!0,logarithmicDepthBuffer:!0});r.setClearColor(0,1),r.setPixelRatio(window.devicePixelRatio),r.setSize(n.offsetWidth,n.offsetHeight),r.xr.enabled=!0,r.toneMapping=THREE.ACESFilmicToneMapping,r.toneMappingExposure=.8,r.outputEncoding=THREE.sRGBEncoding,n.childElementCount>0?n.insertBefore(r.domElement,n.children[0]):n.appendChild(r.domElement),(this.raycaster=new THREE.Raycaster).setFromCamera(this.mouse,o);var s=this.scene=new THREE.Scene;s.add(i);var a=this.objects=new THREE.Group;a.name="[objects]",s.add(a);var u=this.panorama=new Jn;a.add(u.mesh);this.indicator=new Ai,this.pointer=new Ai("#ff4332");var l=new THREE.PointLight(16777215);l.position.set(-50,0,-50),a.add(l);var c=new THREE.DirectionalLight(16770713,1.5);c.position.set(40,-40,40),c.target.position.set(0,0,0),a.add(c);var d=new THREE.DirectionalLight(16770713,1);d.position.set(0,50,0),d.target.position.set(0,0,0),a.add(d);var h=new THREE.AmbientLight(1052688);a.add(h),this.addControllers(),this.resize()},r.addOffCanvasScene=function(t){var e=new ei(t);this.avatars[t.clientId]=e},r.removeOffCanvasScene=function(t){this.avatars[t.clientId];delete this.avatars[t.clientId]},r.updateOffCanvasScene=function(t){var e=this.avatars[t.clientId];e&&e.update(t)},r.setView=function(){var t=this;if(this.panorama){var e=this.view_;if(e){var n=this.requestInfoResult;n&&e instanceof Yt&&void 0!==n.gridIndex&&(e.index_=n.gridIndex),e.ready=!1,this.pushChanges(),this.panorama.change(e,this.renderer,(function(n,i,o){t.scene.environment=n,e.ready=!0,t.pushChanges()}),(function(e){t.setViewOrientation(e)}))}}},r.setViewOrientation=function(t){var e=this.requestInfoResult;this.requestInfoResult=null,this.orbit&&(this.orbit.mode=t.type.name,this.renderer.xr.isPresenting||(e?(this.orbit.setOrientation(e.orientation),this.orbit.zoom=e.zoom,this.camera.updateProjectionMatrix()):(this.orbit.setOrientation(t.orientation),this.orbit.zoom=t.zoom,this.camera.updateProjectionMatrix())))},r.addControllers=function(){var t=this.controllerGroup=new THREE.Group;this.controllers=[],this.controllerModelFactory=new Ki,this.addController(0),this.addController(1),this.cameraGroup.add(t)},r.addController=function(t){var e=this,n=j.state.live,i=this.renderer,o=this.controllerGroup,r=i.xr.getController(t),s=this.controllerModelFactory;r.name="[controller"+(t+1)+"]",o.add(r);var a=function(t){switch(t.index){case 0:case 1:break;case 4:St.send({type:bt})}},u=function(t){e.onModelUp()},l=function(t){e.cameraGroup.rotation.y+=Math.PI/180*45},c=function(t){e.cameraGroup.rotation.y-=Math.PI/180*45},d=function(t){e.onModelDistance(t.y)};r.addEventListener("selectstart",(function(t){r.userData.isSelecting=!0,function(t){e.controller=t}(r)})),r.addEventListener("selectend",(function(t){r.userData.isSelecting=!1})),r.addEventListener("connected",(function(h){if(r.add(e.buildController(h.data)),n&&"left"===h.data.handedness){var p=e.phone=new $i;r.add(p.mesh)}if(!n||"right"===h.data.handedness){var m=i.xr.getControllerGrip(t);m.name="[controller-grip"+(t+1)+"]",m.add(s.createControllerModel(m)),o.add(m)}var f=new Pi(h.data.gamepad);f.on("press",a),f.on("release",u),f.on("left",l),f.on("right",c),f.on("axis",d),r.userData.gamepad=f})),r.addEventListener("disconnected",(function(e){for(;r.children.length;)r.remove(r.children[0]);for(var n=i.xr.getControllerGrip(t);n.children.length;)n.remove(n.children[0]);o.remove(n);var s=r.userData.gamepad;s.off("press",a),s.off("release",u),s.off("left",l),s.off("right",c),s.off("axis",d)})),this.controllers.push(r)},r.buildController=function(t){var e,n;switch(console.log("buildController",t),t.targetRayMode){case"tracked-pointer":return(e=new THREE.BufferGeometry).setAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,-1],3)),e.setAttribute("color",new THREE.Float32BufferAttribute([.5,.5,.5,0,0,0],3)),n=new THREE.LineBasicMaterial({vertexColors:!0,blending:THREE.AdditiveBlending}),new THREE.Line(e,n);case"gaze":return e=new THREE.RingBufferGeometry(.02,.04,32).translate(0,0,-1),n=new THREE.MeshBasicMaterial({opacity:.5,transparent:!0}),new THREE.Mesh(e,n)}},r.onModelDown=function(t){var e=this.controller;if(e&&this.renderer.xr.isPresenting){var n=this.tempTarget=t.mesh,i=(this.tempParent=n.parent,new THREE.Vector3);n.localToWorld(i),e.worldToLocal(i),e.add(n),n.position.copy(i)}},r.onModelDistance=function(t){var e=this.controller,n=this.tempTarget;if(e&&n&&this.renderer.xr.isPresenting){var i=new THREE.Vector3;i=i.copy(n.position);var o=Math.max(1,Math.min(8,i.distanceTo(Xi)+.02*t));i.normalize(),i=i.multiplyScalar(o),n.position.copy(i)}},r.onModelUp=function(){var t=this.tempTarget,e=this.tempParent;if(t&&e){var n=new THREE.Vector3;t.localToWorld(n),e.worldToLocal(n),e.add(t),t.position.copy(n),this.tempTarget=null,this.tempParent=null}},r.onTween=function(){},r.updateRaycasterXR=function(t,e){if(t)return this.controllerMatrix_.identity().extractRotation(t.matrixWorld),e.ray.origin.setFromMatrixPosition(t.matrixWorld),e.ray.direction.set(0,0,-1).applyMatrix4(this.controllerMatrix_),e},r.raycasterHitTest=function(){try{if(this.renderer.xr.isPresenting){var t=this.updateRaycasterXR(this.controller,this.raycaster);if(t){Xn.hittest(t,this.controller.userData.isSelecting);this.indicator.update()}}else if(!this.dragItem&&!this.resizeItem){return}}catch(t){this.error=t}},r.repos=function(t,e){var n=this.worldRect;t.scale.set(.8,.8,.8);var i=(e.x+e.width/2-n.width/2)/n.width*2*this.camera.aspect,o=(e.y+e.height/2-n.height/2)/n.height*2*this.camera.aspect;t.position.set(i,-o,0)},r.render=function(t){var e=this;try{var n=this.renderer,i=(this.scene,this.camera,performance.now()),o=this.tick_?++this.tick_:this.tick_=1;this.raycasterXRHitTest(),this.scene.traverse((function(t){"function"==typeof t.userData.render&&t.userData.render(i,o)})),this.vrService.updateState(this),Object.keys(this.avatars).forEach((function(t){e.avatars[t].render()})),n.xr.isPresenting&&(gsap.ticker.tick(),this.controllers.forEach((function(t){t.userData.gamepad.update()}))),n.render(this.scene,this.camera),this.state&&!this.state.hosted&&this.orbit.render()}catch(t){this.error=t}},r.animate=function(){this.renderer.setAnimationLoop(this.render)},r.resize=function(){try{var t=this.container,e=this.renderer,n=this.camera,i=this.size,o=t.getBoundingClientRect();if(i.left=Math.floor(o.left),i.top=Math.floor(o.top),i.width=Math.ceil(o.width),i.height=Math.ceil(o.height),i.aspect=i.width/i.height,this.worldRect.setSize(i.width,i.height),!e.xr.isPresenting&&(e.setSize(i.width,i.height),n)){n.aspect=i.width/i.height;var r=n.fov*Math.PI/180,s=Math.abs(n.position.z*Math.tan(r/2)*2),a=this.cameraRect;a.width=s*n.aspect,a.height=s,n.updateProjectionMatrix()}}catch(t){this.error=t}},r.updateRaycasterMouse=function(t){var e=this.size.width/2,n=this.size.height/2;this.mouse.x=(t.clientX-this.size.left-e)/e,this.mouse.y=-(t.clientY-this.size.top-n)/n;var i=this.raycaster;return i.setFromCamera(this.mouse,this.camera),i},r.onMouseDown=function(t){try{if(0!==t.button)return;var e=this.updateRaycasterMouse(t);Xn.hittest(e,!0);if(this.editor||g)if(this.keys.Shift||this.keys.Control);else if(this.select.next({item:null}),this.panorama.mesh.intersection){var n=(new THREE.Vector3).copy(this.panorama.mesh.intersection.point).normalize();console.log(JSON.stringify({position:n.toArray()})),this.viewHit.next(n)}}catch(t){this.error=t}},r.raycasterXRHitTest=function(){if(this.renderer.xr.isPresenting){var t=this.updateRaycasterXR(this.controller,this.raycaster);if(t){Xn.hittest(t,this.controller.userData.isSelecting);this.indicator.update()}}},r.raycasterDesktopHitTest=function(t){var e=this.updateRaycasterMouse(t);if(!this.lockedOrXR)if(this.dragItem){if("function"==typeof this.dragItem.onDragMove){var n=e.intersectObjects([this.panorama.mesh]);if(n.length){var i=n[0],o=(new THREE.Vector3).copy(i.point).normalize();this.dragItem.onDragMove(o)}}}else if(this.resizeItem)this.resizeItem.onResizeMove;else{Xn.hittest(e);this.controlEvent$.next(this.control)}},r.onMouseMove=function(t){try{this.raycasterDesktopHitTest(t)}catch(t){this.error=t}},r.onMouseUp=function(t){try{if(this.lockedOrXR)return;this.dragItem&&"function"==typeof this.dragItem.onDragEnd&&(this.dragItem.onDragEnd(),this.dragEnd.next(this.dragItem)),this.dragItem=null,this.resizeItem&&"function"==typeof this.resizeItem.onResizeEnd&&(this.resizeItem.onResizeEnd(),this.resizeEnd.next(this.resizeItem)),this.resizeItem=null;var e=this.updateRaycasterMouse(t);Xn.hittest(e,!1)}catch(t){this.error=t}},r.onMouseWheel=function(t){try{if(this.lockedOrXR)return;var e=t.deltaY*(void 0!==t.wheelDeltaY?1:37),n=this.orbit;gsap.to(n,{duration:.5,zoom:n.zoom+.1*e,ease:Power4.easeOut,overwrite:!0})}catch(t){this.error=t}},r.onOrientationDidChange=function(){this.controlEvent$.next(this.control)},r.onVRStarted=function(){this.objects.position.y=1.3,this.scene.add(this.indicator.mesh),St.send({type:ft})},r.onVREnded=function(){this.objects.position.y=0,this.cameraGroup.rotation.y=0,this.cameraGroup.position.y=0,this.scene.remove(this.indicator.mesh),St.send({type:vt})},r.onVRStateDidChange=function(t){St.send({type:gt,camera:t.camera.array})},r.onMenuNav=function(t){this.menu=void 0,this.navTo.next(t.id)},r.onMenuToggle=function(t){this.locked||(this.menu=t,this.view.items.forEach((function(t){return t.showPanel=!1})),this.pushChanges())},r.onNavOver=function(t){this.menu||(this.view.items.forEach((function(t){return t.showPanel=!1})),t.item.showPanel=t.shouldShowPanel(),this.pushChanges(),St.send({type:dt,itemId:t.item.showPanel?t.item.id:null}))},r.onNavOut=function(t){this.pushChanges()},r.onNavDown=function(t){t.item.showPanel=!1,this.locked||(this.editor&&this.keys.Shift?(this.dragItem=t,this.select.next(t)):this.editor&&this.keys.Control?(this.resizeItem=t,this.select.next(t)):this.navTo.next(t.item.viewId))},r.onObjectDown=function(t){this.lockedOrXR||(this.editor&&this.keys.Shift?(this.dragItem=t,this.select.next(t)):this.editor&&this.keys.Control&&(this.resizeItem=t,this.select.next(t)))},r.onPlayMedia=function(t){St.send({type:ht,itemId:t.itemId,playing:t.playing})},r.onPanelDown=function(t){var e=t.getAttribute("href");t.getAttribute("target");e&&window.open(e,"_blank")},r.onGridMove=function(t){var e=this;this.view.items=[],this.pushChanges(),this.orbit.walk(t.position,(function(n,i){var o=e.view.getTile(t.indices.x,t.indices.y);o&&e.panorama.crossfade(o,e.renderer,(function(t,o,r){e.scene.environment=t,e.orbit.walkComplete(n,i),e.view.updateCurrentItems(),e.pushChanges()}))}))},r.onGridNav=function(t){this.locked||(St.send({type:mt,viewId:this.view.id,gridIndex:t}),this.pushChanges())},r.control$=function(){var t=this;return this.controlEvent$.pipe(n.filter((function(){return j.state.control||j.state.spyed||t.editor})),n.auditTime(40),n.tap((function(e){e.orientation.latitude=t.orbit.latitude,e.orientation.longitude=t.orbit.longitude,e.zoom=t.orbit.zoom;var n=t.raycaster.intersectObjects([t.panorama.mesh]),i=n.length?n[0].point.normalize():null;i&&(e.pointer[0]=i.x,e.pointer[1]=i.y,e.pointer[2]=i.z),St.send(e)})))},r.addListeners=function(){var t=this;this.control={type:lt,orientation:{latitude:0,longitude:0},zoom:1,pointer:[0,0,0]},this.controlEvent$=new i.ReplaySubject(1),this.control$().pipe(n.takeUntil(this.unsubscribe$)).subscribe();var e=this.vrService=he.getService();e.session$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.renderer.xr.setSession(e),e?t.onVRStarted():t.onVREnded()})),e.state$.pipe(n.takeUntil(this.unsubscribe$),n.auditTime(Math.floor(1e3/15))).subscribe((function(e){t.onVRStateDidChange(e)})),this.orbit.observe$(this.container).pipe(n.shareReplay(1)).pipe(n.filter((function(t){return t instanceof xi})),n.auditTime(Math.floor(1e3/15))).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.onOrientationDidChange()})),St.out$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){switch(e.type){case ot:e.type=rt,e.viewId=t.view.id,e.orientation=t.orbit.getOrientation(),e.zoom=t.orbit.zoom,t.view instanceof Yt&&(e.gridIndex=t.view.index),St.sendBack(e),j.state.role!==$.Publisher&&j.patchState({spyed:!0});break;case rt:oe.viewId!==e.viewId?(oe.viewId=e.viewId,t.requestInfoResult=e):(t.orbit.setOrientation(e.orientation),t.renderer.xr.isPresenting||(t.orbit.zoom=e.zoom,t.camera.updateProjectionMatrix()),t.view instanceof Yt&&e.gridIndex&&(t.view.index=e.gridIndex),t.view&&t.view.ready||(t.requestInfoResult=e));break;case dt:t.menu&&t.menu.removeMenu(),t.view.items.forEach((function(t){return t.showPanel=t.id===e.itemId})),t.pushChanges();break;case ht:var n=t.view.items.find((function(t){return t.id===e.itemId}));n&&n.mesh instanceof ci&&n.mesh.setPlayingState(e.playing);break;case mt:t.view.id===e.viewId&&(t.view.index=e.gridIndex);break;case ft:t.addOffCanvasScene(e);break;case vt:t.removeOffCanvasScene(e);break;case gt:t.updateOffCanvasScene(e),j.state.spying===e.clientId&&t.orbit.setVRCamera(e.camera);break;case lt:t.renderer.xr.isPresenting||(t.orbit.setOrientation(e.orientation),t.orbit.zoom=e.zoom),t.pointer.setPosition(e.pointer[0],e.pointer[1],e.pointer[2])}})),j.state$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){t.state=e,t.showPointer=j.state.locked||j.state.spying})),this.resize=this.resize.bind(this),this.render=this.render.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseWheel=this.onMouseWheel.bind(this),window.addEventListener("resize",this.resize,!1),this.container.addEventListener("wheel",this.onMouseWheel,!1),this.container.addEventListener("mousedown",this.onMouseDown,!1),this.container.addEventListener("mouseup",this.onMouseUp,!1),document.addEventListener("mousemove",this.onMouseMove,!1)},r.removeListeners=function(){window.removeEventListener("resize",this.resize,!1),window.removeEventListener("resize",this.resize,!1),document.removeEventListener("mousemove",this.onMouseMove,!1),document.removeEventListener("wheel",this.onMouseWheel,!1),this.container.removeEventListener("mousedown",this.onMouseDown,!1),this.container.removeEventListener("mouseup",this.onMouseUp,!1)},l(o,[{key:"error",get:function(){return this.error_},set:function(t){this.error_!==t&&(this.error_=t,this.pushChanges())}},{key:"view",get:function(){return this.view_},set:function(t){this.view_!==t&&(this.view_=t,this.setView())}},{key:"debugging",get:function(){return g}},{key:"locked",get:function(){return this.state.locked||this.state.spying}},{key:"lockedOrXR",get:function(){return this.locked||this.renderer.xr.isPresenting}},{key:"showPointer",get:function(){return null!=this.pointer.mesh.parent},set:function(t){this.showPointer!==t&&(t?this.scene.add(this.pointer.mesh):this.scene.remove(this.pointer.mesh))}}]),o}(t.Component));Yi.meta={selector:"[world]",inputs:["view","views","editor"],outputs:["navTo","viewHit","dragEnd","resizeEnd","select"]};var Qi=function(t){function e(e){var n;return(n=t.call(this,e)||this).depthTest=!0,n.over_=!1,n.down_=!1,Xn.items.push(p(n)),n}return h(e,t),l(e,[{key:"over",get:function(){return this.over_},set:function(t){this.over_!=t&&(this.over_=t,t?this.emit("over",this):this.emit("out",this))}},{key:"down",get:function(){return this.down_},set:function(t){t=t&&this.over,this.down_!=t&&(this.down_=t,t?this.emit("down",this):this.emit("up",this))}}]),e}(function(t){function e(e){var n;return e=e||new THREE.SpriteMaterial({color:16711935}),(n=t.call(this,e)||this).events={},n}h(e,t);var n=e.prototype;return n.on=function(t,e){var n=this,i=this.events[t]=this.events[t]||[];return i.push(e),function(){n.events[t]=i.filter((function(t){return t!==e}))}},n.off=function(t,e){var n=this.events[t];n&&(this.events[t]=n.filter((function(t){return t!==e})))},n.emit=function(t,e){var n=this.events[t];n&&n.forEach((function(t){t(e)}));var i=this.events.broadcast;i&&i.forEach((function(n){n(t,e)}))},e}(function(t){function e(e){var n;return e=e||new THREE.SpriteMaterial({color:16711935}),(n=t.call(this,e)||this).freezed=!1,n}h(e,t),l(e,[{key:"freezed",get:function(){return this.freezed_},set:function(t){this.freezed_=t,this.children.filter((function(t){return t.__lookupGetter__("freezed")})).forEach((function(e){return e.freezed=t}))}}]);var n=e.prototype;return n.freeze=function(){this.freezed=!0},n.unfreeze=function(){this.freezed=!1},e}(THREE.Sprite))),Ji=(THREE.Math.degToRad,new THREE.BoxBufferGeometry(1,1,1)),Zi=function(e){function n(){return e.apply(this,arguments)||this}h(n,e);var i=n.prototype;return i.onInit=function(){var t=this;if(!this.host)throw"ModelComponent host is undefined";this.scale=new THREE.Vector3(1,1,1),this.position=new THREE.Vector3;var e=this.group=new THREE.Group;e.name=this.getName(),e.userData.render=function(e,n){t.render(t,e,n)},this.getContainer().add(e),this.onCreate((function(e,n){return t.onMount(e,n)}),(function(e,n){return t.onDismount(e,n)}))},i.onDestroy=function(){var t=this.group;this.getContainer().remove(t),delete t.userData.render,this.disposeObject(t),this.group=null},i.getContainer=function(){return this.host.objects},i.getName=function(t){return this.constructor.meta.selector+"-"+this.rxcompId+(t?"-"+t:"")},i.onCreate=function(t,e){var n=new THREE.MeshStandardMaterial({color:new THREE.Color("#ffcc00"),roughness:.4,metalness:.01,flatShading:!0,transparent:!0,opacity:.9}),i=new THREE.Mesh(Ji,n);return"function"==typeof t&&t(i),i},i.onMount=function(t,e){var n=this;this.mesh&&this.onDismount(this.mesh),t.name=this.getName("mesh"),this.mesh=t,e&&(e.mesh=t,e.onUpdate=function(){n.onUpdate(e,t)},e.onUpdateAsset=function(){n.onUpdateAsset(e,t)}),this.group.add(t)},i.onDismount=function(t,e){this.group.remove(t),"function"==typeof t.dispose&&t.dispose(),this.disposeObject(t),this.mesh=null,e&&(delete e.mesh,delete e.onUpdate,delete e.onUpdateAsset)},i.disposeObject=function(t){t.traverse((function(t){(t instanceof Yn||t instanceof Qi)&&Xn.dispose(t),t.isMesh?(t.material.map&&!1!==t.material.map.disposable&&t.material.map.dispose(),t.material.dispose(),t.geometry.dispose()):t.isSprite&&(t.material.map&&!1!==t.material.map.disposable&&t.material.map.dispose(),t.material.dispose())}))},i.calculateScaleAndPosition=function(){var e=t.getContext(this).node;this.host.repos(this,e.getBoundingClientRect())},i.render=function(t,e){},i.getScroll=function(t){return this.intersection.scroll(t)},i.getTween=function(t){var e=Math.min(0,this.intersection.offset(t))+1;return e=Math.max(0,e),e-=1},i.onUpdate=function(t,e){},i.onUpdateAsset=function(t,e){},l(n,[{key:"renderOrder",set:function(t){this.group.renderOrder=t}}]),n}(t.Component);Zi.meta={selector:"[model]",hosts:{host:Yi},inputs:["item"]};var to=100.99,eo=(new THREE.Vector3,function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var n=e.prototype;return n.onChanges=function(){this.title=this.item.title},n.createBanner=function(){var t=this;this.getCanvasTexture().then((function(e){var n=e.texture;n.wrapS=n.wrapY=THREE.RepeatWrapping,n.repeat.x=24,n.encoding=THREE.sRGBEncoding;var i=24*e.width/e.height,o=Math.PI/180*360,r=to*o/i,s=new THREE.CylinderBufferGeometry(to,to,r,80,2,!0,0,o);s.scale(-1,1,1);var a=new THREE.MeshBasicMaterial({map:n,transparent:!0,opacity:0}),u=t.mesh;(t.banners=new Array(1).fill(0).map((function(t){return new THREE.Mesh(s,a)}))).forEach((function(t,e){t.rotation.y=Math.PI/2*e}));var l={value:0};gsap.to(l,{duration:.5,value:1,delay:0,ease:Power2.easeInOut,onUpdate:function(){a.opacity=l.value,a.needsUpdate=!0}}),u.userData={render:function(){u.rotation.y+=Math.PI/180*.02,a.needsUpdate=!0}}}))},n.updateBanner=function(){this.getCanvasTexture().then((function(t){}))},n.onCreate=function(t,e){var n=new THREE.Group;"function"==typeof t&&t(n)},n.getCanvasTexture=function(){var t=this;return new Promise((function(e,n){var i,o=512,r=128,s=Math.floor(102.4),a=Math.floor(9.6);(i=t.canvas?t.canvas:t.canvas=document.createElement("canvas")).width=o,i.height=r;var u,l=t.item.title,c=i.getContext("2d");c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.font=s+"px "+C.fontFamily,o=c.measureText(l).width+8,o=Math.max(512,Math.pow(2,Math.ceil(Math.log(o)/Math.log(2)))),i.width=o,c.clearRect(0,0,o,r),c.fillStyle="#0000005A",c.fillRect(0,0,o,r),c.font=s+"px "+C.fontFamily,c.textAlign="center",c.textBaseline="middle",c.strokeStyle="rgba(0, 0, 0, 0.5)",c.lineWidth=a,c.lineJoin="round",c.miterLimit=2,c.strokeText(l,o/2,64),c.fillStyle="white",c.fillText(l,o/2,64,o),t.texture?(u=t.texture).needsUpdate=!0:u=t.texture=new THREE.CanvasTexture(i),e({texture:u,width:o,height:r})}))},l(e,[{key:"title",get:function(){return this.title_},set:function(t){if(this.title_!==t){var e=null!=this.title_;this.title_=t,e?this.updateBanner():this.createBanner()}}}]),e}(Zi));eo.ORIGIN=new THREE.Vector3,eo.meta={selector:"[model-banner]",hosts:{host:Yi},inputs:["item"]};var no=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var n=e.prototype;return n.onInit=function(){t.prototype.onInit.call(this),this.RADIUS=100},n.onDestroy=function(){this.editing=!1,t.prototype.onDestroy.call(this)},n.setHelper=function(t){t?(this.helper||(this.helper=new THREE.BoxHelper(this.mesh,65280)),this.host.scene.add(this.helper)):this.helper&&this.host.scene.remove(this.helper)},n.updateHelper=function(){this.helper&&this.helper.setFromObject(this.mesh)},l(e,[{key:"editing",get:function(){return this.editing_},set:function(t){this.editing_!==t&&(this.editing_=t,this.setHelper(t))}}]),e}(Zi);no.meta={selector:"[model-editable]",hosts:{host:Yi},inputs:["item"]};var io=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var i=e.prototype;return i.onInit=function(){t.prototype.onInit.call(this)},i.onChanges=function(){this.editing=this.item.selected},i.onCreate=function(t,e){var i,o,r=this,s=this.item,a=this.items,u=this.getCurvedPanelGeometry(s);ci.getStreamId$(s).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){r.streamId!==e&&(r.streamId=e,o&&(o.unsubscribe(),o=null),!e&&s.asset||(s.streamId=e,(i=new ci(s,a,u)).name="curved-plane",s.position&&i.position.fromArray(s.position),s.rotation&&i.rotation.fromArray(s.rotation),s.scale&&i.scale.fromArray(s.scale),i.load((function(){"function"==typeof t&&t(i,s),o=i.events$().pipe(n.takeUntil(r.unsubscribe$)).subscribe((function(){}))})),i.on("down",(function(){r.down.next(r)})),i.on("playing",(function(t){r.play.next({itemId:r.item.id,playing:t})}))))}))},i.onDestroy=function(){t.prototype.onDestroy.call(this),this.mesh&&this.mesh.dispose()},i.onUpdate=function(t,e){if(t.position&&e.position.fromArray(t.position),t.rotation&&e.rotation.fromArray(t.rotation),t.scale&&e.scale.fromArray(t.scale),t.radius!==this.radius_||t.height!==this.height_||t.arc!==this.arc_){this.mesh.geometry.dispose();var n=this.getCurvedPanelGeometry(t);this.mesh.geometry=n}this.updateHelper()},i.onUpdateAsset=function(t,e){var i=this;this.mesh.updateByItem(t),ci.getStreamId$(t).pipe(n.filter((function(t){return null!==t})),n.take(1)).subscribe((function(e){t.streamId=e,i.mesh.load((function(){}))}))},i.onDragMove=function(t){this.item.showPanel=!1,this.editing=!0,this.mesh.position.set(t.x,t.y,t.z).multiplyScalar(20),this.mesh.lookAt(e.ORIGIN),this.updateHelper()},i.onDragEnd=function(){this.item.position=this.mesh.position.toArray(),this.item.rotation=this.mesh.rotation.toArray(),this.item.scale=this.mesh.scale.toArray(),this.editing=!1},i.getCurvedPanelGeometry=function(t){this.radius_=t.radius,this.height_=t.height,this.arc_=t.arc;var e=Math.PI/180*t.arc,n=new THREE.CylinderBufferGeometry(t.radius,t.radius,t.height,36,2,!0,0,e);return n.rotateY(-Math.PI-e/2),n.scale(-1,1,1),n},e}(no);io.ORIGIN=new THREE.Vector3,io.textures={},io.meta={selector:"[model-curved-plane]",hosts:{host:Yi},outputs:["down","play"],inputs:["item","items"]};var oo=function(){function t(){if(t.service_)throw"DebugService is a singleton class!";this.message$=new i.BehaviorSubject(null)}return t.getService=function(){return this.service_||(this.service_=new t),this.service_},l(t,[{key:"message",get:function(){return this.message$.getValue()}}]),t.prototype.setMessage=function(t){this.message!==t&&this.message$.next(t)},t}(),ro=function(t){function e(){return t.apply(this,arguments)||this}h(e,t),e.getLoader=function(){return e.loader||(e.loader=new THREE.FontLoader)},e.getFontLoader=function(t){return e.fontLoader||(e.fontLoader=e.getLoader().load(C.getPath("fonts/helvetiker/helvetiker_regular.typeface.json"),t))};var i=e.prototype;return i.onInit=function(){var e=this;t.prototype.onInit.call(this),(this.vrService=he.getService()).session$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){t?e.text&&e.textGroup.add(e.text):e.text&&e.text.parent.remove(e.text)})),(this.debugService=oo.getService()).message$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){return e.message=t}))},i.createText=function(){var t=document.createElement("canvas");t.width=e.W,t.height=e.H;var n=new THREE.CanvasTexture(t);n.encoding=THREE.sRGBEncoding,n.minFilter=THREE.LinearFilter,n.magFilter=THREE.LinearFilter,n.mapping=THREE.UVMapping,n.needsUpdate=!0;var i=new THREE.PlaneBufferGeometry(4,1,2,2),o=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,map:n,color:16777215,transparent:!0,opacity:1}),r=new THREE.Mesh(i,o);return r.renderer=C.renderOrder.debug,r.position.y=0,r},i.loadFont=function(){var t=this;this.fontLoader=e.getFontLoader((function(e){t.font=e,t.message_&&t.setText(t.message_)}))},i.onCreate=function(t,e){var n=this.textGroup=new THREE.Group;this.material=new THREE.MeshBasicMaterial({depthTest:!1,color:16777215,transparent:!0,opacity:1,side:THREE.DoubleSide}),this.text=this.createText();"function"==typeof t&&t(n)},i.render=function(t,n){var i=this.group,o=this.host.camera,r=this.position;this.host.renderer.xr.isPresenting&&(o=this.host.renderer.xr.getCamera(o)),o.getWorldDirection(r),r.multiplyScalar(3),i.position.copy(r),i.lookAt(e.ORIGIN)},i.setText=function(t){var n=this.text;if(n)if(this.host.renderer.xr.isPresenting&&null!=t){var i=n.material.map.image.getContext("2d");i.clearRect(0,0,e.W,e.H),i.font="30px "+C.fontFamily,i.textBaseline="middle",i.textAlign="center",i.fillStyle="#FFFFFF",i.strokeStyle="#000000",i.lineWidth=5,i.fillText(t,e.W/2,e.H/2,e.W-20),n.material.map.needsUpdate=!0,this.textGroup.add(n)}else n.parent&&n.parent.remove(n)},l(e,[{key:"message",get:function(){return this.message_},set:function(t){t=t&&""!==t?t:null,this.message_!==t&&(this.message_=t,this.setText(t))}}]),e}(Zi);ro.ORIGIN=new THREE.Vector3,ro.W=1024,ro.H=256,ro.meta={selector:"[model-debug]",hosts:{host:Yi}};var so=function(t){function e(){return t.apply(this,arguments)||this}h(e,t),e.getLoader=function(){return e.loader||(e.loader=new THREE.TextureLoader)},e.getTexture=function(){return e.texture||(e.texture=e.getLoader().load(C.getPath("textures/ui/floor-nav.png")))},e.getOverTexture=function(){return e.textureOver||(e.textureOver=e.getLoader().load(C.getPath("textures/ui/floor-nav-over.png")))};var i=e.prototype;return i.getCoords=function(t){var n=e.RADIUS/10,i=Math.ceil((t.x+n/2)/n)-1,o=Math.ceil((t.z+n/2)/n)-1,r=Math.floor(e.COLS/2),s=Math.floor(e.ROWS/2),a=Math.min(r,Math.abs(i))*(i?Math.abs(i)/i:1),u=Math.min(s,Math.abs(o))*(o?Math.abs(o)/o:1);if(this.view.hasTile(this.indices.x+a,this.indices.y+u))return new THREE.Vector2(a,u)},i.onInit=function(){var e=this;t.prototype.onInit.call(this),this.indices=new THREE.Vector2,this.view.index$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){e.moveToIndex(t)}))},i.addTiles=function(t){var n=this,i=e.RADIUS/10,o=.9*i,r=new THREE.PlaneBufferGeometry(o,o,2,2);r.rotateX(-Math.PI/2);var s=e.getTexture();s.disposable=!1,s.encoding=THREE.sRGBEncoding;var a=e.getOverTexture();a.disposable=!1,a.encoding=THREE.sRGBEncoding;var u=this.tileMap={};this.tiles=new Array(e.COLS*e.ROWS).fill(0).map((function(o,l){var c=new THREE.ShaderMaterial({depthTest:!1,depthWrite:!1,transparent:!0,vertexShader:"\n#extension GL_EXT_frag_depth : enable\n\nvarying vec2 vUv;\nvoid main() {\n\tvUv = uv;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",fragmentShader:"\n#extension GL_EXT_frag_depth : enable\n\nvarying vec2 vUv;\nuniform sampler2D textureA;\nuniform sampler2D textureB;\nuniform float opacity;\nuniform float tween;\n\nvoid main() {\n\tvec4 colorA = texture2D(textureA, vUv);\n\tvec4 colorB = texture2D(textureB, vUv);\n\tvec4 color = mix(colorA, colorB, tween);\n\tcolor.a = clamp(color.a * opacity, 0.0, 1.0);\n\tcolor.rgb /= color.a;\n\tgl_FragColor = color;\n}\n",uniforms:{textureA:{type:"t",value:s},textureB:{type:"t",value:a},tween:{value:0},opacity:{value:0}}}),d=new THREE.Mesh(r,c),h=Math.floor(e.COLS/2),p=Math.floor(e.ROWS/2),m=Math.floor(l/e.COLS),f=-h+l%e.COLS,v=-p+m;d.position.set(f*i,.15*-e.RADIUS,v*i),d.name=n.getName("tile_"+f+"_"+v);d.uniforms={tween:0,opacity:0,ci:f,ri:v};return u[f+"_"+v]=d,t.add(d),d}));this.showTiles()},i.showTiles=function(){var t=this;this.tiles.forEach((function(e,n){var i=t.indices?t.indices.x:0,o=t.indices?t.indices.y:0,r=t.view.hasTile(i+e.uniforms.ci,o+e.uniforms.ri),s=e.uniforms;gsap.to(s,{opacity:r?1:0,duration:.4,ease:Power2.easeInOut,onUpdate:function(){e.material.uniforms.opacity.value=s.opacity,e.material.needsUpdate=!0}})}))},i.addHitArea=function(t){this.onGroundOver=this.onGroundOver.bind(this),this.onGroundMove=this.onGroundMove.bind(this),this.onGroundDown=this.onGroundDown.bind(this),this.onGroundOut=this.onGroundOut.bind(this);var n=new THREE.PlaneBufferGeometry(e.RADIUS,e.RADIUS,20,20);n.rotateX(-Math.PI/2);var i=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,opacity:0}),o=this.ground=new Yn(n,i);o.name=this.getName("ground"),o.position.set(0,.15*-e.RADIUS,0),o.on("over",this.onGroundOver),o.on("move",this.onGroundMove),o.on("out",this.onGroundOut),o.on("down",this.onGroundDown),t.add(o)},i.onGroundOver=function(){var t=this.ground,e=this.getCoords(t.intersection.point);this.coords=e},i.onGroundMove=function(){var t=this.ground,e=this.getCoords(t.intersection.point);this.coords=e},i.onGroundDown=function(){var t=this.ground,e=this.getCoords(t.intersection.point);if(this.coords=e,e){var n=this.view.getTileIndex(this.indices.x+e.x,this.indices.y+e.y);this.view.index=n,this.nav.next(n)}},i.onGroundOut=function(){this.coords=null},i.moveToIndex=function(t){this.coords=null;var n=this.view.tiles[t],i=new THREE.Vector2(n.indices.x-this.indices.x,n.indices.y-this.indices.y);this.indices.x=n.indices.x,this.indices.y=n.indices.y,this.showTiles();var o=e.RADIUS/10;this.move.next({indices:this.indices,coords:i,position:i.clone().multiplyScalar(o)})},i.onCreate=function(t,e){var n=new THREE.Group;this.addTiles(n),this.addHitArea(n),"function"==typeof t&&t(n)},i.onDestroy=function(){t.prototype.onDestroy.call(this);var e=this.ground;e.off("over",this.onGroundOver),e.off("move",this.onGroundMove),e.off("down",this.onGroundDown),e.off("out",this.onGroundOut)},l(e,[{key:"coords",set:function(t){if(!t&&this.coords_!==t||!this.coords_||t.x!==this.coords_.x||t.y!==this.coords_.y){var e=this.tileMap;if(this.coords_){var n=e[this.coords_.x+"_"+this.coords_.y],i=n.uniforms;gsap.to(i,{tween:0,duration:.4,delay:0,ease:Power2.easeInOut,onUpdate:function(){n.material.uniforms.tween.value=i.tween,n.material.needsUpdate=!0}})}if(t){var o=this.currentTile=e[t.x+"_"+t.y],r=o.uniforms;gsap.to(r,{tween:1,duration:.4,delay:0,ease:Power2.easeInOut,onUpdate:function(){o.material.uniforms.tween.value=r.tween,o.material.needsUpdate=!0}})}this.coords_=t}}},{key:"coords__",set:function(t){if(!t&&this.coords_!==t||!this.coords_||t.x!==this.coords_.x||t.y!==this.coords_.y){var e=this.tileMap;if(this.coords_){var n=e[this.coords_.x+"_"+this.coords_.y],i={tween:1};gsap.to(i,{duration:.4,tween:0,delay:0,ease:Power2.easeInOut,onUpdate:function(){n.material.opacity=i.tween}})}if(t){var o=this.currentTile=e[t.x+"_"+t.y],r={tween:0};gsap.to(r,{duration:.4,tween:1,delay:0,ease:Power2.easeInOut,onUpdate:function(){o.material.opacity=r.tween}})}this.coords_=t}}}]),e}(Zi);so.ORIGIN=new THREE.Vector3,so.RADIUS=101,so.COLS=11,so.ROWS=11,so.meta={selector:"[model-grid]",hosts:{host:Yi},outputs:["move","nav"],inputs:["view"]};var ao=function(t){function e(n,i,o){var r,s=e.geometry,a=e.material;(r=t.call(this,s,a)||this).renderOrder=C.renderOrder.menu,r.name=n.name,r.item=n,r.index=i,r.total=o,r.tween=0,r.opacity=0;var u=r.textureA=r.getTextureA(n.name);a.uniforms.textureA.value=u,a.uniforms.resolutionA.value=new THREE.Vector2(u.width,u.height);var l=r.textureB=r.getTextureB(n.name);return a.uniforms.textureB.value=l,a.uniforms.resolutionA.value=new THREE.Vector2(l.width,l.height),a.uniforms.tween.value=r.tween,a.uniforms.opacity.value=r.opacity,a.needsUpdate=!0,r.position.set(e.getX(i,o),e.getY(i,o),0),r.onOver=r.onOver.bind(p(r)),r.onOut=r.onOut.bind(p(r)),r}h(e,t),e.getGrid=function(t){var n=Math.ceil(t/e.ROWS);return[Math.ceil(t/n),n]},e.getX=function(t,n){var i=Math.ceil(n/e.ROWS),o=t%i,r=1/e.W*(e.W+e.G);return r/2-i*r/2+o*r},e.getY=function(t,n){var i=Math.ceil(n/e.ROWS),o=Math.ceil(n/i),r=Math.floor(t/i),s=1/e.W*(e.H+e.G);return o*s/2-s/2+r*-s},l(e,null,[{key:"geometry",get:function(){if(this.geometry_)return this.geometry_;var t=new THREE.PlaneBufferGeometry(1,1/e.W*e.H,2,2);return this.geometry_=t,t}},{key:"material",get:function(){return new THREE.ShaderMaterial({depthTest:!1,transparent:!0,vertexShader:lo.VERTEX_SHADER,fragmentShader:lo.FRAGMENT_SHADER,uniforms:{textureA:{type:"t",value:null},textureB:{type:"t",value:null},resolutionA:{value:new THREE.Vector2},resolutionB:{value:new THREE.Vector2},tween:{value:0},opacity:{value:0}}})}}]);var n=e.prototype;return n.getTextureA=function(t){var n=e.W,i=e.H,o=document.createElement("canvas");o.width=n,o.height=i;var r=o.getContext("2d");r.fillStyle=C.colors.menuBackground,r.fillRect(0,0,n,i),r.font="20px "+C.fontFamily,r.fillStyle=C.colors.menuForeground,r.fillText(t,10,50,n-20);var s=new THREE.CanvasTexture(o);return s.minFilter=THREE.LinearFilter,s.magFilter=THREE.LinearFilter,s.mapping=THREE.UVMapping,s.encoding=THREE.sRGBEncoding,s.needsUpdate=!0,s},n.getTextureB=function(t){var n=e.W,i=e.H,o=document.createElement("canvas");o.width=n,o.height=i;var r=o.getContext("2d");r.fillStyle=C.colors.menuOverBackground,r.fillRect(0,0,n,i),r.font="20px "+C.fontFamily,r.fillStyle=C.colors.menuOverForeground,r.fillText(t,10,50,n-20);var s=new THREE.CanvasTexture(o);return s.encoding=THREE.sRGBEncoding,s.magFilter=THREE.LinearFilter,s.needsUpdate=!0,s},n.onOver=function(){var t=this;gsap.to(this,{duration:.4,tween:1,ease:Power2.easeOut,onUpdate:function(){t.position.z=.1*t.tween,t.material.uniforms.tween.value=t.tween,t.material.needsUpdate=!0}})},n.onOut=function(){var t=this;gsap.to(this,{duration:.4,tween:0,ease:Power2.easeOut,onUpdate:function(){t.position.z=.1*t.tween,t.material.uniforms.tween.value=t.tween,t.material.needsUpdate=!0}})},n.dispose=function(){Xn.dispose(this),this.textureA.dispose(),this.textureB.dispose(),this.material.dispose(),this.geometry.dispose()},e}(Yn);ao.W=256,ao.H=64,ao.G=2,ao.ROWS=6;var uo=function(t){function e(e,n,i){return t.call(this,e,n,i)||this}h(e,t);var n=e.prototype;return n.getTextureA=function(t){var e=ao.W,n=ao.H,i=document.createElement("canvas");i.width=e,i.height=n;var o=i.getContext("2d");o.fillStyle=C.colors.menuBackBackground,o.fillRect(0,0,e,n),o.font="20px "+C.fontFamily,o.fillStyle=C.colors.menuBackForeground,o.fillText(t,10,50,e-20);var r=new THREE.CanvasTexture(i);return r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,r.mapping=THREE.UVMapping,r.needsUpdate=!0,r},n.getTextureB=function(t){var e=ao.W,n=ao.H,i=document.createElement("canvas");i.width=e,i.height=n;var o=i.getContext("2d");o.fillStyle=C.colors.menuBackOverBackground,o.fillRect(0,0,e,n),o.font="20px "+C.fontFamily,o.fillStyle=C.colors.menuBackOverForeground,o.fillText(t,10,50,e-20);var r=new THREE.CanvasTexture(i);return r.encoding=THREE.sRGBEncoding,r.magFilter=THREE.LinearFilter,r.needsUpdate=!0,r},e}(ao),lo=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var o=e.prototype;return o.onInit=function(){var e=this;t.prototype.onInit.call(this),this.onDown=this.onDown.bind(this),this.onToggle=this.onToggle.bind(this),St.in$.pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(t){switch(t.type){case bt:e.onToggle()}}))},o.onChanges=function(){},o.buildMenu=function(){var t=this;this.items&&je.getModelMenu$(this.items,this.editor).pipe(n.first()).subscribe((function(e){return t.groups=e}))},o.onDestroy=function(){this.buttons&&this.buttons.forEach((function(t){return Xn.dispose(t)})),t.prototype.onDestroy.call(this)},o.getContainer=function(){return this.host.cameraGroup},o.onCreate=function(t,e){var n=this.menuGroup=new THREE.Group;"function"==typeof t&&t(n)},o.render=function(t,n){var i=this.group,o=this.host.camera,r=this.position;if(this.host.renderer.xr.isPresenting)(o=this.host.renderer.xr.getCamera(o)).getWorldDirection(r),r.y+=.5,r.multiplyScalar(3),this.host.cameraGroup.worldToLocal(r),r.y+=this.host.cameraGroup.position.y,i.position.copy(r),i.scale.set(1,1,1),i.lookAt(o.position);else{o.getWorldDirection(r),Ci.mode===bi?r.multiplyScalar(.01):r.multiplyScalar(3),i.position.copy(r);var s=1/o.zoom;i.scale.set(s,s,s),i.lookAt(e.ORIGIN)}},o.onToggle=function(){j.state.locked||j.state.spying||(this.buttons?(this.removeMenu(),this.toggle.next()):(this.addMenu(),this.toggle.next(this)))},o.onDown=function(t){t.item&&"back"===t.item.type.name?(this.removeMenu(),t.item.backItem?this.addMenu(t.item.backItem.backItem):this.toggle.next()):this.addMenu(t.item)},o.items$=function(t){return void 0===t&&(t=null),t?i.of(t.items):je.getModelMenu$(this.items,this.editor).pipe(n.first())},o.addMenu=function(t){var e=this;void 0===t&&(t=null),this.removeMenu(),t&&"menu-group"!==t.type.name?this.nav.next(t):this.items$(t).subscribe((function(n){if(n){n=n.slice();var i={type:{name:"back"},name:t?"Back":"Close",backItem:t};n.push(i);var o=e.buttons=n.map((function(e,n,i){return e.backItem=t,"back"===e.type.name?new uo(e,n,i.length):new ao(e,n,i.length)}));o.forEach((function(t){t.depthTest=!1,t.on("over",t.onOver),t.on("out",t.onOut),t.on("down",e.onDown),e.menuGroup.add(t)})),gsap.to(o,{duration:.3,opacity:.8,ease:Power2.easeOut,stagger:{grid:ao.getGrid(o.length),from:0,amount:.02*o.length},onUpdate:function(){o.forEach((function(t){t.material.uniforms.opacity.value=t.opacity*(t.item.hidden?.5:1)}))}})}}))},o.removeMenu=function(){this.removeButtons(),this.removeToggler()},o.removeButtons=function(){var t=this,e=this.buttons;e&&e.forEach((function(e){t.menuGroup.remove(e),e.off("over",e.onOver),e.off("out",e.onOut),e.off("down",t.onDown),e.dispose()})),this.buttons=null},o.addToggler=function(){this.removeMenu();var t=this.toggler=new ao({type:{name:"menu"},name:"Menu"},0,1);t.opacity=.8,t.material.uniforms.opacity.value=t.opacity,t.material.needsUpdate=!0,t.on("over",t.onOver),t.on("out",t.onOut),t.on("down",this.onToggle),this.menuGroup.add(t)},o.removeToggler=function(){var t=this.toggler;t&&(this.menuGroup.remove(t),t.off("over",t.onOver),t.off("out",t.onOut),t.off("down",this.onToggle),t.dispose()),this.toggler=null},e}(Zi);lo.ORIGIN=new THREE.Vector3,lo.VERTEX_SHADER="\n#extension GL_EXT_frag_depth : enable\n\nvarying vec2 vUv;\nvoid main() {\n\tvUv = uv;\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",lo.FRAGMENT_SHADER="\n#extension GL_EXT_frag_depth : enable\n\nvarying vec2 vUv;\nuniform float opacity;\nuniform float tween;\nuniform sampler2D textureA;\nuniform sampler2D textureB;\nuniform vec2 resolutionA;\nuniform vec2 resolutionB;\n\nvoid main() {\n\tvec4 colorA = texture2D(textureA, vUv);\n\tvec4 colorB = texture2D(textureB, vUv);\n\tvec4 color = vec4(mix(colorA.rgb, colorB.rgb, tween), opacity);\n\tgl_FragColor = color;\n}\n",lo.meta={selector:"[model-menu]",hosts:{host:Yi},outputs:["nav","toggle"],inputs:["items","editor"]};var co=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var n=e.prototype;return n.onInit=function(){t.prototype.onInit.call(this),this.progress=null,this.isPresenting=!1},n.onChanges=function(){this.editing=this.item.selected},n.onCreate=function(t,e){var n=this;this.loadGltfModel(C.getPath(this.item.asset.folder),this.item.asset.file,(function(i){n.onGltfModelLoaded(i,t,e)}))},n.loadGltfModel=function(t,e,n){this.host.renderer;var i=Nn.getRef();(new THREE.GLTFLoader).setPath(t).load(e,(function(t){"function"==typeof n&&n(t.scene),Nn.setProgress(i,1)}),(function(t){Nn.setProgress(i,t.loaded,t.total)}))},n.onGltfModelLoaded=function(t,e,n){var i,o=this,r=(new THREE.Box3).setFromObject(t),s=r.max.clone().sub(r.min),a=2/Math.max(s.x,s.y,s.z);t.scale.set(a,a,a);var u=this.view,l=this.item;if(u.type.name===Nt.Model.name){(i=new THREE.Group).add(t),r.setFromObject(i);var c=r.getCenter(new THREE.Vector3);i.position.set(t.position.x-c.x,t.position.y-c.y,t.position.z-c.z+(this.host.renderer.xr.isPresenting?-2:0));var d=i.position.y,h={tween:1},p=function(){i.position.y=d+3*h.tween,i.rotation.y=0+Math.PI*h.tween};p(),this.makeInteractive(t),gsap.to(h,{duration:1.5,tween:0,delay:.1,ease:Power2.easeInOut,onUpdate:p,onComplete:function(){o.updateHelper()}})}else{r.setFromObject(t);var m=r.getCenter(new THREE.Vector3);t.position.set(-m.x,-m.y,-m.z),(i=new THREE.Group).add(t),l.position&&i.position.fromArray(l.position),l.rotation&&i.rotation.fromArray(l.rotation),l.scale&&i.scale.fromArray(l.scale),this.makeInteractive(t),this.updateHelper()}"function"==typeof e&&e(i,this.item)},n.render=function(t,e){var n=this.view,i=(this.item,this.mesh),o=this.host.renderer.xr.isPresenting;this.group;i&&(n.type.name===Nt.Model.name?(this.isPresenting!==o&&(this.isPresenting=o,o?(i.position.x=0,i.position.y=0,i.position.z=-2,i.rotation.y=0):(i.position.x=0,i.position.y=0,i.position.z=0,i.rotation.y=0)),o&&(i.rotation.y-=Math.PI/180/60*5)):o&&(i.rotation.y-=Math.PI/180/60*5))},n.onUpdate=function(t,e){this.view.type.name!==Nt.Model.name&&(t.position&&e.position.fromArray(t.position),t.rotation&&e.rotation.fromArray(t.rotation),t.scale&&e.scale.fromArray(t.scale)),this.updateHelper()},n.onUpdateAsset=function(t,e){var n=this;this.loadGltfModel(C.getPath(t.asset.folder),t.asset.file,(function(t){n.onGltfModelLoaded(t,(function(t,e){return n.onMount(t,e)}),(function(t,e){return n.onDismount(t,e)}))}))},n.onDragMove=function(t){this.editing=!0,this.view.type.name!==Nt.Model.name&&this.mesh.position.set(t.x,t.y,t.z).multiplyScalar(4),this.updateHelper()},n.onDragEnd=function(){this.view.type.name!==Nt.Model.name&&(this.item.position=this.mesh.position.toArray(),this.item.rotation=this.mesh.rotation.toArray(),this.item.scale=this.mesh.scale.toArray()),this.editing=!1},n.makeInteractive=function(t){var e=this,n=null;t.traverse((function(t){if(null===n&&t.isMesh&&!(t instanceof Yn)){var i=t.parent;(n=new Yn(t.geometry,t.material)).name=t.name,n.position.copy(t.position),n.rotation.copy(t.rotation),n.scale.copy(t.scale),n.on("down",(function(){e.down.next(e)})),i.remove(t),i.add(n)}})),null!==n&&this.makeInteractive(t)},e}(no);co.ORIGIN=new THREE.Vector3,co.meta={selector:"[model-model]",hosts:{host:Yi},outputs:["down"],inputs:["item","view"]};var ho="none",po="move",mo="info",fo="point",vo="title",go=function(t){function e(){return t.apply(this,arguments)||this}h(e,t),e.getNavGeometry=function(){return e.navGeometry||(e.navGeometry=new THREE.SphereBufferGeometry(3,12,12))},e.getLoader=function(){return e.loader||(e.loader=new THREE.TextureLoader)},e.getTexturePoint=function(){return e.texturePoint||(e.texturePoint=e.getLoader().load(C.getPath("textures/ui/nav-point.png")))},e.getTextureMove=function(){return e.textureMove||(e.textureMove=e.getLoader().load(C.getPath("textures/ui/nav-more.png")))},e.getTextureInfo=function(){return e.textureInfo||(e.textureInfo=e.getLoader().load(C.getPath("textures/ui/nav-info.png")))},e.getTexture=function(t){var e;switch(t){case po:e=this.getTextureMove();break;case mo:e=this.getTextureInfo();break;case fo:case vo:e=this.getTexturePoint()}return e},e.getTitleTexture=function(t,e){var n;if(e===vo){var i=t.title,o=document.createElement("canvas");o.width=512,o.height=32;var r=o.getContext("2d");r.imageSmoothingEnabled=!0,r.imageSmoothingQuality="high",r.font="28px "+C.fontFamily;var s=r.measureText(i).width+8,a=(s=Math.pow(2,Math.ceil(Math.log(s)/Math.log(2))))/2;o.width=s,r.font="28px "+C.fontFamily,r.textAlign="center",r.textBaseline="middle",r.strokeStyle="rgba(0, 0, 0, 0.5)",r.lineWidth=6,r.lineJoin="round",r.miterLimit=2,r.strokeText(i,a,16),r.fillStyle="white",r.fillText(i,a,16),n=new THREE.CanvasTexture(o)}return n},e.getNavMode=function(t,e){var n=ho;return t.viewId!==e.id?(n=po,this.isValidText(t.title)&&(n=vo),(this.isValidText(t.abstract)||t.asset&&t.asset.id||t.link&&t.link.href)&&(n=fo)):(this.isValidText(t.title)||this.isValidText(t.abstract)||t.asset&&t.asset.id||t.link&&t.link.href)&&(n=mo),n},e.isValidText=function(t){return t&&t.length>0};var n=e.prototype;return n.onInit=function(){t.prototype.onInit.call(this)},n.onChanges=function(){this.editing=this.item.selected},n.onCreate=function(t,n){var i,o=this;if((this.mode=e.getNavMode(this.item,this.view))!==ho){var r=new THREE.Group,s=(i=new THREE.Vector3).set.apply(i,this.item.position).normalize().multiplyScalar(e.RADIUS);r.position.set(s.x,s.y,s.z),this.onCreateSprites(r);var a=e.getNavGeometry(),u=new Yn(a,new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,opacity:0,color:65535}));u.name="[nav] "+this.item.id,u.lookAt(e.ORIGIN),u.depthTest=!1,u.renderOrder=0,r.add(u),u.on("over",(function(){o.over.next(o);var t=o.icon,e={scale:t.scale.x};gsap.to(e,{duration:.35,scale:.05,delay:0,ease:Power2.easeOut,overwrite:!0,onUpdate:function(){t.scale.set(e.scale,e.scale,e.scale)},onComplete:function(){}})})),u.on("out",(function(){o.out.next(o);var t=o.icon,e={scale:t.scale.x};gsap.to(e,{duration:.35,scale:.03,delay:0,ease:Power2.easeOut,overwrite:!0,onUpdate:function(){t.scale.set(e.scale,e.scale,e.scale)},onComplete:function(){}})})),u.on("down",(function(){o.down.next(o)}));var l={opacity:0};gsap.to(l,{duration:.7,opacity:1,delay:.5+.1*this.item.index,ease:Power2.easeInOut,overwrite:!0,onUpdate:function(){o.materials.forEach((function(t){t.opacity=l.opacity,t.needsUpdate=!0}))}}),"function"==typeof t&&t(r,this.item)}},n.onCreateSprites=function(t,n){void 0===n&&(n=0),this.onRemoveSprite(this.icon),this.onRemoveSprite(this.title);var i=this.mode=e.getNavMode(this.item,this.view);if(i!==ho){var o=e.getTexture(i);o.disposable=!1,o.encoding=THREE.sRGBEncoding;var r,s=new THREE.SpriteMaterial({depthTest:!1,depthWrite:!1,transparent:!0,map:o,sizeAttenuation:!1,opacity:n}),a=[s],u=this.icon=new THREE.Sprite(s);u.scale.set(.03,.03,.03),t.add(u);var l=e.getTitleTexture(this.item,i);if(l){r=new THREE.SpriteMaterial({depthTest:!1,depthWrite:!1,transparent:!0,map:l,sizeAttenuation:!1,opacity:n});var c=l.image,d=this.title=new THREE.Sprite(r);d.scale.set(.03*c.width/c.height,.03,.03),d.position.set(0,-3.5,0),t.add(d),a.push(r)}this.materials=a}},n.onRemoveSprite=function(t){t&&(t.parent&&t.parent.remove(t),t.material.map&&!1!==t.material.map.disposable&&t.material.map.dispose(),t.material.dispose())},n.onDestroy=function(){Xn.dispose(this.sphere),t.prototype.onDestroy.call(this)},n.shouldShowPanel=function(){return!this.editing&&this.mode!==po&&this.mode!==vo},n.onUpdate=function(t,n){var i;this.item=t,this.onCreateSprites(this.mesh,1);var o=(i=new THREE.Vector3).set.apply(i,t.position).normalize().multiplyScalar(e.RADIUS);n.position.set(o.x,o.y,o.z),this.updateHelper()},n.onDragMove=function(t){this.editing=!0,this.item.showPanel=!1,this.mesh.position.set(t.x,t.y,t.z).multiplyScalar(e.RADIUS),this.updateHelper()},n.onDragEnd=function(){this.item.position=(new THREE.Vector3).copy(this.mesh.position).normalize().toArray(),this.editing=!1},e}(no);go.ORIGIN=new THREE.Vector3,go.RADIUS=100,go.meta={selector:"[model-nav]",hosts:{host:Yi},outputs:["over","out","down"],inputs:["item","view"]};var bo=function(e){function n(){return e.apply(this,arguments)||this}h(n,e);var i=n.prototype;return i.onInit=function(){e.prototype.onInit.call(this)},i.onView=function(){var e=this;if(!this.viewed){this.viewed=!0;var i=t.getContext(this).node;this.getCanvasTexture(i).then((function(t){if(e.mesh){var o=.2*(e.item.asset?1.5:1),r=t.width/t.height,s=n.PANEL_RADIUS*o,a=n.PANEL_RADIUS*o/r,u=.25*s,l=e.item.mesh.position.normalize().multiplyScalar(n.PANEL_RADIUS),c=new THREE.SpriteMaterial({depthTest:!1,transparent:!0,opacity:0,map:t.map,sizeAttenuation:!1}),d=e.panel=new Qi(c);d.renderOrder=C.renderOrder.panel,d.scale.set(.02*s,.02*a,1),d.position.set(l.x,l.y+(a+2*u),l.z),d.on("down",(function(t){var n={x:parseInt(t.intersection.uv.x*i.offsetWidth),y:parseInt((1-t.intersection.uv.y)*i.offsetHeight)},o=Array.prototype.slice.call(i.querySelectorAll(".panel__link")).find((function(t){return n.x>=t.offsetLeft&&n.y>=t.offsetTop&&n.x<=t.offsetLeft+t.offsetWidth&&n.y<=t.offsetTop+t.offsetHeight}));if(o){e.down.next(o);var r=i.getBoundingClientRect(),s=new MouseEvent("mouseup",{button:0,buttons:0,clientX:n.x+r.left,clientY:n.y+r.top,movementX:0,movementY:0,relatedTarget:o,screenX:n.x,screenY:n.y});o.dispatchEvent(s),setTimeout((function(){vi.dismissEvent(s,vi.events$,vi.dismiss$,vi.downEvent)}),1)}})),e.mesh.add(d);var h={value:0};gsap.to(h,{duration:.5,value:1,delay:0,ease:Power2.easeInOut,onUpdate:function(){d.position.set(l.x,l.y+(a+2*u)-u*h.value,l.z),d.lookAt(n.ORIGIN),d.material.opacity=h.value,d.material.needsUpdate=!0}})}}),(function(t){console.log("ModelPanelComponent.getCanvasTexture.error",t)}))}},i.onCreate=function(t,e){var n=new THREE.Group;"function"==typeof t&&t(n)},i.onDestroy=function(){e.prototype.onDestroy.call(this)},i.imagesLoaded=function(){var e=t.getContext(this).node;if(e){var n=Array.prototype.slice.call(e.querySelectorAll("img")).map((function(t){return new Promise((function(e,n){var i=t.src&&-1===t.src.indexOf(location.origin);if(t.complete)return setTimeout((function(){e(i)}),10);var o=function(){t.removeEventListener("load",r),t.removeEventListener("error",s)},r=function(){o(),setTimeout((function(){e(i)}),10)},s=function(){o(),e(!1)};t.addEventListener("load",r),t.addEventListener("error",s)}))}));return n.length?Promise.all(n):Promise.resolve()}},i.getCanvasTexture=function(e){var n=this;return new Promise((function(i,o){setTimeout((function(){n.item.panelTexture?i(n.item.panelTexture):n.imagesLoaded().then((function(s){var a=t.getContext(n);if(a&&a.node){e=a.node;var u=s&&null!=s.find((function(t){return!0===t}));r(e,{backgroundColor:"#ffffff00",scale:2,useCORS:u}).then((function(t){var e=new THREE.CanvasTexture(t);n.item.panelTexture={map:e,width:t.width,height:t.height},i(n.item.panelTexture)}),(function(t){o(t)}))}}))}),1)}))},n}(Zi);bo.ORIGIN=new THREE.Vector3,bo.PANEL_RADIUS=99,bo.meta={selector:"[model-panel]",hosts:{host:Yi},outputs:["over","out","down"],inputs:["item"]};var yo=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var n=e.prototype;return n.onInit=function(){t.prototype.onInit.call(this)},n.onCreate=function(t,e){var n=new THREE.Group;"function"==typeof t&&t(n)},e}(Zi);yo.meta={selector:"[model-picture]",hosts:{host:Yi},inputs:["item"]};var wo=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var i=e.prototype;return i.onInit=function(){t.prototype.onInit.call(this)},i.onChanges=function(){this.editing=this.item.selected},i.onCreate=function(t,e){var i,o,r=this,s=this.item,a=this.items,u=new THREE.PlaneBufferGeometry(1,1,2,2);ci.getStreamId$(s).pipe(n.takeUntil(this.unsubscribe$)).subscribe((function(e){r.streamId!==e&&(r.streamId=e,o&&(o.unsubscribe(),o=null),!e&&s.asset||(s.streamId=e,i=new ci(s,a,u),s.position&&i.position.fromArray(s.position),s.rotation&&i.rotation.fromArray(s.rotation),s.scale&&i.scale.fromArray(s.scale),i.load((function(){"function"==typeof t&&t(i,s),o=i.events$().pipe(n.takeUntil(r.unsubscribe$)).subscribe((function(){}))})),i.on("down",(function(){r.down.next(r)})),i.on("playing",(function(t){r.play.next({itemId:r.item.id,playing:t})}))))}))},i.onDestroy=function(){t.prototype.onDestroy.call(this),this.mesh&&this.mesh.dispose()},i.onUpdate=function(t,e){t.position&&e.position.fromArray(t.position),t.rotation&&e.rotation.fromArray(t.rotation),t.scale&&e.scale.fromArray(t.scale),this.updateHelper()},i.onUpdateAsset=function(t,e){var i=this;this.mesh.updateByItem(t),ci.getStreamId$(t).pipe(n.filter((function(t){return null!==t})),n.take(1)).subscribe((function(e){t.streamId=e,i.mesh.load((function(){}))}))},i.onDragMove=function(t){this.item.showPanel=!1,this.editing=!0,this.mesh.position.set(t.x,t.y,t.z).multiplyScalar(20),this.mesh.lookAt(e.ORIGIN),this.updateHelper()},i.onDragEnd=function(){this.item.position=this.mesh.position.toArray(),this.item.rotation=this.mesh.rotation.toArray(),this.item.scale=this.mesh.scale.toArray(),this.editing=!1},e}(no);wo.ORIGIN=new THREE.Vector3,wo.textures={},wo.meta={selector:"[model-plane]",hosts:{host:Yi},outputs:["down","play"],inputs:["item","items"]};var Eo=100.99,xo=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var i=e.prototype;return i.onInit=function(){this.title_="",t.prototype.onInit.call(this),this.progress=Nn.progress},i.onCreate=function(t,e){var i=this;this.getCanvasTexture().then((function(e){var o=i.createMesh(e);"function"==typeof t&&t(o),Nn.progress$.pipe(n.takeUntil(i.unsubscribe$)).subscribe((function(t){t.count?i.title=0===t.value?M.transform("loading"):t.title:i.title=i.getTitle()}))}))},i.getTitle=function(){return this.view&&this.view.type.name===Nt.WaitingRoom.name?M.transform("waiting_host"):""},i.show=function(){this.mesh.add(this.banner),this.material.opacity=1,this.material.needsUpdate=!0},i.hide=function(){this.material;this.material.opacity=0,this.material.needsUpdate=!0},i.createMesh=function(t){var e=new THREE.Group,n=Math.PI/180*360,i=Eo*n,o=i/360*2.4,r=i/(t.width*o/t.height),s=new THREE.CylinderBufferGeometry(Eo,Eo,o,80,2,!0,0,n);s.scale(-1,1,1);var a=t.texture;a.wrapS=a.wrapY=THREE.RepeatWrapping,a.repeat.x=r,a.encoding=THREE.sRGBEncoding;var u=this.material=new THREE.MeshBasicMaterial({map:a,transparent:!0,opacity:0});this.banner=new THREE.Mesh(s,u);return e.userData={render:function(){e.rotation.y+=Math.PI/180*.02}},e},i.updateProgress=function(){var t=this;this.getCanvasTexture().then((function(e){var n=Math.PI/180*360,i=Eo*n,o=i/360*2.4,r=i/(e.width*o/e.height);t.texture.repeat.x=r}))},i.getCanvasTexture=function(){var t=this;return new Promise((function(e,n){var i,o=512,r=64,s=Math.floor(48),a=Math.floor(3.2);(i=t.canvas?t.canvas:t.canvas=document.createElement("canvas")).width=o,i.height=r;var u,l=t.title_,c=i.getContext("2d");c.imageSmoothingEnabled=!0,c.imageSmoothingQuality="high",c.font="300 "+s+"px "+C.fontFamily,o=c.measureText(l).width+8,o=Math.max(512,Math.pow(2,Math.ceil(Math.log(o)/Math.log(2)))),i.width=o,c.clearRect(0,0,o,r),c.fillStyle="#0000005A",c.fillRect(0,0,o,r),c.font="300 "+s+"px "+C.fontFamily,c.textAlign="center",c.textBaseline="middle",c.strokeStyle="rgba(0, 0, 0, 0.35)",c.lineWidth=a,c.lineJoin="round",c.miterLimit=2,c.strokeText(l,o/2,32),c.fillStyle="white",c.fillText(l,o/2,32,o),t.texture?(u=t.texture).needsUpdate=!0:u=t.texture=new THREE.CanvasTexture(i),e({texture:u,width:o,height:r})}))},l(e,[{key:"title",get:function(){return this.title_},set:function(t){this.title_!==t&&(this.title_=t,""!==t?(this.updateProgress(),this.show()):this.hide())}}]),e}(Zi);xo.meta={selector:"[model-progress]",hosts:{host:Yi},inputs:["view"]};var To=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var n=e.prototype;return n.onInit=function(){t.prototype.onInit.call(this),this.progress=0},n.onCreate=function(t,e){var n=this;this.loadModel(C.getPath(this.item.modelFolder),this.item.modelFile,(function(e){"function"==typeof t&&t(e),n.progress=0,n.pushChanges()}))},n.getLoader=function(t,e){var n;return(n=-1!==e.indexOf(".fbx")?new THREE.FBXLoader:new THREE.GLTFLoader).setPath(t),n},n.loadModel=function(t,e,n){var i=this;this.getLoader(t,e).load(e,(function(t){var e,o=t.scene;e=o||t;var r=i.item.items;e.scale.set(.05,.05,.05),e.traverse((function(t){if(t.isMesh){var e=r.find((function(e){return e.id===t.name}));if(e)e.mesh=t;else{t.material.dispose();var n=new THREE.MeshStandardMaterial({color:1118481,roughness:.6});t.material=n}}})),e.position.y=3*-1.66,r.forEach((function(t){var e=t.mesh;if(e){e.material&&e.material.color.setHex(0);var n=e.parent,o=t.mesh=new ci(t,r,e.geometry);o.depthTest=!1,o.renderOrder=0,o.name=e.name,o.position.copy(e.position),o.rotation.copy(e.rotation),o.scale.copy(e.scale),o.load((function(){n.add(o),n.remove(e),e.material&&e.material.dispose()})),o.on("down",(function(){console.log("ModelRoomComponent.down"),i.down.next(i)})),o.on("playing",(function(e){console.log("ModelRoomComponent.playing",e),i.play.next({itemId:t.id,playing:e})}))}}));new Array(3).fill(0).map((function(t,e){var n=new THREE.PointLight(16777215,.1,1e3,2),o=Math.PI/180*45+Math.PI/180*120*e;return n.position.set(5*Math.cos(o),1,5*Math.sin(o)),i.group.add(n),n}));"function"==typeof n&&n(e),i.progress=0,i.pushChanges()}),(function(t){t.lengthComputable?i.progress=Math.round(t.loaded/t.total*100):(i.progress=i.progress||0,i.progress=Math.min(100,i.progress+1)),i.pushChanges()}))},n.onDestroy=function(){t.prototype.onDestroy.call(this);var e=this.item;if(e){var n=e.items;n&&n.forEach((function(t){t.mesh&&(t.mesh.dispose(),delete t.mesh)}))}},e}(Zi);To.textures={},To.meta={selector:"[model-room]",hosts:{host:Yi},outputs:["down","play"],inputs:["item"]};var Io=function(t){function e(){return t.apply(this,arguments)||this}h(e,t);var n=e.prototype;return n.onInit=function(){t.prototype.onInit.call(this)},n.onCreate=function(t,e){var n=new THREE.Group;"function"==typeof t&&t(n)},e}(Zi);Io.meta={selector:"[model-text]",hosts:{host:Yi},inputs:["item"]};var Ro=function(t){function e(){return t.apply(this,arguments)||this}return h(e,t),e}(t.Module);Ro.meta={imports:[t.CoreModule,e.FormModule,an],declarations:[P,pe,_t,kt,Lt,Ut,Vt,Me,ze,qe,yn,mn,fn,gn,bn,wn,En,Se,xn,Tn,In,Rn,Cn,$e,Ae,Pe,kn,Hn,zn,An,Mn,M,Dn,Fn,zt,eo,Zi,io,ro,co,so,lo,go,bo,yo,wo,xo,To,Io,jn,Sn,Bn,qt,Gn,$n,Yi],bootstrap:me},t.Browser.bootstrap(Ro)}));
//# sourceMappingURL=main.min.js.map