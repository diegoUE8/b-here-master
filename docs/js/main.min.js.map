{"version":3,"sources":["src/js/main.js","../../src/js/environment.served.js","../../src/js/utils/utils.js","../../src/js/environment.js","../../src/js/environment.static.js","../../src/js/access/access-code.component.js","../../src/js/location/location.service.js","../../src/js/label/label.pipe.js","../../src/js/forms/controls.component.js","../../src/js/http/http.service.js","../../src/js/user/user.js","../../src/js/user/user.service.js","../../src/js/access/access.component.js","../../src/js/message/message.service.js","../../src/js/state/state.service.js","../../src/js/emittable/emittable.js","../../src/js/local-storage/session-storage.service.js","../../src/js/stream/stream.service.js","../../src/js/agora/agora.types.js","../../src/js/agora/agora.service.js","../../src/js/agora/agora-chat.component.js","../../src/js/agora/agora-check.component.js","../../src/js/device/device.service.js","../../src/js/local-storage/local-storage.service.js","../../src/js/agora/agora-checklist.component.js","../../src/js/audio/audio-stream.service.js","../../src/js/agora/agora-device-preview.component.js","../../src/js/agora/agora-device.component.js","../../src/js/agora/agora-link.component.js","../../src/js/agora/agora-login.component.js","../../src/js/agora/agora-name.component.js","../../src/js/agora/agora-stream.component.js","../../src/js/gtm/gtm.service.js","../../src/js/modal/modal.service.js","../../src/js/modal/modal-outlet.component.js","../../src/js/try-in-ar/try-in-ar-modal.component.js","../../src/js/view/view.js","../../src/js/view/view.service.js","../../src/js/world/vr.service.js","../../src/js/agora/agora.component.js","../../src/js/app.component.js","../../src/js/asset/asset.js","../../src/js/asset/asset.pipe.js","../../src/js/control-request/control-request-modal.component.js","../../src/js/drop/drop.directive.js","../../src/js/dropdown/dropdown.directive.js","../../src/js/dropdown/dropdown-item.directive.js","../../src/js/toast/toast.service.js","../../src/js/toast/toast-outlet.component.js","../../src/js/editor/aside/aside.component.js","../../src/js/asset/asset.service.js","../../src/js/editor/editor.service.js","../../src/js/editor/editor.component.js","../../src/js/editor/menu/menu.service.js","../../src/js/drop/drop.service.js","../../src/js/forms/control.component.js","../../src/js/forms/control-asset.component.js","../../src/js/forms/control-menu.component.js","../../src/js/editor/menu/menu-builder.component.js","../../src/js/editor/modals/curved-plane-modal.component.js","../../src/js/editor/modals/item-model-modal.component.js","../../src/js/editor/modals/model-modal.component.js","../../src/js/editor/modals/nav-modal.component.js","../../src/js/editor/modals/panorama-grid-modal.component.js","../../src/js/editor/modals/panorama-modal.component.js","../../src/js/editor/modals/plane-modal.component.js","../../src/js/editor/modals/remove-modal.component.js","../../src/js/editor/update/update-view-item.component.js","../../src/js/editor/update/update-view-tile.component.js","../../src/js/editor/update/update-view.component.js","../../src/js/editor/editor.module.js","../../src/js/flag/flag.pipe.js","../../src/js/upload/upload.service.js","../../src/js/forms/control-assets.component.js","../../src/js/forms/control-checkbox.component.js","../../src/js/keyboard/keyboard.service.js","../../src/js/forms/control-custom-select.component.js","../../src/js/forms/control-link.component.js","../../src/js/forms/control-localized-asset.component.js","../../src/js/forms/control-model.component.js","../../src/js/forms/control-number.component.js","../../src/js/forms/control-password.component.js","../../src/js/forms/control-select.component.js","../../src/js/forms/control-text.component.js","../../src/js/forms/control-textarea.component.js","../../src/js/forms/control-vector.component.js","../../src/js/forms/disabled.directive.js","../../src/js/forms/errors.component.js","../../src/js/forms/input-value.component.js","../../src/js/forms/test.component.js","../../src/js/forms/value.directive.js","../../src/js/html/html.pipe.js","../../src/js/id/id.directive.js","../../src/js/layout/layout.component.js","../../src/js/image/image.service.js","../../src/js/intersection/intersection.service.js","../../src/js/lazy/lazy.cache.js","../../src/js/lazy/lazy.directive.js","../../src/js/modal/modal.component.js","../../src/js/slug/slug.pipe.js","../../src/js/svg/svg-icon.structure.js","../../src/js/try-in-ar/try-in-ar.component.js","../../src/js/upload/upload-item.component.js","../../src/js/video/hls.directive.js","../../src/js/virtual/virtual.item.js","../../src/js/virtual/virtual.structure.js","../../src/js/loader/loader.service.js","../../src/js/world/envmap/envmap.loader.js","../../src/js/world/interactive/freezable.mesh.js","../../src/js/world/interactive/emittable.mesh.js","../../src/js/world/interactive/interactive.js","../../src/js/world/interactive/interactive.mesh.js","../../src/js/world/video-texture.js","../../src/js/world/panorama/panorama.js","../../src/js/rect/rect.js","../../src/js/world/avatar/avatar-element.js","../../src/js/world/camera/camera.js","../../src/js/world/media/media-loader.js","../../src/js/world/media/media-mesh.js","../../src/js/drag/drag.service.js","../../src/js/world/orbit/orbit.js","../../src/js/world/phone/phone.element.js","../../src/js/world/pointer/pointer.element.js","../../src/js/world/webxr/gamepad.js","../../src/js/world/interactive/emittable.js","../../src/js/world/webxr/motion-controllers.module.js","../../src/js/world/webxr/xr-controller-model-factory.js","../../src/js/world/world.component.js","../../src/js/world/model/model.component.js","../../src/js/world/model/model-banner.component.js","../../src/js/world/model/model-editable.component.js","../../src/js/world/model/model-curved-plane.component.js","../../src/js/world/debug.service.js","../../src/js/world/model/model-debug.component.js","../../src/js/world/model/model-grid.component.js","../../src/js/world/model/model-menu.component.js","../../src/js/world/model/model-model.component.js","../../src/js/world/model/model-nav.component.js","../../src/js/world/interactive/interactive.sprite.js","../../src/js/world/interactive/emittable.sprite.js","../../src/js/world/interactive/freezable.sprite.js","../../src/js/world/model/model-panel.component.js","../../src/js/world/model/model-picture.component.js","../../src/js/world/model/model-plane.component.js","../../src/js/world/model/model-progress.component.js","../../src/js/world/model/model-room.component.js","../../src/js/world/model/model-text.component.js","../../src/js/app.module.js","../../src/js/main.js"],"names":["g","f","exports","module","require","define","amd","globalThis","self","rxcomp","form","rxjs","operators","THREE","html2canvas","this","rxcompForm","three","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","args","arguments","apply","err","undefined","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","_createClass","Constructor","protoProps","staticProps","prototype","_defineProperty","obj","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","push","_inheritsLoose","subClass","superClass","create","constructor","__proto__","_assertThisInitialized","ReferenceError","hasOwnProperty","call","Utils","merge","source","_this","forEach","Array","isArray","NODE","DEBUG","get","URLSearchParams","window","location","search","BASE_HREF","document","querySelector","getAttribute","HEROKU","host","indexOf","STATIC","port","DEVELOPMENT","split","ENV","PRODUCTION","Environment","_proto","options","url","language","market","assign","getAbsoluteUrl","path","params","origin","replace","getPath","isLocal","href","set","console","log","githubDocs","defaultAppOptions","channelName","flags","production","useProxy","useToken","selfService","guidedTourRequest","editor","ar","menu","attendee","streamer","viewer","smartDevice","maxQuality","heroku","environmentOptions","appKey","editorAssetScreen","chat","logo","background","image","video","colors","menuBackground","menuForeground","menuOverBackground","menuOverForeground","menuBackBackground","menuBackForeground","menuBackOverBackground","menuBackOverForeground","disabledViewTypes","disabledViewItemTypes","assets","worker","index","access","selfServiceTour","guidedTour","accessCode","template","tryInAr","modal","controlRequest","view","panorama","panorama-grid","room-3d","model","viewItem","nav","plane","curved-plane","texture","remove","languages","defaultLanguage","fontFamily","renderOrder","tile","banner","panel","debug","pointer","environment","bhere","_Utils$merge","LocationService","has","keyOrValue","history","pushState","title","toString","deserialize","encoded","decode","serialize","encode","decoded","json","atob","JSON","parse","stringify","btoa","AccessCodeComponent","_Component","onInit","env","link","node","getContext","QRious","element","size","Component","meta","selector","LABELS","browse","cancel","drag_and_drop_images","error_email","error_match","error_required","loading","required","select","select_file","update","upload","waiting_host","editor_image","editor_video","editor_model","editor_publisher_stream","editor_next_attendee_stream","editor_waiting_room","editor_panorama","editor_panorama_grid","editor_room_3d","editor_nav","editor_gltf","editor_plane","editor_curved_plane","editor_texture","labels","LabelPipe","_Pipe","transform","getKeys","_len","_key","map","x","join","Pipe","name","ControlsComponent","getControl","group","formGroup","control","fieldsToFormGroup","fields","FormGroup","reduce","p","c","validators","type","Validators","RequiredTrueValidator","RequiredValidator","EmailValidator","PatternValidator","pattern","FormControl","slice","unshift","id","fieldsToFormControls","inputs","hosts","FormAbstractCollectionDirective","HttpService","http$","method","data","format","response_","from","fetch","headers","Accept","Content-Type","body","response","typedResponse","contentType","text","ok","warn","pipe","catchError","throwError","getError","get$","query","delete$","post$","put$","patch$","status","statusCode","statusMessage","statusText","RoleType","Publisher","Attendee","Streamer","Viewer","SmartDevice","SelfService","User","UserService","setUser","user","user$","next","me$","mapUser","of","switchMap","login$","payload","_this2","tap","logout$","_this3","guidedTour$","_this4","selfServiceTour$","_this5","resolve$","log$","BehaviorSubject","AccessComponent","state","onSelfServiceTourRequest","initRequestForm","pushChanges","navigator","userAgent","test","onSubmit","onGuidedTourRequest","onGuidedTourAccess","first","subscribe","onLogin","initLoginForm","formSubscription","unsubscribe","roles","label","antiforgery","controls","changes$","takeUntil","unsubscribe$","changes","username","password","checkRequest","checkField","testValues","patch","reset","onBack","valid","submitted","touched","isValid","MessageService","message","message$","in","in$","sendBack","remoteId","clientId","out","out$","ReplaySubject","StateService","patchState","state$","getValue","Emittable","events","on","callback","event","off","once","emit","broadcast","callbacks","SessionStorageService","delete","isSessionStorageSupported","sessionStorage","removeItem","exist","e","cache","setItem","supported","StreamServiceMode","StreamService","orderedRemotes$","combineLatest","remotes$","interval","datas","orderedRemotes","remote","clientInfo","audioLevel","getAudioLevel","peekAudioLevel","Math","max","sort","a","b","role","order","min","distinctUntilChanged","uid","getEditorStreams$","mediaDevices","getUserMedia","mode","media","createElement","setAttribute","appendChild","width","height","stream","srcObject","src","URL","createObjectURL","oncanplay","fakePublisherStream","getId","fakeAttendeeStream","fakeSmartDeviceStream","editorStreams$","play","catch","shareReplay","getEditorScreens$","getDisplayMedia","screen","fakePublisherScreen","fakeAttendeeScreen","editorScreens$","getPublisherStreamId$","publisherStreamId","streams$","getRemoteById","streamId","remotes","find","remoteAdd","remoteRemove","isPlaying","stop","splice","remoteSetClientInfo","editorStreams","editorScreens","local","local$","screen$","peers","peers$","streams","publisherStream","_streams","_streams2","StreamQualities","profile","resolution","frameRate","bitrate","getStreamQuality","lowestQuality","highestQuality","AgoraStatus","MessageType","AgoraEvent","AgoraPeerEvent","_AgoraEvent","AgoraRemoteEvent","_AgoraEvent2","AgoraMuteVideoEvent","_AgoraEvent3","AgoraUnmuteVideoEvent","_AgoraEvent4","AgoraMuteAudioEvent","_AgoraEvent5","AgoraUnmuteAudioEvent","_AgoraEvent6","AgoraVolumeLevelsEvent","_AgoraEvent7","AgoraService","defaultDevices","AGORA","_Emittable","onStreamPublished","bind","onStreamUnpublished","onStreamAdded","onStreamRemoved","onStreamSubscribed","onMuteVideo","onUnmuteVideo","onMuteAudio","onUnmuteAudio","onVolumeIndicator","onPeerConnect","onPeerLeaved","onConnectionStateChange","onTokenPrivilegeWillExpire","onTokenPrivilegeDidExpire","onMessage","devices","videos","audios","quality","membersCount","getSingleton","addStreamDevice","removeStreamDevice","deviceId","kind","audio","devices$","defaultVideos","defaultAudios","getDevices","tempStream","close","device","AgoraRTC","createStream","init","connect$","preferences","connecting","setTimeout","createClient","channelNameLink","getChannelNameLink","rtcToken$","token","membersCount$","channelId","messageClient","getChannelMemberCount","counters","observeMemberCount","unobserveMemberCount","membersCountSubscription","client","Logger","setLogLevel","NONE","codec","clientInit","startProxyServer","setClientRole","onError","AgoraRTM","createInstance","logFilter","LOG_FILTER_OFF","setParameters","match","getUniqueUserId","floor","random","Date","now","channel","connected","rtmToken$","joinMessageChannel","success","autoDetectDevice","createMediaStream","login","createChannel","detectDevices","getVideoOptions","crossOrigin","hls","Hls","attachMedia","Events","MEDIA_ATTACHED","loadSource","MANIFEST_PARSED","captureStream","videoSource","getVideoTracks","cameraId","getAudioOptions","loadLevel","levels","audioSource","getAudioTracks","microphoneId","inputDevices","_this6","streamID","Boolean","all","createLocalStreamWithOptions","_this7","setVideoProfile","setVideoEncoderConfiguration","publishLocalStream","initLocalStream","_this8","publish","screenUid","unpublishLocalStream","unpublish","leaveChannel","_this9","unpublishScreenStream","leaveMessageChannel","leaveClient","leaveScreenClient","_this10","leave","stopProxyServer","_this11","logout","toggleCamera","userMuteVideo","unmuteVideo","cameraMuted","broadcastEvent","muteVideo","toggleAudio","userMuteAudio","unmuteAudio","audioMuted","muteAudio","toggleControl","_this12","sendRemoteControlDismiss","spying","sendRemoteInfoDismiss","sendRemoteControlRequest","toggleSpy","_this13","sendSpyRemoteRequestInfo","newMessageId","_this14","sendMessage","messageId","_this15","sendRemoteRequestPeerInfo","_this16","hosted","locked","sendControlRemoteRequestInfo","_this17","_this18","_this19","navToView","viewId","spyed","getSessionStats","stats","Duration","UserCount","SendBytes","RecvBytes","SendBitrate","RecvBitrate","getSystemStats","BatteryLevel","_this20","send","addOrUpdateChannelAttributes","messages","attributes","date","promise","enableNotificationToChannelMembers","getChannelAttributes","lastUpdateTs","attribute","checkBroadcastMessage","broadcastMessage","container","classList","add","peerAdd","peerRemove","peer","peerId","attr","level","renewToken","toggleScreen","_this21","screenClient","createScreenStream","createScreenClient","screenJoin","_this22","onScreenError","onScreenStreamPublished","onScreenStreamUnpublished","_this23","_this24","setScreenProfile","publishScreenStream","_this25","checkRtcConnection","checkRtcTryJoin","finally","checkRtmConnection","devices_","enumerateDevices","getTracks","track","ChatMessage","clientId_","names","shortName","substr","toUpperCase","getPayload","getCopy","AgoraChatComponent","_proto2","checkTypings","pushMessage","typingBegin","typingEnd","groupedMessages","demo","getFakeList","updateMessages","agora","onView","onChanges","createMessage","randomMessage","onClose","scrollToBottom","scrollView","scrollTop","scrollHeight","removeTyping","recursive","typings","typings_","lastMessage","typing","createRandomMessage","outputs","concat","AgoraCheckComponent","DevicePlatform","DeviceService","getDevicePlatform","vendor","opera","isIOS","isVRHeadset","platform_","platform","LocalStorageService","isLocalStorageSupported","localStorage","TIMEOUT","AgoraChecklistComponent","checklist","errors","busy","shouldCheckDevices","checkBrowser","browser","checkSystemRequirements","checkHttps","checkAudio","checkVideo","checkRtc","checkRtm","skip","https","protocol","audioinput","videoinput","rtc","rtm","onComplete","_","onNext","checked","openHttps","AudioStreamService","addSource","streamOrElement","MediaStream","sources_","context","createMediaStreamSource","clone","createMediaElementSource","removeSource","removeSourceKey","analyser","disconnect","frequency$","fftSize","Uint8Array","connect","frame$","withLatestFrom","_ref","getByteFrequencyData","finalize","volume$","volume","clipped","meter","audioMeterCreate","_ref2","checkClipping","clipLevel","averaging","clipLag","processor","createScriptProcessor","onaudioprocess","audioMeterProcess","audioMeterClip","dispose","audioMeterDispose","clipping","lastClip","destination","buffer","inputBuffer","getChannelData","bufferLength","sum","abs","performance","rms","sqrt","step$","previous","Observable","observer","requestAnimationFrame","startTime","deltaTime","frame","context_","AudioContext","analyser_","createAnalyser","expand","share","AgoraDevicePreviewComponent","initialized_","onLoadedMetadata","preview","addEventListener","hasPreview","bars","fill","bar","onDestroy","removeEventListener","initStream","video_","audio_","ideal","analyzeData","loadingStream_","frequencySubscription","frequency","pow","style","left","opacity","change","AgoraDeviceComponent","isHttps","initForm","videoOptions","audioOptions","onStreamDidChange","onStream","onEnter","enter","AgoraLinkComponent","linkAttendee","linkStreamer","linkViewer","linkSmartDevice","onGenerateMeetingId","$event","timestamp","valueOf","getRoleMeetingId","replaceRoleMeetingId","meetingId","components","padded","getRoleIndex","onInputDidChange","setRoleMeetingId","meetingIdSegments","onCopyToClipBoard","asAccessCode","input","position","top","getAccessCodeUrl","getUrl","focus","setSelectionRange","execCommand","parentNode","removeChild","alert","replaceUrl","shareable","pathname","replaceState","pageTitle","num","s","AgoraLoginComponent","friendlyMessage","firstName","lastName","AgoraNameComponent","AgoraStreamComponent","videoMuted","shouldUseResumeGesture","vrContainer","setMediaStream","mediaStream","videoNode","onToggleSpy","videoMuted_","audioMuted_","streamId_","stream_","player","childElementCount","firstElementChild","div","fit","removeAttribute","vrContainer_","videoNode_","GtmService","dataLayer","push_","ModalEvent","ModalResolveEvent","_ModalEvent","ModalRejectEvent","_ModalEvent2","ModalService","open$","getTemplate$","getNode","modal$","events$","load$","innerHTML","Subject","ModalOutletComponent","modalNode","modal_","compile","TryInARModalComponent","_getContext","parentInstance","openInAR","open","ViewType","WaitingRoom","Panorama","PanoramaGrid","Room3d","Model","ViewItemType","Nav","Plane","CurvedPlane","Texture","View","updateIndices","items","item","mapViewItem","tiles","mapViewTile","originalItems","publisherStreamIndex","attendeeStreamIndex","smartDeviceStream","publisherScreenIndex","attendeeScreenIndex","asset","file","allowedProps","substring","PanoramaView","_View","PanoramaGridView","_View2","mapTiles","flipAxes","invertAxes","folder","index_","index$","selected","navs","axes","indices","Vector2","y","parseInt","updateCurrentItems","getTileIndex","hasTile","getTile","ModelView","_View3","ViewItem","abstract","NavViewItem","_ViewItem","ViewTile","mapView","ViewService","data$","data$_","dataUrl","views","view$","initialViewId","action$_","action","keepOrientation","getWaitingRoom","hostedView$","waitingRoom","hosted$","editorView$","viewById$","viewLike$","liked","likes","setViewLike$","orientation","latitude","longitude","XRStatus","VRService","service_","state_","camera","Vector3","quaternion","Quaternion","scale","array","onSessionStarted","onSessionEnded","status$","session$","currentSession","xr","isSessionSupported","isSecureContext","getService","session","toggleVR","requestSession","optionalFeatures","end","isDisabled","getLabel","updateState","world","renderer","scene","matrixWorld","decompose","z","w","AgoraComponent","vrService","resolveUser","getLinkRole","linkRole","initWithUser","userGuard","userGuardRedirect","setNextStatus","has3D","live","initAgora","viewObserver$","onRemoteNavTo","showLove","chatDirty","onChecked","onLink","onName","sharedMeetingId","fullName","userType","onNavTo","navItem","gridIndex","toggleVolume","volumeMuted","toggleChat","onChatClose","onToggleControl","addLike","skipTimeout","uiClass","AppComponent","EXT_IMAGE","EXT_VIDEO","EXT_MODEL","AssetType","Image","Video","PublisherStream","AttendeeStream","PublisherScreen","AttendeeScreen","SmartDeviceStream","AssetGroupType","ImageOrVideo","ids","STREAM_TYPES","assetIsStream","assetGroupTypeFromItem","assetPayloadFromGroupTypeId","groupTypeId","assetTypeById","Asset","assetTypeFromPath","extension","pop","toLowerCase","fromUrl","segments","mapAsset","MIME_IMAGE","MIME_VIDEO","MIME_MODEL","MIME_STREAM","AssetPipe","RegExp","isVideo","isModel","isStream","ControlRequestModalComponent","onAccept","onReject","DropDirective","_Directive","event$","fromEvent","expression","outputFunction","makeFunction","preventDefault","Directive","DROPDOWN_ID","DropdownDirective","trigger","opened","onClick","onDocumentClick","openDropdown","closeDropdown","addListeners","dropdown$","contains","addDocumentListeners","dropped","removeDocumentListeners","removeListeners","nextId","dropdown","id_","DropdownItemDirective","ToastResolveEvent","_ToastEvent","toast","ToastService","getTime","toast$","duration","ToastOutletComponent","AsideComponent","viewTypes","disabled","viewItemTypes","setSupportedViewTypes","setSupportedViewItemTypes","supportedViewTypes","supportedViewType","supportedViewItemTypes","supportedViewItemType","setMode","viewTypeName","viewItemTypeName","onSelect","onUpdate","onDelete","AssetService","assetCreate$","assetUpdate$","assetDelete$","localizedAssetCreate$","lg","localizedAssetUpdate$","upload$","files","formData","FormData","append","xhr","XMLHttpRequest","readyState","responseText","createOrUpdateAsset$","uploads","createOrUpdateLocalizedAsset$","assetDidChange","current","previousId","previousFile","currentId","currentFile","EditorService","viewIdOptions$","viewCreate$","viewUpdate$","viewDelete$","inferItemCreate$","tileItemCreate$","itemCreate$","inferItemUpdate$","tileItemUpdate$","itemUpdate$","inferItemDelete$","tileItemDelete$","itemDelete$","inferItemUpdateResult$","currentItem","inferItemDeleteResult$","EditorComponent","aside","settings","viewHit","initState","delay","onRemoteControlRequest","onToggleAside","dispatchEvent","Event","onToggleSettings","onViewHit","onViewHitted","viewHitSubscription","onDragEnd","onResizeEnd","onWorldSelect","selectedItem","showPanel","onOpenModal","onAsideSelect","currentTile","onAsideUpdate","onUpdateAsset","onAsideDelete","MENU_UID","MenuService","menu$","getMenu$","menu$_","updateMenu$","createMenuItem$","parentId","updateMenuItem$","deleteMenuItem$","getModelMenu$","mapMenuItems","hidden","typeName","mapMenuItem","active","active$","DropService","drop$","isPlatformBrowser","dataTransfer","EMPTY","change$","asset$","previews","uploads$","read$","reader","FileReader","reader$","blob","result","resize$","resized","readAsDataURL","resize_","img","onload","canvas","ctx","drawImage","toDataURL","onerror","ControlComponent","ControlAssetComponent","_ControlComponent","accept","ControlMenuComponent","_ControlAssetComponen","itemToFormGroup","FormArray","dropdownId","onAddItem","onRemoveItem","onRemoveControl","onLinkItem","onLinkControl","onItemUp","up","onItemDown","down","onUpControl","insert","onDownControl","setView","switchSubjects_","onTextDidChange","hasOption","onDropped","MenuBuilderComponent","menuToControls","controlsToMenu","subitems","pushItem","menuItem","CurvedPlaneModalComponent","Object3D","copy","lookAt","ORIGIN","multiplyScalar","toArray","rotation","radius","arc","ItemModelModalComponent","ModelModalComponent","values","zoom","NavModalComponent","PanoramaGridModalComponent","PanoramaModalComponent","PlaneModalComponent","RemoveModalComponent","onRemove","onCancel","UpdateViewItemComponent","originalItem","hasChromaKeyColor","chromaKeyColor","assetType","doUpdateForm","doUpdateItem","getAssetDidChange","itemHasChromaKeyColor","changesHasChromaKeyColor","removeKey","optional","onAssetTypeDidChange","currentType","getTitle","UpdateViewTileComponent","UpdateViewComponent","doUpdateView","orbit$","auditTime","didChange","usdzDidChange","usdz","gltfDidChange","gltf","factories","pipes","EditorModule","_Module","Module","imports","declarations","FlagPipe","UploadItem","progress","uploading","paused","complete","UploadEvent","UploadStartEvent","_UploadEvent","UploadCompleteEvent","_UploadEvent2","UploadAssetEvent","_UploadEvent3","UploadService","concurrent$","items$","uploadItems","uploadItem$","delayWhen","addItems","newItems","removeAll","dropArea","files$","file$","uploadFile$","resize","ControlAssetsComponent","multiple","hasFiles","service","onUpload","onItemPause","onItemResume","onItemCancel","onItemRemove","items_","uploadCount","completed","ControlCheckboxComponent","KeyboardService","keydown$","keydown$_","keyup$","keyup$_","keys$","keys$_","startWith","key$","key$_","regexp","typing$","typing$_","to","clearTimeout","ControlCustomSelectComponent","word","scrollToWord","children","scrollTo","offsetTop","setOption","isMultiple","Error","_readOnlyError","v","ControlLinkComponent","onInputDidBlur","ControlLocalizedAssetComponent","currentLanguage","setLanguage","locale","localizedAsset","ControlModelComponent","ControlNumberComponent","precision","increment","updateValue","ControlPasswordComponent","ControlSelectComponent","ControlTextComponent","ControlTextareaComponent","ControlVectorComponent","DisabledDirective","ErrorsComponent","InputValueComponent","increment$","parseFloat","NaN","sign","m","race","toFixed","setValue","TestComponent","onTest","onReset","ValueDirective","HtmlPipe","n","String","fromCharCode","unescapes","rx","IdDirective","LayoutComponent","UID","ImageServiceEvent","ImageService","worker_","Worker","isBlob","isCors","postMessage","Blob","takeWhile","IntersectionService","observer_","readySubject_","observerSubject_","IntersectionObserver","entries","intersection$","observe","entry","isIntersecting","unobserve","LazyCache","cache_","LazyDirective","input$","lazy$","lazy","ModalComponent","SlugPipe","SvgIconStructure","_Structure","name_","_element$classList","createElementNS","h","setAttributeNS","rxcompId","replaceChild","Structure","TryInARComponent","missingAr","missingUsdz","missingGltf","getViewId","usdzSrc","getUsdzSrc","getGltfSrc","modelViewerNode","getModelViewerNode","gltfSrc","UploadItemComponent","onPause","pause","onResume","resume","HlsDirective","isSupported","hls_","VirtualItem","$key","$value","count","_Context","even","Context","VirtualMode","VirtualStructure","tokens","getExpressionTokens","virtualFunction","iterable","gutter","reverse","containerWidth","containerHeight","cols","cachedRects","cachedInstances","cacheNodes","update$","visibleItems","updateView","scroll$","updateForward","total","highestHeight","getWidth","getGutter","len","col","bottom","rect","getCol","getHeight","intersect","getLeft","cachedNode","offsetHeight","removeNode","removeIndex","parentContainer","diff","getCols","updateNode","createNode","clonedNode","cloneNode","instance","makeInstance","forItemContext","top1","bottom1","top2","bottom2","getComputedStyle","overflowY","getBoundingClientRect","trim","expressions","virtualExpressions","keyValueMatches","indexExpressions","LOADER_UID","LoaderService","switchLoaders","progress$","getRef","ref","loaded","setProgress","switchAll","subject","round","EnvMapLoader","load","loadPublisherStreamBackground","loadVideoBackground","loadHlslVideoBackground","loadRgbeBackground","loadBackgroundImageService","loadBackground","pmremGenerator","PMREMGenerator","compileEquirectangularShader","progressRef","loader","TextureLoader","setPath","envMap","fromEquirectangular","request","revokeObjectURL","RGBELoader","setDataType","UnsignedByteType","VideoTexture","minFilter","LinearFilter","magFilter","mapping","UVMapping","RGBFormat","needsUpdate","cubeRenderTarget","WebGLCubeRenderTarget","generateMipmaps","fromEquirectangularTexture","onPlaying","HAVE_FUTURE_DATA","onPublisherStreamId","muted","loop","playsInline","muted_","cubeRenderTarget_","texture_","FreezableMesh","geometry","material","BoxBufferGeometry","MeshBasicMaterial","color","_THREE$Mesh","freezed","freezed_","__lookupGetter__","freeze","unfreeze","Mesh","EmittableMesh","_FreezableMesh","Interactive","hittest","raycaster","dirty","lock","hit","intersections","intersectObjects","hash","intersection","uuid","lastIntersectedObject","point","over","depthTest","InteractiveMesh","_EmittableMesh","over_","down_","wrapS","wrapT","anisotropy","isVideoTexture","HAVE_CURRENT_DATA","subscription","tween","SphereBufferGeometry","rotateY","PI","ShaderMaterial","depthWrite","vertexShader","fragmentShader","uniforms","rgbe","mesh","onexit","crossfade","currentAsset","loadVideo","setVideo","Rect","right","intersectRect","r1","r2","fromNode","rect_","getClientRects","boundingRect","setCenter","setSize","center","intersection_","offset","scroll","COLORS","AvatarElement","WebGLRenderer","antialias","alpha","premultipliedAlpha","setClearColor","setPixelRatio","devicePixelRatio","toneMapping","ACESFilmicToneMapping","toneMappingExposure","outputEncoding","sRGBEncoding","domElement","PerspectiveCamera","Scene","light","PointLight","head","addHead","headGeometry_","headGeometry","CanvasTexture","MeshStandardMaterial","chalk","render","tick_","vol","sin","smile","cos","fillStyle","fillRect","beginPath","closePath","moveTo","bezierCurveTo","Camera","fov","aspect","near","far","dolly","_THREE$PerspectiveCam","box","Group","MediaLoaderEvent","MediaLoaderPlayEvent","_MediaLoaderEvent","MediaLoaderPauseEvent","_MediaLoaderEvent2","MediaLoader","toggle","getLoader","loadTexture","isPublisherStream","isAttendeeStream","isSmartDeviceStream","isPublisherScreen","isAttendeeScreen","autoplay","onCanPlay","preload","RepeatWrapping","silent","upEvent","VERTEX_SHADER","FRAGMENT_CHROMA_KEY_SHADER","MediaMesh","getMaterialByItem","_InteractiveMesh","getUniformsByItem","mediaLoader","getMaterial","useChromaKey","transparent","textureA","textureB","resolutionA","resolutionB","overlayColor","Color","overlay","getChromaKeyMaterial","side","DoubleSide","getTypeMatcher","matcher","getStreamId$","matchType","onAppear","videoWidth","videoHeight","isPlayableVideo","createTextureB","onOver","onOut","onToggle","aw","ah","imageSmoothingEnabled","imageSmoothingQuality","br","linkedPlayId","gsap","ease","Power2","easeInOut","onDisappear","playing","overwrite","setPlayingState","updateByItem","disposeMaterial","disposeMediaLoader","disposable","DragPoint","DragEvent","DragDownEvent","_DragEvent","distance","strength","speed","DragMoveEvent","_DragEvent2","DragUpEvent","_DragEvent3","DragService","getPosition","MouseEvent","clientX","clientY","TouchEvent","touches","pageX","pageY","down$","downEvent","button","originalEvent","move$","dismiss$","moveEvent","innerWidth","innerHeight","dismissEvent","stopImmediatePropagation","up$","observe$","OrbitMode","OrbitEvent","OrbitDragEvent","_OrbitEvent","OrbitResizeEvent","_OrbitEvent2","OrbitMoveEvent","_OrbitEvent3","orbitMoveEvent","orbitDragEvent","orbitResizeEvent","OrbitService","mode_","dolly_","zoom_","direction","inertia","Euler","updatePosition","updateTarget","setLongitudeLatitude","getDollyValue","getZoomValue","clampedDolly","clamp","setOrientation","getOrientation","phi","degToRad","theta","Shift","Control","flip","MathUtils","updateProjectionMatrix","walk","heading","normalize","headingTheta","atan2","headingLongitude","radToDeg","differenceLongitude","differenceLatitude","walkComplete","headingLatitude","object3d","acos","setVRCamera","applyQuaternion","R","PhoneStreamElement","setRemote","r","sx","sy","ceil","addStreamTexture","PlaneBufferGeometry","PhoneElement","phone","PointerElement","setPosition","Gamepad","gamepad","buttons","updateButtons","updateAxes","pressed","GamepadButton","axis","GamepadAxis","feedback","actuators","hapticActuators","pulse","_THREE$Vector","Constants","Handedness","LEFT","RIGHT","ComponentState","DEFAULT","TOUCHED","PRESSED","ComponentProperty","BUTTON","X_AXIS","Y_AXIS","STATE","ComponentType","TRIGGER","SQUEEZE","TOUCHPAD","THUMBSTICK","ButtonTouchThreshold","AxisTouchThreshold","VisualResponseProperty","TRANSFORM","VISIBILITY","fetchJsonFile","_fetchJsonFile","regeneratorRuntime","mark","_callee","wrap","_context","prev","sent","abrupt","fetchProfilesList","_fetchProfilesList","_callee2","basePath","profilesList","_context2","_fetchProfile","_callee3","xrInputSource","defaultProfile","getAssetPath","supportedProfilesList","supportedProfile","assetPath","layout","_context3","profiles","some","profileId","profilePath","deprecated","handedness","layouts","defaultComponentValues","xAxis","yAxis","VisualResponse","visualResponseDescription","componentProperty","states","valueNodeName","valueNodeProperty","minNodeName","maxNodeName","updateFromComponent","_normalizeAxes","normalizedXAxis","normalizedYAxis","normalizeAxes","includes","componentId","componentDescription","visualResponses","gamepadIndices","rootNodeName","touchPointNodeName","responseName","visualResponse","updateFromGamepad","gamepadButton","getOwnPropertyDescriptors","defineProperties","_objectSpread2","MotionController","assetUrl","layoutDescription","component","gripSpace","targetRaySpace","XRControllerModel","motionController","addAssetSceneToControllerModel","controllerModel","MotionControllerConstants","touchPointNode","getObjectByName","sphereGeometry","sphere","minNode","maxNode","valueNode","findNodes","traverse","child","isMesh","setEnvironmentMap","updateMatrixWorld","force","visible","slerp","lerpVectors","XRControllerModelFactory","gltfLoader","_assetCache","GLTFLoader","createControllerModel","controller","targetRayMode","fetchProfile","cachedAsset","WorldComponent","error_","waiting","avatars","createScene","animate","orbit","setAnimationLoop","mouse","controllerMatrix_","Matrix4","controllerWorldPosition_","controllerWorldDirection_","cameraGroup","worldRect","cameraRect","offsetWidth","logarithmicDepthBuffer","enabled","insertBefore","Raycaster","setFromCamera","objects","indicator","mainLight","light2","DirectionalLight","light3","AmbientLight","addControllers","addOffCanvasScene","avatar","removeOffCanvasScene","updateOffCanvasScene","view_","requestInfoResult","ready","onViewAssetDidChange","setViewOrientation","isPresenting","controllerGroup","controllers","controllerModelFactory","addController","showPhone","getController","onPress","onRelease","onModelUp","onLeft","onRight","onAxis","onModelDistance","userData","isSelecting","setController","buildController","controllerGrip","getControllerGrip","BufferGeometry","Float32BufferAttribute","LineBasicMaterial","vertexColors","blending","AdditiveBlending","Line","RingBufferGeometry","translate","onModelDown","tempTarget","tempParent","parent","localToWorld","worldToLocal","distanceTo","onTween","updateRaycasterXR","identity","extractRotation","ray","setFromMatrixPosition","applyMatrix4","raycasterHitTest","dragItem","resizeItem","repos","tx","ty","delta","time","tick","raycasterXRHitTest","ticker","angle","tan","updateRaycasterMouse","w2","h2","onMouseDown","raycasterDesktopHitTest","lockedOrXR","onDragMove","onResizeMove","controlEvent$","onMouseMove","onMouseUp","dragEnd","resizeEnd","onMouseWheel","deltaY","wheelDeltaY","Power4","easeOut","onOrientationDidChange","onVRStarted","onVREnded","onVRStateDidChange","onMenuNav","navTo","onMenuToggle","onNavOver","shouldShowPanel","itemId","onNavOut","onNavDown","onObjectDown","onPlayMedia","onPanelDown","onGridMove","onGridNav","control$","setSession","removeMenu","showPointer","GEOMETRY","ModelComponent","getName","getContainer","onCreate","onMount","onDismount","disposeObject","mounth","dismount","roughness","metalness","flatShading","isInteractiveMesh","isInteractiveSprite","isSprite","calculateScaleAndPosition","getScroll","getTween","PANEL_RADIUS","PANORAMA_RADIUS","ModelBannerComponent","_ModelComponent","createBanner","getCanvasTexture","wrapY","repeat","encoding","CylinderBufferGeometry","banners","updateBanner","mount","W","H","F","L","font","measureText","clearRect","textAlign","textBaseline","strokeStyle","lineWidth","lineJoin","miterLimit","strokeText","fillText","title_","ModelEditableComponent","RADIUS","editing","setHelper","showHelper","helper","BoxHelper","updateHelper","setFromObject","editing_","ModelCurvedPlaneComponent","_ModelEditableCompone","getCurvedPanelGeometry","fromArray","radius_","height_","arc_","take","textures","DebugService","setMessage","ModelDebugComponent","FontLoader","getFontLoader","fontLoader","textGroup","debugService","createText","loadFont","message_","setText","getCamera","getWorldDirection","ModelGridComponent","getTexture","getOverTexture","textureOver","getCoords","outerTileSize","row","dx","COLS","dy","ROWS","ci","ri","moveToIndex","addTiles","innerTileSize","rotateX","mapOver","tileMap","showTiles","ix","iy","addHitArea","onGroundOver","onGroundMove","onGroundDown","onGroundOut","ground","coords","move","coords_","previousTile","previousUniforms","currentUniforms","MenuButton","getTextureA","getTextureB","getX","getY","getGrid","G","rows","geometry_","ModelMenuComponent","FRAGMENT_SHADER","BackButton","_MenuButton","_proto3","onDown","buildMenu","groups","menuGroup","addMenu","back","backItem","stagger","grid","amount","removeButtons","removeToggler","addToggler","toggler","loading_","ModelModelComponent","loadGlb","animations","onGlbLoaded","decoderPath","dracoLoader","DRACOLoader","setDecoderPath","setDRACOLoader","glb","progressEvent","parseAnimations","actionIndex","actions","clock","Clock","mixer","AnimationMixer","timeScale","animation","clipAction","setEffectiveTimeScale","setEffectiveWeight","setLoop","LoopRepeat","onClipToggle","halt","dummy","Box3","sub","getCenter","endY","makeInteractive","getDelta","getInteractiveDescriptors","descriptors","interactiveDescriptors","freezableDescriptors","emittableDescriptors","NavModeType","ModelNavComponent","getNavGeometry","navGeometry","getTexturePoint","texturePoint","getTextureMove","textureMove","getTextureInfo","textureInfo","getTitleTexture","getNavMode","isValidText","onCreateSprites","icon","materials","onRemoveSprite","titleMaterial","SpriteMaterial","sizeAttenuation","Sprite","titleTexture","sprite","_THREE$Vector2","InteractiveSprite","_EmittableSprite","EmittableSprite","_FreezableSprite","FreezableSprite","_THREE$Sprite","ModelPanelComponent","viewed","xy","uv","querySelectorAll","offsetLeft","movementX","movementY","relatedTarget","screenX","screenY","imagesLoaded","promises","cors","onLoad","panelTexture","results","useCORS","backgroundColor","ModelPictureComponent","ModelPlaneComponent","LOADING_BANNER","WAITING_BANNER","ModelProgressComponent","visible_","createMesh","show","hide","updateProgress","ModelRoomComponent","loadModel","modelFolder","modelFile","FBXLoader","setHex","radians","lengthComputable","ModelTextComponent","AppModule","CoreModule","FormModule","bootstrap","Browser"],"mappings":";;;;;CAMC,SAASA,EAAEC,GAAoB,iBAAVC,SAAoC,oBAATC,OAAqBF,EAAEG,QAAQ,UAAUA,QAAQ,eAAeA,QAAQ,kBAAkBA,QAAQ,QAAQA,QAAQ,SAASA,QAAQ,gBAAgC,mBAATC,QAAqBA,OAAOC,IAAID,OAAO,CAAC,SAAS,cAAc,iBAAiB,OAAO,QAAQ,eAAeJ,GAAyDA,GAArDD,EAAsB,oBAAbO,WAAyBA,WAAWP,GAAGQ,MAASC,OAAOT,EAAES,OAAOC,KAAKV,EAAEW,KAAKC,UAAUZ,EAAEW,KAAKX,EAAEa,MAAMb,EAAEc,aAA7a,CAA6bC,MAAK,SAAUN,EAAQO,EAAYJ,EAAWD,EAAMM,EAAOH,GAAa,aAAqI,SAASI,EAAmBC,EAAKC,EAASC,EAAQC,EAAOC,EAAQC,EAAKC,GAC9sB,IACE,IAAIC,EAAOP,EAAIK,GAAKC,GAChBE,EAAQD,EAAKC,MACjB,MAAOC,GAEP,YADAP,EAAOO,GAILF,EAAKG,KACPT,EAAQO,GAERG,QAAQV,QAAQO,GAAOI,KAAKT,EAAOC,GAIvC,SAASS,EAAkBC,GACzB,OAAO,WACL,IAAIzB,EAAOO,KACPmB,EAAOC,UACX,OAAO,IAAIL,SAAQ,SAAUV,EAASC,GACpC,IAAIF,EAAMc,EAAGG,MAAM5B,EAAM0B,GAEzB,SAASZ,EAAMK,GACbT,EAAmBC,EAAKC,EAASC,EAAQC,EAAOC,EAAQ,OAAQI,GAGlE,SAASJ,EAAOc,GACdnB,EAAmBC,EAAKC,EAASC,EAAQC,EAAOC,EAAQ,QAASc,GAGnEf,OAAMgB,OAKZ,SAASC,EAAkBC,EAAQC,GACjC,IAAK,IAAIC,EAAI,EAAGA,EAAID,EAAME,OAAQD,IAAK,CACrC,IAAIE,EAAaH,EAAMC,GACvBE,EAAWC,WAAaD,EAAWC,aAAc,EACjDD,EAAWE,cAAe,EACtB,UAAWF,IAAYA,EAAWG,UAAW,GACjDC,OAAOC,eAAeT,EAAQI,EAAWpB,IAAKoB,IAIlD,SAASM,EAAaC,EAAaC,EAAYC,GAG7C,OAFID,GAAYb,EAAkBY,EAAYG,UAAWF,GACrDC,GAAad,EAAkBY,EAAaE,GACzCF,EAGT,SAASI,EAAgBC,EAAKhC,EAAKG,GAYjC,OAXIH,KAAOgC,EACTR,OAAOC,eAAeO,EAAKhC,EAAK,CAC9BG,MAAOA,EACPkB,YAAY,EACZC,cAAc,EACdC,UAAU,IAGZS,EAAIhC,GAAOG,EAGN6B,EAGT,SAASC,EAAQC,EAAQC,GACvB,IAAIC,EAAOZ,OAAOY,KAAKF,GAEvB,GAAIV,OAAOa,sBAAuB,CAChC,IAAIC,EAAUd,OAAOa,sBAAsBH,GACvCC,IAAgBG,EAAUA,EAAQC,QAAO,SAAUC,GACrD,OAAOhB,OAAOiB,yBAAyBP,EAAQM,GAAKnB,eAEtDe,EAAKM,KAAK9B,MAAMwB,EAAME,GAGxB,OAAOF,EAuBT,SAASO,EAAeC,EAAUC,GAChCD,EAASd,UAAYN,OAAOsB,OAAOD,EAAWf,WAC9Cc,EAASd,UAAUiB,YAAcH,EACjCA,EAASI,UAAYH,EAGvB,SAASI,EAAuBjE,GAC9B,QAAa,IAATA,EACF,MAAM,IAAIkE,eAAe,6DAG3B,OAAOlE,EAhHygBM,EAAYA,GAAakC,OAAOM,UAAUqB,eAAeC,KAAK9D,EAAY,WAAWA,EAAqB,QAAEA,ECLvnB,ICAM+D,EAAb,WAAA,SAAAA,KAAA,OAAAA,EAEQC,MAAP,SAAatC,EAAQuC,GAAQ,IAAAC,EAAAjE,KAW5B,MAVsB,iBAAXgE,GACV/B,OAAOY,KAAKmB,GAAQE,SAAQ,SAAAzD,GAC3B,IAAMG,EAAQoD,EAAOvD,GACA,iBAAVG,GAAuBuD,MAAMC,QAAQxD,GAG/Ca,EAAOhB,GAAOG,EAFda,EAAOhB,GAAOwD,EAAKF,MAAMtC,EAAOhB,GAAMG,MAMlCa,GAbTqC,EAAA,GCGaO,EAA0B,oBAAXjF,QAA0BA,OAAOD,QAEhDmF,EAAyC,OADhCD,EAAO,CAAEE,IAAK,cAAc,IAAIC,gBAAgBC,OAAOC,SAASC,SAChDJ,IAAI,SAC7BK,EAAYP,EAAO,KAAOQ,SAASC,cAAc,QAAQC,aAAa,QACtEC,GAASX,IAAgBI,SAAyD,IAA/CA,OAAOC,SAASO,KAAKC,QAAQ,cAChEC,GAASd,IAAgBW,GAAWP,SAAoC,UAAzBA,OAAOC,SAASU,MAA6C,SAAzBX,OAAOC,SAASU,MAA4C,SAAzBX,OAAOC,SAASU,MAA4C,uBAAzBX,OAAOC,SAASO,OACzKI,GAAchB,IAAgBI,SAAiG,IAAvF,CAAC,YAAa,YAAa,WAAWS,QAAQT,OAAOC,SAASO,KAAKK,MAAM,KAAK,KAEtHC,EAAM,CAClBJ,OAAAA,EACAE,YAAAA,EACAG,YAJ0BH,GAOdI,EAAb,WAAA,IAAAC,EAAAD,EAAAlD,UAmCC,SAAAkD,EAAYE,GACX,GAAIA,EAAS,CACZ,GAA2B,iBAAhBA,EAAQC,IAAkB,CACpC,IAAMC,EAAWF,EAAQE,UAAY,GAC/BC,EAASH,EAAQG,QAAU,GACjC7D,OAAOY,KAAK8C,EAAQC,KAAK1B,SAAQ,SAAAzD,GAChCkF,EAAQC,IAAInF,GAAOoF,EAAWC,EAASH,EAAQC,IAAInF,MAGrDwB,OAAO8D,OAAO/F,KAAM2F,IA5CvB,OAAAD,EAkBCM,eAAA,SAAeC,EAAMC,GACpB,IAAIN,EAAG,GAAMnB,OAAOC,SAASyB,OAASF,EAKtC,OAHAhE,OAAOY,KAAKqD,GAAQhC,SAAQ,SAAAzD,GAC3BmF,EAAMA,EAAIQ,QAAJ,IAAgB3F,EAAOyF,EAAOzF,OAE9BmF,GAxBTF,EA2BCW,QAAA,SAAQJ,GACP,OAAOjG,KAAKsG,QAAQL,GAASjG,KAAKuG,KAAON,EAAQA,GA5BnDP,EA+BCY,QAAA,SAAQL,GACP,OAAgC,IAAzBA,EAAKf,QAAQ,QAhCtB/C,EAAAsD,EAAA,CAAA,CAAAhF,IAAA,SAAA8D,IAAA,WAGE,OAAOgB,EAAIJ,QAHbqB,IAAA,SAKYrB,GACVI,EAAIJ,QAAqB,IAAXA,GAA8B,SAAXA,EACjCsB,QAAQC,IAAI,yBAA0BnB,EAAIJ,UAP5C,CAAA1E,IAAA,OAAA8D,IAAA,WAWE,OAAIS,EACIhF,KAAK2G,WAEL/B,MAdVa,EAAA,GAgFMmB,EAAoB,CACzBC,YAAa,QACbC,MAAO,CACNC,YAAY,EACZC,UAAU,EACVC,UAAU,EACVC,aAAa,EACbC,mBAAmB,EACnBC,QAAQ,EACRC,IAAI,EACJC,MAAM,EACNC,UAAU,EACVC,UAAU,EACVC,QAAQ,EACRC,aAAa,EACbC,YAAY,EACZC,OAAQ5C,IAIJ6C,EAAqBpD,OAAOU,OCrHD,CAChC2C,OAAQ,mCACRjB,YAAa,QACbC,MAAO,CACNC,YAAY,EACZC,UAAU,EACVC,UAAU,EACVC,aAAa,EACbC,mBAAmB,EACnBC,QAAQ,EACRW,mBAAmB,EACnBV,IAAI,EACJC,MAAM,EACNU,MAAM,EACNT,UAAU,EACVC,UAAU,EACVC,QAAQ,EACRC,aAAa,EACbC,YAAY,GAEbM,KAAM,KACNC,WAAY,CACXC,MAAO,6BACPC,MAAO,8BAERC,OAAQ,CACPC,eAAgB,UAChBC,eAAgB,UAChBC,mBAAoB,UACpBC,mBAAoB,UACpBC,mBAAoB,UACpBC,mBAAoB,UACpBC,uBAAwB,UACxBC,uBAAwB,WAEzBzB,OAAQ,CACP0B,kBAAmB,CAAC,eAAgB,WACpCC,sBAAuB,CAAC,YAEzBC,OAAQ,WACRC,OAAQ,uCACRtC,WAAY,oEACZd,SAAU,GACVC,OAAQ,GACRF,IAAK,CACJsD,MAAO,IACPC,OAAQ,IACR/B,OAAQ,UACRgC,gBAAiB,qBACjBC,WAAY,eACZC,WAAY,gBAEbC,SAAU,CACTC,QAAS,iCACTC,MAAO,CACNC,eAAgB,8BAChBF,QAAS,wBACTG,KAAM,CACLC,SAAY,uBACZC,gBAAiB,4BACjBC,UAAW,sBACXC,MAAS,qBAEVC,SAAU,CACTC,IAAO,kBACPC,MAAS,oBACTC,eAAgB,2BAChBC,QAAW,sBACXL,MAAS,0BAEVM,OAAQ,uBAGVC,UAAW,CAAC,MACZC,gBAAiB,MH1Ee,CAChCzC,OAAQ,mCACRjB,YAAa,QACbC,MAAO,CACNC,YAAY,EACZC,UAAU,EACVC,UAAU,EACVC,aAAa,EACbC,mBAAmB,EACnBC,QAAQ,EACRW,mBAAmB,EACnBV,IAAI,EACJC,MAAM,EACNU,MAAM,EACNT,UAAU,EACVC,UAAU,EACVC,QAAQ,EACRC,aAAa,EACbC,YAAY,GAEbM,KAAM,KACNC,WAAY,CACXC,MAAO,iDACPC,MAAO,kDAERC,OAAQ,CACPC,eAAgB,UAChBC,eAAgB,UAChBC,mBAAoB,UACpBC,mBAAoB,UACpBC,mBAAoB,UACpBC,mBAAoB,UACpBC,uBAAwB,UACxBC,uBAAwB,WAEzBzB,OAAQ,CACP0B,kBAAmB,CAAC,eAAgB,WACpCC,sBAAuB,CAAC,YAEzBC,OAAQ,+BACRC,OAAQ,iEACRtC,WAAY,oEACZd,SAAU,MACVC,OAAQ,MACRF,IAAK,CACJsD,MAAO,IACPC,OAAQ,IACR/B,OAAQ,UACRgC,gBAAiB,qBACjBC,WAAY,eACZC,WAAY,gBAEbC,SAAU,CACTC,QAAS,2DACTC,MAAO,CACNC,eAAgB,wDAChBF,QAAS,kDACTG,KAAM,CACLC,SAAY,iDACZC,gBAAiB,sDACjBC,UAAW,gDACXC,MAAS,+CAEVC,SAAU,CACTC,IAAO,4CACPC,MAAS,8CACTC,eAAgB,qDAChBC,QAAW,gDACXL,MAAS,oDAEVM,OAAQ,iDAGVC,UAAW,CAAC,MACZC,gBAAiB,ME6Cd5E,EAAU1D,OAAO8D,OArDE,CACtBX,KAAM,IACNoF,WAAY,0BACZnC,OAAQ,CACPC,eAAgB,UAChBC,eAAgB,UAChBC,mBAAoB,UACpBC,mBAAoB,UACpBC,mBAAoB,UACpBC,mBAAoB,UACpBC,uBAAwB,UACxBC,uBAAwB,WAEzBzB,OAAQ,CACP0B,kBAAmB,CAAC,eAAgB,WACpCC,sBAAuB,CAAC,YAEzB0B,YAAa,CACZb,SAAU,EACVG,MAAO,GACPG,MAAO,GACPQ,KAAM,GACNC,OAAQ,GACRV,IAAK,GACLW,MAAO,GACPtD,KAAM,GACNuD,MAAO,GACPC,QAAS,KA0BiClE,EAAmBiB,GAGlDkD,EAAc,IAAItF,EAF/BE,EAAU7B,EAAMC,MAAM4B,EAASlB,OAAOuG,QAItCvE,QAAQC,IAAI,cAAeqE,GAA3B,IEvGAE,ECtBqBC,EAAAA,WNsanB,SAASA,KA2ET,OAzEAA,EMtaMC,IAAP,SAAW1K,GAGV,OAFe,IAAI+D,gBAAgBC,OAAOC,SAASC,QAErCwG,IAAI1K,INyalByK,EMtaM3G,IAAP,SAAW9D,GAGV,OAFe,IAAI+D,gBAAgBC,OAAOC,SAASC,QAErCJ,IAAI9D,INyalByK,EMtaM1E,IAAP,SAAW4E,EAAYxK,GACtB,IAAMsF,EAAS,IAAI1B,gBAAgBC,OAAOC,SAASC,QACzB,iBAAfyG,EACVlF,EAAOM,IAAI4E,EAAYxK,GAEvBsF,EAAOM,IAAI4E,EAAY,IAExBpL,KAAKoG,QAAQF,IN2abgF,EMvaM9E,QAAP,SAAeF,GACd,GAAIzB,OAAO4G,SAAW5G,OAAO4G,QAAQC,UAAW,CAC/C,IAAMC,EAAQ1G,SAAS0G,MACjB3F,EAASnB,OAAOC,SAAS6B,KAAKjB,MAAM,KAAK,GAAtC,IAA4CY,EAAOsF,WAC5D/G,OAAO4G,QAAQC,UAAUpF,EAAOsF,WAAYD,EAAO3F,KN2apDsF,EMvaMO,YAAP,SAAmBhL,GAClB,IAAMiL,EAAU1L,KAAKuE,IAAI,UACzB,OAAOvE,KAAK2L,OAAOlL,EAAKiL,IN0axBR,EMvaMU,UAAP,SAAiBR,EAAYxK,GAC5B,IAAMsF,EAASlG,KAAKyL,cACdC,EAAU1L,KAAK6L,OAAOT,EAAYxK,EAAOsF,GAC/ClG,KAAKwG,IAAI,SAAUkF,IN0anBR,EMvaMS,OAAP,SAAclL,EAAKiL,GAClB,IAAII,EAAU,KACd,GAAIJ,EAAS,CACZ,IAAMK,EAAOtH,OAAOuH,KAAKN,GACzBI,EAAUG,KAAKC,MAAMH,GAKtB,OAHItL,GAAOqL,IACVA,EAAUA,EAAQrL,IAEZqL,GAAW,MN6alBZ,EM1aMW,OAAP,SAAcT,EAAYxK,EAAOsF,GAChCA,EAASA,GAAU,GAEO,iBAAfkF,EACVlF,EAAOkF,GAAcxK,EAErBsF,EAASkF,EAEV,IAAMW,EAAOE,KAAKE,UAAUjG,GAE5B,OADUzB,OAAO2H,KAAKL,INgbfb,EMjfYA,GDIAmB,EAAAA,SAAAA,GLifnB,SAASA,IACP,OAAOC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAyB9C,OA5BAoD,EAAeiJ,EAAqBC,GAMvBD,EAAoB9J,UKnflCgK,OAAA,WACCvM,KAAKwM,IAAMzB,EACX,IAAM0B,EAAOvB,EAAgB3G,IAAI,QAC5BkI,IACJhI,OAAOC,SAAS6B,KAAhB,GAA0B9B,OAAOC,SAASyB,OAAS4E,EAAYnF,IAAIyD,YAEpE,IAAMzD,EAAG,GAAMnB,OAAOC,SAASyB,OAAS4E,EAAYnF,IAAIyD,WAA/C,SAAkEoD,EACnEC,EAASC,EAAAA,WAAW3M,MAApB0M,KACO,IAAIE,OAAO,CACzBC,QAASH,EAAK5H,cAAc,WAC5BlE,MAAOgF,EACPkH,KAAM,OL8fAT,EK3gBYA,CAA4BU,EAAAA,WAkBjDV,EAAoBW,KAAO,CAC1BC,SAAU,2BEpBJ,IAAMC,EAASpJ,EAAMC,QAANkH,EAAA,CACrBkC,OAAQ,SACRC,OAAQ,SACRC,qBAAsB,iCACtBC,YAAa,gBACbC,YAAa,sBACbC,eAAgB,oBAChBC,QAAS,UACTpD,OAAQ,SACRqD,SAAU,WACVC,OAAQ,SACRC,YAAa,mBACbC,OAAQ,SACRC,OAAQ,SACRC,aAAc,eAEdC,aAAc,QACdC,aAAc,QACdC,aAAc,QACdC,wBAAyB,mBACzBC,4BAA6B,uBAC7BC,oBAAqB,eACrBC,gBAAiB,WACjBC,qBAAsB,gBACtBC,eAAgB,YAxBK,aAyBP,QAzBOvD,EA0BrBwD,WAAY,cA1BSxD,EA2BrByD,YAAa,aA3BQzD,EA4BrB0D,aAAc,QA5BO1D,EA6BrB2D,oBAAqB,eA7BA3D,EA8BrB4D,eAAgB,UA9BK5D,GA+BnBxG,OAAOqK,QAEWC,EAAAA,SAAAA,GP8gBnB,SAASA,IACP,OAAOC,EAAM3N,MAAMrB,KAAMoB,YAAcpB,KAkBzC,OArBAoD,EAAe2L,EAAWC,GAM1BD,EOhhBME,UAAP,SAAiBxO,GAEhB,OADeyM,EACDzM,IAAP,IAAmBA,EAAnB,KPmhBPsO,EOhhBMG,QAAP,WAAwB,IAAA,IAAAC,EAAA/N,UAAAQ,OAANiB,EAAM,IAAAsB,MAAAgL,GAAAC,EAAA,EAAAA,EAAAD,EAAAC,IAANvM,EAAMuM,GAAAhO,UAAAgO,GACvB,OAAOpP,KAAKiP,UAAUpM,EAAKwM,KAAI,SAAAC,GAAC,OAAIA,EAAElJ,QAAQ,IAAI,QAAMmJ,KAAK,OPyhBtDR,EOjiBYA,CAAkBS,EAAAA,MAYvCT,EAAU/B,KAAO,CAChByC,KAAM,SADP,IC5CqBC,EAAAA,SAAAA,GRwkBnB,SAASA,IACP,OAAOpD,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAwB9C,OA3BAoD,EAAesM,EAAmBpD,GAMrBoD,EAAkBnN,UQ/jBhCoN,WAAA,SAAWF,GACV,OAAOzP,KAAK4P,MAAMrL,IAAIkL,IRokBtBtN,EAAauN,EAAmB,CAAC,CAC/BjP,IAAK,QACL8D,IAAK,WQjlBP,GAAIvE,KAAK6P,UACR,OAAO7P,KAAK6P,UAEZ,IAAK7P,KAAKiF,KACT,KAAO,0BAER,OAAOjF,KAAKiF,KAAK6K,YRwlBXJ,EQjmBYA,CAA0B3C,EAAAA,WA4DxC,SAASgD,EAAkBC,GACjC,OAAO,IAAIC,EAAAA,UA3BL,SAA8BD,GAuBpC,OAtBiBA,EAAOE,QAAO,SAACC,EAAGC,EAAGzO,GACrC,IAAM0O,EAAa,GAcnB,GAbID,EAAE1C,UACL2C,EAAWlN,KAAgB,aAAXiN,EAAEE,KAAsBC,EAAAA,WAAWC,wBAA0BD,EAAAA,WAAWE,qBAE1E,UAAXL,EAAEE,MACLD,EAAWlN,KAAKoN,EAAAA,WAAWG,kBAEb,QAAXN,EAAEE,MACLD,EAAWlN,KAAKoN,EAAAA,WAAWI,iBAAiB,sMAE5B,MAAbP,EAAEQ,SACLP,EAAWlN,KAAKoN,EAAAA,WAAWI,iBAAiBP,EAAEQ,UAE/CT,EAAEC,EAAEX,MAAQ,IAAIoB,EAAAA,YAAwB,MAAXT,EAAExP,MAAgBwP,EAAExP,MAAQ,KAAOyP,GACjD,WAAXD,EAAEE,MAAgC,kBAAXF,EAAEE,KAA0B,CACtD,IAAM3K,GAAWyK,EAAEzK,SAAW,IAAImL,QAClCnL,EAAQoL,QAAQ,CAAEC,GAAI,KAAMvB,KAAMV,EAAUE,UAAU,YACtDkB,EAAEC,EAAEX,MAAM9J,QAAUA,EAErB,OAAOwK,IACL,IAKkBc,CAAqBjB,IA3C3CN,EAAkB1C,KAAO,CACxBC,SAAU,aACViE,OAAQ,CAAC,YAAa,UACtBC,MAAO,CAAElM,KAAMmM,EAAAA,iCACf7H,SAAQ,05BAkDR,ICvDoB8H,EAAAA,WT4oBnB,SAASA,KAmJT,OAjJAA,ES5oBMC,MAAP,SAAaC,EAAQ3L,EAAK4L,EAAMC,GAAiB,IAAAxN,EAAAjE,KAE5C0R,EAAY,KAEhB,OAAOC,EAAAA,KAAKC,MAAMhM,EAAK,CACtB2L,OAAQA,EACRM,QAAS,CACRC,OAAU,mBACVC,eAAgB,oBAEjBC,MAAmC,IATpB,CAAC,OAAQ,MAAO,SASjB9M,QAAQqM,GAAiBtF,KAAKE,UAAUqF,QAAQjQ,IAC5DP,MAAK,SAACiR,GACRP,EAAYO,EAEZ,IACC,IACIC,EADEC,EAAcF,EAASJ,QAAQtN,IAAI,gBAOzC,OAJC2N,EADGC,IAA4D,IAA7CA,EAAYjN,QAAQ,oBACtB+M,EAASlG,OAETkG,EAASG,OAEtBH,EAASI,GACLH,EAEAA,EAAclR,MAAK,SAAAwQ,GACzB,OAAOzQ,QAAQT,OAAOkR,MAGvB,MAAM3Q,GACP,OAAIoR,EAASI,IACZ5L,QAAQ6L,KAAK,oBAAqB,yBAC3BvR,QAAQV,WAERU,QAAQT,OAAOO,QAGrB0R,KACHC,EAAAA,YAAW,SAAA3R,GACV,OAAO4R,EAAAA,WAAWxO,EAAKyO,SAAS7R,EAAO6Q,ST0sBzCL,ES9oBMsB,KAAP,SAAY/M,EAAK4L,EAAMC,GACtB,IAAMmB,EAAQ5S,KAAK4S,MAAMpB,GACzB,OAAOxR,KAAKsR,MAAM,MAAX,GAAqB1L,EAAMgN,OAASrR,EAAWkQ,ITipBtDJ,ES9oBMwB,QAAP,SAAejN,GACd,OAAO5F,KAAKsR,MAAM,SAAU1L,ITipB5ByL,ES9oBMyB,MAAP,SAAalN,EAAK4L,GACjB,OAAOxR,KAAKsR,MAAM,OAAQ1L,EAAK4L,ITipB/BH,ES9oBM0B,KAAP,SAAYnN,EAAK4L,GAChB,OAAOxR,KAAKsR,MAAM,MAAO1L,EAAK4L,ITipB9BH,ES9oBM2B,OAAP,SAAcpN,EAAK4L,GAClB,OAAOxR,KAAKsR,MAAM,QAAS1L,EAAK4L,ITipBhCH,ES9oBMuB,MAAP,SAAapB,GACZ,MAAO,ITipBPH,ES9oBMqB,SAAP,SAAgB/P,EAAQsP,GACvB,IAAIpR,EAA0B,iBAAX8B,EAAsBA,EAAS,GAWlD,OAVK9B,EAAMoS,SACVpS,EAAMoS,OAAShB,EAAWA,EAASgB,OAAS,GAExCpS,EAAMqS,aACVrS,EAAMqS,WAAajB,EAAWA,EAASgB,OAAS,GAE5CpS,EAAMsS,gBACVtS,EAAMsS,cAAgBlB,EAAWA,EAASmB,WAAazQ,GAGjD9B,GTqpBAwQ,ES/xBYA,GCpBRgC,EAAW,CACvBC,UAAW,YACXC,SAAU,WACVC,SAAU,WACVC,OAAQ,SACRC,YAAa,eACbC,YAAa,gBAGDC,EACZ,SAAYjO,GACPA,GACH1D,OAAO8D,OAAO/F,KAAM2F,ICRVkO,EAAb,WAAA,SAAAA,KAAA,OAAAA,EAEQC,QAAP,SAAeC,GACd/T,KAAKgU,MAAMC,KAAKF,IAHlBF,EAMQK,IAAP,WAAa,IAAAjQ,EAAAjE,KACZ,OAAOqR,EAAYsB,KAAK,gBAAgBJ,KACvClD,EAAAA,KAAI,SAAC0E,GAAD,OAAU9P,EAAKkQ,QAAQJ,MAC3BvB,EAAAA,YAAW,SAAA3R,GAEV,GAAqB,MAAjBA,EAAMoS,QAAuC,MAArBpS,EAAMqS,WACjC,OAAOkB,EAAAA,GAAG,MAEV,MAAOvT,KAGTwT,EAAAA,WAAU,SAAAN,GAET,OADA9P,EAAK6P,QAAQC,GACN9P,EAAK+P,WAnBhBH,EAwBQS,OAAP,SAAcC,GAAS,IAAAC,EAAAxU,KACtB,OAAOqR,EAAYyB,MAAM,kBAAmByB,GAAShC,KACpDlD,EAAAA,KAAI,SAAC0E,GAAD,OAAUS,EAAKL,QAAQJ,MAC3BU,EAAAA,KAAI,SAACV,GAAD,OAAUS,EAAKV,QAAQC,QA3B9BF,EA+BQa,QAAP,WAAiB,IAAAC,EAAA3U,KAChB,OAAOqR,EAAYsB,KAAK,oBAAoBJ,KAC3ClD,EAAAA,KAAI,SAAC0E,GAAD,OAAUY,EAAKR,QAAQJ,MAC3BU,EAAAA,KAAI,SAACV,GAAD,OAAUY,EAAKb,QAAQ,WAlC9BD,EAsCQe,YAAP,SAAmBL,GAAS,IAAAM,EAAA7U,KAC3B,OAAOqR,EAAYyB,MAAM,wBAAyByB,GAAShC,KAC1DlD,EAAAA,KAAI,SAAC0E,GAAD,OAAUc,EAAKV,QAAQJ,MAC3BU,EAAAA,KAAI,SAACV,GAAD,OAAUc,EAAKf,QAAQC,QAzC9BF,EA6CQiB,iBAAP,SAAwBP,GAAS,IAAAQ,EAAA/U,KAChC,OAAOqR,EAAYyB,MAAM,8BAA+ByB,GAAShC,KAChElD,EAAAA,KAAI,SAAC0E,GAAD,OAAUgB,EAAKZ,QAAQJ,MAC3BU,EAAAA,KAAI,SAACV,GAAD,OAAUgB,EAAKjB,QAAQC,QAhD9BF,EAoDQmB,SAAP,SAAgBT,EAAStB,GACxB,MAAe,UAAXA,EACIjT,KAAKsU,OAAOC,GAEL,gBAAXtB,EACIjT,KAAK4U,YAAYL,GAEV,sBAAXtB,EACIjT,KAAK8U,iBAAiBP,QAD9B,GA3DFV,EAgEQoB,KAAP,SAAYV,GACX,OAAOlD,EAAYyB,MAAM,gBAAiByB,IAjE5CV,EAwFQM,QAAP,SAAeJ,GACd,OAAO,IAAIH,EAAKG,IAzFlBF,EAAA,GA8FAA,EAAYG,MAAQ,IAAIkB,EAAAA,gBAAgB,MAAxC,IC3FqBC,EAAAA,SAAAA,GZ06BnB,SAASA,IACP,OAAO7I,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe+R,EAAiB7I,GAMhC,IAAI5G,EAASyP,EAAgB5S,UA8O7B,OA5OAmD,EY96BD6G,OAAA,WACCvM,KAAKwM,IAAMzB,EACX/K,KAAKoV,MAAQ,CACZnC,OAAQ,WZ27BTvN,EY96BD2P,yBAAA,WACCrV,KAAKsV,kBACLtV,KAAKoV,MAAMnC,OAAS,oBACpBjT,KAAKuV,cACDpQ,IAAmE,IAAzDV,OAAO+Q,UAAUC,UAAUvQ,QAAQ,mBAChDlF,KAAK0V,OACL1V,KAAK2V,aZm7BNjQ,EY/6BDkQ,oBAAA,WACC5V,KAAKsV,kBACLtV,KAAKoV,MAAMnC,OAAS,cACpBjT,KAAKuV,eZk7BL7P,EY/6BDmQ,mBAAA,WACChC,EAAYa,UAAUnC,KACrBuD,EAAAA,SACCC,WAAU,WACXtR,OAAOC,SAAS6B,KAAOwE,EAAYnF,IAAIyD,eZi7BxC3D,EY76BDsQ,QAAA,WACChW,KAAKiW,gBACLjW,KAAKoV,MAAMnC,OAAS,QACpBjT,KAAKuV,eZg7BL7P,EY76BD4P,gBAAA,WAAkB,IAAArR,EAAAjE,KACbA,KAAKkW,kBACRlW,KAAKkW,iBAAiBC,cAGVnW,KAAKwR,KAAO/M,OAAO+M,MAAQ,CACvC4E,MAAO,CACN,CAAEpF,GAAI,EAAGvB,KAAM,aACf,CAAEuB,GAAI,EAAGvB,KAAM,cACf,CAAEuB,GAAI,EAAGvB,KAAM,qBACf,CAAEuB,GAAI,EAAGvB,KAAM,WACf,CAAEuB,GAAI,EAAGvB,KAAM,WANjB,IAUMO,EAAShQ,KAAKgQ,OAASvL,OAAOuL,QAAU,CAC7C,CAAEM,KAAM,OAAQb,KAAM,YAAa4G,MAAO,oBAAqB3I,UAAU,EAAMgI,KAAM,QACrF,CAAEpF,KAAM,OAAQb,KAAM,WAAY4G,MAAO,mBAAoB3I,UAAU,EAAMgI,KAAM,aACnF,CAAEpF,KAAM,QAASb,KAAM,QAAS4G,MAAO,eAAgB3I,UAAU,EAAMgI,KAAM,2BAC7E,CAAEpF,KAAM,gBAAiBb,KAAM,OAAQ4G,MAAO,cAAe3I,UAAU,EAAM/H,QAASlB,OAAO+M,KAAK4E,MAAOV,KAAMjR,OAAO+M,KAAK4E,MAAM,GAAGpF,IACpI,CAAEV,KAAM,WAAYb,KAAM,UAAW4G,MAAO,4BAA6B3I,UAAU,EAAMgI,MAAM,IAGhG1F,EAAO7M,KACN,CAAEmN,KAAM,SAAUb,KAAM,aAAc7O,MAAO,GAAI8U,KAAM,IACvD,CAAEpF,KAAM,OAAQb,KAAM,eAAgB7O,MAAO6D,OAAO6R,aAAe,GAAIZ,KAAMjR,OAAO6R,aAAe,KAGpG,IAAM3W,EAAOK,KAAKL,KAAOoQ,EAAkBC,GAa1BhQ,KAAKuW,SAAW5W,EAAK4W,SAOtCvW,KAAKkW,iBAAmBvW,EAAK6W,SAASjE,KACrCkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAACY,GACZ1S,EAAKsR,iBAGNvV,KAAKa,MAAQ,MZq9Bb6E,EYl9BDuQ,cAAA,WAAgB,IAAAzB,EAAAxU,KACXA,KAAKkW,kBACRlW,KAAKkW,iBAAiBC,cAGvB,IAAMxW,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtC2G,SAAU,IAAI/F,EAAAA,YAAY,KAAMN,EAAAA,WAAWE,qBAC3CoG,SAAU,IAAIhG,EAAAA,YAAY,KAAMN,EAAAA,WAAWE,qBAC3CqG,aAAcrS,OAAO6R,aAAe,GACpCS,WAAY,KAGI/W,KAAKuW,SAAW5W,EAAK4W,SAEtCvW,KAAKkW,iBAAmBvW,EAAK6W,SAASjE,KACrCkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAACY,GACZnC,EAAKe,iBAGNvV,KAAKa,MAAQ,MZk9Bb6E,EY/8BDgQ,KAAA,WJpEM,IAAqB1F,EAAQrQ,EAC7BqX,EIoEqB,UAAtBhX,KAAKoV,MAAMnC,OACdjT,KAAKL,KAAKsX,MAAM,CACfL,SAAU,YACVC,SAAU,YACVC,aAAcrS,OAAO6R,aAAe,GACpCS,WAAY,MJ1EY/G,EI6EbhQ,KAAKgQ,OJ7EgBrQ,EI6ERK,KAAKL,KJ5E1BqX,EAAahH,EAAOE,QAAO,SAACC,EAAGC,EAAGzO,GAIvC,OAHIyO,EAAEsF,OACLvF,EAAEC,EAAEX,MAAQW,EAAEsF,MAERvF,IACL,IACHxQ,EAAKsX,MAAMD,KRoiCVtR,EY/8BDwR,MAAA,WACClX,KAAKL,KAAKuX,SZk9BVxR,EY/8BDyR,OAAA,WACCnX,KAAKoV,MAAMnC,OAAS,SACpBjT,KAAKuV,eZk9BL7P,EY/8BDiQ,SAAA,WAAW,IAAAhB,EAAA3U,KACV,GAAIA,KAAKL,KAAKyX,MAAO,CACpBpX,KAAKL,KAAK0X,WAAY,EACtB,IAAM9C,EAAUvU,KAAKL,KAAKiB,MACpBqS,EAASjT,KAAKoV,MAAMnC,OAC1BY,EAAYmB,SAAST,EAAStB,GAAQV,KACrCuD,EAAAA,SACCC,WAAU,SAAA9D,GAEX,OADAxL,QAAQC,IAAI,2BAA4BuL,GAChCgB,GACP,IAAK,cACJ0B,EAAKS,MAAMnC,OAAS,sBACpB0B,EAAKY,cACL,MACD,IAAK,oBACJ9Q,OAAOC,SAAS6B,KAAOwE,EAAYnF,IAAIwD,gBACvC,MACD,IAAK,QACJ3E,OAAOC,SAAS6B,KAAOwE,EAAYnF,IAAIyD,WAGzCsL,EAAKhV,KAAKuX,WACR,SAAArW,GACF4F,QAAQC,IAAI,wBAAyB7F,GACrC8T,EAAK9T,MAAQA,EACb8T,EAAKY,sBAGNvV,KAAKL,KAAK2X,SAAU,GZ09BrB5R,EYt9BD6R,QAAA,WACC,IAAMA,EAAUvX,KAAKL,KAAKyX,MAC1B,OAAOG,GZy9BApC,EY5pCYA,CAAwBpI,EAAAA,WAwM7CoI,EAAgBnI,KAAO,CACtBC,SAAU,sBADX,IC9MqBuK,EAAAA,WbuqCnB,SAASA,KAsBT,OApBAA,EavqCMC,QAAP,SAAeA,GACdzX,KAAK0X,SAASzD,KAAKwD,Ib0qCnBD,EatqCMG,GAAP,SAAUF,GACTzX,KAAK4X,IAAI3D,KAAKwD,IbyqCdD,EatqCMK,SAAP,SAAgBJ,GACfA,EAAUxV,OAAO8D,OAAO,GAAI0R,EAAS,CAAEK,SAAUL,EAAQM,WAEzD/X,KAAK4X,IAAI3D,KAAKwD,Ib2qCdD,EavqCMQ,IAAP,SAAWP,GACVzX,KAAKiY,KAAKhE,KAAKwD,Ib0qCRD,Ea7rCYA,GbgsCrBhV,EahsCqBgV,EAAAA,WACF,IAAIU,EAAAA,cAAc,IbisCrC1V,EalsCqBgV,EAAAA,MAMP,IAAIU,EAAAA,cAAc,Ib8rChC1V,EapsCqBgV,EAAAA,OAUNA,EAAeG,Ib4rC9BnV,EatsCqBgV,EAAAA,OAiBN,IAAIU,EAAAA,cAAc,IAAlB,ICjBMC,EAAAA,WdusCnB,SAASA,KAiBT,OAfAA,EcjsCMC,WAAP,SAAkBhD,GACjBA,EAAQnT,OAAO8D,OAAO,GAAI/F,KAAKoV,MAAOA,GACtCpV,KAAKoV,MAAQA,GdosCbjT,EAAagW,EAAc,KAAM,CAAC,CAChC1X,IAAK,QACL+F,IAAK,Sc9sCS4O,GAChBpV,KAAKqY,OAAOpE,KAAKmB,IdgtCf7Q,IAAK,Wc7sCP,OAAOvE,KAAKqY,OAAOC,edktCZH,EcxtCYA,Gd2tCrB3V,Ec3tCqB2V,EAAAA,SACJ,IAAIjD,EAAAA,gBAAgB,KAApB,ICHIqD,EAAAA,WAEpB,SAAAA,IACCvY,KAAKwY,OAAS,Gf+tCd,IAAI9S,EAAS6S,EAAUhW,UA4DvB,OA1DAmD,Ee9tCD+S,GAAA,SAAGnI,EAAMoI,GAAU,IAAAzU,EAAAjE,KACZ2Y,EAAQ3Y,KAAKwY,OAAOlI,GAAQtQ,KAAKwY,OAAOlI,IAAS,GAEvD,OADAqI,EAAMxV,KAAKuV,GACJ,WACNzU,EAAKuU,OAAOlI,GAAQqI,EAAM3V,QAAO,SAAAsM,GAAC,OAAIA,IAAMoJ,OfsuC7ChT,EeluCDkT,IAAA,SAAItI,EAAMoI,GACT,IAAMC,EAAQ3Y,KAAKwY,OAAOlI,GACtBqI,IACH3Y,KAAKwY,OAAOlI,GAAQqI,EAAM3V,QAAO,SAAAsM,GAAC,OAAIA,IAAMoJ,OfyuC7ChT,EeruCDmT,KAAA,SAAKvI,EAAMoI,GAAU,IAAAlE,EAAAxU,KACd6Y,EAAO,SAAPA,EAAQrH,GACbkH,EAASlH,GACTgD,EAAKoE,IAAItI,EAAMuI,IAEhB7Y,KAAKyY,GAAGnI,EAAMuI,If4uCdnT,EezuCDoT,KAAA,SAAKxI,EAAMkB,GACV,IAAMmH,EAAQ3Y,KAAKwY,OAAOlI,GACtBqI,GACHA,EAAMzU,SAAQ,SAAAwU,GAEbA,EAASlH,MAGX,IAAMuH,EAAY/Y,KAAKwY,OAAOO,UAC1BA,GACHA,EAAU7U,SAAQ,SAAAwU,GACjBA,EAASpI,EAAMkB,OfivCjB9L,Ee5uCDyF,IAAA,SAAImF,GACH,IAAM0I,EAAYhZ,KAAKwY,OAAOlI,GAC9B,OAAO0I,GAAaA,EAAUpX,Qf+uCvB2W,Ee9xCYA,GCAAU,EAAAA,WhBgyCnB,SAASA,KA2ET,OAzEAA,EgBhyCMC,OAAP,SAAczJ,GACTzP,KAAKmZ,6BACR1U,OAAO2U,eAAeC,WAAW5J,IhBoyClCwJ,EgBhyCMK,MAAP,SAAa7J,GACZ,GAAIzP,KAAKmZ,4BACR,YAAuC5X,IAAhCkD,OAAO2U,eAAe3J,IhBoyC9BwJ,EgBhyCM1U,IAAP,SAAWkL,GACV,IAAI7O,EAAQ,KACZ,GAAIZ,KAAKmZ,kCAA+D5X,IAAhCkD,OAAO2U,eAAe3J,GAC7D,IACC7O,EAAQqL,KAAKC,MAAMzH,OAAO2U,eAAe3J,IACxC,MAAO8J,GACR9S,QAAQC,IAAI,0CAA2C+I,EAAM8J,GAG/D,OAAO3Y,GhBqyCPqY,EgBlyCMzS,IAAP,SAAWiJ,EAAM7O,GAChB,GAAIZ,KAAKmZ,4BACR,IACC,IAAMK,EAAQ,GACRzN,EAAOE,KAAKE,UAAUvL,GAAO,SAASH,EAAKG,GAChD,GAAqB,iBAAVA,GAAgC,OAAVA,EAAgB,CAChD,IAA8B,IAA1B4Y,EAAMtU,QAAQtE,GAEjB,OAED4Y,EAAMrW,KAAKvC,GAEZ,OAAOA,KAER6D,OAAO2U,eAAeK,QAAQhK,EAAM1D,GACnC,MAAOwN,GACR9S,QAAQC,IAAI,8CAA+C+I,EAAM7O,EAAO2Y,KhByyC1EN,EgBpyCME,0BAAP,WACC,GAAInZ,KAAK0Z,UACR,OAAO,EAER,IAAIA,GAAY,EAChB,KACCA,EAAY,mBAAoBjV,QAAoC,OAA1BA,OAAO2U,iBAEhD3U,OAAO2U,eAAeK,QAAQ,OAAQ,KACtChV,OAAO2U,eAAeC,WAAW,SAEjCK,GAAY,EAEZ,MAAOH,GACRG,GAAY,EAGb,OADA1Z,KAAK0Z,UAAYA,EACVA,GhB2yCAT,EgB32CYA,GCMRU,EACJ,SADIA,EAEJ,SAGYC,EAAAA,WjBw2CnB,SAASA,KAyTT,OAvTAA,EiBtzCMC,gBAAP,WACC,OAAOC,EAAAA,cAAc,CAACF,EAAcG,SAAUC,EAAAA,SAAS,OAAQzH,KAC9DlD,EAAAA,KAAI,SAAA4K,GACH,IAAMC,EAAiB,GAsCvB,OArCgBD,EAAM,GACd/V,SAAQ,SAAAiW,GAGXA,EAAOC,aACVD,EAAOC,WAAWC,WAAaF,EAAOG,gBACtCH,EAAOC,WAAWG,eAAiBC,KAAKC,IAAIN,EAAOC,WAAWC,WAAY,KAO3EH,EAAe/W,KAAKgX,MAErBD,EAAeQ,MAAK,SAACC,EAAGC,GACvB,OAAID,EAAEP,YAAcQ,EAAER,WACjBO,EAAEP,WAAWS,OAASxH,EAASC,WAC1B,EACEsH,EAAER,WAAWS,OAASxH,EAASC,UAClC,EAGAsH,EAAER,WAAWG,eAAiBI,EAAEP,WAAWG,iBACjDI,EAAEP,WAAWU,OAAS,IAAMF,EAAER,WAAWU,OAAS,GAG7C,KAGTZ,EAAehW,SAAQ,SAACiW,EAAQxY,GAC3BwY,EAAOC,aACVD,EAAOC,WAAWU,MAAQnZ,MAI5BuY,EAAetY,OAAS4Y,KAAKO,IAAIb,EAAetY,OAnGxB,GAoGjBsY,KAERc,EAAAA,sBAAqB,SAACL,EAAGC,GACxB,OAAOD,EAAEtL,KAAI,SAAA8K,GAAM,OAAIA,EAAOC,WAAaD,EAAOC,WAAWa,IAAM,MAAI1L,KAAK,OAC5EqL,EAAEvL,KAAI,SAAA8K,GAAM,OAAIA,EAAOC,WAAaD,EAAOC,WAAWa,IAAM,MAAI1L,KAAK,UjB2zCvEqK,EiB1xCMsB,kBAAP,WAA2B,IAAAjX,EAAAjE,KAC1B,OAAOoU,EAAAA,GAAG,MAAM7B,KACf8B,EAAAA,WAAU,WACT,GAAImB,UAAU2F,cAAgB3F,UAAU2F,aAAaC,cAAgBnX,EAAKoX,OAAS1B,EAA0B,CAC5G,IAAM3H,EAAOnN,SAASC,cAAc,QAC9BwW,EAAQzW,SAAS0W,cAAc,OAC/BnT,EAAQvD,SAAS0W,cAAc,SACrCD,EAAME,aAAa,KAAM,iBACzBF,EAAME,aAAa,QAAS,mDAC5BF,EAAMG,YAAYrT,GAClB4J,EAAKyJ,YAAYH,GACjB9F,UAAU2F,aAAaC,aAAa,CACnChT,MAAO,CAAEsT,MAAO,IAAKC,OAAQ,OAC3B3a,MAAK,SAAC4a,GAEJ,cAAexT,EAClBA,EAAMyT,UAAYD,EAElBxT,EAAM0T,IAAMrX,OAAOsX,IAAIC,gBAAgBJ,GAExCxT,EAAM6T,UAAY,WACjB,IAAMC,EAAsB,CAC3BC,MAAO,WAAA,MAAM,UACb/B,WAAY,CACXS,KAAMxH,EAASC,UACf2H,IAAK,WAGDmB,EAAqB,CAC1BD,MAAO,WAAA,MAAM,UACb/B,WAAY,CACXS,KAAMxH,EAASE,SACf0H,IAAK,WAGDoB,EAAwB,CAC7BF,MAAO,WAAA,MAAM,UACb/B,WAAY,CACXS,KAAMxH,EAASK,YACfuH,IAAK,WAGPhX,EAAKqY,eAAerI,KAAK,CAACiI,EAAqBE,EAAoBA,EAAoBA,EAAoBA,EAAoBC,KAGhIjU,EAAMmU,UACJC,OAAM,SAAC3b,GACT4F,QAAQC,IAAI,qCAAsC7F,EAAM4O,KAAM5O,EAAM4W,YAGtE,OAAOxT,EAAKqY,kBAEbG,EAAAA,YAAY,KjB0yCb7C,EiBtyCM8C,kBAAP,WAA2B,IAAAlI,EAAAxU,KAC1B,OAAOoU,EAAAA,GAAG,MAAM7B,KACf8B,EAAAA,WAAU,WACT,GAAImB,UAAU2F,cAAgB3F,UAAU2F,aAAawB,iBAAmBnI,EAAK6G,OAAS1B,EAA0B,CAC/G,IAAM3H,EAAOnN,SAASC,cAAc,QAC9BwW,EAAQzW,SAAS0W,cAAc,OAC/BnT,EAAQvD,SAAS0W,cAAc,SACrCD,EAAME,aAAa,KAAM,wBACzBF,EAAME,aAAa,QAAS,mDAC5BF,EAAMG,YAAYrT,GAClB4J,EAAKyJ,YAAYH,GACjB9F,UAAU2F,aAAawB,gBAAgB,CACtCC,OAAQ,CAAElB,MAAO,IAAKC,OAAQ,OAC5B3a,MAAK,SAAC4a,GAEJ,cAAexT,EAClBA,EAAMyT,UAAYD,EAElBxT,EAAM0T,IAAMrX,OAAOsX,IAAIC,gBAAgBJ,GAExCxT,EAAM6T,UAAY,WACjB,IAAMY,EAAsB,CAC3BV,MAAO,WAAA,MAAM,iBACb/B,WAAY,CACXS,KAAMxH,EAASC,UACf2H,IAAK,mBAGD6B,EAAqB,CAC1BX,MAAO,WAAA,MAAM,iBACb/B,WAAY,CACXS,KAAMxH,EAASE,SACf0H,IAAK,mBAGPzG,EAAKuI,eAAe9I,KAAK,CAAC4I,EAAqBC,KAEhD1U,EAAMmU,UACJC,OAAM,SAAC3b,GACT4F,QAAQC,IAAI,qCAAsC7F,EAAM4O,KAAM5O,EAAM4W,YAGtE,OAAOjD,EAAKuI,kBAEbN,EAAAA,YAAY,KjBozCb7C,EiBnyCMoD,sBAAP,WAA+B,IAAArI,EAAA3U,KACxBid,EAAoBjd,KAAKid,kBAC/B,OAAIA,EACI7I,EAAAA,GAAG6I,GAEHjd,KAAKkd,SAAS3K,KACpBlD,EAAAA,KAAI,WAAA,OAAMsF,EAAKsI,qBACfja,EAAAA,QAAO,SAAAsM,GAAC,OAAIA,OjB4yCdsK,EiBvyCMuD,cAAP,SAAqBC,GAEpB,IACMjD,EADUP,EAAcyD,QACPC,MAAK,SAAAhO,GAAC,OAAIA,EAAE6M,UAAYiB,KAC/C,GAAIjD,EACH,OAAOA,GjB8yCRP,EiB1yCM2D,UAAP,SAAiB3B,GAChB,IAAMyB,EAAUrd,KAAKqd,QAAQvM,QAC7BuM,EAAQla,KAAKyY,GACb5b,KAAKqd,QAAUA,GjB6yCfzD,EiB1yCM4D,aAAP,SAAoBJ,GACnB,IAAMC,EAAUrd,KAAKqd,QAAQvM,QACvBqJ,EAASkD,EAAQC,MAAK,SAAAhO,GAAC,OAAIA,EAAE6M,UAAYiB,KAS/C,OAPIjD,IACCA,EAAOsD,aACVtD,EAAOuD,OAERL,EAAQM,OAAON,EAAQnY,QAAQiV,GAAS,GACxCna,KAAKqd,QAAUA,GAETlD,GjBizCPP,EiB9yCMgE,oBAAP,SAA2B9F,EAAUsC,GACpC,IAAMiD,EAAUrd,KAAKqd,QACflD,EAASkD,EAAQC,MAAK,SAAAhO,GAAC,OAAIA,EAAE6M,UAAYrE,KAC3CqC,IACHA,EAAOC,WAAaA,GAErBpa,KAAKqd,QAAUA,GjBqzCflb,EAAayX,EAAe,KAAM,CAAC,CACjCnZ,IAAK,gBACL+F,IAAK,SiBxlDiBqX,GACxB7d,KAAKsc,eAAerI,KAAK4J,IjB0lDvBtZ,IAAK,WiBvlDP,OAAOvE,KAAKsc,eAAehE,ajB0lDxB,CACD7X,IAAK,gBACL+F,IAAK,SiBxlDiBsX,GACxB9d,KAAK+c,eAAe9I,KAAK6J,IjB0lDvBvZ,IAAK,WiBvlDP,OAAOvE,KAAK+c,eAAezE,ajB0lDxB,CACD7X,IAAK,QACL+F,IAAK,SiBxlDSuX,GAChB/d,KAAKge,OAAO/J,KAAK8J,IjB0lDfxZ,IAAK,WiBvlDP,OAAOvE,KAAKge,OAAO1F,ajB0lDhB,CACD7X,IAAK,SACL+F,IAAK,SiBxlDUoW,GACjB5c,KAAKie,QAAQhK,KAAK2I,IjB0lDhBrY,IAAK,WiBvlDP,OAAOvE,KAAKie,QAAQ3F,ajB0lDjB,CACD7X,IAAK,UACL+F,IAAK,SiBxlDW6W,GAClBrd,KAAK+Z,SAAS9F,KAAKoJ,IjB0lDjB9Y,IAAK,WiBvlDP,OAAOvE,KAAK+Z,SAASzB,ajB0lDlB,CACD7X,IAAK,QACL+F,IAAK,SiBxlDS0X,GAChBle,KAAKme,OAAOlK,KAAKiK,IjB0lDf3Z,IAAK,WiBvlDP,OAAOvE,KAAKme,OAAO7F,ajB0lDhB,CACD7X,IAAK,oBACL8D,IAAK,WiBl6CP,IAAM6Z,EAAUpe,KAAKqd,QAAQvM,QACvBiN,EAAQ/d,KAAK+d,MACfA,GACHK,EAAQrN,QAAQgN,GAEjB,IAAMM,EAAkBD,EAAQd,MAAK,SAAAhO,GAAC,OAAIA,EAAE8K,YAAc9K,EAAE8K,WAAWS,OAASxH,EAASC,aACzF,OAAI+K,EACIA,EAAgBlC,QAEjB,SjB66CAvC,EiBjqDYA,GjBoqDrBpX,EiBpqDqBoX,EAAAA,OAEND,GjBoqDfnX,EiBtqDqBoX,EAAAA,iBAII,IAAI1E,EAAAA,gBAAgB,OjBoqD7C1S,EiBxqDqBoX,EAAAA,iBAYI,IAAI1E,EAAAA,gBAAgB,OjB8pD7C1S,EiB1qDqBoX,EAAAA,SAoBJ,IAAI1E,EAAAA,gBAAgB,OjBwpDrC1S,EiB5qDqBoX,EAAAA,UA4BH,IAAI1E,EAAAA,gBAAgB,OjBkpDtC1S,EiB9qDqBoX,EAAAA,WAoCF,IAAI1E,EAAAA,gBAAgB,KjB4oDvC1S,EiBhrDqBoX,EAAAA,SA4CJ,IAAI1E,EAAAA,gBAAgB,KjBsoDrC1S,EiBlrDqBoX,EAAAA,WAsGFE,EAAAA,cAAc,CAACF,EAAcoE,OAAQpE,EAAcqE,QAASrE,EAAcG,SAAUH,EAAcsB,oBAAqBtB,EAAc8C,sBAAsBnK,KAC5KlD,EAAAA,KAAI,SAAAmC,GACH,IAcmB8M,EAGAC,EAjBbR,EAAQvM,EAAK,GACboL,EAASpL,EAAK,GACd6L,EAAU7L,EAAK,GACfqM,EAAgBrM,EAAK,GACrBsM,EAAgBtM,EAAK,GACvB4M,EAAUf,GACVU,IACHK,EAAUA,EAAQtN,SACV3N,KAAK4a,GAEVnB,IACHwB,EAAUA,EAAQtN,SACV3N,KAAKyZ,GAEViB,KACHS,EAAAF,GAAQjb,KAAR9B,MAAAid,EAAgBT,GAEbC,IACHS,EAAAH,GAAQjb,KAAR9B,MAAAkd,EAAgBT,GAGjB,OAAOM,KAER3B,EAAAA,YAAY,KCvIP,IAIM+B,EAAkB,CAAC,CAG/BC,QAAS,KACTC,WAAY,CACXhD,MAAO,KACPC,OAAQ,MAETgD,UAAW,CACV5D,IAAK,GACLN,IAAK,IAENmE,QAAS,CACR7D,IAAK,KACLN,IAAK,QAEJ,CAGFgE,QAAS,QACTC,WAAY,CACXhD,MAAO,KACPC,OAAQ,MAETgD,UAAW,CACV5D,IAAK,GACLN,IAAK,IAENmE,QAAS,CACR7D,IAAK,KACLN,IAAK,OAEJ,CAGFgE,QAAS,QACTC,WAAY,CACXhD,MAAO,KACPC,OAAQ,MAETgD,UAAW,CACV5D,IAAK,GACLN,IAAK,IAENmE,QAAS,CACR7D,IAAK,KACLN,IAAK,OAEJ,CAGFgE,QAAS,SACTC,WAAY,CACXhD,MAAO,KACPC,OAAQ,KAETgD,UAAW,CACV5D,IAAK,GACLN,IAAK,IAENmE,QAAS,CACR7D,IAAK,KACLN,IAAK,OAEJ,CAGFgE,QAAS,SACTC,WAAY,CACXhD,MAAO,IACPC,OAAQ,KAETgD,UAAW,CACV5D,IAAK,GACLN,IAAK,IAENmE,QAAS,CACR7D,IAAK,IACLN,IAAK,OAIA,SAASoE,EAAiBzJ,GAChC,IAAM0J,EAAgBN,EAAgBA,EAAgB5c,OAAS,GACzDmd,EAAiBhU,EAAYjE,MAAMa,WAAa6W,EAAgB,GAAKA,EAAgBA,EAAgB5c,OAAS,GACpH,OAAQwT,EAAMyF,OAASxH,EAASC,WAAa8B,EAAMyF,OAASxH,EAASK,YAAeqL,EAAiBD,EAG/F,IAAME,EACN,OADMA,EAED,YAFCA,EAGN,OAHMA,EAIL,QAJKA,EAKN,OALMA,EAMJ,SANIA,GAOG,iBAPHA,GAQA,aARAA,GASD,YAICC,GACA,aADAA,GAGI,iBAHJA,GAIY,yBAJZA,GAKY,yBALZA,GAMW,wBANXA,GAOa,0BAPbA,GAQK,kBARLA,GASW,wBATXA,GAUC,cAVDA,GAWO,oBAXPA,GAYQ,qBAZRA,GAaU,uBAbVA,GAcS,sBAdTA,GAgBC,cAhBDA,GAiBH,UAjBGA,GAkBD,YAlBCA,GAmBD,YAnBCA,GAoBD,YApBCA,GAqBD,YArBCA,GAsBD,YAtBCA,GAuBH,UAvBGA,GAwBH,UAxBGA,GAyBA,aAzBAA,GA0BC,cA1BDA,GA2BK,kBA3BLA,GA4BG,gBAEHC,GACZ,SAAYvZ,GACX1D,OAAO8D,OAAO/F,KAAM2F,IAGTwZ,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAA/d,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAA+b,EAAAC,GAAAD,EAAA,CAAoCD,IACvBG,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAje,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAic,EAAAC,GAAAD,EAAA,CAAsCH,IACzBK,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAne,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAmc,EAAAC,GAAAD,EAAA,CAAyCL,IAC5BO,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAre,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAqc,EAAAC,GAAAD,EAAA,CAA2CP,IAC9BS,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAve,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAuc,EAAAC,GAAAD,EAAA,CAAyCT,IAC5BW,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAze,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAyc,EAAAC,GAAAD,EAAA,CAA2CX,IAC9Ba,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAA3e,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAA2c,EAAAC,GAAAD,EAAA,CAA4Cb,ICtIvBe,GAAAA,SAAAA,GAYpB,SAAAA,EAAYC,GAAgB,IAAAjc,EAC3B,GAAIgc,EAAaE,MAChB,KAAO,+BAERlc,EAAAmc,EAAAvc,KAAA7D,OAAAA,MACKqgB,kBAAoBpc,EAAKoc,kBAAkBC,KAAvB5c,EAAAO,IACzBA,EAAKsc,oBAAsBtc,EAAKsc,oBAAoBD,KAAzB5c,EAAAO,IAC3BA,EAAKuc,cAAgBvc,EAAKuc,cAAcF,KAAnB5c,EAAAO,IACrBA,EAAKwc,gBAAkBxc,EAAKwc,gBAAgBH,KAArB5c,EAAAO,IACvBA,EAAKyc,mBAAqBzc,EAAKyc,mBAAmBJ,KAAxB5c,EAAAO,IAC1BA,EAAK0c,YAAc1c,EAAK0c,YAAYL,KAAjB5c,EAAAO,IACnBA,EAAK2c,cAAgB3c,EAAK2c,cAAcN,KAAnB5c,EAAAO,IACrBA,EAAK4c,YAAc5c,EAAK4c,YAAYP,KAAjB5c,EAAAO,IACnBA,EAAK6c,cAAgB7c,EAAK6c,cAAcR,KAAnB5c,EAAAO,IACrBA,EAAK8c,kBAAoB9c,EAAK8c,kBAAkBT,KAAvB5c,EAAAO,IACzBA,EAAK+c,cAAgB/c,EAAK+c,cAAcV,KAAnB5c,EAAAO,IACrBA,EAAKgd,aAAehd,EAAKgd,aAAaX,KAAlB5c,EAAAO,IACpBA,EAAKid,wBAA0Bjd,EAAKid,wBAAwBZ,KAA7B5c,EAAAO,IAC/BA,EAAKkd,2BAA6Bld,EAAKkd,2BAA2Bb,KAAhC5c,EAAAO,IAClCA,EAAKmd,0BAA4Bnd,EAAKmd,0BAA0Bd,KAA/B5c,EAAAO,IACjCA,EAAKod,UAAYpd,EAAKod,UAAUf,KAAf5c,EAAAO,IACjB,IAAMmR,EAAQ+C,EAAa/C,MArBA,OAsB3B+C,EAAaC,WAAW,CACvBkJ,QAAUlM,EAAMyF,OAASxH,EAASE,UAAY2M,EAAkBA,EAAiB,CAAEqB,OAAQ,GAAIC,OAAQ,IACvGC,QAAS5C,EAAiBzJ,GAC1BsM,aAAc,IAzBYzd,EnBy4D3Bb,EAAe6c,EAAcG,GAE7BH,EmBr5DM0B,aAAP,SAAoBzB,GACnB,IAAI5b,EAMJ,OAHKtE,KAAKmgB,QACTngB,KAAKmgB,MAAQ,IAAIF,EAAaC,IAExBlgB,KAAKmgB,OnB68DZ,IAAIza,EAASua,EAAa1d,UAgvD1B,OA9uDAmD,EmBh6DDkc,gBAAA,SAAgB9F,GACf9b,KAAK6hB,qBACL,IAAMzZ,EAAQ,CACb0Z,SAAU,eACVzL,MAAO,cACP0L,KAAM,cACNjG,IAAKA,GAEAkG,EAAQ,CACbF,SAAU,eACVzL,MAAO,cACP0L,KAAM,cACNjG,IAAKA,GAEAwF,EAAUnJ,EAAa/C,MAAMkM,QACnCA,EAAQC,OAAOpe,KAAKiF,GACpBkZ,EAAQE,OAAOre,KAAK6e,GACpB7J,EAAaC,WAAW,CAAEkJ,QAASA,KnBq6DnC5b,EmBl6DDmc,mBAAA,WACC,IAAMP,EAAUnJ,EAAa/C,MAAMkM,QACnCA,EAAQC,OAASD,EAAQC,OAAOve,QAAO,SAAAsM,GAAC,MAAe,gBAAXA,EAAEyS,QAC9CT,EAAQE,OAASF,EAAQE,OAAOxe,QAAO,SAAAsM,GAAC,MAAe,gBAAXA,EAAEyS,QAC9C5J,EAAaC,WAAW,CAAEkJ,QAASA,KnB26DnC5b,EmBx6DDuc,SAAA,WACC,IAAM/Q,EAASiH,EAAa/C,MAAMkM,QAC5BY,EAAgBliB,KAAKkiB,cAAiBliB,KAAKkiB,eAAiBhR,EAAOqQ,OAAOzQ,QAC1EqR,EAAgBniB,KAAKmiB,cAAiBniB,KAAKmiB,eAAiBjR,EAAOqQ,OAAOzQ,QAGhF,OAFAI,EAAOqQ,OAASW,EAAcpR,QAC9BI,EAAOsQ,OAASW,EAAcrR,QACvBa,EAAAA,KAAK,IAAI5Q,SAAQ,SAACV,EAASC,GACjC,IAAM8hB,EAAa,WAClBnC,EAAamC,aAAaphB,MAAK,SAACsgB,GAE/Be,EAAWC,QACX,IAAK,IAAI3gB,EAAI,EAAGA,EAAI2f,EAAQ1f,OAAQD,IAAK,CACxC,IAAM4gB,EAASjB,EAAQ3f,GAEH,eAAhB4gB,EAAOR,MAAyBQ,EAAOT,UAC1C5Q,EAAOqQ,OAAOpe,KAAK,CAClBkT,MAAOkM,EAAOlM,OAAS,UAAYnF,EAAOqQ,OAAO3f,OACjDkgB,SAAUS,EAAOT,SACjBC,KAAMQ,EAAOR,OAGK,eAAhBQ,EAAOR,MAAyBQ,EAAOT,UAC1C5Q,EAAOsQ,OAAOre,KAAK,CAClBkT,MAAOkM,EAAOlM,OAAS,cAAgBnF,EAAOsQ,OAAO5f,OACrDkgB,SAAUS,EAAOT,SACjBC,KAAMQ,EAAOR,OAIZ7Q,EAAOqQ,OAAO3f,OAAS,GAAKsP,EAAOsQ,OAAO5f,OAAS,EACtDvB,EAAQ6Q,GAER5Q,EAAO4Q,MAENsL,OAAM,SAAC3b,GACTP,EAAOO,OAgCHwhB,EAAaG,SAASC,aAAa,CAAET,OAAO,EAAM5Z,OAAO,IAC/Dia,EAAWK,MAAK,WACfN,OACE,WACFA,YnBo7DF1c,EmB/6DDid,SAAA,SAASC,GAAa,IAAApO,EAAAxU,KACfshB,EAAUnJ,EAAa/C,MAAMkM,QAkBnC,OAjBIsB,IACHtB,EAAQlZ,MAAQwa,EAAYxa,MAC5BkZ,EAAQU,MAAQY,EAAYZ,OAGxB7J,EAAa/C,MAAMyN,aACvB1K,EAAaC,WAAW,CAAEnF,OAAQ+L,GAAwB6D,YAAY,EAAMvB,QAAAA,IAC5EwB,YAAW,WACVtO,EAAKuO,cAAa,WACjB,IAAMC,EAAkBxO,EAAKyO,qBAC7BhD,EAAaiD,UAAUF,GAAiBjN,WAAU,SAAAoN,GAEjD3O,EAAKjF,KAAK4T,EAAMA,MAAOH,WAGvB,MAEG7K,EAAaE,QnB47DpB3S,EmBz7DD0d,cAAA,SAAcC,GACb,IAAMC,EAAgBtjB,KAAKsjB,cAC3B,OAAOtJ,EAAAA,SAAS,KAAMzH,KACrB8B,EAAAA,WAAU,WAAA,OAAM1C,EAAAA,KAAK2R,EAAcC,sBAAsB,CAACF,QAC1DhU,EAAAA,KAAI,SAAAmU,GAAQ,OAAIA,EAASH,MACzBrI,EAAAA,yBnB67DDtV,EmBz7DD+d,mBAAA,WACCzjB,KAAK0jB,uBACL1jB,KAAK2jB,yBAA2B3jB,KAAKojB,cAAcjL,EAAa/C,MAAM4N,iBAAiBjN,WACtF,SAAA2L,GACCvJ,EAAaC,WAAW,CAAEsJ,aAAcA,QnB87D1Chc,EmBz7DDge,qBAAA,WACK1jB,KAAK2jB,2BACR3jB,KAAK2jB,yBAAyBxN,cAC9BnW,KAAK2jB,yBAA2B,KAChCxL,EAAaC,WAAW,CAAEsJ,aAAc,MnB+7DzChc,EmB37DDqd,aAAA,SAAa9O,GAAM,IAAAU,EAAA3U,KACdA,KAAK4jB,QACR3P,IAIDuO,SAASqB,OAAOC,YAAYtB,SAASqB,OAAOE,MAC5C,IAAMH,EAAS5jB,KAAK4jB,OAASpB,SAASO,aAAa,CAAE1H,KAAM,OAAQ2I,MAAO,SACpEC,EAAa,WACdlZ,EAAYjE,MAAME,WACrB4c,EAAOM,iBAAiB,GACxBzd,QAAQC,IAAI,yCAEbkd,EAAOlB,KAAK3X,EAAYjD,QAAQ,WAE/BmM,OACE,SAACpT,GAEH8T,EAAKiP,OAAS,SAGZzL,EAAa/C,MAAMyF,OAASxH,EAASI,OACxCmQ,EAAOO,cAAc,YAAY,SAAStjB,GACpCA,GACJojB,OAIFA,IAEDL,EAAOnL,GAAG,QAASzY,KAAKokB,SACxBR,EAAOnL,GAAG,mBAAoBzY,KAAKqgB,mBACnCuD,EAAOnL,GAAG,qBAAsBzY,KAAKugB,qBAErCqD,EAAOnL,GAAG,eAAgBzY,KAAKwgB,eAC/BoD,EAAOnL,GAAG,iBAAkBzY,KAAKygB,iBACjCmD,EAAOnL,GAAG,oBAAqBzY,KAAK0gB,oBACpCkD,EAAOnL,GAAG,aAAczY,KAAK2gB,aAC7BiD,EAAOnL,GAAG,eAAgBzY,KAAK4gB,eAC/BgD,EAAOnL,GAAG,aAAczY,KAAK6gB,aAC7B+C,EAAOnL,GAAG,eAAgBzY,KAAK8gB,eAK/B8C,EAAOnL,GAAG,cAAezY,KAAKghB,eAE9B4C,EAAOnL,GAAG,aAAczY,KAAKihB,cAE7B2C,EAAOnL,GAAG,6BAA8BzY,KAAKmhB,4BAC7CyC,EAAOnL,GAAG,4BAA6BzY,KAAKohB,4BASrBphB,KAAKsjB,cAAgBe,SAASC,eAAevZ,EAAYjD,OAAQ,CAAEyc,UAAWF,SAASG,kBAC/FC,cAAc,CAAEF,UAAWF,SAASG,kBnB48DnD9e,EmBt8DDud,mBAAA,WACC,IAAIxW,EAAO0L,EAAa/C,MAAM3I,MAAQ,GAChCiY,EAAQjY,EAAKiY,MAAM,4BAOzB,OANIA,IACHjY,EAAUiY,EAAM,GAAZ,IAAkBA,EAAM,IAETvM,EAAa/C,MAAMvO,YAClB,IAAqB4F,GnB68D1CwT,EmBx8DM0E,gBAAP,WAeC,OAXa,MACmC,KAArC,EAAInK,KAAKoK,MAAsB,EAAhBpK,KAAKqK,WACiB,IAArC,EAAIrK,KAAKoK,MAAsB,EAAhBpK,KAAKqK,WACiB,GAArC,EAAIrK,KAAKoK,MAAsB,EAAhBpK,KAAKqK,YAElBC,KAAKC,OAMPvZ,YnBw8DX9F,EmBr8DD6J,KAAA,SAAK4T,EAAOH,GAAiB,IAAAnO,EAAA7U,KAC5BA,KAAKglB,QAAU,KACf,IAAMpB,EAAS5jB,KAAK4jB,OACd7L,EAAWkB,EAAsB1U,IAAI,kBAAoB0b,EAAa0E,kBAE5Ef,EAAOrU,KAAK4T,EAAOH,EAAiBjL,GAAU,SAACkD,GAE9C9C,EAAaC,WAAW,CAAEnF,OAAQ+L,GAAuBgE,gBAAAA,EAAiBiC,WAAW,EAAMhK,IAAKA,IAChGhC,EAAsBzS,IAAI,gBAAiByU,GAE1CgF,EAAaiF,UAAUjK,GAAKlF,WAAU,SAAAoN,GAErCtO,EAAKsQ,mBAAmBhC,EAAMA,MAAOlI,GAAKja,MAAK,SAACokB,GAE3CjN,EAAa/C,MAAMyF,OAASxH,EAASI,QACxCoB,EAAKwQ,mBAAmBrkB,MAAK,SAAAsgB,GAC5BzM,EAAKyQ,kBAAkBrK,EAAKqG,EAAQlZ,MAAOkZ,EAAQU,UAGrDnN,EAAK4O,wBACH,SAAA5iB,GACF4F,QAAQC,IAAI,2BAA4B7F,YAUzC,SAACA,GACH4F,QAAQC,IAAI,0BAA2B7F,GACzB,wBAAVA,GACHof,EAAaiD,UAAUF,GAAiBjN,WAAU,SAAAoN,GACjDtO,EAAKtF,KAAK4T,EAAMA,MAAOH,UnB+8D1Btd,EmBx8DDyf,mBAAA,SAAmBhC,EAAOlI,GAAK,IAC1B+J,EAD0BjQ,EAAA/U,KAE9B,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5B,IAAMgjB,EAAgBvO,EAAKuO,cAC3BA,EAAciC,MAAM,CAAEpC,MAAOA,EAAOlI,IAAKA,EAAIzP,aAAcxK,MAAK,WAG/D,OADAgkB,EAAU1B,EAAckC,cAAcrN,EAAa/C,MAAM4N,kBAC1CzT,UACbvO,MAAK,WACP+T,EAAKiQ,QAAUA,EACfA,EAAQvM,GAAG,iBAAkB1D,EAAKsM,WAClCtM,EAAK+D,KAAK,UAAWkM,GAErB3kB,EAAQ4a,MACNuB,MAAMlc,OnBm9DVoF,EmB/8DD+f,cAAA,SAAcxR,GACbgM,EAAamC,aAAaphB,MAAK,SAACsgB,GAG/B,IAFA,IAAMC,EAAS,GACTC,EAAS,GACN7f,EAAI,EAAGA,EAAI2f,EAAQ1f,OAAQD,IAAK,CACxC,IAAM4gB,EAASjB,EAAQ3f,GACnB,cAAgB4gB,EAAOR,MAC1BR,EAAOpe,KAAK,CACXkT,MAAOkM,EAAOlM,OAAS,UAAYkL,EAAO3f,OAC1CkgB,SAAUS,EAAOT,SACjBC,KAAMQ,EAAOR,OAGX,cAAgBQ,EAAOR,MAC1BP,EAAOre,KAAK,CACXkT,MAAOkM,EAAOlM,OAAS,cAAgBkL,EAAO3f,OAC9CkgB,SAAUS,EAAOT,SACjBC,KAAMQ,EAAOR,OAIhB9N,EAAK,CAAEsN,OAAQA,EAAQC,OAAQA,OAC7BhF,OAAM,SAAC3b,GACT4F,QAAQC,IAAI,6BAA8B7F,OnB09D3C6E,EmBt9DDggB,gBAAA,SAAgB/f,EAASyC,GACxB,OAAO,IAAIrH,SAAQ,SAACV,EAASC,GAC5B,GAAI8H,EACH,GAAmB,gBAAfA,EAAM2Z,KAAwB,CACjC,IAAMlV,EAAUhI,SAASC,cAAc,IAAMsD,EAAM0Z,UACnDjV,EAAQ8Y,YAAc,YACtB,IAAIC,EAAM,IAAIC,IACdD,EAAIE,YAAYjZ,GAChB+Y,EAAInN,GAAGoN,IAAIE,OAAOC,gBAAgB,WACjCJ,EAAIK,WAAW7d,EAAM0T,KACrB8J,EAAInN,GAAGoN,IAAIE,OAAOG,iBAAiB,SAACvN,EAAOnH,GAE1C3E,EAAQ0P,OAAOvb,MAAK,SAAAokB,GACnB,IAAMxJ,EAAS/O,EAAQsZ,gBACvBxgB,EAAQygB,YAAcxK,EAAOyK,iBAAiB,GAE9ChmB,EAAQsF,MACN,SAAA9E,GACF4F,QAAQC,IAAI,qCAAsC7F,iBAI/C,GAAmB,gBAAfuH,EAAM2Z,MAAyC,gBAAf3Z,EAAM2Z,KAAwB,CACxE,IAAMlV,EAAUhI,SAASC,cAAc,IAAMsD,EAAM0Z,UACnDjV,EAAQ8Y,YAAc,YAEtB,IAAM/J,EAAS/O,EAAQsZ,gBACvBxgB,EAAQygB,YAAcxK,EAAOyK,iBAAiB,GAE9ChmB,EAAQsF,QAaRA,EAAQ2gB,SAAWle,EAAM0Z,SACzBzhB,EAAQsF,QAGTtF,EAAQsF,OnB69DVD,EmBx9DD6gB,gBAAA,SAAgB5gB,EAASqc,GACxB,OAAO,IAAIjhB,SAAQ,SAACV,EAASC,GAC5B,GAAI0hB,EACH,GAAmB,gBAAfA,EAAMD,KAAwB,CACjC,IAAMlV,EAAUhI,SAASC,cAAc,IAAMkd,EAAMF,UACnDjV,EAAQ8Y,YAAc,YAEtB,IAAIC,EAAM,IAAIC,IACdD,EAAIE,YAAYjZ,GAChB+Y,EAAInN,GAAGoN,IAAIE,OAAOC,gBAAgB,WACjCJ,EAAIK,WAAWjE,EAAMlG,KACrB8J,EAAInN,GAAGoN,IAAIE,OAAOG,iBAAiB,SAACvN,EAAOnH,GAE1CoU,EAAIY,UAAYhV,EAAKiV,OAAO7kB,OAAS,EACrCiL,EAAQ0P,OAAOvb,MAAK,SAAAokB,GACnB,IAAMxJ,EAAS/O,EAAQsZ,gBACvBxgB,EAAQ+gB,YAAc9K,EAAO+K,iBAAiB,GAE9CtmB,EAAQsF,MACN,SAAA9E,GACF4F,QAAQC,IAAI,qCAAsC7F,iBAI/C,GAAmB,gBAAfmhB,EAAMD,MAAyC,gBAAfC,EAAMD,KAAwB,CACxE,IAAMlV,EAAUhI,SAASC,cAAc,IAAMkd,EAAMF,UACnDjV,EAAQ8Y,YAAc,YAEtB,IAAM/J,EAAS/O,EAAQsZ,gBACvBxgB,EAAQ+gB,YAAc9K,EAAO+K,iBAAiB,GAE9CtmB,EAAQsF,QAaRA,EAAQihB,aAAe5E,EAAMF,SAC7BzhB,EAAQsF,QAGTtF,EAAQsF,OnB+9DVD,EmB19DD2f,iBAAA,WACC,OAAO,IAAItkB,SAAQ,SAACV,EAASC,GAC5B,IAAM8U,EAAQ+C,EAAa/C,MACvBA,EAAMyF,OAASxH,EAASK,YAC3BuM,EAAamC,aAAaphB,MAAK,SAAA6lB,GAC9B,IAAMvF,EAAU,CAAEC,OAAQ,GAAIC,OAAQ,GAAIpZ,MAAO,KAAM4Z,MAAO,MAC9D6E,EAAa3iB,SAAQ,SAAAoL,GACL,eAAXA,EAAEyS,KACLT,EAAQC,OAAOpe,KAAKmM,GACC,eAAXA,EAAEyS,MACZT,EAAQE,OAAOre,KAAKmM,MAGtB7I,QAAQC,IAAI4a,GACZA,EAAQlZ,MAAQkZ,EAAQC,OAAO,IAAM,KACrCD,EAAQU,MAAQV,EAAQE,OAAO,IAAM,KACrCrJ,EAAaC,WAAW,CAAEkJ,QAAAA,IAC1BjhB,EAAQihB,MACN9E,OAAM,SAAA3b,GACRP,EAAOO,MAGRR,EAAQ+U,EAAMkM,anBu+DhB5b,EmBl+DD4f,kBAAA,SAAkBrK,EAAK7S,EAAO4Z,GAAO,IAAA8E,EAAA9mB,KAE9B2F,EAAU,CACfohB,SAAU9L,EACV7S,MAAO4e,QAAQ5e,GACf4Z,MAAOgF,QAAQhF,GACfpF,QAAQ,GAET7b,QAAQkmB,IAAI,CACXjnB,KAAK0lB,gBAAgB/f,EAASyC,GAC9BpI,KAAKumB,gBAAgB5gB,EAASqc,KAC5BhhB,MAAK,SAAAokB,GACP,IAAM3D,EAAUxf,OAAO8D,OAAO,GAAIoS,EAAa/C,MAAMqM,SACrDqF,EAAKI,6BAA6BvhB,EAAS8b,OnBs+D5C/b,EmBl+DDwhB,6BAAA,SAA6BvhB,EAAS8b,GAAS,IAAA0F,EAAAnnB,KAaxC+d,EAAQyE,SAASC,aAAa9c,GAkBhC8b,IACH1D,EAAMqJ,gBAAgB3F,EAAQhD,SAC9BV,EAAMsJ,6BAA6B5F,IAGpC1D,EAAM2E,MAAK,WACV9I,EAAcmE,MAAQA,EACtB+E,YAAW,WACVqE,EAAKG,uBACH,MACD,SAACzmB,GACH4F,QAAQC,IAAI,0CAA2C7F,OnB0+DxD6E,EmBt+DD6hB,gBAAA,WAAkB,IAAAC,EAAAxnB,KACH4Z,EAAcmE,MACtB2E,MAAK,WACV8E,EAAKF,wBACH,SAACzmB,GACH4F,QAAQC,IAAI,0CAA2C7F,OnB2/DxD6E,EmBx+DD4hB,mBAAA,WACC,IAAM1D,EAAS5jB,KAAK4jB,OACd7F,EAAQnE,EAAcmE,MAE5B6F,EAAO6D,QAAQ1J,GAAO,SAACld,GACtB4F,QAAQC,IAAI,wCAAyCqX,EAAM5B,QAAStb,MAErEkd,EAAM3D,WAAa,CAClBS,KAAM1C,EAAa/C,MAAMyF,KACzBpL,KAAM0I,EAAa/C,MAAM3F,KACzBwL,IAAK9C,EAAa/C,MAAM6F,IACxByM,UAAWvP,EAAa/C,MAAMsS,WAE/B9N,EAAcmE,MAAQA,GnB2+DtBrY,EmBx+DDiiB,qBAAA,WACC,IAAM/D,EAAS5jB,KAAK4jB,OACd7F,EAAQnE,EAAcmE,MACxBA,GACH6F,EAAOgE,UAAU7J,GAAO,SAACld,GACxB4F,QAAQC,IAAI,0CAA2CqX,EAAM5B,QAAStb,MAGxE+Y,EAAcmE,MAAQ,MnB6+DtBrY,EmB1+DDmiB,aAAA,WAAe,IAAAC,EAAA9nB,KAMd,OALAmY,EAAaC,WAAW,CAAEyK,YAAY,IACtC7iB,KAAK2nB,uBACL3nB,KAAK+nB,wBACLnO,EAAcyD,QAAU,GACxBzD,EAAcsE,MAAQ,GACf,IAAInd,SAAQ,SAACV,EAASC,GAC5BwnB,EAAKE,sBAAsBhnB,MAAK,WAC/B,OAAOD,QAAQkmB,IAAI,CAACa,EAAKG,cAAeH,EAAKI,wBAC3C5nB,OnBk/DJoF,EmB9+DDuiB,YAAA,WAAc,IAAAE,EAAAnoB,KACb,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5B,IAAMsjB,EAASuE,EAAKvE,OAChBA,EACHA,EAAOwE,OAAM,WACZD,EAAKvE,OAAS,KAEV7Y,EAAYjE,MAAME,WACrB4c,EAAOyE,kBACP5hB,QAAQC,IAAI,wCAEbrG,OACE,SAACQ,GACH4F,QAAQC,IAAI,iCAAkC7F,GAC9CP,EAAOO,MAGRR,QnBu/DFqF,EmBl/DDsiB,oBAAA,WAAsB,IAAAM,EAAAtoB,KACrB,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAE3BgoB,EAAK5E,uBACL,IAAMsB,EAAUsD,EAAKtD,QACf1B,EAAgBgF,EAAKhF,cAC3B0B,EAAQoD,QAAQpnB,MAAK,WACpBsnB,EAAKtD,QAAU,KACf1B,EAAciF,SAASvnB,MAAK,WAC3BsnB,EAAKhF,cAAgB,KACrBjjB,MACEC,KACDA,OnB0/DLoF,EmBn/DD8iB,aAAA,WACC,IAAMzK,EAAQnE,EAAcmE,MAExBA,GAASA,EAAM3V,QACd2V,EAAM0K,eACT1K,EAAM2K,cACNvQ,EAAaC,WAAW,CAAEuQ,aAAa,IACvC3oB,KAAK4oB,eAAe,IAAInJ,GAAsB,CAAErC,SAAUW,EAAM5B,aAEhE4B,EAAM8K,YACN1Q,EAAaC,WAAW,CAAEuQ,aAAa,IACvC3oB,KAAK4oB,eAAe,IAAIrJ,GAAoB,CAAEnC,SAAUW,EAAM5B,cnBggEhEzW,EmB3/DDojB,YAAA,WACC,IAAM/K,EAAQnE,EAAcmE,MAExBA,GAASA,EAAMiE,QACdjE,EAAMgL,eACThL,EAAMiL,cACN7Q,EAAaC,WAAW,CAAE6Q,YAAY,IACtCjpB,KAAK4oB,eAAe,IAAI/I,GAAsB,CAAEzC,SAAUW,EAAM5B,aAEhE4B,EAAMmL,YACN/Q,EAAaC,WAAW,CAAE6Q,YAAY,IACtCjpB,KAAK4oB,eAAe,IAAIjJ,GAAoB,CAAEvC,SAAUW,EAAM5B,cnBwgEhEzW,EmBngEDyjB,cAAA,WAAgB,IAAAC,EAAAppB,KACXmY,EAAa/C,MAAMtF,QACtB9P,KAAKqpB,2BAA2BroB,MAAK,SAAC8O,GAErCqI,EAAaC,WAAW,CAAEtI,SAAUA,OAE3BqI,EAAa/C,MAAMkU,OAC7BtpB,KAAKupB,sBAAsBpR,EAAa/C,MAAMkU,QAAQtoB,MAAK,SAACsoB,GAE3DnR,EAAaC,WAAW,CAAEkR,QAAQ,IAClCF,EAAKI,2BAA2BxoB,MAAK,SAAC8O,GAErCqI,EAAaC,WAAW,CAAEtI,QAASA,UAIrC9P,KAAKwpB,2BAA2BxoB,MAAK,SAAC8O,GAErCqI,EAAaC,WAAW,CAAEtI,QAASA,QnBmhErCpK,EmB9gED+jB,UAAA,SAAU3R,GAAU,IAAA4R,EAAA1pB,KACfmY,EAAa/C,MAAMtF,QACtB9P,KAAKqpB,2BAA2BroB,MAAK,SAAC8O,GACrCqI,EAAaC,WAAW,CAAEtI,SAAS,IACnC4Z,EAAKC,yBAAyB7R,GAAU9W,MAAK,SAACL,GAC7CwX,EAAaC,WAAW,CAAEkR,OAAQxR,UAG1BK,EAAa/C,MAAMkU,OAC7BtpB,KAAKupB,sBAAsBpR,EAAa/C,MAAMkU,QAAQtoB,MAAK,SAACsoB,GAGvDnR,EAAa/C,MAAMkU,SAAWxR,EACjC4R,EAAKC,yBAAyB7R,GAAU9W,MAAK,SAACL,GAC7CwX,EAAaC,WAAW,CAAEkR,OAAQxR,OAGnCK,EAAaC,WAAW,CAAEkR,QAAQ,OAIpCtpB,KAAK2pB,yBAAyB7R,GAAU9W,MAAK,SAACL,GAC7CwX,EAAaC,WAAW,CAAEkR,OAAQxR,QnBgiEpCpS,EmB3hEDkkB,aAAA,WACC,OAAUzR,EAAa/C,MAAM6F,IAA7B,IAAoC6J,KAAKC,MAAMvZ,YnB8hE/C9F,EmB3hED2jB,yBAAA,WAA2B,IAAAQ,EAAA7pB,KAC1B,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5BupB,EAAKC,YAAY,CAChBxZ,KAAM2O,GACN8K,UAAWF,EAAKD,iBACd5oB,MAAK,SAACyW,GAEJA,EAAQnH,OAAS2O,GACpB5e,GAAQ,GACEoX,EAAQnH,OAAS2O,IAC3B5e,GAAQ,UnBmiEXqF,EmB7hED8jB,yBAAA,WAA2B,IAAAQ,EAAAhqB,KAC1B,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5B0pB,EAAKF,YAAY,CAChBxZ,KAAM2O,GACN8K,UAAWC,EAAKJ,iBACd5oB,MAAK,SAACyW,GAEJA,EAAQnH,OAAS2O,GACpB5e,GAAQ,GACEoX,EAAQnH,OAAS2O,IAE3B5e,GAAQ,UnBqiEXqF,EmB/hEDukB,0BAAA,SAA0BnS,GAAU,IAAAoS,EAAAlqB,KAEnC,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5B4pB,EAAKJ,YAAY,CAChBxZ,KAAM2O,GACN8K,UAAWG,EAAKN,eAChB9R,SAAUA,IACR9W,MAAK,SAACyW,GAER,GAAIA,EAAQnH,OAAS2O,GAAmC,CACvD,GAAIxH,EAAQ2C,WAAWS,OAASxH,EAASC,UAAW,CACnD,IAAM8B,EAAQ,CAAE+U,QAAQ,IACW,IAA/B1S,EAAQ2C,WAAWtK,UACtBsF,EAAMgV,QAAS,EACfF,EAAKG,6BAA6B5S,EAAQ2C,WAAWa,MAEtD9C,EAAaC,WAAWhD,GAEzB/U,EAAQoX,WnB6iEX/R,EmBviED2kB,6BAAA,SAA6BvS,GAAU,IAAAwS,EAAAtqB,KAEtC,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5BgqB,EAAKR,YAAY,CAChBxZ,KAAM2O,GACN8K,UAAWO,EAAKV,eAChB9R,SAAUA,IACR9W,MAAK,SAACyW,GACJA,EAAQnH,OAAS2O,IACpB5e,EAAQoX,UnB+iEX/R,EmBziEDikB,yBAAA,SAAyB7R,GAAU,IAAAyS,EAAAvqB,KAClC,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5BiqB,EAAKT,YAAY,CAChBxZ,KAAM2O,GACN8K,UAAWQ,EAAKX,eAChB9R,SAAUA,IACR9W,MAAK,SAACyW,GAEJA,EAAQnH,OAAS2O,KACpB9G,EAAaC,WAAW,CAAEkR,OAAQxR,IAClCzX,EAAQoX,WnBmjEX/R,EmB7iED6jB,sBAAA,SAAsBzR,GAAU,IAAA0S,EAAAxqB,KAC/B,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5BkqB,EAAKV,YAAY,CAChBxZ,KAAM2O,GACN8K,UAAWS,EAAKZ,eAChB9R,SAAUA,IACR9W,MAAK,SAACyW,GAEJA,EAAQnH,OAAS2O,GACpB5e,GAAQ,GACEoX,EAAQnH,OAAS2O,IAC3B5e,GAAQ,UnBqjEXqF,EmB/iED+kB,UAAA,SAAUC,IACLvS,EAAa/C,MAAMtF,SAAWqI,EAAa/C,MAAMuV,QACpD3qB,KAAK8pB,YAAY,CAChBxZ,KAAM2O,GACNyL,OAAQA,KnBojEVhlB,EmB/iEDklB,gBAAA,WACgB5qB,KAAK4jB,OACbgH,iBAAgB,SAACC,GACvBpkB,QAAQC,IAAR,6BAAyCmkB,EAAMC,UAC/CrkB,QAAQC,IAAR,8BAA0CmkB,EAAME,WAChDtkB,QAAQC,IAAR,8BAA0CmkB,EAAMG,WAChDvkB,QAAQC,IAAR,8BAA0CmkB,EAAMI,WAChDxkB,QAAQC,IAAR,gCAA4CmkB,EAAMK,aAClDzkB,QAAQC,IAAR,gCAA4CmkB,EAAMM,iBnBmjEnDzlB,EmB/iED0lB,eAAA,WACgBprB,KAAK4jB,OACbwH,gBAAe,SAACP,GACtBpkB,QAAQC,IAAR,0BAAsCmkB,EAAMQ,kBnBmjE7C3lB,EmB/iEDokB,YAAA,SAAYrS,GAAS,IAAA6T,EAAAtrB,KACpB,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5B,GAAI6X,EAAa/C,MAAM6P,UAAW,CAEjC,OADAxN,EAAQM,SAAWI,EAAa/C,MAAM6F,IAC9BxD,EAAQnH,MACf,KAAK2O,GACL,KAAKA,GACL,KAAKA,GACL,KAAKA,GACJ,IAAK9G,EAAa/C,MAAMtF,UAAYqI,EAAa/C,MAAMuV,MACtD,OAMH,IAAMY,EAAO,SAAC9T,EAASuN,GACtB,IACC,IAAM5S,EAAOnG,KAAKE,UAAUsL,GACxBA,EAAQsS,WACXuB,EAAKzS,KAAL,WAAqBpB,EAAQsS,WAAa,SAACtS,GAC1CpX,EAAQoX,MAIVuN,EAAQ8E,YAAY,CAAE1X,KAAMA,IAAQpR,MAAK,WAEnCyW,EAAQsS,WACZ1pB,EAAQoX,MAEP+E,OAAM,SAAA3b,GACR4F,QAAQC,IAAI,iCAAkC7F,MAE9C,MAAOA,GACR4F,QAAQC,IAAI,iCAAkC7F,KAI1CmkB,EAAUsG,EAAKtG,QACrB,GAAIA,EACHuG,EAAK9T,EAASuN,QAEd,IACCsG,EAAKzS,KAAL,WAAqB,SAACmM,GACrBuG,EAAK9T,EAASuN,MAEd,MAAOnkB,GACRP,EAAOO,SnBgkEX6E,EmBtjED8lB,6BAAA,SAA6BC,GAC5B,IAAMnI,EAAgBtjB,KAAKsjB,cAC3B,GAAIA,EAAe,CAClB,IAAMoI,EAAa,GAKnB,GAJAD,EAASvnB,SAAQ,SAAAuT,GAChB,IAAMhX,EAAMgX,EAAQkU,KAAKngB,WACzBkgB,EAAWjrB,GAAOwL,KAAKE,UAAUsL,MAE9BxV,OAAOY,KAAK6oB,GAAY9pB,OAAQ,CAEnC,IAAMgqB,EAAUtI,EAAckI,6BAA6BrT,EAAa/C,MAAM4N,gBAAiB0I,EAAY,CAAEG,oCAAoC,IACjJ,OAAOla,EAAAA,KAAKia,GAEZ,OAAOxX,EAAAA,GAAG,MAGX,OAAOA,EAAAA,GAAG,OnB8jEX1O,EmB1jEDomB,qBAAA,WACC,IAAMxI,EAAgBtjB,KAAKsjB,cAC3B,GAAIA,EAAe,CAClB,IAAMsI,EAAUtI,EAAcwI,qBAAqB3T,EAAa/C,MAAM4N,iBACtE,OAAOrR,EAAAA,KAAKia,GAASrZ,KACpBlD,EAAAA,KAAI,SAAAqc,GAAU,OAAIzpB,OAAOY,KAAK6oB,GAAYrc,KAAI,SAAA5O,GAAG,OAAIirB,EAAWjrB,SAChE4O,EAAAA,KAAI,SAAAqc,GAUH,OATAA,EAAWhR,MAAK,SAACC,EAAGC,GACnB,OAAOD,EAAEoR,aAAenR,EAAEmR,gBAEVL,EAAWrc,KAAI,SAAA2c,GAG/B,OAFgB/f,KAAKC,MAAM8f,EAAUprB,cASxC,OAAOwT,EAAAA,GAAG,OnBgkEX1O,EmB5jEDumB,sBAAA,SAAsBxU,GAGrB,OAAQA,EAAQnH,MACf,KAAK2O,GACJ9G,EAAaC,WAAW,CAAEgS,QAAQ,IAClCpqB,KAAK8pB,YAAY,CAChBxZ,KAAM2O,GACN8K,UAAWtS,EAAQsS,YAEpB,MACD,KAAK9K,GAEJ9G,EAAaC,WAAW,CAAEuS,OAAO,IACjC3qB,KAAK8pB,YAAY,CAChBxZ,KAAM2O,GACN8K,UAAWtS,EAAQsS,UACnBjS,SAAUL,EAAQK,WAEnB,MACD,KAAKmH,IAEA9G,EAAa/C,MAAMyF,OAASxH,EAASC,WAE9B6E,EAAa/C,MAAMgV,SAD7BpqB,KAAKksB,iBAAiBzU,GAIvB,MACD,KAAKwH,GACL,KAAKA,GACL,KAAKA,GACL,KAAKA,GACL,KAAKA,IACA9G,EAAa/C,MAAMgV,QAAWjS,EAAa/C,MAAMkU,QAAUnR,EAAa/C,MAAMkU,SAAW7R,EAAQM,WACpG/X,KAAKksB,iBAAiBzU,GAEvB,MACD,QACCzX,KAAKksB,iBAAiBzU,KnB0kExB/R,EmBtkEDwmB,iBAAA,SAAiBzU,GAChBD,EAAeQ,IAAIP,InBykEnB/R,EmBtkEDkjB,eAAA,SAAejQ,GACdnB,EAAeQ,IAAI,CAClB1H,KAAM2O,GACNtG,MAAAA,KnB0kEDjT,EmBtkED2b,UAAA,SAAU7P,EAAMyJ,GAGf,GAAIA,IAAQ9C,EAAa/C,MAAM6F,IAAK,CAEnC,IAAMxD,EAAUxL,KAAKC,MAAMsF,EAAKY,MAMhC,GALIqF,EAAQsS,WAAa/pB,KAAKmL,IAAL,WAAoBsM,EAAQsS,YAEpD/pB,KAAK8Y,KAAL,WAAqBrB,EAAQsS,UAAatS,GAGvCA,EAAQK,UAAYL,EAAQK,WAAaK,EAAa/C,MAAM6F,KAAOxD,EAAQK,WAAaK,EAAa/C,MAAMsS,UAC9G,OAGD,GAAIjQ,EAAQnH,OAAS2O,GAAuB,CAC3C,IAAMkN,EAAYtnB,SAAS0W,cAAc,OACzC4Q,EAAUC,UAAUC,IAAI,cACxB5U,EAAQ0U,UAAYA,EAOrBnsB,KAAKisB,sBAAsBxU,KnB+kE5B/R,EmB3kED0e,QAAA,SAAQvjB,GACP4F,QAAQC,IAAI,uBAAwB7F,InB8kEpC6E,EmB3kED2a,kBAAA,SAAkB1H,GAEjB,IAAMoF,EAAQnE,EAAcmE,MAC5BA,EAAM3D,WAAa,CAClBS,KAAM1C,EAAa/C,MAAMyF,KACzBpL,KAAM0I,EAAa/C,MAAM3F,KACzBwL,IAAK9C,EAAa/C,MAAM6F,IACxByM,UAAWvP,EAAa/C,MAAMsS,WAE/B9N,EAAcmE,MAAQA,GnB8kEtBrY,EmB3kED6a,oBAAA,SAAoB5H,GAEnBiB,EAAcmE,MAAQ,MnB8kEtBrY,EmB3kED8a,cAAA,SAAc7H,GACb,IAAMiL,EAAS5jB,KAAK4jB,OACdhI,EAASjD,EAAMiD,OACrB,GAAKA,EAAL,CAGA,IAAMwB,EAAWxB,EAAOO,QACpBiB,IAAajF,EAAa/C,MAAM6F,KAAOmC,IAAajF,EAAa/C,MAAMsS,WAE1E9D,EAAO7N,UAAU6F,GAAQ,SAAC/a,GACzB4F,QAAQC,IAAI,6CAA8C7F,QnBmlE5D6E,EmB9kED+a,gBAAA,SAAgB9H,GACf,IACMyE,EADSzE,EAAMiD,OACGO,QACpBiB,IAAajF,EAAa/C,MAAM6F,KAAOmC,IAAajF,EAAa/C,MAAMsS,WAG1E1nB,KAAKwd,aAAaJ,InBmlEnB1X,EmB/kEDgb,mBAAA,SAAmB/H,GAElB3Y,KAAKud,UAAU5E,EAAMiD,SnBklErBlW,EmB/kEDsb,cAAA,SAAcrI,GAEb3Y,KAAKssB,QAAQ3T,InBklEbjT,EmB/kEDub,aAAA,SAAatI,GACZ,IAAMZ,EAAWY,EAAMsC,IACvB,GAAIlD,IAAaI,EAAa/C,MAAM6F,IAAK,CAExC,IAAMd,EAASna,KAAKwd,aAAazF,GAC7BoC,EAAOC,aAEND,EAAOC,WAAWS,OAASxH,EAASC,UACvC6E,EAAaC,WAAW,CAAE+R,QAAQ,EAAOC,QAAQ,EAAOta,SAAS,EAAO6a,OAAO,IACrExS,EAAa/C,MAAMkU,SAAWvR,GACxCI,EAAaC,WAAW,CAAEkR,QAAQ,KAIrCtpB,KAAKusB,WAAWxU,InB4lEhBrS,EmBzlED4mB,QAAA,SAAQ3T,GAEP,IAAM6T,EAAO,CACZvR,IAAKtC,EAAMsC,KAENiD,EAAQtE,EAAcsE,MAC5BA,EAAM/a,KAAKqpB,GACX5S,EAAcsE,MAAQA,EACtBle,KAAK4oB,eAAe,IAAIzJ,GAAe,CAAEqN,KAAAA,MnB8lEzC9mB,EmB3lED6mB,WAAA,SAAWE,GAEV,IAAMvO,EAAQtE,EAAcsE,MACtBsO,EAAOtO,EAAMZ,MAAK,SAAAhO,GAAC,OAAIA,EAAE2L,MAAQwR,KACnCD,IACHtO,EAAMP,OAAOO,EAAMhZ,QAAQsnB,GAAO,GAClC5S,EAAcsE,MAAQA,InBkmEvBxY,EmB9lED6X,UAAA,SAAU3B,GAEThC,EAAc2D,UAAU3B,GACxB5b,KAAK4oB,eAAe,IAAIvJ,GAAiB,CAAEzD,OAAAA,KAC3C,IAAM9D,EAAW8D,EAAOO,QACxBnc,KAAKiqB,0BAA0BnS,GAAU9W,MAAK,SAACyW,GAC9CmC,EAAcgE,oBAAoB9F,EAAUL,EAAQ2C,gBnBomErD1U,EmBhmED8X,aAAA,SAAaJ,GAEZ,IAAMjD,EAASP,EAAc4D,aAAaJ,GAI1C,OAHIjD,GAAUA,EAAOC,YAAcD,EAAOC,WAAWS,OAASxH,EAASC,WAAa6G,EAAOC,WAAWsN,YAActK,GACnHjF,EAAaC,WAAW,CAAE+R,QAAQ,IAE5BhQ,GnBumEPzU,EmBpmEDib,YAAA,SAAYhI,GAEX3Y,KAAK4oB,eAAe,IAAIrJ,GAAoB,CAAEnC,SAAUzE,EAAMsC,QnBymE9DvV,EmBtmEDkb,cAAA,SAAcjI,GAEb3Y,KAAK4oB,eAAe,IAAInJ,GAAsB,CAAErC,SAAUzE,EAAMsC,QnB2mEhEvV,EmBxmEDmb,YAAA,SAAYlI,GAEX3Y,KAAK4oB,eAAe,IAAIjJ,GAAoB,CAAEvC,SAAUzE,EAAMsC,QnB6mE9DvV,EmB1mEDob,cAAA,SAAcnI,GAEb3Y,KAAK4oB,eAAe,IAAI/I,GAAsB,CAAEzC,SAAUzE,EAAMsC,QnB+mEhEvV,EmB5mEDqb,kBAAA,SAAkBpI,GAEjB,IAAMyF,EAAUzF,EAAM+T,KAAKrd,KAAI,SAAAC,GAC9B,MAAO,CAAE8N,SAAU9N,EAAE2L,IAAK0R,MAAOrd,EAAEqd,UAEpC3sB,KAAK4oB,eAAe,IAAI7I,GAAuB,CAAE3B,QAASA,MnBonE1D1Y,EmBjnEDwb,wBAAA,SAAwBvI,GACvBlS,QAAQC,IAAI,uCAAwCiS,InBonEpDjT,EmBjnEDyb,2BAAA,SAA2BxI,GAC1BlS,QAAQC,IAAI,2CACZ,IAAMkd,EAAS5jB,KAAK4jB,OACdZ,EAAkBhjB,KAAKijB,qBAC7BhD,EAAaiD,UAAUF,GAAiBjN,WAAU,SAAAoN,GAC7CA,EAAMA,QACTS,EAAOgJ,WAAWzJ,EAAMA,OACxB1c,QAAQC,IAAI,wDnBsnEdhB,EmBjnED0b,0BAAA,SAA0BzI,GACzBlS,QAAQC,IAAI,0CACZ,IAAMkd,EAAS5jB,KAAK4jB,OACdZ,EAAkBhjB,KAAKijB,qBAC7BhD,EAAaiD,UAAUF,GAAiBjN,WAAU,SAAAoN,GAC7CA,EAAMA,QACTS,EAAOgJ,WAAWzJ,EAAMA,OACxB1c,QAAQC,IAAI,uDnBunEdhB,EmBhnEDmnB,aAAA,WAAe,IAAAC,EAAA9sB,KACC4Z,EAAcgD,OAE5B5c,KAAK+nB,wBAED/nB,KAAK+sB,aACR/sB,KAAKgtB,mBAAmB7U,EAAa/C,MAAMsS,WAE3C1nB,KAAKitB,oBAAmB,WACvB,IAAMjK,EAAkB8J,EAAK7J,qBAC7BhD,EAAaiD,UAAUF,GAAiBjN,WAAU,SAAAoN,GAEjD2J,EAAKI,WAAW/J,EAAMA,MAAOH,UnB4nEjCtd,EmBpnEDunB,mBAAA,SAAmBhZ,GAAM,IAAAkZ,EAAAntB,KACpBA,KAAK+sB,cACR9Y,IAED,IAAM8Y,EAAe/sB,KAAK+sB,aAAevK,SAASO,aAAa,CAAE1H,KAAM,OAAQ2I,MAAO,SAEjFjZ,EAAYjE,MAAME,WACrB+lB,EAAa7I,iBAAiB,GAC9Bzd,QAAQC,IAAI,+CAEbqmB,EAAarK,KAAK3X,EAAYjD,QAAQ,WAErCmM,OACE,SAACpT,GAEHssB,EAAKJ,aAAe,QAItBA,EAAatU,GAAG,QAASzY,KAAKotB,eAC9BL,EAAatU,GAAG,mBAAoBzY,KAAKqtB,yBACzCN,EAAatU,GAAG,qBAAsBzY,KAAKstB,4BnBuoE3C5nB,EmB5nEDwnB,WAAA,SAAW/J,EAAOH,GAAiB,IAAAuK,EAAAvtB,KACbA,KAAK+sB,aAGbxd,KAAK4T,EAAOH,EAFF,MAEmC,SAAC/H,GAE1D9C,EAAaC,WAAW,CAAEsP,UAAWzM,IACrCsS,EAAKP,mBAAmB/R,MACtB,SAACpa,GACH4F,QAAQC,IAAI,gCAAiC7F,GAC/B,wBAAVA,GACHof,EAAaiD,UAAUF,GAAiBjN,WAAU,SAAAoN,GACjDoK,EAAKL,WAAW/J,EAAMA,MAAOH,UnBwoEhCtd,EmBloEDsnB,mBAAA,SAAmBtF,GAAW,IAAA8F,EAAAxtB,KACvB2F,EAAU,CACfohB,SAAUW,EACV1F,OAAO,EACP5Z,OAAO,EACPwU,QAAQ,GAWH6E,EAAUxf,OAAO8D,OAAO,GAAIoS,EAAa/C,MAAMqM,SAC/C7F,EAAS4G,SAASC,aAAa9c,GACjC8b,GACH7F,EAAO6R,iBAAiB,UAKzB7R,EAAO8G,MAAK,WACX9I,EAAcgD,OAAShB,EACvBkH,YAAW,WACV0K,EAAKE,wBACH,MACD,SAAS7sB,GACX4F,QAAQC,IAAI,oDAAqD7F,OnB0oElE6E,EmBtoEDgoB,oBAAA,WACC,IAAMX,EAAe/sB,KAAK+sB,aACpBnQ,EAAShD,EAAcgD,OAE7BmQ,EAAatF,QAAQ7K,GAAQ,SAAC/b,GAC7B4F,QAAQC,IAAI,yCAA0CkW,EAAOT,QAAStb,MAEvE+b,EAAOxC,WAAa,CACnBS,KAAM1C,EAAa/C,MAAMyF,KACzBpL,KAAM0I,EAAa/C,MAAM3F,KACzBwL,IAAK9C,EAAa/C,MAAM6F,IACxByM,UAAWvP,EAAa/C,MAAMsS,WAE/B9N,EAAcgD,OAASA,GnByoEvBlX,EmBtoEDqiB,sBAAA,WACC,IAAMgF,EAAe/sB,KAAK+sB,aACpBnQ,EAAShD,EAAcgD,OAEzBmQ,GAAgBnQ,GACnBmQ,EAAanF,UAAUhL,GAAQ,SAAC/b,GAC/B4F,QAAQC,IAAI,2CAA4CkW,EAAOT,QAAStb,MAG1E+Y,EAAcgD,OAAS,MnB0oEvBlX,EmBvoEDwiB,kBAAA,WAAoB,IAAAyF,EAAA3tB,KACnB,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5B,IAAMysB,EAAeY,EAAKZ,aACtBA,EACHA,EAAa3E,OAAM,WAClBuF,EAAKZ,aAAe,KAEhBhiB,EAAYjE,MAAME,WACrB+lB,EAAa1E,kBACb5hB,QAAQC,IAAI,8CAEbrG,OACE,SAACQ,GACH4F,QAAQC,IAAI,uCAAwC7F,GACpDP,EAAOO,MAGRR,QnBgpEFqF,EmB3oED0nB,cAAA,SAAcvsB,GACb4F,QAAQC,IAAI,6BAA8B7F,InB8oE1C6E,EmB3oED2nB,wBAAA,SAAwB1U,GAEvB,IAAMiE,EAAShD,EAAcgD,OAC7BA,EAAOxC,WAAa,CACnBS,KAAM1C,EAAa/C,MAAMyF,KACzBpL,KAAM0I,EAAa/C,MAAM3F,KACzBwL,IAAK9C,EAAa/C,MAAM6F,IACxByM,UAAWvP,EAAa/C,MAAMsS,WAE/B9N,EAAcgD,OAASA,GnB8oEvBlX,EmB3oED4nB,0BAAA,SAA0B3U,GAEzBiB,EAAcgD,OAAS,MnB+oEvBqD,EmB3oEMiD,UAAP,SAAiBF,GAChB,OAAIjY,EAAYjE,MAAMG,SACdoK,EAAYyB,MAAM,iBAAkB,CAAEjM,YAAamc,EAAiB/H,IAAK,OAEzE7G,EAAAA,GAAG,CAAE+O,MAAO,QnBopEpBlD,EmBhpEMiF,UAAP,SAAiBjK,GAChB,OAAIlQ,EAAYjE,MAAMG,SACdoK,EAAYyB,MAAM,iBAAkB,CAAEmI,IAAKA,IAE3C7G,EAAAA,GAAG,CAAE+O,MAAO,QnBypEpBlD,EmBppEM2N,mBAAP,WACC,OAAO,IAAI7sB,SAAQ,SAACV,EAASC,GAC5B,IAAMsjB,EAASpB,SAASO,aAAa,CAAE1H,KAAM,OAAQ2I,MAAO,SACxDjZ,EAAYjE,MAAME,UACrB4c,EAAOM,iBAAiB,GAEzBN,EAAOlB,KAAK3X,EAAYjD,QAAQ,WAC/BmY,EAAa4N,gBAAgBjK,GAAQ5iB,MAAK,SAAAia,GACzC5a,EAAQ4a,MACNuB,OAAM,SAAA3b,GACRP,EAAOO,MACLitB,SAAQ,WAEVlK,EAAOwE,OAAM,WACRrd,EAAYjE,MAAME,UACrB4c,EAAOyE,qBAEN,qBAEF,SAACxnB,GACHP,EAAOO,UnB8pETof,EmBzpEM4N,gBAAP,SAAuBjK,GACtB,OAAO,IAAI7iB,SAAQ,SAACV,EAASC,GAC5B,IAAMuG,EAAc,qBACpBoZ,EAAaiD,UAAUrc,GAAakP,WAAU,SAAAoN,GAC7CS,EAAOrU,KAAK4T,EAAMA,MAAOtc,EAAa,MAAM,SAACoU,GAE5C5a,EAAQ4a,MACN,SAACpa,GACH,GAAc,wBAAVA,EACH,OAAOof,EAAa4N,gBAAgBjK,GAEpCnd,QAAQC,IAAI,wCAAyC7F,GACrDP,EAAOO,anBgqEXof,EmBzpEM8N,mBAAP,SAA0B9S,GACzB,OAAO,IAAIla,SAAQ,SAACV,EAASC,GAI5B,IAEI0kB,EAFApB,EAASS,SAASC,eAAevZ,EAAYjD,OAAQ,CAAEyc,UAAWF,SAASG,iBAC/EZ,EAAOa,cAAc,CAAEF,UAAWF,SAASG,iBAE3CvE,EAAaiF,UAAUjK,GAAKlF,WAAU,SAAAoN,GAGrCS,EAAO2B,MAAM,CAAEpC,MAAOA,EAAMA,MAAOlI,IAAKA,EAAIzP,aAAcxK,MAAK,YAC9DgkB,EAAUpB,EAAO4B,cAFE,uBAGXjW,OAAOvO,MAAK,WACnBX,EAAQ4a,GACR+J,EAAQoD,WACN5L,OAAM,SAAC3b,GACTP,EAAOO,MACLitB,SAAQ,WAEV9I,EAAQoD,QAAQpnB,MAAK,WACpBgkB,EAAU,KACVpB,EAAO2E,SAASvnB,MAAK,WACpB4iB,EAAS,QACPpH,OAAM,kBACPA,OAAM,qBAERA,OAAM,SAAC3b,GACTP,EAAOO,MACLitB,SAAQ,WAENlK,GACHA,EAAO2E,SAASvnB,MAAK,WACpB4iB,EAAS,QACPpH,OAAM,yBnBqqEbyD,EmB9pEMmC,WAAP,WACC,OAAO,IAAIrhB,SAAQ,SAACV,EAASC,GAC5B,IAAI0tB,EAAW/N,EAAa+N,SAC5B,GAAIA,EACH3tB,EAAQ2tB,OACF,CACNA,EAAW/N,EAAa+N,SAAW,GAK/BxY,UAAU2F,cAAgB3F,UAAU2F,aAAaC,aACpD5F,UAAU2F,aAAaC,aALN,CACjB4G,OAAO,EACP5Z,OAAO,IAG0CpH,MAAK,SAAC4a,GACtDpG,UAAU2F,aAAa8S,mBAAmBjtB,MAAK,SAACsgB,GAC/C1F,EAAOsS,YAAYhqB,SAAQ,SAACiqB,GAC3BA,EAAMzQ,UAEP4D,EAAQpd,SAAQ,SAACqe,GAChByL,EAAS7qB,KAAKof,MAEfliB,EAAQ2tB,MACNxR,OAAM,SAAC3b,GACTP,EAAOO,SAEN2b,OAAM,SAAC3b,GACTP,EAAOO,MAGRP,EAAO,mCnBsqEH2f,EmBtsHYA,CAAqB1H,GCN7B6V,GAAb,WAEC,SAAAA,EAAY3W,EAASM,EAAUtI,GAC9BzP,KAAKsQ,KAAO2O,GACZjf,KAAKquB,UAAYtW,EACM,iBAAZN,GACVzX,KAAK2rB,KAAO7G,KAAKC,MACjB/kB,KAAK+X,SAAWA,EAChB/X,KAAKyP,KAAOA,EACZzP,KAAKyX,QAAUA,GACc,iBAAZA,IACjBzX,KAAK2rB,KAAOlU,EAAQkU,KACpB3rB,KAAK+X,SAAWN,EAAQM,SACxB/X,KAAKyP,KAAOgI,EAAQhI,KACpBzP,KAAKyX,QAAUA,EAAQA,SAExB,IAAM6W,EAAQtuB,KAAKyP,KAAKnK,MAAM,KAC9BtF,KAAKuuB,UAAYD,EAAM,GAAGE,OAAO,EAAG,GAAGC,eAAiBH,EAAM1sB,OAAS,EAAI0sB,EAAM,GAAKA,EAAM,IAAIE,OAAO,EAAG,GAAGC,cAjB/G,IAAA/oB,EAAA0oB,EAAA7rB,UAAA,OAAAmD,EAwBCgpB,WAAA,WACC,MAAO,CACN/C,KAAM3rB,KAAK2rB,KACX5T,SAAU/X,KAAK+X,SACftI,KAAMzP,KAAKyP,KACXgI,QAASzX,KAAKyX,UA7BjB/R,EAiCCipB,QAAA,WACC,OAAO,IAAIP,EAAY,CACtBzC,KAAM3rB,KAAK2rB,KACX5T,SAAU/X,KAAK+X,SACftI,KAAMzP,KAAKyP,KACXgI,QAASzX,KAAKyX,SACZzX,KAAKquB,YAvCVlsB,EAAAisB,EAAA,CAAA,CAAA3tB,IAAA,KAAA8D,IAAA,WAqBE,OAAOvE,KAAK+X,WAAa/X,KAAKquB,cArBhCD,EAAA,GA2CqBQ,GAAAA,SAAAA,GpBwtHnB,SAASA,IACP,OAAOtiB,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAewrB,EAAoBtiB,GAMnC,IAAIuiB,EAAUD,EAAmBrsB,UAgQjC,OA9PAssB,EoB5tHDtiB,OAAA,WAAS,IAAAtI,EAAAjE,KACFL,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCwH,QAAS,OAEOzX,KAAKuW,SAAW5W,EAAK4W,SA+BtC,GA9BA5W,EAAK6W,SAASjE,KACbkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAACY,GAEZ1S,EAAK6qB,aAAanY,GAClB1S,EAAKsR,iBAEN4C,EAAaE,OAAO9F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAX,OAGZoC,EAAeS,KAAK1F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA0B,GAEX,OAAQA,EAAQnH,MACf,KAAK2O,GACJhb,EAAK8qB,YAAY,IAAIX,GAAY3W,EAASU,EAAa/C,MAAM6F,IAAK9C,EAAa/C,MAAM3F,OACrF,MACD,KAAKwP,GACJhb,EAAK+qB,YAAYvX,GACjB,MACD,KAAKwH,GACJhb,EAAKgrB,UAAUxX,OAIlBzX,KAAKyrB,SAAW,GAChBzrB,KAAKkvB,gBAAkB,GACnBlvB,KAAKmvB,KAAM,CAEd,IAAM1D,EAAWmD,EAAmBQ,cAAc/f,KAAI,SAAAC,GAAC,OAAI,IAAI8e,GAAY9e,EAAG6I,EAAa/C,MAAM6F,IAAK9C,EAAa/C,MAAM3F,SACzHzP,KAAKqvB,eAAe5D,GACpBjU,EAAeI,IAAIrF,KAClBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA0B,GAGX,OAFAA,EAAQM,SAAWN,EAAQM,UAAYI,EAAa/C,MAAM6F,IAElDxD,EAAQnH,MACf,KAAK2O,GACJ,MACD,KAAKA,GAGL,KAAKA,GACJzH,EAAeQ,IAAIP,WAKhB,CACN,IAAM6X,EAAQtvB,KAAKsvB,MAAQrP,GAAa0B,eACpC2N,GACHA,EAAMxD,uBAAuBvZ,KAC5BuD,EAAAA,SACCC,WAAU,SAAA0V,GACXA,EAAWA,EAASpc,KAAI,SAAAC,GAAC,OAAI,IAAI8e,GAAY9e,EAAG6I,EAAa/C,MAAM6F,IAAK9C,EAAa/C,MAAM3F,SAE3FxL,EAAKorB,eAAe5D,QpBsuHvBoD,EoBhuHDU,OAAA,apBmuHCV,EoB/tHDW,UAAA,apBkuHCX,EoB9tHDlZ,SAAA,WACC,IAAM8B,EAAUzX,KAAKyvB,cAAczvB,KAAKL,KAAKiB,MAAM6W,SACnDzX,KAAK8pB,YAAYrS,GACjBzX,KAAKL,KAAK4E,IAAI,WAAW3D,MAAQ,KAC7BZ,KAAKmvB,MACRnvB,KAAK0vB,iBpBmuHNb,EoB/tHDY,cAAA,SAAcrd,GAEb,OADgB,IAAIgc,GAAYhc,EAAM+F,EAAa/C,MAAM6F,IAAK9C,EAAa/C,MAAM3F,OpBmuHjFof,EoB/tHD/E,YAAA,SAAYrS,GACXzX,KAAK+uB,YAAYtX,GACjB,IAAM6X,EAAQtvB,KAAKsvB,MACfA,GACHA,EAAM9D,6BAA6B,CAAC/T,EAAQiX,eAAenc,KAC1DuD,EAAAA,SACCC,YAEHyB,EAAe+T,KAAK9T,IpBkuHpBoX,EoB/tHDc,QAAA,SAAQhX,GACP3Y,KAAKsiB,MAAMrO,QpBkuHX4a,EoB/tHDe,eAAA,WAAiB,IAEVC,EADWljB,EAAAA,WAAW3M,MAApB0M,KACgB5H,cAAc,sBACtC+qB,EAAWC,UAAYD,EAAWE,cpBouHlClB,EoBjuHDE,YAAA,SAAYtX,GACX,IAAMgU,EAAWzrB,KAAKyrB,SAAWzrB,KAAKyrB,SAAS3a,QAAU,GACzD9Q,KAAKgwB,aAAa,CAAE1f,KAAM2O,GAA6BlH,SAAUN,EAAQM,UAAY/X,KAAKyrB,UAC1FA,EAAStoB,KAAKsU,GACdzX,KAAKqvB,eAAe5D,IpBuuHpBoD,EoBpuHDG,YAAA,SAAYvX,GAEX,IAAMgU,EAAWzrB,KAAKyrB,SAAWzrB,KAAKyrB,SAAS3a,QAAU,GACzD2a,EAAStoB,KAAKsU,GACdzX,KAAKqvB,eAAe5D,IpBuuHpBoD,EoBpuHDI,UAAA,SAAUxX,GAET,IAAMgU,EAAWzrB,KAAKyrB,SAAWzrB,KAAKyrB,SAAS3a,QAAU,GACzD9Q,KAAKgwB,aAAa,CAAE1f,KAAM2O,GAA6BlH,SAAUN,EAAQM,UAAY0T,GACrFzrB,KAAKqvB,eAAe5D,IpB0uHpBoD,EoBvuHDmB,aAAA,SAAavY,EAASgU,EAAUwE,QAAkB,IAAlBA,IAAAA,GAAY,GAC3C,IAAM/mB,EAAQuiB,EAASvb,QAAO,SAACC,EAAEC,EAAEzO,GAClC,OAAQyO,EAAEE,OAASmH,EAAQnH,MAAQF,EAAE2H,WAAaN,EAAQM,SAAYpW,EAAIwO,KACvE,GAOJ,OANe,IAAXjH,IACHuiB,EAAS9N,OAAOzU,EAAO,IACL,IAAd+mB,GACHjwB,KAAKgwB,aAAavY,EAASgU,GAAU,IAGhCviB,GpBivHP2lB,EoB9uHDC,aAAA,SAAanY,GACZ,IAAMuZ,EAAWvZ,EAAQc,SAAWd,EAAQc,QAAQ7V,OAAS,EAEzD5B,KAAKmwB,WAAaD,IACrBlwB,KAAKmwB,SAAWD,EACZA,EACH1Y,EAAe+T,KAAK,CAAEjb,KAAM2O,KAE5BzH,EAAe+T,KAAK,CAAEjb,KAAM2O,OpBwvH9B4P,EoBnvHDQ,eAAA,SAAe5D,GAAU,IAAAjX,EAAAxU,KACxBA,KAAKyrB,SAAWA,EAEfzrB,KAAKkvB,gBAAkB,GACvBlvB,KAAKuV,cAEN,IAAM2Z,EAAkB,GACxBzD,EAASvnB,SAAQ,SAAAuT,GAChB,GAAIA,EAAQnH,OAAS2O,GAAyB,CAE7C,IAAMmR,EAAclB,EAAgBttB,OAASstB,EAAgBA,EAAgBttB,OAAS,GAAK,KACvFwuB,GAAeA,EAAYrY,WAAaN,EAAQM,SACnDqY,EAAY3Y,SAAZ,SAAgCA,EAAQA,QAExCyX,EAAgB/rB,KAAKsU,EAAQkX,gBAExB,GAAIlX,EAAQnH,OAAS2O,GAA6B,CAExD,IAAMmR,EAAclB,EAAgBhf,QAAO,SAACC,EAAGC,EAAGzO,GACjD,OAAQyO,EAAE2H,WAAaN,EAAQM,SAAY3H,EAAID,IAC7C,MACCigB,IACHA,EAAYC,QAAS,OAKxBvN,YAAW,WACVtO,EAAK0a,gBAAkBA,EACvB1a,EAAKe,cAELuN,YAAW,WACVtO,EAAKob,mBACH,KACD,IpB8vHHf,EoB3vHDtX,QAAA,WACC,IAAMA,EAAUvX,KAAKL,KAAKyX,MAC1B,OAAOG,GAAWvX,KAAKL,KAAKiB,MAAM6W,SAAWzX,KAAKL,KAAKiB,MAAM6W,QAAQ7V,OAAS,GpB+vH9EitB,EoB1vHDa,cAAA,WAAgB,IAAA/a,EAAA3U,KACf8iB,YAAW,WACV,IAAMrL,EAAU9C,EAAK2b,sBACrB3b,EAAKmV,YAAYrS,KACW,KAAzB,EAAoB,EAAhB+C,KAAKqK,YpBgwHbgK,EoB7vHDyB,oBAAA,SAAoBle,GAOnB,OANgB,IAAIgc,GAAY,CAC/BzC,KAAM7G,KAAKC,MACXhN,SAAU,uCACVtI,KAAM,mBACNgI,QAAS,qBACPU,EAAa/C,MAAM6F,IAAK9C,EAAa/C,MAAM3F,OpBiwHvCmf,EoB59HYA,CAA2B7hB,EAAAA,WAgOhD6hB,GAAmB5hB,KAAO,CACzBC,SAAU,eACVsjB,QAAS,CAAC,SACVrf,OAAQ,CAAC,SAGV0d,GAAmBQ,YAAc,WA2HhC,IA1HA,IAAI3D,EAAW,CACd,CACCE,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,uCACXM,SAAY,oBAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,sCACXM,SAAY,oBAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,kCACXM,SAAY,wCAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,qCACXM,SAAY,oBAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,uCACXM,SAAY,oBAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,+BACXM,SAAY,oBAEb,CACC4T,KAAQ,YACRlc,KAAQ,gBACRgI,QAAW,yCACXM,SAAY,wCAEb,CACC4T,KAAQ,WACRlc,KAAQ,qBACRgI,QAAW,2BACXM,SAAY,wCAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,0CACXM,SAAY,oBAEb,CACC4T,KAAQ,YACRlc,KAAQ,eACRgI,QAAW,iCACXM,SAAY,wCAEb,CACC4T,KAAQ,YACRlc,KAAQ,oBACRgI,QAAW,oCACXM,SAAY,wCAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,8BACXM,SAAY,oBAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,yCACXM,SAAY,oBAEb,CACC4T,KAAQ,YACRlc,KAAQ,kBACRgI,QAAW,oDACXM,SAAY,wCAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,kCACXM,SAAY,oBAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,mCACXM,SAAY,oBAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,qCACXM,SAAY,oBAEb,CACC4T,KAAQ,WACRlc,KAAQ,iBACRgI,QAAW,oCACXM,SAAY,oBAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,2CACXM,SAAY,wCAEb,CACC4T,KAAQ,YACRlc,KAAQ,iBACRgI,QAAW,uCACXM,SAAY,qBAGP0T,EAAS7pB,OAAS,KACxB6pB,EAAWA,EAAS+E,OAAO/E,GAG5B,OAAOA,EAAS3a,MAAM,EAAG,IA/H1B,ICxRqB2f,GAAAA,SAAAA,GrBsoInB,SAASA,IACP,OAAOnkB,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAG9C,OANAoD,EAAeqtB,EAAqBnkB,GAM7BmkB,EqB1oIYA,CAA4B1jB,EAAAA,WAEjD0jB,GAAoBzjB,KAAO,CAC1BC,SAAU,gBACViE,OAAQ,CAAC,SACT3H,SAAQ,uzBCNF,IAAMmnB,GACH,UADGA,GAEP,MAFOA,GAGH,UAHGA,GAIE,eAJFA,GAKD,YAGCC,GAAb,WAAA,SAAAA,KAAA,OAAAA,EAmBQC,kBAAP,WACC,IAAMnb,EAAYD,UAAUC,WAAaD,UAAUqb,QAAUpsB,OAAOqsB,MAEpE,MAAI,iBAAiBpb,KAAKD,GAClBib,GAEJ,WAAWhb,KAAKD,GACZib,GAIJ1wB,KAAK+wB,MACDL,GAEJ1wB,KAAKgxB,YACDN,GAEDA,IApCTvuB,EAAAwuB,EAAA,KAAA,CAAA,CAAAlwB,IAAA,WAAA8D,IAAA,WAME,OAHKvE,KAAKixB,YACTjxB,KAAKixB,UAAYjxB,KAAK4wB,qBAEhB5wB,KAAKixB,YANd,CAAAxwB,IAAA,QAAA8D,IAAA,WAUE,OAA2H,IAApH,CAAC,iBAAkB,mBAAoB,iBAAkB,OAAQ,SAAU,QAAQW,QAAQsQ,UAAU0b,YAE/D,IAAxC1b,UAAUC,UAAUvQ,QAAQ,QAAiB,eAAgBL,WAZpE,CAAApE,IAAA,cAAA8D,IAAA,WAgBE,OAA8C,IAAvCiR,UAAUC,UAAUvQ,QAAQ,QAA0D,IAA1CsQ,UAAUC,UAAUvQ,QAAQ,WAA8D,IAA3CsQ,UAAUC,UAAUvQ,QAAQ,cAhBhIyrB,EAAA,GCTqBQ,GAAAA,WvB8sInB,SAASA,KA2ET,OAzEAA,EuB9sIMjY,OAAP,SAAczJ,GACTzP,KAAKoxB,2BACR3sB,OAAO4sB,aAAahY,WAAW5J,IvBktIhC0hB,EuB9sIM7X,MAAP,SAAa7J,GACZ,GAAIzP,KAAKoxB,0BACR,YAAqC7vB,IAA9BkD,OAAO4sB,aAAa5hB,IvBktI5B0hB,EuB9sIM5sB,IAAP,SAAWkL,GACV,IAAI7O,EAAQ,KACZ,GAAIZ,KAAKoxB,gCAA2D7vB,IAA9BkD,OAAO4sB,aAAa5hB,GACzD,IACC7O,EAAQqL,KAAKC,MAAMzH,OAAO4sB,aAAa5hB,IACtC,MAAO8J,GACR9S,QAAQC,IAAI,wCAAyC+I,EAAM8J,GAG7D,OAAO3Y,GvBmtIPuwB,EuBhtIM3qB,IAAP,SAAWiJ,EAAM7O,GAChB,GAAIZ,KAAKoxB,0BACR,IACC,IAAM5X,EAAQ,GACRzN,EAAOE,KAAKE,UAAUvL,GAAO,SAASH,EAAKG,GAChD,GAAqB,iBAAVA,GAAgC,OAAVA,EAAgB,CAChD,IAA8B,IAA1B4Y,EAAMtU,QAAQtE,GAEjB,OAED4Y,EAAMrW,KAAKvC,GAEZ,OAAOA,KAER6D,OAAO4sB,aAAa5X,QAAQhK,EAAM1D,GACjC,MAAOwN,GACR9S,QAAQC,IAAI,4CAA6C+I,EAAM7O,EAAO2Y,KvButIxE4X,EuBltIMC,wBAAP,WACC,GAAIpxB,KAAK0Z,UACR,OAAO,EAER,IAAIA,GAAY,EAChB,KACCA,EAAY,iBAAkBjV,QAAkC,OAAxBA,OAAO4sB,eAE9C5sB,OAAO4sB,aAAa5X,QAAQ,OAAQ,KACpChV,OAAO4sB,aAAahY,WAAW,SAE/BK,GAAY,EAEZ,MAAOH,GACRG,GAAY,EAGb,OADA1Z,KAAK0Z,UAAYA,EACVA,GvBytIAyX,EuBzxIYA,GCSfG,GAAU,IAEKC,GAAAA,SAAAA,GxBoxInB,SAASA,IACP,OAAOjlB,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAemuB,EAAyBjlB,GAMxC,IAAI5G,EAAS6rB,EAAwBhvB,UAwPrC,OAtPAmD,EwBxxID6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKkxB,SAAWP,GAAcO,SAC9BlxB,KAAKwxB,UAAY,GACjBxxB,KAAKyxB,OAAS,GACdzxB,KAAKoV,MAAQ,GACbpV,KAAK0xB,MAAO,EACZ1xB,KAAK2xB,oBAAqB,EAC1BR,GAAoB3qB,IAAI,aAAa,GACrC2R,EAAaE,OAAO9F,KACnBuD,EAAAA,SACCC,WAAU,SAAAX,GACX3O,QAAQC,IAAI,0BAA2B0O,GACvCnR,EAAKmR,MAAQA,EACTA,EAAMyF,OAASxH,EAASI,SAC3BxP,EAAK0tB,oBAAqB,GAE3B1tB,EAAKsR,cACLuN,YAAW,WACV7e,EAAK2tB,iBACH,SxBgyIJlsB,EwB5xIDksB,aAAA,WAAe,IAAApd,EAAAxU,KACR6xB,EAAUrP,SAASsP,0BACzB9xB,KAAKwxB,UAAUK,QAAUA,EACrBA,EACH/O,YAAW,WACVtO,EAAKud,eACHT,KAEHtxB,KAAKyxB,OAAOI,QAAU9iB,EAAUE,UAAU,uBAC1CjP,KAAK+xB,YAAW,GAChB/xB,KAAKgyB,YAAW,GAChBhyB,KAAKiyB,YAAW,GAChBjyB,KAAKkyB,UAAS,GACdlyB,KAAKmyB,UAAS,IAEfnyB,KAAKuV,exBmyIL7P,EwBhyIDqsB,WAAA,SAAWK,GAAM,IAAAzd,EAAA3U,KACVqyB,EAAqC,WAA7B5tB,OAAOC,SAAS4tB,SAC9BtyB,KAAKwxB,UAAUa,MAAQA,EACnBD,EACEC,IACJryB,KAAKyxB,OAAOY,MAAQtjB,EAAUE,UAAU,sBAE/BojB,GACVvP,YAAW,WACNnO,EAAKgd,mBACRhd,EAAKqd,aAELrd,EAAKud,aAEJZ,IACHtxB,KAAKuV,gBAELvV,KAAKyxB,OAAOY,MAAQtjB,EAAUE,UAAU,qBACxCjP,KAAKgyB,YAAW,GAChBhyB,KAAKiyB,YAAW,GAChBjyB,KAAKkyB,UAAS,GACdlyB,KAAKmyB,UAAS,GACdnyB,KAAKuV,gBxBuyIN7P,EwBnyIDssB,WAAA,SAAWI,GAAM,IAAAvd,EAAA7U,KACZoyB,EACHpyB,KAAKwxB,UAAUxP,OAAQ,EAEvB/B,GAAamC,aAAaphB,MAAK,SAACsgB,GAE/B,IAAMiR,EAAajR,EAAQhE,MAAK,SAAAhO,GAAC,MAAe,eAAXA,EAAEyS,MAAyBzS,EAAEwS,YAClEjN,EAAK2c,UAAUxP,MAAsB,MAAduQ,EACvB1d,EAAKU,cACLuN,YAAW,WACVjO,EAAKod,eACHX,OACD9U,OAAM,SAAC3b,GACTgU,EAAK2c,UAAUxP,OAAQ,EACvBnN,EAAK4c,OAAOzP,MAAQnhB,EACpBgU,EAAKU,cACLuN,YAAW,WACVjO,EAAKod,eACHX,QxBk0IL5rB,EwB3yIDusB,WAAA,SAAWG,GAAM,IAAArd,EAAA/U,KACZoyB,EACHpyB,KAAKwxB,UAAUppB,OAAQ,EAEvB6X,GAAamC,aAAaphB,MAAK,SAACsgB,GAE/B,IAAMkR,EAAalR,EAAQhE,MAAK,SAAAhO,GAAC,MAAe,eAAXA,EAAEyS,MAAyBzS,EAAEwS,YAClE/M,EAAKyc,UAAUppB,MAAsB,MAAdoqB,EACvB1P,YAAW,WACV/N,EAAKmd,aACHZ,IACHvc,EAAKQ,iBACHiH,OAAM,SAAC3b,GACTkU,EAAKyc,UAAUppB,OAAQ,EACvB2M,EAAK0c,OAAOrpB,MAAQvH,EACpBiiB,YAAW,WACV/N,EAAKmd,aACHZ,IACHvc,EAAKQ,kBxBw0IP7P,EwBjzIDwsB,SAAA,SAASE,GAAM,IAAAtL,EAAA9mB,KACVoyB,EACHpyB,KAAKwxB,UAAUiB,KAAM,EAErBxS,GAAa2N,qBAAqB5sB,MAAK,SAAAia,GACtC6L,EAAK0K,UAAUiB,KAAM,EACrB3L,EAAKvR,cACLuN,YAAW,WACVgE,EAAKqL,UAAS,EAAOlX,KACnBqW,OACD9U,OAAM,SAAC3b,GACTimB,EAAK0K,UAAUiB,KAAM,EACrB3L,EAAK2K,OAAOgB,IAAM5xB,EAClBimB,EAAKqL,UAAS,GACdrL,EAAKvR,kBxB4zIP7P,EwBvzIDysB,SAAA,SAASC,EAAMnX,GAAK,IAAAkM,EAAAnnB,KACfoyB,GACHpyB,KAAKwxB,UAAUkB,KAAM,EACrB1yB,KAAK2yB,cAEL1S,GAAa8N,mBAAmB9S,GAAKja,MAAK,SAAA4xB,GACzCzL,EAAKqK,UAAUkB,KAAM,KACnBlW,OAAM,SAAC3b,GACTsmB,EAAKqK,UAAUkB,KAAM,EACrBvL,EAAKsK,OAAOiB,IAAM7xB,KAChBitB,SAAQ,WACV3G,EAAKwL,iBxB8zIPjtB,EwBzzIDitB,WAAA,WAAa,IAAAnL,EAAAxnB,KACZyG,QAAQC,IAAI,sCACZ,IAAM0e,EAAUnjB,OAAOY,KAAK7C,KAAKwxB,WAAWthB,QAAO,SAACC,EAAGC,GACtD,OAAOD,GAAKqX,EAAKgK,UAAUphB,MACzB,GACHpQ,KAAKwxB,UAAUpM,QAAUA,EACzBplB,KAAKwxB,UAAU3wB,OAASukB,EACxBplB,KAAK0xB,MAAO,EACZ1xB,KAAKuV,cACDH,MAAMyF,OAASxH,EAASK,aAC3B1T,KAAK6yB,UxBg0INntB,EwB5zIDmtB,OAAA,WACK7yB,KAAKwxB,UAAUpM,SAClB+L,GAAoB3qB,IAAI,aAAa,GAEtCxG,KAAK8yB,QAAQ7e,KAAKjU,KAAKwxB,YxBg0IvB9rB,EwB7zIDqtB,UAAA,WACCtuB,OAAOC,SAAS6B,KAAO9B,OAAOC,SAAS6B,KAAKH,QAAQ,UAAW,YAAYA,QAAQ,QAAS,UxBg0IrFmrB,EwBhhJYA,CAAgCxkB,EAAAA,WAoNrDwkB,GAAwBvkB,KAAO,CAC9BC,SAAU,oBACVsjB,QAAS,CAAC,YAFX,IC1NqByC,GAAAA,WzB4hJnB,SAASA,KAwST,OAtSAA,EyBx/IMC,UAAP,SAAiBC,GAChB,IAAMzyB,EAAMyyB,aAA2BC,YAAcD,EAAgBliB,GAAKkiB,EAS1E,OARKlzB,KAAKozB,SAAS3yB,KACdyyB,aAA2BC,YAC9BnzB,KAAKozB,SAAS3yB,GAAOT,KAAKqzB,QAAQC,wBAAwBJ,EAAgBK,SAE1EvzB,KAAKozB,SAAS3yB,GAAOT,KAAKqzB,QAAQG,yBAAyBN,IAItDlzB,KAAKozB,SAAS3yB,IzB6/IrBuyB,EyB1/IMS,aAAP,SAAoBP,GACnB,IAAMzyB,EAAMyyB,aAA2BC,YAAcD,EAAgBliB,GAAKkiB,EAC1E,OAAOlzB,KAAK0zB,gBAAgBjzB,IzB6/I5BuyB,EyB1/IMU,gBAAP,SAAuBjzB,GAEtB,IAAIuD,EAeJ,OAdIhE,KAAKozB,SAAS3yB,KACjBuD,EAAShE,KAAKozB,SAAS3yB,GAOnBT,KAAK2zB,UACR3vB,EAAO4vB,WAAW5zB,KAAK2zB,UAExB3vB,EAAO4vB,oBACA5zB,KAAKozB,SAAS3yB,IAEfuD,GzBigJPgvB,EyB9/IMa,WAAP,SAAkBX,EAAiBY,GAAc,IAAA7vB,EAAAjE,KAChD,QADgD,IAAd8zB,IAAAA,EAAU,IACxCA,EAAU,GAAM,EACnB,MAAoDA,EAErD,IAAM1e,EAAQ,IAAI2e,WAAWD,EAAU,GAEvC,GADgB9zB,KAAKqzB,QACR,CACZ,IAAMM,EAAW3zB,KAAK2zB,SACtB,GAAIA,EAKHA,EAASG,QAAUA,EAEJ9zB,KAAKizB,UAAUC,GAGvBc,QAAQL,GAEhB,IAAMtb,EAAS,IAAInD,EAAAA,gBAAgBE,GACnC,OAAO4d,EAAmBiB,OAAO1hB,KAChC2hB,EAAAA,eAAe7b,GACfhJ,EAAAA,KAAI,SAAA8kB,GAAwBA,EAAA,GAAA,IAAX/e,EAAW+e,EAAA,GAc3B,OAbIR,GAEHA,EAASS,qBAAqBhf,GAWxBA,KAERX,EAAAA,KAAI,SAACW,GAAD,OAAWiD,EAAOpE,KAAKmB,MAC3Bif,EAAAA,UAAS,WACRpwB,EAAKwvB,aAAaP,OAIpB,OAAO9e,EAAAA,GAAGgB,IzB+gJX4d,EyB1gJMsB,QAAP,SAAepB,GAAiB,IAAA1e,EAAAxU,KACzBoV,EAAQ,CAAEmf,OAAQ,EAAGC,SAAS,GAGpC,GAFgBx0B,KAAKqzB,QAER,CACZ,IAAMrvB,EAAShE,KAAKizB,UAAUC,GACxBuB,EAAQzB,EAAmB0B,mBACjC1wB,EAAOgwB,QAAQS,GACf,IAAMpc,EAAS,IAAInD,EAAAA,gBAAgBE,GACnC,OAAO4d,EAAmBiB,OAAO1hB,KAChC2hB,EAAAA,eAAe7b,GACfhJ,EAAAA,KAAI,SAAAslB,GAAwBA,EAAA,GAAA,IAAXvf,EAAWuf,EAAA,GAG3B,OAFAvf,EAAMof,QAAUC,EAAMG,gBACtBxf,EAAMmf,OAASE,EAAMF,OACdnf,KAERX,EAAAA,KAAI,SAACW,GAAD,OAAWiD,EAAOpE,KAAKmB,MAC3Bif,EAAAA,UAAS,WACR7f,EAAKif,aAAaP,OAIpB,OAAO9e,EAAAA,GAAGgB,IzBmhJX4d,EyB9gJM0B,iBAAP,SAAwBG,EAAkBC,EAAkBC,QAAe,IAAnDF,IAAAA,EAAY,UAAuC,IAAjCC,IAAAA,EAAY,UAAqB,IAAfC,IAAAA,EAAU,KACrE,IAAM1B,EAAUrzB,KAAKqzB,QACrB,GAAIA,EAAS,CACZ,IAAM2B,EAAY3B,EAAQ4B,sBAAsB,KAahD,OAZAD,EAAUE,eAAiBl1B,KAAKm1B,kBAChCH,EAAUJ,cAAgB50B,KAAKo1B,eAC/BJ,EAAUK,QAAUr1B,KAAKs1B,kBACzBN,EAAUO,UAAW,EACrBP,EAAUQ,SAAW,EACrBR,EAAUT,OAAS,EACnBS,EAAUH,UAAYA,EACtBG,EAAUF,UAAYA,EACtBE,EAAUD,QAAUA,EAGpBC,EAAUhB,QAAQX,EAAQoC,aACnBT,IzB+hJRhC,EyB3hJMmC,kBAAP,SAAyBxc,GAOxB,IANA,IAGIrJ,EAHEomB,EAAS/c,EAAMgd,YAAYC,eAAe,GAC1CC,EAAeH,EAAO9zB,OACxBk0B,EAAM,EAIDn0B,EAAI,EAAGA,EAAIk0B,EAAcl0B,IACjC2N,EAAIomB,EAAO/zB,GACP6Y,KAAKub,IAAIzmB,IAAMtP,KAAK60B,YACvB70B,KAAKu1B,UAAW,EAChBv1B,KAAKw1B,SAAW/wB,OAAOuxB,YAAYjR,OAEpC+Q,GAAOxmB,EAAIA,EAIZ,IAAM2mB,EAAMzb,KAAK0b,KAAKJ,EAAMD,GAK5B71B,KAAKu0B,OAAS/Z,KAAKC,IAAIwb,EAAKj2B,KAAKu0B,OAASv0B,KAAK80B,YzB8hJ/C9B,EyB3hJMoC,eAAP,WACC,QAAKp1B,KAAKu1B,WAGLv1B,KAAKw1B,SAAWx1B,KAAK+0B,QAAWtwB,OAAOuxB,YAAYjR,QACvD/kB,KAAKu1B,UAAW,GAEVv1B,KAAKu1B,WzBgiJZvC,EyB7hJMsC,kBAAP,WACCt1B,KAAK4zB,aACL5zB,KAAKk1B,eAAiB,MzBgiJtBlC,EyB7hJMmD,MAAP,SAAaC,GAMZ,OAAOC,EAAAA,WAAW9yB,QAAO,SAAC+yB,GACzBC,uBAAsB,SAACC,GAEtB,IAAMC,EAAYL,GAAYI,EAAYJ,EAASI,WAAa,IAAO,EACvEF,EAASriB,KAAK,CACbuiB,UAAAA,EACAC,UAAAA,UAGAlkB,KACFlD,EAAAA,KAAI,SAAAqnB,GAIH,OAHIA,EAAMD,UAAa,EAAI,KAC1BC,EAAMD,UAAY,EAAI,IAEhBC,OzBiiJT1D,EyB5hJMqC,QAAP,WAAiB,IAAA1gB,EAAA3U,KAChBiC,OAAOY,KAAK7C,KAAKozB,UAAUlvB,SAAQ,SAAAzD,GAClCkU,EAAK+e,gBAAgBjzB,MAEtB,IAAMkzB,EAAW3zB,KAAK2zB,SAClBA,GACHA,EAASC,aAEV5zB,KAAKozB,SAAW,IzBoiJhBjxB,EAAa6wB,EAAoB,KAAM,CAAC,CACtCvyB,IAAK,UACL8D,IAAK,WyBtxJP,OAHKvE,KAAK22B,UAAY,iBAAkBlyB,SACvCzE,KAAK22B,SAAW,IAAIC,cAEd52B,KAAK22B,WzB+yJT,CACDl2B,IAAK,WACL8D,IAAK,WyB3xJP,IAAKvE,KAAK62B,UACT,IACC72B,KAAK62B,UAAY72B,KAAKqzB,QAAQyD,iBAC7B,MAAMj2B,GACP4F,QAAQC,IAAI,8BAA+B7F,GAG7C,OAAOb,KAAK62B,czBiyJL7D,EyBp0JYA,GA6PrBA,GAAmBI,SAAW,GAC9BJ,GAAmBiB,OAAS7f,EAAAA,QAAG7S,GAAWgR,KACzCwkB,EAAAA,QAAO,SAACn2B,GAAD,OAAWoyB,GAAmBmD,MAAMv1B,MAG3CoC,EAAAA,QAAO,SAAA0zB,GAAK,YAAcn1B,IAAVm1B,KAChBrnB,EAAAA,KAAI,SAAAqnB,GAAK,OAAIA,EAAMD,aACnBO,EAAAA,SAND,IC5PqBC,GAAAA,SAAAA,G1Bg1JnB,SAASA,IACP,OAAO3qB,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe6zB,EAA6B3qB,GAM5C,IAAI5G,EAASuxB,EAA4B10B,UA0LzC,OAxLAmD,E0BlzJD6G,OAAA,WACCvM,KAAK0iB,Q1BqzJLhd,E0BlzJDgd,KAAA,WACC,IAAI1iB,KAAKk3B,aAAT,CAGAl3B,KAAKk3B,cAAe,EACpBl3B,KAAKkxB,SAAWP,GAAcO,SALxB,IAMExkB,EAASC,EAAAA,WAAW3M,MAApB0M,KACR1M,KAAKm3B,iBAAmBn3B,KAAKm3B,iBAAiB7W,KAAKtgB,OACnCA,KAAKo3B,QAAU1qB,EAAK5H,cAAc,UAC1CuyB,iBAAiB,iBAAkBr3B,KAAKm3B,kBAChD,IAAMnV,EAAQtV,EAAK5H,cAAc,UACjC,GAAI9E,KAAKs3B,WACKt3B,KAAKu3B,KAAO,IAAIpzB,MAAM,IAAIqzB,KAAK,GAAGnoB,KAAI,SAAAC,GAClD,IAAMmoB,EAAM5yB,SAAS0W,cAAc,OAGnC,OAFAkc,EAAIrL,UAAUC,IAAI,OAClBrK,EAAMvG,YAAYgc,GACXA,O1B4zJT/xB,E0BvzJDgyB,UAAA,WACiB13B,KAAKo3B,QACbO,oBAAoB,iBAAkB33B,KAAKm3B,kBAC/Cn3B,KAAKs3B,YACRtE,GAAmBqC,W1B4zJpB3vB,E0BxzJDkyB,WAAA,WAAa,IAAA3zB,EAAAjE,KACNo3B,EAAUp3B,KAAKo3B,QACrB,GAAKp3B,KAAKo3B,QAIV,GAAIp3B,KAAK63B,QAAU73B,KAAK83B,QAGvB,GAAItiB,UAAU2F,cAAgB3F,UAAU2F,aAAaC,aAAc,CAClE,IACMqG,EAAU5C,EADF1G,EAAa/C,OAErBzP,EAAU,CACfyC,QAAOpI,KAAK63B,QAAS,CACpB/V,SAAU9hB,KAAK63B,OACfnc,MAAO,CAAEqc,MAAOtW,EAAQ/C,WAAWhD,OACnCC,OAAQ,CAAEoc,MAAOtW,EAAQ/C,WAAW/C,QACpCgD,UAAW,CAAEoZ,MAAOtW,EAAQ9C,UAAU5D,IAAKN,IAAKgH,EAAQ9C,UAAUlE,MAEnEuH,QAAOhiB,KAAK83B,QAAS,CAAEhW,SAAU9hB,KAAK83B,SAGvCtiB,UAAU2F,aAAaC,aAAazV,GAAS3E,MAAK,SAAC4a,GAC9C3X,EAAKqzB,YACJ,cAAeF,EAClBA,EAAQvb,UAAYD,EAEpBwb,EAAQtb,IAAMrX,OAAOsX,IAAIC,gBAAgBJ,GAEtC3X,EAAK6zB,QACR7zB,EAAK+zB,YAAYpc,GAElB3X,EAAKg0B,eAAiBrc,GAEtB3X,EAAK2X,OAAO3H,KAAK2H,MAEhBY,OAAM,SAAC3b,GACT4F,QAAQC,IAAI,+CAAgD7F,EAAM4O,KAAM5O,EAAM4W,SAC9ExT,EAAK2X,OAAO3H,KAAK,eAIfjU,KAAKs3B,aACJ,cAAeF,EAClBA,EAAQvb,UAAY,KAEpBub,EAAQtb,IAAM,KAEf9b,KAAKg4B,YAAY,OAElBh4B,KAAK4b,OAAO3H,KAAK,O1B80JlBvO,E0B10JDyxB,iBAAA,SAAiBxe,GAEChM,EAAAA,WAAW3M,MAApB0M,KACH0f,UAAUC,IAAI,SACnBrsB,KAAKo3B,QAAQ7a,OACbvc,KAAK4b,OAAO3H,KAAKjU,KAAKi4B,iB1B+0JtBvyB,E0B50JDsyB,YAAA,SAAYpc,GAAQ,IAAApH,EAAAxU,KACfA,KAAKk4B,uBACRl4B,KAAKk4B,sBAAsB/hB,cAGxByF,IACH5b,KAAKk4B,sBAAwBlF,GAAmBa,WAAWjY,EAAQ,IAAIrJ,KACtEkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAoiB,GAIE3jB,EAAK+iB,KACbrzB,SAAQ,SAACuzB,EAAK91B,GAClB,IAAMy2B,EAAM5d,KAAKO,IAAI,IAAM,EAAIod,EAAUx2B,IAAO,IAChD81B,EAAIY,MAAMC,KAJK,MAIE32B,EAAc,IAC/B81B,EAAIY,MAAMppB,UAAV,WAAiCmpB,EAAjC,IACAX,EAAIY,MAAME,QAAUH,U1Bm1JvBj2B,EAAa80B,EAA6B,CAAC,CACzCx2B,IAAK,QACL8D,IAAK,W0Bt+JP,OAAOvE,KAAK63B,Q1By+JVrxB,IAAK,S0Bt+JE4B,GACLpI,KAAK63B,SAAWzvB,IACnBpI,KAAK63B,OAASzvB,EACVpI,KAAKw4B,SACRx4B,KAAKw4B,OAAOvkB,OACZjU,KAAK0iB,OACL1iB,KAAK43B,iB1B2+JJ,CACDn3B,IAAK,QACL8D,IAAK,W0Bv+JP,OAAOvE,KAAK83B,Q1B0+JVtxB,IAAK,S0Bv+JEwb,GACLhiB,KAAK83B,SAAW9V,IACnBhiB,KAAK83B,OAAS9V,EACVhiB,KAAKw4B,SACRx4B,KAAKw4B,OAAOvkB,OACZjU,KAAK0iB,OACL1iB,KAAK43B,iB1B4+JJ,CACDn3B,IAAK,aACL8D,IAAK,W0Bx+JP,OAAOvE,KAAKkxB,WAAaR,IAAsB1wB,KAAKkxB,WAAaR,O1B6+J1DuG,E0B9gKYA,CAAoClqB,EAAAA,WA4JzDkqB,GAA4BjqB,KAAO,CAClCC,SAAU,yBACVsjB,QAAS,CAAC,SAAU,UACpBrf,OAAQ,CAAC,QAAS,UAHnB,IC3JqBunB,GAAAA,SAAAA,G3BshKnB,SAASA,IACP,OAAOnsB,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeq1B,EAAsBnsB,GAMrC,IAAI5G,EAAS+yB,EAAqBl2B,UAuHlC,OArHAmD,E2BthKD6G,OAAA,WAAS,IAAAtI,EAAAjE,KAOR,GANAA,KAAKkxB,SAAWP,GAAcO,SAC9BlxB,KAAK04B,QAAuC,WAA7Bj0B,OAAOC,SAAS4tB,SAC/BtyB,KAAKoV,MAAQ,GACbpV,KAAKshB,QAAU,CAAEC,OAAQ,GAAIC,OAAQ,IACrCxhB,KAAK4b,OAAS,KACd5b,KAAKL,KAAO,KACRK,KAAK04B,QAAS,CACjB,IAAMpJ,EAAQtvB,KAAKsvB,MAAQrP,GAAa0B,eACxCxJ,EAAaE,OAAO9F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAX,GAEXnR,EAAKmR,MAAQA,EACbnR,EAAKsR,iBAEF+Z,GACHA,EAAMrN,WAAWlM,WAAU,SAAAuL,GAE1Brd,EAAKqd,QAAUA,EACfrd,EAAK00B,SAASrX,GACdrd,EAAKsR,mB3BoiKR7P,E2B9hKDqtB,UAAA,SAAUpa,GACTlU,OAAOC,SAAS6B,KAAO9B,OAAOC,SAAS6B,KAAKH,QAAQ,UAAW,YAAYA,QAAQ,QAAS,U3BiiK5FV,E2B9hKDizB,SAAA,SAASrX,GAAS,IAAA9M,EAAAxU,KACXL,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtC7H,MAAO,IAAIyI,EAAAA,YAAY,KAAMyQ,EAAQC,OAAO3f,OAAS2O,EAAAA,WAAWE,yBAAsBlP,GACtFygB,MAAO,IAAInR,EAAAA,YAAY,KAAMyQ,EAAQE,OAAO5f,OAAS2O,EAAAA,WAAWE,yBAAsBlP,KAEjFgV,EAAWvW,KAAKuW,SAAW5W,EAAK4W,SAChCqiB,EAAetX,EAAQC,OAAOlS,KAAI,SAAAC,GACvC,MAAO,CACN0B,GAAI1B,EAAEwS,SACNrS,KAAMH,EAAE+G,UAGNuiB,EAAah3B,OAAS,GACzBg3B,EAAa7nB,QAAQ,CACpBC,GAAI,KAAMvB,KAAMV,EAAUE,UAAU,wBAGtCsH,EAASnO,MAAMzC,QAAUizB,EACzB,IAAMC,EAAevX,EAAQE,OAAOnS,KAAI,SAAAC,GACvC,MAAO,CACN0B,GAAI1B,EAAEwS,SACNrS,KAAMH,EAAE+G,UAGNwiB,EAAaj3B,OAAS,GACzBi3B,EAAa9nB,QAAQ,CACpBC,GAAI,KAAMvB,KAAMV,EAAUE,UAAU,wBAGtCsH,EAASyL,MAAMrc,QAAUkzB,EACzBl5B,EAAK6W,SAASjE,KACbkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAACY,GAEZnC,EAAKe,kB3BwiKN7P,E2BpiKDozB,kBAAA,SAAkBngB,GACjB3Y,KAAK4b,OAAS,KACd5b,KAAKuV,e3BuiKL7P,E2BpiKDqzB,SAAA,SAASnd,GACR5b,KAAK4b,OAASA,EACd5b,KAAKuV,e3BuiKL7P,E2BpiKD6R,QAAA,WACC,IAAMA,EAAUvX,KAAKL,KAAKyX,QAAUpX,KAAK4b,SAAW5b,KAAKs3B,YACzD,OAAO/f,G3BuiKP7R,E2BpiKDszB,QAAA,SAAQrgB,GACP,IAAMiK,EAAc5iB,KAAKL,KAAKiB,MACxB0gB,EAAUthB,KAAKshB,QACrBA,EAAQlZ,MAAQkZ,EAAQC,OAAOjE,MAAK,SAAAhO,GAAC,OAAIA,EAAEwS,WAAac,EAAYxa,SACpEkZ,EAAQU,MAAQV,EAAQE,OAAOlE,MAAK,SAAAhO,GAAC,OAAIA,EAAEwS,WAAac,EAAYZ,SACpEhiB,KAAKi5B,MAAMhlB,KAAKqN,I3B2iKhBnf,EAAas2B,EAAsB,CAAC,CAClCh4B,IAAK,aACL8D,IAAK,W2BzoKP,OAAOvE,KAAKkxB,WAAaR,IAAsB1wB,KAAKkxB,WAAaR,O3B8oK1D+H,E2BjpKYA,CAA6B1rB,EAAAA,WAoGlD0rB,GAAqBzrB,KAAO,CAC3BC,SAAU,iBACVsjB,QAAS,CAAC,UAFX,ICnGqB2I,GAAAA,SAAAA,G5BwpKnB,SAASA,IACP,OAAO5sB,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe81B,EAAoB5sB,GAMnC,IAAI5G,EAASwzB,EAAmB32B,UAkKhC,OAhKAmD,E4B5pKD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKoV,MAAQ,GACb,IAAMzV,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCxD,KAAM,IAAIoE,EAAAA,YAAY,KAAM,CAACN,EAAAA,WAAWI,iBAAiB,wBAAyBJ,EAAAA,WAAWE,sBAC7F0oB,aAAc,KACdC,aAAc,KACdC,WAAY,KACZC,gBAAiB,OAGDt5B,KAAKuW,SAAW5W,EAAK4W,SACtC5W,EAAK6W,SAASjE,KACbkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAACY,GAEZ1S,EAAKsR,iBAEN4C,EAAaE,OAAO9F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAX,GAEXnR,EAAKmR,MAAQA,EACbnR,EAAKsR,kB5B+pKN7P,E4B3pKD6zB,oBAAA,SAAoBC,GAEnB,IAAMC,GAAY,IAAI3U,MAAO4U,UAAUluB,WACvCxL,KAAKL,KAAKsX,MAAM,CACfxK,KAAMzM,KAAK25B,iBAAiBF,EAAWpmB,EAASC,WAChD6lB,aAAcn5B,KAAK25B,iBAAiBF,EAAWpmB,EAASE,UACxD6lB,aAAcp5B,KAAK25B,iBAAiBF,EAAWpmB,EAASG,UACxD6lB,WAAYr5B,KAAK25B,iBAAiBF,EAAWpmB,EAASI,QACtD6lB,gBAAiBt5B,KAAK25B,iBAAiBF,EAAWpmB,EAASK,gB5B+pK5DhO,E4B3pKDk0B,qBAAA,SAAqBC,EAAWhf,GAC/B,IAAMif,EAAaD,EAAUv0B,MAAM,KAEnC,OADAw0B,EAAW,GAAK95B,KAAK+5B,OAAO/5B,KAAKg6B,aAAanf,GAAO,GAC9Cif,EAAWvqB,KAAK,M5B8pKvB7J,E4B3pKDu0B,iBAAA,SAAiBT,GAAQ,IAAAhlB,EAAAxU,KAEA,cAApBA,KAAKoV,MAAMyF,MAGfiI,YAAW,WACV,GAAItO,EAAK7U,KAAK4E,IAAI,QAAQ6S,MAAO,CAChC,IAAMxW,EAAQ4T,EAAK7U,KAAK4E,IAAI,QAAQ3D,MACpC4T,EAAK7U,KAAKsX,MAAM,CACfxK,KAAM+H,EAAK0lB,iBAAiBt5B,EAAOyS,EAASC,WAC5C6lB,aAAc3kB,EAAK0lB,iBAAiBt5B,EAAOyS,EAASE,UACpD6lB,aAAc5kB,EAAK0lB,iBAAiBt5B,EAAOyS,EAASG,UACpD6lB,WAAY7kB,EAAK0lB,iBAAiBt5B,EAAOyS,EAASI,QAClD6lB,gBAAiB9kB,EAAK0lB,iBAAiBt5B,EAAOyS,EAASK,oBAGxDc,EAAK7U,KAAK4E,IAAI,gBAAgB2S,QAC9B1C,EAAK7U,KAAK4E,IAAI,gBAAgB2S,QAC9B1C,EAAK7U,KAAK4E,IAAI,cAAc2S,UAE3B,I5BoqKHxR,E4BjqKDw0B,iBAAA,SAAiBL,EAAWhf,GAC3B,IAAMsf,EAAoBN,EAAUv0B,MAAM,KAC1C,OAAU60B,EAAkB,GAA5B,IAAkCn6B,KAAK+5B,OAAO/5B,KAAKg6B,aAAanf,GAAO,GAAvE,IAA6Esf,EAAkB,I5BoqK/Fz0B,E4BjqKDi0B,iBAAA,SAAiBF,EAAW5e,GAC3B,OAAU7a,KAAK+5B,OAAO/5B,KAAKoV,MAAMrB,KAAK/C,GAAI,GAA1C,IAAgDhR,KAAK+5B,OAAO/5B,KAAKg6B,aAAanf,GAAO,GAArF,IAA2F4e,G5BoqK3F/zB,E4BjqKDs0B,aAAA,SAAanf,GACZ,OAAO5Y,OAAOY,KAAKwQ,GAAUnD,QAAO,SAACC,EAAGC,EAAGzO,GAC1C,OAAO0R,EAASjD,KAAOyK,EAAOlZ,EAAIwO,KAC/B,I5BoqKJzK,E4BjqKD00B,kBAAA,SAAkBP,EAAWQ,QAAsB,IAAtBA,IAAAA,GAAe,GAC3C,IAAMC,EAAQz1B,SAAS0W,cAAc,SACrC+e,EAAMjC,MAAMkC,SAAW,WACvBD,EAAMjC,MAAMmC,IAAM,SAElB31B,SAASC,cAAc,QAAQ2W,YAAY6e,GAC3CA,EAAM15B,MAAQy5B,EAAer6B,KAAKy6B,iBAAiBZ,GAAW,GAAQ75B,KAAK06B,OAAOb,GAAW,GAC7FS,EAAMK,QACNL,EAAM3sB,SACN2sB,EAAMM,kBAAkB,EAAG,OAC3B/1B,SAASg2B,YAAY,QACrBP,EAAMQ,WAAWC,YAAYT,GAC7BU,MAAK,mBAAoBV,EAAM15B,Q5BwqK/B8E,E4BrqKD6R,QAAA,WACC,IAAMA,EAAUvX,KAAKL,KAAKyX,MAC1B,OAAOG,G5BwqKP7R,E4BrqKDmtB,OAAA,SAAOla,GACN,IAAIkhB,EAAY75B,KAAKuW,SAAS9J,KAAK7L,MAMnCZ,KAAKi7B,WAAWpB,GAChB75B,KAAKyM,KAAKwH,KAAK4lB,I5ByqKfn0B,E4BtqKDg1B,OAAA,SAAOb,EAAWqB,QAAmB,IAAnBA,IAAAA,GAAY,GAC7B,IAAMrgB,EAAO3P,EAAgB3G,IAAI,SAAW,KACtCkL,EAAOvE,EAAgB3G,IAAI,SAAW,KAE5C,MADY,GAAGE,OAAOC,SAASyB,OAAS1B,OAAOC,SAASy2B,SAA5C,SAA6DtB,GAAepqB,EAAI,SAAYA,EAAS,KAAQoL,IAASqgB,EAAV,SAAgCrgB,EAAS,K5B8qKjKnV,E4B1qKD+0B,iBAAA,SAAiBZ,EAAWqB,QAAmB,IAAnBA,IAAAA,GAAY,GACvC,IAAMrgB,EAAO3P,EAAgB3G,IAAI,SAAW,KACtCkL,EAAOvE,EAAgB3G,IAAI,SAAW,KAE5C,MADY,GAAGE,OAAOC,SAASyB,OAAS4E,EAAYnF,IAAI0D,WAA5C,SAA+DuwB,GAAepqB,EAAI,SAAYA,EAAS,KAAQoL,IAASqgB,EAAV,SAAgCrgB,EAAS,K5BkrKnKnV,E4B9qKDu1B,WAAA,SAAWpB,GACV,GAAI,YAAap1B,OAAQ,CACxB,IAAMmB,EAAM5F,KAAK06B,OAAOb,GAExBp1B,OAAO4G,QAAQ+vB,aAAa,CAAEC,UAAa52B,OAAO42B,WAAa,GAAIz1B,K5BorKpEF,E4BhrKDq0B,OAAA,SAAOuB,EAAKxuB,GACX,IAAMyuB,EAAI,YAAcD,EACxB,OAAOC,EAAE/M,OAAO+M,EAAE35B,OAASkL,I5BmrKpBosB,E4B9zKYA,CAA2BnsB,EAAAA,WA+IhDmsB,GAAmBlsB,KAAO,CACzBC,SAAU,eACVsjB,QAAS,CAAC,SAFX,IChJqBiL,GAAAA,SAAAA,G7Bu0KnB,SAASA,IACP,OAAOlvB,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeo4B,EAAqBlvB,GAMpC,IAAI5G,EAAS81B,EAAoBj5B,UAsFjC,OApFAmD,E6B30KD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACFL,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtC2G,SAAU,IAAI/F,EAAAA,YAAY,KAAMN,EAAAA,WAAWE,qBAC3CoG,SAAU,IAAIhG,EAAAA,YAAY,KAAMN,EAAAA,WAAWE,qBAC3CqG,aAAcrS,OAAO6R,aAAe,GACpCS,WAAY,KAGI/W,KAAKuW,SAAW5W,EAAK4W,SAEtC5W,EAAK6W,SAASjE,KACbkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAACY,GACZ1S,EAAKsR,iBAGNvV,KAAKa,MAAQ,M7B20Kb6E,E6Bx0KDgQ,KAAA,WACC1V,KAAKL,KAAKsX,MAAM,CACfL,SAAU,YACVC,SAAU,YACVC,aAAcrS,OAAO6R,aAAe,GACpCS,WAAY,M7B40KbrR,E6Bx0KDwR,MAAA,WACClX,KAAKL,KAAKuX,S7B20KVxR,E6Bx0KDiQ,SAAA,WAAW,IAAAnB,EAAAxU,KACV,GAAIA,KAAKL,KAAKyX,MAAO,CACpB,IAAM7C,EAAUvU,KAAKL,KAAKiB,MAC1BZ,KAAKL,KAAK0X,WAAY,EACtBrX,KAAKa,MAAQ,KACbb,KAAKuV,cACL1B,EAAYS,OAAOC,GAAShC,KAC3BuD,EAAAA,SACCC,WAAU,SAAAhC,GACPoE,EAAa/C,MAAMyF,OAAS9G,EAAKzD,MAEpCkE,EAAKqe,OAAO9e,GACZS,EAAK7U,KAAKuX,UAEV1C,EAAK3T,MAAQ,CAAE46B,gBAAiB1sB,EAAUE,UAAU,sBACpDuF,EAAKe,kBAEJ,SAAA1U,GACF4F,QAAQC,IAAI,wBAAyB7F,GACrC2T,EAAK3T,MAAQA,EACb2T,EAAKe,sBAGNvV,KAAKL,KAAK2X,SAAU,G7Bi1KrB5R,E6B70KD6R,QAAA,WACC,IAAMA,EAAUvX,KAAKL,KAAKyX,MAC1B,OAAOG,G7Bg1KP7R,E6B70KDmtB,OAAA,SAAO9e,GACN/T,KAAKi7B,WAAWlnB,GAChB/T,KAAKulB,MAAMtR,KAAKF,I7Bg1KhBrO,E6B70KDu1B,WAAA,SAAWlnB,GACV,GAAI,YAAatP,OAAQ,CACxB,IAAMoW,EAAO3P,EAAgB3G,IAAI,SAAW,KACtCkI,EAAOvB,EAAgB3G,IAAI,SAAW,KACtCkL,EAAOvE,EAAgB3G,IAAI,UAAYwP,EAAK2nB,WAAa3nB,EAAK4nB,SAAc5nB,EAAK2nB,UAA1C,IAAuD3nB,EAAK4nB,SAAa,MAChH/1B,EAAM,GAAGnB,OAAOC,SAASyB,OAAS1B,OAAOC,SAASy2B,SAA5C,SAA6D1uB,GACrEgD,EAAI,SAAYA,EAAS,KACzBoL,EAAI,SAAYA,EAAS,IAE7BpW,OAAO4G,QAAQ+vB,aAAa,CAAEC,UAAa52B,OAAO42B,WAAa,GAAIz1B,K7Bi1K7D41B,E6Bj6KYA,CAA4BzuB,EAAAA,WAqFjDyuB,GAAoBxuB,KAAO,CAC1BC,SAAU,gBACVsjB,QAAS,CAAC,UAFX,ICtFqBqL,GAAAA,SAAAA,G9B06KnB,SAASA,IACP,OAAOtvB,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAew4B,EAAoBtvB,GAMnC,IAAI5G,EAASk2B,EAAmBr5B,UA6ChC,OA3CAmD,E8B/6KD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACFyP,EAAOvE,EAAgB3G,IAAI,SAAW,KAC5CvE,KAAKoV,MAAQ,GACb,IAAMzV,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCR,KAAM,IAAIoB,EAAAA,YAAYpB,EAAM,CAACc,EAAAA,WAAWI,iBAAiB,mBAAoBJ,EAAAA,WAAWE,wBAExEzQ,KAAKuW,SAAW5W,EAAK4W,SACtC5W,EAAK6W,SAASjE,KACbkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAACY,GAEZ1S,EAAKsR,iBAEN4C,EAAaE,OAAO9F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAX,GAEXnR,EAAKmR,MAAQA,EACbnR,EAAKsR,kB9Bk7KN7P,E8B96KD6R,QAAA,WACC,IAAMA,EAAUvX,KAAKL,KAAKyX,MAC1B,OAAOG,G9Bi7KP7R,E8B96KDmtB,OAAA,SAAOla,GACN3Y,KAAKi7B,aACLj7B,KAAKyP,KAAKwE,KAAKjU,KAAKuW,SAAS9G,KAAK7O,Q9Bi7KlC8E,E8B96KDu1B,WAAA,WACC,GAAI,YAAax2B,OAAQ,CACxB,IAAMoW,EAAO3P,EAAgB3G,IAAI,SAAW,KACtCkI,EAAOvB,EAAgB3G,IAAI,SAAW,KACtCqB,EAAM,GAAGnB,OAAOC,SAASyB,OAAS1B,OAAOC,SAASy2B,SAA5C,SAA6D1uB,EAA7D,SAA0EzM,KAAKuW,SAAS9G,KAAK7O,OAAWia,EAAI,SAAYA,EAAS,IAE7IpW,OAAO4G,QAAQ+vB,aAAa,CAAEC,UAAa52B,OAAO42B,WAAa,GAAIz1B,K9Bo7K7Dg2B,E8B39KYA,CAA2B7uB,EAAAA,WA4ChD6uB,GAAmB5uB,KAAO,CACzBC,SAAU,eACVsjB,QAAS,CAAC,SAFX,IC7CqBsL,GAAAA,SAAAA,G/Bo+KnB,SAASA,IACP,OAAOvvB,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAey4B,EAAsBvvB,GAMrC,IAAI5G,EAASm2B,EAAqBt5B,UA4MlC,OA1MAmD,E+Bv4KD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAK87B,YAAa,EAClB97B,KAAKipB,YAAa,EAClBjpB,KAAK+7B,wBAAyB,EAC9B/7B,KAAKoV,MAAQ,GACb+C,EAAaE,OAAO9F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAX,GACXnR,EAAKmR,MAAQA,EACbnR,EAAKsR,iBAGNiC,EAAeS,KAAK1F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA0B,GAEX,OAAQA,EAAQnH,MACf,KAAK2O,GACJ,IAAMtG,EAAQlB,EAAQkB,MAElB1U,EAAKmZ,UAAYzE,EAAMyE,WAAanZ,EAAKmZ,WACxCzE,aAAiB4G,KACpBtb,EAAK63B,YAAa,GAEfnjB,aAAiB8G,KACpBxb,EAAK63B,YAAa,GAEfnjB,aAAiBgH,KACpB1b,EAAKglB,YAAa,GAEftQ,aAAiBkH,KACpB5b,EAAKglB,YAAa,IAGpB,MACD,KAAKhK,GAEAhb,EAAKmZ,WAAa3F,EAAQM,WAC7B9T,EAAK+3B,YAAcvkB,EAAQ0U,WAE5B,MACD,KAAKlN,GAEAhb,EAAKmZ,WAAa3F,EAAQM,WAC7B9T,EAAK+3B,YAAc,W/Bq5KvBt2B,E+B94KDu2B,eAAA,SAAeC,GACd,IAAMC,EAAYn8B,KAAKm8B,UACnB,cAAeA,EAClBA,EAAUtgB,UAAYqgB,EAEtBC,EAAUrgB,IAAMogB,EAAcz3B,OAAOsX,IAAIC,gBAAgBkgB,GAAe,M/Bm5KzEx2B,E+B/4KDyxB,iBAAA,SAAiBxe,GAEhB3Y,KAAKm8B,UAAU5f,OAAOvb,MAAK,SAAAokB,OAExB,SAAAvkB,GACF4F,QAAQC,IAAI,kCAAmC7F,O/Bk5KhD6E,E+B94KD02B,YAAA,SAAY5C,GACXx5B,KAAKypB,UAAUxV,KAAKulB,I/Bi5KpBr3B,EAAa05B,EAAsB,CAAC,CAClCp7B,IAAK,aACL+F,IAAK,S+B1jLOs1B,GACd,GAAI97B,KAAKq8B,cAAgBP,EAAY,CACpC97B,KAAKq8B,YAAcP,EADiB,IAE5BpvB,EAASC,EAAAA,WAAW3M,MAApB0M,KACRovB,EAAapvB,EAAK0f,UAAUC,IAAI,gBAAkB3f,EAAK0f,UAAU/hB,OAAO,mB/BgkLtE,CACD5J,IAAK,aACL+F,IAAK,S+B9jLOyiB,GACd,GAAIjpB,KAAKs8B,cAAgBrT,EAAY,CACpCjpB,KAAKs8B,YAAcrT,EADiB,IAE5Bvc,EAASC,EAAAA,WAAW3M,MAApB0M,KACRuc,EAAavc,EAAK0f,UAAUC,IAAI,gBAAkB3f,EAAK0f,UAAU/hB,OAAO,mB/BokLtE,CACD5J,IAAK,WACL8D,IAAK,W+BjkLP,OAAOvE,KAAKu8B,W/BokLV/1B,IAAK,S+BjkLK4W,GACZpd,KAAKu8B,UAAYnf,I/BmkLd,CACD3c,IAAK,SACL8D,IAAK,W+BjkLP,OAAOvE,KAAKw8B,S/BokLVh2B,IAAK,S+BjkLGoV,GACV,GAAI5b,KAAKw8B,UAAY5gB,EAAQ,CAI5B,IAJ4B,IAEpBlP,EAASC,EAAAA,WAAW3M,MAApB0M,KACF+vB,EAASz8B,KAAKy8B,OAAS/vB,EAAK5H,cAAc,yBACzC23B,EAAOC,kBAAoB,GACjCD,EAAO1B,YAAY0B,EAAOE,mBAGvB38B,KAAKw8B,SAAWx8B,KAAKw8B,QAAQ/e,aAAezd,KAAKw8B,QAAQC,OAAOG,IAAI9B,aAAe2B,GAEtFz8B,KAAKw8B,QAAQ9e,OAEd1d,KAAKw8B,QAAU5gB,EACXA,IACH5b,KAAK87B,WAAalgB,EAAO6M,cACzBzoB,KAAKipB,WAAarN,EAAOmN,eAE1B,IAAM3L,EAAWxB,EAASA,EAAOO,QAAU,KAG3C,GAFAnc,KAAKod,SAAWA,EAEZA,EAAU,CACb,IAAM3N,EAAI,UAAa2N,EACvBqf,EAAOjhB,aAAa,KAAM/L,GAC1B,IAAMhQ,EAAOO,KACT4b,EAAO6B,YACVgf,EAAOhhB,YAAYG,EAAO6gB,OAAOG,MAEjC58B,KAAK+7B,wBAAyB,EAC9BngB,EAAOW,KAAK9M,EAAM,CAAEotB,IAAK,UAAW,SAACh8B,GAChCA,GAA0B,YAAjBA,EAAMoS,SAElBxT,EAAKs8B,wBAAyB,EAC9Bt8B,EAAK8V,wBAKRknB,EAAOK,gBAAgB,S/B+kLtB,CACDr8B,IAAK,cACL+F,IAAK,S+B5kLQw1B,GACXh8B,KAAK+8B,eAAiBf,IACzBh8B,KAAK+8B,aAAef,EAChBA,GACHh8B,KAAKw8B,QAAQR,YAAcA,EAC3Bh8B,KAAKy8B,OAAOhhB,YAAYugB,IACdh8B,KAAKw8B,QAAQR,aAAeh8B,KAAKw8B,QAAQR,YAAYlB,aAC/D96B,KAAKw8B,QAAQR,YAAYlB,WAAWC,YAAY/6B,KAAKw8B,QAAQR,aAC7Dh8B,KAAKw8B,QAAQR,YAAc,S/BilL1B,CACDv7B,IAAK,YACL8D,IAAK,W+B7kLP,IAAI43B,EAAYn8B,KAAKg9B,WACrB,IAAKb,EAAW,CACf,IAAMM,EAAS9vB,EAAAA,WAAW3M,MAAM0M,KAAK5H,cAAc,yBACnDq3B,EAAYt3B,SAAS0W,cAAc,SACnCvb,KAAKm3B,iBAAmBn3B,KAAKm3B,iBAAiB7W,KAAKtgB,MACnDm8B,EAAU9E,iBAAiB,iBAAkBr3B,KAAKm3B,kBAClDsF,EAAOhhB,YAAY0gB,GACnBn8B,KAAKg9B,WAAab,EAEnB,OAAOA,M/BolLAN,E+BprLYA,CAA6B9uB,EAAAA,WA6KlD8uB,GAAqB7uB,KAAO,CAC3BC,SAAU,iBACVsjB,QAAS,CAAC,aACVrf,OAAQ,CAAC,W/BghLV,IgChsLqB+rB,GAAAA,WhCisLnB,SAASA,KAMT,OAJAA,EgCjsLM95B,KAAP,SAAYwV,GACX,OATF,SAAeA,IACIlU,OAAOy4B,WAAa,IAC5B/5B,KAAKwV,GACflS,QAAQC,IAAI,uBAAwBiS,GAM5BwkB,CAAMxkB,IhCosLNskB,EgCvsLYA,GCHRG,GAEZ,SAAY5rB,GACXxR,KAAKwR,KAAOA,GAKD6rB,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAj8B,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAi6B,EAAAC,GAAAD,EAAA,CAAuCD,IAC1BG,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAn8B,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAm6B,EAAAC,GAAAD,EAAA,CAAsCH,IAEjBK,GAAAA,WjCutLnB,SAASA,KA2CT,OAzCAA,EiCvtLMC,MAAP,SAAaj0B,GAAO,IAAAxF,EAAAjE,KACnB,OAAOA,KAAK29B,aAAal0B,EAAMqS,KAAKvJ,KACnClD,EAAAA,KAAI,SAAA9F,GACH,MAAO,CAAEmD,KAAMzI,EAAK25B,QAAQr0B,GAAWiI,KAAM/H,EAAM+H,KAAM/H,MAAOA,MAEjEgL,EAAAA,KAAI,SAAA/H,GAAI,OAAIzI,EAAK45B,OAAO5pB,KAAKvH,MAC7B2H,EAAAA,WAAU,SAAA3H,GAAI,OAAIzI,EAAK65B,ajCiuLxBL,EiC7tLMM,MAAP,SAAat0B,KjC+tLZg0B,EiC3tLME,aAAP,SAAoB/3B,GACnB,OAAO+L,EAAAA,KAAKC,MAAMhM,GAAK5E,MAAK,SAAAiR,GAC3B,OAAOA,EAASG,YjC+tLjBqrB,EiC3tLMG,QAAP,SAAer0B,GACd,IAAMqzB,EAAM/3B,SAAS0W,cAAc,OAGnC,OAFAqhB,EAAIoB,UAAYz0B,EACHqzB,EAAID,mBjC+tLjBc,EiC3tLMn9B,OAAP,SAAckR,GACbxR,KAAK69B,OAAO5pB,KAAK,MACjBjU,KAAK89B,QAAQ7pB,KAAK,IAAIspB,GAAiB/rB,KjC8tLvCisB,EiC3tLMp9B,QAAP,SAAemR,GACdxR,KAAK69B,OAAO5pB,KAAK,MACjBjU,KAAK89B,QAAQ7pB,KAAK,IAAIopB,GAAkB7rB,KjC8tLjCisB,EiClwLYA,GAyCrBA,GAAaI,OAAS,IAAII,EAAAA,QAC1BR,GAAaK,QAAU,IAAIG,EAAAA,QAA3B,ICpDqBC,GAAAA,SAAAA,GlCkxLnB,SAASA,IACP,OAAO5xB,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe86B,EAAsB5xB,GAMrC,IAAI5G,EAASw4B,EAAqB37B,UA4ClC,OA1CAmD,EkCnwLD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACA0M,EAASC,EAAAA,WAAW3M,MAApB0M,KACR1M,KAAKm+B,UAAYzxB,EAAK5H,cAAc,wBACpC24B,GAAaI,OAAOtrB,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAtM,GACXxF,EAAKwF,MAAQA,MlCywLd/D,EkCrwLDpF,OAAA,SAAOqY,GACN8kB,GAAan9B,UlCwwLb6B,EAAa+7B,EAAsB,CAAC,CAClCz9B,IAAK,QACL8D,IAAK,WkCxyLP,OAAOvE,KAAKo+B,QlC2yLV53B,IAAK,SkCxyLEiD,GAAO,IAERrK,EAAWuN,EAAAA,WAAW3M,MAAtBZ,OAKR,GAJIY,KAAKo+B,QAAUp+B,KAAKo+B,OAAO1xB,OAC9BtN,EAAOiL,OAAOrK,KAAKo+B,OAAO1xB,KAAM1M,MAChCA,KAAKm+B,UAAUpD,YAAY/6B,KAAKo+B,OAAO1xB,OAEpCjD,GAASA,EAAMiD,KAAM,CACxB1M,KAAKo+B,OAAS30B,EACdzJ,KAAKm+B,UAAU1iB,YAAYhS,EAAMiD,MACftN,EAAOi/B,QAAQ50B,EAAMiD,MAExC1M,KAAKo+B,OAAS30B,EACdzJ,KAAKuV,kBlCgzLE2oB,EkCl0LYA,CAA6BnxB,EAAAA,WAoClDmxB,GAAqBlxB,KAAO,CAC3BC,SAAU,iBACV1D,SAAQ,+MAFT,ICnCqB+0B,GAAAA,SAAAA,GnC20LnB,SAASA,IACP,OAAOhyB,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAek7B,EAAuBhyB,GAMtC,IAAI5G,EAAS44B,EAAsB/7B,UAwCnC,OAtCAmD,EmC/0LD6G,OAAA,WACCD,EAAA/J,UAAMgK,OAAN1I,KAAA7D,MADQ,IAAAu+B,EAEyB5xB,EAAAA,WAAW3M,MAApCw+B,EAFAD,EAEAC,eAAgB9xB,EAFhB6xB,EAEgB7xB,KACxB,GAAI8xB,aAA0BN,GAAsB,CACnD,IAAM1sB,EAAOxR,KAAKwR,KAAOgtB,EAAe/0B,MAAM+H,KAE9C,GAAIA,GAAQA,EAAKnK,GAChB,CAAA,IAAMzB,EAAM04B,EAAsB5D,OAAOlpB,GAC1B,IAAI5E,OAAO,CACzBC,QAASH,EAAK5H,cAAc,WAC5BlE,MAAOgF,EACPkH,KAAM,SnCy1LTpH,EmCn1LD4c,MAAA,WACCmb,GAAan9B,UnCs1Lbg+B,EmCn1LM5D,OAAP,SAAclpB,GACb,IAAM5L,EAAMmF,EAAY/E,eAAe+E,EAAYxB,SAASC,QAAS,CAAEkhB,OAAQlZ,EAAKR,KAEpF,OADAvK,QAAQC,IAAI,+BAAgCd,GACrCA,GnCw1LP04B,EmCr1LMG,SAAP,SAAgBjtB,GACf,IAAM5L,EAAM5F,KAAK06B,OAAOlpB,GACxB/M,OAAOi6B,KAAK94B,EAAK,WnCw1LV04B,EmCv3LYA,CAA8BvxB,EAAAA,WAoCnDuxB,GAAsBtxB,KAAO,CAC5BC,SAAU,qBCtCJ,IAAM0xB,GAAW,CACvBC,YAAa,CAAE5tB,GAAI,EAAGvB,KAAM,gBAC5BovB,SAAU,CAAE7tB,GAAI,EAAGvB,KAAM,YACzBqvB,aAAc,CAAE9tB,GAAI,EAAGvB,KAAM,iBAC7BsvB,OAAQ,CAAE/tB,GAAI,EAAGvB,KAAM,WACvBuvB,MAAO,CAAEhuB,GAAI,EAAGvB,KAAM,UAGVwvB,GAAe,CAC3BC,IAAK,CAAEluB,GAAI,EAAGvB,KAAM,OACpB0vB,MAAO,CAAEnuB,GAAI,EAAGvB,KAAM,SACtB2vB,YAAa,CAAEpuB,GAAI,EAAGvB,KAAM,gBAC5BuvB,MAAO,CAAEhuB,GAAI,EAAGvB,KAAM,SACtB4vB,QAAS,CAAEruB,GAAI,EAAGvB,KAAM,YAGZ6vB,GAAb,WAGC,SAAAA,EAAY35B,GACPA,IACH1D,OAAO8D,OAAO/F,KAAM2F,GACpB3F,KAAKu/B,cAAc55B,EAAQ65B,QAE5Bx/B,KAAKw/B,OAASx/B,KAAKw/B,OAAS,IAAInwB,KAAI,SAAAowB,GAAI,OAAIC,GAAYD,MACpDz/B,KAAK2/B,QACR3/B,KAAK2/B,MAAQ3/B,KAAK2/B,MAAMtwB,KAAI,SAAA3E,GAAI,OAAIk1B,GAAYl1B,OAEjD1K,KAAK6/B,cAAgB7/B,KAAKw/B,MAAM1uB,QAZlC,OAAAwuB,EAAA/8B,UAqCCg9B,cAAA,SAAcC,GACb,GAAIA,EAAO,CACV,IAAIM,EAAuB,EACvBC,EAAsB,EACtBC,EAAoB,EACpBC,EAAuB,EACvBC,EAAsB,EAC1BV,EAAMt7B,SAAQ,SAACu7B,EAAMv2B,GAEpB,GADAu2B,EAAKv2B,MAAQA,EACTu2B,EAAKU,MACR,OAAOV,EAAKU,MAAMC,MACjB,IAAK,kBACJX,EAAKU,MAAMj3B,MAAQ42B,IACpB,MACA,IAAK,qBACJL,EAAKU,MAAMj3B,MAAQ62B,IACpB,MACA,IAAK,oBACJN,EAAKU,MAAMj3B,MAAQ82B,IACpB,MACA,IAAK,kBACJP,EAAKU,MAAMj3B,MAAQ+2B,IACpB,MACA,IAAK,iBACJR,EAAKU,MAAMj3B,MAAQg3B,UA7D1B/9B,EAAAm9B,EAAA,CAAA,CAAA7+B,IAAA,UAAA8D,IAAA,WAce,IAAAN,EAAAjE,KACPuU,EAAU,GAehB,OAdAtS,OAAOY,KAAK7C,MAAMkE,SAAQ,SAAAzD,GACzB,IAAwC,IAApC6+B,EAAKe,aAAan7B,QAAQzE,GAC7B,OAAQA,GACP,IAAK,QACJ8T,EAAQ9T,GAAOwD,EAAKxD,GAAK4O,KAAI,SAAAowB,GAAI,OAAIC,GAAYD,GAAMlrB,WACvD,MACD,IAAK,QACJA,EAAQ9T,GAAOwD,EAAKxD,GAAK4O,KAAI,SAAA3E,GAAI,OAAIk1B,GAAYl1B,GAAM6J,WACvD,MACD,QACCA,EAAQ9T,GAAOwD,EAAKxD,OAIjB8T,IA9BT,CAAA9T,IAAA,YAAA8D,IAAA,WAkCE,OAAOvE,KAAKsQ,KAAOtQ,KAAKsQ,KAAKhL,MAAM,KAAK+J,KAAI,SAAAC,GAAC,OAAIA,EAAEgxB,UAAU,EAAG,GAAG7R,iBAAelf,KAAK,IAAM,SAlC/F+vB,EAAA,GpCqgMA98B,EoCrgMa88B,GAAAA,eAEU,CAAC,KAAM,OAAQ,OAAQ,SAAU,QAAS,QAAS,QAAS,cAAe,OAAQ,KAAM,QAAS,aAAc,apCqgMvI,IoCz7LaiB,GAAb,SAAAC,GACC,SAAAD,EAAY56B,GAAS,OACpB66B,EAAA38B,KAAA7D,KAAM2F,IADc3F,KADtB,OAAAoD,EAAAm9B,EAAAC,GAAAD,EAAA,CAAkCjB,IAMrBmB,GAAb,SAAAC,GAsCC,SAAAD,EAAY96B,GAAS,IAAA6O,EAAA,OACpB7O,EAAQg6B,MAAQc,EAAiBE,SAASh7B,EAAQg6B,MAAOh6B,EAAQi7B,SAAUj7B,EAAQk7B,WAAYl7B,EAAQw6B,MAAQx6B,EAAQw6B,MAAMW,OAAS,KACtItsB,EAAAksB,EAAA78B,KAAA7D,KAAM2F,IAAN3F,MAMK+gC,OAAS,EACdvsB,EAAKwsB,OAAS,IAAI/C,EAAAA,QAClBzpB,EAAKmrB,MAAMz7B,SAAQ,SAACwG,EAAM/I,GAAP,OAAa+I,EAAKu2B,SAAiB,IAANt/B,KAC5C6S,EAAKmrB,MAAM/9B,SACd4S,EAAKgrB,MAAQhrB,EAAKqrB,cAAcrP,OAAOhc,EAAKmrB,MAAM,GAAGuB,MACrD1sB,EAAK2rB,MAAQ3rB,EAAKmrB,MAAM,GAAGQ,OAbR3rB,EAtCtBpR,EAAAq9B,EAAAC,GAAAD,EAEQE,SAAP,SAAgBhB,EAAYiB,EAAkBC,EAAoBC,QAAa,IAA/DnB,IAAAA,EAAQ,SAAuD,IAAnDiB,IAAAA,GAAW,QAAwC,IAAjCC,IAAAA,GAAa,QAAoB,IAAbC,IAAAA,EAAS,IAC1E,IAAMK,EAAOP,GAAY,EAAI,EAC7B,OAAOjB,EAAMtwB,KAAI,SAAC3E,EAAM/I,GACvB,IAAMy/B,EAAU,IAAIthC,MAAMuhC,QAW1B,OAVA32B,EAAuB,iBAATA,EAAoB,CAAEsG,GAAIrP,EAAI,EAAGw+B,MAAO,CAAEW,OAAQA,EAAQV,KAAM11B,GAAQw2B,KAAM,IAAOx2B,GAC9Fy1B,MAAMC,KAAKh6B,QAAQ,2BAA2B,SAACuU,EAAGC,EAAGxK,GACrDywB,GACHO,EAAQE,EAAIC,SAAS3mB,GACrBwmB,EAAQ9xB,EAAIiyB,SAASnxB,GAAK+wB,IAE1BC,EAAQ9xB,EAAIiyB,SAAS3mB,GACrBwmB,EAAQE,EAAIC,SAASnxB,GAAK+wB,MAGrB,CACNnwB,GAAItG,EAAKsG,GACTmvB,MAAOz1B,EAAKy1B,MACZe,KAAMx2B,EAAKw2B,MAAQ,GACnBE,QAAAA,OApBJj/B,EAAAs+B,EAAA,CAAA,CAAAhgC,IAAA,QAAA+F,IAAA,SAyBW0C,GACLlJ,KAAK+gC,SAAW73B,IACnBlJ,KAAK+gC,OAAS73B,EACdlJ,KAAK2/B,MAAMz7B,SAAQ,SAACwG,EAAM/I,GAAP,OAAa+I,EAAKu2B,SAAWt/B,IAAMuH,KACtDlJ,KAAKwhC,qBAELxhC,KAAKghC,OAAO/sB,KAAK/K,KA/BpB3E,IAAA,WAmCE,OAAOvE,KAAK+gC,WAnCd,IAAAlS,EAAA4R,EAAAl+B,UAAA,OAAAssB,EAuDC2S,mBAAA,WACCxhC,KAAKw/B,MAAQx/B,KAAK6/B,cAAcrP,OAAOxwB,KAAK2/B,MAAM3/B,KAAK+gC,QAAQG,OAxDjErS,EA2DC4S,aAAA,SAAanyB,EAAGgyB,GACf,OAAOthC,KAAK2/B,MAAMzvB,QAAO,SAACC,EAAGC,EAAGzO,GAC/B,OAAIyO,EAAEgxB,QAAQ9xB,IAAMA,GAAKc,EAAEgxB,QAAQE,IAAMA,EACjC3/B,EAEAwO,KAEL,IAlEN0e,EAoEC6S,QAAA,SAAQpyB,EAAGgyB,GACV,OAAoC,IAA7BthC,KAAKyhC,aAAanyB,EAAGgyB,IArE9BzS,EAuEC8S,QAAA,SAAQryB,EAAGgyB,GACV,IAAMp4B,EAAQlJ,KAAKyhC,aAAanyB,EAAGgyB,GACnC,IAAe,IAAXp4B,EAEH,OADAlJ,KAAKkJ,MAAQA,EACNlJ,KAAK2/B,MAAMz2B,IA3ErBu3B,EAAA,CAAsCnB,IAgFzBsC,GAAb,SAAAC,GACC,SAAAD,EAAYj8B,GAAS,OACpBk8B,EAAAh+B,KAAA7D,KAAM2F,IADc3F,KADtB,OAAAoD,EAAAw+B,EAAAC,GAAAD,EAAA,CAA+BtC,IAMlBwC,GAAb,WAEC,SAAAA,EAAYn8B,GACPA,GACH1D,OAAO8D,OAAO/F,KAAM2F,GAJvB,OAAAxD,EAAA2/B,EAAA,CAAA,CAAArhC,IAAA,UAAA8D,IAAA,WAOe,IAAAoQ,EAAA3U,KACPuU,EAAU,GAShB,OARAtS,OAAOY,KAAK7C,MAAMkE,SAAQ,SAAAzD,IACmB,IAAxCqhC,EAASzB,aAAan7B,QAAQzE,KACjC8T,EAAQ9T,GAAOkU,EAAKlU,QAGlB8T,EAAQ9H,MAAU8H,EAAQ9H,KAAKlB,OAAUgJ,EAAQ9H,KAAKlG,aAClDgO,EAAQ9H,KAET8H,IAjBT,CAAA9T,IAAA,WAAA8D,IAAA,WAoBE,OAAOvE,KAAKsQ,KAAKb,OAASwvB,GAAaC,IAAIzvB,OACzCzP,KAAKuL,OAAwB,KAAfvL,KAAKuL,OACnBvL,KAAK+hC,UAA8B,KAAlB/hC,KAAK+hC,UACvB/hC,KAAKmgC,OACLngC,KAAKyM,UAxBRq1B,EAAA,GpC8gMAt/B,EoC9gMas/B,GAAAA,eACU,CAAC,KAAM,OAAQ,QAAS,WAAY,QAAS,OAAQ,SAAU,kBAAmB,WAAY,WAAY,QAAS,SAAU,SAAU,QpC+gM9J,IoCn/LaE,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAA5gC,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAA4+B,EAAAC,GAAAD,EAAA,CAAiCF,IAIpBI,GAAb,WAEC,SAAAA,EAAYv8B,GACPA,GACH1D,OAAO8D,OAAO/F,KAAM2F,GAErB3F,KAAKkhC,MAAQlhC,KAAKkhC,MAAQ,IAAI7xB,KAAI,SAAApF,GAAG,OAAIy1B,GAAYz1B,MACrDjK,KAAK6/B,cAAgB7/B,KAAKkhC,KAAKpwB,QAPjC,OAAA3O,EAAA+/B,EAAA,CAAA,CAAAzhC,IAAA,UAAA8D,IAAA,WASe,IAAAsQ,EAAA7U,KACPuU,EAAU,GAYhB,OAXAtS,OAAOY,KAAK7C,MAAMkE,SAAQ,SAAAzD,GACzB,IAA4C,IAAxCyhC,EAAS7B,aAAan7B,QAAQzE,GACjC,OAAQA,GACP,IAAK,OACJ8T,EAAQ9T,GAAOoU,EAAKpU,GAAK4O,KAAI,SAAApF,GAAG,OAAIy1B,GAAYz1B,GAAKsK,WACrD,MACD,QACCA,EAAQ9T,GAAOoU,EAAKpU,OAIjB8T,MAtBT2tB,EAAA,GA0BO,SAASC,GAAQx4B,GACvB,OAAQA,EAAK2G,KAAKb,MACjB,KAAKkvB,GAASE,SAASpvB,KACtB9F,EAAO,IAAI42B,GAAa52B,GACxB,MACD,KAAKg1B,GAASG,aAAarvB,KAC1B9F,EAAO,IAAI82B,GAAiB92B,GAC5B,MACD,KAAKg1B,GAASK,MAAMvvB,KACnB9F,EAAO,IAAIi4B,GAAUj4B,GACrB,MACD,QACCA,EAAO,IAAI21B,GAAK31B,GAElB,OAAOA,EAGD,SAAS+1B,GAAYD,GAC3B,OAAQA,EAAKnvB,KAAKb,MACjB,KAAKwvB,GAAaC,IAAIzvB,KACrBgwB,EAAO,IAAIuC,GAAYvC,GACvB,MACD,QACCA,EAAO,IAAIqC,GAASrC,GAEtB,OAAOA,EAGD,SAASG,GAAYl1B,GAC3B,OAAO,IAAIw3B,GAASx3B,GpCw+LrBlI,EoC/hMa0/B,GAAAA,eACU,CAAC,KAAM,QAAS,SAuDtC,IC/QoBE,GAAAA,WrC2xMnB,SAASA,KA0JT,OAxJAA,EqCzwMMC,MAAP,WACC,IAAKriC,KAAKsiC,OAAQ,CACjB,IAAMC,EAAUx3B,EAAYjE,MAAMC,WAAa,YAAc,kBAC7D/G,KAAKsiC,OAASjxB,EAAYsB,KAAK4vB,GAAShwB,KACvClD,EAAAA,KAAI,SAAAmC,GAEH,OADAA,EAAKgxB,MAAQhxB,EAAKgxB,MAAMnzB,KAAI,SAAA1F,GAAI,OAAIw4B,GAAQx4B,MACrC6H,KAGRiL,EAAAA,YAAY,IAGd,OAAOzc,KAAKsiC,QrC4wMZF,EqCzwMMK,MAAP,SAAajxB,EAAMpK,GAAQ,IAAAnD,EAAAjE,KACpBwiC,EAAQp7B,EAASoK,EAAKgxB,MAAQhxB,EAAKgxB,MAAMx/B,QAAO,SAAAsM,GAAC,MAAoB,iBAAhBA,EAAEgB,KAAKb,QAC5DizB,EAAgBx3B,EAAgBC,IAAI,UAAYo2B,SAASr2B,EAAgB3G,IAAI,WAAci+B,EAAM5gC,OAAS4gC,EAAM,GAAGxxB,GAAK,KAE9H,OADAhR,KAAK2iC,SAAS1uB,KAAK,CAAEyW,OAAQgY,IACtB1iC,KAAK2iC,SAASpwB,KACpByI,EAAAA,sBAAqB,SAACL,EAAGC,GAAJ,OAAUD,EAAE+P,SAAW9P,EAAE8P,UAC9Crb,EAAAA,KAAI,SAAAuzB,GACH,IAAMj5B,EAAO6H,EAAKgxB,MAAMllB,MAAK,SAAA3T,GAAI,OAAIA,EAAKqH,KAAO4xB,EAAOlY,UAIxD,OAHI/gB,IACHA,EAAKk5B,gBAAkBD,EAAOC,kBAAmB,GAE3Cl5B,GAAQ1F,EAAK6+B,eAAetxB,QrCuxMrC4wB,EqClxMMW,YAAP,SAAmBvxB,GAClB,IAAMwxB,EAAchjC,KAAK8iC,eAAetxB,GACxC,OAAOsI,EAAAA,cAAc,CAAC9Z,KAAKyiC,MAAMjxB,GAAOxR,KAAKijC,YAAY1wB,KACxDlD,EAAAA,KAAI,SAAA4K,GACH,IAAMtQ,EAAOsQ,EAAM,GAEnB,OADeA,EAAM,GACLtQ,EAAOq5B,KAExBvuB,EAAAA,KAAI,SAAA9K,GACCA,EAAKqH,KAAOgyB,EAAYhyB,IAC3B9F,EAAgB1E,IAAI,SAAUmD,EAAKqH,SrCqxMtCoxB,EqC/wMMc,YAAP,SAAmB1xB,GAClB,IAAMwxB,EAAchjC,KAAK8iC,eAAetxB,GACxC,OAAOxR,KAAKyiC,MAAMjxB,GAAM,GAAMe,KAC7BkC,EAAAA,KAAI,SAAA9K,GACCA,EAAKqH,KAAOgyB,EAAYhyB,IAC3B9F,EAAgB1E,IAAI,SAAUmD,EAAKqH,SrCmxMtCoxB,EqC7wMMa,QAAP,WACC,OAAO9qB,EAAaE,OAAO9F,KAC1BlD,EAAAA,KAAI,SAAA+F,GAAK,OAAIA,EAAM+U,UACnBnP,EAAAA,yBrCgxMDonB,EqC5wMMe,UAAP,SAAiBzY,GAChB,OAAO1qB,KAAKqiC,QAAQ9vB,KACnBlD,EAAAA,KAAI,SAAAmC,GAAI,OAAIA,EAAKgxB,MAAMllB,MAAK,SAAAhO,GAAC,OAAIA,EAAE0B,KAAO0Z,UrCkxM3C0X,EqC9wMMgB,UAAP,SAAiBz5B,GAChB,OAAKA,EAAK05B,MAUFjvB,EAAAA,GAAG,OATVzK,EAAK05B,OAAQ,EACTt4B,EAAYjE,MAAMC,WACdsK,EAAYsB,KAAZ,aAA8BhJ,EAAKqH,GAAnC,UAEPrH,EAAK25B,MAAQ35B,EAAK25B,OAAS,EAC3B35B,EAAK25B,QACElvB,EAAAA,GAAGzK,MrCsxMZy4B,EqC/wMMmB,aAAP,SAAoB9rB,GACnB,OAAOzX,KAAKmjC,UAAU1rB,EAAQiT,QAAQnY,KACrCkC,EAAAA,KAAI,SAAA9K,GACCA,IACHA,EAAK25B,MAAQ7rB,EAAQ6rB,YrCmxMxBlB,EqC7wMMU,eAAP,SAAsBtxB,GACrB,OAAOA,GAAQA,EAAKgxB,MAAMllB,MAAK,SAAAhO,GAAC,MAAoB,iBAAhBA,EAAEgB,KAAKb,SAA4B,CACtEuB,GAAI,eACJV,KAAM,CAAEU,GAAI,EAAGvB,KAAM,gBACrBA,KAAM,eACN6zB,MAAO,EACPD,OAAO,EACPlD,MAAO,CACN7vB,KAAM,CAAEU,GAAI,EAAGvB,KAAM,SACrBqxB,OAAQ,0BACRV,KAAM,oBAEPZ,MAAO,GACPgE,YAAa,CACZC,SAAU,EACVC,UAAW,KrC0xMbvhC,EAAaigC,EAAa,KAAM,CAAC,CAC/B3hC,IAAK,SAEL+F,IAAK,SqC55MUo8B,GACjB5iC,KAAK2iC,SAAS1uB,KAAK2uB,IrC85MjBr+B,IAAK,WqC35MP,OAAOvE,KAAK2iC,SAASrqB,arC+5MlB,CACD7X,IAAK,SACL+F,IAAK,SqC75MUkkB,GACjB1qB,KAAK2iC,SAAS1uB,KAAK,CAAEyW,OAAAA,EAAQmY,iBAAiB,KrCk6M5Ct+B,IAAK,WqC/5MP,IAAMq+B,EAAS5iC,KAAK2iC,SAASrqB,WAC7B,OAAOsqB,EAASA,EAAOlY,OAAS,SrCo6MzB0X,EqCr7MYA,GrCw7MrB5/B,EqCx7MqB4/B,GAAAA,WAGF,IAAIltB,EAAAA,gBAAgB,OCThC,IAAMyuB,GACH,UADGA,GAEH,UAFGA,GAGL,QAHKA,GAIH,UAJGA,GAKF,WALEA,GAMA,cANAA,GAOC,cAGOC,GAAAA,WAiBpB,SAAAA,IAAc,IAAA3/B,EAAAjE,KACb,GAAI4jC,EAAUC,SACb,KAAO,kCAER,IAAMzuB,EAAQpV,KAAK8jC,OAAS,CAC3BC,OAAQ,CACPxJ,SAAU,IAAIz6B,MAAMkkC,QACpBC,WAAY,IAAInkC,MAAMokC,WACtBC,MAAO,IAAIrkC,MAAMkkC,QACjBI,MAAO,IAAIjgC,MAAM,IAAWqzB,KAAK,KAGnCx3B,KAAKqkC,iBAAmBrkC,KAAKqkC,iBAAiB/jB,KAAKtgB,MACnDA,KAAKskC,eAAiBtkC,KAAKskC,eAAehkB,KAAKtgB,MAC/CA,KAAKukC,QAAU,IAAIrvB,EAAAA,gBAAgByuB,IACnC3jC,KAAKwkC,SAAW,IAAIvG,EAAAA,QACpBj+B,KAAKqY,OAAS,IAAInD,EAAAA,gBAAgBE,GAClCpV,KAAKykC,eAAiB,KAClB,OAAQjvB,UACXA,UAAUkvB,GAAGC,mBAAmB,gBAAgB3jC,MAAK,SAAC0Y,GACjDA,EACHzV,EAAKsgC,QAAQtwB,KAAK0vB,IAElB1/B,EAAKsgC,QAAQtwB,KAAK0vB,QAIW,IAA3Bl/B,OAAOmgC,gBACV5kC,KAAKukC,QAAQtwB,KAAK0vB,IAElB3jC,KAAKukC,QAAQtwB,KAAK0vB,ItCg5MpBC,EsC77MMiB,WAAP,WAIC,OAHK7kC,KAAK6jC,WACT7jC,KAAK6jC,SAAW,IAAID,GAEd5jC,KAAK6jC,UtCi8MZ1hC,EAAayhC,EAAW,CAAC,CACvBnjC,IAAK,SACL8D,IAAK,WsC/7MP,OAAOvE,KAAKukC,QAAQjsB,atCk8MjB,CACD7X,IAAK,QACL8D,IAAK,WsCh8MP,OAAOvE,KAAKqY,OAAOC,etC4+MnB,IAAI5S,EAASk+B,EAAUrhC,UAyGvB,OAvGAmD,EsCv8MD2+B,iBAAA,SAAiBS,GAChBA,EAAQzN,iBAAiB,MAAOr3B,KAAKskC,gBACrCtkC,KAAKykC,eAAiBK,EACtB9kC,KAAKwkC,SAASvwB,KAAK6wB,GACnB9kC,KAAKukC,QAAQtwB,KAAK0vB,KtC08MlBj+B,EsCv8MD4+B,eAAA,WACCtkC,KAAKykC,eAAe9M,oBAAoB,MAAO33B,KAAKskC,gBACpDtkC,KAAKykC,eAAiB,KACtBzkC,KAAKwkC,SAASvwB,KAAK,MACnBjU,KAAKukC,QAAQtwB,KAAK0vB,KtC48MlBj+B,EsCz8MDq/B,SAAA,SAASpsB,GACR,GAA4B,OAAxB3Y,KAAKykC,eAAyB,CAQjCjvB,UAAUkvB,GAAGM,eAAe,eADR,CAAEC,iBAAkB,CAAC,cAAe,mBACCjkC,KAAKhB,KAAKqkC,uBAEnErkC,KAAKykC,eAAeS,OtC+8MrBx/B,EsC38MDy/B,WAAA,WAEC,OADenlC,KAAKukC,QAAQjsB,YAE3B,KAAKqrB,GACL,KAAKA,GACL,KAAKA,GACL,KAAKA,GACJ,OAAO,EACR,QACC,OAAO,ItCi9MTj+B,EsC78MD0/B,SAAA,WACC,IAAI/uB,EAEJ,OADerW,KAAKukC,QAAQjsB,YAE3B,KAAKqrB,GACJttB,EAAQ,aACR,MACD,KAAKstB,GACL,KAAKA,GACJttB,EAAQ,WACR,MACD,KAAKstB,GACJttB,EAAQ,UACR,MACD,KAAKstB,GACJttB,EAAQ,cACR,MACD,KAAKstB,GACJttB,EAAQ,iBACR,MACD,KAAKstB,GACJttB,EAAQ,iBAGV,OAAOA,GtCu9MP3Q,EsCp9MD2/B,YAAA,SAAYC,GACX,GAAItlC,KAAKiT,SAAW0wB,GAAkB,CACpB2B,EAAMC,SACdD,EAAME,MADf,IAECzB,EAASuB,EAAMvB,OACf3uB,EAAQpV,KAAK8jC,OACdC,EAAO0B,YAAYC,UAAUtwB,EAAM2uB,OAAOxJ,SAAUnlB,EAAM2uB,OAAOE,WAAY7uB,EAAM2uB,OAAOI,OAC1F/uB,EAAM2uB,OAAOK,MAAM,GAAKhvB,EAAM2uB,OAAOxJ,SAASjrB,EAC9C8F,EAAM2uB,OAAOK,MAAM,GAAKhvB,EAAM2uB,OAAOxJ,SAAS+G,EAC9ClsB,EAAM2uB,OAAOK,MAAM,GAAKhvB,EAAM2uB,OAAOxJ,SAASoL,EAC9CvwB,EAAM2uB,OAAOK,MAAM,GAAKhvB,EAAM2uB,OAAOE,WAAW30B,EAChD8F,EAAM2uB,OAAOK,MAAM,GAAKhvB,EAAM2uB,OAAOE,WAAW3C,EAChDlsB,EAAM2uB,OAAOK,MAAM,GAAKhvB,EAAM2uB,OAAOE,WAAW0B,EAChDvwB,EAAM2uB,OAAOK,MAAM,GAAKhvB,EAAM2uB,OAAOE,WAAW2B,EAChDxwB,EAAM2uB,OAAOK,MAAM,GAAKhvB,EAAM2uB,OAAOI,MAAM70B,EAC3C8F,EAAM2uB,OAAOK,MAAM,GAAKhvB,EAAM2uB,OAAOI,MAAM7C,EAC3ClsB,EAAM2uB,OAAOK,MAAM,GAAKhvB,EAAM2uB,OAAOI,MAAMwB,EAC3C3lC,KAAKqY,OAAOpE,KAAKmB,KtCw9MXwuB,EsCnmNYA,GCQAiC,GAAAA,SAAAA,GvC+lNnB,SAASA,IACP,OAAOv5B,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeyiC,EAAgBv5B,GAM/B,IAAI5G,EAASmgC,EAAetjC,UAonB5B,OAlnBAmD,EuC5lND6G,OAAA,WAAS,IAAAtI,EAAAjE,KACS2M,EAAAA,WAAW3M,MAApB0M,KACH0f,UAAU/hB,OAAO,UACtBrK,KAAKwM,IAAMzB,EACX/K,KAAKkxB,SAAWP,GAAcO,SAC9BlxB,KAAKoV,MAAQ,GACbpV,KAAKmqB,OAAS,KACdnqB,KAAKwR,KAAO,KACZxR,KAAKwiC,MAAQ,KACbxiC,KAAK2J,KAAO,KACZ3J,KAAKL,KAAO,KACZK,KAAK+d,MAAQ,KACb/d,KAAK4c,OAAS,KACd5c,KAAKqd,QAAU,IACGrd,KAAK8lC,UAAYlC,GAAUiB,cACnCN,QAAQhyB,KACjBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA9C,GAAM,OAAIhP,EAAKsR,iBAC3BvV,KAAK+lC,evCmmNLrgC,EuChmNDsgC,YAAA,WACC,IAAIC,EAAW,KACTvhB,GAASxZ,EAAgB3G,IAAI,SAAW,IAAImgB,MAAM,wBACxD,GAAIA,EAAO,CACV,IAAMxb,EAAQq4B,SAAS7c,EAAM,IAC7BuhB,EAAWhkC,OAAOY,KAAKwQ,GAAUnD,QAAO,SAACC,EAAGC,EAAGzO,GAC9C,OAAOA,IAAMuH,EAAQmK,EAASjD,GAAKD,IACjC,MAEJ,OAAO81B,GvCqmNPvgC,EuClmNDqgC,YAAA,WAAc,IAAAvxB,EAAAxU,KACb6T,EAAYK,MAAM3B,KACjBuD,EAAAA,SACCC,WAAU,SAAAhC,GACXS,EAAK0xB,aAAanyB,OvCumNnBrO,EuClmNDygC,UAAA,SAAUpyB,GACT,IAAMkyB,EAAWjmC,KAAKgmC,eAClBjyB,GAAUkyB,GAAYlyB,EAAKzD,OAAS21B,EAGvCjmC,KAAKkmC,aAAa,CAAE51B,KAAM21B,IAF1BjmC,KAAKkmC,aAAanyB,IvC2mNnBrO,EuCrmND0gC,kBAAA,SAAkBryB,GACjB,IAAMkyB,EAAWjmC,KAAKgmC,eAClBjyB,GAAUkyB,GAAYA,IAAalyB,EAAKzD,KAEjC21B,IAAa5yB,EAASC,WAAa2yB,IAAa5yB,EAASE,SACnE9O,OAAOC,SAAS6B,KAAOwE,EAAYnF,IAAIuD,OAEvCnJ,KAAKkmC,aAAa,CAAE51B,KAAM21B,IAJ1BjmC,KAAKkmC,aAAanyB,IvCgnNnBrO,EuCxmND2gC,cAAA,WACC,IAAIpzB,EAAS+L,EACP5J,EAAQ+C,EAAa/C,MAkB3B,OAjBIA,EAAMyF,OAASxH,EAASK,cAC3B0B,EAAM3F,KAAO2F,EAAM3F,MAAQ,gBAW3BwD,EATImC,EAAMoc,UAECpc,EAAM3I,KAEN2I,EAAMrB,KAAK/C,IAAOoE,EAAMyF,OAASxH,EAASC,WAAa8B,EAAMyF,OAASxH,EAASE,SAE/E6B,EAAM3F,KAEP2F,EAAMyF,OAASxH,EAASI,QAAU2B,EAAMyF,OAASxH,EAASK,YAC3DsL,EAEAA,GAJAA,EAFAA,EAFAA,EAFAA,EAYV7G,EAAaC,WAAW,CAAEnF,OAAAA,IACnBA,GvCgnNPvN,EuC7mNDwgC,aAAA,SAAanyB,GAAM,IAAAY,EAAA3U,KAClByG,QAAQC,IAAI,eAAgBqN,GAC5B,IAAMtH,EAAOvB,EAAgB3G,IAAI,SAAW,KACtCsW,EAAO7a,KAAKgmC,gBAAkBjyB,EAAOA,EAAKzD,KAAO,MAEnDuK,KADJ9G,EAAOA,GAAQ,CAAEzD,KAAMuK,IACLvK,OACjByD,EAAO,CAAEzD,KAAMuK,IAEhB,IAAMyrB,EAAQzrB,IAASxH,EAASK,YAC1BjE,EAAOvE,EAAgB3G,IAAI,UAAYwP,EAAK2nB,WAAa3nB,EAAK4nB,SAAc5nB,EAAK2nB,UAA1C,IAAuD3nB,EAAK4nB,SAAa,MAChHnK,EAAYL,GAAoB5sB,IAAI,cAAgB,KACpD4lB,EAAStP,IAASxH,EAASC,UAC3BizB,GAAQjiC,GAASuW,IAASxH,EAASM,YACnCyB,EAAQ,CACbrB,KAAMA,EACN8G,KAAMA,EACNyrB,MAAOA,EACP72B,KAAMA,EACN+hB,UAAWA,EACX/kB,KAAMA,EACN5F,YAAakE,EAAYlE,YACzBoU,IAAK,KACLhI,OAAQ,OACR4P,YAAY,EACZoC,WAAW,EACXmF,QAAQ,EACRta,SAAS,EACT6a,OAAO,EACPR,OAAQA,EACRoc,KAAMA,EACN5d,aAAa,EACbM,YAAY,GAEb9Q,EAAa/C,MAAQA,EACrB+C,EAAaE,OAAO9F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAX,GACXT,EAAKS,MAAQA,EACbT,EAAKwV,OAAS/U,EAAM+U,OACpBxV,EAAKY,iBAGNvV,KAAKwmC,YACLxmC,KAAKymC,gBAAgBl0B,KACpBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAApM,QvCsnNZjE,EuCjnND+gC,cAAA,WAAgB,IAAA5xB,EAAA7U,KACf,OAAOoiC,GAAYC,QAAQ9vB,KAC1B8B,EAAAA,WAAU,SAAA7C,GAGT,OAFAqD,EAAKrD,KAAOA,EACZqD,EAAK2tB,MAAQhxB,EAAKgxB,MAAMx/B,QAAO,SAAAsM,GAAC,MAAoB,iBAAhBA,EAAEgB,KAAKb,QACpC2yB,GAAYW,YAAYvxB,MAShCiD,EAAAA,KAAI,SAAA9K,GAECkL,EAAKya,OACRza,EAAKya,MAAM7E,UAAU9gB,EAAKqH,IAE3B6D,EAAKlL,KAAOA,EACZkL,EAAKU,mBvC0nNP7P,EuCrnND8gC,UAAA,WAAY,IAAAzxB,EAAA/U,KACPsvB,EAAQ,KACZ,GAAIhrB,GAAStE,KAAKoV,MAAMyF,OAASxH,EAASM,YACzCwE,EAAaC,WAAW,CAAEnF,OAAQ+L,GAAuBmL,QAAQ,QAC3D,CACNmF,EAAQtvB,KAAKsvB,MAAQrP,GAAa0B,eACrB3hB,KAAKgmC,cACHhmC,KAAKqmC,gBAGrBzsB,EAAcoE,OAAOzL,KACpBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAgI,GAEXhJ,EAAKgJ,MAAQA,EACbhJ,EAAKQ,iBAENqE,EAAcqE,QAAQ1L,KACrBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA6G,GAEX7H,EAAK6H,OAASA,EACd7H,EAAKQ,iBAENqE,EAAcC,kBAAkBtH,KAC/BkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAsH,GAEXtI,EAAKsI,QAAUA,EACftI,EAAKQ,iBAENiC,EAAeS,KAAK1F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA0B,GAEX,OAAQA,EAAQnH,MACf,KAAK2O,GACJxH,EAAQnH,KAAO2O,GACfxH,EAAQ2C,WAAa,CACpBS,KAAM1C,EAAa/C,MAAMyF,KACzBpL,KAAM0I,EAAa/C,MAAM3F,KACzBwL,IAAK9C,EAAa/C,MAAM6F,IACxByM,UAAWvP,EAAa/C,MAAMsS,UAC9B5X,QAASqI,EAAa/C,MAAMtF,SAE7B0H,EAAeK,SAASJ,GACxB,MACD,KAAKwH,GAEJxH,EAAQnH,KAAO2O,GACfzH,EAAeK,SAASJ,GACxBU,EAAaC,WAAW,CAAEgS,QAAQ,IAC9BrV,EAAKua,OACRva,EAAKua,MAAMjF,6BAA6B5S,EAAQM,UAIjD,MAcD,KAAKkH,GACJlK,EAAK2xB,cAAcjvB,GACnB,MACD,KAAKwH,GACJmjB,GAAYmB,aAAa9rB,GAASlF,KACjCuD,EAAAA,SACCC,WAAU,SAAApM,GAAI,OAAIoL,EAAK4xB,SAASh9B,MAClC,MACD,KAAKsV,GACC9G,EAAa/C,MAAMpN,MACvBmQ,EAAaC,WAAW,CAAEwuB,WAAW,QAKzCpvB,EAAeI,IAAIrF,KAClBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA0B,GACP6X,GACHA,EAAMxF,YAAYrS,MAGhB6X,GAASnX,EAAa/C,MAAMnC,SAAW+L,IAC1Chf,KAAKg0B,WvCsoNNtuB,EuCloNDmhC,UAAA,SAAUrV,GAETrZ,EAAaC,WAAW,CAAEoZ,WAAW,IACrCxxB,KAAKqmC,iBvCuoNL3gC,EuCpoNDohC,OAAA,SAAOr6B,GACN,IAAMoO,EAAO7a,KAAKgmC,cACZM,EAAQzrB,IAASxH,EAASK,YAC1BK,EAAOoE,EAAa/C,MAAMrB,KAC3B8G,IAASxH,EAASC,WAAauH,IAASxH,EAASE,UAAeQ,EAAK/C,IAAM+C,EAAKzD,OAASuK,EAEnF1C,EAAa/C,MAAM3F,KACzBoL,IAASxH,EAASI,QAAUoH,IAASxH,EAASK,aACjDyE,EAAaC,WAAW,CAAE3L,KAAAA,EAAMoO,KAAAA,EAAMyrB,MAAAA,IACtCtmC,KAAKg0B,WAEL7b,EAAaC,WAAW,CAAE3L,KAAAA,EAAMoO,KAAAA,EAAMyrB,MAAAA,EAAOrzB,OAAQ+L,IAGtD7G,EAAaC,WAAW,CAAE3L,KAAAA,EAAMoO,KAAAA,EAAMyrB,MAAAA,EAAOrzB,OAAQ+L,IATrD7G,EAAaC,WAAW,CAAE3L,KAAAA,EAAMoO,KAAAA,EAAMyrB,MAAAA,EAAOrzB,OAAQ+L,KvCqqNtDtZ,EuCxpNDsQ,QAAA,SAAQjC,GACP,IAAMtE,EAAO0I,EAAa/C,MAAM3F,OAASsE,EAAK2nB,WAAa3nB,EAAK4nB,SAAc5nB,EAAK2nB,UAA1C,IAAuD3nB,EAAK4nB,SAAa,MAC9GlsB,EACH0I,EAAaC,WAAW,CAAErE,KAAAA,EAAMtE,KAAAA,EAAMwD,OAAQ+L,IAE9C7G,EAAaC,WAAW,CAAErE,KAAAA,EAAMd,OAAQ+L,KvCoqNzCtZ,EuChqNDqhC,OAAA,SAAOt3B,GACF0I,EAAa/C,MAAMyF,OAASxH,EAASI,QAAU0E,EAAa/C,MAAMyF,OAASxH,EAASK,aACvFyE,EAAaC,WAAW,CAAE3I,KAAAA,IAC1BzP,KAAKg0B,WAEL7b,EAAaC,WAAW,CAAE3I,KAAAA,EAAMwD,OAAQ+L,KvCyqNzCtZ,EuCrqNDszB,QAAA,SAAQpW,GACP5iB,KAAKg0B,QAAQpR,IvCwqNbld,EuCrqNDsuB,QAAA,SAAQpR,GAKP,GAJA5iB,KAAKsvB,MAAM3M,SAASC,GAAarQ,KAChCkE,EAAAA,UAAUzW,KAAK0W,eACdX,YAEE/V,KAAKoV,MAAMyF,OAASxH,EAASM,YAAa,CAC7C,IAAMqzB,EAAkBhnC,KAAKoV,MAAM3I,KAAKrG,QAAQ,QAAS,KACnDM,EAAM,CACXmzB,UAAW75B,KAAKoV,MAAM3I,KACtBu6B,gBAAiBA,EACjBC,SAAUjnC,KAAKoV,MAAM3F,KACrBy3B,SAAUlnC,KAAKoV,MAAMyF,MAGtBhH,EAAYoB,KAAKvO,GAAK6L,KACrBuD,EAAAA,SACCC,YACFknB,GAAW95B,KAAK,CACfy/B,OAAQ,iBACR/I,UAAW75B,KAAKoV,MAAM3I,KACtBu6B,gBAAiBA,EACjBE,SAAUlnC,KAAKoV,MAAMyF,SvCsqNvBnV,EuCjqNDkuB,WAAA,WACK5zB,KAAKsvB,MACRtvB,KAAKsvB,MAAMzH,eAAe7mB,MAAK,WAE9ByD,OAAOC,SAAS6B,KAAO9B,OAAOC,SAAS6B,OACrCE,QAAQC,KAEX1G,KAAKoY,WAAW,CAAEyK,YAAY,EAAOoC,WAAW,KvCwqNjDvf,EuCpqNDyhC,QAAA,SAAQC,GACP,IAAM1c,EAAS0c,EAAQ1c,OACV1qB,KAAKwR,KAAKgxB,MAAMllB,MAAK,SAAAhO,GAAC,OAAIA,EAAE0B,KAAO0Z,OAE/C0X,GAAYQ,OAAS,CAAElY,OAAAA,EAAQmY,gBAAiBuE,EAAQvE,mBvC8qNzDn9B,EuC1qNDghC,cAAA,SAAcjvB,GACb,IAAMiT,EAASjT,EAAQiT,OACjB2c,EAAY5vB,EAAQ4vB,UAC1B,GAAI3c,GAAU0X,GAAY1X,SAAWA,EAAQ,CAC5C,IAAM/gB,EAAO3J,KAAKwR,KAAKgxB,MAAMllB,MAAK,SAAAhO,GAAC,OAAIA,EAAE0B,KAAO0Z,KAC5C/gB,IACHy4B,GAAYQ,OAAS,CAAElY,OAAAA,EAAQmY,gBAAiBprB,EAAQorB,iBACvC,MAAbwE,GAAqB19B,aAAgB82B,KACxC92B,EAAKT,MAAQm+B,MvCotNhB3hC,EuClrND0S,WAAA,SAAWhD,GACVpV,KAAKoV,MAAQnT,OAAO8D,OAAO,GAAI/F,KAAKoV,MAAOA,GAC3CpV,KAAKuV,evCqrNL7P,EuCjrND8iB,aAAA,WACKxoB,KAAKsvB,MACRtvB,KAAKsvB,MAAM9G,eAEXxoB,KAAKoY,WAAW,CAAEuQ,aAAc3oB,KAAKoV,MAAMuT,evCurN5CjjB,EuCnrNDojB,YAAA,WACK9oB,KAAKsvB,MACRtvB,KAAKsvB,MAAMxG,cAEX9oB,KAAKoY,WAAW,CAAE6Q,YAAajpB,KAAKoV,MAAM6T,cvCyrN3CvjB,EuCrrNDmnB,aAAA,WACK7sB,KAAKsvB,MACRtvB,KAAKsvB,MAAMzC,eAEX7sB,KAAKoY,WAAW,CAAEwE,QAAS5c,KAAKoV,MAAMwH,UvC2rNvClX,EuCvrND4hC,aAAA,WACC,IAAMC,GAAevnC,KAAKoV,MAAMmyB,YAChCpvB,EAAaC,WAAW,CAAEmvB,YAAAA,KvC4rN1B7hC,EuCzrND8hC,WAAA,WACCrvB,EAAaC,WAAW,CAAEpQ,MAAOhI,KAAKoV,MAAMpN,KAAM4+B,WAAW,KvC+rN7DlhC,EuC5rND+hC,YAAA,WACCznC,KAAKoY,WAAW,CAAEpQ,MAAM,KvCisNxBtC,EuC9rNDgiC,gBAAA,WACK1nC,KAAKsvB,MACRtvB,KAAKsvB,MAAMnG,gBACDnpB,KAAKoV,MAAMtF,SACrB9P,KAAKoY,WAAW,CAAEtI,SAAS,KvCysN5BpK,EuClsND02B,YAAA,SAAYtkB,GACP9X,KAAKsvB,MACRtvB,KAAKsvB,MAAM7F,UAAU3R,GAErB9X,KAAKoY,WAAW,CAAEkR,QAAStpB,KAAKoV,MAAMkU,OAAQxZ,SAAS,KvCysNxDpK,EuCrsNDiiC,QAAA,WAAU,IAAA7gB,EAAA9mB,KACToiC,GAAYgB,UAAUpjC,KAAK2J,MAAM4I,KAChCuD,EAAAA,SACCC,WAAU,SAACpM,GACRA,IACHmd,EAAKnd,KAAK05B,OAAQ,EAClBvc,EAAK6f,SAASh9B,GAGd6N,EAAe+T,KAAK,CACnBjb,KAAM2O,GACNyL,OAAQ5D,EAAKnd,KAAKqH,GAClBsyB,MAAOxc,EAAKnd,KAAK25B,avC6sNpB59B,EuCvsNDihC,SAAA,SAASh9B,GAAM,IAAAwd,EAAAnnB,KACd,GAAI2J,GAAQ3J,KAAK2J,KAAKqH,KAAOrH,EAAKqH,GAAI,CACrC,IAAM42B,EAAc5nC,KAAK2J,KAAKg9B,SAC9B3mC,KAAK2J,KAAK25B,MAAQ35B,EAAK25B,MACvBtjC,KAAK2J,KAAKg9B,UAAW,EACrB3mC,KAAKuV,cACAqyB,GACJ9kB,YAAW,WACVqE,EAAKxd,KAAKg9B,UAAW,EACrBxf,EAAK5R,gBACH,QvCgtNL7P,EuC3sND8D,QAAA,WACKxJ,KAAKkxB,WAAaR,IAAsB1wB,KAAKkxB,WAAaR,GAC7D4N,GAAsBG,SAASz+B,KAAK2J,MAEpC8zB,GAAaC,MAAM,CAAE5hB,IAAK/Q,EAAYxB,SAASE,MAAMD,QAASgI,KAAMxR,KAAK2J,OAAQ4I,KAChFkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA4C,QvCwtNbxW,EAAa0jC,EAAgB,CAAC,CAC5BplC,IAAK,UACL8D,IAAK,WuC5sOP,IAAMsjC,EAAU,GAGhB,OAFAA,EAAQ7nC,KAAKoV,MAAMyF,OAAQ,EAC3BgtB,EAAQ7/B,KAAOhI,KAAKoV,MAAMpN,KACnB6/B,MvCitOAhC,EuCvtOYA,CAAuB94B,EAAAA,WAmgB5C84B,GAAe74B,KAAO,CACrBC,SAAU,qBADX,ICrhBqB66B,GAAAA,SAAAA,GxCgvOnB,SAASA,IACP,OAAOx7B,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAY9C,OAfAoD,EAAe0kC,EAAcx7B,GAMhBw7B,EAAavlC,UwCnvO3BgK,OAAA,WACkBI,EAAAA,WAAW3M,MAApB0M,KACH0f,UAAU/hB,OAAO,WxC0vOfy9B,EwC7vOYA,CAAqB/6B,EAAAA,WAO1C+6B,GAAa96B,KAAO,CACnBC,SAAU,mBCRJ,IAAM86B,GAAY,CACxB,OAAQ,MAAO,OAEHC,GAAY,CACxB,MAAO,QAEKC,GAAY,CACxB,MAAO,OAAQ,MAAO,QAGVC,GAAY,CACxBC,MAAO,CAAEn3B,GAAI,EAAGvB,KAAM,SACtB24B,MAAO,CAAEp3B,GAAI,EAAGvB,KAAM,SACtBuvB,MAAO,CAAEhuB,GAAI,EAAGvB,KAAM,SACtB44B,gBAAiB,CAAEr3B,GAAI,EAAGvB,KAAM,mBAAoB2wB,KAAM,mBAC1DkI,eAAgB,CAAEt3B,GAAI,EAAGvB,KAAM,uBAAwB2wB,KAAM,sBAC7DmI,gBAAiB,CAAEv3B,GAAI,EAAGvB,KAAM,mBAAoB2wB,KAAM,mBAC1DoI,eAAgB,CAAEx3B,GAAI,EAAGvB,KAAM,kBAAmB2wB,KAAM,kBACxDqI,kBAAmB,CAAEz3B,GAAI,EAAGvB,KAAM,sBAAuB2wB,KAAM,sBAGnDsI,GAAiB,CAC7BC,aAAc,CAAE33B,GAAI,EAAGvB,KAAM,iBAAkBm5B,IAAK,CAAC,EAAG,IAExDt1B,UAAW,CAAEtC,GAAI,EAAGvB,KAAM,YAAam5B,IAAK,CAAC,IAC7Cr1B,SAAU,CAAEvC,GAAI,EAAGvB,KAAM,WAAYm5B,IAAK,CAAC,KAKxC79B,EAAYjE,MAAMiB,oBACrB2gC,GAAeH,gBAAkB,CAAEv3B,GAAI,EAAGvB,KAAM,kBAAmBm5B,IAAK,CAAC,IACzEF,GAAeF,eAAiB,CAAEx3B,GAAI,EAAGvB,KAAM,iBAAkBm5B,IAAK,CAAC,KAGxEF,GAAeh1B,YAAc,CAAE1C,GAAI,EAAGvB,KAAM,eAAgBm5B,IAAK,CAAC,IAE3D,IAAMC,GAAe,CAC3BX,GAAUG,gBAAgB54B,KAC1By4B,GAAUI,eAAe74B,KACzBy4B,GAAUK,gBAAgB94B,KAC1By4B,GAAUM,eAAe/4B,KACzBy4B,GAAUO,kBAAkBh5B,MAGtB,SAASq5B,GAAc3I,GAC7B,OAAOA,IAAoD,IAA3C0I,GAAa3jC,QAAQi7B,EAAM7vB,KAAKb,MAqB1C,SAASs5B,GAAuBtJ,GACtC,IAAIh/B,EAOJ,OANIg/B,GAAQA,EAAKU,QAChB1/B,EAAMwB,OAAOY,KAAK6lC,IAAgBprB,MAAK,SAAA7c,GAEtC,OAAgE,IAAzDioC,GAAejoC,GAAKmoC,IAAI1jC,QAAQu6B,EAAKU,MAAM7vB,KAAKU,QAGlD03B,GAAejoC,GAAO,gBAGvB,SAASuoC,GAA4BC,GAC3C,IArBkCj4B,EAsB5BV,EA/BA,SAAuBU,GAK7B,OAJa/O,OAAOY,KAAKqlC,IAAWh4B,QAAO,SAACC,EAAG1P,GAC9C,IAAM6P,EAAO43B,GAAUznC,GACvB,OAAO6P,EAAKU,KAAOA,EAAKV,EAAOH,IAC7B,MA2BU+4B,EAtBqBl4B,EAqBGi4B,EApBxBhnC,OAAOY,KAAK6lC,IAAgBx4B,QAAO,SAACC,EAAG1P,GACnD,IAAM6P,EAAOo4B,GAAejoC,GAC5B,OAAO6P,EAAKU,KAAOA,EAAKV,EAAOH,IAC7B,OAkBkCy4B,IAAI,IAEnCzI,EAAQ,CACb7vB,KAAMA,EACNwwB,OAAQ,GACRV,KAJY9vB,EAAK8vB,MAOlB,OADA35B,QAAQC,IAAI,8BAA+By5B,GACpC,IAAIgJ,GAAMhJ,GAGX,SAASiJ,GAAkBnjC,GACjC,IAAMojC,EAAYpjC,EAAKX,MAAM,KAAKgkC,MAAMC,cACxC,OAAsC,IAAlCxB,GAAU7iC,QAAQmkC,GACdnB,GAAUC,OAC2B,IAAlCH,GAAU9iC,QAAQmkC,GACrBnB,GAAUE,OAC2B,IAAlCH,GAAU/iC,QAAQmkC,GACrBnB,GAAUlJ,WADX,EzC8yOR,IyCpyOamK,GAAb,WAEC,SAAAA,EAAYxjC,GACPA,GACH1D,OAAO8D,OAAO/F,KAAM2F,GAJvB,OAAAwjC,EAgBQK,QAAP,SAAe5jC,GACd,IAAM6jC,EAAW7jC,EAAIN,MAAM,KACrB86B,EAAOqJ,EAASH,MAChBxI,EAAS2I,EAASl6B,KAAK,KAAO,IAEpC,OAAO,IAAI45B,EAAM,CAChB74B,KAFY84B,GAAkBhJ,GAG9BU,OAAQA,EACRV,KAAMA,KAxBTj+B,EAAAgnC,EAAA,CAAA,CAAA1oC,IAAA,UAAA8D,IAAA,WAOe,IAAAN,EAAAjE,KACPuU,EAAU,GAMhB,OALAtS,OAAOY,KAAK7C,MAAMkE,SAAQ,SAAAzD,IACgB,IAArC0oC,EAAM9I,aAAan7B,QAAQzE,KAC9B8T,EAAQ9T,GAAOwD,EAAKxD,OAGf8T,MAdT40B,EAAA,GA6BO,SAASO,GAASvJ,GAKxB,OAJQA,EAAM7vB,KAEZ6vB,EAAQ,IAAIgJ,GAAMhJ,GzCyyOrB39B,EyCz0Oa2mC,GAAAA,eACU,CAAC,KAAM,OAAQ,SAAU,OAAQ,eAAgB,mBC1GjE,IAAMQ,GAAa,CACzB,MAAO,MAAO,MAAO,OAAQ,MAAO,MAAO,MAAO,MAAO,OAAQ,QAKrDC,GAAa,CACzB,MAAO,MAAO,OAAQ,MAAO,KAAM,OAAQ,MAAO,OAEtCC,GAAa,CACzB,MAAO,OAAQ,MAAO,MAAO,QAEjBC,GAAc,CAC1B,kBAAmB,qBAAsB,kBAAmB,kB1C+7O7D,I0Cj7OqBC,GAAAA,SAAAA,G1Co7OnB,SAASA,IACP,OAAO/6B,EAAM3N,MAAMrB,KAAMoB,YAAcpB,KAyDzC,OA5DAoD,EAAe2mC,EAAW/6B,GAM1B+6B,E0Cv7OM96B,UAAP,SAAiBkxB,EAAO7vB,GAIvB,QAJoC,IAAbA,IAAAA,EAAO,MAClB,MAARA,IACH6vB,EAAQA,EAAM7vB,KAAKb,OAASa,EAAO6vB,EAAQ,MAExCA,EAAO,CAEV,OAAQA,EAAM7vB,KAAKb,MAClB,KAAKy4B,GAAUC,MAAM14B,KACrB,KAAKy4B,GAAUE,MAAM34B,KAIrB,KAAKy4B,GAAUlJ,MAAMvvB,KACpB0wB,EAAQA,EAAMW,OAASX,EAAMC,KAC7BD,EAAQp1B,EAAY1E,QAAQ85B,GAC5B,MACD,KAAK+H,GAAUG,gBAAgB54B,KAC/B,KAAKy4B,GAAUI,eAAe74B,KAC9B,KAAKy4B,GAAUK,gBAAgB94B,KAC/B,KAAKy4B,GAAUM,eAAe/4B,KAC9B,KAAKy4B,GAAUO,kBAAkBh5B,KAChC0wB,EAAQp1B,EAAY1E,QAAQ85B,EAAMC,MAClC,MACD,QApCoBn6B,EAqCPk6B,EAAMC,KApCf,IAAI4J,OAAJ,MAAkBL,GAAWp6B,KAAK,KAAlC,QAA8CmG,KAAKzP,IAEpD,SAAiBA,GACvB,OAAO,IAAI+jC,OAAJ,MAAkBJ,GAAWr6B,KAAK,KAAlC,QAA8CmG,KAAKzP,GAiC3BgkC,CAAQ9J,EAAMC,OACxCD,EAAQA,EAAMW,OAASX,EAAMC,KAC7BD,EAAQp1B,EAAY1E,QAAQ85B,KAjC3B,SAAiBl6B,GACvB,OAAO,IAAI+jC,OAAJ,MAAkBH,GAAWt6B,KAAK,KAAlC,QAA8CmG,KAAKzP,GAiC3CikC,CAAQ/J,EAAMC,MA/BvB,SAAkBn6B,GACxB,OAAsC,IAA/B6jC,GAAY5kC,QAAQe,GAiCZkkC,CAAShK,EAAMC,QACzBD,EAAQA,EAAMC,OAHdD,EAAQA,EAAMW,OAASX,EAAMC,KAC7BD,EAAQp1B,EAAY1E,QAAQ85B,IAK/BA,EAAQA,OAERA,EAAQ,KAjDJ,IAAiBl6B,EAoDtB,OAAOk6B,G1Cs8OA4J,E0C9+OYA,CAAkBv6B,EAAAA,MA2CvCu6B,GAAU/8B,KAAO,CAChByC,KAAM,SADP,ICtEqB26B,GAAAA,SAAAA,G3CghPnB,SAASA,IACP,OAAO99B,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAegnC,EAA8B99B,GAM7C,IAAI5G,EAAS0kC,EAA6B7nC,UA+B1C,OA7BAmD,E2CphPD6G,OAAA,WACCD,EAAA/J,UAAMgK,OAAN1I,KAAA7D,MADQ,IAEAw+B,EAAmB7xB,EAAAA,WAAW3M,MAA9Bw+B,eACJA,aAA0BN,KAC7Bl+B,KAAKwR,KAAOgtB,EAAe/0B,MAAM+H,O3C2hPlC9L,E2CvhPD2kC,SAAA,SAASt2B,GACR0pB,GAAap9B,W3C0hPbqF,E2CvhPD4kC,SAAA,SAASv2B,GACR0pB,GAAan9B,U3CgiPboF,E2CvhPD4c,MAAA,WACCmb,GAAan9B,U3C0hPN8pC,E2CnjPYA,CAAqCr9B,EAAAA,WA8B1Dq9B,GAA6Bp9B,KAAO,CACnCC,SAAU,2BADX,IC9BqBs9B,GAAAA,SAAAA,G5C0jPnB,SAASA,IACP,OAAOC,EAAWnpC,MAAMrB,KAAMoB,YAAcpB,KA8B9C,OAjCAoD,EAAemnC,EAAeC,GAMjBD,EAAchoC,U4C5jP5BgK,OAAA,WAAS,IAAAgyB,EAC2C5xB,EAAAA,WAAW3M,MAAtDZ,EADAm/B,EACAn/B,OAAQsN,EADR6xB,EACQ7xB,KAAM8xB,EADdD,EACcC,eAChB7lB,GAFE4lB,EAC8BtxB,SACxB,QACRw9B,EAASC,EAAAA,UAAUh+B,EAAMiM,GAAOpG,KAAKkK,EAAAA,YAAY,IACjDkuB,EAAaj+B,EAAK3H,aAAL,UACnB,GAAI4lC,EAAY,CACf,IAAMC,EAAiBxrC,EAAOyrC,aAAaF,EAAY,CAAC,WACxDF,EAAOl4B,KACNkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA4C,GACXvZ,EAAOiB,QAAQuqC,EAAgBpM,EAAgB7lB,MAEhD+xB,EAAAA,UAAUh+B,EAAM,YAAY6F,KAC3BkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA4C,GAAK,OAAIA,EAAMmyB,yBAE3BtM,EAAc,MAAgBiM,G5CukPxBF,E4CzlPYA,CAAsBQ,EAAAA,WAyB3CR,GAAcv9B,KAAO,CACpBC,SAAQ,YC1BT,IAAI+9B,GAAc,IAEGC,GAAAA,SAAAA,G7CgmPnB,SAASA,IACP,OAAOT,EAAWnpC,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe6nC,EAAmBT,GAMlC,IAAI9kC,EAASulC,EAAkB1oC,UA0G/B,OAxGAmD,E6ChmPD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACA0M,EAASC,EAAAA,WAAW3M,MAApB0M,KACFw+B,EAAUx+B,EAAK3H,aAAa,oBAClC/E,KAAKkrC,QAAUA,EAAUx+B,EAAK5H,cAAcomC,GAAWx+B,EACvD1M,KAAKmrC,OAAS,KACdnrC,KAAKorC,QAAUprC,KAAKorC,QAAQ9qB,KAAKtgB,MACjCA,KAAKqrC,gBAAkBrrC,KAAKqrC,gBAAgB/qB,KAAKtgB,MACjDA,KAAKsrC,aAAetrC,KAAKsrC,aAAahrB,KAAKtgB,MAC3CA,KAAKurC,cAAgBvrC,KAAKurC,cAAcjrB,KAAKtgB,MAC7CA,KAAKwrC,eACLP,EAAkBQ,UAAUl5B,KAC3BkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA/E,GAEP/M,EAAK+M,KAAOA,EACftE,EAAK0f,UAAUC,IAAI,WAEnB3f,EAAK0f,UAAU/hB,OAAO,e7CumPxB3E,E6ClmPD0lC,QAAA,SAAQzyB,GAAO,IACNjM,EAASC,EAAAA,WAAW3M,MAApB0M,KACY,OAAhB1M,KAAKmrC,OACRnrC,KAAKsrC,eAEoB5+B,EAAK5H,cAAc,oBAG3C9E,KAAKurC,iB7C0mPP7lC,E6CrmPD2lC,gBAAA,SAAgB1yB,GAAO,IACdjM,EAASC,EAAAA,WAAW3M,MAApB0M,KACcA,IAASiM,EAAMlX,QAAUiL,EAAKg/B,SAAS/yB,EAAMlX,SAElEzB,KAAKurC,iB7C4mPN7lC,E6CxmPD4lC,aAAA,WACqB,OAAhBtrC,KAAKmrC,SACRnrC,KAAKmrC,QAAS,EACdnrC,KAAK2rC,uBACLV,EAAkBQ,UAAUx3B,KAAKjU,KAAKgR,IACtChR,KAAK4rC,QAAQ33B,KAAKjU,KAAKgR,M7C4mPxBtL,E6CxmPD6lC,cAAA,WACqB,OAAhBvrC,KAAKmrC,SACRnrC,KAAK6rC,0BACL7rC,KAAKmrC,OAAS,KACVF,EAAkBQ,UAAUnzB,aAAetY,KAAKgR,KACnDi6B,EAAkBQ,UAAUx3B,KAAK,MACjCjU,KAAK4rC,QAAQ33B,KAAK,S7C8mPpBvO,E6CzmPD8lC,aAAA,WACCxrC,KAAKkrC,QAAQ7T,iBAAiB,QAASr3B,KAAKorC,U7C4mP5C1lC,E6CzmPDimC,qBAAA,WACC9mC,SAASwyB,iBAAiB,QAASr3B,KAAKqrC,kB7C4mPxC3lC,E6CzmPDomC,gBAAA,WACC9rC,KAAKkrC,QAAQvT,oBAAoB,QAAS33B,KAAKorC,U7C4mP/C1lC,E6CzmPDmmC,wBAAA,WACChnC,SAAS8yB,oBAAoB,QAAS33B,KAAKqrC,kB7C4mP3C3lC,E6CzmPDgyB,UAAA,WACC13B,KAAK8rC,kBACL9rC,KAAK6rC,2B7C4mPLZ,E6CzmPMc,OAAP,WACC,OAAOf,M7C4mPP7oC,EAAa8oC,EAAmB,CAAC,CAC/BxqC,IAAK,KACL8D,IAAK,W6CtsPP,OAAOvE,KAAKgsC,UAAYhsC,KAAKisC,MAAQjsC,KAAKisC,IAAMhB,EAAkBc,c7C2sP3Dd,E6C9sPYA,CAA0BF,EAAAA,WAgG/CE,GAAkBj+B,KAAO,CACxBC,SAAU,aACViE,OAAQ,CAAC,WAAY,oBACrBqf,QAAS,CAAC,YAGX0a,GAAkBQ,UAAY,IAAIv2B,EAAAA,gBAAgB,MAAlD,ICxGqBg3B,GAAAA,SAAAA,G9C0tPnB,SAASA,IACP,OAAO1B,EAAWnpC,MAAMrB,KAAMoB,YAAcpB,KA6B9C,OAhCAoD,EAAe8oC,EAAuB1B,GAMzB0B,EAAsB3pC,U8CxtPpCgK,OAAA,WAAS,IAAAtI,EAAAjE,KACA0M,EAASC,EAAAA,WAAW3M,MAApB0M,KACRA,EAAK0f,UAAUC,IAAI,iBACnB4e,GAAkBQ,UAAUl5B,KAC3BkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA/E,GAEP/M,EAAK+M,KAAOA,EACftE,EAAK0f,UAAUC,IAAI,WAEnB3f,EAAK0f,UAAU/hB,OAAO,e9CiuPxBlI,EAAa+pC,EAAuB,CAAC,CACnCzrC,IAAK,KACL8D,IAAK,W8ChvPP,OAAOvE,KAAK,qB9CqvPLksC,E8CxvPYA,CAA8BnB,EAAAA,WAuBnDmB,GAAsBl/B,KAAO,CAC5BC,SAAU,qCACViE,OAAQ,CAAC,kBAFV,ICnBai7B,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAA/qC,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAA+oC,EAAAC,GAAAD,EAAA,EALC,SAAYE,GACXrsC,KAAKqsC,MAAQA,KAMMC,GAAAA,W/CqwPnB,SAASA,KAwBT,OAtBAA,E+CtwPM5O,MAAP,SAAa2O,GAAO,IAAApoC,EAAAjE,KAMnB,OALAqsC,EAAMr7B,IAAK,IAAI8T,MAAOynB,UACtBvsC,KAAKwsC,OAAOv4B,KAAKo4B,GACjBvpB,YAAW,WACV7e,EAAK5D,QAAQgsC,KACXA,EAAMI,UAAY,KACdzsC,KAAK89B,S/CixPZwO,E+CxwPMjsC,QAAP,SAAegsC,GACdrsC,KAAKwsC,OAAOv4B,KAAK,MACjBjU,KAAK89B,QAAQ7pB,KAAK,IAAIk4B,GAAkBE,K/C2wPjCC,E+C7xPYA,GAsBrBA,GAAaE,OAAS,IAAIvO,EAAAA,QAC1BqO,GAAaxO,QAAU,IAAIG,EAAAA,QAA3B,IC7BqByO,GAAAA,SAAAA,GhDyyPnB,SAASA,IACP,OAAOpgC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAqB9C,OAxBAoD,EAAespC,EAAsBpgC,GAMxBogC,EAAqBnqC,UgD5yPnCgK,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKqsC,MAAQ,KACbrsC,KAAKowB,YAAc,GACnBkc,GAAaE,OAAOj6B,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAs2B,GACPA,IACHpoC,EAAKmsB,YAAcic,EAAM50B,SAE1BxT,EAAKooC,MAAQA,EACbpoC,EAAKsR,kBhDozPCm3B,EgD/zPYA,CAA6B3/B,EAAAA,WAiBlD2/B,GAAqB1/B,KAAO,CAC3BC,SAAU,iBACV1D,SAAQ,8JAFT,IChBqBojC,GAAAA,SAAAA,GjDw0PnB,SAASA,IACP,OAAOrgC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeupC,EAAgBrgC,GAM/B,IAAI5G,EAASinC,EAAepqC,UAoH5B,OAlHAmD,EiD50PD6G,OAAA,WACCvM,KAAKqb,KAAO,EACZrb,KAAK4sC,UAAY3qC,OAAOY,KAAK87B,IAAUtvB,KAAI,SAAA5O,GAC1C,IAAM6P,EAAOquB,GAASl+B,GACtB,MAAO,CACN6P,KAAMA,EACNb,KAAMV,EAAUG,QAAQ,SAAUoB,EAAKb,MACvCo9B,UAAuE,IAA7D9hC,EAAY3D,OAAO0B,kBAAkB5D,QAAQoL,EAAKb,UAG9DzP,KAAK8sC,cAAgB7qC,OAAOY,KAAKo8B,IAAc5vB,KAAI,SAAA5O,GAClD,IAAM6P,EAAO2uB,GAAax+B,GAC1B,MAAO,CACN6P,KAAMA,EACNb,KAAMV,EAAUG,QAAQ,SAAUoB,EAAKb,MACvCo9B,UAA2E,IAAjE9hC,EAAY3D,OAAO2B,sBAAsB7D,QAAQoL,EAAKb,UAGlEzP,KAAK+sC,wBACL/sC,KAAKgtC,6BjD+0PLtnC,EiD50PD8pB,UAAA,WACCxvB,KAAK+sC,wBACL/sC,KAAKgtC,6BjD+0PLtnC,EiD50PDqnC,sBAAA,WAAwB,IAAA9oC,EAAAjE,KACvBA,KAAKitC,mBAAqBjtC,KAAK4sC,UAAU5pC,QAAO,SAAAsM,GAAC,OAAIrL,EAAKipC,kBAAkB59B,EAAEgB,KAAKb,SAAOiL,MAAK,SAACC,EAAGC,GAClG,OAAID,EAAEkyB,WAAajyB,EAAEiyB,SACb,EAEAlyB,EAAEkyB,SAAW,GAAK,MjDq1P3BnnC,EiDh1PDsnC,0BAAA,WAA4B,IAAAx4B,EAAAxU,KACvBA,KAAK2J,KACR3J,KAAKmtC,uBAAyBntC,KAAK8sC,cAAc9pC,QAAO,SAAAsM,GAAC,OAAIkF,EAAK44B,sBAAsB54B,EAAK7K,KAAK2G,KAAKb,KAAMH,EAAEgB,KAAKb,SAAOiL,MAAK,SAACC,EAAGC,GACnI,OAAID,EAAEkyB,WAAajyB,EAAEiyB,SACb,EAEAlyB,EAAEkyB,SAAW,GAAK,KAI3B7sC,KAAKmtC,uBAAyB,IjDw1P/BznC,EiDp1PD2nC,QAAA,SAAQhyB,GACHrb,KAAKqb,OAASA,IACjBrb,KAAKqb,KAAOA,EACZrb,KAAKuV,gBjDw1PN7P,EiDp1PDwnC,kBAAA,SAAkBI,GAGjB,OAF2I,IAA3H,CAAC3O,GAASE,SAASpvB,KAAMkvB,GAASG,aAAarvB,KAAMkvB,GAASI,OAAOtvB,KAAMkvB,GAASK,MAAMvvB,MAAMvK,QAAQooC,IjD01PxH5nC,EiDr1PD0nC,sBAAA,SAAsBE,EAAcC,GACnC,IAAI7zB,EACJ,OAAQ4zB,GACP,KAAK3O,GAASC,YAAYnvB,KACzBiK,GAAY,EACZ,MACD,KAAKilB,GAASE,SAASpvB,KAGvB,KAAKkvB,GAASG,aAAarvB,KAC1BiK,GAAoJ,IAAxI,CAACulB,GAAaC,IAAIzvB,KAAMwvB,GAAaD,MAAMvvB,KAAMwvB,GAAaE,MAAM1vB,KAAMwvB,GAAaG,YAAY3vB,MAAMvK,QAAQqoC,GAC7H,MACD,KAAK5O,GAASI,OAAOtvB,KACpBiK,GAAuH,IAA3G,CAACulB,GAAaC,IAAIzvB,KAAMwvB,GAAaD,MAAMvvB,KAAMwvB,GAAaI,QAAQ5vB,MAAMvK,QAAQqoC,GAChG,MACD,KAAK5O,GAASK,MAAMvvB,KACnBiK,GAAoJ,IAAxI,CAACulB,GAAaC,IAAIzvB,KAAMwvB,GAAaD,MAAMvvB,KAAMwvB,GAAaE,MAAM1vB,KAAMwvB,GAAaG,YAAY3vB,MAAMvK,QAAQqoC,GAI/H,OAAO7zB,GjD81PPhU,EiD31PD8nC,SAAA,SAAS70B,GACR3Y,KAAK2N,OAAOsG,KAAK0E,IjD81PjBjT,EiD31PD+nC,SAAA,SAAS90B,GACR3Y,KAAK6N,OAAOoG,KAAK0E,IjD81PjBjT,EiD31PDgoC,SAAA,SAAS/0B,GACR3Y,KAAKkZ,OAAOjF,KAAK0E,IjD81PVg0B,EiDh8PYA,CAAuB5/B,EAAAA,WAsG5C4/B,GAAe3/B,KAAO,CACrBC,SAAU,UACVsjB,QAAS,CAAC,SAAU,SAAU,UAC9Brf,OAAQ,CAAC,SAHV,ICtGay8B,GAAb,WAAA,SAAAA,KAAA,OAAAA,EAEQC,aAAP,SAAoBzN,GACnB,OAAO9uB,EAAYyB,MAAZ,aAAgCqtB,GAAO5tB,KAC7ClD,EAAAA,KAAI,SAAA8wB,GAAK,OAAIuJ,GAASvJ,QAJzBwN,EAQQE,aAAP,SAAoB1N,GACnB,OAAO9uB,EAAY0B,KAAZ,cAA+BotB,EAAMnvB,GAAMmvB,GAAO5tB,KACxDlD,EAAAA,KAAI,SAAA8wB,GAAK,OAAIuJ,GAASvJ,QAVzBwN,EAcQG,aAAP,SAAoB3N,GACnB,OAAIA,GAASA,EAAMnvB,GACXK,EAAYwB,QAAZ,cAAkCstB,EAAMnvB,IAAMuB,KACpDlD,EAAAA,KAAI,WAAA,OAAM,SAGJ+E,EAAAA,GAAG,OApBbu5B,EAwBQI,sBAAP,SAA6BC,EAAI7N,GAChC,OAAO9uB,EAAYyB,MAAZ,QAA0Bk7B,EAA1B,SAAsC7N,GAAO5tB,KACnDlD,EAAAA,KAAI,SAAA8wB,GAAK,OAAIuJ,GAASvJ,QA1BzBwN,EA8BQM,sBAAP,SAA6BD,EAAI7N,GAChC,OAAO9uB,EAAY0B,KAAZ,QAAyBi7B,EAAzB,UAAqC7N,EAAMnvB,GAAMmvB,GAAO5tB,KAC9DlD,EAAAA,KAAI,SAAA8wB,GAAK,OAAIuJ,GAASvJ,QAhCzBwN,EAoCQO,QAAP,SAAeC,GACd,IAAMC,EAAW,IAAIC,SACrBF,EAAMjqC,SAAQ,SAAAk8B,GAAI,OAAIgO,EAASE,OAAO,OAAQlO,EAAMA,EAAK3wB,SACzD,IAAM8+B,EAAM,IAAIC,eACV1Q,EAAU/5B,EAAAA,MACf2mC,EAAAA,UAAU6D,EAAIzgC,OAAQ,aACtB48B,EAAAA,UAAU6D,EAAIzgC,OAAQ,YACtB48B,EAAAA,UAAU6D,EAAIzgC,OAAQ,QACtB48B,EAAAA,UAAU6D,EAAK,qBACdh8B,KACDlD,EAAAA,KAAI,SAAAsJ,GACH,OAAQA,EAAMrI,MACb,IAAK,mBACJ,OAAuB,IAAnBi+B,EAAIE,WACAxiC,KAAKC,MAAMqiC,EAAIG,cAEf,KAGT,QACC,OAAO,SAGV1rC,EAAAA,QAAO,SAAA2V,GAAK,OAAc,OAAVA,MAIjB,OAFA41B,EAAI7P,KAAK,OAAT,gBAAiC,GACjC6P,EAAIhjB,KAAK6iB,GACFtQ,GA/DT6P,EAkEQgB,qBAAP,SAA4BC,EAAS9+B,GACpC,IAAMhC,EAAS8gC,EAAQ,GACjBzO,EAAQgJ,GAAMK,QAAQ17B,EAAOlI,KACnC,OAAIkK,EAAQlP,OAASkP,EAAQlP,MAAMoQ,IAClCmvB,EAAMnvB,GAAKlB,EAAQlP,MAAMoQ,GAClB28B,EAAaE,aAAa1N,IAE1BwN,EAAaC,aAAazN,IAzEpCwN,EA6EQkB,8BAAP,SAAqCD,EAAS9+B,EAASk+B,GACtD,IAAMlgC,EAAS8gC,EAAQ,GACjBzO,EAAQgJ,GAAMK,QAAQ17B,EAAOlI,KACnC,OAAIkK,EAAQlP,OAASkP,EAAQlP,MAAMoQ,IAClCmvB,EAAMnvB,GAAKlB,EAAQlP,MAAMoQ,GAClB28B,EAAaM,sBAAsBD,EAAI7N,IAEvCwN,EAAaI,sBAAsBC,EAAI7N,IApFjDwN,EAwFQmB,eAAP,SAAsB1Y,EAAU2Y,GAC/B,IAAIC,EAAa,KACbC,EAAe,KACfC,EAAY,KACZC,EAAc,KASlB,OARI/Y,IACH4Y,EAAa5Y,EAASplB,GACtBi+B,EAAe7Y,EAASgK,MAErB2O,IACHG,EAAYH,EAAQ/9B,GACpBm+B,EAAcJ,EAAQ3O,MAEf4O,IAAeE,GAAaD,IAAiBE,GArGvDxB,EAAA,GCAqByB,GAAAA,WnDojQnB,SAASA,KAiKT,OA/JAA,EmDpjQM/M,MAAP,WAUC,OATKriC,KAAKsiC,SACTtiC,KAAKsiC,OAASjxB,EAAYsB,KAAZ,aAA8BJ,KAC3ClD,EAAAA,KAAI,SAAAmC,GAEH,OADAA,EAAKgxB,MAAQhxB,EAAKgxB,MAAMnzB,KAAI,SAAA1F,GAAI,OAAIw4B,GAAQx4B,MACrC6H,KAERiL,EAAAA,YAAY,KAGPzc,KAAKsiC,QnDujQZ8M,EmDpjQMC,eAAP,WACC,OAAOrvC,KAAKqiC,QAAQ9vB,KACnBlD,EAAAA,KAAI,SAAAmC,GACH,IAAM7L,EAAU6L,EAAKgxB,MAAMnzB,KAAI,SAAA1F,GAAI,MAAK,CAAEqH,GAAIrH,EAAKqH,GAAIvB,KAAM9F,EAAK8F,SAElE,OADA9J,EAAQoL,QAAQ,CAAEC,GAAI,KAAMvB,KAAMV,EAAUE,UAAU,YAC/CtJ,OnD+jQTypC,EmD1jQME,YAAP,SAAmB3lC,GAClB,OAAO0H,EAAYyB,MAAZ,YAA+BnJ,GAAM4I,KAC3ClD,EAAAA,KAAI,SAAA1F,GAAI,OAAIw4B,GAAQx4B,QnD8jQrBylC,EmD3jQMG,YAAP,SAAmB5lC,GAClB,OAAO0H,EAAY0B,KAAZ,aAA8BpJ,EAAKqH,GAAMrH,EAAK4K,SAAShC,KAC7DlD,EAAAA,KAAI,SAAA1F,GAAI,OAAIw4B,GAAQx4B,QnD+jQrBylC,EmD5jQMI,YAAP,SAAmB7lC,GAClB,OAAO0H,EAAYwB,QAAZ,aAAiClJ,EAAKqH,KnD+jQ7Co+B,EmD5jQMzN,QAAP,SAAeh4B,GACd,IAAIe,EAIJ,OAHIf,EAAK2G,KAAKb,OAASkvB,GAASG,aAAarvB,OAC5C/E,EAAOf,EAAKg2B,MAAMh2B,EAAKT,QAEjBwB,GnDikQP0kC,EmD9jQMK,iBAAP,SAAwB9lC,EAAM81B,GAC7B,IAAM/0B,EAAO1K,KAAK2hC,QAAQh4B,GAC1B,OAAIe,EACI1K,KAAK0vC,gBAAgB/lC,EAAMe,EAAM+0B,GAEjCz/B,KAAK2vC,YAAYhmC,EAAM81B,InDmkQ/B2P,EmDhkQMQ,iBAAP,SAAwBjmC,EAAM81B,GAC7B,IAAM/0B,EAAO1K,KAAK2hC,QAAQh4B,GAC1B,OAAIe,EACI1K,KAAK6vC,gBAAgBlmC,EAAMe,EAAM+0B,GAEjCz/B,KAAK8vC,YAAYnmC,EAAM81B,InDqkQ/B2P,EmDlkQMW,iBAAP,SAAwBpmC,EAAM81B,GAC7B,IAAM/0B,EAAO1K,KAAK2hC,QAAQh4B,GAC1B,OAAIe,EACI1K,KAAKgwC,gBAAgBrmC,EAAMe,EAAM+0B,GAEjCz/B,KAAKiwC,YAAYtmC,EAAM81B,InDukQ/B2P,EmDpkQMc,uBAAP,SAA8BvmC,EAAM81B,GACnC,IACI0Q,EADEzlC,EAAO1K,KAAK2hC,QAAQh4B,IAGzBwmC,EADGzlC,EACWA,EAAKw2B,KAAK5jB,MAAK,SAAA3b,GAAC,OAAIA,EAAEqP,KAAOyuB,EAAKzuB,MAElCrH,EAAK61B,MAAMliB,MAAK,SAAA3b,GAAC,OAAIA,EAAEqP,KAAOyuB,EAAKzuB,QAGjD/O,OAAO8D,OAAOoqC,EAAa1Q,InD8kQ5B2P,EmD3kQMgB,uBAAP,SAA8BzmC,EAAM81B,GACnC,IACID,EADE90B,EAAO1K,KAAK2hC,QAAQh4B,GAO1B,GAJC61B,EADG90B,EACKA,EAAKw2B,KAELv3B,EAAK61B,MAEH,CACV,IAAMt2B,EAAQs2B,EAAMt6B,QAAQu6B,IACb,IAAXv2B,GACHs2B,EAAM7hB,OAAOzU,EAAO,GAEjBwB,GACHf,EAAK63B,uBnDolQP4N,EmD/kQMO,YAAP,SAAmBhmC,EAAM81B,GACxB,OAAOpuB,EAAYyB,MAAZ,aAA+BnJ,EAAKqH,GAApC,QAA+CyuB,GAAMltB,KAC3DlD,EAAAA,KAAI,SAAAowB,GAAI,OAAIC,GAAYD,QnDmlQzB2P,EmDhlQMU,YAAP,SAAmBnmC,EAAM81B,GACxB,OAAOpuB,EAAY0B,KAAZ,aAA8BpJ,EAAKqH,GAAnC,SAA8CyuB,EAAKzuB,GAAMyuB,EAAKlrB,SAAShC,KAC7ElD,EAAAA,KAAI,SAAAowB,GAAI,OAAIC,GAAYD,QnDolQzB2P,EmDjlQMa,YAAP,SAAmBtmC,EAAM81B,GACxB,OAAOpuB,EAAYwB,QAAZ,aAAiClJ,EAAKqH,GAAtC,SAAiDyuB,EAAKzuB,KnDolQ7Do+B,EmDjlQMM,gBAAP,SAAuB/lC,EAAMe,EAAM+0B,GAClC,OAAOpuB,EAAYyB,MAAZ,aAA+BnJ,EAAKqH,GAApC,SAA+CtG,EAAKsG,GAApD,QAA+DyuB,GAAMltB,KAC3ElD,EAAAA,KAAI,SAAAowB,GAAI,OAAIC,GAAYD,QnDqlQzB2P,EmDllQMS,gBAAP,SAAuBlmC,EAAMe,EAAM+0B,GAClC,OAAOpuB,EAAY0B,KAAZ,aAA8BpJ,EAAKqH,GAAnC,SAA8CtG,EAAKsG,GAAnD,SAA8DyuB,EAAKzuB,GAAMyuB,EAAKlrB,SAAShC,KAC7FlD,EAAAA,KAAI,SAAAowB,GAAI,OAAIC,GAAYD,QnDslQzB2P,EmDnlQMY,gBAAP,SAAuBrmC,EAAMe,EAAM+0B,GAClC,OAAOpuB,EAAYwB,QAAZ,aAAiClJ,EAAKqH,GAAtC,SAAiDtG,EAAKsG,GAAtD,SAAiEyuB,EAAKzuB,KnDslQtEo+B,EmDrtQYA,GCYAiB,GAAAA,SAAAA,GpD6sQnB,SAASA,IACP,OAAO/jC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeitC,EAAiB/jC,GAMhC,IAAI5G,EAAS2qC,EAAgB9tC,UAuc7B,OArcAmD,EoDjtQD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACS2M,EAAAA,WAAW3M,MAApB0M,KACH0f,UAAU/hB,OAAO,UACtBrK,KAAKswC,OAAQ,EACbtwC,KAAKuwC,UAAW,EAChBvwC,KAAKoV,MAAQ,GACbpV,KAAKwR,KAAO,KACZxR,KAAKwiC,MAAQ,KACbxiC,KAAK2J,KAAO,KACZ3J,KAAKL,KAAO,KACZK,KAAK+d,MAAQ,KACb/d,KAAKqd,QAAU,GACfrd,KAAKwwC,QAAU,IAAIvS,EAAAA,SACDj+B,KAAK8lC,UAAYlC,GAAUiB,cACnCN,QAAQhyB,KACjBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA9C,GAAM,OAAIhP,EAAKsR,iBAC3BvV,KAAK+lC,epDwtQLrgC,EoDrtQDqgC,YAAA,WAAc,IAAAvxB,EAAAxU,KACb6T,EAAYK,MAAM3B,KACjBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAhC,GACPA,GAAQA,EAAKzD,OAAS+C,EAASC,WAClCkB,EAAKT,KAAOA,EACZS,EAAKi8B,aAELhsC,OAAOC,SAAS6B,KAAOwE,EAAYnF,IAAIuD,WpD2tQzCzD,EoDttQD+qC,UAAA,WAAY,IAAA97B,EAAA3U,KACL+T,EAAO/T,KAAK+T,KAGZqB,EAAQ,CACbrB,KAAMA,EACN8G,KAJY9G,EAAKzD,KAKjBb,KAJYsE,EAAK2nB,WAAa3nB,EAAK4nB,SAAc5nB,EAAK2nB,UAA1C,IAAuD3nB,EAAK4nB,SAAa,KAKrFlvB,KAAM,KACN5F,YAAakE,EAAYlE,YACzBoU,IAAK,KACLhI,OAAQ+L,GACR6D,YAAY,EACZoC,WAAW,EACXmF,QAAQ,EACRta,SAAS,EACT6a,OAAO,EACPR,QAAQ,EACRoc,MAAM,EACN5d,aAAa,EACbM,YAAY,GAEb9Q,EAAa/C,MAAQA,EACrB+C,EAAaE,OAAO9F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAX,GACXT,EAAKS,MAAQA,EACbT,EAAKwV,OAAS/U,EAAM+U,OACpBxV,EAAKY,iBAENvV,KAAKymC,gBAAgBl0B,KACpBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAApM,OAGZiQ,EAAcyB,KAAO1B,GpDutQrBjU,EoDntQD+gC,cAAA,WAAgB,IAAA5xB,EAAA7U,KACf,OAAOovC,GAAc/M,QAAQ9vB,KAC5B8B,EAAAA,WAAU,SAAA7C,GAGT,OAFAqD,EAAKrD,KAAOA,EACZqD,EAAK2tB,MAAQhxB,EAAKgxB,MAAMx/B,QAAO,SAAAsM,GAAC,MAAoB,iBAAhBA,EAAEgB,KAAKb,QACpC2yB,GAAYc,YAAY1xB,MAEhCiD,EAAAA,KAAI,SAAA9K,GACHkL,EAAKlL,KAAO,KACZkL,EAAKU,iBAENm7B,EAAAA,MAAM,GACNj8B,EAAAA,KAAI,SAAA9K,GACHkL,EAAKlL,KAAOA,EACZkL,EAAKU,mBpDytQP7P,EoDptQDyhC,QAAA,SAAQC,GAEP,IAAM1c,EAAS0c,EAAQ1c,OACV1qB,KAAKwR,KAAKgxB,MAAMllB,MAAK,SAAAhO,GAAC,OAAIA,EAAE0B,KAAO0Z,OAE/C0X,GAAYQ,OAAS,CAAElY,OAAAA,EAAQmY,gBAAiBuE,EAAQvE,mBpD8tQzDn9B,EoD1tQDirC,uBAAA,SAAuBl5B,GAAS,IAAA1C,EAAA/U,KAC/By9B,GAAaC,MAAM,CAAE5hB,IAAK/Q,EAAYxB,SAASE,MAAMC,eAAgB8H,KAAM,OAAQe,KAClFkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA4C,GACPA,aAAiB0kB,GACpBtoB,EAAKqD,WAAW,CAAEtI,SAAS,EAAMwZ,QAAQ,IAEzCvU,EAAKqD,WAAW,CAAEtI,SAAS,EAAOwZ,QAAQ,QpDwuQ5C5jB,EoDnuQD0S,WAAA,SAAWhD,GACVpV,KAAKoV,MAAQnT,OAAO8D,OAAO,GAAI/F,KAAKoV,MAAOA,GAC3CpV,KAAKuV,epDsuQL7P,EoDluQD8D,QAAA,WACCi0B,GAAaC,MAAM,CAAE5hB,IAAK/Q,EAAYxB,SAASE,MAAMD,QAASgI,KAAMxR,KAAK2J,OAAQ4I,KAChFkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA4C,QpD8uQZjT,EoDluQDu1B,WAAA,WACC,GAAI,YAAax2B,OAAQ,CACxB,IAAMyB,EAAS,IAAI1B,gBAAgBC,OAAOC,SAASC,QAC7CkG,EAAQ3E,EAAO3B,IAAI,UAAY,KAC/B6C,EAASlB,EAAO3B,IAAI,WAAa,KACjCsW,EAAO3U,EAAO3B,IAAI,SAAW,KAC7BkI,EAAOvG,EAAO3B,IAAI,SAAW,KAC7BkL,EAAOvJ,EAAO3B,IAAI,SAAW,KAC7BqB,EAAG,GAAMnB,OAAOC,SAASyB,OAAS1B,OAAOC,SAASy2B,SAA/C,SAAgE1uB,GAAOgD,EAAI,SAAYA,EAAS,KAAKoL,EAAI,SAAYA,EAAS,KAAKhQ,EAAK,SAAc,KAAKzD,EAAM,UAAe,IAEzL3C,OAAO4G,QAAQ+vB,aAAa,CAAEC,UAAa52B,OAAO42B,WAAa,GAAIz1B,KpDwuQpEF,EoDpuQDkrC,cAAA,WACC5wC,KAAKswC,OAAStwC,KAAKswC,MACnBtwC,KAAKuV,cACL9Q,OAAOosC,cAAc,IAAIC,MAAM,YpDuuQ/BprC,EoDpuQDqrC,iBAAA,WACC/wC,KAAKuwC,UAAYvwC,KAAKuwC,SACtBvwC,KAAKuV,epDwuQL7P,EoDnuQDsrC,UAAA,SAAUr4B,GAET3Y,KAAKwwC,QAAQv8B,KAAK0E,IpDsuQlBjT,EoDnuQDurC,aAAA,SAAav4B,GACR1Y,KAAKkxC,sBACRlxC,KAAKkxC,oBAAoB/6B,cACzBnW,KAAKkxC,oBAAsB,MAEJ,mBAAbx4B,IACV1Y,KAAKkxC,oBAAsBlxC,KAAKwwC,QAAQj+B,KACvCuD,EAAAA,SACCC,WAAU,SAAAwkB,GAAQ,OAAI7hB,EAAS6hB,QpDwuQlC70B,EoDpuQDyrC,UAAA,SAAUx4B,GAAO,IAAAmO,EAAA9mB,KAChBovC,GAAcQ,iBAAiB5vC,KAAK2J,KAAMgP,EAAM8mB,MAAMltB,KACrDuD,EAAAA,SACCC,WAAU,SAAA9D,GAEX6U,EAAKvR,iBACH,SAAA1U,GAAK,OAAI4F,QAAQC,IAAI,mDAAoD7F,OpDyuQ5E6E,EoDtuQD0rC,YAAA,SAAYz4B,GACXlS,QAAQC,IAAI,gCpDivQZhB,EoDtuQD2rC,cAAA,SAAc14B,GAGZ,IAAI24B,EADDtxC,KAAK2J,OAER3J,KAAK2J,KAAK61B,MAAMt7B,SAAQ,SAAAu7B,GAAI,OAAIA,EAAK8R,WAAY,KACjDvxC,KAAK2J,KAAK61B,MAAMt7B,SAAQ,SAAAu7B,GACvBA,EAAKwB,SAAWxB,IAAS9mB,EAAM8mB,KAC/B6R,EAAe7R,EAAKwB,SAAWxB,EAAO6R,KAEvCtxC,KAAK2J,KAAKs3B,UAAYqQ,EACtBtxC,KAAKuV,cACD+7B,IACHtxC,KAAKswC,OAAQ,EACbtwC,KAAKuV,cACL9Q,OAAOosC,cAAc,IAAIC,MAAM,cpD8uQjCprC,EoDzuQD8rC,YAAA,SAAY/nC,EAAO+H,GAAM,IAAA2V,EAAAnnB,KACxBy9B,GAAaC,MAAM,CAAE5hB,IAAK/Q,EAAYxB,SAASE,MAAMA,EAAM6G,MAAM7G,EAAM7I,OAAQ4Q,KAAAA,IAAQe,KACtFuD,EAAAA,SACCC,WAAU,SAAA4C,GACX,GAAIA,aAAiB0kB,GAEpB,OADA52B,QAAQC,IAAI,sCAAuCiS,GAC5ClP,EAAM6G,MACZ,IAAK,OACJ,OAAQ7G,EAAM7I,OACb,KAAK+9B,GAASE,SAASpvB,KACvB,KAAKkvB,GAASG,aAAarvB,KAC3B,KAAKkvB,GAASK,MAAMvvB,KACnB0X,EAAK3V,KAAKgxB,MAAMr/B,KAAKwV,EAAMnH,MAC3B4wB,GAAY1X,OAAS/R,EAAMnH,KAAKR,GAChCmW,EAAK5R,cAIP,MACD,IAAK,WACJ,OAAQ9L,EAAM7I,OACb,KAAKq+B,GAAaC,IAAIzvB,KACtB,KAAKwvB,GAAaE,MAAM1vB,KACxB,KAAKwvB,GAAaG,YAAY3vB,KAC9B,KAAKwvB,GAAaD,MAAMvvB,KACvB,IAAM/E,EAAO0kC,GAAczN,QAAQxa,EAAKxd,MACxC,GAAIe,EAAM,CACT,IAAMw2B,EAAOx2B,EAAKw2B,MAAQ,GAC1BA,EAAK/9B,KAAKwV,EAAMnH,MAChBvP,OAAO8D,OAAO2E,EAAM,CAAEw2B,KAAAA,IACtB/Z,EAAKxd,KAAK63B,yBACJ,CACN,IAAMhC,EAAQrY,EAAKxd,KAAK61B,OAAS,GACjCA,EAAMr8B,KAAKwV,EAAMnH,MACjBvP,OAAO8D,OAAOohB,EAAKxd,KAAM,CAAE61B,MAAAA,IAE5BrY,EAAK5R,eAQV4R,EAAK5R,kBpD8vQN7P,EoD1vQD+rC,cAAA,SAAc94B,GAAO,IAAA6O,EAAAxnB,KAEpB,GAAI2Y,EAAM/X,MACT,OAAQ+X,EAAM/X,OACb,KAAKq+B,GAAaC,IAAIzvB,KACtB,KAAKwvB,GAAaE,MAAM1vB,KACxB,KAAKwvB,GAAaG,YAAY3vB,KAC7BzP,KAAKixC,cAAa,SAAC1W,GAClB/S,EAAKgqB,YAAY74B,EAAO,CAAEhP,KAAM6d,EAAK7d,KAAM4wB,SAAAA,OAE5C+R,GAAa5O,MAAM,CAAEjmB,QAAS,8BAC9B,MACD,KAAKwnB,GAAaD,MAAMvvB,KACvB,GAAmB,aAAfkJ,EAAMrI,KAAqB,CAC9B,GAAItQ,KAAK2J,KAAK2G,KAAKb,OAASkvB,GAASK,MAAMvvB,KAC1C,OAEDzP,KAAKixC,cAAa,SAAC1W,GAClB/S,EAAKgqB,YAAY74B,EAAO,CAAEhP,KAAM6d,EAAK7d,KAAM4wB,SAAAA,OAE5C+R,GAAa5O,MAAM,CAAEjmB,QAAS,mCAE9BzX,KAAKwxC,YAAY74B,EAAO,CAAEhP,KAAM3J,KAAK2J,OAEtC,MACD,QACC3J,KAAKwxC,YAAY74B,EAAO,CAAEhP,KAAM3J,KAAK2J,YAEjC,GAAIgP,EAAMhP,OAASgP,EAAM8mB,MAAuB,OAAf9mB,EAAM8mB,MAC7C9mB,EAAMhP,KAAKs3B,UAAW,EACtBtoB,EAAMhP,KAAK61B,MAAMt7B,SAAQ,SAAAu7B,GAAI,OAAIA,EAAKwB,SAAWxB,IAAS9mB,EAAM8mB,QAChEz/B,KAAKuV,mBACC,GAAIoD,EAAMhP,OAASgP,EAAMjO,MAAuB,OAAfiO,EAAMjO,MAC7CiO,EAAMhP,KAAKs3B,UAAW,EACtBtoB,EAAMhP,KAAKg2B,MAAMz7B,SAAQ,SAAAwG,GAAI,OAAIA,EAAKu2B,SAAWv2B,IAASiO,EAAMjO,QAiBhE1K,KAAKuV,mBACC,GAAIoD,EAAMhP,MAAuB,OAAfgP,EAAMhP,KAAe,CAC7C3J,KAAK2J,KAAKs3B,SAAYjhC,KAAK2J,OAASgP,EAAMhP,KAC1C3J,KAAK2J,KAAK61B,MAAMt7B,SAAQ,SAAAu7B,GAAI,OAAIA,EAAKwB,UAAW,KAChD,IAAMyQ,EAActC,GAAczN,QAAQ3hC,KAAK2J,MAC3C+nC,GACH1xC,KAAK2J,KAAKg2B,MAAMz7B,SAAQ,SAAAwG,GAAI,OAAIA,EAAKu2B,SAAWv2B,IAASgnC,KAE1D1xC,KAAKuV,gBpD6xQN7P,EoDzxQDisC,cAAA,SAAch5B,GAEb,GAAIA,EAAM8mB,MAAQ9mB,EAAMhP,KACvB3J,KAAKuV,mBACC,GAAIoD,EAAMjO,MAAQiO,EAAMhP,WAIxB,GAAIgP,EAAMhP,KAChB,GAAIy4B,GAAY1X,SAAW/R,EAAMhP,KAAKqH,GACrCoxB,GAAY1X,OAAS/R,EAAMhP,KAAKqH,OAC1B,CACN,IAAM89B,EAAiBnB,GAAamB,eAAe9uC,KAAK2J,KAAKw2B,MAAOxnB,EAAMhP,KAAKw2B,OAC/El+B,OAAO8D,OAAO/F,KAAK2J,KAAMgP,EAAMhP,MAC3BmlC,GACoC,mBAA5B9uC,KAAK2J,KAAKioC,eACpB5xC,KAAK2J,KAAKioC,gBAGZ5xC,KAAKuV,gBpD4xQP7P,EoDvxQDmsC,cAAA,SAAcl5B,GAAO,IAAAmP,EAAA9nB,KACpByG,QAAQC,IAAI,gBAAiBiS,GACzBA,EAAM8mB,MAAQ9mB,EAAMhP,KACvBylC,GAAcW,iBAAiBp3B,EAAMhP,KAAMgP,EAAM8mB,MAAMltB,KACtDuD,EAAAA,SACCC,WAAU,SAAA9D,GAEXm9B,GAAcgB,uBAAuBz3B,EAAMhP,KAAMgP,EAAM8mB,MACvD3X,EAAKvS,iBACH,SAAA1U,GAAK,OAAI4F,QAAQC,IAAI,uDAAwD7F,MACtE8X,EAAMhP,MAChBylC,GAAcI,YAAY72B,EAAMhP,MAAM4I,KACrCuD,EAAAA,SACCC,WAAU,SAAA9D,GAEX,IAAM/I,EAAQ4e,EAAKtW,KAAKgxB,MAAMt9B,QAAQyT,EAAMhP,OAC7B,IAAXT,GACH4e,EAAKtW,KAAKgxB,MAAM7kB,OAAOzU,EAAO,GAE/B4e,EAAK0a,MAAQ1a,EAAKtW,KAAKgxB,MAAM1xB,QAC7BsxB,GAAY1X,OAAS5C,EAAK0a,MAAM,GAAGxxB,MAEjC,SAAAnQ,GAAK,OAAI4F,QAAQC,IAAI,kDAAmD7F,OpDgyQrEwvC,EoDxpRYA,CAAwBtjC,EAAAA,WA8X7CsjC,GAAgBrjC,KAAO,CACtBC,SAAU,sBC3YX,IAAI6kC,GAAW,EAEMC,GAAAA,WrDyqRnB,SAASA,KAgKT,OA9JAA,EqD/pRMC,MAAP,WAAe,IAAA/tC,EAAAjE,KACd,OAAOA,KAAKiyC,WAAW1/B,KACtB8B,EAAAA,WAAU,SAAA/M,GAET,OADArD,EAAKiuC,OAAOj+B,KAAK3M,GACVrD,EAAKiuC,YrDqqRdH,EqDhqRME,SAAP,WACC,OAAO5gC,EAAYsB,KAAZ,aAA8BJ,KACpClD,EAAAA,KAAI,SAAAmC,GAIH,OAHAA,EAAKlK,KAAKoT,MAAK,SAACC,EAAGC,GAClB,OAAOD,EAAEG,MAAQF,EAAEE,SAEbtJ,EAAKlK,UrDmqRdyqC,EqD9pRMI,YAAP,SAAmB7qC,GAClB,OAAO+J,EAAY0B,KAAZ,YAA8BzL,IrDiqRrCyqC,EqD9pRMK,gBAAP,SAAuBC,EAAiBv3B,QAAW,IAA5Bu3B,IAAAA,EAAW,WAAiB,IAAXv3B,IAAAA,EAAQ,GAC/C,IAAMvG,EAAU,CACf89B,SAAUA,EACV3nB,OAAQ,KACR5P,MAAe,GAARA,EACPrL,KAAM,aAAeqiC,IAEtB,OAAOzgC,EAAYyB,MAAZ,YAA+ByB,IrDyqRtCw9B,EqDtqRMO,gBAAP,SAAuB7S,GACtB,OAAOpuB,EAAY0B,KAAZ,aAA8B0sB,EAAKzuB,GAAMyuB,IrDyqRhDsS,EqDtqRMQ,gBAAP,SAAuB9S,GACtB,OAAOpuB,EAAYwB,QAAZ,aAAiC4sB,EAAKzuB,KrDyqR7C+gC,EqDtqRMS,cAAP,SAAqBhQ,EAAOp7B,GAAgB,IAAAoN,EAAAxU,KAC3C,YAD2C,IAAhBoH,IAAAA,GAAS,GAC7BpH,KAAKgyC,QAAQz/B,KACnBlD,EAAAA,KAAI,SAAA/H,GACH,GAAIA,GAAQA,EAAK1F,OAChB,OAAO4S,EAAKi+B,aAAanrC,GAEzB,IAAMzE,EAAO,GA+Bb,OA9BA2/B,EAAMt+B,SAAQ,SAAAu7B,GACb,GAAIA,EAAKnvB,KAAKb,OAASkvB,GAASC,YAAYnvB,QAAUgwB,EAAKiT,QAAUtrC,GAAS,CAC7E,IAAIwI,EAAQ/M,EAAK48B,EAAKnvB,KAAKb,MACtBG,IACJA,EAAQ/M,EAAK48B,EAAKnvB,KAAKb,MAAQ,IAEhCG,EAAMzM,KAAKs8B,OAGAx9B,OAAOY,KAAKA,GAAMwM,KAAI,SAAAsjC,GAClC,IAAIljC,EAAO,SACX,OAAQkjC,GACP,KAAKhU,GAASC,YAAYnvB,KACzBA,EAAO,eACP,MACD,KAAKkvB,GAASE,SAASpvB,KACtBA,EAAO,aACP,MACD,KAAKkvB,GAASG,aAAarvB,KAC1BA,EAAO,eACP,MACD,KAAKkvB,GAASI,OAAOtvB,KACpBA,EAAO,YACP,MACD,KAAKkvB,GAASK,MAAMvvB,KACnBA,EAAO,aAGT,MAAO,CAAEA,KAAAA,EAAMa,KAAM,CAAEb,KAAM,cAAgB+vB,MAAOgD,EAAMx/B,QAAO,SAAAsM,GAAC,OAAIA,EAAEgB,KAAKb,OAASkjC,KAAcrjC,EAAEojC,QAAUtrC,erDosRpH2qC,EqD5rRMa,YAAP,SAAmBnT,EAAMD,GACxB,OAAIC,EAAK/U,OACD,CAAE1Z,GAAIyuB,EAAK/U,OAAQjb,KAAMgwB,EAAKhwB,KAAMa,KAAM,CAAEb,KAAM,aAElD,CAAEA,KAAMgwB,EAAKhwB,KAAMa,KAAM,CAAEb,KAAM,cAAgB+vB,MAAOx/B,KAAKyyC,aAAajT,EAAOC,EAAKzuB,MrD4sR9F+gC,EqDxsRMU,aAAP,SAAoBjT,EAAO6S,GAAiB,IAAA19B,EAAA3U,KAC3C,YAD2C,IAAjBqyC,IAAAA,EAAW,MAC9B7S,EAAMx8B,QAAO,SAAAy8B,GAAI,OAAKA,EAAK4S,UAAY,QAAUA,KAAWhjC,KAAI,SAAAowB,GAAI,OAAI9qB,EAAKi+B,YAAYnT,EAAMD,OrDqtRtGr9B,EAAa4vC,EAAa,KAAM,CAAC,CAC/BtxC,IAAK,SACL+F,IAAK,SqD9zRUqsC,GACjB7yC,KAAK8yC,QAAQ7+B,KAAK4+B,IrDg0RhBtuC,IAAK,WqD7zRP,OAAOvE,KAAK8yC,QAAQx6B,erDk0Rby5B,EqDz0RYA,GrD40RrBvvC,EqD50RqBuvC,GAAAA,UAEH,IAAI78B,EAAAA,iBAAgB,IrD40RtC1S,EqD90RqBuvC,GAAAA,SAUJ,IAAI78B,EAAAA,gBAAgB,KAApB,ICXJ69B,GAAb,WAAA,SAAAA,KAAA,OAAAA,EAEQC,MAAP,SAAa1Y,GACZ,GAAI2Y,EAAAA,mBAAqB3Y,EAAO,CAC/B,IAAMtoB,EAAOnN,SAASC,cAAc,QACpC,OAAOf,EAAAA,MAAM2mC,EAAAA,UAAU14B,EAAM,QAAS04B,EAAAA,UAAU14B,EAAM,aAAaO,KAClElD,EAAAA,KAAI,SAACsJ,GACJlS,QAAQC,IAAI,oBAAqBiS,GACjCA,EAAMmyB,iBACFnyB,EAAMlX,SAAW64B,IACpBA,EAAM6T,MAAQx1B,EAAMu6B,aAAa/E,WAMpC,OAAOgF,EAAAA,OAhBVJ,EAoBQK,QAAP,SAAe9Y,GACd,OAAI2Y,EAAAA,mBAAqB3Y,EACjBoQ,EAAAA,UAAUpQ,EAAO,UAAU/nB,KACjCvP,EAAAA,QAAO,SAAC2V,GAAD,OAAW2hB,EAAM6T,OAAS7T,EAAM6T,MAAMvsC,UAC7CyN,EAAAA,KAAI,SAACsJ,GAAD,OAAWxU,MAAMwN,KAAK2oB,EAAM6T,WAG1BgF,EAAAA,OA3BVJ,EA+BQM,OAAP,SAAc/Y,EAAOgZ,GAAe,IAAArvC,EAAAjE,KACnC,YADmC,IAAfszC,IAAAA,EAAW,IACxBtzC,KAAKozC,QAAQ9Y,GAAO/nB,KAC1B8B,EAAAA,WAAU,SAAC85B,GACVmF,EAAS1xC,OAASusC,EAAMvsC,OACxB0xC,EAAS9b,KAAK,MAEd,IAAM+b,EAAWpF,EAAM9+B,KAAI,SAAC+wB,EAAMz+B,GAAP,OAAasC,EAAKuvC,MAAMpT,EAAMz+B,EAAG2xC,GAAU/gC,KACrElD,EAAAA,KAAI,WAAA,OAAM+wB,KACV/rB,EAAAA,WAAU,SAAC+rB,GAAD,OAAUuN,GAAaO,QAAQ,CAAC9N,OAC1C/rB,EAAAA,WAAU,SAACu6B,GACV,IAAM9gC,EAAS8gC,EAAQ,GACjBzO,EAAQgJ,GAAMK,QAAQ17B,EAAOlI,KACnC,OAAO+nC,GAAaC,aAAazN,UAGnC,OAAOrmB,EAAAA,cAAcy5B,QA9CzBR,EAmDQS,MAAP,SAAapT,EAAMz+B,EAAG2xC,GAAe,IAAA9+B,EAAAxU,UAAA,IAAfszC,IAAAA,EAAW,IAChC,IAAMG,EAAS,IAAIC,WACbC,EAAUjJ,EAAAA,UAAU+I,EAAQ,QAAQlhC,KACzC8B,EAAAA,WAAU,SAAAsE,GACT,IAAMi7B,EAAOj7B,EAAMlX,OAAOoyC,OAC1B,OAAOr/B,EAAKs/B,QAAQF,MAErBn/B,EAAAA,KAAI,SAAAs/B,GACHT,EAAS3xC,GAAKoyC,MAIhB,OADAN,EAAOO,cAAc5T,GACduT,GA/DTZ,EAkEQe,QAAP,SAAeF,GACd,OAAOjiC,EAAAA,KAAK3R,KAAKi0C,QAAQL,KAnE3Bb,EAsEQkB,QAAP,SAAeL,GACd,OAAO,IAAI7yC,SAAQ,SAACV,EAASC,GAC5B,IAAM4zC,EAAMrvC,SAAS0W,cAAc,OACnC24B,EAAIC,OAAS,WACZ,IAEMC,EAASvvC,SAAS0W,cAAc,UAChC84B,EAAMD,EAAOznC,WAAW,MAC1B+O,EAAQw4B,EAAIx4B,MACZC,EAASu4B,EAAIv4B,OACbD,EAAQC,EACPD,EAPa,MAQhBC,GARgB,IAQMD,EACtBA,EATgB,KAYbC,EAXc,MAYjBD,GAZiB,IAYKC,EACtBA,EAbiB,KAgBnBy4B,EAAO14B,MAAQA,EACf04B,EAAOz4B,OAASA,EAChB04B,EAAIC,UAAUJ,EAAK,EAAG,EAAGx4B,EAAOC,GAChC,IAAM4mB,EAAU6R,EAAOG,UAAU,aAAc,IAC/Cl0C,EAAQkiC,IAET2R,EAAIM,QAAU,WACbl0C,EAAOszC,IAERM,EAAIp4B,IAAM83B,MApGbb,EAAA,GCJqB0B,GAAAA,SAAAA,GvD+8RnB,SAASA,IACP,OAAOnoC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAiB9C,OApBAoD,EAAeqxC,EAAkBnoC,GAMpBmoC,EAAiBlyC,UuDj9R/BitB,UAAA,WAAY,IACH9iB,EAASC,EAAAA,WAAW3M,MAApB0M,KAGF5F,EADU9G,KAAK8P,QACChJ,MACtB7E,OAAOY,KAAKiE,GAAO5C,SAAQ,SAACzD,GAC3BqG,EAAMrG,GAAOiM,EAAK0f,UAAUC,IAAI5rB,GAAOiM,EAAK0f,UAAU/hB,OAAO5J,OvDy9RvDg0C,EuDj+RYA,CAAyB1nC,EAAAA,WAa9C0nC,GAAiBznC,KAAO,CACvBC,SAAU,YACViE,OAAQ,CAAC,YAFV,ICRqBwjC,GAAAA,SAAAA,GxDo+RnB,SAASA,IACP,OAAOC,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KA+BrD,OAlCAoD,EAAesxC,EAAuBC,GAMzBD,EAAsBnyC,UwDt+RpCgK,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKqW,MAAQrW,KAAKqW,OAAS,QAC3BrW,KAAK6sC,SAAW7sC,KAAK6sC,WAAY,EACjC7sC,KAAK40C,OAAS50C,KAAK40C,QAAU,wBAHrB,IAKFta,EADW3tB,EAAAA,WAAW3M,MAApB0M,KACW5H,cAAc,SACjCw1B,EAAM9e,aAAa,SAAUxb,KAAK40C,QAClC7B,GAAYC,MAAM1Y,GAAO/nB,KACxBkE,EAAAA,UAAUzW,KAAK0W,eACdX,YACFg9B,GAAYK,QAAQ9Y,GAAO/nB,KAC1B8B,EAAAA,WAAU,SAAC85B,GACV,IAAMoF,EAAWpF,EAAM9+B,KAAI,SAAC+wB,EAAMz+B,GAAP,OAAagsC,GAAaO,QAAQ,CAAC9N,IAAO7tB,KACpE8B,EAAAA,WAAU,SAACu6B,GAAD,OAAajB,GAAagB,qBAAqBC,EAAS3qC,EAAK6L,gBAExE,OAAOgK,EAAAA,cAAcy5B,MAEtB98B,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA/M,GAEX/E,EAAK6L,QAAQlP,MAAQoI,EAAO,OxD8+RtB0rC,EwDpgSYA,CAA8BD,IA2BnDC,GAAsB1nC,KAAO,CAC5BC,SAAU,kBACViE,OAAQ,CAAC,UAAW,QAAS,WAAY,UACzC3H,SAAQ,64BAHT,ICzBqBsrC,GAAAA,SAAAA,GzD6gSnB,SAASA,IACP,OAAOC,EAAsBzzC,MAAMrB,KAAMoB,YAAcpB,KAHzDoD,EAAeyxC,EAAsBC,GAMrCD,EyD/gSME,gBAAP,SAAuBtV,GACtB,OAAO,IAAIxvB,EAAAA,UAAU,CACpBe,GAAIyuB,EAAKzuB,GACTqhC,SAAU5S,EAAK4S,SACf3nB,OAAQ+U,EAAK/U,OACbjb,KAAMgwB,EAAKhwB,KACX+vB,MAAO,IAAIwV,EAAAA,azD+hSZ,IAAItvC,EAASmvC,EAAqBtyC,UAmHlC,OAjHAmD,EyDjhSD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKi1C,WAAahK,GAAkBc,SACpC/rC,KAAKuW,SAAWvW,KAAK8P,QAAQyG,SAC7B64B,GAAcC,iBAAiB98B,KAC9BuD,EAAAA,SACCC,WAAU,SAAApQ,GACX1B,EAAKsS,SAASmU,OAAO/kB,QAAUA,MzDqhShCD,EyDjhSDwvC,UAAA,WAAY,IAAA1gC,EAAAxU,KACX+xC,GAAYK,gBAAgBpyC,KAAKuW,SAASvF,GAAGpQ,MAAOZ,KAAKuW,SAASipB,MAAM59B,QAAQ2Q,KAC/EuD,EAAAA,SACCC,WAAU,SAAA0pB,GACXjrB,EAAK+B,SAASipB,MAAMr8B,KAAK0xC,EAAqBE,gBAAgBtV,QzDqhS/D/5B,EyDhhSDyvC,aAAA,WACCn1C,KAAKqK,OAAO4J,KAAKjU,KAAK8P,UzDmhStBpK,EyDhhSD0vC,gBAAA,SAAgBtlC,GAAS,IAAA6E,EAAA3U,KACxB+xC,GAAYQ,gBAAgBziC,EAAQlP,OAAO2R,KAC1CuD,EAAAA,SACCC,WAAU,WACXpB,EAAK4B,SAASipB,MAAMn1B,OAAOyF,OzDohS5BpK,EyD/gSD2vC,WAAA,WACCr1C,KAAKyM,KAAKwH,KAAKjU,KAAK8P,UzDkhSpBpK,EyD/gSD4vC,cAAA,SAAcxlC,GACb9P,KAAKyM,KAAKwH,KAAKnE,IzDkhSfpK,EyD/gSD6vC,SAAA,WACCv1C,KAAKw1C,GAAGvhC,KAAKjU,KAAK8P,UzDkhSlBpK,EyD/gSD+vC,WAAA,WACCz1C,KAAK01C,KAAKzhC,KAAKjU,KAAK8P,UzDkhSpBpK,EyD/gSDiwC,YAAA,SAAY7lC,GACX,IAAM0vB,EAAQx/B,KAAKuW,SAASipB,MACtB59B,EAAS49B,EAAMjpB,SAAS3U,OAC1BsH,EAAQs2B,EAAMjpB,SAASrR,QAAQ4K,GACnC0vB,EAAMjpB,SAASoH,OAAOzU,EAAO,GACzBA,EAAQ,EACXA,IAEAA,EAAQtH,EAAS,EAElB49B,EAAMoW,OAAO9lC,EAAS5G,IzDohStBxD,EyDjhSDmwC,cAAA,SAAc/lC,GACb,IAAM0vB,EAAQx/B,KAAKuW,SAASipB,MACtB59B,EAAS49B,EAAMjpB,SAAS3U,OAC1BsH,EAAQs2B,EAAMjpB,SAASrR,QAAQ4K,GACnC0vB,EAAMjpB,SAASoH,OAAOzU,EAAO,GACzBA,EAAQtH,EAAS,EACpBsH,IAEAA,EAAQ,EAETs2B,EAAMoW,OAAO9lC,EAAS5G,IzDshStBxD,EyDnhSDowC,QAAA,SAAQnsC,GAAM,IAAAkL,EAAA7U,KACbyG,QAAQC,IAAI,+BAAgCiD,EAAKqH,IACjD,IAAMuD,EAAUtS,OAAO8D,OAAO,GAAI/F,KAAK8P,QAAQlP,OAC/C2T,EAAQmW,OAAS/gB,EAAKqH,GAClBrH,EAAKqH,KACRuD,EAAQ9E,KAAO9F,EAAK8F,MAErBsiC,GAAYO,gBAAgB/9B,GAAShC,KACpCuD,EAAAA,SACCC,WAAU,WACXlB,EAAK0B,SAASmU,OAAO9pB,MAAQ+I,EAAKqH,GAC9BrH,EAAKqH,KACR6D,EAAK0B,SAAS9G,KAAK7O,MAAQ+I,EAAK8F,KAEhCoF,EAAK0B,SAASipB,MAAMjpB,SAAW,GAC/B1B,EAAK0B,SAASipB,MAAMuW,uBzD6hStBrwC,EyDvhSDswC,gBAAA,SAAgBr9B,GACflS,QAAQC,IAAI,uCAAwC1G,KAAKuW,SAAS9G,KAAK7O,OACvEmxC,GAAYO,gBAAgBtyC,KAAK8P,QAAQlP,OAAO2R,KAC/CuD,EAAAA,SACCC,azDwhSFrQ,EyDrhSDuwC,UAAA,SAAUxW,GACT,OAAOz/B,KAAKuW,SAASmU,OAAO9pB,QAAU6+B,EAAKzuB,IzDwhS3CtL,EyDrhSDwwC,UAAA,SAAUllC,KzDwhSF6jC,EyD1pSYA,CAA6BH,IAwIlDG,GAAqB7nC,KAAO,CAC3BC,SAAU,iBACVsjB,QAAS,CAAC,SAAU,OAAQ,KAAM,QAClCrf,OAAQ,CAAC,WACT3H,SAAQ,44EAJT,IC3IqB4sC,GAAAA,SAAAA,G1DyqSnB,SAASA,IACP,OAAO7pC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe+yC,EAAsB7pC,GAMrC,IAAI5G,EAASywC,EAAqB5zC,UA0IlC,OAxIAmD,E0D7qSD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAK2W,QAAU,EACf3W,KAAKL,KAAO,KACZoyC,GAAYE,WAAW1/B,KACtBuD,EAAAA,SACCC,WAAU,SAAAzO,GAAI,OAAIrD,EAAK00B,SAASrxB,O1DkrSlC5B,E0D/qSDizB,SAAA,SAASrxB,GAAW,IAAAkN,EAAAxU,UAAA,IAAXsH,IAAAA,EAAO,IACf,IAAMk4B,EAAQx/B,KAAKo2C,eAAe9uC,GAE5B3H,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCuvB,MAAOA,IAESx/B,KAAKuW,SAAW5W,EAAK4W,SACtC5W,EAAK6W,SAASjE,KACbkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAACY,GAEZnC,EAAKmC,UACLnC,EAAKe,kB1DwrSN7P,E0DprSD4vC,cAAA,SAAcxlC,K1DsrSbpK,E0DlrSDiwC,YAAA,SAAY7lC,GACX,IAAM0vB,EAAQx/B,KAAKuW,SAASipB,MACtB59B,EAAS49B,EAAMjpB,SAAS3U,OAC1BsH,EAAQs2B,EAAMjpB,SAASrR,QAAQ4K,GACnC0vB,EAAMjpB,SAASoH,OAAOzU,EAAO,GACzBA,EAAQ,EACXA,IAEAA,EAAQtH,EAAS,EAElB49B,EAAMoW,OAAO9lC,EAAS5G,I1DurStBxD,E0DprSDmwC,cAAA,SAAc/lC,GACb,IAAM0vB,EAAQx/B,KAAKuW,SAASipB,MACtB59B,EAAS49B,EAAMjpB,SAAS3U,OAC1BsH,EAAQs2B,EAAMjpB,SAASrR,QAAQ4K,GACnC0vB,EAAMjpB,SAASoH,OAAOzU,EAAO,GACzBA,EAAQtH,EAAS,EACpBsH,IAEAA,EAAQ,EAETs2B,EAAMoW,OAAO9lC,EAAS5G,I1DyrStBxD,E0DtrSDwvC,UAAA,WAAY,IAAAvgC,EAAA3U,KACX+xC,GAAYK,gBAAgB,KAAMpyC,KAAKuW,SAASipB,MAAM59B,QAAQ2Q,KAC7DuD,EAAAA,SACCC,WAAU,SAAA0pB,GACX9qB,EAAK4B,SAASipB,MAAMr8B,KAAK0xC,GAAqBE,gBAAgBtV,Q1D0rS/D/5B,E0DrrSD0vC,gBAAA,SAAgBtlC,GAAS,IAAA+E,EAAA7U,KACxB+xC,GAAYQ,gBAAgBziC,EAAQlP,OAAO2R,KAC1CuD,EAAAA,SACCC,WAAU,WACXlB,EAAK0B,SAASipB,MAAMn1B,OAAOyF,O1DyrS5BpK,E0DprSD6R,QAAA,WACC,IAAMA,EAAUvX,KAAKL,KAAKyX,MAC1B,OAAOG,G1DurSP7R,E0DprSDiQ,SAAA,SAASgD,GACR,GAAI3Y,KAAKL,KAAKyX,MAAO,CACpB,IAAMT,EAAU3W,KAAKL,KAAKiB,MACpB0G,EAAOtH,KAAKq2C,eAAe1/B,GACjCo7B,GAAYI,YAAY7qC,QAExBtH,KAAKL,KAAK2X,SAAU,G1DwrSrB5R,E0DprSD0wC,eAAA,SAAe9uC,EAAM+qC,GAAiB,IAAAt9B,EAAA/U,KAarC,YAbqC,IAAjBqyC,IAAAA,EAAW,MACjB,IAAI2C,EAAAA,UAAU1tC,EAAKtE,QAAO,SAAAsM,GACvC,OAAQA,EAAE+iC,UAAY,QAAUA,KAC9BhjC,KAAI,SAAAC,GACN,IAAMgnC,EAAWvhC,EAAKqhC,eAAe9uC,EAAMgI,EAAE0B,IAC7C,OAAO,IAAIf,EAAAA,UAAU,CACpBe,GAAI1B,EAAE0B,GACNqhC,SAAU/iC,EAAE+iC,SACZ3nB,OAAQpb,EAAEob,OACVjb,KAAMH,EAAEG,KACR+vB,MAAO8W,S1DisST5wC,E0D3rSD2wC,eAAA,SAAe1/B,GACd,IAAMrP,EAAO,GAab,OAZiB,SAAXivC,EAAY/W,GACbA,GACHA,EAAMt7B,SAAQ,SAACu7B,EAAM99B,GACpB,IAAM60C,EAAWv0C,OAAO8D,OAAO,GAAI05B,GACnC+W,EAAS17B,MAAY,GAAJnZ,SACV60C,EAAShX,MAChBl4B,EAAKnE,KAAKqzC,GACVD,EAAS9W,EAAKD,UAIjB+W,CAAS5/B,EAAQ6oB,OACVl4B,G1DgsSA6uC,E0DvzSYA,CAA6BppC,EAAAA,WA4HlDopC,GAAqBnpC,KAAO,CAC3BC,SAAU,iBACViE,OAAQ,CAAC,UAFV,IC1HqBulC,GAAAA,SAAAA,G3D6zSnB,SAASA,IACP,OAAOnqC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeqzC,EAA2BnqC,GAM1C,IAAI5G,EAAS+wC,EAA0Bl0C,UAsFvC,OApFAmD,E2DtySD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACF2C,EAAS,IAAI7C,MAAM42C,SACzB/zC,EAAO43B,SAASoc,KAAK32C,KAAKu6B,UAC1B53B,EAAOi0C,OAAOH,EAA0BI,QACxC,IAAMl3C,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCK,KAAM2uB,GAAaG,YACnB7E,SAAU,IAAI1pB,EAAAA,YAAY7Q,KAAKu6B,SAASuc,eAAe,IAAIC,UAAWtmC,EAAAA,qBACtEumC,SAAU,IAAInmC,EAAAA,YAAYlO,EAAOq0C,SAASD,UAAWtmC,EAAAA,qBACrD0zB,MAAO,IAAItzB,EAAAA,YAAY,CAAC,EAAG,EAAG,GAAIJ,EAAAA,qBAClCwmC,OAAQ,IAAIpmC,EAAAA,YAAY,GAAIJ,EAAAA,qBAC5BkL,OAAQ,IAAI9K,EAAAA,YAAY,GAAIJ,EAAAA,qBAC5BymC,IAAK,IAAIrmC,EAAAA,YAAY,GAAIJ,EAAAA,qBACzB0vB,MAAO,OAERngC,KAAKuW,SAAW5W,EAAK4W,SACrB5W,EAAK6W,SAAST,WAAU,SAACY,GAExB1S,EAAKsR,kB3D6ySN7P,E2DzySDiQ,SAAA,WACC,GAAI3V,KAAKL,KAAKyX,MAAO,CACpB,IAAMqoB,EAAOx9B,OAAO8D,OAAO,GAAI/F,KAAKL,KAAKiB,OAEzC6F,QAAQC,IAAI,qCAAsC1G,KAAK2J,KAAM81B,GAC7D2P,GAAcK,iBAAiBzvC,KAAK2J,KAAM81B,GAAMltB,KAC/CuD,EAAAA,SACCC,WAAU,SAAA9D,GACXxL,QAAQC,IAAI,6CAA8CuL,GAC1DwrB,GAAap9B,QAAQ4R,MACnB,SAAApR,GAAK,OAAI4F,QAAQC,IAAI,2CAA4C7F,WAEpEb,KAAKL,KAAK2X,SAAU,G3D6ySrB5R,E2DzySD4c,MAAA,WACCmb,GAAan9B,U3D4ySb6B,EAAas0C,EAA2B,CAAC,CACvCh2C,IAAK,OACL8D,IAAK,W2D92SP,IAAIiN,EAAO,KACHgtB,EAAmB7xB,EAAAA,WAAW3M,MAA9Bw+B,eAIR,OAHIA,aAA0BN,KAC7B1sB,EAAOgtB,EAAe/0B,MAAM+H,MAEtBA,I3Dq3SJ,CACD/Q,IAAK,OACL8D,IAAK,W2Dn3SP,IAAIoF,EAAO,KACL6H,EAAOxR,KAAKwR,KAIlB,OAHIA,IACH7H,EAAO6H,EAAK7H,MAENA,I3Dw3SJ,CACDlJ,IAAK,WACL8D,IAAK,W2Dt3SP,IAAIg2B,EAAW,KACT/oB,EAAOxR,KAAKwR,KAIlB,OAHIA,IACH+oB,EAAW/oB,EAAK+oB,UAEVA,M3D63SAkc,E2Dv5SYA,CAAkC1pC,EAAAA,WAwEvD0pC,GAA0BI,OAAS,IAAI/2C,MAAMkkC,QAE7CyS,GAA0BzpC,KAAO,CAChCC,SAAU,wBADX,IC1EqBkqC,GAAAA,SAAAA,G5D+5SnB,SAASA,IACP,OAAO7qC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe+zC,EAAyB7qC,GAMxC,IAAI5G,EAASyxC,EAAwB50C,UAsFrC,OApFAmD,E4Dx4SD6G,OAAA,WAAS,IAAAtI,EAAAjE,KAMFL,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCK,KAAM2uB,GAAaD,MACnBzE,SAAU,IAAI1pB,EAAAA,YAAY7Q,KAAKu6B,SAASuc,eAAe,GAAGC,UAAWtmC,EAAAA,qBACrEumC,SAAU,IAAInmC,EAAAA,YAAY,CAAC,EAAG,EAAG,GAAIJ,EAAAA,qBAErC0zB,MAAO,IAAItzB,EAAAA,YAAY,CAAC,EAAG,EAAG,GAAIJ,EAAAA,qBAClC0vB,MAAO,IAAItvB,EAAAA,YAAY,KAAMJ,EAAAA,uBAE9BzQ,KAAKuW,SAAW5W,EAAK4W,SACrB5W,EAAK6W,SAAST,WAAU,SAACY,GAExB1S,EAAKsR,kB5D+4SN7P,E4D34SDiQ,SAAA,WACC,GAAI3V,KAAKL,KAAKyX,MAAO,CACpB,IAAMqoB,EAAOx9B,OAAO8D,OAAO,GAAI/F,KAAKL,KAAKiB,OAEzC6F,QAAQC,IAAI,mCAAoC1G,KAAK2J,KAAM81B,GAC3D2P,GAAcK,iBAAiBzvC,KAAK2J,KAAM81B,GAAMltB,KAC/CuD,EAAAA,SACCC,WAAU,SAAA9D,GACXxL,QAAQC,IAAI,2CAA4CuL,GACxDwrB,GAAap9B,QAAQ4R,MACnB,SAAApR,GAAK,OAAI4F,QAAQC,IAAI,yCAA0C7F,WAElEb,KAAKL,KAAK2X,SAAU,G5D+4SrB5R,E4D34SD4c,MAAA,WACCmb,GAAan9B,U5D84Sb6B,EAAag1C,EAAyB,CAAC,CACrC12C,IAAK,OACL8D,IAAK,W4Dh9SP,IAAIiN,EAAO,KACHgtB,EAAmB7xB,EAAAA,WAAW3M,MAA9Bw+B,eAIR,OAHIA,aAA0BN,KAC7B1sB,EAAOgtB,EAAe/0B,MAAM+H,MAEtBA,I5Du9SJ,CACD/Q,IAAK,OACL8D,IAAK,W4Dr9SP,IAAIoF,EAAO,KACL6H,EAAOxR,KAAKwR,KAIlB,OAHIA,IACH7H,EAAO6H,EAAK7H,MAENA,I5D09SJ,CACDlJ,IAAK,WACL8D,IAAK,W4Dx9SP,IAAIg2B,EAAW,KACT/oB,EAAOxR,KAAKwR,KAIlB,OAHIA,IACH+oB,EAAW/oB,EAAK+oB,UAEVA,M5D+9SA4c,E4Dz/SYA,CAAgCpqC,EAAAA,WAwErDoqC,GAAwBN,OAAS,IAAI/2C,MAAMkkC,QAE3CmT,GAAwBnqC,KAAO,CAC9BC,SAAU,sBADX,IC3EqBmqC,GAAAA,SAAAA,G7DkgTnB,SAASA,IACP,OAAO9qC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeg0C,EAAqB9qC,GAMpC,IAAI5G,EAAS0xC,EAAoB70C,UA+DjC,OA7DAmD,E6DtgTD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKa,MAAQ,KACb,IAAMlB,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCK,KAAMquB,GAASK,MACfvvB,KAAM,IAAIoB,EAAAA,YAAY,KAAMJ,EAAAA,qBAC5B0vB,MAAO,IAAItvB,EAAAA,YAAY,KAAMJ,EAAAA,qBAC7B1G,MAAO,IAAI8G,EAAAA,YAAY,KAAMJ,EAAAA,uBAE9BzQ,KAAKuW,SAAW5W,EAAK4W,SACrB5W,EAAK6W,SAAST,WAAU,SAACY,GAExB1S,EAAKsR,kB7D4gTN7P,E6DxgTDiQ,SAAA,WAAW,IAAAnB,EAAAxU,KACV,GAAIA,KAAKL,KAAKyX,MAAO,CACpBpX,KAAKL,KAAK0X,WAAY,EACtB,IAAMggC,EAASr3C,KAAKL,KAAKiB,MACnB+I,EAAO,CACZ2G,KAAM+mC,EAAO/mC,KACbb,KAAM4nC,EAAO5nC,KACb0wB,MAAOkX,EAAOlX,MACdqD,YAAa,CACZC,SAAU,EACVC,UAAW,GAEZ4T,KAAM,IAGP,OADA7wC,QAAQC,IAAI,oCAAqCiD,GAC1CylC,GAAcE,YAAY3lC,GAAM4I,KACtC8B,EAAAA,WAAU,SAAA1K,GACT,IAAM81B,EAAO,CACZnvB,KAAM2uB,GAAaD,MACnBmB,MAAOkX,EAAOttC,OAEf,OAAOqlC,GAAcO,YAAYhmC,EAAM81B,GAAMltB,KAC5ClD,EAAAA,KAAI,SAAAowB,GAEH,OADA91B,EAAK61B,MAAQ,CAACC,GACP91B,SAIVmM,EAAAA,SACCC,WAAU,SAAA9D,GACXxL,QAAQC,IAAI,uCAAwCuL,GACpDwrB,GAAap9B,QAAQ4R,MACnB,SAAApR,GACF4F,QAAQC,IAAI,qCAAsC7F,GAClD2T,EAAK3T,MAAQA,EACb2T,EAAK7U,KAAKuX,WAGXlX,KAAKL,KAAK2X,SAAU,G7D0gTrB5R,E6DtgTD4c,MAAA,WACCmb,GAAan9B,U7DygTN82C,E6DrkTYA,CAA4BrqC,EAAAA,WAiEjDqqC,GAAoBpqC,KAAO,CAC1BC,SAAU,iBADX,IChEqBsqC,GAAAA,SAAAA,G9D2kTnB,SAASA,IACP,OAAOjrC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAem0C,EAAmBjrC,GAMlC,IAAI5G,EAAS6xC,EAAkBh1C,UA+G/B,OA7GAmD,E8DpjTD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKa,MAAQ,KACb,IAAMlB,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCK,KAAM2uB,GAAaC,IACnB3zB,MAAO,KACPw2B,SAAU,KACVrX,OAAQ,IAAI7Z,EAAAA,YAAY,KAAMJ,EAAAA,qBAC9BoyB,iBAAiB,EACjBtI,SAAUv6B,KAAKu6B,SAASwc,UACxB5W,MAAO,KACP1zB,KAAM,IAAIwD,EAAAA,UAAU,CACnB1E,MAAO,IAAIsF,EAAAA,YAAY,MACvBtK,KAAM,IAAIsK,EAAAA,YAAY,MACtBpP,OAAQ,aAKVzB,KAAKuW,SAAW5W,EAAK4W,SAOrB5W,EAAK6W,SAAST,WAAU,SAACY,GAExB1S,EAAKsR,iBAEN65B,GAAcC,iBAAiB98B,KAC9BuD,EAAAA,SACCC,WAAU,SAAApQ,GACX1B,EAAKsS,SAASmU,OAAO/kB,QAAUA,EAC/B1B,EAAKsR,kB9D0jTN7P,E8DtjTDiQ,SAAA,WAAW,IAAAnB,EAAAxU,KACV,GAAIA,KAAKL,KAAKyX,MAAO,CACpBpX,KAAKL,KAAK0X,WAAY,EACtB,IAAMooB,EAAOx9B,OAAO8D,OAAO,GAAI/F,KAAKL,KAAKiB,OACzC6+B,EAAK/U,OAAS6W,SAAS9B,EAAK/U,SACxB+U,EAAKhzB,MAAUgzB,EAAKhzB,KAAKlB,OAAUk0B,EAAKhzB,KAAKlG,OAChDk5B,EAAKhzB,KAAO,MAGb2iC,GAAcK,iBAAiBzvC,KAAK2J,KAAM81B,GAAMltB,KAC/CuD,EAAAA,SACCC,WAAU,SAAA9D,GACXxL,QAAQC,IAAI,qCAAsCuL,GAClDwrB,GAAap9B,QAAQ4R,MACnB,SAAApR,GACF4F,QAAQC,IAAI,mCAAoC7F,GAChD2T,EAAK3T,MAAQA,EACb2T,EAAK7U,KAAK0X,WAAY,UAIvBrX,KAAKL,KAAK2X,SAAU,G9D2jTrB5R,E8DvjTD4c,MAAA,WACCmb,GAAan9B,U9D0jTb6B,EAAao1C,EAAmB,CAAC,CAC/B92C,IAAK,OACL8D,IAAK,W8DrpTP,IAAIiN,EAAO,KACHgtB,EAAmB7xB,EAAAA,WAAW3M,MAA9Bw+B,eAIR,OAHIA,aAA0BN,KAC7B1sB,EAAOgtB,EAAe/0B,MAAM+H,MAEtBA,I9D4pTJ,CACD/Q,IAAK,OACL8D,IAAK,W8D1pTP,IAAIoF,EAAO,KACL6H,EAAOxR,KAAKwR,KAIlB,OAHIA,IACH7H,EAAO6H,EAAK7H,MAENA,I9D+pTJ,CACDlJ,IAAK,WACL8D,IAAK,W8D7pTP,IAAIg2B,EAAW,KACT/oB,EAAOxR,KAAKwR,KAIlB,OAHIA,IACH+oB,EAAW/oB,EAAK+oB,UAEVA,M9DoqTAgd,E8D9rTYA,CAA0BxqC,EAAAA,WAiG/CwqC,GAAkBvqC,KAAO,CACxBC,SAAU,eADX,IClGqBuqC,GAAAA,SAAAA,G/DssTnB,SAASA,IACP,OAAOlrC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeo0C,EAA4BlrC,GAM3C,IAAI5G,EAAS8xC,EAA2Bj1C,UAqExC,OAnEAmD,E+D1sTD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKa,MAAQ,KACb,IAAMlB,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCK,KAAMquB,GAASG,aACfrvB,KAAM,IAAIoB,EAAAA,YAAY,KAAMJ,EAAAA,qBAC5BzH,OAAQ,IAAI6H,EAAAA,YAAY,KAAMJ,EAAAA,uBAE/BzQ,KAAKuW,SAAW5W,EAAK4W,SACrB5W,EAAK6W,SAAST,WAAU,SAACY,GAExB1S,EAAKsR,kB/DgtTN7P,E+D5sTDiQ,SAAA,WAAW,IAAAnB,EAAAxU,KACV,GAAIA,KAAKL,KAAKyX,MAAO,CACpBpX,KAAKL,KAAK0X,WAAY,EACtB5Q,QAAQC,IAAI,sCAAuC1G,KAAKL,KAAKiB,OAC7D,IAAMoI,EAAShJ,KAAKL,KAAKiB,MAAMoI,OACzB22B,EAAQc,GAAiBE,SAAS33B,EAAOqG,KAAI,SAAA8wB,GAAK,MAAK,CAC5DA,MAAAA,EACAe,KAAM,QACF,GAAO,GACZvB,EAAMjlB,MAAK,SAACC,EAAGC,GAGd,OAFyB,IAAdD,EAAEymB,QAAQ9xB,EAAYqL,EAAEymB,QAAQE,GAClB,IAAd1mB,EAAEwmB,QAAQ9xB,EAAYsL,EAAEwmB,QAAQE,MAG5C76B,QAAQC,IAAI,sCAAuCi5B,GACnD,IAAMQ,EAAQR,EAAM,GAAGQ,MACjBx2B,EAAO,CACZ2G,KAAMtQ,KAAKL,KAAKiB,MAAM0P,KACtBb,KAAMzP,KAAKL,KAAKiB,MAAM6O,KACtB0wB,MAAAA,EACAR,MAAOA,EACPkB,YAAY,EACZD,UAAU,EACV4C,YAAa,CACZC,SAAU,EACVC,UAAW,GAEZ4T,KAAM,IAEPlI,GAAcE,YAAY3lC,GAAM4I,KAC/BuD,EAAAA,SACCC,WAAU,SAAA9D,GACXxL,QAAQC,IAAI,8CAA+CuL,GAC3DwrB,GAAap9B,QAAQ4R,MACnB,SAAApR,GACF4F,QAAQC,IAAI,4CAA6C7F,GACzD2T,EAAK3T,MAAQA,EACb2T,EAAK7U,KAAKuX,gBAGXlX,KAAKL,KAAK2X,SAAU,G/DmtTrB5R,E+D/sTD4c,MAAA,WACCmb,GAAan9B,U/DktTNk3C,E+D/wTYA,CAAmCzqC,EAAAA,WAkExDyqC,GAA2BxqC,KAAO,CACjCC,SAAU,yBADX,IClEqBwqC,GAAAA,SAAAA,GhEsxTnB,SAASA,IACP,OAAOnrC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeq0C,EAAwBnrC,GAMvC,IAAI5G,EAAS+xC,EAAuBl1C,UAqIpC,OAnIAmD,EgE1xTD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKa,MAAQ,KACb,IAAMlB,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCK,KAAMquB,GAASE,SACfpvB,KAAM,IAAIoB,EAAAA,YAAY,KAAMJ,EAAAA,qBAC5B0vB,MAAO,IAAItvB,EAAAA,YAAY,KAAMJ,EAAAA,uBAI9BzQ,KAAKuW,SAAW5W,EAAK4W,SACrB5W,EAAK6W,SAAST,WAAU,SAACY,GAExB1S,EAAKsR,kBhEgyTN7P,EgE5xTDiQ,SAAA,WAAW,IAAAnB,EAAAxU,KACV,GAAIA,KAAKL,KAAKyX,MAAO,CACpBpX,KAAKL,KAAK0X,WAAY,EACtB,IAAMggC,EAASr3C,KAAKL,KAAKiB,MACnB+I,EAAO,CACZ2G,KAAM+mC,EAAO/mC,KACbb,KAAM4nC,EAAO5nC,KACb0wB,MAAOkX,EAAOlX,MACdqD,YAAa,CACZC,SAAU,EACVC,UAAW,GAEZ4T,KAAM,IAGP,OADA7wC,QAAQC,IAAI,uCAAwCiD,GAC7CylC,GAAcE,YAAY3lC,GAAM4I,KACtCuD,EAAAA,SACCC,WAAU,SAAA9D,GACXxL,QAAQC,IAAI,0CAA2CuL,GACvDwrB,GAAap9B,QAAQ4R,MACnB,SAAApR,GACF4F,QAAQC,IAAI,wCAAyC7F,GACrD2T,EAAK3T,MAAQA,EACb2T,EAAK7U,KAAKuX,WAiCXlX,KAAKL,KAAK2X,SAAU,GhEi1TrB5R,EgE7xTD4c,MAAA,WACCmb,GAAan9B,UhEgyTNm3C,EgE/5TYA,CAA+B1qC,EAAAA,WAoIpD0qC,GAAuBzqC,KAAO,CAC7BC,SAAU,oBAuCX,IC3KqByqC,GAAAA,SAAAA,GjE08TnB,SAASA,IACP,OAAOprC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAes0C,EAAqBprC,GAMpC,IAAI5G,EAASgyC,EAAoBn1C,UAmFjC,OAjFAmD,EiEn7TD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACF2C,EAAS,IAAI7C,MAAM42C,SACzB/zC,EAAO43B,SAASoc,KAAK32C,KAAKu6B,UAC1B53B,EAAOi0C,OAAOc,EAAoBb,QAClC,IAAMl3C,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCK,KAAM2uB,GAAaE,MACnB5E,SAAU,IAAI1pB,EAAAA,YAAY7Q,KAAKu6B,SAASuc,eAAe,IAAIC,UAAWtmC,EAAAA,qBACtEumC,SAAU,IAAInmC,EAAAA,YAAYlO,EAAOq0C,SAASD,UAAWtmC,EAAAA,qBACrD0zB,MAAO,IAAItzB,EAAAA,YAAY,CAAC,GAAI,KAAM,GAAIJ,EAAAA,qBACtC0vB,MAAO,OAERngC,KAAKuW,SAAW5W,EAAK4W,SACrB5W,EAAK6W,SAAST,WAAU,SAACY,GAExB1S,EAAKsR,kBjE07TN7P,EiEt7TDiQ,SAAA,WACC,GAAI3V,KAAKL,KAAKyX,MAAO,CACpB,IAAMqoB,EAAOx9B,OAAO8D,OAAO,GAAI/F,KAAKL,KAAKiB,OAEzC6F,QAAQC,IAAI,+BAAgC1G,KAAK2J,KAAM81B,GACvD2P,GAAcK,iBAAiBzvC,KAAK2J,KAAM81B,GAAMltB,KAC/CuD,EAAAA,SACCC,WAAU,SAAA9D,GACXxL,QAAQC,IAAI,uCAAwCuL,GACpDwrB,GAAap9B,QAAQ4R,MACnB,SAAApR,GAAK,OAAI4F,QAAQC,IAAI,qCAAsC7F,WAE9Db,KAAKL,KAAK2X,SAAU,GjE07TrB5R,EiEt7TD4c,MAAA,WACCmb,GAAan9B,UjEy7Tb6B,EAAau1C,EAAqB,CAAC,CACjCj3C,IAAK,OACL8D,IAAK,WiEx/TP,IAAIiN,EAAO,KACHgtB,EAAmB7xB,EAAAA,WAAW3M,MAA9Bw+B,eAIR,OAHIA,aAA0BN,KAC7B1sB,EAAOgtB,EAAe/0B,MAAM+H,MAEtBA,IjE+/TJ,CACD/Q,IAAK,OACL8D,IAAK,WiE7/TP,IAAIoF,EAAO,KACL6H,EAAOxR,KAAKwR,KAIlB,OAHIA,IACH7H,EAAO6H,EAAK7H,MAENA,IjEkgUJ,CACDlJ,IAAK,WACL8D,IAAK,WiEhgUP,IAAIg2B,EAAW,KACT/oB,EAAOxR,KAAKwR,KAIlB,OAHIA,IACH+oB,EAAW/oB,EAAK+oB,UAEVA,MjEugUAmd,EiEjiUYA,CAA4B3qC,EAAAA,WAqEjD2qC,GAAoBb,OAAS,IAAI/2C,MAAMkkC,QAEvC0T,GAAoB1qC,KAAO,CAC1BC,SAAU,iBADX,IC3EqB0qC,GAAAA,SAAAA,GlE6iUnB,SAASA,IACP,OAAOrrC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeu0C,EAAsBrrC,GAMrC,IAAI5G,EAASiyC,EAAqBp1C,UA0ClC,OAxCAmD,EkE/hUDkyC,SAAA,WACCna,GAAap9B,WlEkiUbqF,EkE/hUDmyC,SAAA,WACCpa,GAAan9B,UlEkiUboF,EkE/hUD4c,MAAA,WACCmb,GAAan9B,UlEkiUb6B,EAAaw1C,EAAsB,CAAC,CAClCl3C,IAAK,OACL8D,IAAK,WkE9jUP,IAAIiN,EAAO,KACHgtB,EAAmB7xB,EAAAA,WAAW3M,MAA9Bw+B,eAIR,OAHIA,aAA0BN,KAC7B1sB,EAAOgtB,EAAe/0B,MAAM+H,MAEtBA,IlEqkUJ,CACD/Q,IAAK,OACL8D,IAAK,WkEnkUP,IAAIk7B,EAAO,KACLjuB,EAAOxR,KAAKwR,KAIlB,OAHIA,IACHiuB,EAAOjuB,EAAKiuB,MAENA,MlE0kUAkY,EkE3lUYA,CAA6B5qC,EAAAA,WAkClD4qC,GAAqB3qC,KAAO,CAC3BC,SAAU,kBADX,IC1BqB6qC,GAAAA,SAAAA,GnE0lUnB,SAASA,IACP,OAAOxrC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe00C,EAAyBxrC,GAMxC,IAAI5G,EAASoyC,EAAwBv1C,UA+RrC,OA7RAmD,EmE9lUD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAK0xB,MAAO,EACZ1xB,KAAK6yC,QAAS,EACd,IAAMlzC,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAC7BjQ,KAAKuW,SAAW5W,EAAK4W,SACrB,IAAMkpB,EAAOz/B,KAAKy/B,KAClBz/B,KAAK+3C,aAAe91C,OAAO8D,OAAO,GAAI05B,GACtCA,EAAKuY,qBAAqBvY,EAAKU,QAASV,EAAKU,MAAM8X,gBACnDxY,EAAKyY,UAAYnP,GAAuBtJ,GAAMzuB,GAC9ChR,KAAKm4C,eACLx4C,EAAK6W,SAAST,WAAU,SAACY,GAExB1S,EAAKm0C,aAAazhC,GAClB1S,EAAKsR,kBnEqmUN7P,EmEjmUD2yC,kBAAA,SAAkB1hC,GACjB,IAAM8oB,EAAOz/B,KAAKy/B,KAEZ6Y,GAAmD,IAA3B7Y,EAAKuY,kBAC7BO,GAAyD,IAA9B5hC,EAAQqhC,kBACzC,SAAIrK,GAAamB,eAAerP,EAAKU,MAAOxpB,EAAQwpB,QACnDmY,IAA0BC,InEwmU3B7yC,EmEjmUD0yC,aAAA,SAAazhC,GAAS,IAAAnC,EAAAxU,KACfy/B,EAAOz/B,KAAKy/B,KACZqP,EAAiB9uC,KAAKq4C,kBAAkB1hC,IAE9C1U,OAAO8D,OAAO05B,EAAM9oB,GAChB8oB,EAAKU,QACRV,EAAKU,MAAM8X,eAAiBxY,EAAKuY,kBAAoB,CAAC,EAAK,EAAK,GAAO,MAEpElJ,MACYrP,EAAKU,MAAQwN,GAAaE,aAAapO,EAAKU,OAAS/rB,EAAAA,GAAG,OAChE7B,KACN8B,EAAAA,WAAU,WAAA,OAAM+6B,GAAcQ,iBAAiBp7B,EAAK7K,KAAM81B,MAC1D3pB,EAAAA,SACCC,YAEF/V,KAAK2J,KAAK41B,cAAcv/B,KAAK2J,KAAK61B,OACA,mBAAvBC,EAAKmS,eACfnS,EAAKmS,iBAGsB,mBAAlBnS,EAAKgO,UACfhO,EAAKgO,YnE0mUN/nC,EmEtmUDyyC,aAAA,WAAe,IAAAxjC,EAAA3U,KACRy/B,EAAOz/B,KAAKy/B,KACZ9/B,EAAOK,KAAKL,KAClB,GAAKK,KAAKsQ,MAAQtQ,KAAKsQ,KAAKb,OAASgwB,EAAKnvB,KAAKb,KAmE9CxN,OAAOY,KAAK7C,KAAKuW,UAAUrS,SAAQ,SAAAzD,GAClC,OAAQA,GACP,IAAK,OACJ,IAAM8K,EAAQk0B,EAAKhzB,KAAOgzB,EAAKhzB,KAAKlB,MAAQ,KACtChF,EAAOk5B,EAAKhzB,KAAOgzB,EAAKhzB,KAAKlG,KAAO,KAE1CoO,EAAK4B,SAAS9V,GAAKG,MAAQ,CAAE2K,MAAAA,EAAOhF,KAAAA,EAAM9E,OAD3B,UAEf,MACD,IAAK,oBACJkT,EAAK4B,SAAS9V,GAAKG,SAAS6+B,EAAKU,QAASV,EAAKU,MAAM8X,gBACrD,MACD,IAAK,YACJtjC,EAAK4B,SAAS9V,GAAKG,MAAQmoC,GAAuBtJ,GAAMzuB,GACxD,MACD,QACC2D,EAAK4B,SAAS9V,GAAKG,MAAsB,MAAb6+B,EAAKh/B,GAAeg/B,EAAKh/B,GAAO,aAlFX,CAKpD,IAAIoC,EACJ,OALA7C,KAAKsQ,KAAOmvB,EAAKnvB,KACjBrO,OAAOY,KAAK7C,KAAKuW,UAAUrS,SAAQ,SAAAzD,GAClCd,EAAK64C,UAAU/3C,MAGRg/B,EAAKnvB,KAAKb,MACjB,KAAKwvB,GAAaC,IAAIzvB,KACrB5M,EAAO,CAAC,KAAM,OAAQ,SAAU,YAAa,SAAU,mBAAoB,WAAY,SAAU,SACjG,MACD,KAAKo8B,GAAaE,MAAM1vB,KACvB5M,EAAO,CAAC,KAAM,OAAQ,WAAY,WAAY,QAAS,aAAc,SAAU,sBAC/E,MACD,KAAKo8B,GAAaG,YAAY3vB,KAC7B5M,EAAO,CAAC,KAAM,OAAQ,WAAY,WAAY,QAAS,SAAU,SAAU,MAAO,aAAc,SAAU,sBAC1G,MACD,KAAKo8B,GAAaI,QAAQ5vB,KACzB5M,EAAO,CAAC,KAAM,OAAQ,aAAc,SAAU,sBAC9C,MACD,KAAKo8B,GAAaD,MAAMvvB,KAEtB5M,EADG7C,KAAK2J,KAAK2G,KAAKb,OAASkvB,GAASK,MAC7B,CAAC,KAAM,OAAQ,UAEf,CAAC,KAAM,OAAQ,WAAY,WAAY,UAE/C,MACD,QACCn8B,EAAO,CAAC,KAAM,QAEhBA,EAAKqB,SAAQ,SAAAzD,GACZ,IAAMg4C,GAAiC,IAAtBh4C,EAAIyE,QAAQ,KAC7BzE,EAAMA,EAAI2F,QAAQ,IAAK,IACvB,IACI0J,EADElP,EAAsB,MAAb6+B,EAAKh/B,GAAeg/B,EAAKh/B,GAAO,KAE/C,OAAQA,GACP,IAAK,SACJqP,EAAU,IAAIe,EAAAA,YAAYjQ,EAAO63C,OAAWl3C,EAAYkP,EAAAA,qBACxD2+B,GAAcC,iBAAiB98B,KAC9BuD,EAAAA,SACCC,WAAU,SAAApQ,GACXmK,EAAQnK,QAAUA,EAClBmK,EAAQlP,MAAQkP,EAAQlP,OAAS,KACjC+T,EAAKY,iBAEN,MACD,IAAK,aACJzF,EAAU,IAAIe,EAAAA,YAAYjQ,EAAO63C,OAAWl3C,EAAYkP,EAAAA,sBAChD9K,QAAU1D,OAAOY,KAAK6lC,IAAgBr5B,KAAI,SAAAC,GAAC,OAAIo5B,GAAep5B,MAEtE,MACD,IAAK,OACJ,IAAM/D,EAAQk0B,EAAKhzB,KAAOgzB,EAAKhzB,KAAKlB,MAAQ,KACtChF,EAAOk5B,EAAKhzB,KAAOgzB,EAAKhzB,KAAKlG,KAAO,KAE1CuJ,EAAU,IAAIG,EAAAA,UAAU,CACvB1E,MAAO,IAAIsF,EAAAA,YAAYtF,GACvBhF,KAAM,IAAIsK,EAAAA,YAAYtK,GACtB9E,OAJc,WAMf,MACD,QACCqO,EAAU,IAAIe,EAAAA,YAAYjQ,EAAO63C,OAAWl3C,EAAYkP,EAAAA,qBAE1D9Q,EAAK0sB,IAAIvc,EAASrP,MAEnBT,KAAKuW,SAAW5W,EAAK4W,WnEspUtB7Q,EmE/nUDgzC,qBAAA,SAAqBR,GAAW,IAAArjC,EAAA7U,KACzBy/B,EAAOz/B,KAAKy/B,KACZkZ,EAAc5P,GAAuBtJ,GAAMzuB,GAEjD,GAAIknC,IAAcS,EAAa,CAC9BlZ,EAAKyY,UAAYA,EACjB,IAAI7E,EAASj/B,EAAAA,GAAG,MACZ8jC,IAAcxP,GAAeC,aAAa33B,KAC7CqiC,EAASA,EAAO9gC,KACf8B,EAAAA,WAAU,WACT,IAAM8rB,EAAQ6I,GAA4BkP,GAC1C,OAAOvK,GAAaC,aAAazN,QAIpCkT,EAAO9gC,KACNuD,EAAAA,SACCC,WAAU,SAAAoqB,GAEXtrB,EAAK0B,SAAS4pB,MAAMv/B,MAAQu/B,OnEgpU9Bz6B,EmE/nUD8pB,UAAA,SAAU7Y,GAET3W,KAAKm4C,gBnEkoULzyC,EmE/nUDiQ,SAAA,WAAW,IAAAZ,EAAA/U,KACV,IAAKA,KAAK0xB,MAAQ1xB,KAAKL,KAAKyX,MAAO,CAClCpX,KAAK0xB,MAAO,EACZ1xB,KAAKuV,cACL,IAAMoB,EAAU3W,KAAKL,KAAKiB,MACpB2T,EAAUtS,OAAO8D,OAAO,GAAI4Q,GAC5BhN,EAAO3J,KAAK2J,KACZ81B,EAAO,IAAIqC,GAASvtB,GAC1B66B,GAAcQ,iBAAiBjmC,EAAM81B,GAAMltB,KAC1CuD,EAAAA,SACCC,WAAU,SAAA9D,GAEXm9B,GAAcc,uBAAuBvmC,EAAM81B,GAC3C1qB,EAAKlH,OAAOoG,KAAK,CAAEtK,KAAAA,EAAM81B,KAAAA,IACzB3c,YAAW,WACV/N,EAAK2c,MAAO,EACZ3c,EAAKQ,gBACH,QACD,SAAA1U,GAAK,OAAI4F,QAAQC,IAAI,0DAA2D7F,WAGnFb,KAAKL,KAAK2X,SAAU,GnE0oUrB5R,EmEtoUDkyC,SAAA,SAASj/B,GAAO,IAAAmO,EAAA9mB,KACfy9B,GAAaC,MAAM,CAAE5hB,IAAK/Q,EAAYxB,SAASE,MAAMY,OAAQmH,KAAM,CAAEiuB,KAAMz/B,KAAKy/B,QAAUltB,KACzFkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA4C,GACPA,aAAiB0kB,IACpBvW,EAAK5N,OAAOjF,KAAK,CAAEtK,KAAMmd,EAAKnd,KAAM81B,KAAM3Y,EAAK2Y,WnEmpUjD/5B,EmE9oUD8nC,SAAA,SAAS70B,GACR3Y,KAAK2N,OAAOsG,KAAK,CAAEtK,KAAM3J,KAAK2J,KAAM81B,KAAMz/B,KAAKy/B,KAAKwB,SAAW,KAAOjhC,KAAKy/B,QnEwpU3E/5B,EmEjpUDkzC,SAAA,SAASnZ,GACR,OAAO1wB,EAAUG,QAAQ,SAAUuwB,EAAKnvB,KAAKb,OnEopUtCqoC,EmE73UYA,CAAgC/qC,EAAAA,WA6OrD+qC,GAAwB9qC,KAAO,CAC9BC,SAAU,mBACVsjB,QAAS,CAAC,SAAU,SAAU,UAC9Brf,OAAQ,CAAC,OAAQ,QACjB3H,SAAQ,gzJAJT,ICnPqBsvC,GAAAA,SAAAA,GpE+4UnB,SAASA,IACP,OAAOvsC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAey1C,EAAyBvsC,GAMxC,IAAI5G,EAASmzC,EAAwBt2C,UA+ErC,OA7EAmD,EoEn5UD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAK0xB,MAAO,EACZ1xB,KAAK6yC,QAAS,EACd,IAAMlzC,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAAU,CACtCe,GAAI,IAAIH,EAAAA,YAAY7Q,KAAK0K,KAAKsG,GAAIP,EAAAA,qBAClC0vB,MAAO,IAAItvB,EAAAA,YAAY7Q,KAAK0K,KAAKy1B,MAAO1vB,EAAAA,qBACxCywB,KAAM,IAAIrwB,EAAAA,YAAY7Q,KAAK0K,KAAKw2B,KAAMzwB,EAAAA,uBAEvCzQ,KAAKuW,SAAW5W,EAAK4W,SACrB5W,EAAK6W,SAAST,WAAU,SAACY,GAExB,IAAMjM,EAAOzG,EAAKyG,KAClBzI,OAAO8D,OAAO2E,EAAMiM,GACS,mBAAlBjM,EAAK+iC,UACf/iC,EAAK+iC,WAENxpC,EAAKsR,iBAEN9O,QAAQC,IAAI,iCAAkC1G,KAAK2J,KAAM3J,KAAK0K,OpE05U9DhF,EoEv5UDiQ,SAAA,WAAW,IAAAnB,EAAAxU,KACV,IAAKA,KAAK0xB,MAAQ1xB,KAAKL,KAAKyX,MAAO,CAClCpX,KAAK0xB,MAAO,EACZ1xB,KAAKuV,cACL,IAAMhB,EAAUtS,OAAO8D,OAAO,GAAI/F,KAAKL,KAAKiB,OACtC+I,EAAO3J,KAAK2J,KACZe,EAAO6J,EAIbvU,KAAK6N,OAAOoG,KAAK,CAAEtK,KAAAA,EAAMe,KAAAA,IACzBoY,YAAW,WACVtO,EAAKkd,MAAO,EACZld,EAAKe,gBACH,UAEHvV,KAAKL,KAAK2X,SAAU,GpEk6UrB5R,EoE95UDkyC,SAAA,SAASj/B,GAAO,IAAAhE,EAAA3U,KACfy9B,GAAaC,MAAM,CAAE5hB,IAAK/Q,EAAYxB,SAASE,MAAMY,OAAQmH,KAAM,CAAE9G,KAAM1K,KAAK0K,QAAU6H,KACzFkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA4C,GACPA,aAAiB0kB,IACpB1oB,EAAKuE,OAAOjF,KAAK,CAAEtK,KAAMgL,EAAKhL,KAAMe,KAAMiK,EAAKjK,WpE26UjDhF,EoEt6UD8nC,SAAA,SAAS70B,GACR3Y,KAAK2N,OAAOsG,KAAK,CAAEtK,KAAM3J,KAAK2J,KAAMe,KAAM1K,KAAK0K,KAAKu2B,SAAW,KAAOjhC,KAAK0K,QpE46UpEmuC,EoEl+UYA,CAAgC9rC,EAAAA,WA0DrD8rC,GAAwB7rC,KAAO,CAC9BC,SAAU,mBACVsjB,QAAS,CAAC,SAAU,SAAU,UAC9Brf,OAAQ,CAAC,OAAQ,QACjB3H,SAAQ,8kCAJT,ICpDqBuvC,GAAAA,SAAAA,GrEw+UnB,SAASA,IACP,OAAOxsC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe01C,EAAqBxsC,GAMpC,IAAI5G,EAASozC,EAAoBv2C,UAiNjC,OA/MAmD,EqE5+UD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAK0xB,MAAO,EACZ,IAAM/xB,EAAOK,KAAKL,KAAO,IAAIsQ,EAAAA,UAC7BjQ,KAAKuW,SAAW5W,EAAK4W,SACrBvW,KAAKm4C,eACLx4C,EAAK6W,SAAST,WAAU,SAACY,GAExB1S,EAAK80C,aAAapiC,GAClB1S,EAAKsR,iBAENvV,KAAKg5C,SAASzmC,KACbkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA0B,GACX,OAAQxT,EAAK0F,KAAK2G,KAAKb,MACtB,KAAKkvB,GAASE,SAASpvB,KACvB,KAAKkvB,GAASG,aAAarvB,KAC3B,KAAKkvB,GAASK,MAAMvvB,KACnBxL,EAAKtE,KAAKsX,MAAM,CACfwsB,SAAUhsB,EAAQ+rB,YAAYC,SAC9BC,UAAWjsB,EAAQ+rB,YAAYE,UAC/B4T,KAAM7/B,EAAQ6/B,YrEq/UlB5xC,EqE9+UDszC,OAAA,WACC,IAAIvV,EAAUC,EAAW4T,EAAO,KAChC,OAAO9/B,EAAeI,IAAIrF,KACzBvP,EAAAA,QAAO,SAAAyU,GAAO,OAAIA,EAAQnH,OAAS2O,MACnCg6B,EAAAA,UAAU,IACVj+B,EAAAA,sBAAqB,SAACob,EAAU2Y,GAC/B,IAAMmK,EAAazV,IAAasL,EAAQvL,YAAYC,UACnDC,IAAcqL,EAAQvL,YAAYE,WAClC4T,IAASvI,EAAQuI,KAIlB,OAHA7T,EAAWsL,EAAQvL,YAAYC,SAC/BC,EAAYqL,EAAQvL,YAAYE,UAChC4T,EAAOvI,EAAQuI,MACP4B,OrEi/UVxzC,EqE5+UD2yC,kBAAA,SAAkB1hC,GACjB,IAAMhN,EAAO3J,KAAK2J,KACZmlC,EAAiBnB,GAAamB,eAAenlC,EAAKw2B,MAAOxpB,EAAQwpB,OACjEgZ,EAAgBxL,GAAamB,eAAenlC,EAAKtC,GAAKsC,EAAKtC,GAAG+xC,KAAO,KAAMziC,EAAQyiC,MACnFC,EAAgB1L,GAAamB,eAAenlC,EAAKtC,GAAKsC,EAAKtC,GAAGiyC,KAAO,KAAM3iC,EAAQ2iC,MACzF,SAAIxK,GAAkBqK,GAAiBE,IrEq/UvC3zC,EqE7+UDqzC,aAAA,SAAapiC,GACW3W,KAAKq4C,kBAAkB1hC,IAG7C3W,KAAK2V,YrEi/UNjQ,EqE7+UDyyC,aAAA,WACC,IAAMxuC,EAAO3J,KAAK2J,KAClB,IAAK3J,KAAKsQ,MAAQtQ,KAAKsQ,KAAKb,OAAS9F,EAAK2G,KAAKb,KAAM,CACpDzP,KAAKsQ,KAAO3G,EAAK2G,KACjB,IAIIzN,EAJElD,EAAOK,KAAKL,KAKlB,OAJAsC,OAAOY,KAAK7C,KAAKuW,UAAUrS,SAAQ,SAAAzD,GAClCd,EAAK64C,UAAU/3C,MAGRkJ,EAAK2G,KAAKb,MACjB,KAAKkvB,GAASC,YAAYnvB,KACzB5M,EAAO,CAAC,KAAM,OAAQ,OAAQ,WAAY,YAAa,OAAQ,SAC/D,MACD,KAAK87B,GAASE,SAASpvB,KACtB5M,EAAO,CAAC,KAAM,OAAQ,OAAQ,UAAW,WAAY,YAAa,OAAQ,SAC1E,MACD,KAAK87B,GAASG,aAAarvB,KAC1B5M,EAAO,CAAC,KAAM,OAAQ,OAAQ,UAAW,WAAY,YAAa,QAClE,MACD,KAAK87B,GAASK,MAAMvvB,KACnB5M,EAAO,CAAC,KAAM,OAAQ,OAAQ,UAAW,WAAY,YAAa,OAAQ,SAC1E,MACD,QACCA,EAAO,CAAC,KAAM,OAAQ,QAEpB8G,EAAK2G,KAAKb,OAASkvB,GAASC,YAAYnvB,MAAQ1E,EAAYjE,MAAMO,KACrExE,EAAKM,KAAK,SACVN,EAAKM,KAAK,UAEXN,EAAKqB,SAAQ,SAAAzD,GACZ,IAAMg4C,GAAiC,IAAtBh4C,EAAIyE,QAAQ,KAE7B,OADAzE,EAAMA,EAAI2F,QAAQ,IAAK,KAEtB,IAAK,WACL,IAAK,YACJ,IAAMo9B,EAAc75B,EAAK65B,aAAe,CAAEC,SAAU,EAAGC,UAAW,GAClE/jC,EAAK0sB,IAAI,IAAIxb,EAAAA,YAAY2yB,EAAY/iC,GAAMgQ,EAAAA,qBAAsBhQ,GACjE,MACD,IAAK,OACL,IAAK,OACJd,EAAK0sB,IAAI,IAAIxb,EAAAA,YAAalH,EAAKtC,IAAMsC,EAAKtC,GAAG5G,IAAgB,KAAOg4C,OAAWl3C,EAAYkP,EAAAA,qBAAsBhQ,GACjH,MACD,QACCd,EAAK0sB,IAAI,IAAIxb,EAAAA,YAA0B,MAAblH,EAAKlJ,GAAekJ,EAAKlJ,GAAO,KAAOg4C,OAAWl3C,EAAYkP,EAAAA,qBAAsBhQ,OAGjHT,KAAKuW,SAAW5W,EAAK4W,WrE+/UtB7Q,EqE3/UD8pB,UAAA,SAAU7Y,GACT3W,KAAKm4C,gBrE8/ULzyC,EqE3/UDiQ,SAAA,WAAW,IAAAnB,EAAAxU,KACV,IAAKA,KAAK0xB,MAAQ1xB,KAAKL,KAAKyX,MAAO,CAClCpX,KAAK0xB,MAAO,EACZ1xB,KAAKuV,cACL,IAAMhB,EAAUtS,OAAO8D,OAAO,GAAI/F,KAAK2J,KAAM3J,KAAKL,KAAKiB,OAC/B,MAApB2T,EAAQkvB,WACXlvB,EAAQivB,YAAc,CACrBC,SAAUlvB,EAAQkvB,SAClBC,UAAWnvB,EAAQmvB,kBAEbnvB,EAAQkvB,gBACRlvB,EAAQmvB,WAEhB,IAAM0V,EAAO7kC,EAAQ6kC,MAAQ,KACvBE,EAAO/kC,EAAQ+kC,MAAQ,YACtB/kC,EAAQ6kC,YACR7kC,EAAQ+kC,KACf/kC,EAAQlN,GAAM+xC,GAAQE,EAAQ,CAAEF,KAAAA,EAAME,KAAAA,GAAS,KAC/C,IAAM3vC,EAAO,IAAI21B,GAAK/qB,GACtB66B,GAAcG,YAAY5lC,GAAM4I,KAC/BuD,EAAAA,SACCC,WAAU,SAAA9D,GAEXuC,EAAK3G,OAAOoG,KAAK,CAAEtK,KAAAA,IACnBmZ,YAAW,WACVtO,EAAKkd,MAAO,EACZld,EAAKe,gBACH,QACD,SAAA1U,GAAK,OAAI4F,QAAQC,IAAI,iDAAkD7F,WAG1Eb,KAAKL,KAAK2X,SAAU,GrE0gVrB5R,EqEtgVDkyC,SAAA,SAASj/B,GAAO,IAAAhE,EAAA3U,KACfy9B,GAAaC,MAAM,CAAE5hB,IAAK/Q,EAAYxB,SAASE,MAAMY,OAAQmH,KAAM,CAAEiuB,KAAMz/B,KAAKy/B,QAAUltB,KACzFkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA4C,GACPA,aAAiB0kB,IACpB1oB,EAAKuE,OAAOjF,KAAK,CAAEtK,KAAMgL,EAAKhL,WrEkhVhCjE,EqE7gVD8nC,SAAA,SAAS70B,GACR3Y,KAAK2N,OAAOsG,KAAK,CAAEtK,KAAM3J,KAAK2J,KAAKs3B,SAAW,KAAOjhC,KAAK2J,QrEkhV1DjE,EqE/gVDkzC,SAAA,SAASjvC,GACR,OAAOoF,EAAUG,QAAQ,SAAUvF,EAAK2G,KAAKb,OrEkhVtCqpC,EqE7rVYA,CAA4B/rC,EAAAA,WA+KjD+rC,GAAoB9rC,KAAO,CAC1BC,SAAU,cACVsjB,QAAS,CAAC,SAAU,SAAU,UAC9Brf,OAAQ,CAAC,QACT3H,SAAQ,wlHC9KT,IAAMgwC,GAAY,CACjB5M,GACA8J,GACApG,GACA8G,GACAhB,GACAiB,GACAG,GACAE,GACAD,GACAE,GACAC,GACAjL,GACAoL,GACAe,GACAC,IAGKU,GAAQ,GAEDC,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAr4C,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAq2C,EAAAC,GAAAD,EAAA,CAAkCE,EAAAA,QAElCF,GAAazsC,KAAO,CACnB4sC,QAAS,GACTC,aAAY,GAAArpB,OACR+oB,GACAC,IAEJr6C,QAAO,GAAAqxB,OACH+oB,GACAC,KARL,ICpCqBM,GAAAA,SAAAA,GvEiuVnB,SAASA,IACP,OAAO9qC,EAAM3N,MAAMrB,KAAMoB,YAAcpB,KAQzC,OAXAoD,EAAe02C,EAAU9qC,GAMzB8qC,EuEnuVM7qC,UAAP,SAAiBxO,GAEhB,OADcsK,EAAYjE,MACbrG,KAAQ,GvEsuVdq5C,EuE1uVYA,CAAiBtqC,EAAAA,MAStCsqC,GAAS9sC,KAAO,CACfyC,KAAM,QADP,ICNasqC,GAEZ,SAAY3Z,GACXpgC,KAAKogC,KAAOA,EACZpgC,KAAKyP,KAAO2wB,EAAK3wB,KACjBzP,KAAKsQ,KAAO84B,GAAkBhJ,EAAK3wB,MACnCzP,KAAKg6C,SAAW,EAChBh6C,KAAK8M,KAAOszB,EAAKtzB,KACjB9M,KAAKi6C,WAAY,EACjBj6C,KAAKk6C,QAAS,EACdl6C,KAAKolB,SAAU,EACfplB,KAAKm6C,UAAW,EAChBn6C,KAAKa,MAAQ,KACbb,KAAKo3B,QAAU,MAKJgjB,GACZ,SAAYz0C,GACPA,GACH1D,OAAO8D,OAAO/F,KAAM2F,IAKV00C,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAj5C,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAi3C,EAAAC,GAAAD,EAAA,CAAsCD,IAEzBG,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAn5C,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAm3C,EAAAC,GAAAD,EAAA,CAAyCH,IAE5BK,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAr5C,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAq3C,EAAAC,GAAAD,EAAA,CAAsCL,IAEzBO,GAAb,WAEC,SAAAA,IACC36C,KAAK46C,YAAc,IAAI1lC,EAAAA,gBAAgB,GACvClV,KAAK66C,OAAS,IAAI3lC,EAAAA,gBAAgB,IAClClV,KAAK89B,QAAU,IAAI5lB,EAAAA,cAAc,GALnC,IAAAxS,EAAAi1C,EAAAp4C,UAAA,OAAAmD,EAQCwoC,QAAA,WAAU,IAAAjqC,EAAAjE,KAEH86C,EADQ96C,KAAK66C,OAAOviC,WACAtV,QAAO,SAAAy8B,GAAI,OAAKA,EAAKwa,aAC/C,OAAOngC,EAAAA,cAAcghC,EAAYzrC,KAAI,SAAAowB,GAAI,OAAIx7B,EAAK82C,YAAYtb,QAXhE/5B,EAcCq1C,YAAA,SAAYtb,GAAM,IAAAjrB,EAAAxU,KAEjBy/B,EAAKwa,WAAY,EACjBj6C,KAAK89B,QAAQ7pB,KAAK,IAAIomC,GAAiB,CAAE5a,KAAAA,KACzC,IAAM0O,EAAQ,CAAC1O,EAAKW,MACpB,OAAOhsB,EAAAA,GAAG+5B,GAAO57B,KAChByoC,EAAAA,WAAU,WAAA,OAAMxmC,EAAKomC,YAAYroC,KAChCvP,EAAAA,QAAO,SAAAsM,GAAC,OAAIA,EAAI,SAEjBmF,EAAAA,KAAI,WAAA,OAAMD,EAAKomC,YAAY3mC,KAAKO,EAAKomC,YAAYtiC,WAAa,MAC9DxC,EAAAA,QACAzB,EAAAA,WAAU,SAAA85B,GAAK,OAAIR,GAAaO,QAAQC,MACxC95B,EAAAA,WAAU,SAACu6B,GACV,IAAM9gC,EAAS8gC,EAAQ,GACvBnP,EAAKwa,WAAY,EACjBxa,EAAK0a,UAAW,EAChB,IAAMha,EAAQgJ,GAAMK,QAAQ17B,EAAOlI,KAEnC,OADA4O,EAAKspB,QAAQ7pB,KAAK,IAAIsmC,GAAoB,CAAE9a,KAAAA,EAAMU,MAAAA,KAC3CwN,GAAaC,aAAazN,GAAO5tB,KACvCkC,EAAAA,KAAI,SAAA0rB,GACH3rB,EAAKnK,OAAOo1B,GACZjrB,EAAKspB,QAAQ7pB,KAAK,IAAIwmC,GAAiB,CAAEhb,KAAAA,EAAMU,MAAAA,KAC/C3rB,EAAKomC,YAAY3mC,KAAKO,EAAKomC,YAAYtiC,WAAa,YApC1D5S,EA8DCu1C,SAAA,SAAS9M,GACR,GAAIA,GAASA,EAAMvsC,OAAQ,CAE1B,IAAM49B,EAAQx/B,KAAK66C,OAAOviC,WACpB4iC,EAAW/2C,MAAMwN,KAAKw8B,GAAO9+B,KAAI,SAAA+wB,GAAI,OAAI,IAAI2Z,GAAW3Z,MAC9DZ,EAAMr8B,KAAN9B,MAAAm+B,EAAc0b,GACdl7C,KAAK66C,OAAO5mC,KAAKurB,KApEpB95B,EAwEC2E,OAAA,SAAOo1B,GACN,IAAMD,EAAQx/B,KAAK66C,OAAOviC,WACpBpP,EAAQs2B,EAAMt6B,QAAQu6B,IACb,IAAXv2B,GACHs2B,EAAM7hB,OAAOzU,EAAO,GAErBlJ,KAAK66C,OAAO5mC,KAAKurB,IA9EnB95B,EAiFCy1C,UAAA,WAECn7C,KAAK66C,OAAO5mC,KAAK,KAnFnBvO,EAsFCstC,MAAA,SAAM1Y,EAAO8gB,GAAU,IAAAzmC,EAAA3U,KACtB,GAAIizC,EAAAA,mBAAqB3Y,EAAO,CAC/B8gB,EAAWA,GAAY9gB,EACvB,IAAMtoB,EAAOnN,SAASC,cAAc,QACpC,OAAOf,EAAAA,MAAM2mC,EAAAA,UAAU14B,EAAM,QAAS04B,EAAAA,UAAU14B,EAAM,aAAaO,KAClElD,EAAAA,KAAI,SAACsJ,GAMJ,OAJAA,EAAMmyB,iBACFnyB,EAAMlX,SAAW25C,GACpBzmC,EAAKsmC,SAAStiC,EAAMu6B,aAAa/E,OAE3Bx5B,EAAKkmC,WAId,OAAO1H,EAAAA,OArGVztC,EAyGC0tC,QAAA,SAAQ9Y,GAAO,IAAAzlB,EAAA7U,KACd,OAAIizC,EAAAA,mBAAqB3Y,EACjBoQ,EAAAA,UAAUpQ,EAAO,UAAU/nB,KACjC8B,EAAAA,WAAU,SAACsE,GAKV,OAJI2hB,EAAM6T,MAAMvsC,SACfiT,EAAKomC,SAAS3gB,EAAM6T,OACpB7T,EAAM15B,MAAQ,IAERiU,EAAKgmC,WAIP1H,EAAAA,OArHVztC,EAyHC21C,OAAA,SAAOlN,GAAO,IAAAp5B,EAAA/U,KACb,OAAO8Z,EAAAA,cAAc3V,MAAMwN,KAAKw8B,GAAO9+B,KAAI,SAAC+wB,EAAMz+B,GAAP,OAAaoT,EAAKumC,MAAMlb,EAAMz+B,QA1H3E+D,EA6HC41C,MAAA,SAAMlb,EAAMz+B,GAAG,IAAAmlB,EAAA9mB,KACd,OAAOA,KAAKwzC,MAAMpT,EAAMz+B,GAAG4Q,KAC1B8B,EAAAA,WAAU,WAAA,OAAMyS,EAAKy0B,YAAYnb,QA/HpC16B,EA8IC8tC,MAAA,SAAMpT,EAAMz+B,GAAG,IAAAwlB,EAAAnnB,KACRyzC,EAAS,IAAIC,WACbC,EAAUjJ,EAAAA,UAAU+I,EAAQ,QAAQlhC,KACzCkC,EAAAA,KAAI,SAAAkE,GACH,IAAMi7B,EAAOj7B,EAAMlX,OAAOoyC,OAC1B1sB,EAAKq0B,OAAO5H,GAAM,SAACG,GAClB5sB,EAAKmsB,SAAS3xC,GAAKoyC,EAEnB5sB,EAAK5R,qBAKR,OADAk+B,EAAOO,cAAc5T,GACduT,GA3JTjuC,EA8JC61C,YAAA,SAAYnb,GACX,OAAOuN,GAAaO,QAAQ,CAAC9N,IAAO7tB,KAEnC8B,EAAAA,WAAU,SAACu6B,GACV,IAAM9gC,EAAS8gC,EAAQ,GAQjBzO,EAAQgJ,GAAMK,QAAQ17B,EAAOlI,KACnC,OAAO+nC,GAAaC,aAAazN,QA3KrCz6B,EAgLC81C,OAAA,SAAO5H,EAAMl7B,GACZ,GAAwB,mBAAbA,EAAyB,CACnC,IAAMw7B,EAAMrvC,SAAS0W,cAAc,OACnC24B,EAAIC,OAAS,WACZ,IAEMC,EAASvvC,SAAS0W,cAAc,UAChC84B,EAAMD,EAAOznC,WAAW,MAC1B+O,EAAQw4B,EAAIx4B,MACZC,EAASu4B,EAAIv4B,OACbD,EAAQC,EACPD,EAPa,MAQhBC,GARgB,IAQMD,EACtBA,EATgB,KAYbC,EAXc,MAYjBD,GAZiB,IAYKC,EACtBA,EAbiB,KAgBnBy4B,EAAO14B,MAAQA,EACf04B,EAAOz4B,OAASA,EAChB04B,EAAIC,UAAUJ,EAAK,EAAG,EAAGx4B,EAAOC,GAChC,IAAM4mB,EAAU6R,EAAOG,UAAU,aAAc,IAC/C77B,EAAS6pB,IAEV2R,EAAIp4B,IAAM83B,IA3MbluC,EA+MCgU,UAAA,WACC,OAEK4gB,EAAQz1B,SAAS0W,cAAc,UAC7BjL,KAAO,OACN,UAAWgqB,OAGdiU,EAAM,IAAIC,iBACI,WAAYD,GAAS,eAAgBA,EAAIzgC,WAGlDrJ,OAAO4pC,SALjB,IACKE,EALAjU,GAlNPqgB,EAAA,GCjCqBc,GAAAA,SAAAA,GzEoiWnB,SAASA,IACP,OAAO9G,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KAHrDoD,EAAeq4C,EAAwB9G,GAMvC,IAAIjvC,EAAS+1C,EAAuBl5C,UAmFpC,OAjFAmD,EyE9hWD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKqW,MAAQrW,KAAKqW,OAAS,QAC3BrW,KAAK40C,OAAS50C,KAAK40C,QAAU,wBAC7B50C,KAAK07C,UAA8B,IAAlB17C,KAAK07C,SACtB17C,KAAKw/B,MAAQ,GACbx/B,KAAKgJ,OAAShJ,KAAK8P,QAAQlP,OAAS,GACpCZ,KAAK27C,UAAW,EANR,IAOAjvC,EAASC,EAAAA,WAAW3M,MAApB0M,KACF4tB,EAAQ5tB,EAAK5H,cAAc,SACjCw1B,EAAM9e,aAAa,SAAUxb,KAAK40C,QAClC,IAAMwG,EAAW1uC,EAAK5H,cAAc,gBAC9B82C,EAAU57C,KAAK47C,QAAU,IAAIjB,GACnCiB,EAAQ5I,MAAM1Y,EAAO8gB,GAAU7oC,KAC9BkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAypB,GAEXv7B,EAAKu7B,MAAQA,EACbv7B,EAAKsR,iBAENqmC,EAAQxI,QAAQ9Y,GAAO/nB,KACtBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAypB,GAEXv7B,EAAKu7B,MAAQA,EACbv7B,EAAKsR,iBAENqmC,EAAQ9d,QAAQvrB,KACfkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA4C,GAEPA,aAAiB8hC,KACpBx2C,EAAK+E,OAAO7F,KAAKwV,EAAMwnB,OACvBl8B,EAAK6L,QAAQlP,MAAQqD,EAAK+E,QAE3B/E,EAAKu7B,MAAQv7B,EAAKu7B,MAClBv7B,EAAKsR,kBzEuiWN7P,EyEliWDm2C,SAAA,WAEC77C,KAAK47C,QAAQ1N,UAAU37B,KACtBuD,EAAAA,SACCC,azEmiWFrQ,EyEhiWDmyC,SAAA,WAEC73C,KAAK47C,QAAQT,azEmiWbz1C,EyEhiWDo2C,YAAA,SAAYrc,KzEmiWX/5B,EyE/hWDq2C,aAAA,SAAatc,KzEkiWZ/5B,EyE9hWDs2C,aAAA,SAAavc,KzEiiWZ/5B,EyE7hWDu2C,aAAA,SAAaxc,GAEZz/B,KAAK47C,QAAQvxC,OAAOo1B,IzEgiWpBt9B,EAAas5C,EAAwB,CAAC,CACpCh7C,IAAK,QACL8D,IAAK,WyE7mWP,OAAOvE,KAAKk8C,QzEgnWV11C,IAAK,SyE9mWEg5B,GACTx/B,KAAKk8C,OAAS1c,EACdx/B,KAAKm8C,YAAc3c,EAAMtvB,QAAO,SAACC,EAAGC,GACnC,OAAOD,GAAKC,EAAE6pC,WAAa7pC,EAAEgsC,UAAY,EAAI,KAC3C,OzEknWIX,EyE3nWYA,CAA+BhH,IAkFpDgH,GAAuBzuC,KAAO,CAC7BC,SAAU,mBACViE,OAAQ,CAAC,UAAW,QAAS,YAC7B3H,SAAQ,qoDAHT,ICrFqB8yC,GAAAA,SAAAA,G1EyoWnB,SAASA,IACP,OAAO1H,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KASrD,OAZAoD,EAAei5C,EAA0B1H,GAM5B0H,EAAyB95C,U0E3oWvCgK,OAAA,WACCvM,KAAKqW,MAAQrW,KAAKqW,OAAS,S1EgpWpBgmC,E0EnpWYA,CAAiC5H,IAQtD4H,GAAyBrvC,KAAO,CAC/BC,SAAU,qBACViE,OAAQ,CAAC,UAAW,SACpB3H,SAAQ,mbAHT,ICPqB+yC,GAAAA,W3E2pWnB,SAASA,KAuET,OArEAA,E2EzpWMC,SAAP,WAMC,OALKv8C,KAAKw8C,YACTx8C,KAAKw8C,UAAY9R,EAAAA,UAAUjmC,OAAQ,WAAW8N,KAC7CkK,EAAAA,YAAY,KAGPzc,KAAKw8C,W3E2pWZF,E2ExpWMG,OAAP,WAMC,OALKz8C,KAAK08C,UACT18C,KAAK08C,QAAUhS,EAAAA,UAAUjmC,OAAQ,SAAS8N,KACzCkK,EAAAA,YAAY,KAGPzc,KAAK08C,S3E0pWZJ,E2EvpWMK,MAAP,WAAe,IAAA14C,EAAAjE,KAgBd,OAfKA,KAAK48C,SACT58C,KAAK48C,OAAS74C,EAAAA,MAAM/D,KAAKu8C,WAAYv8C,KAAKy8C,UAAUlqC,KACnDlD,EAAAA,KAAI,SAAAsJ,GACH,IAAM9V,EAAOoB,EAAKpB,KAMlB,MALmB,YAAf8V,EAAMrI,KACTzN,EAAK8V,EAAMlY,MAAO,SAEXoC,EAAK8V,EAAMlY,KAEZwD,EAAKpB,QAEbg6C,EAAAA,UAAU78C,KAAK6C,MACf4Z,EAAAA,YAAY,KAGPzc,KAAK48C,Q3E2pWZN,E2ExpWMQ,KAAP,WACC,IAAK98C,KAAK+8C,MAAO,CAChB,IAAMC,EAAS,KACfh9C,KAAK+8C,MAAQ/8C,KAAKu8C,WAAWhqC,KAC5BvP,EAAAA,QAAO,SAAA2V,GAAK,OAAIA,EAAMlY,KAAOkY,EAAMlY,IAAIikB,MAAMs4B,MAC7C3tC,EAAAA,KAAI,SAAAsJ,GAAK,OAAIA,EAAMlY,OACnBgc,EAAAA,YAAY,IAGd,OAAOzc,KAAK+8C,O3E4pWZT,E2EzpWMW,QAAP,WACC,IAAKj9C,KAAKk9C,SAAU,CACnB,IACCC,EADG9sB,EAAS,GAEbrwB,KAAKk9C,SAAWl9C,KAAK88C,OAAOvqC,KAC3BlD,EAAAA,KAAI,SAAA5O,GAQH,OAPI08C,GACHC,aAAaD,GAEd9sB,GAAU5vB,EACV08C,EAAKr6B,YAAW,WACfuN,EAAS,KACP,MACIA,KAER5T,EAAAA,YAAY,IAGd,OAAOzc,KAAKk9C,U3E2pWLZ,E2EluWYA,G3EquWrB95C,E2EruWqB85C,GAAAA,OAEN,IAAA,ICEMe,GAAAA,SAAAA,G5EouWnB,SAASA,IACP,OAAO1I,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KAHrDoD,EAAei6C,EAA8B1I,GAM7C,IAAIjvC,EAAS23C,EAA6B96C,UA+H1C,OA7HAmD,E4ExuWD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKqW,MAAQrW,KAAKqW,OAAS,QAC3BrW,KAAK4rC,SAAU,EACf5rC,KAAKi1C,WAAahK,GAAkBc,SACpCuQ,GAAgBW,UAAU1qC,KACzBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAunC,GACXr5C,EAAKs5C,aAAaD,O5EmvWnB53C,E4ExuWD63C,aAAA,SAAaD,GAIZ,IAFA,IAAM9d,EAAQx/B,KAAK8P,QAAQnK,SAAW,GAClCuD,GAAS,EACJvH,EAAI,EAAGA,EAAI69B,EAAM59B,OAAQD,IAAK,CAEtC,GAAyD,IAD/C69B,EAAM79B,GACV8N,KAAK85B,cAAcrkC,QAAQo4C,EAAK/T,eAAsB,CAE3DrgC,EAAQvH,EACR,OAGF,IAAe,IAAXuH,EAAc,CAAA,IACTwD,EAASC,EAAAA,WAAW3M,MAApB0M,KACFs/B,EAAWt/B,EAAK5H,cAAc,aAE9B26B,EADc/yB,EAAK5H,cAAc,kBACd04C,SAASt0C,GAClC8iC,EAASyR,SAAS,EAAGhe,EAAKie,a5EivW3Bh4C,E4E7uWDi4C,UAAA,SAAUle,GAET,IAAI7+B,EACJ,GAAIZ,KAAK49C,WAAY,CACpB,IAAMh9C,EAAQZ,KAAK8P,QAAQlP,OAAS,GAC9BsI,EAAQtI,EAAMsE,QAAQu6B,EAAKzuB,KAClB,IAAX9H,EAEHtI,EAAM+c,OAAOzU,EAAO,GAGpBtI,EAAMuC,KAAKs8B,EAAKzuB,I5E8DpB,SAAwBvB,GACtB,MAAM,IAAIouC,MAAM,IAAOpuC,EAAO,kB4E7DxBquC,CAAA,SAALl9C,EAAQA,EAAMgB,OAAShB,EAAMkQ,QAAU,UAEvClQ,EAAQ6+B,EAAKzuB,GAGdhR,KAAK8P,QAAQlP,MAAQA,EACrBZ,KAAKw4B,OAAOvkB,KAAKrT,I5EovWjB8E,E4EjvWDuwC,UAAA,SAAUxW,GACT,OAAIz/B,KAAK49C,YAE4B,KADrB59C,KAAK8P,QAAQlP,OAAS,IACvBsE,QAAQu6B,EAAKzuB,IAEpBhR,KAAK8P,QAAQlP,QAAU6+B,EAAKzuB,I5EqvWpCtL,E4EjvWD0/B,SAAA,WACC,IAAIxkC,EAAQZ,KAAK8P,QAAQlP,MACnB4+B,EAAQx/B,KAAK8P,QAAQnK,SAAW,GACtC,GAAI3F,KAAK49C,WAER,OADAh9C,EAAQA,GAAS,IACPgB,OACFhB,EAAMyO,KAAI,SAAA0uC,GAChB,IAAMte,EAAOD,EAAMliB,MAAK,SAAAhO,GAAC,OAAIA,EAAE0B,KAAO+sC,GAAKzuC,EAAEG,OAASsuC,KACtD,OAAOte,EAAOA,EAAKhwB,KAAO,MACxBF,KAAK,MAEDR,EAAUE,UAAU,UAG5B,IAAMwwB,EAAOD,EAAMliB,MAAK,SAAAhO,GAAC,OAAIA,EAAE0B,KAAOpQ,GAAS0O,EAAEG,OAAS7O,KAC1D,OAAI6+B,EACIA,EAAKhwB,KAELV,EAAUE,UAAU,W5E6vW7BvJ,E4ExvWDwwC,UAAA,SAAU1c,GAELx5B,KAAK4rC,SAAsB,OAAXpS,IACnBx5B,KAAK8P,QAAQwH,SAAU,GAExBtX,KAAK4rC,QAAUpS,IAAWx5B,KAAKi1C,Y5E4vW/B9yC,EAAak7C,EAA8B,CAAC,CAC1C58C,IAAK,aACL8D,IAAK,W4E1vWP,OAAOvE,KAAK07C,WAA8B,IAAlB17C,KAAK07C,UAAwC,UAAlB17C,KAAK07C,a5E+vWjD2B,E4Ev2WYA,CAAqC5I,IA4G1D4I,GAA6BrwC,KAAO,CACnCC,SAAU,0BACVsjB,QAAS,CAAC,UACVrf,OAAQ,CAAC,UAAW,QAAS,YAC7B3H,SAAQ,q7BAJT,ICjHqBy0C,GAAAA,SAAAA,G7Ew3WnB,SAASA,IACP,OAAOrJ,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KAHrDoD,EAAe46C,EAAsBrJ,GAMrC,IAAIjvC,EAASs4C,EAAqBz7C,UAwClC,OAtCAmD,E6E53WD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKqW,MAAQrW,KAAKqW,OAAS,QAC3BrW,KAAK6sC,SAAW7sC,KAAK6sC,WAAY,EAFzB,IAGAngC,EAASC,WAAW3M,MAApB0M,KACF4tB,EAAQt6B,KAAKs6B,MAAQ5tB,EAAK5H,cAAc,SAC9Cf,MAAM2mC,UAAUpQ,EAAO,UAAU/nB,KAAKkE,UAAUzW,KAAK0W,eAAeX,WAAU,SAAA4C,GAAK,OAAI1U,EAAKg2B,iBAAiBthB,MAC7G+xB,UAAUpQ,EAAO,QAAQ/nB,KAAKkE,UAAUzW,KAAK0W,eAAeX,WAAU,SAAA4C,GAAK,OAAI1U,EAAKg6C,eAAetlC,O7Ew4WnGjT,E6Er4WDu0B,iBAAA,SAAiBthB,GAChBlS,QAAQC,IAAI,wCAAyCiS,EAAMlX,OAAOb,Q7Ek5WlE8E,E6Er4WDu4C,eAAA,SAAetlC,GACdlS,QAAQC,IAAI,sCAAuCiS,EAAMlX,OAAOb,OAChEZ,KAAK8P,QAAQwH,SAAU,EACvBtX,KAAKY,MAAQZ,KAAKs6B,MAAM15B,O7Ew4WjBo9C,E6Ep6WYA,CAA6BvJ,IAiClDuJ,GAAqBhxC,KAAO,CAC3BC,SAAU,iBACViE,OAAQ,CAAC,UAAW,QAAS,YAC7B3H,SAAQ,0aAHT,IC3BqB20C,GAAAA,SAAAA,G9Ey6WnB,SAASA,IACP,OAAOvJ,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KAHrDoD,EAAe86C,EAAgCvJ,GAM/C,IAAIjvC,EAASw4C,EAA+B37C,UAoD5C,OAlDAmD,E8El6WD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKqW,MAAQrW,KAAKqW,OAAS,QAC3BrW,KAAK6sC,SAAW7sC,KAAK6sC,WAAY,EACjC7sC,KAAK40C,OAAS50C,KAAK40C,QAAU,wBAC7B50C,KAAKsK,UAAYS,EAAYT,UAC7BtK,KAAKm+C,gBAAkBpzC,EAAYR,gBAL3B,IAOF+vB,EADW3tB,EAAAA,WAAW3M,MAApB0M,KACW5H,cAAc,SACjCw1B,EAAM9e,aAAa,SAAUxb,KAAK40C,QAClC7B,GAAYC,MAAM1Y,GAAO/nB,KACxBkE,EAAAA,UAAUzW,KAAK0W,eACdX,YACFg9B,GAAYK,QAAQ9Y,GAAO/nB,KAC1B8B,EAAAA,WAAU,SAAC85B,GACV,IAAMoF,EAAWpF,EAAM9+B,KAAI,SAAC+wB,EAAMz+B,GAAP,OAAagsC,GAAaO,QAAQ,CAAC9N,IAAO7tB,KACpE8B,EAAAA,WAAU,SAACu6B,GAAD,OAAc3qC,EAAKqG,UAAU1I,OAAS,EAAI+rC,GAAakB,8BAAgClB,GAAagB,sBAAsBC,EAAS3qC,EAAK6L,QAAS7L,EAAKk6C,wBAEjK,OAAOrkC,EAAAA,cAAcy5B,MAEtB98B,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA/M,GAEX/E,EAAK6L,QAAQlP,MAAQoI,EAAO,O9Ew6W7BtD,E8Ep6WD04C,YAAA,SAAYv4C,GACX7F,KAAKm+C,gBAAkBt4C,EACvB7F,KAAKuV,e9Eu6WLpT,EAAa+7C,EAAgC,CAAC,CAC5Cz9C,IAAK,iBACL8D,IAAK,W8E/8WP,IAAI47B,EAAQngC,KAAK8P,QAAQlP,MACzB,GAAIu/B,GAASA,EAAMke,OAAQ,CAC1B,IAAMC,EAAiBne,EAAMke,OAAOr+C,KAAKm+C,iBACrCG,IACHne,EAAQme,GAGV,OAAOne,M9Eu9WA+d,E8Ej+WYA,CAAuCzJ,IA6C5DyJ,GAA+BlxC,KAAO,CACrCC,SAAU,4BACViE,OAAQ,CAAC,UAAW,QAAS,WAAY,UACzC3H,SAAQ,+nCAHT,IC9CqBg1C,GAAAA,SAAAA,G/E6+WnB,SAASA,IACP,OAAOzJ,EAAsBzzC,MAAMrB,KAAMoB,YAAcpB,KAHzDoD,EAAem7C,EAAuBzJ,GAMtC,IAAIpvC,EAAS64C,EAAsBh8C,UA4DnC,OA1DAmD,E+Ej/WD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKqW,MAAQrW,KAAKqW,OAAS,QAC3BrW,KAAK6sC,SAAW7sC,KAAK6sC,WAAY,EACjC7sC,KAAK40C,OAAS50C,KAAK40C,QAAU,OAHrB,IAIAloC,EAASC,EAAAA,WAAW3M,MAApB0M,KACF4tB,EAAQt6B,KAAKs6B,MAAQ5tB,EAAK5H,cAAc,SAC9Cw1B,EAAM9e,aAAa,SAAUxb,KAAK40C,QAMlC7B,GAAYK,QAAQ9Y,GAAO/nB,KAC1B8B,EAAAA,WAAU,SAAC85B,GACV,IAAMoF,EAAWpF,EAAM9+B,KAAI,SAAC+wB,EAAMz+B,GAAP,OAAagsC,GAAaO,QAAQ,CAAC9N,IAAO7tB,KACpE8B,EAAAA,WAAU,SAACu6B,GAAD,OAAajB,GAAagB,qBAAqBC,EAAS3qC,EAAK6L,gBAExE,OAAOgK,EAAAA,cAAcy5B,MAEtB98B,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA/M,GACXvC,QAAQC,IAAI,gCAAiCsC,GAC7C/E,EAAK6L,QAAQlP,MAAQoI,EAAO,O/E0/W7BtD,E+Et/WDkyC,SAAA,SAASj/B,GAAO,IAAAnE,EAAAxU,KACf2tC,GAAaG,aAAa9tC,KAAK8P,QAAQlP,OAAO2R,KAC7CuD,EAAAA,SACCC,WAAU,WACXvB,EAAK1E,QAAQlP,MAAQ,KACrB4T,EAAK8lB,MAAM15B,MAAQ,KACnB4T,EAAK1E,QAAQwH,SAAU,M/EugXxB5R,E+Er/WD8tC,MAAA,SAAMpT,EAAMz+B,GACX,OAAOyS,EAAAA,GAAGgsB,I/Ew/WHme,E+E7iXYA,CAA8B7J,IAyDnD6J,GAAsBvxC,KAAO,CAC5BC,SAAU,kBACViE,OAAQ,CAAC,UAAW,QAAS,WAAY,UACzC3H,SAAQ,s0BAHT,IC9DqBi1C,GAAAA,SAAAA,GhF6jXnB,SAASA,IACP,OAAO7J,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KAHrDoD,EAAeo7C,EAAwB7J,GAMvC,IAAIjvC,EAAS84C,EAAuBj8C,UAapC,OAXAmD,EgFlkXD6G,OAAA,WACCvM,KAAKqW,MAAQrW,KAAKqW,OAAS,QAC3BrW,KAAKy+C,UAAYz+C,KAAKy+C,WAAa,EACnCz+C,KAAK0+C,UAAY1+C,KAAK0+C,WAAa,EAAIlkC,KAAK4d,IAAI,GAAIp4B,KAAKy+C,WACzDz+C,KAAK6sC,SAAW7sC,KAAK6sC,WAAY,GhFqkXjCnnC,EgFnkXDi5C,YAAA,SAAY/9C,GACXZ,KAAK8P,QAAQlP,MAAQA,GhFskXd49C,EgF9kXYA,CAA+B/J,IAYpD+J,GAAuBxxC,KAAO,CAC7BC,SAAU,mBACViE,OAAQ,CAAC,UAAW,QAAS,YAAa,YAAa,YACvD3H,SAAQ,mkBAHT,ICZqBq1C,GAAAA,SAAAA,GjFylXnB,SAASA,IACP,OAAOjK,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KASrD,OAZAoD,EAAew7C,EAA0BjK,GAM5BiK,EAAyBr8C,UiF3lXvCgK,OAAA,WACCvM,KAAKqW,MAAQrW,KAAKqW,OAAS,SjFgmXpBuoC,EiFnmXYA,CAAiCnK,IAQtDmK,GAAyB5xC,KAAO,CAC/BC,SAAU,qBACViE,OAAQ,CAAC,UAAW,SACpB3H,SAAQ,oYAHT,ICRqBs1C,GAAAA,SAAAA,GlF8mXnB,SAASA,IACP,OAAOlK,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KASrD,OAZAoD,EAAey7C,EAAwBlK,GAM1BkK,EAAuBt8C,UkFhnXrCgK,OAAA,WACCvM,KAAKqW,MAAQrW,KAAKqW,OAAS,SlFqnXpBwoC,EkFxnXYA,CAA+BpK,IAQpDoK,GAAuB7xC,KAAO,CAC7BC,SAAU,mBACViE,OAAQ,CAAC,UAAW,SACpB3H,SAAQ,ooBAHT,ICRqBu1C,GAAAA,SAAAA,GnFmoXnB,SAASA,IACP,OAAOnK,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KAUrD,OAbAoD,EAAe07C,EAAsBnK,GAMxBmK,EAAqBv8C,UmFroXnCgK,OAAA,WACCvM,KAAKqW,MAAQrW,KAAKqW,OAAS,QAC3BrW,KAAK6sC,SAAW7sC,KAAK6sC,WAAY,GnF0oX1BiS,EmF9oXYA,CAA6BrK,IASlDqK,GAAqB9xC,KAAO,CAC3BC,SAAU,iBACViE,OAAQ,CAAC,UAAW,QAAS,YAC7B3H,SAAQ,0aAHT,ICTqBw1C,GAAAA,SAAAA,GpFypXnB,SAASA,IACP,OAAOpK,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KAUrD,OAbAoD,EAAe27C,EAA0BpK,GAM5BoK,EAAyBx8C,UoF3pXvCgK,OAAA,WACCvM,KAAKqW,MAAQrW,KAAKqW,OAAS,QAC3BrW,KAAK6sC,SAAW7sC,KAAK6sC,WAAY,GpFgqX1BkS,EoFpqXYA,CAAiCtK,IAStDsK,GAAyB/xC,KAAO,CAC/BC,SAAU,qBACViE,OAAQ,CAAC,UAAW,QAAS,YAC7B3H,SAAQ,idAHT,ICTqBy1C,GAAAA,SAAAA,GrF+qXnB,SAASA,IACP,OAAOrK,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KAHrDoD,EAAe47C,EAAwBrK,GAMvC,IAAIjvC,EAASs5C,EAAuBz8C,UAepC,OAbAmD,EqFprXD6G,OAAA,WACCvM,KAAKqW,MAAQrW,KAAKqW,OAAS,QAC3BrW,KAAKy+C,UAAYz+C,KAAKy+C,WAAa,EACnCz+C,KAAK0+C,UAAY1+C,KAAK0+C,WAAa,EAAIlkC,KAAK4d,IAAI,GAAIp4B,KAAKy+C,WACzDz+C,KAAK6sC,SAAW7sC,KAAK6sC,WAAY,GrFurXjCnnC,EqFrrXDi5C,YAAA,SAAYz1C,EAAOtI,GAClB,IAAMy2C,EAASr3C,KAAK8P,QAAQlP,MAC5By2C,EAAOnuC,GAAStI,EAChBZ,KAAK8P,QAAQlP,MAAQy2C,EAAOvmC,SrFwrXrBkuC,EqFlsXYA,CAA+BvK,IAcpDuK,GAAuBhyC,KAAO,CAC7BC,SAAU,mBACViE,OAAQ,CAAC,UAAW,QAAS,YAAa,YAAa,YACvD3H,SAAQ,86BAHT,ICdqB01C,GAAAA,SAAAA,GtF6sXnB,SAASA,IACP,OAAOzU,EAAWnpC,MAAMrB,KAAMoB,YAAcpB,KAmB9C,OAtBAoD,EAAe67C,EAAmBzU,GAMrByU,EAAkB18C,UsF/sXhCitB,UAAA,WAAY,IACH9iB,EAASC,EAAAA,WAAW3M,MAApB0M,MAEc,IAAlB1M,KAAK6sC,UACRngC,EAAKmgC,SAAW7sC,KAAK6sC,SACrBngC,EAAK8O,aAAa,WAAYxb,KAAK6sC,mBAE5BngC,EAAKmgC,SACZngC,EAAKowB,gBAAgB,ctFutXfmiB,EsFjuXYA,CAA0BlU,EAAAA,WAgB/CkU,GAAkBjyC,KAAO,CACxBC,SAAU,qCACViE,OAAQ,CAAC,aAFV,ICfqBguC,GAAAA,SAAAA,GvFwuXnB,SAASA,IACP,OAAOvK,EAAkBtzC,MAAMrB,KAAMoB,YAAcpB,KAUrD,OAbAoD,EAAe87C,EAAiBvK,GAMnBuK,EAAgB38C,UuF3uX9B6iC,SAAA,SAAS3kC,EAAKG,GAEb,OADcmO,EAAUE,UAAV,SAA6BxO,IvFivXpCy+C,EuFnvXYA,CAAwBzK,IAO7CyK,GAAgBlyC,KAAO,CACtBC,SAAU,mBACViE,OAAQ,CAAC,WACT3H,SAAQ,0XAHT,ICNqB41C,GAAAA,SAAAA,GxF6vXnB,SAASA,IACP,OAAO7yC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe+7C,EAAqB7yC,GAMpC,IAAI5G,EAASy5C,EAAoB58C,UAyGjC,OAvGAmD,EwFlwXD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKqW,MAAQrW,KAAKqW,OAAS,QAC3BrW,KAAKY,MAAQZ,KAAKY,OAAS,EAC3BZ,KAAKy+C,UAAYz+C,KAAKy+C,WAAa,EACnCz+C,KAAK0+C,UAAY1+C,KAAK0+C,WAAa,EAAIlkC,KAAK4d,IAAI,GAAIp4B,KAAKy+C,WACzDz+C,KAAK6sC,SAAW7sC,KAAK6sC,WAAY,EACjC7sC,KAAKo/C,WAAW,aAAc,GAC5B7sC,KAAKkE,EAAAA,UAAUzW,KAAK0W,eACpBX,WAAU,SAAC4C,GAEX1U,EAAKrD,OAAS+X,EACd1U,EAAK4J,OAAOoG,KAAKhQ,EAAKrD,OACtBqD,EAAKsR,iBAEPvV,KAAKo/C,WAAW,cAAe,GAC7B7sC,KAAKkE,EAAAA,UAAUzW,KAAK0W,eACpBX,WAAU,SAAC4C,GAEX1U,EAAKrD,OAAS+X,EACd1U,EAAK4J,OAAOoG,KAAKhQ,EAAKrD,OACtBqD,EAAKsR,iBApBC,IAsBA7I,EAASC,EAAAA,WAAW3M,MAApB0M,KACF4tB,EAAQt6B,KAAKs6B,MAAQ5tB,EAAK5H,cAAc,SAE9Cf,EAAAA,MAAM2mC,EAAAA,UAAUpQ,EAAO,UAAU/nB,KAAKkE,EAAAA,UAAUzW,KAAK0W,eAAeX,WAAU,SAAA4C,GAAK,OAAI1U,EAAKg2B,iBAAiBthB,MAC7G+xB,EAAAA,UAAUpQ,EAAO,QAAQ/nB,KAAKkE,EAAAA,UAAUzW,KAAK0W,eAAeX,WAAU,SAAA4C,GAAK,OAAI1U,EAAKg6C,eAAetlC,OxF8wXnGjT,EwF1wXDu0B,iBAAA,SAAiBthB,GAGhBA,EAAMlX,OAAOb,MAAQ+X,EAAMlX,OAAOb,MAAMwF,QAAQ,YAAa,KxFuxX7DV,EwF1wXDu4C,eAAA,SAAetlC,GAGd,IAAM/X,EAAQy+C,WAAWr/C,KAAKs6B,MAAM15B,OAChCZ,KAAKY,QAAUA,IACJ0+C,MAAV1+C,GACHZ,KAAKY,MAAQA,EACbZ,KAAK6N,OAAOoG,KAAKjU,KAAKY,QAEtBZ,KAAKs6B,MAAM15B,MAAQZ,KAAKsY,axFgxX1B5S,EwF3wXD05C,WAAA,SAAWnyC,EAAUsyC,GAAM,IAGtBC,EAAGd,EAHmBlqC,EAAAxU,KAEpB6M,EADWF,EAAAA,WAAW3M,MAApB0M,KACa5H,cAAcmI,GAEnC,OAAOwyC,EAAAA,KAAK/U,EAAAA,UAAU79B,EAAS,aAAc69B,EAAAA,UAAU79B,EAAS,eAAe0F,KAC9EkC,EAAAA,KAAI,WACHiqC,EAAYlqC,EAAKkqC,UACjBc,EAAI,MAELnrC,EAAAA,WAAU,SAACkF,GACV,OAAOS,EAAAA,SAAS,IAAIzH,KACnBvP,EAAAA,QAAO,SAACrB,GACP,OAAOA,EAAI69C,GAAM,KAElBnwC,EAAAA,KAAI,WACH,IAAM1N,EAAI+8C,EAAYa,EAGtB,OADAC,EAAIhlC,KAAKC,IAAI,EAAGD,KAAKoK,MAAU,IAAJ46B,IACpB79C,KAGR8U,EAAAA,UAAUgpC,EAAAA,KAAK/U,EAAAA,UAAU79B,EAAS,WAAY69B,EAAAA,UAAU79B,EAAS,oBxF8wXpEnH,EwFzwXD4S,SAAA,WACC,OAAOtY,KAAKY,MAAM8+C,QAAQ1/C,KAAKy+C,YxF4wX/B/4C,EwF1wXDi6C,SAAA,SAASJ,GACRv/C,KAAKY,OAASZ,KAAK0+C,UAAYa,EAC/Bv/C,KAAK6N,OAAOoG,KAAKjU,KAAKY,OACtBZ,KAAKuV,exF6wXE4pC,EwF12XYA,CAA4BpyC,EAAAA,WAiGjDoyC,GAAoBnyC,KAAO,CAC1BC,SAAU,cACVsjB,QAAS,CAAC,UACVrf,OAAQ,CAAC,QAAS,QAAS,YAAa,YAAa,YACrD3H,SAAQ,4XAJT,IClGqBq2C,GAAAA,SAAAA,GzFu3XnB,SAASA,IACP,OAAOtzC,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAew8C,EAAetzC,GAM9B,IAAI5G,EAASk6C,EAAcr9C,UAc3B,OAZAmD,EyF33XD6G,OAAA,WACCvM,KAAKwM,IAAMjH,GzF83XXG,EyF33XDm6C,OAAA,SAAOlnC,GACN3Y,KAAK0V,KAAKzB,KAAK0E,IzF83XfjT,EyF33XDo6C,QAAA,SAAQnnC,GACP3Y,KAAKkX,MAAMjD,KAAK0E,IzF83XTinC,EyFz4XYA,CAAsB7yC,EAAAA,WAgB3C6yC,GAAc5yC,KAAO,CACpBC,SAAU,iBACViE,OAAQ,CAAC,QACTqf,QAAS,CAAC,OAAQ,SAClBhnB,SAAQ,qUAJT,ICjBqBw2C,GAAAA,SAAAA,G1Fs5XnB,SAASA,IACP,OAAOvV,EAAWnpC,MAAMrB,KAAMoB,YAAcpB,KAc9C,OAjBAoD,EAAe28C,EAAgBvV,GAMlBuV,EAAex9C,U0Fx5X7BitB,UAAA,SAAU7Y,GAAS,IACVjK,EAASC,EAAAA,WAAW3M,MAApB0M,KAERA,EAAK9L,MAAQZ,KAAKY,MAClB8L,EAAK8O,aAAa,QAASxb,KAAKY,Q1F+5XzBm/C,E0Fr6XYA,CAAuBhV,EAAAA,WAW5CgV,GAAe/yC,KAAO,CACrBC,SAAU,UACViE,OAAQ,CAAC,U1Fk6XV,I2F16XqB8uC,GAAAA,SAAAA,G3F66XnB,SAASA,IACP,OAAOhxC,EAAM3N,MAAMrB,KAAMoB,YAAcpB,KAwBzC,OA3BAoD,EAAe48C,EAAUhxC,GAMzBgxC,E2F/6XM/wC,UAAP,SAAiBrO,GAChB,GAAIA,EAAO,CACVA,EAAQA,EAAMwF,QAAQ,aAAa,SAASo5C,EAAGS,GAC9C,OAAOC,OAAOC,aAAa5e,SAAS0e,OAErC,IACMG,EAAY,CAAC,IAAK,IAAK,IAAM,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,IAAK,KACj1BC,EAAK,IAAIrW,OAAJ,KAFK,CAAC,OAAQ,MAAO,OAAQ,KAAM,KAAM,OAAQ,QAAS,OAAQ,QAAS,SAAU,MAAO,SAAU,OAAQ,MAAO,OAAQ,OAAQ,QAAS,MAAO,MAAO,MAAO,OAAQ,MAAO,SAAU,OAAQ,OAAQ,QAAS,QAAS,OAAQ,SAAU,QAAS,OAAQ,OAAQ,QAAS,SAAU,SAAU,SAAU,SAAU,SAAU,SAAU,QAAS,SAAU,OAAQ,QAAS,QAAS,SAAU,SAAU,SAAU,QAAS,OAAQ,SAAU,SAAU,QAAS,OAAQ,MAAO,SAAU,SAAU,SAAU,QAAS,SAAU,OAAQ,QAAS,SAAU,SAAU,SAAU,QAAS,OAAQ,SAAU,QAAS,QAAS,SAAU,SAAU,SAAU,OAAQ,QAAS,QAAS,SAAU,SAAU,SAAU,QAAS,OAAQ,SAAU,SAAU,QAAS,OAAQ,MAAO,SAAU,SAAU,SAAU,QAAS,SAAU,OAAQ,SAAU,SAAU,SAAU,SAAU,QAAS,OAAQ,SAAU,QAAS,OAAQ,MAAO,OAAQ,MAAO,QAAS,SAAU,OAAQ,SAAU,SAAU,QAAS,MAAO,QAAS,OAAQ,MAAO,OAAQ,QAAS,MAAO,OAAQ,OAAQ,MAAO,QAAS,QAAS,OAAQ,QAAS,QAAS,UAAW,OAAQ,MAAO,QAAS,OAAQ,QAAS,SAAU,KAAM,KAAM,KAAM,UAAW,KAAM,MAAO,QAAS,MAAO,UAAW,MAAO,MAAO,MAAO,QAAS,QAAS,OAAQ,QAAS,QAAS,UAAW,OAAQ,MAAO,QAAS,OAAQ,QAAS,SAAU,KAAM,KAAM,KAAM,UAAW,KAAM,MAAO,QAAS,MAAO,UAAW,MAAO,MAAO,MAAO,SAE/4Cz6B,KAAK,SAA7B,KAA2C,KAUtD,OATA3O,EAAQA,EAAMwF,QAAQi6C,GAAI,WACzB,IAAK,IAAI1+C,EAAI,EAAGA,EAAIP,UAAUQ,OAAQD,IACrC,GAAIP,UAAUO,GAEb,OAAOy+C,EAAUz+C,EAAI,Q3Fw7XlBq+C,E2Ft8XYA,CAAiBxwC,EAAAA,MAyBtCwwC,GAAShzC,KAAO,CACfyC,KAAM,QADP,IC9BqB6wC,GAAAA,SAAAA,G5Fk9XnB,SAASA,IACP,OAAO9V,EAAWnpC,MAAMrB,KAAMoB,YAAcpB,KAY9C,OAfAoD,EAAek9C,EAAa9V,GAMf8V,EAAY/9C,U4Fp9X1BitB,UAAA,WACkB7iB,EAAAA,WAAW3M,MAApB0M,KACH8O,aAAa,KAAMxb,KAAKgR,K5F29XtBsvC,E4F/9XYA,CAAoBvV,EAAAA,WASzCuV,GAAYtzC,KAAO,CAClBC,SAAU,OACViE,OAAQ,CAAC,OAFV,ICLqBqvC,GAAAA,SAAAA,G7Fm+XnB,SAASA,IACP,OAAOj0C,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAem9C,EAAiBj0C,GAMhC,IAAI5G,EAAS66C,EAAgBh+C,UA2H7B,OAzHAmD,E6Fh+XD6G,OAAA,WACCvM,KAAKwM,IAAMzB,EACX/K,KAAKoV,MAAQ,CACZnC,OAAQ/H,EAAgB3G,IAAI,WAAa,YACzCsW,KAAM3P,EAAgB3G,IAAI,SAAW,YACrCmd,aAAc,EACd6kB,MAAM,EACNv+B,MAAM,EACN4+B,WAAW,EACXn3B,KAAM,iBACNwL,IAAK,oBAENjb,KAAKoV,MAAMkxB,MAAQtmC,KAAKoV,MAAMyF,OAASxH,EAASK,YAChD1T,KAAK2J,KAAO,CACX25B,MAAO,IAERtjC,KAAK+d,MAAQ,GACb/d,KAAK4c,OAAS,KACd5c,KAAKqd,QAAU,IAAIlZ,MAAM,GAAGqzB,KAAK,GAAGnoB,KAAI,SAACC,EAAG3N,GAAJ,MAAW,CAAEqP,GAAIrP,EAAI,MAC7DwW,EAAaC,WAAWpY,KAAKoV,OAC7B3O,QAAQC,IAAI,kBAAmB1G,O7Fu+X/B0F,E6Fn+XD0S,WAAA,SAAWhD,GACVpV,KAAKoV,MAAQnT,OAAO8D,OAAO,GAAI/F,KAAKoV,MAAOA,GAC3CpV,KAAKuV,e7Fs+XL7P,E6Fn+XD8iB,aAAA,WACCxoB,KAAKoY,WAAW,CAAEuQ,aAAc3oB,KAAKoV,MAAMuT,e7Fw+X3CjjB,E6Fr+XDojB,YAAA,WACC9oB,KAAKoY,WAAW,CAAE6Q,YAAajpB,KAAKoV,MAAM6T,c7F0+X1CvjB,E6Fv+XDmnB,aAAA,WACC7sB,KAAKoY,WAAW,CAAEwE,QAAS5c,KAAKoV,MAAMwH,U7F4+XtClX,E6Fz+XD4hC,aAAA,WACCtnC,KAAKoY,WAAW,CAAEmvB,aAAcvnC,KAAKoV,MAAMmyB,e7F8+X3C7hC,E6F3+XD8hC,WAAA,WACCxnC,KAAKoY,WAAW,CAAEpQ,MAAOhI,KAAKoV,MAAMpN,KAAM4+B,WAAW,K7Fi/XrDlhC,E6F9+XD+hC,YAAA,WACCznC,KAAKoY,WAAW,CAAEpQ,MAAM,K7Fm/XxBtC,E6Fh/XDgiC,gBAAA,WACC1nC,KAAKoY,WAAW,CAAEtI,SAAU9P,KAAKoV,MAAMtF,QAASwZ,QAAQ,K7Fs/XxD5jB,E6Fn/XD02B,YAAA,SAAYtkB,GACX,IAAMwR,EAAStpB,KAAKoV,MAAMkU,SAAWxR,EAAW,KAAOA,EACvD9X,KAAKoY,WAAW,CAAEkR,OAAAA,EAAQxZ,SAAS,K7Fy/XnCpK,E6Ft/XDiiC,QAAA,WACC3nC,KAAK2J,KAAK05B,OAAQ,EAClBrjC,KAAK2mC,SAAS3mC,KAAK2J,O7F0/XnBjE,E6Fv/XDihC,SAAA,SAASh9B,GAAM,IAAA1F,EAAAjE,KACd,GAAI2J,GAAQ3J,KAAK2J,KAAKqH,KAAOrH,EAAKqH,GAAI,CACrC,IAAM42B,EAAc5nC,KAAK2J,KAAKg9B,SAC9B3mC,KAAK2J,KAAK25B,MAAQ35B,EAAK25B,MACvBtjC,KAAK2J,KAAKg9B,UAAW,EACrB3mC,KAAKuV,cACAqyB,GACJ9kB,YAAW,WACV7e,EAAK0F,KAAKg9B,UAAW,EACrB1iC,EAAKsR,gBACH,Q7FggYL7P,E6F3/XDkuB,WAAA,a7F6/XCzxB,EAAao+C,EAAiB,CAAC,CAC7B9/C,IAAK,UACL8D,IAAK,W6FvlYP,IAAMsjC,EAAU,GAGhB,OAFAA,EAAQ7nC,KAAKoV,MAAMyF,OAAQ,EAC3BgtB,EAAQ7/B,KAAOhI,KAAKoV,MAAMpN,KACnB6/B,M7F4lYA0Y,E6FlmYYA,CAAwBxzC,EAAAA,WAgG7CwzC,GAAgBvzC,KAAO,CACtBC,SAAU,sBCnGX,IAAIuzC,GAAM,EAEGC,GACF,WADEA,GAEF,WAEUC,GAAAA,W9FymYnB,SAASA,KAoET,OAlEAA,E8FzmYMz3C,OAAP,WAIC,OAHKjJ,KAAK2gD,UACT3gD,KAAK2gD,QAAU,IAAIC,OAAO71C,EAAY9B,SAEhCjJ,KAAK2gD,S9F6mYZD,E8F1mYM5iB,QAAP,SAAehiB,EAAKhP,GACnB,KAAM,WAAYrI,SAAWzE,KAAK6gD,OAAO/kC,IAAQ9b,KAAK8gD,OAAOhlC,GAC5D,OAAO1H,EAAAA,GAAG,CAAE9D,KAAMmwC,GAA4BjvC,KAAKsK,IAEpD,IAAM9K,IAAOwvC,GACPv3C,EAASjJ,KAAKiJ,SAGpB,OAFAA,EAAO83C,YAAY,CAAEjlC,IAAAA,EAAK9K,GAAAA,EAAIlE,KAAAA,IAEvB49B,EAAAA,UAAUzhC,EAAQ,WAAWsJ,KACnClD,EAAAA,KAAI,SAAAsJ,GAAK,OAAIA,EAAMnH,QACnBxO,EAAAA,QAAO,SAAA2V,GAAK,OAAIA,EAAMmD,MAAQA,KAC9Bm9B,EAAAA,UAAU,KACV5pC,EAAAA,KAAI,SAAAsJ,GAEH,GAAIA,EAAMrI,OAASmwC,IAA8B9nC,EAAMnH,gBAAgBwvC,KAAM,CAC5E,IAAMp7C,EAAMmW,IAAIC,gBAAgBrD,EAAMnH,MACtCmH,EAAMnH,KAAO5L,EAGd,OAAO+S,KAERsoC,EAAAA,WAAU,SAAAtoC,GAAK,OAAIA,EAAMrI,OAASmwC,MAA4B,GAC9DpsB,EAAAA,UAAS,WAERprB,EAAO83C,YAAY,CAAE/vC,GAAAA,S9F2nYvB0vC,E8FjnYM3iB,MAAP,SAAajiB,EAAKhP,GACjB,OAAO9M,KAAK89B,QAAQhiB,EAAKhP,GAAMyF,KAC9BvP,EAAAA,QAAO,SAAA2V,GAAK,OAAIA,EAAMrI,OAASmwC,MAC/BpxC,EAAAA,KAAI,SAAAsJ,GAAK,OAAIA,EAAMnH,U9FsnYpBkvC,E8FlnYMI,OAAP,SAAchlC,GAEb,OAAO,G9FqnYP4kC,E8FjnYMG,OAAP,SAAc/kC,GACb,OAAgC,IAAzBA,EAAI5W,QAAQ,U9FonYZw7C,E8F7qYYA,GCPAQ,GAAAA,W/FsrYnB,SAASA,KAyDT,OAvDAA,E+FtrYM5qB,SAAP,WAAkB,IAAAryB,EAAAjE,KAQjB,OAPKA,KAAKmhD,YACTnhD,KAAKohD,cAAgB,IAAIlsC,EAAAA,iBAAgB,GACzClV,KAAKqhD,iBAAmB,IAAIpjB,EAAAA,QAC5Bj+B,KAAKmhD,UAAY,IAAIG,sBAAqB,SAAAC,GACzCt9C,EAAKo9C,iBAAiBptC,KAAKstC,OAGtBvhD,KAAKmhD,W/F4rYZD,E+FzrYMM,cAAP,SAAqB90C,GACpB,GAAI,yBAA0BjI,OAAQ,CACrC,IAAM6xB,EAAWt2B,KAAKs2B,WAEtB,OADAA,EAASmrB,QAAQ/0C,GACV1M,KAAKqhD,iBAAiB9uC,KAE5BlD,EAAAA,KAAI,SAAAkyC,GAAO,OAAIA,EAAQjkC,MAAK,SAAAokC,GAAK,OAAIA,EAAMjgD,SAAWiL,QAEtD1J,EAAAA,QAAO,SAAA0+C,GAAK,YAAcngD,IAAVmgD,GAAuBA,EAAMC,kBAC7C7rC,EAAAA,QACAue,EAAAA,UAAS,WAAA,OAAMiC,EAASsrB,UAAUl1C,OAGnC,OAAO0H,EAAAA,GAAG,CAAE3S,OAAQiL,K/FqtYdw0C,E+F/uYYA,GCHAW,GAAAA,WhGovYnB,SAASA,KA8BT,OA5BAA,EgG9uYMt9C,IAAP,SAAWuX,GACV,OAAO9b,KAAKwZ,MAAMsC,IhGivYlB+lC,EgG9uYMr7C,IAAP,SAAWsV,EAAK83B,GACf5zC,KAAKwZ,MAAMsC,GAAO83B,EAClB,IAAM/wC,EAAOZ,OAAOY,KAAK7C,KAAKwZ,OAC1B3W,EAAKjB,OAAS,KACjB5B,KAAKqK,OAAOxH,EAAK,KhGmvYlBg/C,EgG/uYMx3C,OAAP,SAAcyR,UACN9b,KAAKwZ,MAAMsC,IhGkvYlB3Z,EAAa0/C,EAAW,KAAM,CAAC,CAC7BphD,IAAK,QACL8D,IAAK,WgGpwYP,OAHKvE,KAAK8hD,SACT9hD,KAAK8hD,OAAS,IAER9hD,KAAK8hD,WhG6wYLD,EgGlxYYA,GCOAE,GAAAA,SAAAA,GjG+wYnB,SAASA,IACP,OAAOvX,EAAWnpC,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe2+C,EAAevX,GAM9B,IAAI9kC,EAASq8C,EAAcx/C,UA2C3B,OAzCAmD,EiGnxYD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACA0M,EAASC,EAAAA,WAAW3M,MAApB0M,KACRA,EAAK0f,UAAUC,IAAI,QACnBrsB,KAAKgiD,QAAS,IAAI/jB,EAAAA,SAAU1rB,KAC3ByI,EAAAA,uBACA3G,EAAAA,WAAU,SAAAimB,GACT,IAAMxe,EAAM+lC,GAAUt9C,IAAI+1B,GAC1B,OAAIxe,EACI1H,EAAAA,GAAG0H,IAEXpP,EAAK0f,UAAU/hB,OAAO,UACfpG,EAAKg+C,MAAM3nB,OAEnB7jB,EAAAA,UAAUzW,KAAK0W,eAEhB1W,KAAKgiD,OAAOjsC,WAAU,SAAA+F,GACrB+lC,GAAUr7C,IAAIvC,EAAKi+C,KAAMpmC,GACzBpP,EAAK8O,aAAa,MAAOM,GACzBpP,EAAK0f,UAAUC,IAAI,cjGyxYpB3mB,EiGrxYD8pB,UAAA,WACCxvB,KAAKgiD,OAAO/tC,KAAKjU,KAAKkiD,OjGwxYtBx8C,EiGrxYDu8C,MAAA,SAAM3nB,GAAO,IAAA9lB,EAAAxU,KACJ0M,EAASC,EAAAA,WAAW3M,MAApB0M,KACR,OAAOw0C,GAAoBM,cAAc90C,GAAM6F,KAE9C8B,EAAAA,WAAU,WAAA,OAAMqsC,GAAa3iB,MAAMzD,EAAO9lB,EAAK1H,SAC/CgJ,EAAAA,UjG6xYMisC,EiG9zYYA,CAAsBhX,EAAAA,WAwC3CgX,GAAc/0C,KAAO,CACpBC,SAAU,kBACViE,OAAQ,CAAC,OAAQ,SAFlB,IC3CqBixC,GAAAA,SAAAA,GlGy0YnB,SAASA,IACP,OAAO71C,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe++C,EAAgB71C,GAM/B,IAAI5G,EAASy8C,EAAe5/C,UAe5B,OAbAmD,EkG70YD6G,OAAA,WAAS,IACAiyB,EAAmB7xB,EAAAA,WAAW3M,MAA9Bw+B,eACJA,aAA0BN,KAC7Bl+B,KAAKwR,KAAOgtB,EAAe/0B,MAAM+H,OlGm1YlC9L,EkG/0YD4c,MAAA,WACCmb,GAAan9B,UlGk1YN6hD,EkG51YYA,CAAuBp1C,EAAAA,WAe5Co1C,GAAen1C,KAAO,CACrBC,SAAU,WADX,IChBqBm1C,GAAAA,SAAAA,GnGo2YnB,SAASA,IACP,OAAOpzC,EAAM3N,MAAMrB,KAAMoB,YAAcpB,KAQzC,OAXAoD,EAAeg/C,EAAUpzC,GAMzBozC,EmGt2YMnzC,UAAP,SAAiBxO,GAEhB,OADYsK,EAAYnF,IACbnF,IAAJ,IAAgBA,GnGy2YhB2hD,EmG72YYA,CAAiB5yC,EAAAA,MAStC4yC,GAASp1C,KAAO,CACfyC,KAAM,QADP,ICVqB4yC,GAAAA,SAAAA,GpGq3YnB,SAASA,IACP,OAAOC,EAAWjhD,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAei/C,EAAkBC,GAMjC,IAAI58C,EAAS28C,EAAiB9/C,UAsC9B,OApCAmD,EoG13YD6G,OAAA,WACCvM,KAAK6N,UpG63YLnI,EoG33YD8pB,UAAA,WACCxvB,KAAK6N,UpG83YLnI,EoG53YDmI,OAAA,WACC,GAAI7N,KAAKuiD,QAAUviD,KAAKyP,KAAM,CAC7BzP,KAAKuiD,MAAQviD,KAAKyP,KADW,IAErB/C,EAASC,EAAAA,WAAW3M,MAApB0M,KACR,GAAIA,EAAKouB,WAAY,CAAA,IAAA0nB,EAEd31C,EAAUhI,SAAS49C,gBADX,6BACE,OACV7c,EAAI5lC,KAAK0b,OAAS,GAClBgnC,EAAI1iD,KAAK2b,QAAU,GACzB9O,EAAQ2O,aAAa,QAArB,SAAuCxb,KAAKyP,MAG5C5C,EAAQ81C,eAAe,KAAM,UAA7B,OAA+C/c,EAA/C,IAAoD8c,GACpD71C,EAAQmxB,UAAR,qBAAyCh+B,KAAKyP,KAA9C,WACA5C,EAAQ+1C,SAAWl2C,EAAKk2C,UACxBJ,EAAA31C,EAAQuf,WAAUC,IAAlBhrB,MAAAmhD,EAAyB91C,EAAK0f,WAC9B1f,EAAKouB,WAAW+nB,aAAah2C,EAASH,MpGw4YjC21C,EoG/5YYA,CAAyBS,EAAAA,WA6B9CT,GAAiBr1C,KAAO,CACvBC,SAAU,WACViE,OAAQ,CAAC,OAAQ,QAAS,WAK3B,IC/BqB6xC,GAAAA,SAAAA,GrGq6YnB,SAASA,IACP,OAAOz2C,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAe2/C,EAAkBz2C,GAMjC,IAAI5G,EAASq9C,EAAiBxgD,UA+E9B,OA7EAmD,EqGz6YD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKkxB,SAAWP,GAAcO,SAC9BlxB,KAAKgjD,WAAY,EACjBhjD,KAAKijD,aAAc,EACnBjjD,KAAKkjD,aAAc,EACnB,IAAMx4B,EAAS1qB,KAAK0qB,OAAS1qB,KAAKmjD,YAE9Bz4B,GACH0X,GAAYe,UAAUzY,GAAQnY,KAC7BuD,EAAAA,SACCC,WAAU,SAAApM,GACX,IAAKA,EAAKtC,GAGT,OAFApD,EAAK++C,WAAY,OACjB/+C,EAAKsR,cAIN,GAAItR,EAAKitB,WAAaR,GAAoB,CACzC,IAAM0yB,EAAUn/C,EAAKo/C,WAAW15C,GAC5By5C,EACH3+C,OAAOC,SAAS6B,KAAO68C,GAEvBn/C,EAAKg/C,aAAc,EACnBh/C,EAAKsR,oBAEA,GAA8B,OAA1BtR,EAAKq/C,WAAW35C,GAAgB,CAC1C,IAAM45C,EAAkBt/C,EAAKu/C,mBAAmB75C,GAC/BgD,EAAAA,WAAW1I,GAApByI,KACH+O,YAAY8nC,QAEjBt/C,EAAKi/C,aAAc,EACnBj/C,EAAKsR,kBrGw7YR7P,EqGl7YD29C,WAAA,SAAW15C,GACV,OAAQA,EAAKtC,IAAMsC,EAAKtC,GAAG+xC,KAAQruC,EAAY1E,QAAQsD,EAAKtC,GAAG+xC,KAAKtY,OAASn3B,EAAKtC,GAAG+xC,KAAKhZ,MAAQ,MrGq7YlG16B,EqGl7YD49C,WAAA,SAAW35C,GACV,OAAQA,EAAKtC,IAAMsC,EAAKtC,GAAGiyC,KAAQvuC,EAAY1E,QAAQsD,EAAKtC,GAAGiyC,KAAKxY,OAASn3B,EAAKtC,GAAGiyC,KAAKlZ,MAAQ,MrGq7YlG16B,EqGl7YDy9C,UAAA,WACC,IAAIz4B,EAASxf,EAAgB3G,IAAI,WAAa,KAI9C,OAHImmB,IACHA,EAAS6W,SAAS7W,IAEZA,GrGu7YPhlB,EqGp7YD89C,mBAAA,SAAmB75C,GAClB,IAAMC,EAAWmB,EAAY1E,QAAQsD,EAAKw2B,MAAMW,OAASn3B,EAAKw2B,MAAMC,MAC9DgjB,EAAUpjD,KAAKqjD,WAAW15C,GAC1B85C,EAAUzjD,KAAKsjD,WAAW35C,GAC1BJ,EAAQ,8BACQI,EAAK8F,KADb,mBACoC7F,EADpC,cAC0Dw5C,EAD1D,UAC2EK,EAD3E,sGAGR7mB,EAAM/3B,SAAS0W,cAAc,OAGnC,OAFAqhB,EAAIoB,UAAYz0B,EACHqzB,EAAID,mBrGw7YVomB,EqGx/YYA,CAAyBh2C,EAAAA,WAsE9Cg2C,GAAiB/1C,KAAO,CACvBC,SAAU,eADX,ICxEqBy2C,GAAAA,SAAAA,GtGigZnB,SAASA,IACP,OAAOp3C,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAesgD,EAAqBp3C,GAMpC,IAAI5G,EAASg+C,EAAoBnhD,UAuFjC,OArFAmD,EsGrgZD6G,OAAA,WAAS,IAAAtI,EAAAjE,KAEkB,OAAtBA,KAAKy/B,KAAKrI,SACbp3B,KAAKwzC,MAAMxzC,KAAKy/B,KAAKW,MAAM7tB,KAC1BkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAqhB,GACXnzB,EAAKw7B,KAAKrI,QAAUA,EACpBnzB,EAAKsR,kBtG2gZP7P,EsGtgZD8tC,MAAA,SAAMpT,GAAM,IAAA5rB,EAAAxU,KACLyzC,EAAS,IAAIC,WACbC,EAAUjJ,EAAAA,UAAU+I,EAAQ,QAAQlhC,KACzC8B,EAAAA,WAAU,SAAAsE,GACT,IAAMi7B,EAAOj7B,EAAMlX,OAAOoyC,OAC1B,OAAIr/B,EAAKirB,KAAKnvB,KAAKb,OAASy4B,GAAUC,MAAM14B,KACpC+E,EAAKs/B,QAAQF,GAEbx/B,EAAAA,GAAGw/B,OAKb,OADAH,EAAOO,cAAc5T,GACduT,GtG0gZPjuC,EsGvgZDouC,QAAA,SAAQF,GACP,OAAO,IAAI7yC,SAAQ,SAACV,EAASC,GAC5B,IAAM4zC,EAAMrvC,SAAS0W,cAAc,OACnC24B,EAAIC,OAAS,WACZ,IAEMC,EAASvvC,SAAS0W,cAAc,UAChC84B,EAAMD,EAAOznC,WAAW,MAC1B+O,EAAQw4B,EAAIx4B,MACZC,EAASu4B,EAAIv4B,OACbD,EAAQC,EACPD,EAPa,MAQhBC,GARgB,IAQMD,EACtBA,EATgB,KAYbC,EAXc,MAYjBD,GAZiB,IAYKC,EACtBA,EAbiB,KAgBnBy4B,EAAO14B,MAAQA,EACf04B,EAAOz4B,OAASA,EAChB04B,EAAIC,UAAUJ,EAAK,EAAG,EAAGx4B,EAAOC,GAChC,IAAM4mB,EAAU6R,EAAOG,UAAU,aAAc,IAC/Cl0C,EAAQkiC,IAET2R,EAAIM,QAAU,SAAS3zC,GACtBP,EAAOO,IAERqzC,EAAIp4B,IAAM83B,MtGghZXluC,EsG5gZDi+C,QAAA,WACC3jD,KAAK4jD,MAAM3vC,KAAKjU,KAAKy/B,OtG+gZrB/5B,EsG5gZDm+C,SAAA,WACC7jD,KAAK8jD,OAAO7vC,KAAKjU,KAAKy/B,OtG+gZtB/5B,EsG5gZDmyC,SAAA,WACC73C,KAAKoN,OAAO6G,KAAKjU,KAAKy/B,OtG+gZtB/5B,EsG5gZDkyC,SAAA,WACC53C,KAAKqK,OAAO4J,KAAKjU,KAAKy/B,OtG+gZfikB,EsG5lZYA,CAA4B32C,EAAAA,WAiFjD22C,GAAoB12C,KAAO,CAC1BC,SAAU,gBACVsjB,QAAS,CAAC,QAAS,SAAU,SAAU,UACvCrf,OAAQ,CAAC,QACT3H,SAAQ,u/CAJT,ICpFqBw6C,GAAAA,SAAAA,GvG2mZnB,SAASA,IACP,OAAOvZ,EAAWnpC,MAAMrB,KAAMoB,YAAcpB,KAoC9C,OAvCAoD,EAAe2gD,EAAcvZ,GAMhBuZ,EAAaxhD,UuGlmZ3Bga,KAAA,SAAKT,GAAK,IACDpP,EAASC,EAAAA,WAAW3M,MAApB0M,KACR,GAAImZ,IAAIm+B,cAAe,CACtB,IAAIp+B,EAAM,IAAIC,IAEdD,EAAIE,YAAYpZ,GAChBkZ,EAAInN,GAAGoN,IAAIE,OAAOC,gBAAgB,WACjCJ,EAAIK,WAAWnK,GACf8J,EAAInN,GAAGoN,IAAIE,OAAOG,iBAAiB,SAACvN,EAAOnH,GAE1C9E,EAAK6P,evG4mZRpa,EAAa4hD,EAAc,CAAC,CAC1BtjD,IAAK,MACL+F,IAAK,SuGnoZAof,GACH5lB,KAAKikD,OAASr+B,IACjB5lB,KAAKikD,KAAOr+B,EACZ5lB,KAAKuc,KAAKqJ,KvGsoZTrhB,IAAK,WuGjoZP,OAAOvE,KAAKikD,SvGsoZLF,EuGhpZYA,CAAqBhZ,EAAAA,WA+B1CgZ,GAAa/2C,KAAO,CACnBC,SAAU,UACViE,OAAQ,CAAC,QAFV,IC/BqBgzC,GAAAA,SAAAA,GACpB,SAAAA,EAAYzjD,EAAK0jD,EAAMvjD,EAAOwjD,EAAQl7C,EAAOm7C,EAAO7lB,GAAgB,IAAAv6B,EAAA,OACnEA,EAAAqgD,EAAAzgD,KAAA7D,KAAMw+B,IAANx+B,MACKS,GAAO0jD,EACZlgD,EAAKrD,GAASwjD,EACdngD,EAAKiF,MAAQA,EACbjF,EAAKogD,MAAQA,EALsDpgD,ExGwrZnE,OAnCAb,EAAe8gD,EAAaI,GAa5BniD,EAAa+hD,EAAa,CAAC,CACzBzjD,IAAK,QACL8D,IAAK,WwG3pZP,OAAsB,IAAfvE,KAAKkJ,QxG8pZT,CACDzI,IAAK,OACL8D,IAAK,WwG5pZP,OAAOvE,KAAKkJ,QAAUlJ,KAAKqkD,MAAQ,IxG+pZhC,CACD5jD,IAAK,OACL8D,IAAK,WwG7pZP,OAAOvE,KAAKkJ,MAAQ,GAAM,IxGgqZvB,CACDzI,IAAK,MACL8D,IAAK,WwG9pZP,OAAQvE,KAAKukD,SxGmqZNL,EwGzrZYA,CAAoBM,EAAAA,SCG5BC,GACA,EADAA,GAEN,EAFMA,GAGF,EAHEA,GAIN,EAGcC,GAAAA,SAAAA,GzG0rZnB,SAASA,IACP,OAAOpC,EAAWjhD,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeshD,EAAkBpC,GAMjC,IAAI58C,EAASg/C,EAAiBniD,UAkiB9B,OAhiBAmD,EyG9rZD6G,OAAA,WAAS,IAAAgyB,EACiB5xB,EAAAA,WAAW3M,MAA5BZ,EADAm/B,EACAn/B,OAAQsN,EADR6xB,EACQ7xB,KACVnD,EAAWmD,EAAKiwB,kBAChBgO,EAAaj+B,EAAK3H,aAAa,YACrC2H,EAAKowB,gBAAgB,YACrBpwB,EAAKquB,YAAYxxB,GACjB,IAAMo7C,EAAU3kD,KAAK2kD,OAAS3kD,KAAK4kD,oBAAoBja,GACvD3qC,KAAK6kD,gBAAkBzlD,EAAOyrC,aAAa8Z,EAAOG,UAClD9kD,KAAKmsB,UAAYzf,EACjB1M,KAAKuJ,SAAWA,EAChBvJ,KAAKqb,KAAOrb,KAAKqb,MAAQ,EACzBrb,KAAK0b,MAAQ1b,KAAK0b,OAAS,IAC3B1b,KAAK+kD,YAA0BxjD,IAAhBvB,KAAK+kD,OAAwB/kD,KAAK+kD,OAAS,GAC1D/kD,KAAKglD,SAA2B,IAAjBhlD,KAAKglD,QACpBhlD,KAAK2F,QAAU,CACd+V,MAAO1b,KAAK0b,MACZqpC,OAAQ/kD,KAAK+kD,OACbC,QAAShlD,KAAKglD,QACdC,eAAgB,EAChBC,gBAAiB,EACjB1qB,IAAK,EACL2qB,KAAM,CAAC,IAERnlD,KAAKolD,YAAc,GACnBplD,KAAKqlD,gBAAkB,GACvBrlD,KAAKslD,WAAa,GAClBtlD,KAAK66C,OAAS,IAAI3lC,EAAAA,gBAAgB,IAClClV,KAAKulD,UACHhzC,KAAKkE,EAAAA,UAAUzW,KAAK0W,eACpBX,WAAU,SAAAyvC,QzGmsZZ9/C,EyG9rZD8pB,UAAA,SAAU7Y,GACT,IAAM0c,EAAU1mB,EAAAA,WAAW3M,MAGrBw/B,EAFSnM,EAAQj0B,OAEFiB,QAAQL,KAAK6kD,gBAAiBxxB,EAAQmL,eAAgBx+B,OAAS,GACpFA,KAAKqb,KAAOrb,KAAKqb,MAAQ,EACzBrb,KAAK0b,MAAQ1b,KAAK0b,OAAS,IAC3B1b,KAAK+kD,YAA0BxjD,IAAhBvB,KAAK+kD,OAAwB/kD,KAAK+kD,OAAS,GAC1D/kD,KAAK2F,QAAQ+V,MAAQ1b,KAAK0b,MAC1B1b,KAAKylD,YAAW,GAChBzlD,KAAK66C,OAAO5mC,KAAKurB,IzGisZjB95B,EyG7rZD6/C,QAAA,WAAU,IAAAthD,EAAAjE,KACT,OAAO+D,EAAAA,MAAM/D,KAAK0lD,UAAW1lD,KAAK8zC,UAAW9zC,KAAK66C,OAAOtoC,KACxDyI,EAAAA,yBACEzI,KACFlD,EAAAA,KAAI,SAAAujB,GAEH,OADqB3uB,EAAK0hD,qBzGksZ5BjgD,EyG5rZDigD,cAAA,WAAgB,IAAAnxC,EAAAxU,KACT2F,EAAU3F,KAAK2F,QACf65B,EAAQx/B,KAAK66C,OAAOviC,WAEpBstC,EAAQpmB,EAAM59B,OACpB5B,KAAKmsB,UAAUoO,SAAW,WAK1B,IAJA,IAAIsrB,EAAgB,EACdnqC,EAAQ1b,KAAK8lD,WACbf,EAAS/kD,KAAK+lD,UAAUrqC,GACxB8pC,EAAe,GACZ7jD,EAAI,EAAGqkD,EAAMxmB,EAAM59B,OAAQD,EAAIqkD,EAAKrkD,IAAK,CACjD,IACiB64B,EADXiF,EAAOD,EAAM79B,GACfskD,OAAG,EAAEtqC,OAAM,EAAO2c,OAAI,EAAE4tB,OAAM,EAC9BC,EAAOnmD,KAAKolD,YAAYzjD,GAY5B,GAXIwkD,GACHF,EAAME,EAAKF,IACXtqC,EAASwqC,EAAKxqC,OACd2c,EAAO6tB,EAAK7tB,OAIZ2tB,EAAMjmD,KAAKomD,SACXzqC,EAAS3b,KAAKqmD,UAAU3qC,EAAO+jB,IAEhCjF,EAAM70B,EAAQw/C,KAAKc,GACfjmD,KAAKsmD,UAAU9rB,EAAM70B,EAAQ60B,IAAKA,EAAM7e,EAAShW,EAAQ60B,IAAK70B,EAAQ60B,IAAK70B,EAAQ60B,IAAM70B,EAAQu/C,iBAAkB,CACjHiB,IACJ7tB,EAAOt4B,KAAKumD,QAAQN,EAAKvqC,EAAOqpC,IAEjC,IAAMr4C,EAAO1M,KAAKwmD,WAAW7kD,EAAGA,EAAG89B,EAAMmmB,GACzCl5C,EAAK2rB,MAAMkC,SAAW,WACtB7tB,EAAK2rB,MAAMmC,IAAMA,EAAM,KACvB9tB,EAAK2rB,MAAMC,KAAOA,EAAO,KACzB5rB,EAAK2rB,MAAM3c,MAAQA,EAAQ,KACvBC,IAAWjP,EAAK+5C,eACnB9qC,EAASjP,EAAK+5C,cAEfP,EAAS1rB,EAAM7e,EAAShW,EAAQo/C,OAChCc,EAAgBrrC,KAAKC,IAAIorC,EAAeK,GACxCvgD,EAAQw/C,KAAKc,GAAOC,EACfC,GAGJA,EAAKxqC,OAASA,EACdwqC,EAAKD,OAASA,GAHdlmD,KAAKolD,YAAYzjD,GAAK,CAAEskD,IAAAA,EAAKvqC,MAAAA,EAAOC,OAAAA,EAAQ2c,KAAAA,EAAMkC,IAAAA,EAAK0rB,OAAAA,GAKxDV,EAAariD,KAAKs8B,QAElBz/B,KAAK0mD,WAAW/kD,GAChBukD,EAAS1rB,EAAM7e,EAAShW,EAAQo/C,OAChCp/C,EAAQw/C,KAAKc,GAAOC,EACpBL,EAAgBrrC,KAAKC,IAAIorC,EAAeK,GAI1C,IADA,IAAIS,EAAcnnB,EAAM59B,OACjB+kD,EAAc3mD,KAAKslD,WAAW1jD,QACpC5B,KAAK0mD,WAAWC,GAChBA,IAED3mD,KAAKslD,WAAW1jD,OAAS49B,EAAM59B,OAC/B,IAAMglD,EAAkB5mD,KAAKmsB,UAAU2O,WACvC,GAAI96B,KAAKglD,SAAYa,EAAgBe,EAAgBH,aAAe,EAAI,CACvE,IAAMI,EAAOD,EAAgBH,aAAe,EAAIZ,EAChDrmB,EAAMt7B,SAAQ,SAACu7B,EAAM99B,GACpB,IAAoC,IAAhC6jD,EAAatgD,QAAQu6B,GAAc,CACtC,IAAM0mB,EAAO3xC,EAAK4wC,YAAYzjD,GACjB6S,EAAKgyC,WAAW7kD,EAAGA,EAAG89B,EAAMmmB,GACpCvtB,MAAMmC,IAAO2rB,EAAK3rB,IAAMqsB,EAAQ,SAGvC7mD,KAAKmsB,UAAUkM,MAAM1c,OAAYirC,EAAgBH,aAAe,EAAhE,UAEAzmD,KAAKmsB,UAAUkM,MAAM1c,OAAYkqC,EAAjC,KAED,OAAOL,GzG41ZP9/C,EyGxtZDohD,QAAA,WACC,IAAMnhD,EAAU3F,KAAK2F,QACfw/C,EAAO3qC,KAAKoK,OAAOjf,EAAQs/C,eAAiBt/C,EAAQo/C,SAAWp/C,EAAQ+V,MAAQ/V,EAAQo/C,UAAY,EACzG,OAAO,IAAI5gD,MAAMghD,GAAM3tB,KAAK,IzG2tZ5B9xB,EyGxtZD0gD,OAAA,WACC,IACIH,EADEtgD,EAAU3F,KAAK2F,QAErB,OAAQ3F,KAAKqb,MACZ,KAAKopC,GACL,KAAKA,GACL,KAAKA,GACJwB,EAAMtgD,EAAQw/C,KAAKj1C,QAAO,SAACC,EAAGC,EAAGzO,EAAGgZ,GACnC,OAAOvK,EAAIuK,EAAExK,GAAKxO,EAAIwO,IACpB,GACH,MACD,KAAKs0C,GACL,QACCwB,EAAM,EAER,OAAOA,GzG8tZPvgD,EyG3tZDogD,SAAA,WACC,IACIpqC,EADE/V,EAAU3F,KAAK2F,QAErB,OAAQ3F,KAAKqb,MACZ,KAAKopC,GACL,KAAKA,GACJ/oC,EAAQ/V,EAAQ+V,MAChB,MACD,KAAK+oC,GACJ/oC,GAAS/V,EAAQs/C,gBAAkBt/C,EAAQw/C,KAAKvjD,OAAS,GAAK+D,EAAQo/C,QAAUp/C,EAAQw/C,KAAKvjD,OAC7F,MACD,KAAK6iD,GACL,QACC/oC,EAAQ/V,EAAQs/C,eAElB,OAAOvpC,GzGkuZPhW,EyG/tZD2gD,UAAA,SAAU3qC,EAAO+jB,GAChB,IACI9jB,EADEhW,EAAU3F,KAAK2F,QAErB,OAAQ3F,KAAKqb,MACZ,KAAKopC,GACL,KAAKA,GACL,KAAKA,GACJ9oC,EAAShW,EAAQ+V,MACjB,MACD,KAAK+oC,GACL,QACC9oC,EAAS,GAEX,OAAOA,GzGquZPjW,EyGluZDqgD,UAAA,SAAUrqC,GACT,IACIqpC,EADEp/C,EAAU3F,KAAK2F,QAErB,OAAQ3F,KAAKqb,MACZ,KAAKopC,GACL,KAAKA,GACJM,EAASp/C,EAAQo/C,OACjB,MACD,KAAKN,GACJM,GAAUp/C,EAAQs/C,eAAiBt/C,EAAQw/C,KAAKvjD,OAAS8Z,IAAU/V,EAAQw/C,KAAKvjD,OAAS,GACzF,MACD,KAAK6iD,GACL,QACCM,EAAS,EAEX,OAAOA,GzGyuZPr/C,EyGtuZD6gD,QAAA,SAAQr9C,EAAOwS,EAAOqpC,GACrB,IACIzsB,EADE3yB,EAAU3F,KAAK2F,QAErB,OAAQ3F,KAAKqb,MACZ,KAAKopC,GACL,KAAKA,GACJnsB,EAAOpvB,GAASwS,EAAQqpC,GACxB,MACD,KAAKN,GACJnsB,GAAQ3yB,EAAQs/C,eAAiBt/C,EAAQw/C,KAAKvjD,QAAU8Z,EAAQqpC,GAAUA,GAAU,EAAI77C,GAASwS,EAAQqpC,GACzG,MACD,KAAKN,GACL,QACCnsB,EAAO,EAET,OAAOA,GzG6uZP5yB,EyG1uZD8gD,WAAA,SAAWt9C,EAAOvH,EAAGf,EAAOglD,GAC3B,OAAI5lD,KAAKslD,WAAWp8C,GACZlJ,KAAK+mD,WAAW79C,EAAOvH,EAAGf,GAE1BZ,KAAKgnD,WAAW99C,EAAOvH,EAAGf,EAAOglD,IzG8uZzClgD,EyG1uZDshD,WAAA,SAAW99C,EAAOvH,EAAGf,EAAOglD,GAC3B,IAAMqB,EAAajnD,KAAKuJ,SAAS29C,WAAU,UACpCD,EAAWrE,SAClB5iD,KAAKmsB,UAAU1Q,YAAYwrC,GAC3BjnD,KAAKslD,WAAWp8C,GAAS+9C,EACzB,IAAM5zB,EAAU1mB,EAAAA,WAAW3M,MACrBZ,EAASi0B,EAAQj0B,OACjBulD,EAAS3kD,KAAK2kD,OACdxjD,EAAO,CAACwjD,EAAOlkD,IAAKkB,EAAGgjD,EAAO/jD,MAAOA,EAAOe,EAAGikD,EAAOvyB,EAAQmL,gBAC9D2oB,EAAW/nD,EAAOgoD,aAAaH,EAAY/C,GAAa7wB,EAAQpmB,SAAUomB,EAAQmL,eAAgBr9B,GAClGkmD,EAAiB16C,EAAAA,WAAWw6C,GAGlC,OAFA/nD,EAAOi/B,QAAQ4oB,EAAYI,EAAeF,UAC1CnnD,KAAKqlD,gBAAgBn8C,GAASi+C,EACvBF,GzG6uZPvhD,EyG1uZDqhD,WAAA,SAAW79C,EAAOvH,EAAGf,GACpB,IAAMumD,EAAWnnD,KAAKqlD,gBAAgBn8C,GAChCy7C,EAAS3kD,KAAK2kD,OAOpB,OANIwC,EAASxC,EAAOlkD,OAASkB,IAC5BwlD,EAASxC,EAAOlkD,KAAOkB,EACvBwlD,EAASxC,EAAO/jD,OAASA,EACzBumD,EAAS5xC,eAGHvV,KAAKslD,WAAWp8C,IzG+uZvBxD,EyG5uZDghD,WAAA,SAAWx9C,GACVlJ,KAAKqlD,gBAAgBn8C,QAAS3H,EAC9B,IAAMmL,EAAO1M,KAAKslD,WAAWp8C,GAC7B,GAAIwD,EAAM,CACT,IACMtN,EADUuN,EAAAA,WAAW3M,MACJZ,OACvBsN,EAAKouB,WAAWC,YAAYruB,GAC5BtN,EAAOiL,OAAOqC,GAGf,OADA1M,KAAKslD,WAAWp8C,QAAS3H,EAClBmL,GzGivZPhH,EyG9uZD4gD,UAAA,SAAUgB,EAAMC,EAASC,EAAMC,GAC9B,OAAOD,EAAOD,GAAWE,EAAUH,GzGivZnC5hD,EyG9uZDouC,QAAA,WAAU,IAAAn/B,EAAA3U,KACT,OAAO0qC,EAAAA,UAAUjmC,OAAQ,UAAU8N,KAClC0mC,EAAAA,UAAU,KACV4D,EAAAA,UAAU,MACVpoC,EAAAA,KAAI,WAAA,OAAME,EAAK8wC,YAAW,QzGkvZ3B//C,EyG9uZDggD,QAAA,WAAU,IAAA7wC,EAAA7U,KACD0M,EAASC,EAAAA,WAAW3M,MAApB0M,KAER,OAAIA,EAAKouB,YAA8D,SAAhD4sB,iBAAiBh7C,EAAKouB,YAAY6sB,UACjDjd,EAAAA,UAAUh+B,EAAKouB,WAAY,UAAUvoB,KAAKkC,EAAAA,KAAI,WACpDI,EAAK4wC,iBAGC/a,EAAAA,UAAUjmC,OAAQ,UAAU8N,KAAKkC,EAAAA,KAAI,WAAA,OAAMI,EAAK4wC,kBzGwvZxD//C,EyGpvZD+/C,WAAA,SAAWvuC,GACV,IAAMivC,EAAOnmD,KAAKmsB,UAAUy7B,wBACtBjiD,EAAU3F,KAAK2F,QACrBA,EAAQ60B,IAAM2rB,EAAK3rB,IACnB70B,EAAQs/C,eAAiBkB,EAAKzqC,MAC9B/V,EAAQu/C,gBAAkBiB,EAAKxqC,OAC/BhW,EAAQw/C,KAAOnlD,KAAK8mD,UAChB5vC,IACHlX,KAAKolD,YAAc,KzG0vZpB1/C,EyGtvZDk/C,oBAAA,SAAoBja,GACnB,GAAmB,OAAfA,EACH,MAAM,IAAIkT,MAAM,mBAEjB,IAA2C,IAAvClT,EAAWkd,OAAO3iD,QAAQ,UAAyD,IAAvCylC,EAAWkd,OAAO3iD,QAAQ,QACzE,MAAM,IAAI24C,MAAM,mBAEjB,IAAMiK,EAAcnd,EAClBrlC,MAAM,KACN+J,KAAI,SAAAC,GAAC,OAAIA,EAAEu4C,UACX7kD,QAAO,SAAAsM,GAAC,MAAU,KAANA,KACRy4C,EAAqBD,EAAY,GAAGxiD,MAAM,QAAQ+J,KAAI,SAAAC,GAAC,OAAIA,EAAEu4C,UAC/DjnD,EAAQmnD,EAAmB,GAAG3hD,QAAQ,YAAa,IACjD0+C,EAAWiD,EAAmB,GAChCtnD,EAAM,QACJunD,EAAkBpnD,EAAM8jB,MAAM,uBAKpC,GAJIsjC,IACHvnD,EAAMunD,EAAgB,GACtBpnD,EAAQonD,EAAgB,IAErBF,EAAYlmD,OAAS,EAAG,CAC3B,IAAMqmD,EAAmBH,EAAY,GAAGxiD,MAAM,0BAA0B+J,KAAI,SAAAC,GAAC,OAAIA,EAAEu4C,UACnD,IAA5BI,EAAiBrmD,SACpBnB,EAAMwnD,EAAiB,IAGzB,MAAO,CAAExnD,IAAAA,EAAKG,MAAAA,EAAOkkD,SAAAA,IzGwwZdJ,EyGhuaYA,CAAyB5B,EAAAA,WA4d9C4B,GAAiB13C,KAAO,CACvBC,SAAU,aACViE,OAAQ,CAAC,OAAQ,QAAS,SAAU,YCverC,IAAIg3C,GAAa,EAEIC,GAAAA,W1G+uanB,SAASA,KAkDT,OA/CAA,E0GntaMC,cAAP,WAAuB,IAAAnkD,EAAAjE,KAChBw/B,EAAQv9B,OAAOY,KAAK7C,KAAKw/B,OAAOnwB,KAAI,SAAA5O,GAAG,OAAIwD,EAAKu7B,MAAM/+B,MACtDo6C,EAASrb,EAAM59B,OAASkY,EAAAA,cAAc0lB,GAASprB,EAAAA,GAAGorB,GACxDx/B,KAAKqoD,UAAUp0C,KAAK4mC,I1G0tapBsN,E0GvtaMG,OAAP,WACC,IAAMC,IAAQL,GAGd,OAFAloD,KAAKw/B,MAAM+oB,GAAO,IAAIrzC,EAAAA,gBAAgB,CAAEszC,OAAQ,EAAG5C,MAAO,IAC1D5lD,KAAKooD,gBACEG,G1G6taPJ,E0G1taMM,YAAP,SAAmBF,EAAKC,EAAQ5C,GAAW,IAAApxC,EAAAxU,UAAA,IAAX4lD,IAAAA,EAAQ,GACvC,IAAMnmB,EAAOz/B,KAAKw/B,MAAM+oB,GACpB9oB,GACHA,EAAKxrB,KAAK,CAAEu0C,OAAAA,EAAQ5C,MAAAA,IAEjB4C,GAAU5C,GACb9iC,YAAW,kBACHtO,EAAKgrB,MAAM+oB,GAClB/zC,EAAK4zC,kBACH,KAEJpoD,KAAKooD,iB1G0uaED,E0GjyaYA,G1GoyarB3lD,E0GpyaqB2lD,GAAAA,WAEF,CAAEvnD,MAAO,EAAG4nD,OAAQ,EAAG5C,MAAO,EAAGvB,MAAO,EAAG94C,MAAO,K1G0yarE/I,E0G5yaqB2lD,GAAAA,QAIL,I1G0yahB3lD,E0G9yaqB2lD,GAAAA,YAOD,IAAIjwC,EAAAA,cAAc,GAAG3F,KACvCm2C,EAAAA,YACAr5C,EAAAA,KAAI,WACH,IAAMmwB,EAAQv9B,OAAOY,KAVHslD,GAUa3oB,OAAOnwB,KAAI,SAAA5O,GAAG,OAV3B0nD,GAUoC3oB,MAAM/+B,MACtDu5C,EAAWxa,EAAMtvB,QAAO,SAAC8pC,EAAU2O,EAAShnD,EAAG69B,GACpD,IAAMC,EAAOkpB,EAAQrwC,WACfkwC,EAAS/oB,EAAK+oB,QAAU,EACxB5C,EAAQnmB,EAAKmmB,OAAS,EACtBhlD,EAAQ4nD,EAAS5C,EAIvB,OAHA5L,EAASp5C,OAASA,EAClBo5C,EAASwO,QAAUA,EACnBxO,EAAS4L,OAASA,EACX5L,IACL,CAAEp5C,MAAO,EAAG4nD,OAAQ,EAAG5C,MAAO,IAOjC,OANA5L,EAASqK,MAAQ7kB,EAAM59B,OACnB49B,EAAM59B,SACTo4C,EAASp5C,OAASo5C,EAASqK,OAE5BrK,EAASzuC,MAAWiP,KAAKouC,MAAuB,IAAjB5O,EAASp5C,OAAxC,IAzBkBunD,GA0BbnO,SAAWA,EACTA,OApBU,ICHP6O,GAAb,WAAA,SAAAA,KAAA,OAAAA,EAoDQC,KAAP,SAAYrpB,EAAM8F,EAAU7sB,GAE3B,GADA1Y,KAAKoI,MAAQ,KACRq3B,EAAKU,MAGV,OAAIV,EAAKU,MAAM7vB,KAAKb,OAASy4B,GAAUG,gBAAgB54B,KAC/CzP,KAAK+oD,8BAA8BxjB,EAAU7sB,IACL,IAArC+mB,EAAKU,MAAMC,KAAKl7B,QAAQ,UAAwD,IAAtCu6B,EAAKU,MAAMC,KAAKl7B,QAAQ,SACrElF,KAAKgpD,oBAAoBj+C,EAAY1E,QAAQo5B,EAAKU,MAAMW,QAASrB,EAAKU,MAAMC,KAAMmF,EAAU7sB,IACnD,IAAtC+mB,EAAKU,MAAMC,KAAKl7B,QAAQ,SAC3BlF,KAAKipD,wBAAwBxpB,EAAKU,MAAMC,KAAMmF,EAAU7sB,IAChB,IAArC+mB,EAAKU,MAAMC,KAAKl7B,QAAQ,QAC3BlF,KAAKkpD,mBAAmBn+C,EAAY1E,QAAQo5B,EAAKU,MAAMW,QAASrB,EAAKU,MAAMC,KAAMmF,EAAU7sB,GAE3F1Y,KAAKmpD,2BAA2Bp+C,EAAY1E,QAAQo5B,EAAKU,MAAMW,QAASrB,EAAKU,MAAMC,KAAMmF,EAAU7sB,IAlE7GmwC,EAsEQO,eAAP,SAAsBtoB,EAAQV,EAAMmF,EAAU7sB,GAC7C,IAAM2wC,EAAiB,IAAIvpD,MAAMwpD,eAAe/jB,GAChD8jB,EAAeE,+BACf,IAAMC,EAAcrB,GAAcG,SAE5BmB,EAAS,IAAI3pD,MAAM4pD,cAYzB,OAXAD,EAAOE,QAAQ7oB,GAAQgoB,KAAK1oB,GAAM,SAACh2B,GAClC,IAAMw/C,EAASP,EAAeQ,oBAAoBz/C,GAASA,QAC3Di/C,EAAeh0B,UACS,mBAAb3c,GACVA,EAASkxC,EAAQx/C,GAAS,GAE3B+9C,GAAcM,YAAYe,EAAa,MACrC,SAACM,GACHrjD,QAAQC,IAAIojD,EAAQtB,OAAQsB,EAAQlE,OACpCuC,GAAcM,YAAYe,EAAaM,EAAQtB,OAAQsB,EAAQlE,UAEzD6D,GAvFTZ,EA0FQM,2BAAP,SAAkCroB,EAAQV,EAAMmF,EAAU7sB,GACzD,IAAM2wC,EAAiB,IAAIvpD,MAAMwpD,eAAe/jB,GAChD8jB,EAAeE,+BACf,IAAMC,EAAcrB,GAAcG,SAC5BngD,EAAQ,IAAIggC,MAClBuY,GAAa5iB,QAAQgD,EAASV,GAAM7tB,KACnCkC,EAAAA,KAAI,SAAAkE,GACCA,EAAMrI,OAASmwC,IAClB0H,GAAcM,YAAYe,EAAa7wC,EAAMnH,KAAKg3C,OAAQ7vC,EAAMnH,KAAKo0C,UAGvE5iD,EAAAA,QAAO,SAAA2V,GAAK,OAAIA,EAAMrI,OAASmwC,MAC/BpsC,EAAAA,WAAU,SAAAsE,GACT,IAAMmwC,EAAOpe,EAAAA,UAAUviC,EAAO,QAG9B,OAFAA,EAAMwd,YAAc,YACpBxd,EAAM2T,IAAMnD,EAAMnH,KACXs3C,KAER7H,EAAAA,WAAU,SAAAtoC,GAAK,OAAIA,EAAMrI,OAASmwC,MAA4B,IAC7D1qC,WAAU,SAAA4C,GACXoD,IAAIguC,gBAAgBpxC,EAAMnH,MAC1B,IAAMpH,EAAU,IAAItK,MAAMu/B,QAAQl3B,GAC5ByhD,EAASP,EAAeQ,oBAAoBz/C,GAASA,QAC3Di/C,EAAeh0B,UACS,mBAAb3c,GACVA,EAASkxC,EAAQx/C,GAAS,GAE3B+9C,GAAcM,YAAYe,EAAa,OArH1CX,EAyHQK,mBAAP,SAA0BpoB,EAAQV,EAAMmF,EAAU7sB,GACjD,IAAM2wC,EAAiB,IAAIvpD,MAAMwpD,eAAe/jB,GAChD8jB,EAAeE,+BACf,IAAMC,EAAcrB,GAAcG,SAC5BmB,EAAS,IAAI3pD,MAAMkqD,WAgBzB,OAfAP,EACEQ,YAAYnqD,MAAMoqD,kBAElBP,QAAQ7oB,GACRgoB,KAAK1oB,GAAM,SAACh2B,GACZ,IAAMw/C,EAASP,EAAeQ,oBAAoBz/C,GAASA,QAE3Di/C,EAAeh0B,UACS,mBAAb3c,GACVA,EAASkxC,EAAQx/C,GAAS,GAE3B+9C,GAAcM,YAAYe,EAAa,MACrC,SAACM,GACH3B,GAAcM,YAAYe,EAAaM,EAAQtB,OAAQsB,EAAQlE,UAE1D6D,GA7ITZ,EAgJQI,wBAAP,SAA+BntC,EAAKypB,EAAU7sB,GAC7C,IAAM8wC,EAAcrB,GAAcG,SAC5BlgD,EAAQvD,SAAS0W,cAAc,SA4BrC,GAJAnT,EAAM6T,UAAY,YAvBA,WACjB7T,EAAM6T,UAAY,KAClB,IAAM7R,EAAU,IAAItK,MAAMqqD,aAAa/hD,GACvCgC,EAAQggD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UACxBpgD,EAAQqH,OAAS3R,MAAM2qD,UACvBrgD,EAAQsgD,aAAc,EAEtB,IAAMC,EAAmB,IAAI7qD,MAAM8qD,sBAAsB,KAAM,CAC9DC,iBAAiB,EAEjBT,UAAWtqD,MAAMuqD,aACjBC,UAAWxqD,MAAMuqD,aACjBE,QAASzqD,MAAM0qD,UACf/4C,OAAQ3R,MAAM2qD,YACZK,2BAA2BvlB,EAAUn7B,GAEhB,mBAAbsO,GACVA,EAASiyC,EAAiBvgD,QAASA,GAAS,GAE7C+9C,GAAcM,YAAYe,EAAa,GAIvCuB,IAEGllC,IAAIm+B,cAAe,CACtB,IAAIp+B,EAAM,IAAIC,IAEdD,EAAIE,YAAY1d,GAChBwd,EAAInN,GAAGoN,IAAIE,OAAOC,gBAAgB,WACjCJ,EAAIK,WAAWnK,GACf8J,EAAInN,GAAGoN,IAAIE,OAAOG,iBAAiB,SAACvN,EAAOnH,GAE1CpJ,EAAMmU,eAtLXssC,EA4LQG,oBAAP,SAA2BloB,EAAQV,EAAMmF,EAAU7sB,GAAU,IAAAzU,EAAAjE,KACtDwpD,EAAcrB,GAAcG,SAElCtoD,KAAKoI,OAAQ,EACb,IAAMA,EAAQpI,KAAKoI,MAyBnBA,EAAM6T,UAAY,YAxBA,WACjB7T,EAAM6T,UAAY,KAClB,IAAM7R,EAAU,IAAItK,MAAMqqD,aAAa/hD,GACvCgC,EAAQggD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UACxBpgD,EAAQqH,OAAS3R,MAAM2qD,UACvBrgD,EAAQsgD,aAAc,EAEtB,IAAMC,EAAmB1mD,EAAK0mD,iBAAmB,IAAI7qD,MAAM8qD,sBAAsB,KAAM,CACtFC,iBAAiB,EAEjBT,UAAWtqD,MAAMuqD,aACjBC,UAAWxqD,MAAMuqD,aACjBE,QAASzqD,MAAM0qD,UACf/4C,OAAQ3R,MAAM2qD,YACZK,2BAA2BvlB,EAAUn7B,GAEhB,mBAAbsO,GACVA,EAASiyC,EAAiBvgD,QAASA,GAAS,GAE7C+9C,GAAcM,YAAYe,EAAa,GAKvCuB,IAED3iD,EAAM0T,IAAMglB,EAASV,EACrBh4B,EAAM0gD,OACN1gD,EAAMmU,OAAOvb,MAAK,eAGf,SAAAH,GACF4F,QAAQC,IAAI,8CAA+C7F,OAnO9DgoD,EAwOQE,8BAAP,SAAqCxjB,EAAU7sB,GAAU,IAAAlE,EAAAxU,KAqCxD4Z,EAAcoD,wBAAwBzK,KACrCuD,EAAAA,SACCC,WAAU,SAAAkH,GAAiB,OAtCD,SAACA,GAE5B,IAAMxb,EAAM,WAAcwb,EACpB7U,EAAQvD,SAASC,cAAiBrD,EAA1B,UACd,GAAK2G,EAAL,CAGA,IAAM2iD,EAAY,WACjB,IAAM3gD,EAAUoK,EAAKpK,QAAU,IAAItK,MAAMqqD,aAAa/hD,GACtDgC,EAAQggD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UACxBpgD,EAAQqH,OAAS3R,MAAM2qD,UACvBrgD,EAAQsgD,aAAc,EACtB,IAAMC,EAAmBn2C,EAAKm2C,iBAAmB,IAAI7qD,MAAM8qD,sBAAsB,KAAM,CACtFC,iBAAiB,EAEjBT,UAAWtqD,MAAMuqD,aACjBC,UAAWxqD,MAAMuqD,aACjBE,QAASzqD,MAAM0qD,UACf/4C,OAAQ3R,MAAM2qD,YACZK,2BAA2BvlB,EAAUn7B,GAEhB,mBAAbsO,GACVA,EAASiyC,EAAiBvgD,QAASA,GAAS,IAG9ChC,EAAMud,YAAc,YAChBvd,EAAMqmC,YAAcrmC,EAAM4iD,iBAC7BD,IAEA3iD,EAAM6T,UAAY,WACjB8uC,MAM8BE,CAAoBhuC,OA/QvD9a,EAAA0mD,EAAA,KAAA,CAAA,CAAApoD,IAAA,QAAA8D,IAAA,WAGE,OAAOvE,KAAK63B,QAHdrxB,IAAA,SAMkB4B,GAShB,GARIpI,KAAK63B,SACR73B,KAAK63B,OAAOqzB,OAAQ,EACpBlrD,KAAK63B,OAAO+rB,QACR5jD,KAAK63B,OAAOiD,YACf96B,KAAK63B,OAAOiD,WAAWC,YAAY/6B,KAAK63B,QAEzC73B,KAAK63B,OAAS,MAEXzvB,EAAO,CACV,IAAMA,EAAQpI,KAAK63B,OAAShzB,SAAS0W,cAAc,SACnDnT,EAAM+iD,MAAO,EAEb/iD,EAAMgjD,aAAc,EACpBhjD,EAAMud,YAAc,eApBvB,CAAAllB,IAAA,QAAA8D,IAAA,WA0BE,OAAOvE,KAAKqrD,QA1Bd7kD,IAAA,SA6BkB0kD,GAChBlrD,KAAKqrD,OAASH,EAEVlrD,KAAKoI,QACRpI,KAAKoI,MAAM8iD,OAAkB,IAAVA,KAjCtB,CAAAzqD,IAAA,mBAAA+F,IAAA,SAqC6BmkD,GACvB3qD,KAAKsrD,oBACRtrD,KAAKsrD,kBAAkBlhD,QAAQirB,UAC/Br1B,KAAKsrD,kBAAkBj2B,WAExBr1B,KAAKsrD,kBAAoBX,IA1C3B,CAAAlqD,IAAA,UAAA+F,IAAA,SA6CoB4D,GACdpK,KAAKurD,UACRvrD,KAAKurD,SAASl2B,UAEfr1B,KAAKurD,SAAWnhD,MAjDlBy+C,EAAA,GCRqB2C,GAAAA,SAAAA,GAYpB,SAAAA,EAAYC,EAAUC,GAAU,IAAAznD,EAAA,OAC/BwnD,EAAWA,GAAY,IAAI3rD,MAAM6rD,kBAAkB,EAAG,EAAG,GACzDD,EAAWA,GAAY,IAAI5rD,MAAM8rD,kBAAkB,CAClDC,MAAO,YAIR5nD,EAAA6nD,EAAAjoD,KAAA7D,KAAMyrD,EAAUC,IAAhB1rD,MACK+rD,SAAU,EARgB9nD,E5Gknb/Bb,EAAeooD,EAAeM,GAE9B3pD,EAAaqpD,EAAe,CAAC,CAC3B/qD,IAAK,UACL8D,IAAK,W4G/nbP,OAAOvE,KAAKgsD,U5GkobVxlD,IAAK,S4G/nbIulD,GAEX/rD,KAAKgsD,SAAWD,EAChB/rD,KAAKw9C,SAASx6C,QAAO,SAAAsM,GAAC,OAAIA,EAAE28C,iBAAiB,cAAY/nD,SAAQ,SAAAoL,GAAC,OAAIA,EAAEy8C,QAAUA,S5GqpblF,IAAIrmD,EAAS8lD,EAAcjpD,UAU3B,OARAmD,E4GzobDwmD,OAAA,WACClsD,KAAK+rD,SAAU,G5G4obfrmD,E4GzobDymD,SAAA,WACCnsD,KAAK+rD,SAAU,G5G4obRP,E4GxqbYA,CAAsB1rD,MAAMssD,MCC5BC,GAAAA,SAAAA,GAEpB,SAAAA,EAAYZ,EAAUC,GAAU,IAAAznD,EAAA,OAC/BwnD,EAAWA,GAAY,IAAI3rD,MAAM6rD,kBAAkB,EAAG,EAAG,GACzDD,EAAWA,GAAY,IAAI5rD,MAAM8rD,kBAAkB,CAClDC,MAAO,YAIR5nD,EAAAqoD,EAAAzoD,KAAA7D,KAAMyrD,EAAUC,IAAhB1rD,MACKwY,OAAS,GARiBvU,E7Guqb/Bb,EAAeipD,EAAeC,GAgB9B,IAAI5mD,EAAS2mD,EAAc9pD,UA2C3B,OAzCAmD,E6G9qbD+S,GAAA,SAAGnI,EAAMoI,GAAU,IAAAlE,EAAAxU,KACZ2Y,EAAQ3Y,KAAKwY,OAAOlI,GAAQtQ,KAAKwY,OAAOlI,IAAS,GAEvD,OADAqI,EAAMxV,KAAKuV,GACJ,WACNlE,EAAKgE,OAAOlI,GAAQqI,EAAM3V,QAAO,SAAAsM,GAAC,OAAIA,IAAMoJ,O7Gsrb7ChT,E6GlrbDkT,IAAA,SAAItI,EAAMoI,GACT,IAAMC,EAAQ3Y,KAAKwY,OAAOlI,GACtBqI,IACH3Y,KAAKwY,OAAOlI,GAAQqI,EAAM3V,QAAO,SAAAsM,GAAC,OAAIA,IAAMoJ,O7Gyrb7ChT,E6GrrbDoT,KAAA,SAAKxI,EAAMkB,GACV,IAAMmH,EAAQ3Y,KAAKwY,OAAOlI,GACtBqI,GACHA,EAAMzU,SAAQ,SAAAwU,GAEbA,EAASlH,MAGX,IAAMuH,EAAY/Y,KAAKwY,OAAOO,UAC1BA,GACHA,EAAU7U,SAAQ,SAAAwU,GACjBA,EAASpI,EAAMkB,O7G6rbV66C,E6GpubYA,CAAsBb,ICEtBe,GAAAA,aAErBA,GAAY/sB,MAAQ,GACpB+sB,GAAYC,QAGL,SAA4BC,EAAW/W,EAAc/8B,GAAsB,IAAA1U,EAAAjE,UAAA,IAApC01C,IAAAA,GAAO,GAEpD,IAAIgX,GAAQ,EACR1sD,KAAK01C,OAASA,IACjB11C,KAAK01C,KAAOA,EACZ11C,KAAK2sD,MAAO,EACZD,GAAQ,GAET,IAEIjsD,EAAKmsD,EAFHptB,EAAQx/B,KAAKw/B,MAAMx8B,QAAO,SAAAsM,GAAC,OAAKA,EAAEy8C,WAClCc,EAAgBJ,EAAUK,iBAAiBttB,GAE3CutB,EAAO,GACbF,EAAc3oD,SAAQ,SAAC8oD,EAAcrrD,GACpC,IAAMgB,EAASqqD,EAAarqD,OAC5BlC,EAAMkC,EAAOsqD,KACH,IAANtrD,IACCsC,EAAKipD,wBAA0BvqD,GAAU+pD,GAC5CzoD,EAAKipD,sBAAwBvqD,EAC7BiqD,EAAMjqD,GAINA,EAAOqqD,eACNxyC,KAAKub,IAAIpzB,EAAOqqD,aAAaG,MAAM79C,EAAI09C,EAAaG,MAAM79C,GAAK,KAC/DkL,KAAKub,IAAIpzB,EAAOqqD,aAAaG,MAAM7rB,EAAI0rB,EAAaG,MAAM7rB,GAAK,OAGhE3+B,EAAOqqD,aAAeA,EACtBrqD,EAAOmW,KAAK,OAAQnW,KAGtBoqD,EAAKtsD,GAAOusD,KAEgB,IAAzBH,EAAcjrD,SACjB5B,KAAKktD,sBAAwB,MAU9B,OARA1tB,EAAMt7B,SAAQ,SAAAoL,GACbA,EAAE09C,aAAeD,EAAKz9C,EAAE29C,MACxB39C,EAAE89C,KAAQ99C,IAAMrL,EAAKipD,uBAA2B59C,EAAE09C,eAAiB19C,EAAE+9C,aAAeppD,EAAKipD,uBAAyBjpD,EAAKipD,sBAAsBG,WAC7I/9C,EAAEomC,KAAOA,GAAQpmC,EAAE89C,OAASnpD,EAAK0oD,KAC7Br9C,EAAEomC,OACLzxC,EAAK0oD,MAAO,MAGPC,GA/CiCtsC,KAAKisC,IAC9CA,GAAYl3B,QAiDL,SAA4B1yB,GAClC,GAAIA,EAAQ,CACX,IAAMuG,EAAQlJ,KAAKw/B,MAAMt6B,QAAQvC,IAClB,IAAXuG,GACHlJ,KAAKw/B,MAAM7hB,OAAOzU,EAAO,KArDaoX,KAAKisC,IAwD7C,IC7DoBe,GAAAA,SAAAA,GAEpB,SAAAA,EAAY7B,EAAUC,GAAU,IAAAznD,EAAA,OAC/BA,EAAAspD,EAAA1pD,KAAA7D,KAAMyrD,EAAUC,IAAhB1rD,MACKqtD,WAAY,EACjBppD,EAAKupD,OAAQ,EACbvpD,EAAKwpD,OAAQ,EACblB,GAAY/sB,MAAMr8B,KAAlBO,EAAAO,IAL+BA,E/Gm2b/B,OA3DAb,EAAekqD,EAAiBC,GAahCprD,EAAamrD,EAAiB,CAAC,CAC7B7sD,IAAK,oBACL8D,IAAK,W+G9ybP,OAAO,I/GizbJ,CACD9D,IAAK,OACL8D,IAAK,W+G/ybP,OAAOvE,KAAKwtD,O/GkzbVhnD,IAAK,S+GhzbC4mD,GACJptD,KAAKwtD,OAASJ,IACjBptD,KAAKwtD,MAAQJ,EAMTA,EACHptD,KAAK8Y,KAAK,OAAQ9Y,MAElBA,KAAK8Y,KAAK,MAAO9Y,S/GqzbhB,CACDS,IAAK,OACL8D,IAAK,W+GjzbP,OAAOvE,KAAKytD,O/GozbVjnD,IAAK,S+GlzbCkvC,GACRA,EAAOA,GAAQ11C,KAAKotD,KAChBptD,KAAKytD,OAAS/X,IACjB11C,KAAKytD,MAAQ/X,EACTA,EACH11C,KAAK8Y,KAAK,OAAQ9Y,MAElBA,KAAK8Y,KAAK,KAAM9Y,W/G0zbXstD,E+Gr2bYA,CAAwBjB,ICD7C,SAASlC,GAAa/hD,EAAOmiD,EAASmD,EAAOC,EAAOrD,EAAWF,EAAW34C,EAAQnB,EAAMs9C,GACvFvuB,EAAAA,QAAQx7B,KAAK7D,KAAMoI,EAAOmiD,EAASmD,EAAOC,EAAOrD,EAAWF,EAAW34C,EAAQnB,EAAMs9C,GACrF5tD,KAAKyR,YAAoBlQ,IAAXkQ,EAAuBA,EAAS3R,MAAM2qD,UACpDzqD,KAAKoqD,eAA0B7oD,IAAd6oD,EAA0BA,EAAYtqD,MAAMuqD,aAC7DrqD,KAAKsqD,eAA0B/oD,IAAd+oD,EAA0BA,EAAYxqD,MAAMuqD,aAC7DrqD,KAAKuqD,QAAUzqD,MAAM0qD,UACrBxqD,KAAK6qD,iBAAkB,EAGxBV,GAAa5nD,UAAYN,OAAO8D,OAAO9D,OAAOsB,OAAO87B,EAAAA,QAAQ98B,WAAY,CAExEiB,YAAa2mD,GAEb0D,gBAAgB,EAEhBhgD,OAAQ,WACP,IAAIzF,EAAQpI,KAAKmI,MACbC,EAAMqmC,YAAcrmC,EAAM0lD,oBAC7B9tD,KAAK0qD,aAAc,MCdf,IAoEc7rB,GAAAA,WAEpB,SAAAA,IACC7+B,KAAKqrD,QAAS,EACdrrD,KAAK+tD,aAAe51C,EAAaE,OAAOtC,WAAU,SAAAX,GAAK,OAAIyzC,GAAaqC,MAAQ91C,EAAMmyB,eACtFvnC,KAAKguD,MAAQ,EACbhuD,KAAKuD,SjH0zbL,IAAImC,EAASm5B,EAASt8B,UAkOtB,OAhOAmD,EiHzzbDnC,OAAA,WACC,IAAMkoD,EAAW,IAAI3rD,MAAMmuD,qBA9EE,IA8EoC,GAAI,IACrExC,EAAStnB,OAAO,EAAG,EAAG,GACtBsnB,EAASyC,QAAQ1zC,KAAK2zC,IACtB,IAAMzC,EAAW,IAAI5rD,MAAMsuD,eAAe,CAEzCC,YAAY,EACZC,aAlFgB,qMAmFhBC,eAxEkB,w3CAyElBC,SAAU,CACTpkD,QAAS,CAAEkG,KAAM,IAAK1P,MAAO,MAC7B8d,WAAY,CAAE9d,MAAO,IAAId,MAAMuhC,SAC/B2sB,MAAO,CAAEptD,MAAO,GAChB6tD,KAAM,CAAE7tD,OAAO,OASJZ,KAAK0uD,KAAO,IAAIpB,GAAgB7B,EAAUC,IAElDj8C,KAAO,cjH63bZ/J,EiHn0bD8yB,OAAA,SAAO7uB,EAAM47B,EAAU7sB,EAAUi2C,GAChC,IAAMlvB,EAAO91B,aAAgB82B,GAAmB92B,EAAKg2B,MAAMh2B,EAAKo3B,QAAUp3B,EACpE+hD,EAAW1rD,KAAK0uD,KAAKhD,SAE1B1rD,KAAK8oD,KAAKrpB,EAAM8F,GAAU,SAACqkB,EAAQx/C,EAASqkD,GAEpB,mBAAXE,GACVA,EAAOhlD,GAER+hD,EAAS8C,SAASR,MAAMptD,MAAQ,EAChC8qD,EAAShB,aAAc,EACvB5nC,YAAW,WACc,mBAAbpK,GACVA,EAASkxC,EAAQx/C,EAASqkD,KAEzB,SjH41bN/oD,EiHp0bDkpD,UAAA,SAAUnvB,EAAM8F,EAAU7sB,GACzB,IAAMgzC,EAAW1rD,KAAK0uD,KAAKhD,SAC3B1rD,KAAK8oD,KAAKrpB,EAAM8F,GAAU,SAACqkB,EAAQx/C,EAASqkD,GAC3C/C,EAAS8C,SAASR,MAAMptD,MAAQ,EAChC8qD,EAAShB,aAAc,EACC,mBAAbhyC,GACVA,EAASkxC,EAAQx/C,EAASqkD,OjH00b5B/oD,EiHr0bDojD,KAAA,SAAKrpB,EAAM8F,EAAU7sB,GAAU,IAAAzU,EAAAjE,KAC9B,GAAKy/B,EAAKU,MAAV,CAGAngC,KAAK6uD,aAAepvB,EAAKU,MAAMW,OAASrB,EAAKU,MAAMC,KACnD,IAAMsrB,EAAW1rD,KAAK0uD,KAAKhD,SAC3B7C,GAAaC,KAAKrpB,EAAM8F,GAAU,SAACqkB,EAAQx/C,EAASqkD,EAAMrmD,EAAOihD,GAC5D5pB,EAAKU,MAAMW,OAASrB,EAAKU,MAAMC,OAASn8B,EAAK4qD,cAI7CnD,EAAS8C,SAASpkD,QAAQxJ,QAC7B8qD,EAAS8C,SAASpkD,QAAQxJ,MAAMy0B,UAChCq2B,EAAS8C,SAASpkD,QAAQxJ,MAAQ,MAEnCwJ,EAAQggD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UACxBpgD,EAAQsgD,aAAc,EAEtBgB,EAAS8C,SAASpkD,QAAQxJ,MAAQwJ,EAClCshD,EAAS8C,SAAS9vC,WAAW9d,MAAQ,IAAId,MAAMuhC,QAAQj3B,EAAQsR,MAAOtR,EAAQuR,QAC9E+vC,EAAS8C,SAASR,MAAMptD,MAAQ,EAChC8qD,EAAS8C,SAASC,KAAK7tD,MAAQ6tD,EAC/B/C,EAAShB,aAAc,EACC,mBAAbhyC,GACVA,EAASkxC,EAAQx/C,EAASqkD,IAlB1BrkD,EAAQirB,ejHk2bV3vB,EiH30bDopD,UAAA,SAAUhzC,GACT,IAAM1T,EAAQvD,SAAS0W,cAAc,SACrCnT,EAAM0T,IAAMA,EACZ1T,EAAMmsB,OAAS,GACfnsB,EAAM8iD,OAAQ,EACd9iD,EAAMgjD,aAAc,EACpBhjD,EAAMud,YAAc,YACpBvd,EAAMmU,OACNvc,KAAK+uD,SAAS3mD,IjH80bd1C,EiH30bDqpD,SAAA,SAAS3mD,GAAO,IAAAoM,EAAAxU,KAEf,GAAIoI,EAAO,CAeVA,EAAMud,YAAc,YACpBvd,EAAM6T,UAAY,YAfA,WACjB,IAAM7R,EAAU,IAAI+/C,GAAa/hD,GACjCgC,EAAQggD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UACxBpgD,EAAQqH,OAAS3R,MAAM2qD,UACvBrgD,EAAQsgD,aAAc,EACtB,IAAMgB,EAAWl3C,EAAKk6C,KAAKhD,SAC3BA,EAASr8C,IAAMjF,EACfshD,EAAS8C,SAASpkD,QAAQxJ,MAAQwJ,EAClCshD,EAAS8C,SAAS9vC,WAAW9d,MAAQ,IAAId,MAAMuhC,QAAQj3B,EAAQsR,MAAOtR,EAAQuR,QAC9E+vC,EAAShB,aAAc,EAKvBK,MjHo1bFrlD,EiH/0bD2vB,QAAA,WACCr1B,KAAK+tD,aAAa53C,ejHk1bX0oB,EiHlicYA,GC1ERmwB,GAAb,WAEC,SAAAA,EAAY7I,GACXnmD,KAAKsP,EAAI,EACTtP,KAAKshC,EAAI,EACTthC,KAAKw6B,IAAM,EACXx6B,KAAKivD,MAAQ,EACbjvD,KAAKkmD,OAAS,EACdlmD,KAAKs4B,KAAO,EACZt4B,KAAK0b,MAAQ,EACb1b,KAAK2b,OAAS,EACd3b,KAAKwG,IAAI2/C,GAXX6I,EAcQtjB,SAAP,SAAgBya,EAAM7tB,EAAMkC,GAC3B,OAAO2rB,EAAK3rB,KAAOA,GAAOA,GAAO2rB,EAAKD,QAAUC,EAAK7tB,MAAQA,GAAQA,GAAQ6tB,EAAK8I,OAfpFD,EAkBQE,cAAP,SAAqBC,EAAIC,GACxB,QAASA,EAAG92B,KAAO62B,EAAGF,OACrBG,EAAGH,MAAQE,EAAG72B,MACd82B,EAAG50B,IAAM20B,EAAGjJ,QACZkJ,EAAGlJ,OAASiJ,EAAG30B,MAtBlBw0B,EAyBQK,SAAP,SAAgB3iD,GACf,GAAKA,EAAL,CAGA,IAAMy5C,EAAOz5C,EAAK4iD,QAAU5iD,EAAK4iD,MAAQ,IAAIN,GAE7C,IADctiD,EAAK6iD,iBACR3tD,OAEV,OAAOukD,EAER,IAAMqJ,EAAe9iD,EAAKk7C,wBAY1B,OATAzB,EAAK72C,EAAIkgD,EAAal3B,KACtB6tB,EAAK7kB,EAAIkuB,EAAah1B,IACtB2rB,EAAK3rB,IAAMg1B,EAAah1B,IACxB2rB,EAAK7tB,KAAOk3B,EAAal3B,KACzB6tB,EAAKzqC,MAAQ8zC,EAAa9zC,MAC1ByqC,EAAKxqC,OAAS6zC,EAAa7zC,OAC3BwqC,EAAK8I,MAAQ9I,EAAK7tB,KAAO6tB,EAAKzqC,MAC9ByqC,EAAKD,OAASC,EAAK3rB,IAAM2rB,EAAKxqC,OAC9BwqC,EAAKsJ,YACEtJ,IA/CT,IAAAzgD,EAAAspD,EAAAzsD,UAAA,OAAAmD,EAkDCc,IAAA,SAAI2/C,GACCA,IACHlkD,OAAO8D,OAAO/F,KAAMmmD,GACpBnmD,KAAKivD,MAAQjvD,KAAKs4B,KAAOt4B,KAAK0b,MAC9B1b,KAAKkmD,OAASlmD,KAAKw6B,IAAMx6B,KAAK2b,QAE/B3b,KAAKyvD,aAxDP/pD,EA2DCgqD,QAAA,SAAQ9pB,EAAG8c,GACV1iD,KAAK0b,MAAQkqB,EACb5lC,KAAK2b,OAAS+mC,EACd1iD,KAAKivD,MAAQjvD,KAAKs4B,KAAOt4B,KAAK0b,MAC9B1b,KAAKkmD,OAASlmD,KAAKw6B,IAAMx6B,KAAK2b,OAC9B3b,KAAKyvD,aAhEP/pD,EAoEC+pD,UAAA,WACC,IAAME,EAAS3vD,KAAK2vD,SAAW3vD,KAAK2vD,OAAS,IAC7CA,EAAOn1B,IAAMx6B,KAAKw6B,IAAMx6B,KAAK2b,OAAS,EACtCg0C,EAAOr3B,KAAOt4B,KAAKs4B,KAAOt4B,KAAK0b,MAAQ,EACvCi0C,EAAOrgD,EAAIqgD,EAAOr3B,KAClBq3B,EAAOruB,EAAIquB,EAAOn1B,KAzEpB90B,EA4ECgmC,SAAA,SAASpT,EAAMkC,GACd,OAAOw0B,EAAKtjB,SAAS1rC,KAAMs4B,EAAMkC,IA7EnC90B,EAgFC4gD,UAAA,SAAUH,GACT,OAAO6I,EAAKE,cAAclvD,KAAMmmD,IAjFlCzgD,EAoFCsnD,aAAA,SAAa7G,GACZ,IAAM6G,EAAehtD,KAAK4vD,gBAAkB5vD,KAAK4vD,cAAgB,CAChEt3B,KAAM,EACNkC,IAAK,EACL9e,MAAO,EACPC,OAAQ,EACRrM,EAAG,EACHgyB,EAAG,EACHlJ,IAAK,CACJ9oB,GAAI,EACJgyB,GAAI,GAELuuB,OAAQ,SAASA,GAGhB,OAFAA,EAASA,GAAU,GACN7vD,KAAKw6B,IAAMx6B,KAAKmmD,KAAKxqC,OAAS,EAAIk0C,IAAW7vD,KAAK2b,QAGhEm0C,OAAQ,SAASD,GAGhB,OAFAA,EAASA,GAAU,GACN7vD,KAAKw6B,IAAMx6B,KAAKmmD,KAAKxqC,OAAS,EAAIk0C,IAAW7vD,KAAK2b,UAIjEqxC,EAAa10B,KAAOt4B,KAAKs4B,KACzB00B,EAAaxyB,IAAMx6B,KAAKw6B,IACxBwyB,EAAatxC,MAAQ1b,KAAK0b,MAC1BsxC,EAAarxC,OAAS3b,KAAK2b,OAC3BqxC,EAAa19C,EAAItP,KAAKs4B,KAAOt4B,KAAK0b,MAAQ,EAC1CsxC,EAAa1rB,EAAIthC,KAAKw6B,IAAMx6B,KAAK2b,OAAS,EAC1CqxC,EAAa7G,KAAOA,EACpB,IAAM/tB,EAAM40B,EAAa6C,OAAO,GAEhC,OADA7C,EAAa50B,IAAIkJ,EAAIlJ,EACd40B,GApHTgC,EAAA,GCMae,GAAS,CAAC,SAAU,MAAU,MAAU,SAAU,SAAU,UAEpDC,GAAAA,WASpB,SAAAA,EAAYv4C,GACX,IAAMM,EAAW/X,KAAK+X,SAAWN,EAAQM,SACnCoU,EAAYnsB,KAAKmsB,UAAY1U,EAAQ0U,UACrCoZ,EAAWvlC,KAAKulC,SAAW,IAAIzlC,MAAMmwD,cAAc,CACxDC,WAAW,EACXC,OAAO,EACPC,oBAAoB,IAGrB7qB,EAAS8qB,cAAc,EAAU,GACjC9qB,EAAS+qB,cAAc7rD,OAAO8rD,kBAC9BhrB,EAASmqB,QAxBM,IACA,KAwBfnqB,EAASirB,YAAc1wD,MAAM2wD,sBAC7BlrB,EAASmrB,oBAAsB,GAC/BnrB,EAASorB,eAAiB7wD,MAAM8wD,aAChCzkC,EAAU1Q,YAAY8pB,EAASsrB,YAE/B,IAAM9sB,EAAS/jC,KAAK+jC,OAAS,IAAIjkC,MAAMgxD,kBAAkB,GA9B1C,IACA,IA6BqD,IAAM,KAC1E/sB,EAAOxJ,SAAS/zB,IAAI,EAAG,GAAI,IAC3Bu9B,EAAOtiC,OAAS,IAAI3B,MAAMkkC,QAC1BD,EAAO6S,OAAO7S,EAAOtiC,QAErB,IAAM+jC,EAAQxlC,KAAKwlC,MAAQ,IAAI1lC,MAAMixD,MAO/BC,EAAQhxD,KAAKgxD,MAAQ,IAAIlxD,MAAMmxD,WAAW,SAAU,EAAG,KAC7DD,EAAMz2B,SAAS/zB,IAAI,EAAG,GAAI,GAC1Bg/B,EAAMnZ,IAAI2kC,GAEV,IAAME,EAAOlxD,KAAKkxD,KAAOlxD,KAAKmxD,UAC9B3rB,EAAMnZ,IAAI6kC,GAEKlxD,KAAKma,OAASP,EAAcuD,cAAcpF,GnHsrczD5V,EAAa6tD,EAAe,KAAM,CAAC,CACjCvvD,IAAK,eACL8D,IAAK,WmH/tcP,OAHKvE,KAAKoxD,gBACTpxD,KAAKoxD,cAAgB,IAAItxD,MAAMmuD,qBAAqB,GAAK,GAAI,KAEvDjuD,KAAKoxD,kBnHoxcZ,IAAI1rD,EAASsqD,EAAcztD,UA8E3B,OA5EAmD,EmHlucDyrD,QAAA,WACC,IAAM1F,EAAWuE,EAAcqB,aACzBjd,EAASp0C,KAAKo0C,OAASvvC,SAAS0W,cAAc,UACpD64B,EAAO14B,MAAQ,KACf04B,EAAOz4B,OAAS,IACJ3b,KAAKq0C,IAAMr0C,KAAKo0C,OAAOznC,WAAW,MAA9C,IACM0C,EAAMrP,KAAKqP,IAAM,IAAIvP,MAAMwxD,cAAcld,GAC/C/kC,EAAIwgD,OAAOvgD,GAAK,IAChB,IAAMu8C,EAAQkE,GAAO/vD,KAAK+X,SAAWg4C,GAAOnuD,QACtC8pD,EAAW,IAAI5rD,MAAMyxD,qBAAqB,CAC/CliD,IAAKA,EACLw8C,MAAOA,IAGR,OADA7rD,KAAKwxD,MAAM,GACJ,IAAI1xD,MAAMssD,KAAKX,EAAUC,InHquchChmD,EmHlucD+rD,OAAA,WACczxD,KAAK0xD,QAAU1xD,KAAK0xD,MAAQ1xD,KAAK0xD,MAAQ,EAEtD,GAAI1xD,KAAKma,OAAQ,CAChB,IAAME,EAA2C,GAA9Bra,KAAKma,OAAOG,gBAC/Bta,KAAKwxD,MAAMn3C,GAEZ,IAAMkrB,EAAWvlC,KAAKulC,SACrBC,EAAQxlC,KAAKwlC,MACbzB,EAAS/jC,KAAK+jC,OACfwB,EAASksB,OAAOjsB,EAAOzB,InHsucvBr+B,EmHlucDmI,OAAA,SAAO4J,GACN,IAAMssB,EAAStsB,EAAQssB,OACV/jC,KAAKkxD,KACbjtB,WAAWz9B,IAAIu9B,EAAO,GAAIA,EAAO,GAAIA,EAAO,GAAIA,EAAO,KnHwuc5Dr+B,EmHlucD2vB,QAAA,WAEKr1B,KAAK+tD,cACR/tD,KAAK+tD,aAAa53C,enHsucnBzQ,EmHlucD8rD,MAAA,SAAM7vD,GACLA,GAAKA,EAAc,GAAV6Y,KAAK2zC,KAAuB,EAAV3zC,KAAK2zC,IAChC,IAAMwD,EAAoB,GAAdn3C,KAAKo3C,IAAIjwD,GACfkwD,EAAsB,GAAdr3C,KAAKs3C,IAAInwD,GAEjB2/B,EAAI,IACJ+S,EAAMr0C,KAAKq0C,IACjBA,EAAI0d,UAAY,UAChB1d,EAAI2d,SAAS,EAAG,EAAG,KAAM,KACzB3d,EAAI0d,UAAY,QAChB1d,EAAI4d,YACJ5d,EAAI6C,IAAI5nC,IAAQgyB,IAAQ,EAAG,EAAG,EAAI9mB,KAAK2zC,IACvC9Z,EAAI6C,IAAI5nC,IAAQgyB,IAAQ,EAAG,EAAG,EAAI9mB,KAAK2zC,IACvC9Z,EAAI6d,YACJ7d,EAAI7c,OACJ6c,EAAI4d,YAKJ5d,EAAI8d,OAAO7iD,IAASuiD,EAAOvwB,KAC3B+S,EAAI+d,cAAc9iD,IAASuiD,EAAOvwB,IAAQhyB,IAASuiD,EAAOvwB,IAAQhyB,IAASuiD,EAAOvwB,KAClF+S,EAAI+d,cAAc9iD,IAASuiD,EAAOvwB,EAAIqwB,EAAKriD,IAASuiD,EAAOvwB,EAAIqwB,EAAKriD,IAASuiD,EAAOvwB,KAEpF+S,EAAI6d,YACJ7d,EAAI7c,OACJx3B,KAAKqP,IAAIq7C,aAAc,GnHquchBsF,EmHx2cYA,GCNAqC,GAAAA,SAAAA,GACpB,SAAAA,EAAYC,EAAUC,EAAYC,EAAaC,EAAYC,GAAY,IAAAzuD,EAAA,YAAA,IAA3DquD,IAAAA,EAAM,SAAqD,IAAjDC,IAAAA,EAAS,QAAwC,IAArCC,IAAAA,EAAO,UAA8B,IAAxBC,IAAAA,EAAM,MACpDxuD,EAAA0uD,EAAA9uD,KAAA7D,KAAMsyD,EAAKC,EAAQC,EAAMC,IAAzBzyD,MACKyB,OAAS,IAAI3B,MAAMkkC,QACxB//B,EAAK2uD,IAAM,IAAI9yD,MAAM+yD,MACrB5uD,EAAKooB,IAAIpoB,EAAK2uD,KAJwD3uD,EpH64ctE,OA9BAb,EAAeivD,EAAQM,GA8BhBN,EoH94cYA,CAAevyD,MAAMgxD,mBCG7BgC,GACZ,SAAYh3C,EAAK9K,GAChBhR,KAAK8b,IAAMA,EACX9b,KAAKgR,GAAKA,GAIC+hD,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAA3xD,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAA2vD,EAAAC,GAAAD,EAAA,CAA0CD,IAE7BG,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAA7xD,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAA6vD,EAAAC,GAAAD,EAAA,CAA2CH,IAEtBK,GAAAA,WA2FpB,SAAAA,EAAY1zB,GAAM,IAAAx7B,EAAAjE,KACjBA,KAAKy/B,KAAOA,EACZz/B,KAAKozD,OAASpzD,KAAKozD,OAAO9yC,KAAKtgB,MAC/BA,KAAKqrD,QAAS,EACdrrD,KAAK+tD,aAAe51C,EAAaE,OAAOtC,WAAU,SAAAX,GAAK,OAAInR,EAAKinD,MAAQ91C,EAAMmyB,erH0zc9E4rB,EqHv5cME,UAAP,WACC,OAAOF,EAAY1J,SAAW0J,EAAY1J,OAAS,IAAI3pD,MAAM4pD,gBrH05c7DyJ,EqHv5cM9sD,QAAP,SAAeo5B,GACd,OAAO10B,EAAY1E,QAAQo5B,EAAKU,MAAMW,OAASrB,EAAKU,MAAMC,OrH05c1D+yB,EqHv5cMG,YAAP,SAAmB7zB,EAAM/mB,GACxB,IAAMzS,EAAOktD,EAAY9sD,QAAQo5B,GACjC,OAAO0zB,EAAYE,YAAYvK,KAAK7iD,EAAMyS,IrH05c1Cy6C,EqHv5cMlpB,QAAP,SAAexK,GACd,OAAOA,EAAKU,OAASV,EAAKU,MAAMC,QAA8C,IAArCX,EAAKU,MAAMC,KAAKl7B,QAAQ,UAAwD,IAAtCu6B,EAAKU,MAAMC,KAAKl7B,QAAQ,WrH05c3GiuD,EqHv5cMhpB,SAAP,SAAgB1K,GACf,OAAOqJ,GAAcrJ,EAAKU,QrH05c1BgzB,EqHv5cMI,kBAAP,SAAyB9zB,GACxB,OAAOA,EAAKU,OAASV,EAAKU,MAAM7vB,KAAKb,OAASy4B,GAAUG,gBAAgB54B,MrH05cxE0jD,EqHv5cMK,iBAAP,SAAwB/zB,GACvB,OAAOA,EAAKU,OAASV,EAAKU,MAAM7vB,KAAKb,OAASy4B,GAAUI,eAAe74B,MrH05cvE0jD,EqHv5cMM,oBAAP,SAA2Bh0B,GAC1B,OAAOA,EAAKU,OAASV,EAAKU,MAAM7vB,KAAKb,OAASy4B,GAAUO,kBAAkBh5B,MrH05c1E0jD,EqHv5cMO,kBAAP,SAAyBj0B,GACxB,OAAOA,EAAKU,OAASV,EAAKU,MAAM7vB,KAAKb,OAASy4B,GAAUK,gBAAgB94B,MrH05cxE0jD,EqHv5cMQ,iBAAP,SAAwBl0B,GACvB,OAAOA,EAAKU,OAASV,EAAKU,MAAM7vB,KAAKb,OAASy4B,GAAUM,eAAe/4B,MrH05cvEtN,EAAagxD,EAAa,CAAC,CACzB1yD,IAAK,UACL8D,IAAK,WqHx5cP,OAAO4uD,EAAYlpB,QAAQjqC,KAAKy/B,QrH25c7B,CACDh/B,IAAK,WACL8D,IAAK,WqHz5cP,OAAO4uD,EAAYhpB,SAASnqC,KAAKy/B,QrH45c9B,CACDh/B,IAAK,oBACL8D,IAAK,WqH15cP,OAAO4uD,EAAYI,kBAAkBvzD,KAAKy/B,QrH65cvC,CACDh/B,IAAK,mBACL8D,IAAK,WqH35cP,OAAO4uD,EAAYK,iBAAiBxzD,KAAKy/B,QrH85ctC,CACDh/B,IAAK,sBACL8D,IAAK,WqH55cP,OAAO4uD,EAAYM,oBAAoBzzD,KAAKy/B,QrH+5czC,CACDh/B,IAAK,oBACL8D,IAAK,WqH75cP,OAAO4uD,EAAYO,kBAAkB1zD,KAAKy/B,QrHg6cvC,CACDh/B,IAAK,mBACL8D,IAAK,WqH95cP,OAAO4uD,EAAYQ,iBAAiB3zD,KAAKy/B,QrHi6ctC,CACDh/B,IAAK,kBACL8D,IAAK,WqH/5cP,OAAOvE,KAAKiqC,UAAYjqC,KAAKy/B,KAAKU,MAAMyzB,WrHk6crC,CACDnzD,IAAK,kBACL8D,IAAK,WqHh6cP,OAAOvE,KAAKmqC,UAAanqC,KAAKiqC,SAAwC,MAA5BjqC,KAAKy/B,KAAKU,MAAMyzB,WrHm6cvD,CACDnzD,IAAK,QACL8D,IAAK,WqHj6cP,OAAOvE,KAAKqrD,QrHo6cV7kD,IAAK,SqHj6cE0kD,GACTlrD,KAAKqrD,OAASH,EAEVlrD,KAAKoI,QACRpI,KAAKoI,MAAM8iD,OAAkB,IAAVA,OrHi7cpB,IAAIxlD,EAASytD,EAAY5wD,UAqJzB,OAnJAmD,EqHx6cDojD,KAAA,SAAKpwC,GAAU,IAEVtO,EAFUoK,EAAAxU,KACRy/B,EAAOz/B,KAAKy/B,KAGlB,GAAIz/B,KAAKmqC,UAAY1K,EAAKriB,SAAU,CACnC,IACM3b,EAAM,WADKg+B,EAAKriB,SAEhBhV,EAAQvD,SAASC,cAAiBrD,EAA1B,UACd,IAAK2G,EACJ,OAED,IAAMyrD,EAAY,SAAZA,IACLzrD,EAAMuvB,oBAAoB,UAAWk8B,IACrCzpD,EAAUoK,EAAKpK,QAAU,IAAItK,MAAMqqD,aAAa/hD,IACxCgiD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UACxBpgD,EAAQqH,OAAS3R,MAAM2qD,UAGvBrgD,EAAQsgD,aAAc,EACE,mBAAbhyC,GACVA,EAAStO,EAASoK,IAGpBpM,EAAMud,YAAc,YAChBvd,EAAMqmC,YAAcrmC,EAAM4iD,iBAC7B6I,IAEAzrD,EAAMivB,iBAAiB,UAAWw8B,QAE7B,GAAI7zD,KAAKiqC,QAAS,CAExB,IAAM7hC,EAAQpI,KAAKoI,MAAQvD,SAAS0W,cAAc,SAClDnT,EAAM0rD,QAAU,WAChB1rD,EAAMmsB,OAAS,GACfnsB,EAAM8iD,OAAQ,EACd9iD,EAAMgjD,aAAc,EACpBhjD,EAAMud,YAAc,YAChB8Z,EAAKU,OAASV,EAAKU,MAAMyzB,WAC5BxrD,EAAM+iD,MAAO,GAmBd/iD,EAAM6T,UAjBY,WACjB7T,EAAM6T,UAAY,MAClB7R,EAAU,IAAItK,MAAMqqD,aAAa/hD,IACzBgiD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UACxBpgD,EAAQqH,OAAS3R,MAAM2qD,UAGvBrgD,EAAQsgD,aAAc,EACjBjrB,EAAKU,OAAUV,EAAKU,MAAMyzB,UAC9BxrD,EAAMw7C,QAEiB,mBAAblrC,GACVA,EAAStO,EAASoK,IAIpBpM,EAAM0T,IAAMq3C,EAAY9sD,QAAQo5B,GAChCr3B,EAAM0gD,OACN9oD,KAAKuc,MAAK,QACAkjB,EAAKU,MACfgzB,EAAYG,YAAY7zB,GAAM,SAAAr1B,GAC7BA,EAAQggD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UAExBpgD,EAAQsjD,MAAQ5tD,MAAMi0D,eACtB3pD,EAAQujD,MAAQ7tD,MAAMi0D,eACE,mBAAbr7C,GACVA,EAAStO,EAASoK,MAIpBkE,EAAS,KAAM1Y,MAEhB,OAAOA,MrH67cP0F,EqH17cD6W,KAAA,SAAKy3C,GAAQ,IAAAr/C,EAAA3U,KAERA,KAAKoI,QACRpI,KAAKoI,MAAMmU,OAAOvb,MAAK,eAEpB,SAAAH,GACF4F,QAAQC,IAAI,yBAA0BiO,EAAK8qB,KAAKU,MAAMC,KAAMv/B,MAExDmzD,GACJb,EAAYr1B,QAAQ7pB,KAAK,IAAI8+C,GAAqB/yD,KAAKoI,MAAM0T,IAAK9b,KAAKy/B,KAAKzuB,OrHi8c9EtL,EqH57cDk+C,MAAA,SAAMoQ,GAEDh0D,KAAKoI,QACRpI,KAAKoI,MAAM8iD,OAAQ,EACnBlrD,KAAKoI,MAAMw7C,QACNoQ,GACJb,EAAYr1B,QAAQ7pB,KAAK,IAAIg/C,GAAsBjzD,KAAKoI,MAAM0T,IAAK9b,KAAKy/B,KAAKzuB,OrHk8c/EtL,EqH77cD0tD,OAAA,WAEC,GAAIpzD,KAAKoI,MACR,OAAIpI,KAAKoI,MAAM8xC,QACdl6C,KAAKoI,MAAM8iD,MAAQlrD,KAAKqrD,OACxBrrD,KAAKuc,QACE,IAEPvc,KAAK4jD,SACE,IrHk8cTl+C,EqH77cD2vB,QAAA,WACCr1B,KAAK+tD,aAAa53C,cAClBnW,KAAK4jD,eACE5jD,KAAKoI,OrHg8cL+qD,EqH7pdYA,GAkOrBA,GAAYr1B,QAAU,IAAI5lB,EAAAA,cAAc,GCzOxC,ICiCI+7C,GDjCEC,GAAa,2KAqCbC,GAA0B,+wBA6BXC,GAAAA,SAAAA,GAiJpB,SAAAA,EAAY30B,EAAMD,EAAOisB,GAAU,IAAAxnD,EAC5BynD,EAAW0I,EAAUC,kBAAkB50B,IAC7Cx7B,EAAAqwD,EAAAzwD,KAAA7D,KAAMyrD,EAAUC,IAAhB1rD,MACKy/B,KAAOA,EACZx7B,EAAKu7B,MAAQA,EACbv7B,EAAKwG,YAAcM,EAAYN,YAAYP,MAC3CjG,EAAKuqD,SAAW4F,EAAUG,kBAAkB90B,GACxBx7B,EAAKuwD,YAAc,IAAIrB,GAAY1zB,GAPrB,OAAAx7B,EtHw9clCb,EAAegxD,EAAWE,GAE1BF,EsHzmdMK,YAAP,SAAmBC,GAoBlB,OAnBiB,IAAI50D,MAAMsuD,eAAe,CACzCf,WAAW,EACXgB,YAAY,EACZsG,aAAa,EACbrG,aAAc4F,GACd3F,eAAgBmG,EAAeP,GAhEb,ipBAiElB3F,SAAU,CACTpmD,MAAO,CAAExH,OAAO,GAChBg0D,SAAU,CAAEtkD,KAAM,IAAK1P,MAAO,MAC9Bi0D,SAAU,CAAEvkD,KAAM,IAAK1P,MAAO,MAC9Bk0D,YAAa,CAAEl0D,MAAO,IAAId,MAAMuhC,SAChC0zB,YAAa,CAAEn0D,MAAO,IAAId,MAAMuhC,SAChC2zB,aAAc,CAAEp0D,MAAO,IAAId,MAAMm1D,MAAM,YACvCC,QAAS,CAAEt0D,MAAO,GAClBotD,MAAO,CAAEptD,MAAO,GAChB23B,QAAS,CAAE33B,MAAO,OtHoodpBwzD,EsH7ndMe,qBAAP,SAA4Bld,GAqB3B,YArB6D,IAAlCA,IAAAA,EAAiB,CAAC,EAAK,EAAK,IACtC,IAAIn4C,MAAMsuD,eAAe,CACzCf,WAAW,EACXgB,YAAY,EACZsG,aAAa,EACbrG,aAAc4F,GACd3F,eAAgB4F,GAChB3F,SAAU,CACTpmD,MAAO,CAAExH,OAAO,GAChBg0D,SAAU,CAAEtkD,KAAM,IAAK1P,MAAO,MAC9Bi0D,SAAU,CAAEvkD,KAAM,IAAK1P,MAAO,MAC9Bk0D,YAAa,CAAEl0D,MAAO,IAAId,MAAMuhC,SAChC0zB,YAAa,CAAEn0D,MAAO,IAAId,MAAMuhC,SAChC4W,eAAgB,CAAEr3C,MAAO,IAAId,MAAMkkC,QAAQiU,EAAe,GAAIA,EAAe,GAAIA,EAAe,KAChG+c,aAAc,CAAEp0D,MAAO,IAAId,MAAMm1D,MAAM,YACvCC,QAAS,CAAEt0D,MAAO,GAClBotD,MAAO,CAAEptD,MAAO,GAChB23B,QAAS,CAAE33B,MAAO,IAEnBw0D,KAAMt1D,MAAMu1D,ctH4pdbjB,EsHvpdMb,kBAAP,SAAyB33C,GACxB,OAAOA,EAAOxB,YAAcwB,EAAOxB,WAAWS,OAASxH,EAASC,WtH0pdhE8gD,EsHxpdMZ,iBAAP,SAAwB53C,GACvB,OAAOA,EAAOxB,YAAcwB,EAAOxB,WAAWS,OAASxH,EAASE,UtH2pdhE6gD,EsHzpdMX,oBAAP,SAA2B73C,GAC1B,OAAOA,EAAOxB,YAAcwB,EAAOxB,WAAWS,OAASxH,EAASK,atH4pdhE0gD,EsH1pdMV,kBAAP,SAAyB93C,GACxB,OAAOA,EAAOxB,YAAcwB,EAAOxB,WAAWS,OAASxH,EAASC,WAAasI,EAAOxB,WAAWa,MAAQW,EAAOO,StH6pd9Gi4C,EsH3pdMT,iBAAP,SAAwB/3C,GACvB,OAAOA,EAAOxB,YAAcwB,EAAOxB,WAAWS,OAASxH,EAASE,UAAYqI,EAAOxB,WAAWa,MAAQW,EAAOO,StH8pd7Gi4C,EsH5pdMkB,eAAP,SAAsBpd,GACrB,IAAIqd,EACJ,OAAQrd,EAAUzoC,MACjB,KAAKy4B,GAAUG,gBAAgB54B,KAC9B8lD,EAAUv1D,KAAKuzD,kBACf,MACD,KAAKrrB,GAAUI,eAAe74B,KAC7B8lD,EAAUv1D,KAAKwzD,iBACf,MACD,KAAKtrB,GAAUO,kBAAkBh5B,KAChC8lD,EAAUv1D,KAAKyzD,oBACf,MACD,KAAKvrB,GAAUK,gBAAgB94B,KAC9B8lD,EAAUv1D,KAAK0zD,kBACf,MACD,KAAKxrB,GAAUM,eAAe/4B,KAC7B8lD,EAAUv1D,KAAK2zD,iBACf,MACD,QACC4B,EAAU,SAAC35C,GAAa,OAAO,GAEjC,OAAO25C,GtHyqdPnB,EsHtqdMoB,aAAP,SAAoB/1B,GAAM,IAAAjrB,EAAAxU,KACzB,IAAKy/B,EAAKU,MACT,OAAO/rB,EAAAA,GAAG,MAEX,IAAM8jC,EAAYzY,EAAKU,MAAM7vB,KACvB8vB,EAAOX,EAAKU,MAAMC,KACxB,OAAI0I,GAAcrJ,EAAKU,OACfvmB,EAAcsD,SAAS3K,KAC7BlD,EAAAA,KAAI,SAAC+O,GACJ,IAAIxC,EACAja,EAAI,EACF8zD,EAAYjhD,EAAK8gD,eAAepd,GAUtC,OATA95B,EAAQla,SAAQ,SAAAoL,GACXmmD,EAAUnmD,KACT3N,IAAM89B,EAAKU,MAAMj3B,QACpB0S,EAAStM,GAEV3N,QAIEia,EACIA,EAAOO,QAEP,SAKH/H,EAAAA,GAAGgsB,ItH+qdXg0B,EsH3qdMC,kBAAP,SAAyB50B,GASxB,OAPIA,EAAKU,OAASV,EAAKU,MAAM8X,eACjBmc,EAAUe,qBAAqB11B,EAAKU,MAAM8X,gBAC3CxY,EAAKU,MACJi0B,EAAUK,cAEV,IAAI30D,MAAM8rD,kBAAkB,CAAEC,MAAO,WtHordjDuI,EsH/qdMG,kBAAP,SAAyB90B,GACxB,IAAI+uB,EAAW,KAQf,OAPI/uB,EAAKU,QACRquB,EAAW,CACV0G,QAAS,EACTlH,MAAO,EACPz1B,QAAS,IAGJi2B,GtHusdP,IAAI9oD,EAAS0uD,EAAU7xD,UAyRvB,OAvRAmD,EsHvrdDojD,KAAA,SAAKpwC,GAAU,IAAA/D,EAAA3U,KACd,IAAKA,KAAKy/B,KAAKU,MAKd,OAJAngC,KAAK01D,gBACmB,mBAAbh9C,GACVA,EAAS1Y,OAIX,IAAM0rD,EAAW1rD,KAAK0rD,SAChB8I,EAAcx0D,KAAKw0D,YACzBA,EAAY1L,MAAK,SAAC8L,GAEbA,IACHlJ,EAAS8C,SAASoG,SAASh0D,MAAQg0D,EAGnClJ,EAAS8C,SAASsG,YAAYl0D,MAAQ,IAAId,MAAMuhC,QAAQuzB,EAASzsD,MAAMuT,OAASk5C,EAASzsD,MAAMwtD,WAAYf,EAASzsD,MAAMwT,QAAUi5C,EAASzsD,MAAMytD,aACnJlK,EAAShB,aAAc,EACnB8J,EAAYqB,iBACflhD,EAAKmhD,eAAelB,GAAU,SAACC,GAE9BA,EAASzK,UAAYtqD,MAAMuqD,aAC3BwK,EAASvK,UAAYxqD,MAAMuqD,aAC3BwK,EAAStK,QAAUzqD,MAAM0qD,UAEzBqK,EAASnH,MAAQ5tD,MAAMi0D,eACvBc,EAASlH,MAAQ7tD,MAAMi0D,eACvBrI,EAAS8C,SAASqG,SAASj0D,MAAQi0D,EAGnCnJ,EAAS8C,SAASuG,YAAYn0D,MAAQ,IAAId,MAAMuhC,QAAQwzB,EAAS1sD,MAAMuT,MAAOm5C,EAAS1sD,MAAMwT,QAE7F+vC,EAAShB,aAAc,MAI1B/1C,EAAK+gD,WACDlB,EAAYqB,kBACfnK,EAAS8C,SAASpmD,MAAMxH,OAAQ,EAChC+T,EAAKohD,OAASphD,EAAKohD,OAAOz1C,KAAK3L,GAC/BA,EAAKqhD,MAAQrhD,EAAKqhD,MAAM11C,KAAK3L,GAC7BA,EAAKshD,SAAWthD,EAAKshD,SAAS31C,KAAK3L,GACnCA,EAAK8D,GAAG,OAAQ9D,EAAKohD,QACrBphD,EAAK8D,GAAG,MAAO9D,EAAKqhD,OACpBrhD,EAAK8D,GAAG,OAAQ9D,EAAKshD,WAEE,mBAAbv9C,GACVA,EAAS/D,OtHwsdXjP,EsHnsdDowD,eAAA,SAAelB,EAAUl8C,GACxB,IAAMw9C,EAAKtB,EAASzsD,MAAMuT,OAASk5C,EAASzsD,MAAMwtD,WAC5CQ,EAAKvB,EAASzsD,MAAMwT,QAAUi5C,EAASzsD,MAAMytD,YAC7CvuD,EAAK6uD,EAAKC,EAEV/hB,EAASvvC,SAAS0W,cAAc,UAEtC64B,EAAO14B,MAAQw6C,EACf9hB,EAAOz4B,OAASw6C,EAChB,IAAM9hB,EAAMD,EAAOznC,WAAW,MAC9B0nC,EAAI+hB,uBAAwB,EAC5B/hB,EAAIgiB,sBAAwB,OAC5B,IAAMluD,EAAQ,IAAIggC,MAClBhgC,EAAMgsC,OAAS,WACd,IAGIvO,EACA8c,EAFE4T,EAFKnuD,EAAMuT,MACNvT,EAAMwT,OAIbtU,EAAKivD,EAER5T,GADA9c,EAhBY,IAgBRuwB,GACIG,EAGR1wB,GADA8c,EAnBY,IAmBRwT,GACII,EAETjiB,EAAIC,UAAUnsC,EAAO+tD,EAAK,EAAItwB,EAAI,EAAGuwB,EAAK,EAAIzT,EAAI,EAAG9c,EAAG8c,GACxD,IAAMmS,EAAW,IAAI/0D,MAAMwxD,cAAcld,GACjB,mBAAb17B,GACVA,EAASm8C,IAGX1sD,EAAMwd,YAAc,YACpBxd,EAAM2T,IAAM/Q,EAAY1E,QAAQ,yBtH2sdhCX,EsHxsdDo4B,QAAA,WAAU,IAAAjpB,EAAA7U,KACHy/B,EAAOz/B,KAAKy/B,KACZD,EAAQx/B,KAAKw/B,MAInB,OAHIC,EAAKU,OAASV,EAAKU,MAAMo2B,cAC5Bv2D,KAAKksD,SAECiH,GAAYr1B,QAAQvrB,KAC1BlD,EAAAA,KAAI,SAAAsJ,GACC8mB,EAAKU,OAASV,EAAKU,MAAMo2B,eACV/2B,EAAMliB,MAAK,SAAAhO,GAAC,OAAIA,EAAE6wB,QAA8C,IAArCxnB,EAAMmD,IAAI5W,QAAQoK,EAAE6wB,MAAMC,OAAgBznB,EAAM3H,KAAOyuB,EAAKU,MAAMo2B,kBAG1G59C,aAAiBo6C,GACpBl+C,EAAK0H,OACK5D,aAAiBs6C,IAC3Bp+C,EAAK+uC,UAIR,OAAOjrC,OtHmtdTjT,EsH9sdDgwD,SAAA,WACC,IAAMlH,EAAWxuD,KAAKwuD,SAChB9C,EAAW1rD,KAAK0rD,SAClBA,EAAS8C,UACZgI,KAAKrZ,GAAGqR,EAAU,CACjB/hB,SAAU,GACVlU,QAAS,EACTk+B,KAAMC,OAAOC,UACblpB,SAAU,WACTie,EAAS8C,SAASj2B,QAAQ33B,MAAQ4tD,EAASj2B,QAC3CmzB,EAAShB,aAAc,MtHqtd1BhlD,EsH/sdDkxD,YAAA,WACC,IAAMpI,EAAWxuD,KAAKwuD,SAChB9C,EAAW1rD,KAAK0rD,SAClBA,EAAS8C,UACZgI,KAAKrZ,GAAGqR,EAAU,CACjB/hB,SAAU,GACVlU,QAAS,EACTk+B,KAAMC,OAAOC,UACblpB,SAAU,WACTie,EAAS8C,SAASj2B,QAAQ33B,MAAQ4tD,EAASj2B,QAC3CmzB,EAAShB,aAAc,MtHstd1BhlD,EsHhtdDqwD,OAAA,WACC,IAAMvH,EAAWxuD,KAAKwuD,SAChB9C,EAAW1rD,KAAK0rD,SAClBA,EAAS8C,UACZgI,KAAKrZ,GAAGqR,EAAU,CACjB/hB,SAAU,GACVyoB,QAAS,EACTlH,MAAOhuD,KAAK62D,QAAU,EAAI,EAC1Bt+B,QAAS,EACTk+B,KAAMC,OAAOC,UACbG,WAAW,EACXrpB,SAAU,WACTie,EAAS8C,SAAS0G,QAAQt0D,MAAQ4tD,EAAS0G,QAC3CxJ,EAAS8C,SAASR,MAAMptD,MAAQ4tD,EAASR,MACzCtC,EAAS8C,SAASj2B,QAAQ33B,MAAQ4tD,EAASj2B,QAC3CmzB,EAAShB,aAAc,MtHutd1BhlD,EsHjtdDswD,MAAA,WACC,IAAMxH,EAAWxuD,KAAKwuD,SAChB9C,EAAW1rD,KAAK0rD,SAClBA,EAAS8C,UACZgI,KAAKrZ,GAAGqR,EAAU,CACjB/hB,SAAU,GACVyoB,QAAS,EACTlH,MAAOhuD,KAAK62D,QAAU,EAAI,EAC1Bt+B,QAAS,EACTk+B,KAAMC,OAAOC,UACbG,WAAW,EACXrpB,SAAU,WACTie,EAAS8C,SAAS0G,QAAQt0D,MAAQ4tD,EAAS0G,QAC3CxJ,EAAS8C,SAASR,MAAMptD,MAAQ4tD,EAASR,MACzCtC,EAAS8C,SAASj2B,QAAQ33B,MAAQ4tD,EAASj2B,QAC3CmzB,EAAShB,aAAc,MtHwtd1BhlD,EsHltdDuwD,SAAA,WACCj2D,KAAK62D,QAAU72D,KAAKw0D,YAAYpB,SAChCpzD,KAAK8Y,KAAK,UAAW9Y,KAAK62D,SAC1B72D,KAAKg2D,StHqtdLtwD,EsHltdD6W,KAAA,WACCvc,KAAKw0D,YAAYj4C,OACjBvc,KAAK62D,SAAU,EACf72D,KAAK8Y,KAAK,WAAW,GACrB9Y,KAAKg2D,StHqtdLtwD,EsHltdDk+C,MAAA,WACC5jD,KAAKw0D,YAAY5Q,QACjB5jD,KAAK62D,SAAU,EACf72D,KAAK8Y,KAAK,WAAW,GACrB9Y,KAAKg2D,StHqtdLtwD,EsHltdDqxD,gBAAA,SAAgBF,GACX72D,KAAK62D,UAAYA,IACpB72D,KAAK62D,QAAUA,EACfA,EAAU72D,KAAKw0D,YAAYj4C,OAASvc,KAAKw0D,YAAY5Q,QACrD5jD,KAAKg2D,UtHstdNtwD,EsHltdDsxD,aAAA,SAAav3B,GACZz/B,KAAKi3D,kBACLj3D,KAAKk3D,qBACLl3D,KAAK0rD,SAAW0I,EAAUC,kBAAkB50B,GAC5Cz/B,KAAKwuD,SAAW4F,EAAUG,kBAAkB90B,GAC5Cz/B,KAAKw0D,YAAc,IAAIrB,GAAY1zB,ItHqtdnC/5B,EsHltdDuxD,gBAAA,WACKj3D,KAAK0rD,WACJ1rD,KAAK0rD,SAASr8C,MAAwC,IAAjCrP,KAAK0rD,SAASr8C,IAAI8nD,YAC1Cn3D,KAAK0rD,SAASr8C,IAAIgmB,UAEnBr1B,KAAK0rD,SAASr2B,UACdr1B,KAAK0rD,SAAW,OtHutdjBhmD,EsHntdDwxD,mBAAA,WACC,IAAM1C,EAAcx0D,KAAKw0D,YACrBA,IACCA,EAAYqB,kBACf71D,KAAK4Y,IAAI,OAAQ5Y,KAAK+1D,QACtB/1D,KAAK4Y,IAAI,MAAO5Y,KAAKg2D,OACrBh2D,KAAK4Y,IAAI,OAAQ5Y,KAAKi2D,WAEvBzB,EAAYn/B,UACZr1B,KAAKw0D,YAAc,OtHytdpB9uD,EsHrtdD2vB,QAAA,WACCr1B,KAAKk3D,sBtHwtdE9C,EsH9meYA,CAAkB9G,ICxE1B8J,GACZ,WACCp3D,KAAKsP,EAAI,EACTtP,KAAKshC,EAAI,GAIE+1B,GACZ,SAAY1xD,GACPA,GACH1D,OAAO8D,OAAO/F,KAAM2F,IAKV2xD,GAAb,SAAAC,GACC,SAAAD,EAAY3xD,GAAS,IAAA1B,EAAA,OACpBA,EAAAszD,EAAA1zD,KAAA7D,KAAM2F,IAAN3F,MACKw3D,SAAW,IAAIJ,GACpBnzD,EAAKwzD,SAAW,IAAIL,GACpBnzD,EAAKyzD,MAAQ,IAAIN,GAJGnzD,EADtB,OAAAb,EAAAk0D,EAAAC,GAAAD,EAAA,CAAmCD,IAStBM,GAAb,SAAAC,GACC,SAAAD,EAAYhyD,GAAS,IAAA6O,EAAA,OACpBA,EAAAojD,EAAA/zD,KAAA7D,KAAM2F,IAAN3F,MACKw3D,SAAW,IAAIJ,GACpB5iD,EAAKijD,SAAW,IAAIL,GACpB5iD,EAAKkjD,MAAQ,IAAIN,GAJG5iD,EADtB,OAAApR,EAAAu0D,EAAAC,GAAAD,EAAA,CAAmCN,IAStBQ,GAAb,SAAAC,GACC,SAAAD,EAAYlyD,GAAS,OACpBmyD,EAAAj0D,KAAA7D,KAAM2F,IADc3F,KADtB,OAAAoD,EAAAy0D,EAAAC,GAAAD,EAAA,CAAiCR,IAQZU,GAAAA,WvHisenB,SAASA,KAgHT,OA9GAA,EuHjseMC,YAAP,SAAmBr/C,EAAOw0C,GAoBzB,OAnBIx0C,aAAiBs/C,WACpB9K,GACCA,EAAM79C,EAAIqJ,EAAMu/C,QAChB/K,EAAM7rB,EAAI3oB,EAAMw/C,SACbhL,EAAQ,CACX79C,EAAGqJ,EAAMu/C,QACT52B,EAAG3oB,EAAMw/C,SAEA1zD,OAAO2zD,YAAcz/C,aAAiBy/C,YAC5Cz/C,EAAM0/C,QAAQz2D,OAAS,IAC1BurD,GACCA,EAAM79C,EAAIqJ,EAAM0/C,QAAQ,GAAGC,MAC3BnL,EAAM7rB,EAAI3oB,EAAM0/C,QAAQ,GAAGE,OACxBpL,EAAQ,CACX79C,EAAGqJ,EAAM0/C,QAAQ,GAAGC,MACpBh3B,EAAG3oB,EAAM0/C,QAAQ,GAAGE,QAIhBpL,GvH+reP4K,EuH5reMS,MAAP,SAAa/2D,EAAQq8B,GAAS,IACzB26B,EADyB9jD,EAAA3U,KAE7B,OAAO+D,EAAAA,MACN2mC,EAAAA,UAAUjpC,EAAQ,aAAa8Q,KAAKvP,EAAAA,QAAO,SAAA2V,GAAK,OAAqB,IAAjBA,EAAM+/C,WAC1DhuB,EAAAA,UAAUjpC,EAAQ,eACjB8Q,KACDlD,EAAAA,KAAI,SAACsJ,GAMJ,IALA8/C,EAAYA,GAAa,IAAInB,IACnB5qD,KAAOjL,EACjBg3D,EAAUh3D,OAASkX,EAAMlX,OACzBg3D,EAAUE,cAAgBhgD,EAC1B8/C,EAAU/iB,KAAO/gC,EAAKqjD,YAAYr/C,EAAO8/C,EAAU/iB,MAC/C+iB,EAAU/iB,KAKb,OAJA+iB,EAAUjB,SAAW,IAAIJ,GACzBqB,EAAUhB,SAAW,IAAIL,GACzBqB,EAAUf,MAAQ,IAAIN,GACtBt5B,EAAQ7pB,KAAKwkD,GACNA,KAGTz1D,EAAAA,QAAO,SAAA2V,GAAK,YAAcpX,IAAVoX,OvHisejBo/C,EuH7reMa,MAAP,SAAan3D,EAAQq8B,EAAS+6B,EAAUJ,GAAW,IAC9CK,EAD8CjkD,EAAA7U,KAElD,OAAO0qC,EAAAA,UAAU7lC,SAAU4zD,EAAUE,yBAAyBV,WAAa,YAAc,aAAa1lD,KACrGsqC,EAAAA,UAAU4b,GACVppD,EAAAA,KAAI,SAACsJ,GAOJ,IANAmgD,EAAYA,GAAa,IAAInB,IACnBjrD,KAAOjL,EACjBq3D,EAAUr3D,OAASkX,EAAMlX,OACzBq3D,EAAUH,cAAgBhgD,EAC1BmgD,EAAUv+B,SAAW1lB,EAAKmjD,YAAYr/C,EAAOmgD,EAAUv+B,eACnBh5B,IAAnBk3D,EAAU/iB,WAA6Cn0C,IAAvBu3D,EAAUv+B,SAe1D,OAbAu+B,EAAUtB,SAASloD,EAAIwpD,EAAUv+B,SAASjrB,EAAImpD,EAAU/iB,KAAKpmC,EAC7DwpD,EAAUtB,SAASl2B,EAAIw3B,EAAUv+B,SAAS+G,EAAIm3B,EAAU/iB,KAAKpU,EAC7Dw3B,EAAUrB,SAASnoD,EAAIwpD,EAAUtB,SAASloD,EAAI7K,OAAOs0D,WAAa,EAClED,EAAUrB,SAASn2B,EAAIw3B,EAAUtB,SAASl2B,EAAI78B,OAAOu0D,YAAc,EACnEF,EAAUpB,MAAMpoD,EAAImpD,EAAUf,MAAMpoD,EAAoD,IAA/CwpD,EAAUrB,SAASnoD,EAAImpD,EAAUhB,SAASnoD,GACnFwpD,EAAUpB,MAAMp2B,EAAIm3B,EAAUf,MAAMp2B,EAAoD,IAA/Cw3B,EAAUrB,SAASn2B,EAAIm3B,EAAUhB,SAASn2B,GACnFm3B,EAAUjB,SAASloD,EAAIwpD,EAAUtB,SAASloD,EAC1CmpD,EAAUjB,SAASl2B,EAAIw3B,EAAUtB,SAASl2B,EAC1Cm3B,EAAUf,MAAMpoD,EAAIwpD,EAAUpB,MAAMpoD,EACpCmpD,EAAUf,MAAMp2B,EAAIw3B,EAAUpB,MAAMp2B,EACpCm3B,EAAUhB,SAASnoD,EAAIwpD,EAAUrB,SAASnoD,EAC1CmpD,EAAUhB,SAASn2B,EAAIw3B,EAAUrB,SAASn2B,EAC1CxD,EAAQ7pB,KAAK6kD,GACNA,OvHmseVf,EuH7reMkB,aAAP,SAAoBtgD,EAAOmlB,EAAS+6B,EAAUJ,GAU7C,OARAxE,GAAUA,IAAW,IAAI4D,GACzB/5B,EAAQ7pB,KAAKggD,IACb4E,EAAS5kD,OAELwkD,GAAaj+C,KAAKub,IAAI0iC,EAAUjB,SAASloD,GAAK,KACjDqJ,EAAMmyB,iBACNnyB,EAAMugD,4BAEAjF,IvHiseP8D,EuH9reMoB,IAAP,SAAW13D,EAAQq8B,EAAS+6B,EAAUJ,GAAW,IAAA1jD,EAAA/U,KAChD,OAAO0qC,EAAAA,UAAU7lC,SAAU4zD,EAAUE,yBAAyBV,WAAa,UAAY,YAAY1lD,KAClGlD,EAAAA,KAAI,SAAAsJ,GAAK,OAAI5D,EAAKkkD,aAAatgD,EAAOmlB,EAAS+6B,EAAUJ,QvHose1DV,EuHhseMqB,SAAP,SAAgB33D,GAAQ,IAAAqlB,EAAA9mB,KACvByB,EAASA,GAAUoD,SACnB,IAAMi5B,EAAUi6B,EAAYj6B,QAAU,IAAI5lB,EAAAA,cAAc,GAClD2gD,EAAWd,EAAYc,SAAW,IAAI56B,EAAAA,QAC5C,OAAOj+B,KAAKw4D,MAAM/2D,EAAQq8B,GAASvrB,KAClC8B,EAAAA,WAAU,SAACokD,GAEV,OADAV,EAAYU,UAAYA,EACjB10D,EAAAA,MACN+iB,EAAK8xC,MAAMn3D,EAAQq8B,EAAS+6B,EAAUJ,GACtC3xC,EAAKqyC,IAAI13D,EAAQq8B,EAAS+6B,EAAUJ,IACnClmD,KACDkE,EAAAA,UAAUoiD,OAGZxkD,EAAAA,WAAU,WAAA,OAAMypB,OvHgseVi6B,EuHjzeYA,GCtCRsB,GACF,WADEA,GAGL,QAGKC,GAAb,aACaC,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAn4D,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAm2D,EAAAC,GAAAD,EAAA,CAAoCD,IACvBG,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAr4D,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAq2D,EAAAC,GAAAD,EAAA,CAAsCH,IACzBK,GAAb,SAAAC,GAAA,SAAAD,IAAA,OAAAC,EAAAv4D,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAu2D,EAAAC,GAAAD,EAAA,CAAoCL,IAC9BO,GAAiB,IAAIF,GACrBG,GAAiB,IAAIP,GACrBQ,GAAmB,IAAIN,GAQRO,GAAAA,WxH+2enB,IAAIt0D,EAASs0D,EAAaz3D,UwHt0e3B,SAAAy3D,EAAYj2B,GACX/jC,KAAKi6D,MAAQD,EAAa3+C,KAAOg+C,GACjCr5D,KAAKk6D,OAAS,GACdl6D,KAAKm6D,MAAQ,GACbn6D,KAAK0jC,UAAY,EACjB1jC,KAAKyjC,SAAW,EAChBzjC,KAAKo6D,UAAY,EACjBp6D,KAAKi3C,OAAS,IACdj3C,KAAKu6B,SAAW,IAAIz6B,MAAMkkC,QAE1BhkC,KAAKq6D,QAAU,IAAIv6D,MAAMuhC,QACzBrhC,KAAKg3C,SAAW,IAAIl3C,MAAMw6D,MAAM,EAAG,EAAG,EAAG,OACzCt6D,KAAKyB,OAAS,IAAI3B,MAAMkkC,QACxBhkC,KAAKu6D,eAAiB,IAAIz6D,MAAMkkC,QAChChkC,KAAKw6D,aAAe,IAAI16D,MAAMkkC,QAC9BhkC,KAAK+jC,OAASA,EACd/jC,KAAKy6D,qBAAqB,EAAG,GAC7Bz6D,KAAK89B,QAAU,IAAI5lB,EAAAA,cAAc,GxH4pfjC,OArWAxS,EwHr2eDg1D,cAAA,WACC,OAAQ,GAAK16D,KAAKk6D,OAlBK,IAkBX,GAAuD,IxHw2enEx0D,EwH31eDi1D,aAAA,WACC,OAAO,GAAS36D,KAAKm6D,MA9BC,IA8BP,IxH81efh4D,EAAa63D,EAAc,CAAC,CAC1Bv5D,IAAK,QACL8D,IAAK,WwHx3eP,OAAOvE,KAAKk6D,QxH23eV1zD,IAAK,SwHz3eEksD,GACT,IAAMkI,EAAe96D,MAAM0a,KAAKqgD,MAAMnI,EAXf,GACA,IAWnB1yD,KAAKk6D,SAAWU,IACnB56D,KAAKk6D,OAASU,EACd56D,KAAK6N,YxH63eH,CACDpN,IAAK,OACL8D,IAAK,WwHv3eP,OAAOvE,KAAKm6D,OxH03eV3zD,IAAK,SwHx3eC8wC,GACR,IAAMsjB,EAAe96D,MAAM0a,KAAKqgD,MAAMvjB,EAzBf,GACA,IAyBnBt3C,KAAKm6D,QAAUS,IAClB56D,KAAKm6D,MAAQS,EACb56D,KAAK6N,YxH43eH,CACDpN,IAAK,OACL8D,IAAK,WwHt3eP,OAAOvE,KAAKi6D,OxHy3eVzzD,IAAK,SwHv3eC6U,GACJrb,KAAKi6D,QAAU5+C,IAClBrb,KAAKi6D,MAAQ5+C,EACb2+C,EAAa3+C,KAAOA,EACpBrb,KAAK6N,cxHg5eNnI,EwHx3eDo1D,eAAA,SAAet3B,GACVA,IACHxjC,KAAKy6D,qBAAqBj3B,EAAYE,UAAWF,EAAYC,UAC7DzjC,KAAK6N,WxH43eNnI,EwHx3eDq1D,eAAA,WACC,MAAO,CACNt3B,SAAUzjC,KAAKyjC,SACfC,UAAW1jC,KAAK0jC,YxH43ejBh+B,EwHx3eD+0D,qBAAA,SAAqB/2B,EAAWD,GAC/BA,EAAWjpB,KAAKC,KAAK,GAAID,KAAKO,IAAI,GAAI0oB,IACtCzjC,KAAK0jC,WAAaA,EAAY,EAAI,IAAMA,EAAYA,GAAa,IACjE1jC,KAAKyjC,SAAWA,EAEhB,IAAMu3B,EAAMl7D,MAAM0a,KAAKygD,SAAS,GAAKx3B,GAC/By3B,EAAQp7D,MAAM0a,KAAKygD,SAASv3B,GAClC1jC,KAAKg7D,IAAMA,EACXh7D,KAAKk7D,MAAQA,GxH23ebx1D,EwHx3eD0zD,SAAA,SAAS1sD,GAAM,IAEV+2B,EAAUC,EAFAz/B,EAAAjE,KAGd,OAAO8Z,EAAAA,cAAc,CAACwiC,GAAgBK,QAASob,GAAYqB,SAAS1sD,KAAQ6F,KAC3EvP,EAAAA,QAAO,SAAA2V,GAAK,OAAMR,EAAa/C,MAAMgV,SAAWjS,EAAa/C,MAAMkU,UACnEja,EAAAA,KAAI,SAAC4K,GACJ,IAAMpX,EAAOoX,EAAM,GACbtB,EAAQsB,EAAM,GAEpB,GAAItB,aAAiB2+C,GACpB7zB,EAAWx/B,EAAKw/B,SAChBC,EAAYz/B,EAAKy/B,eACX,GAAI/qB,aAAiBg/C,GAC3B,GAAI90D,EAAKs4D,MACRl3D,EAAK65B,QAAQ7pB,KAAK6lD,SACZ,GAAIj3D,EAAKu4D,QACfn3D,EAAK65B,QAAQ7pB,KAAK8lD,QACZ,CACN,IAAMsB,EAAOp3D,EAAKg2D,QAAUZ,IAAmB,EAAI,EACnDp1D,EAAKw2D,qBAAqB/2B,EAA+B,GAAnB/qB,EAAM6+C,SAASloD,EAAU+rD,EAAM53B,EAA8B,GAAnB9qB,EAAM6+C,SAASl2B,GAKjG,OAAO3oB,KAER3V,EAAAA,QAAO,SAAA2V,GAAK,OAAIA,aAAiBg/C,MACjC9a,EAAAA,UAAU,CAAEpZ,SAAUzjC,KAAKyjC,SAAUC,UAAW1jC,KAAK0jC,YACrDjvB,EAAAA,KAAI,SAAAkE,GAAK,OAAI1U,EAAK4J,YAClBwG,EAAAA,WAAU,SAAAsE,GAAK,OAAI1U,EAAK65B,axHk4ezBp4B,EwH93eDmI,OAAA,WACC,IAAIopC,EAAQ1c,EAAWv6B,KAAKu6D,eAAgB94D,EAASzB,KAAKw6D,aACpDljB,EAAOt3C,KAAK26D,eAGZK,GAFQh7D,KAAK06D,gBAEP56D,MAAMw7D,UAAUL,SAAS,GAAKj7D,KAAKyjC,WACzCy3B,EAAQp7D,MAAMw7D,UAAUL,SAASj7D,KAAK0jC,WACtCK,EAAS/jC,KAAK+jC,OACpB,OAAQ/jC,KAAKi6D,OACZ,KAAKZ,GACJpiB,EAAqC,EACrC1c,EAASoc,KAAK32C,KAAKu6B,UACnB94B,EAAO6N,EAAItP,KAAKu6B,SAASjrB,EAAI2nC,EAASz8B,KAAKo3C,IAAIoJ,GAAOxgD,KAAKs3C,IAAIoJ,GAC/Dz5D,EAAO6/B,EAAIthC,KAAKu6B,SAAS+G,EAAI2V,EAASz8B,KAAKs3C,IAAIkJ,GAC/Cv5D,EAAOkkC,EAAI3lC,KAAKu6B,SAASoL,EAAIsR,EAASz8B,KAAKo3C,IAAIoJ,GAAOxgD,KAAKo3C,IAAIsJ,GAC/Dn3B,EAAOtiC,OAAOk1C,KAAKpc,GACnBwJ,EAAOxJ,SAASoc,KAAKl1C,GACrB,MACD,QACCw1C,EAASj3C,KAAKi3C,OACdx1C,EAAO6N,EAAItP,KAAKu6B,SAASjrB,EAAI2nC,EAASz8B,KAAKo3C,IAAIoJ,GAAOxgD,KAAKs3C,IAAIoJ,GAC/Dz5D,EAAO6/B,EAAIthC,KAAKu6B,SAAS+G,EAAI2V,EAASz8B,KAAKs3C,IAAIkJ,GAC/Cv5D,EAAOkkC,EAAI3lC,KAAKu6B,SAASoL,EAAIsR,EAASz8B,KAAKo3C,IAAIoJ,GAAOxgD,KAAKo3C,IAAIsJ,GAI9D3gC,EAASoc,KAAK32C,KAAKu6B,UAEpBwJ,EAAOxJ,SAASoc,KAAKpc,GACrBwJ,EAAOtiC,OAAOk1C,KAAKl1C,GAOpBsiC,EAAOuT,KAAOA,EAEfvT,EAAO6S,OAAO7S,EAAOtiC,QACrBsiC,EAAOw3B,yBACPv7D,KAAK89B,QAAQ7pB,KAAK4lD,KxH05elBn0D,EwHp4eD+rD,OAAA,WACCzxD,KAAK0jC,WAAa,KAClB1jC,KAAK6N,UxHu4eLnI,EwHp4eD81D,KAAA,SAAKjhC,EAAU7hB,GAAU,IACpBu+B,EADoBziC,EAAAxU,KAExB,OAAQA,KAAKi6D,OACZ,KAAKZ,GACJpiB,EAAS,EACT,MACD,QACCA,EAASj3C,KAAKi3C,OAEhB,IAAMwkB,EAAU,IAAI37D,MAAMuhC,QAAQ9G,EAASjrB,EAAGirB,EAAS+G,GAAGo6B,YAAY5kB,eAAeG,GAC/E0kB,EAAenhD,KAAKohD,MAAMH,EAAQn6B,EAAGm6B,EAAQnsD,GAC/CusD,EAAmB/7D,MAAMw7D,UAAUQ,SAASH,GAChDE,GAAoBA,EAAmB,EAAI,IAAMA,EAAmBA,GAAoB,IACxF,IACMp4B,EAAWzjC,KAAKyjC,SAChBC,EAAY1jC,KAAK0jC,UACnBq4B,EAAuBF,EAAmBn4B,EAC9Cq4B,EAAsBvhD,KAAKub,IAAIgmC,GAAuB,IAAOA,EAA6BA,EAAsBvhD,KAAKub,IAAIgmC,GAAtC,IAA+DA,EAClJ,IAAIC,EALoB,EAKoBv4B,EAC5Cu4B,EAAqBxhD,KAAKub,IAAIimC,GAAsB,GAAMA,EAA2BA,EAAqBxhD,KAAKub,IAAIimC,GAApC,GAA4DA,EAE3I,IAAMrqD,EAAO,CAAEq8C,MAAO,GACtBwI,KAAKrZ,GAAGxrC,EAAM,CACb86B,SAAU,GACVuhB,MAAO,EACPtd,MAAO,EACP+lB,KAAMC,OAAOC,UACblpB,SAAU,WACTj5B,EAAKimD,qBAAqB/2B,EAAYq4B,EAAsBpqD,EAAKq8C,MAAOvqB,EAAWu4B,EAAqBrqD,EAAKq8C,OAC7Gx5C,EAAK+lB,SAAS/zB,IAAI+zB,EAASjrB,EAAIqC,EAAKq8C,MAAO,EAAGzzB,EAAS+G,EAAI3vB,EAAKq8C,OAChEx5C,EAAK3G,UAEN8kB,WAAY,WAEa,mBAAbja,GACVA,EAASmjD,EAtBY,OxHy6exBn2D,EwH74eDu2D,aAAA,SAAaJ,EAAkBK,GAC9Bl8D,KAAKy6D,qBAAqBoB,EAAkBK,GAC5Cl8D,KAAKu6B,SAAS/zB,IAAI,EAAG,EAAG,GACxBxG,KAAK6N,UxHg5eLnI,EwH74eDkxC,OAAA,SAAOulB,GAEN,GAAIA,EAAU,CAOb,IACIllB,EADE1c,EAAW4hC,EAAS5hC,SAE1B,OAAQv6B,KAAKi6D,OACZ,KAAKZ,GACJpiB,EAAS,EACT,MACD,QACCA,EAASj3C,KAAKi3C,OAEhB,IAAMwkB,EAAU,IAAI37D,MAAMkkC,QAAQzJ,EAASjrB,EAAGirB,EAASoL,EAAGpL,EAAS+G,GAAGo6B,YAAY5kB,eAAeG,GAC3FikB,EAAQ1gD,KAAKohD,MAAMH,EAAQn6B,EAAGm6B,EAAQnsD,GACtC0rD,EAAMxgD,KAAK4hD,KAAKX,EAAQ91B,EAAIsR,GAC9BvT,EAAY5jC,MAAMw7D,UAAUQ,SAASZ,GACzCx3B,GAAaA,EAAY,EAAI,IAAMA,EAAYA,GAAa,IAC5D,IAAID,EAAW,GAAK3jC,MAAMw7D,UAAUQ,SAASd,GAC7Cv3B,EAAWjpB,KAAKC,KAAK,GAAID,KAAKO,IAAI,GAAI0oB,IACtCzjC,KAAKy6D,qBAAqB/2B,EAAWD,GACrCzjC,KAAK6N,WxH+7eNnI,EwHh5eD22D,YAAA,SAAYt4B,GACX,GAAIA,EAAQ,CAGX,IAAMkT,EAASj3C,KAAKi3C,OACd1c,EAAW,IAAIz6B,MAAMkkC,QAAQ,EAAG,GAAIiT,GACpChT,EAAa,IAAInkC,MAAMokC,WAAWH,EAAO,GAAIA,EAAO,GAAIA,EAAO,GAAIA,EAAO,IAChFxJ,EAAS+hC,gBAAgBr4B,GACzB,IAAMw3B,EAAU,IAAI37D,MAAMkkC,QAAQzJ,EAASjrB,EAAGirB,EAASoL,EAAGpL,EAAS+G,GAAGo6B,YAAY5kB,eAAeG,GAC3FikB,EAAQ1gD,KAAKohD,MAAMH,EAAQn6B,EAAGm6B,EAAQnsD,GACtC0rD,EAAMxgD,KAAK4hD,KAAKX,EAAQ91B,EAAIsR,GAC9BvT,EAAY5jC,MAAMw7D,UAAUQ,SAASZ,GACzCx3B,GAAaA,EAAY,EAAI,IAAMA,EAAYA,GAAa,IAC5D,IAAID,EAAW,GAAK3jC,MAAMw7D,UAAUQ,SAASd,GAC7Cv3B,EAAWjpB,KAAKC,KAAK,GAAID,KAAKO,IAAI,GAAI0oB,IACtCzjC,KAAKy6D,qBAAqB/2B,EAAWD,GACrCzjC,KAAK6N,WxHo5eCmsD,EwHttfYA,GCrBRuC,GAAI,EAAI,EACRxM,GAAS,CAAC,SAAU,SAAU,MAAU,MAAU,SAAU,UAE5DyM,GAAb,WAAA,IAAA92D,EAAA82D,EAAAj6D,UA0EC,SAAAi6D,IACC,IAAM/Q,EAAW+Q,EAAmB/Q,SAC9BC,EAAW,IAAI5rD,MAAMyxD,qBAAqB,CAE/C1F,MAAO,SACPuJ,KAAMt1D,MAAMu1D,aAECr1D,KAAKkK,MAAQ,IAAIpK,MAAMssD,KAAKX,EAAUC,GAjFtD,OAAAhmD,EAOC+2D,UAAA,SAAUtiD,EAAQxY,EAAGikD,GAAO,IAAA3hD,EAAAjE,KAC3BA,KAAKma,OAASA,EACd,IAAIohB,EAAGnrB,EAAGssD,EAAG92B,EAAG8c,EAAGia,EAAIC,EACnBhX,EAAQ,GAEXx1C,EAAI,EACJssD,EAAI/6D,EAGJg7D,EAAK,EACLC,GAFAla,GADA9c,EAAI,KAHJrK,EAAI,IAIIghC,IAEC,EAAK3W,EAAQlD,EAAK,EAC3B1iD,KAAKkK,MAAMqwB,SAAS/zB,IAAIm2D,EAAIC,EAAKla,EAAI/gD,EATN,QAW/B45B,EAAI,GACJnrB,EAAIzO,EAAI,EACR+6D,EAAIliD,KAAKoK,MAAMjjB,EAAI,GAGnBg7D,IAFA/2B,EAAI,IAAWrK,GAEL,EACVqhC,GAFAla,EAAI9c,EAAI22B,IAEC,EAAK/hD,KAAKqiD,KAAKjX,EAAQ,GAAKlD,EAAK,EAC1C1iD,KAAKkK,MAAMqwB,SAAS/zB,IAAIm2D,EAAKvsD,EAAIw1B,EAAGg3B,EAAKF,EAAIha,EAlBd,OAoBhC1iD,KAAKkK,MAAMi6B,MAAM39B,IAAI+0B,EAAGA,EAAGA,GAEL,iBAAXphB,EACVna,KAAKkK,MAAMwhD,SAASG,MAAMrlD,IAAIupD,GAAOpuD,EAAIouD,GAAOnuD,SAE5CuY,EAAO/P,SACVpK,KAAKkK,MAAMwhD,SAASr8C,IAAM8K,EAAO/P,QACjCpK,KAAKkK,MAAMwhD,SAAShB,aAAc,GAElC1qD,KAAK88D,iBAAiB3iD,EAAOgC,SAAS,SAAC/R,GACtC+P,EAAO/P,QAAUA,EACjBnG,EAAKiG,MAAMwhD,SAASr8C,IAAMjF,EAC1BnG,EAAKiG,MAAMwhD,SAAShB,aAAc,MAzCvChlD,EA+CCo3D,iBAAA,SAAiB1/C,EAAU1E,GAC1B,IAAMjX,EAAM,WAAc2b,EACpBhV,EAAQvD,SAASC,cAAiBrD,EAA1B,UACd,GAAK2G,EAAL,CAGA,IAAM2iD,EAAY,WACjB,IAAM3gD,EAAU,IAAItK,MAAMqqD,aAAa/hD,GACvCgC,EAAQggD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UACxBpgD,EAAQqH,OAAS3R,MAAM2qD,UACvBrgD,EAAQsgD,aAAc,EACE,mBAAbhyC,GACVA,EAAStO,IAGXhC,EAAMud,YAAc,YAChBvd,EAAMqmC,YAAcrmC,EAAM4iD,iBAC7BD,IAEA3iD,EAAM6T,UAAY,WACjB8uC,OArEJ5oD,EAAAq6D,EAAA,KAAA,CAAA,CAAA/7D,IAAA,WAAA8D,IAAA,WAIE,OADiB,IAAIzE,MAAMi9D,oBAAoB,IAAU,IAAc,EAAG,OAH5EP,EAAA,GAsFqBQ,GAAAA,WAmBpB,SAAAA,IAAc,IAAAroD,EAAA3U,KACP0uD,EAAO1uD,KAAK0uD,KAAO,IAAI5uD,MAAM+yD,MAC7BoK,EAAQj9D,KAAKi9D,MAAQj9D,KAAKuD,SAChCmrD,EAAKriC,IAAI4wC,GACOj9D,KAAKoe,QAAU,GAC/BxE,EAAcG,SAAShE,WAAU,SAAAsH,GAChC1I,EAAK0I,QAAUA,KzHgyfhB,OArDAlb,EAAa66D,EAAc,CAAC,CAC1Bv8D,IAAK,UACL+F,IAAK,SyHpwfI6W,GAAS,IAAA7I,EAAAxU,KAEpBqd,EAAQnZ,SAAQ,SAACiW,EAAQxY,GACxB,IAAIia,EAASpH,EAAK4J,QAAQzc,GACrBia,IACJA,EAAS,IAAI4gD,IAEd5gD,EAAO6gD,UAAUtiD,EAAQxY,EAAG0b,EAAQzb,QACpC4S,EAAKyoD,MAAM5wC,IAAIzQ,EAAO1R,OACtBsK,EAAK4J,QAAQzc,GAAKia,KAEnB,IAAK,IAAIja,EAAI0b,EAAQzb,OAAQD,EAAI3B,KAAKoe,QAAQxc,OAAQD,IACrD3B,KAAKi9D,MAAM5yD,OAAOrK,KAAKoe,QAAQzc,GAAGuI,OAEnClK,KAAKoe,QAAQxc,OAASyb,EAAQzb,WzH4xfhBo7D,EAAaz6D,UyH/wf5BgB,OAAA,WACC,IAAMkoD,EAAW,IAAI3rD,MAAM6rD,kBAAkB,IAAU,IAAU,KAAU,EAAG,EAAG,GAC3ED,EAAW,IAAI5rD,MAAMyxD,qBAAqB,CAE/C1F,MAAO,UAEFoR,EAAQ,IAAIn9D,MAAMssD,KAAKX,EAAUC,GAEvC,OADAuR,EAAMjmB,SAASxwC,KAAKgU,KAAK2zC,GAAK,EAAG,EAAG,GAC7B8O,GzHoxfAD,EyHzzfYA,GC3FfnmB,GAAS,IAAI/2C,MAAMkkC,QAEJk5B,GAAAA,WAEpB,SAAAA,EAAYrR,QAAmB,IAAnBA,IAAAA,EAAQ,WACnB,IAAMJ,EAAW,IAAI3rD,MAAMi9D,oBAAoB,IAAK,IAAK,EAAG,GAEtD3yD,GADS,IAAItK,MAAM4pD,eACFZ,KAAK/9C,EAAY1E,QAAQ,8BAC1CqlD,EAAW,IAAI5rD,MAAM8rD,kBAAkB,CAC5CC,MAAO,IAAI/rD,MAAMm1D,MAAMpJ,GACvBwB,WAAW,EACXgB,YAAY,EACZh/C,IAAKjF,EACLuqD,aAAa,EACbp8B,QAAS,KAEJm2B,EAAO1uD,KAAK0uD,KAAO,IAAI5uD,MAAMssD,KAAKX,EAAUC,GAClDgD,EAAKjkD,YAAcM,EAAYN,YAAYK,QAC3C4jD,EAAKn0B,SAAS/zB,KAAK,KAAS,KAAS,K1H25frC,IAAId,EAASw3D,EAAe36D,UAqB5B,OAnBAmD,E0H15fDmI,OAAA,WACC,GAAI0+C,GAAYW,sBAAuB,CACtC,IAAMwB,EAAO1uD,KAAK0uD,KACZn0B,EAAWgyB,GAAYW,sBAAsBF,aAAaG,MAAMrW,eAAe,KACrF4X,EAAKn0B,SAAS/zB,IAAI+zB,EAASjrB,EAAGirB,EAAS+G,EAAG/G,EAASoL,GACnD,IAAMpK,EAAImzB,EAAKn0B,SAAS34B,SAAW,GACnC8sD,EAAKvqB,MAAM39B,IAAI+0B,EAAGA,EAAGA,GACrBmzB,EAAK9X,OAAOC,M1H85fbnxC,E0H15fDy3D,YAAA,SAAY7tD,EAAGgyB,EAAGqE,GACjB,IAAM+oB,EAAO1uD,KAAK0uD,KAClBA,EAAKn0B,SAAS/zB,IAAI8I,EAAGgyB,EAAGqE,GAAGmR,eAAe,IAC1C,IAAMvb,EAAImzB,EAAKn0B,SAAS34B,SAAW,GACnC8sD,EAAKvqB,MAAM39B,IAAI+0B,EAAGA,EAAGA,GACrBmzB,EAAK9X,OAAOC,K1H65fLqmB,E0Hh8fYA,GCHRE,GAAb,SAAAh9C,GACC,SAAAg9C,EAAYC,GAAS,IAAAp5D,EAAA,OACpBA,EAAAmc,EAAAvc,KAAA7D,OAAAA,MACKq9D,QAAUA,EACfp5D,EAAKq5D,QAAU,GACfr5D,EAAKk9B,KAAO,GAJQl9B,EADtBb,EAAAg6D,EAAAh9C,GAAA,IAAA1a,EAAA03D,EAAA76D,UAAA,OAAAmD,EAQCmI,OAAA,WACC7N,KAAKu9D,gBACLv9D,KAAKw9D,cAVP93D,EAaC63D,cAAA,WAAgB,IAAA/oD,EAAAxU,KACfA,KAAKq9D,QAAQC,QAAQp5D,SAAQ,SAACoL,EAAG3N,GAChC,IAAM87D,EAAUnuD,EAAEmuD,QACZ/E,EAASlkD,EAAK8oD,QAAQ37D,KAAO6S,EAAK8oD,QAAQ37D,GAAK,IAAI+7D,GAAc/7D,EAAG6S,IACtEkkD,EAAO+E,UAAYA,IACtB/E,EAAO+E,QAAUA,EACbA,EACHjpD,EAAKsE,KAAK,QAAS4/C,QACEn3D,IAAX0R,QACVuB,EAAKsE,KAAK,UAAW4/C,QAtB1BhzD,EA4BC83D,WAAA,WAEC,IADA,IAAMr8B,EAAOnhC,KAAKq9D,QAAQl8B,KACjBx/B,EAAI,EAAGA,EAAIw/B,EAAKv/B,OAAQD,GAAK,EAAG,CACxC,IAAMuH,EAAQsR,KAAKoK,MAAMjjB,EAAI,GACvBg8D,EAAO39D,KAAKmhC,KAAKj4B,KAAWlJ,KAAKmhC,KAAKj4B,GAAS,IAAI00D,GAAY10D,EAAOlJ,OACtEsP,EAAI6xB,EAAKx/B,GACT2/B,EAAIH,EAAKx/B,EAAI,GACnB,GAAIg8D,EAAKruD,IAAMA,GAAKquD,EAAKr8B,IAAMA,EAAG,CAGjC,GAFAq8B,EAAKruD,EAAIA,EACTquD,EAAKr8B,EAAIA,EACL9mB,KAAKub,IAAIzmB,GAAKkL,KAAKub,IAAIuL,GAAI,CAC9B,IAAMhJ,EAAOhpB,GAAK,IACZ2/C,EAAQ3/C,EAAI,IACdquD,EAAKrlC,OAASA,IACjBqlC,EAAKrlC,KAAOA,EACZt4B,KAAK8Y,KAAMwf,EAAO,OAAS,OAASqlC,IAGjCA,EAAK1O,QAAUA,IAClB0O,EAAK1O,MAAQA,EACbjvD,KAAK8Y,KAAMm2C,EAAQ,QAAU,OAAS0O,QAGjC,CACN,IAAMnoB,EAAKlU,GAAK,IACVoU,EAAOpU,EAAI,IACbq8B,EAAKnoB,KAAOA,IACfmoB,EAAKnoB,GAAKA,EACVx1C,KAAK8Y,KAAM08B,EAAK,KAAO,OAASmoB,IAG7BA,EAAKjoB,OAASA,IACjBioB,EAAKjoB,KAAOA,EACZ11C,KAAK8Y,KAAM48B,EAAO,OAAS,OAASioB,IAItC39D,KAAK8Y,KAAK,OAAQ6kD,MAjEtBj4D,EAsECm4D,SAAA,SAASpG,EAAgBhrB,QAAe,IAA/BgrB,IAAAA,EAAW,SAAoB,IAAfhrB,IAAAA,EAAW,IAEnC,IAAMqxB,EAAY99D,KAAKq9D,QAAQU,gBAC/B,OAAID,GAAaA,EAAUl8D,OACnBk8D,EAAU,GAAGE,MAAMvG,EAAUhrB,GAE7B1rC,QAAQT,UA5ElB88D,EAAA,CCFqB7kD,WAEpB,SAAAA,IACCvY,KAAKwY,OAAS,G5Hw8fd,IAAI9S,EAAS6S,EAAUhW,UA2CvB,OAzCAmD,E4Hv8fD+S,GAAA,SAAGnI,EAAMoI,GAAU,IAAAzU,EAAAjE,KACZ2Y,EAAQ3Y,KAAKwY,OAAOlI,GAAQtQ,KAAKwY,OAAOlI,IAAS,GAEvD,OADAqI,EAAMxV,KAAKuV,GACJ,WACNzU,EAAKuU,OAAOlI,GAAQqI,EAAM3V,QAAO,SAAAsM,GAAC,OAAIA,IAAMoJ,O5H+8f7ChT,E4H38fDkT,IAAA,SAAItI,EAAMoI,GACT,IAAMC,EAAQ3Y,KAAKwY,OAAOlI,GACtBqI,IACH3Y,KAAKwY,OAAOlI,GAAQqI,EAAM3V,QAAO,SAAAsM,GAAC,OAAIA,IAAMoJ,O5Hk9f7ChT,E4H98fDoT,KAAA,SAAKxI,EAAMkB,GACV,IAAMmH,EAAQ3Y,KAAKwY,OAAOlI,GACtBqI,GACHA,EAAMzU,SAAQ,SAAAwU,GAEbA,EAASlH,MAGX,IAAMuH,EAAY/Y,KAAKwY,OAAOO,UAC1BA,GACHA,EAAU7U,SAAQ,SAAAwU,GACjBA,EAASpI,EAAMkB,O5Hs9fV+G,E4Ht/fYA,IDmFfmlD,GACL,SAAYx0D,EAAOm0D,GAClBr9D,KAAKkJ,MAAQA,EACblJ,KAAKq9D,QAAUA,EACfr9D,KAAKy9D,SAAU,GAIXG,GAAAA,SAAAA,GACL,SAAAA,EAAY10D,EAAOm0D,GAAS,IAAA1oD,EAAA,OAC3BA,EAAAspD,EAAAp6D,KAAA7D,OAAAA,MACKkJ,MAAQA,EACbyL,EAAK0oD,QAAUA,EACf1oD,EAAK2jB,KAAO3jB,EAAKs6C,MAAQt6C,EAAK6gC,GAAK7gC,EAAK+gC,MAAO,EAJpB/gC,E3HyhgB3B,OAZAvR,EAAew6D,EAAaK,GAYrBL,E2H1hgBHA,CAAoB99D,MAAMuhC,SEvF1B68B,GAAY,CAChBC,WAAYl8D,OAAOiqD,OAAO,CACxBnoC,KAAM,OACNq6C,KAAM,OACNC,MAAO,UAGTC,eAAgBr8D,OAAOiqD,OAAO,CAC5BqS,QAAS,UACTC,QAAS,UACTC,QAAS,YAGXC,kBAAmBz8D,OAAOiqD,OAAO,CAC/ByS,OAAQ,SACRC,OAAQ,QACRC,OAAQ,QACRC,MAAO,UAGTC,cAAe98D,OAAOiqD,OAAO,CAC3B8S,QAAS,UACTC,QAAS,UACTC,SAAU,WACVC,WAAY,aACZR,OAAQ,WAGVS,qBAAsB,IAEtBC,mBAAoB,GAEpBC,uBAAwBr9D,OAAOiqD,OAAO,CACpCqT,UAAW,YACXC,WAAY,gB7HungBhB,S6H/mgBeC,GAAAA,G7HgngBb,OAAOC,GAAer+D,MAAMrB,KAAMoB,WAGpC,SAASs+D,KA8BP,OA7BAA,GAAiBz+D,EAAgC0+D,mBAAmBC,M6HpngBtE,SAAAC,EAA6B55D,GAA7B,IAAAgM,EAAA,OAAA0tD,mBAAAG,MAAA,SAAAC,GAAA,OAAA,OAAAA,EAAAC,KAAAD,EAAA9rD,MAAA,KAAA,EAAA,OAAA8rD,EAAA9rD,KAAA,EACyBrC,MAAM3L,GAD/B,KAAA,EAAA,IACQgM,EADR8tD,EAAAE,MAEgB5tD,GAFhB,CAAA0tD,EAAA9rD,KAAA,EAAA,MAAA,MAGU,IAAI4pC,MAAM5rC,EAASmB,YAH7B,KAAA,EAAA,OAAA2sD,EAAAG,OAAA,SAKWjuD,EAASlG,QALpB,KAAA,EAAA,IAAA,MAAA,OAAAg0D,EAAAriD,UAAAmiD,Q7HipgBwBx+D,MAAMrB,KAAMoB,WAGpC,S6H3ogBe++D,GAAAA,G7H4ogBb,OAAOC,GAAmB/+D,MAAMrB,KAAMoB,WAGxC,SAASg/D,KA8BP,OA7BAA,GAAqBn/D,EAAgC0+D,mBAAmBC,M6HhpgB1E,SAAAS,EAAiCC,GAAjC,IAAAC,EAAA,OAAAZ,mBAAAG,MAAA,SAAAU,GAAA,OAAA,OAAAA,EAAAR,KAAAQ,EAAAvsD,MAAA,KAAA,EAAA,GACOqsD,EADP,CAAAE,EAAAvsD,KAAA,EAAA,MAAA,MAEU,IAAI4pC,MAAM,wBAFpB,KAAA,EAAA,MAK8B,oBAL9B2iB,EAAAvsD,KAAA,EAM6BwrD,GAAiBa,EAAAA,sBAN9C,KAAA,EAAA,OAMQC,EANRC,EAAAP,KAAAO,EAAAN,OAAA,SAOSK,GAPT,KAAA,EAAA,IAAA,MAAA,OAAAC,EAAA9iD,UAAA2iD,Q7H6qgB4Bh/D,MAAMrB,KAAMoB,WASxC,SAASq/D,KA0HP,OAzHAA,GAAgBx/D,EAAgC0+D,mBAAmBC,M6H7qgBrE,SAAAc,EAA4BC,EAAeL,EAAUM,EAAuBC,GAA5E,IAAAC,EAAAp8C,EAAAq8C,EAAAtiD,EAAAuiD,EAAAC,EAAA,OAAAtB,mBAAAG,MAAA,SAAAoB,GAAA,OAAA,OAAAA,EAAAlB,KAAAkB,EAAAjtD,MAAA,KAAA,EAAA,QAAA,IAAqD2sD,IAAAA,EAAiB,WAAtE,IAA4EC,IAAAA,GAAe,GACpFF,EADP,CAAAO,EAAAjtD,KAAA,EAAA,MAAA,MAEU,IAAI4pC,MAAM,6BAFpB,KAAA,EAAA,GAKOyiB,EALP,CAAAY,EAAAjtD,KAAA,EAAA,MAAA,MAMU,IAAI4pC,MAAM,wBANpB,KAAA,EAAA,OAAAqjB,EAAAjtD,KAAA,EAUsCksD,GAAkBG,GAVxD,KAAA,EAAA,GAUQQ,EAVRI,EAAAjB,KAcEU,EAAcQ,SAASC,MAAK,SAACC,GAC3B,IAAMN,EAAmBD,EAAsBO,GAQ/C,OAPIN,IACFr8C,EAAQ,CACN28C,UAAAA,EACAC,YAAgBhB,EAAL,IAAiBS,EAAiB96D,KAC7Cs7D,aAAcR,EAAiBQ,eAG1B78C,KAGNA,EA1BP,CAAAw8C,EAAAjtD,KAAA,GAAA,MAAA,GA2BS2sD,EA3BT,CAAAM,EAAAjtD,KAAA,GAAA,MAAA,MA4BY,IAAI4pC,MAAM,kCA5BtB,KAAA,GAAA,GA+BUkjB,EAAmBD,EAAsBF,GA/BnD,CAAAM,EAAAjtD,KAAA,GAAA,MAAA,MAiCY,IAAI4pC,MAAJ,uDAAiE+iB,EAAjE,cAjCZ,KAAA,GAoCIl8C,EAAQ,CACN28C,UAAWT,EACXU,YAAgBhB,EAAL,IAAiBS,EAAiB96D,KAC7Cs7D,aAAcR,EAAiBQ,YAvCrC,KAAA,GAAA,OAAAL,EAAAjtD,KAAA,GA2CwBwrD,GAAc/6C,EAAM48C,aA3C5C,KAAA,GAAA,GA2CQ7iD,EA3CRyiD,EAAAjB,MA8CMY,EA9CN,CAAAK,EAAAjtD,KAAA,GAAA,MAAA,GAiDMgtD,EAD+B,QAA7BN,EAAca,WACP/iD,EAAQgjD,QAAQx/D,OAAOY,KAAK4b,EAAQgjD,SAAS,IAE7ChjD,EAAQgjD,QAAQd,EAAca,YAnD7C,CAAAN,EAAAjtD,KAAA,GAAA,MAAA,MAsDY,IAAI4pC,MAAJ,2BACuB8iB,EAAca,WADrC,gBAC+D98C,EAAM28C,WAvDjF,KAAA,GA2DQJ,EAAOD,YACTA,EAAYt8C,EAAM48C,YAAYl7D,QAAQ,eAAgB66D,EAAOD,YA5DnE,KAAA,GAAA,OAAAE,EAAAhB,OAAA,SAgES,CAAEzhD,QAAAA,EAASuiD,UAAAA,IAhEpB,KAAA,GAAA,IAAA,MAAA,OAAAE,EAAAxjD,UAAAgjD,Q7HsygBuBr/D,MAAMrB,KAAMoB,W6HlugBnC,IAAMsgE,GAAyB,CAC7BC,MAAO,EACPC,MAAO,EACPlJ,OAAQ,EACRtjD,MAAO8oD,GAAUI,eAAeC,S7HuxgBlC,I6H9ugBMsD,GAAAA,WACJ,SAAAA,EAAYC,GACV9hE,KAAK+hE,kBAAoBD,EAA0BC,kBACnD/hE,KAAKgiE,OAASF,EAA0BE,OACxChiE,KAAKiiE,cAAgBH,EAA0BG,cAC/CjiE,KAAKkiE,kBAAoBJ,EAA0BI,kBAE/CliE,KAAKkiE,oBAAsBhE,GAAUoB,uBAAuBC,YAC9Dv/D,KAAKmiE,YAAcL,EAA0BK,YAC7CniE,KAAKoiE,YAAcN,EAA0BM,aAI/CpiE,KAAKY,MAAQ,EACbZ,KAAKqiE,oBAAoBX,I7HiygB3B,OAvCaG,EAAet/D,U6H/ugB5B8/D,oBAAA,SAAAluC,GAEG,IADDwtC,EACCxtC,EADDwtC,MAAOC,EACNztC,EADMytC,MAAOlJ,EACbvkC,EADaukC,OAAQtjD,EACrB+e,EADqB/e,MACrBktD,EAzDL,SAAuBhzD,EAAOgyB,QAAO,IAAdhyB,IAAAA,EAAI,QAAU,IAAPgyB,IAAAA,EAAI,GAChC,IAAIqgC,EAAQryD,EACRsyD,EAAQtgC,EAKZ,GADmB9mB,KAAK0b,KAAM5mB,EAAIA,EAAMgyB,EAAIA,GAC3B,EAAG,CAClB,IAAM45B,EAAQ1gD,KAAKohD,MAAMt6B,EAAGhyB,GAC5BqyD,EAAQnnD,KAAKs3C,IAAIoJ,GACjB0G,EAAQpnD,KAAKo3C,IAAIsJ,GASnB,MAJe,CACbqH,gBAA0B,GAARZ,EAAe,GACjCa,gBAA0B,GAARZ,EAAe,IAyCYa,CAAcd,EAAOC,GAA1DW,EADPD,EACOC,gBAAiBC,EADxBF,EACwBE,gBACzB,OAAQxiE,KAAK+hE,mBACX,KAAK7D,GAAUQ,kBAAkBE,OAC/B5+D,KAAKY,MAASZ,KAAKgiE,OAAOU,SAASttD,GAAUmtD,EAAkB,GAC/D,MACF,KAAKrE,GAAUQ,kBAAkBG,OAC/B7+D,KAAKY,MAASZ,KAAKgiE,OAAOU,SAASttD,GAAUotD,EAAkB,GAC/D,MACF,KAAKtE,GAAUQ,kBAAkBC,OAC/B3+D,KAAKY,MAASZ,KAAKgiE,OAAOU,SAASttD,GAAUsjD,EAAS,EACtD,MACF,KAAKwF,GAAUQ,kBAAkBI,MAC3B9+D,KAAKkiE,oBAAsBhE,GAAUoB,uBAAuBE,WAC9Dx/D,KAAKY,MAASZ,KAAKgiE,OAAOU,SAASttD,GAEnCpV,KAAKY,MAAQZ,KAAKgiE,OAAOU,SAASttD,GAAS,EAAM,EAEnD,MACF,QACE,MAAM,IAAIyoC,MAAJ,+CAAyD79C,KAAK+hE,qB7HgwgBnEF,E6H/ygBHA,GAoDA90D,GAAAA,WAKJ,SAAAA,EAAY41D,EAAaC,GAAsB,IAAA3+D,EAAAjE,KAC7C,KAAK2iE,GACAC,GACAA,EAAqBC,iBACrBD,EAAqBE,gBACsC,IAA5D7gE,OAAOY,KAAK+/D,EAAqBE,gBAAgBlhE,QACnD,MAAM,IAAIi8C,MAAM,8BAGlB79C,KAAKgR,GAAK2xD,EACV3iE,KAAKsQ,KAAOsyD,EAAqBtyD,KACjCtQ,KAAK+iE,aAAeH,EAAqBG,aACzC/iE,KAAKgjE,mBAAqBJ,EAAqBI,mBAG/ChjE,KAAK6iE,gBAAkB,GACvB5gE,OAAOY,KAAK+/D,EAAqBC,iBAAiB3+D,SAAQ,SAAC++D,GACzD,IAAMC,EAAiB,IAAIrB,GAAee,EAAqBC,gBAAgBI,IAC/Eh/D,EAAK4+D,gBAAgBI,GAAgBC,KAIvCljE,KAAK8iE,eAAiB7gE,OAAO8D,OAAO,GAAI68D,EAAqBE,gBAE7D9iE,KAAKq3C,OAAS,CACZjiC,MAAO8oD,GAAUI,eAAeC,QAChC7F,YAAwCn3D,IAA/BvB,KAAK8iE,eAAepK,OAAwB,OAAIn3D,EACzDogE,WAAsCpgE,IAA9BvB,KAAK8iE,eAAenB,MAAuB,OAAIpgE,EACvDqgE,WAAsCrgE,IAA9BvB,KAAK8iE,eAAelB,MAAuB,OAAIrgE,G7H6zgB3D,OAhEcwL,EAAUxK,U6HhvgBxB4gE,kBAAA,SAAkB9F,GAAS,IAAA7oD,EAAAxU,KAKzB,GAHAA,KAAKq3C,OAAOjiC,MAAQ8oD,GAAUI,eAAeC,aAGVh9D,IAA/BvB,KAAK8iE,eAAepK,QACjB2E,EAAQC,QAAQ17D,OAAS5B,KAAK8iE,eAAepK,OAAQ,CAC1D,IAAM0K,EAAgB/F,EAAQC,QAAQt9D,KAAK8iE,eAAepK,QAC1D14D,KAAKq3C,OAAOqhB,OAAS0K,EAAcxiE,MACnCZ,KAAKq3C,OAAOqhB,OAAU14D,KAAKq3C,OAAOqhB,OAAS,EAAK,EAAI14D,KAAKq3C,OAAOqhB,OAChE14D,KAAKq3C,OAAOqhB,OAAU14D,KAAKq3C,OAAOqhB,OAAS,EAAK,EAAI14D,KAAKq3C,OAAOqhB,OAG5D0K,EAAc3F,SAAkC,IAAvBz9D,KAAKq3C,OAAOqhB,OACvC14D,KAAKq3C,OAAOjiC,MAAQ8oD,GAAUI,eAAeG,SACpC2E,EAAc9rD,SAAWtX,KAAKq3C,OAAOqhB,OAASwF,GAAUkB,wBACjEp/D,KAAKq3C,OAAOjiC,MAAQ8oD,GAAUI,eAAeE,cAKfj9D,IAA9BvB,KAAK8iE,eAAenB,OACjBtE,EAAQl8B,KAAKv/B,OAAS5B,KAAK8iE,eAAenB,QAC/C3hE,KAAKq3C,OAAOsqB,MAAQtE,EAAQl8B,KAAKnhC,KAAK8iE,eAAenB,OACrD3hE,KAAKq3C,OAAOsqB,MAAS3hE,KAAKq3C,OAAOsqB,OAAS,GAAM,EAAI3hE,KAAKq3C,OAAOsqB,MAChE3hE,KAAKq3C,OAAOsqB,MAAS3hE,KAAKq3C,OAAOsqB,MAAQ,EAAK,EAAI3hE,KAAKq3C,OAAOsqB,MAG1D3hE,KAAKq3C,OAAOjiC,QAAU8oD,GAAUI,eAAeC,SAC9C/jD,KAAKub,IAAI/1B,KAAKq3C,OAAOsqB,OAASzD,GAAUmB,qBAC3Cr/D,KAAKq3C,OAAOjiC,MAAQ8oD,GAAUI,eAAeE,eAKfj9D,IAA9BvB,KAAK8iE,eAAelB,OACjBvE,EAAQl8B,KAAKv/B,OAAS5B,KAAK8iE,eAAelB,QAC/C5hE,KAAKq3C,OAAOuqB,MAAQvE,EAAQl8B,KAAKnhC,KAAK8iE,eAAelB,OACrD5hE,KAAKq3C,OAAOuqB,MAAS5hE,KAAKq3C,OAAOuqB,OAAS,GAAM,EAAI5hE,KAAKq3C,OAAOuqB,MAChE5hE,KAAKq3C,OAAOuqB,MAAS5hE,KAAKq3C,OAAOuqB,MAAQ,EAAK,EAAI5hE,KAAKq3C,OAAOuqB,MAG1D5hE,KAAKq3C,OAAOjiC,QAAU8oD,GAAUI,eAAeC,SAC9C/jD,KAAKub,IAAI/1B,KAAKq3C,OAAOuqB,OAAS1D,GAAUmB,qBAC3Cr/D,KAAKq3C,OAAOjiC,MAAQ8oD,GAAUI,eAAeE,UAKjDv8D,OAAOo1C,OAAOr3C,KAAK6iE,iBAAiB3+D,SAAQ,SAACg/D,GAC3CA,EAAeb,oBAAoB7tD,EAAK6iC,Y7HmvgB5Cl1C,EAAa4K,EAAW,CAAC,CACvBtM,IAAK,OACL8D,IAAK,W6H9ygBL,O7HtLJ,SAAwB9C,GACtB,IAAK,IAAIE,EAAI,EAAGA,EAAIP,UAAUQ,OAAQD,IAAK,CACzC,IAAIqC,EAAyB,MAAhB5C,UAAUO,GAAaP,UAAUO,GAAK,GAE/CA,EAAI,EACNe,EAAQT,OAAO+B,IAAS,GAAME,SAAQ,SAAUzD,GAC9C+B,EAAgBf,EAAQhB,EAAKuD,EAAOvD,OAE7BwB,OAAOohE,0BAChBphE,OAAOqhE,iBAAiB7hE,EAAQQ,OAAOohE,0BAA0Br/D,IAEjEtB,EAAQT,OAAO+B,IAASE,SAAQ,SAAUzD,GACxCwB,OAAOC,eAAeT,EAAQhB,EAAKwB,OAAOiB,yBAAyBc,EAAQvD,OAKjF,OAAOgB,E6HoKK8hE,CAAA,CAAKvyD,GAAIhR,KAAKgR,IAAOhR,KAAKq3C,Y7HwzgB/BtqC,E6H91gBHA,GA0GAy2D,GAAAA,WAMJ,SAAAA,EAAY7C,EAAeliD,EAASglD,GAAU,IAAA9uD,EAAA3U,KAC5C,IAAK2gE,EACH,MAAM,IAAI9iB,MAAM,6BAGlB,IAAKp/B,EACH,MAAM,IAAIo/B,MAAM,uBAGlB79C,KAAK2gE,cAAgBA,EACrB3gE,KAAKyjE,SAAWA,EAChBzjE,KAAKgR,GAAKyN,EAAQ4iD,UAGlBrhE,KAAK0jE,kBAAoBjlD,EAAQgjD,QAAQd,EAAca,YACvDxhE,KAAK85B,WAAa,GAClB73B,OAAOY,KAAK7C,KAAK0jE,kBAAkB5pC,YAAY51B,SAAQ,SAACy+D,GACtD,IAAMC,EAAuBjuD,EAAK+uD,kBAAkB5pC,WAAW6oC,GAC/DhuD,EAAKmlB,WAAW6oC,GAAe,IAAI51D,GAAU41D,EAAaC,MAI5D5iE,KAAKmjE,oB7HsygBP,OAtCcK,EAAiBjhE,U6HvugB/B4gE,kBAAA,WAAoB,IAAAtuD,EAAA7U,KAClBiC,OAAOo1C,OAAOr3C,KAAK85B,YAAY51B,SAAQ,SAACy/D,GACtCA,EAAUR,kBAAkBtuD,EAAK8rD,cAActD,a7HkvgBnDl7D,EAAaqhE,EAAkB,CAAC,CAC9B/iE,IAAK,YACL8D,IAAK,W6H3wgBL,OAAOvE,KAAK2gE,cAAciD,Y7H8wgBzB,CACDnjE,IAAK,iBACL8D,IAAK,W6H5wgBL,OAAOvE,KAAK2gE,cAAckD,iB7HmxgBzB,CACDpjE,IAAK,OACL8D,IAAK,W6H9wgBL,IAAMiN,EAAO,GAIb,OAHAvP,OAAOo1C,OAAOr3C,KAAK85B,YAAY51B,SAAQ,SAACy/D,GACtCnyD,EAAKrO,KAAKwgE,EAAUnyD,SAEfA,M7HmxgBFgyD,E6Hl0gBHA,GCxUN,SAASM,KACRhkE,MAAM42C,SAAS7yC,KAAK7D,MACpBA,KAAK+jE,iBAAmB,KACxB/jE,KAAK4pD,OAAS,KA+Jf,SAASoa,GAA+BC,EAAiBz+B,IApEzD,SAAmBu+B,EAAkBv+B,GAGpCvjC,OAAOo1C,OAAO0sB,EAAiBjqC,YAAY51B,SAAQ,SAACy/D,GAAc,IAEzDrzD,EAA8CqzD,EAA9CrzD,KAAM0yD,EAAwCW,EAAxCX,mBAAoBH,EAAoBc,EAApBd,gBAElC,GAAIvyD,IAAS4zD,GAA0BnF,cAAcG,SAGpD,GADAyE,EAAUQ,eAAiB3+B,EAAM4+B,gBAAgBpB,GAC7CW,EAAUQ,eAAgB,CAG7B,IAAME,EAAiB,IAAIvkE,MAAMmuD,qBAAqB,MAChDvC,EAAW,IAAI5rD,MAAM8rD,kBAAkB,CAAEC,MAAO,MAChDyY,EAAS,IAAIxkE,MAAMssD,KAAKiY,EAAgB3Y,GAC9CiY,EAAUQ,eAAe93C,IAAIi4C,QAI7B79D,QAAQ6L,KAAR,6BAA0CqxD,EAAUX,mBAApD,2BAAiGW,EAAU3yD,IAO7G/O,OAAOo1C,OAAOwrB,GAAiB3+D,SAAQ,SAACg/D,GAAmB,IAElDjB,EAA+DiB,EAA/DjB,cAAeE,EAAgDe,EAAhDf,YAAaC,EAAmCc,EAAnCd,YAGpC,GAHuEc,EAAtBhB,oBAGvBgC,GAA0B5E,uBAAuBC,UAAW,CAMrF,GAJA2D,EAAeqB,QAAU/+B,EAAM4+B,gBAAgBjC,GAC/Ce,EAAesB,QAAUh/B,EAAM4+B,gBAAgBhC,IAG1Cc,EAAeqB,QAGnB,YADA99D,QAAQ6L,KAAR,kBAA+B6vD,EAA/B,iBAKD,IAAKe,EAAesB,QAGnB,YADA/9D,QAAQ6L,KAAR,kBAA+B8vD,EAA/B,iBAQFc,EAAeuB,UAAYj/B,EAAM4+B,gBAAgBnC,GAC5CiB,EAAeuB,WAEnBh+D,QAAQ6L,KAAR,kBAA+B2vD,EAA/B,uBAaHyC,CAAUT,EAAgBF,iBAAkBv+B,GAGxCy+B,EAAgBra,QAEnBpkB,EAAMm/B,UAAS,SAACC,GAEXA,EAAMC,SAETD,EAAMlZ,SAAS9B,OAASqa,EAAgBra,OACxCgb,EAAMlZ,SAAShB,aAAc,MAShCuZ,EAAgB53C,IAAImZ,GAlLrBs+B,GAAkBvhE,UAAYN,OAAO8D,OAAO9D,OAAOsB,OAAOzD,MAAM42C,SAASn0C,WAAY,CAEpFiB,YAAasgE,GAEbgB,kBAAmB,SAASlb,GAAQ,IAAA3lD,EAAAjE,KAEnC,OAAIA,KAAK4pD,QAAUA,IAMnB5pD,KAAK4pD,OAASA,EACd5pD,KAAK2kE,UAAS,SAACC,GAEVA,EAAMC,SAETD,EAAMlZ,SAAS9B,OAAS3lD,EAAK2lD,OAC7Bgb,EAAMlZ,SAAShB,aAAc,OAVvB1qD,MAwBT+kE,kBAAmB,SAASC,GAE3BllE,MAAM42C,SAASn0C,UAAUwiE,kBAAkBlhE,KAAK7D,KAAMglE,GAEjDhlE,KAAK+jE,mBAGV/jE,KAAK+jE,iBAAiBZ,oBAGtBlhE,OAAOo1C,OAAOr3C,KAAK+jE,iBAAiBjqC,YAAY51B,SAAQ,SAACy/D,GAGxD1hE,OAAOo1C,OAAOssB,EAAUd,iBAAiB3+D,SAAQ,SAACg/D,GAAmB,IAE5DuB,EAA0DvB,EAA1DuB,UAAWF,EAA+CrB,EAA/CqB,QAASC,EAAsCtB,EAAtCsB,QAAS5jE,EAA6BsiE,EAA7BtiE,MAAOshE,EAAsBgB,EAAtBhB,kBAIvCuC,IAGDvC,IAAsBgC,GAA0B5E,uBAAuBE,WAE1EiF,EAAUQ,QAAUrkE,EAEVshE,IAAsBgC,GAA0B5E,uBAAuBC,YAEjFz/D,MAAMokC,WAAWghC,MAChBX,EAAQtgC,WACRugC,EAAQvgC,WACRwgC,EAAUxgC,WACVrjC,GAGD6jE,EAAUlqC,SAAS4qC,YAClBZ,EAAQhqC,SACRiqC,EAAQjqC,SACR35B,eAgHN,IAAIwkE,GAA4B,WAE/B,SAASA,EAAyBC,QAAmB,IAAnBA,IAAAA,EAAa,MAE9CrlE,KAAKqlE,WAAaA,EAClBrlE,KAAKiG,KApMuB,8EAqM5BjG,KAAKslE,YAAc,GAGdtlE,KAAKqlE,aACTrlE,KAAKqlE,WAAa,IAAIvlE,MAAMylE,YAoF9B,OA/EAH,EAAyB7iE,UAAY,CAEpCiB,YAAa4hE,EAEbI,sBAAuB,SAASC,GAAY,IAAAjxD,EAAAxU,KAErCikE,EAAkB,IAAIH,GACxBt+B,EAAQ,KAkEZ,OAhEAigC,EAAWpuC,iBAAiB,aAAa,SAAC1e,GAEzC,IAAMgoD,EAAgBhoD,EAAMnH,KAEQ,oBAAhCmvD,EAAc+E,eAAwC/E,EAActD,S9HuggB5E,S6HtqgBesI,EAAAA,EAAAA,EAAAA,G7HuqgBb,OAAOlF,GAAcp/D,MAAMrB,KAAMoB,W8HtggB/BukE,CAAahF,EAAensD,EAAKvO,KA5Nb,mBA4NoCjF,MAAK,SAAAmzB,GAA4B,IAAzB1V,EAAyB0V,EAAzB1V,QAASuiD,EAAgB7sC,EAAhB6sC,UAExEiD,EAAgBF,iBAAmB,IAAIP,GACtC7C,EACAliD,EACAuiD,GAGD,IAAI4E,EAAcpxD,EAAK8wD,YAAYrB,EAAgBF,iBAAiBN,UACpE,GAAImC,EAEHpgC,EAAQogC,EAAYpgC,MAAMjS,QAE1BywC,GAA+BC,EAAiBz+B,OAE1C,CAEN,IAAKhxB,EAAK6wD,WAET,MAAM,IAAIxnB,MAAJ,uBAIPrpC,EAAK6wD,WAAW1b,QAAQ,IACxBn1C,EAAK6wD,WAAWvc,KAAKmb,EAAgBF,iBAAiBN,UAAU,SAACtjC,GAEhE3rB,EAAK8wD,YAAYrB,EAAgBF,iBAAiBN,UAAYtjC,EAE9DqF,EAAQrF,EAAMqF,MAAMjS,QAEpBywC,GAA+BC,EAAiBz+B,KAGhD,MACA,WAEC,MAAM,IAAIqY,MAAJ,SAAmBomB,EAAgBF,iBAAiBN,SAApD,iCAMPjnD,OAAM,SAAClb,GAETmF,QAAQ6L,KAAKhR,SAMfmkE,EAAWpuC,iBAAiB,gBAAgB,WAE3C4sC,EAAgBF,iBAAmB,KACnCE,EAAgB55D,OAAOm7B,GACvBA,EAAQ,QAIFy+B,IAMFmB,EA9FwB,GC3K1BvuB,GAAS,IAAI/2C,MAAMkkC,QAIJ6hC,GAAAA,SAAAA,G/Ho0hBnB,SAASA,IACP,OAAOv5D,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAeyiE,EAAgBv5D,GAM/B,IAAI5G,EAASmgE,EAAetjE,UAssC5B,OApsCAmD,E+HjyhBD6G,OAAA,WAAS,IAAAtI,EAAAjE,KAERA,KAAKkJ,MAAQ,EACblJ,KAAK8lE,OAAS,KACd9lE,KAAKyN,QAAU,KACfzN,KAAK+lE,QAAU,KACf/lE,KAAKgmE,QAAU,GACfhmE,KAAKimE,cACLjmE,KAAK81C,UACL91C,KAAKwrC,eACLxrC,KAAKkmE,UACL5pB,GAAgBK,QAAQpqC,KACvBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAlT,GACXoB,EAAKpB,KAAOA,M/HsyhBb6C,E+HjyhBD8pB,UAAA,WACC,GAAIxvB,KAAK2J,KAAM,CACd,IAAMs3B,EAAWjhC,KAAK2J,KAAK61B,MAAMliB,MAAK,SAAAmiB,GAAI,OAAIA,EAAKwB,YAC/CA,GAAYA,EAASytB,MACI,UAAxB1uD,KAAK2J,KAAK2G,KAAKb,MAClBzP,KAAKmmE,MAAMvvB,OAAO3V,EAASytB,Q/H0yhB9BhpD,E+HpyhBDgyB,UAAA,WACC13B,KAAK8rC,kBACY9rC,KAAKulC,SACb6gC,kBAAiB,gB/HuyhB1B1gE,E+HpyhBDugE,YAAA,WAAc,IACLv5D,EAASC,EAAAA,WAAW3M,MAApB0M,KACR1M,KAAK8M,KAAO,CAAEwrB,KAAM,EAAGkC,IAAK,EAAG9e,MAAO,EAAGC,OAAQ,EAAG42C,OAAQ,GAC5DvyD,KAAKqmE,MAAQ,IAAIvmE,MAAMuhC,QACvBrhC,KAAKsmE,kBAAoB,IAAIxmE,MAAMymE,QACnCvmE,KAAKwmE,yBAA2B,IAAI1mE,MAAMkkC,QAC1ChkC,KAAKymE,0BAA4B,IAAI3mE,MAAMkkC,QAE3C,IAAM7X,EAAYnsB,KAAKmsB,UAAYzf,EAO7Bg6D,GANO1mE,KAAKW,KAAO+L,EAAK5H,cAAc,gBAE1B9E,KAAK2mE,UAAY3X,GAAKK,SAASljC,GAC9BnsB,KAAK4mE,WAAa,IAAI5X,GAGrBhvD,KAAK0mE,YAAc,IAAI5mE,MAAM+yD,OAG3C9uB,EAAS/jC,KAAK+jC,OAAS,IAAIsuB,GAAO,GAAIlmC,EAAU06C,YAAc16C,EAAUs6B,aAAc,IAAM,KAKlGigB,EAAYr6C,IAAI0X,GAChB2iC,EAAYjlE,OAAS,IAAI3B,MAAMkkC,QAEjBhkC,KAAKmmE,MAAQ,IAAInM,GAAaj2B,GAA5C,IAEMwB,EAAWvlC,KAAKulC,SAAW,IAAIzlC,MAAMmwD,cAAc,CACxDC,WAAW,EACXC,OAAO,EACPC,oBAAoB,EACpB0W,wBAAwB,IAGzBvhC,EAAS8qB,cAAc,EAAU,GACjC9qB,EAAS+qB,cAAc7rD,OAAO8rD,kBAC9BhrB,EAASmqB,QAAQvjC,EAAU06C,YAAa16C,EAAUs6B,cAClDlhB,EAASb,GAAGqiC,SAAU,EACtBxhC,EAASirB,YAAc1wD,MAAM2wD,sBAC7BlrB,EAASmrB,oBAAsB,GAC/BnrB,EAASorB,eAAiB7wD,MAAM8wD,aAK5BzkC,EAAUuQ,kBAAoB,EACjCvQ,EAAU66C,aAAazhC,EAASsrB,WAAY1kC,EAAUqxB,SAAS,IAE/DrxB,EAAU1Q,YAAY8pB,EAASsrB,aAGd7wD,KAAKysD,UAAY,IAAI3sD,MAAMmnE,WACnCC,cAAclnE,KAAKqmE,MAAOtiC,GAEpC,IAAMyB,EAAQxlC,KAAKwlC,MAAQ,IAAI1lC,MAAMixD,MACrCvrB,EAAMnZ,IAAIq6C,GAEV,IAAMS,EAAUnnE,KAAKmnE,QAAU,IAAIrnE,MAAM+yD,MACzCsU,EAAQ13D,KAAO,YACf+1B,EAAMnZ,IAAI86C,GAEV,IAAMv9D,EAAW5J,KAAK4J,SAAW,IAAIi1B,GACrCsoC,EAAQ96C,IAAIziB,EAAS8kD,MAEH1uD,KAAKonE,UAAY,IAAIlK,GAEvBl9D,KAAK8K,QAAU,IAAIoyD,GAAe,WAFlD,IAIMmK,EAAY,IAAIvnE,MAAMmxD,WAAW,UACvCoW,EAAU9sC,SAAS/zB,KAAK,GAAI,GAAI,IAChC2gE,EAAQ96C,IAAIg7C,GAEZ,IAAMC,EAAS,IAAIxnE,MAAMynE,iBAAiB,SAAU,KACpDD,EAAO/sC,SAAS/zB,IAAI,IAAK,GAAI,IAC7B8gE,EAAO7lE,OAAO84B,SAAS/zB,IAAI,EAAG,EAAG,GACjC2gE,EAAQ96C,IAAIi7C,GAEZ,IAAME,EAAS,IAAI1nE,MAAMynE,iBAAiB,SAAU,GACpDC,EAAOjtC,SAAS/zB,IAAI,EAAG,GAAI,GAC3BghE,EAAO/lE,OAAO84B,SAAS/zB,IAAI,EAAG,EAAG,GACjC2gE,EAAQ96C,IAAIm7C,GAEZ,IAAMxW,EAAQ,IAAIlxD,MAAM2nE,aAAa,SACrCN,EAAQ96C,IAAI2kC,GAEZhxD,KAAK0nE,iBAEL1nE,KAAKw7C,U/H+xhBL91C,E+H1xhBDiiE,kBAAA,SAAkBlwD,GACjB,IAAMmwD,EAAS,IAAI5X,GAAcv4C,GACjCzX,KAAKgmE,QAAQvuD,EAAQM,UAAY6vD,G/H6xhBjCliE,E+HzxhBDmiE,qBAAA,SAAqBpwD,GACLzX,KAAKgmE,QAAQvuD,EAAQM,iBAM7B/X,KAAKgmE,QAAQvuD,EAAQM,W/H6xhB5BrS,E+H1xhBDoiE,qBAAA,SAAqBrwD,GACpB,IAAMmwD,EAAS5nE,KAAKgmE,QAAQvuD,EAAQM,UAChC6vD,GACHA,EAAO/5D,OAAO4J,I/H+xhBf/R,E+H3xhBDowC,QAAA,WAAU,IAAAthC,EAAAxU,KACT,GAAKA,KAAK4J,SAAV,CAGA,IAAMD,EAAO3J,KAAK+nE,MAClB,GAAIp+D,EAAM,CACL3J,KAAKwiC,OACRxiC,KAAKwiC,MAAMt+B,SAAQ,SAAAyF,GAAI,cAAWA,EAAKioC,iBAExC,IAAMn6B,EAAUzX,KAAKgoE,kBACjBvwD,GACC9N,aAAgB82B,SAA0Cl/B,IAAtBkW,EAAQ4vB,YAC/C19B,EAAKo3B,OAAStpB,EAAQ4vB,WAGxB19B,EAAKs+D,OAAQ,EAGbjoE,KAAKuV,cACLvV,KAAK4J,SAAS4uB,OAAO7uB,EAAM3J,KAAKulC,UAAU,SAACqkB,EAAQx/C,EAASqkD,GAE3Dj6C,EAAKgxB,MAAMz6B,YAAc6+C,EACzBjgD,EAAKs+D,OAAQ,EACbt+D,EAAKioC,cAAgB,WACpBp9B,EAAK0zD,wBAGN1zD,EAAKe,iBAEH,SAAC5L,GACH6K,EAAK2zD,mBAAmBx+D,S/H6yhB1BjE,E+HtyhBDwiE,qBAAA,WAAuB,IAAAvzD,EAAA3U,KAClBA,KAAK4J,UACR5J,KAAK4J,SAASglD,UAAU5uD,KAAK2J,KAAM3J,KAAKulC,UAAU,SAACqkB,EAAQx/C,EAASqkD,GACnE95C,EAAK6wB,MAAMz6B,YAAc6+C,M/H6yhB3BlkD,E+HxyhBDyiE,mBAAA,SAAmBx+D,GAClB,IAAM8N,EAAUzX,KAAKgoE,kBACrBhoE,KAAKgoE,kBAAoB,KACrBhoE,KAAKmmE,QACRnmE,KAAKmmE,MAAM9qD,KAAO1R,EAAK2G,KAAKb,KACvBzP,KAAKulC,SAASb,GAAG0jC,eACjB3wD,GACHzX,KAAKmmE,MAAMrL,eAAerjD,EAAQ+rB,aAClCxjC,KAAKmmE,MAAM7uB,KAAO7/B,EAAQ6/B,KAC1Bt3C,KAAK+jC,OAAOw3B,0BACD5xD,EAAKk5B,kBAChB7iC,KAAKmmE,MAAMrL,eAAenxD,EAAK65B,aAC/BxjC,KAAKmmE,MAAM7uB,KAAO3tC,EAAK2tC,KACvBt3C,KAAK+jC,OAAOw3B,6B/HgzhBf71D,E+H1yhBDgiE,eAAA,WACC,IAAMW,EAAkBroE,KAAKqoE,gBAAkB,IAAIvoE,MAAM+yD,MACzD7yD,KAAKsoE,YAAc,GACnBtoE,KAAKuoE,uBAAyB,IAAInD,GAClCplE,KAAKwoE,cAAc,GACnBxoE,KAAKwoE,cAAc,GACnBxoE,KAAK0mE,YAAYr6C,IAAIg8C,I/H6yhBrB3iE,E+H1yhBD8iE,cAAA,SAAct/D,GAAO,IAAA2L,EAAA7U,KACdyoE,EAAyBtwD,EAAa/C,MAAMmxB,KAC5ChB,EAAWvlC,KAAKulC,SAChB8iC,EAAkBroE,KAAKqoE,gBACvB5C,EAAalgC,EAASb,GAAGgkC,cAAcx/D,GACvCq/D,EAAyBvoE,KAAKuoE,uBACpC9C,EAAWh2D,KAAX,eAAgCvG,EAAQ,GAAxC,IACAm/D,EAAgBh8C,IAAIo5C,GACpB,IAaMkD,EAAU,SAAChwD,GAOhB,OAAOA,EAAMzP,OACZ,KAAK,EAGL,KAAK,EAEJ,MACD,KAAK,EAEJsO,EAAe+T,KAAK,CACnBjb,KAAM2O,OAKJ2pD,EAAY,SAACjwD,GAClB9D,EAAKg0D,aAEAC,EAAS,SAACnwD,GAGf9D,EAAK6xD,YAAY1vB,SAAS1V,GAAK9mB,KAAK2zC,GAAK,IAAM,IAE1C4a,EAAU,SAACpwD,GAGhB9D,EAAK6xD,YAAY1vB,SAAS1V,GAAK9mB,KAAK2zC,GAAK,IAAM,IAS1C6a,EAAS,SAACrwD,GAGf9D,EAAKo0D,gBAAgBtwD,EAAM2oB,IA8D5BmkC,EAAWpuC,iBAAiB,eApHN,SAAC1e,GACtB8sD,EAAWyD,SAASC,aAAc,EALb,SAAC1D,GAEtB5wD,EAAK4wD,WAAaA,EAIlB2D,CAAc3D,MAmHfA,EAAWpuC,iBAAiB,aAjHR,SAAC1e,GACpB8sD,EAAWyD,SAASC,aAAc,KAiHnC1D,EAAWpuC,iBAAiB,aA1CR,SAAC1e,GAEpB,GADA8sD,EAAWp5C,IAAIxX,EAAKw0D,gBAAgB1wD,EAAMnH,OACtCi3D,GAAuC,SAA1B9vD,EAAMnH,KAAKgwD,WAAuB,CAClD,IAAMvE,EAAQpoD,EAAKooD,MAAQ,IAAID,GAC/ByI,EAAWp5C,IAAI4wC,EAAMvO,MAEtB,IAAK+Z,GAAuC,UAA1B9vD,EAAMnH,KAAKgwD,WAAwB,CACpD,IAAM8H,EAAiB/jC,EAASb,GAAG6kC,kBAAkBrgE,GACrDogE,EAAe75D,KAAf,oBAAyCvG,EAAQ,GAAjD,IACAogE,EAAej9C,IAAIk8C,EAAuB/C,sBAAsB8D,IAChEjB,EAAgBh8C,IAAIi9C,GAErB,IAAMjM,EAAU,IAAID,GAAQzkD,EAAMnH,KAAK6rD,SACvCA,EAAQ5kD,GAAG,QAASkwD,GACpBtL,EAAQ5kD,GAAG,UAAWmwD,GACtBvL,EAAQ5kD,GAAG,OAAQqwD,GACnBzL,EAAQ5kD,GAAG,QAASswD,GACpB1L,EAAQ5kD,GAAG,OAAQuwD,GAGnBvD,EAAWyD,SAAS7L,QAAUA,KAuB/BoI,EAAWpuC,iBAAiB,gBArBL,SAAC1e,GACvB,KAAO8sD,EAAWjoB,SAAS57C,QAC1B6jE,EAAWp7D,OAAOo7D,EAAWjoB,SAAS,IAGvC,IADA,IAAM8rB,EAAiB/jC,EAASb,GAAG6kC,kBAAkBrgE,GAC9CogE,EAAe9rB,SAAS57C,QAC9B0nE,EAAej/D,OAAOi/D,EAAe9rB,SAAS,IAE/C6qB,EAAgBh+D,OAAOi/D,GACvB,IAAMjM,EAAUoI,EAAWyD,SAAS7L,QACpCA,EAAQzkD,IAAI,QAAS+vD,GACrBtL,EAAQzkD,IAAI,UAAWgwD,GACvBvL,EAAQzkD,IAAI,OAAQkwD,GACpBzL,EAAQzkD,IAAI,QAASmwD,GACrB1L,EAAQzkD,IAAI,OAAQowD,MAQDhpE,KAAKsoE,YACbnlE,KAAKsiE,I/Ho0hBjB//D,E+Hj0hBD2jE,gBAAA,SAAgB73D,GAEf,IAAIi6C,EAAUC,EACd,OAFAjlD,QAAQC,IAAI,kBAAmB8K,GAEvBA,EAAKk0D,eACZ,IAAK,kBAQJ,OAPAja,EAAW,IAAI3rD,MAAM0pE,gBACZhuD,aAAa,WAAY,IAAI1b,MAAM2pE,uBAAuB,CAAC,EAAG,EAAG,EAAG,EAAG,GAAI,GAAI,IACxFhe,EAASjwC,aAAa,QAAS,IAAI1b,MAAM2pE,uBAAuB,CAAC,GAAK,GAAK,GAAK,EAAG,EAAG,GAAI,IAC1F/d,EAAW,IAAI5rD,MAAM4pE,kBAAkB,CACtCC,cAAc,EACdC,SAAU9pE,MAAM+pE,mBAEV,IAAI/pE,MAAMgqE,KAAKre,EAAUC,GACjC,IAAK,OAMJ,OALAD,EAAW,IAAI3rD,MAAMiqE,mBAAmB,IAAM,IAAM,IAAIC,UAAU,EAAG,GAAI,GACzEte,EAAW,IAAI5rD,MAAM8rD,kBAAkB,CACtCrzB,QAAS,GACTo8B,aAAa,IAEP,IAAI70D,MAAMssD,KAAKX,EAAUC,K/Hu0hBlChmD,E+Hn0hBDukE,YAAA,SAAYtxD,GAEX,IAAM8sD,EAAazlE,KAAKylE,WACxB,GAAIA,GAAczlE,KAAKulC,SAASb,GAAG0jC,aAAc,CAChD,IAAM3mE,EAASzB,KAAKkqE,WAAavxD,EAAM+1C,KAIjCn0B,GADSv6B,KAAKmqE,WAAa1oE,EAAO2oE,OACvB,IAAItqE,MAAMkkC,SAC3BviC,EAAO4oE,aAAa9vC,GACpBkrC,EAAW6E,aAAa/vC,GACxBkrC,EAAWp5C,IAAI5qB,GACfA,EAAO84B,SAASoc,KAAKpc,K/Hw0hBtB70B,E+Hp0hBDujE,gBAAA,SAAgB7O,GAEf,IAAMqL,EAAazlE,KAAKylE,WAClBhkE,EAASzB,KAAKkqE,WACpB,GAAIzE,GAAchkE,GAAUzB,KAAKulC,SAASb,GAAG0jC,aAAc,CAC1D,IAAI7tC,EAAW,IAAIz6B,MAAMkkC,QACzBzJ,EAAWA,EAASoc,KAAKl1C,EAAO84B,UAChC,IAAMi9B,EAAWh9C,KAAKC,IAAI,EAAGD,KAAKO,IAAI,EAAGwf,EAASgwC,WAAW1zB,IAAU,IAAOujB,IAC9E7/B,EAASmhC,YACTnhC,EAAWA,EAASuc,eAAe0gB,GAEnC/1D,EAAO84B,SAASoc,KAAKpc,K/Hy0hBtB70B,E+Hr0hBDmjE,UAAA,WAEC,IAAMpnE,EAASzB,KAAKkqE,WACdE,EAASpqE,KAAKmqE,WACpB,GAAI1oE,GAAU2oE,EAAQ,CAErB,IAAM7vC,EAAW,IAAIz6B,MAAMkkC,QAC3BviC,EAAO4oE,aAAa9vC,GACpB6vC,EAAOE,aAAa/vC,GACpB6vC,EAAO/9C,IAAI5qB,GACXA,EAAO84B,SAASoc,KAAKpc,GACrBv6B,KAAKkqE,WAAa,KAClBlqE,KAAKmqE,WAAa,O/H00hBnBzkE,E+Ht0hBD8kE,QAAA,a/Hy0hBC9kE,E+Hr0hBD+kE,kBAAA,SAAkBhF,EAAYhZ,GAC7B,GAAIgZ,EAKH,OAJAzlE,KAAKsmE,kBAAkBoE,WAAWC,gBAAgBlF,EAAWhgC,aAC7DgnB,EAAUme,IAAIzkE,OAAO0kE,sBAAsBpF,EAAWhgC,aACtDgnB,EAAUme,IAAIxQ,UAAU5zD,IAAI,EAAG,GAAI,GAAGskE,aAAa9qE,KAAKsmE,mBAEjD7Z,G/Hy0hBR/mD,E+Hr0hBDqlE,iBAAA,WACC,IACC,GAAI/qE,KAAKulC,SAASb,GAAG0jC,aAAc,CAClC,IAAM3b,EAAYzsD,KAAKyqE,kBAAkBzqE,KAAKylE,WAAYzlE,KAAKysD,WAC/D,GAAIA,EAAW,CACFF,GAAYC,QAAQC,EAAWzsD,KAAKylE,WAAWyD,SAASC,aACpEnpE,KAAKonE,UAAUv5D,eAOV,IAAK7N,KAAKgrE,WAAahrE,KAAKirE,WAAY,CAC9C,QAWA,MAAOpqE,GACRb,KAAKa,MAAQA,I/H60hBd6E,E+Hx0hBDwlE,MAAA,SAAMvoE,EAAQwjD,GACb,IAAMwgB,EAAY3mE,KAAK2mE,UAIvBhkE,EAAOwhC,MAAM39B,IAHF,GAAA,GAAA,IAMX,IAAM2kE,GAAOhlB,EAAK72C,EAAI62C,EAAKzqC,MAAQ,EAAKirD,EAAUjrD,MAAQ,GAAKirD,EAAUjrD,MAAQ,EAAM1b,KAAK+jC,OAAOwuB,OAC7F6Y,GAAOjlB,EAAK7kB,EAAI6kB,EAAKxqC,OAAS,EAAKgrD,EAAUhrD,OAAS,GAAKgrD,EAAUhrD,OAAS,EAAM3b,KAAK+jC,OAAOwuB,OAGtG5vD,EAAO43B,SAAS/zB,IAAI2kE,GAAKC,EAAI,I/H20hB7B1lE,E+Hv0hBD+rD,OAAA,SAAO4Z,GAAO,IAAAt2D,EAAA/U,KACb,IACC,IAAMulC,EAAWvlC,KAAKulC,SAGhB+lC,GAFGtrE,KAAKwlC,MACJxlC,KAAK+jC,OACF/N,YAAYjR,OACnBwmD,EAAOvrE,KAAK0xD,QAAU1xD,KAAK0xD,MAAQ1xD,KAAK0xD,MAAQ,EACtD1xD,KAAKwrE,qBACLxrE,KAAKwlC,MAAMm/B,UAAS,SAACC,GACiB,mBAA1BA,EAAMsE,SAASzX,QACzBmT,EAAMsE,SAASzX,OAAO6Z,EAAMC,MAG9BvrE,KAAK8lC,UAAUT,YAAYrlC,MAC3BiC,OAAOY,KAAK7C,KAAKgmE,SAAS9hE,SAAQ,SAAAzD,GACjCsU,EAAKixD,QAAQvlE,GAAKgxD,YAEflsB,EAASb,GAAG0jC,eACf5R,KAAKiV,OAAOF,OACZvrE,KAAKsoE,YAAYpkE,SAAQ,SAAAuhE,GACxBA,EAAWyD,SAAS7L,QAAQxvD,aAY9B03B,EAASksB,OAAOzxD,KAAKwlC,MAAOxlC,KAAK+jC,QAC7B/jC,KAAKoV,QAAUpV,KAAKoV,MAAM+U,QAC7BnqB,KAAKmmE,MAAM1U,SAEX,MAAO5wD,GACRb,KAAKa,MAAQA,I/Hi1hBd6E,E+H50hBDwgE,QAAA,WACkBlmE,KAAKulC,SACb6gC,iBAAiBpmE,KAAKyxD,S/H+0hB/B/rD,E+H50hBD81C,OAAA,WACC,IACC,IAAMrvB,EAAYnsB,KAAKmsB,UACtBoZ,EAAWvlC,KAAKulC,SAChBxB,EAAS/jC,KAAK+jC,OACTj3B,EAAO9M,KAAK8M,KACZq5C,EAAOh6B,EAAUy7B,wBAQvB,GAPA96C,EAAKwrB,KAAO9d,KAAKoK,MAAMuhC,EAAK7tB,MAC5BxrB,EAAK0tB,IAAMhgB,KAAKoK,MAAMuhC,EAAK3rB,KAC3B1tB,EAAK4O,MAAQlB,KAAKqiD,KAAK1W,EAAKzqC,OAC5B5O,EAAK6O,OAASnB,KAAKqiD,KAAK1W,EAAKxqC,QAC7B7O,EAAKylD,OAASzlD,EAAK4O,MAAQ5O,EAAK6O,OACd3b,KAAK2mE,UACbjX,QAAQ5iD,EAAK4O,MAAO5O,EAAK6O,SAC9B4pB,EAASb,GAAG0jC,eAChB7iC,EAASmqB,QAAQ5iD,EAAK4O,MAAO5O,EAAK6O,QAC9BooB,GAAQ,CACXA,EAAOwuB,OAASzlD,EAAK4O,MAAQ5O,EAAK6O,OAClC,IAAM+vD,EAAQ3nC,EAAOuuB,IAAM93C,KAAK2zC,GAAK,IAC/BxyC,EAASnB,KAAKub,IAAIgO,EAAOxJ,SAASoL,EAAInrB,KAAKmxD,IAAID,EAAQ,GAAK,GAC5D9E,EAAa5mE,KAAK4mE,WACxBA,EAAWlrD,MAAQC,EAASooB,EAAOwuB,OACnCqU,EAAWjrD,OAASA,EAEpBooB,EAAOw3B,0BAIR,MAAO16D,GACRb,KAAKa,MAAQA,I/Hk1hBd6E,E+H70hBDkmE,qBAAA,SAAqBjzD,GACpB,IAAMkzD,EAAK7rE,KAAK8M,KAAK4O,MAAQ,EACvBowD,EAAK9rE,KAAK8M,KAAK6O,OAAS,EAC9B3b,KAAKqmE,MAAM/2D,GAAKqJ,EAAMu/C,QAAUl4D,KAAK8M,KAAKwrB,KAAOuzC,GAAMA,EACvD7rE,KAAKqmE,MAAM/kC,IAAM3oB,EAAMw/C,QAAUn4D,KAAK8M,KAAK0tB,IAAMsxC,GAAMA,EACvD,IAAMrf,EAAYzsD,KAAKysD,UAEvB,OADAA,EAAUya,cAAclnE,KAAKqmE,MAAOrmE,KAAK+jC,QAClC0oB,G/Hg1hBP/mD,E+H70hBDqmE,YAAA,SAAYpzD,GACX,IACC,GAAqB,IAAjBA,EAAM+/C,OACT,OAED,IAAMjM,EAAYzsD,KAAK4rE,qBAAqBjzD,GAChC4zC,GAAYC,QAAQC,GAAW,GAC3C,GAAIzsD,KAAKoH,QAAU9C,EAClB,GAAItE,KAAK6C,KAAKs4D,OAASn7D,KAAK6C,KAAKu4D,cAGhC,GADAp7D,KAAK2N,OAAOsG,KAAK,CAAEwrB,KAAM,OACrBz/B,KAAK4J,SAAS8kD,KAAK1B,aAAc,CACpC,IAAMzyB,GAAW,IAAIz6B,MAAMkkC,SAAU2S,KAAK32C,KAAK4J,SAAS8kD,KAAK1B,aAAaG,OAAOuO,YACjFj1D,QAAQC,IAAIuF,KAAKE,UAAU,CAAEouB,SAAUA,EAASwc,aAChD/2C,KAAKwwC,QAAQv8B,KAAKsmB,IAIpB,MAAO15B,GACRb,KAAKa,MAAQA,I/Hu1hBd6E,E+Hl1hBD8lE,mBAAA,WACC,GAAIxrE,KAAKulC,SAASb,GAAG0jC,aAAc,CAClC,IAAM3b,EAAYzsD,KAAKyqE,kBAAkBzqE,KAAKylE,WAAYzlE,KAAKysD,WAC/D,GAAIA,EAAW,CACFF,GAAYC,QAAQC,EAAWzsD,KAAKylE,WAAWyD,SAASC,aACpEnpE,KAAKonE,UAAUv5D,Y/H61hBjBnI,E+Hn1hBDsmE,wBAAA,SAAwBrzD,GACvB,IAAM8zC,EAAYzsD,KAAK4rE,qBAAqBjzD,GAC5C,IAAI3Y,KAAKisE,WAGT,GAAIjsE,KAAKgrE,UACR,GAAwC,mBAA7BhrE,KAAKgrE,SAASkB,WAA2B,CACnD,IAAMrf,EAAgBJ,EAAUK,iBAAiB,CAAC9sD,KAAK4J,SAAS8kD,OAChE,GAAI7B,EAAcjrD,OAAQ,CACzB,IAAMorD,EAAeH,EAAc,GAE7BtyB,GAAW,IAAIz6B,MAAMkkC,SAAU2S,KAAKqW,EAAaG,OAAOuO,YAC9D17D,KAAKgrE,SAASkB,WAAW3xC,UAGrB,GAAIv6B,KAAKirE,WACJjrE,KAAKirE,WAAWkB,iBAYrB,CACM5f,GAAYC,QAAQC,GAMhCzsD,KAAKosE,cAAcn4D,KAAKjU,KAAK8P,W/Hg1hB9BpK,E+H50hBD2mE,YAAA,SAAY1zD,GACX,IACC3Y,KAAKgsE,wBAAwBrzD,GAC5B,MAAO9X,GACRb,KAAKa,MAAQA,I/Hg1hBd6E,E+H30hBD4mE,UAAA,SAAU3zD,GACT,IACC,GAAI3Y,KAAKisE,WACR,OAEGjsE,KAAKgrE,UAC+B,mBAA5BhrE,KAAKgrE,SAAS75B,YACxBnxC,KAAKgrE,SAAS75B,YACdnxC,KAAKusE,QAAQt4D,KAAKjU,KAAKgrE,WAGzBhrE,KAAKgrE,SAAW,KACZhrE,KAAKirE,YACmC,mBAAhCjrE,KAAKirE,WAAW75B,cAC1BpxC,KAAKirE,WAAW75B,cAChBpxC,KAAKwsE,UAAUv4D,KAAKjU,KAAKirE,aAG3BjrE,KAAKirE,WAAa,KAMlB,IAAMxe,EAAYzsD,KAAK4rE,qBAAqBjzD,GAChC4zC,GAAYC,QAAQC,GAAW,GAC1C,MAAO5rD,GACRb,KAAKa,MAAQA,I/Ho1hBd6E,E+H/0hBD+mE,aAAA,SAAa9zD,GACZ,IACC,GAAI3Y,KAAKisE,WACR,OAED,IAAMS,EAAS/zD,EAAM+zD,aAAgCnrE,IAAtBoX,EAAMg0D,YAA4B,EAAI,IAC/DxG,EAAQnmE,KAAKmmE,MACnB3P,KAAKrZ,GAAGgpB,EAAO,CACd15B,SAAU,GACV6K,KAAM6uB,EAAM7uB,KAAgB,GAATo1B,EACnBjW,KAAMmW,OAAOC,QACb/V,WAAW,IAEX,MAAOj2D,GACRb,KAAKa,MAAQA,I/Ho1hBd6E,E+H/0hBDonE,uBAAA,WACC9sE,KAAKosE,cAAcn4D,KAAKjU,KAAK8P,U/Hk1hB7BpK,E+H/0hBDqnE,YAAA,WAEC/sE,KAAKmnE,QAAQ5sC,SAAS+G,EAAI,IAC1BthC,KAAKwlC,MAAMnZ,IAAIrsB,KAAKonE,UAAU1Y,MAC9Bl3C,EAAe+T,KAAK,CACnBjb,KAAM2O,M/Hm1hBPvZ,E+H/0hBDsnE,UAAA,WAEChtE,KAAKmnE,QAAQ5sC,SAAS+G,EAAI,EAC1BthC,KAAK0mE,YAAY1vB,SAAS1V,EAAI,EAC9BthC,KAAK0mE,YAAYnsC,SAAS+G,EAAI,EAC9BthC,KAAKwlC,MAAMn7B,OAAOrK,KAAKonE,UAAU1Y,MACjCl3C,EAAe+T,KAAK,CACnBjb,KAAM2O,M/Hm1hBPvZ,E+H/0hBDunE,mBAAA,SAAmB73D,GAClBoC,EAAe+T,KAAK,CACnBjb,KAAM2O,GACN8kB,OAAQ3uB,EAAM2uB,OAAOK,S/Hm1hBtB1+B,E+H/0hBDwnE,UAAA,SAAUv0D,GAET3Y,KAAKsH,UAAO/F,EACZvB,KAAKmtE,MAAMl5D,KAAK,CAAEyW,OAAQ/R,EAAM3H,M/Ho1hBhCtL,E+Hj1hBD0nE,aAAA,SAAaz0D,GAER3Y,KAAKoqB,SAGTpqB,KAAKsH,KAAOqR,EACZ3Y,KAAK2J,KAAK61B,MAAMt7B,SAAQ,SAAAu7B,GAAI,OAAIA,EAAK8R,WAAY,KACjDvxC,KAAKuV,gB/Hu1hBL7P,E+Hp1hBD2nE,UAAA,SAAUpjE,GAELjK,KAAKsH,OAITtH,KAAK2J,KAAK61B,MAAMt7B,SAAQ,SAAAu7B,GAAI,OAAIA,EAAK8R,WAAY,KACjDtnC,EAAIw1B,KAAK8R,UAAYtnC,EAAIqjE,kBACzBttE,KAAKuV,cACLiC,EAAe+T,KAAK,CACnBjb,KAAM2O,GACNsuD,OAAQtjE,EAAIw1B,KAAK8R,UAAYtnC,EAAIw1B,KAAKzuB,GAAK,S/H01hB5CtL,E+Ht1hBD8nE,SAAA,SAASvjE,GAGRjK,KAAKuV,e/Hy1hBL7P,E+Ht1hBD+nE,UAAA,SAAU90D,GACTA,EAAM8mB,KAAK8R,WAAY,EAEnBvxC,KAAKoqB,SAGLpqB,KAAKoH,QAAUpH,KAAK6C,KAAKs4D,OAC5Bn7D,KAAKgrE,SAAWryD,EAChB3Y,KAAK2N,OAAOsG,KAAK0E,IACP3Y,KAAKoH,QAAUpH,KAAK6C,KAAKu4D,SACnCp7D,KAAKirE,WAAatyD,EAClB3Y,KAAK2N,OAAOsG,KAAK0E,IAEjB3Y,KAAKmtE,MAAMl5D,KAAK0E,EAAM8mB,Q/H21hBvB/5B,E+Hv1hBDgoE,aAAA,SAAa/0D,GAER3Y,KAAKisE,aAGLjsE,KAAKoH,QAAUpH,KAAK6C,KAAKs4D,OAC5Bn7D,KAAKgrE,SAAWryD,EAChB3Y,KAAK2N,OAAOsG,KAAK0E,IACP3Y,KAAKoH,QAAUpH,KAAK6C,KAAKu4D,UACnCp7D,KAAKirE,WAAatyD,EAClB3Y,KAAK2N,OAAOsG,KAAK0E,M/H41hBlBjT,E+Hx1hBDioE,YAAA,SAAYh1D,GACXnB,EAAe+T,KAAK,CACnBjb,KAAM2O,GACNsuD,OAAQ50D,EAAM40D,OACd1W,QAASl+C,EAAMk+C,W/H41hBhBnxD,E+Hx1hBDkoE,YAAA,SAAYj1D,GAEX,IAAMpS,EAAOoS,EAAM5T,aAAa,QACjB4T,EAAM5T,aAAa,UAC9BwB,GACH9B,OAAOi6B,KAAKn4B,EAAM,W/H61hBnBb,E+Hz1hBDmoE,WAAA,SAAWl1D,GAAO,IAAAmO,EAAA9mB,KAEjBA,KAAK2J,KAAK61B,MAAQ,GAElBx/B,KAAKuV,cACLvV,KAAKmmE,MAAM3K,KAAK7iD,EAAM4hB,UAAU,SAACshC,EAAkBK,GAClD,IAAMxxD,EAAOoc,EAAKnd,KAAKg4B,QAAQhpB,EAAMyoB,QAAQ9xB,EAAGqJ,EAAMyoB,QAAQE,GAC1D52B,GACHoc,EAAKld,SAASglD,UAAUlkD,EAAMoc,EAAKye,UAAU,SAACqkB,EAAQx/C,EAASqkD,GAE9D3nC,EAAK0e,MAAMz6B,YAAc6+C,EACzB9iC,EAAKq/C,MAAMlK,aAAaJ,EAAkBK,GAC1Cp1C,EAAKnd,KAAK63B,qBAEV1a,EAAKvR,qB/Hu2hBR7P,E+H/1hBDooE,UAAA,SAAUn1D,GAEL3Y,KAAKoqB,SAGT5S,EAAe+T,KAAK,CACnBjb,KAAM2O,GACNyL,OAAQ1qB,KAAK2J,KAAKqH,GAClBq2B,UAAW1uB,IAEZ3Y,KAAKuV,gB/Hm2hBL7P,E+Hh2hBDqoE,SAAA,WAAW,IAAA5mD,EAAAnnB,KACV,OAAOA,KAAKosE,cAAc75D,KACzBvP,EAAAA,QAAO,WAAA,OAAMmV,EAAa/C,MAAMtF,SAAWqI,EAAa/C,MAAMuV,OAASxD,EAAK/f,UAC5E6xC,EAAAA,UAAU,IACVxkC,EAAAA,KAAI,SAAC3E,GACJA,EAAQ0zB,YAAYC,SAAWtc,EAAKg/C,MAAM1iC,SAC1C3zB,EAAQ0zB,YAAYE,UAAYvc,EAAKg/C,MAAMziC,UAC3C5zB,EAAQwnC,KAAOnwB,EAAKg/C,MAAM7uB,KAC1B,IAAMuV,EAAgB1lC,EAAKslC,UAAUK,iBAAiB,CAAC3lC,EAAKvd,SAAS8kD,OAC/DvB,EAAQN,EAAcjrD,OAASirD,EAAc,GAAGM,MAAMuO,YAAc,KACtEvO,IACHr9C,EAAQhF,QAAQ,GAAKqiD,EAAM79C,EAC3BQ,EAAQhF,QAAQ,GAAKqiD,EAAM7rB,EAC3BxxB,EAAQhF,QAAQ,GAAKqiD,EAAMxnB,GAE5BnuB,EAAe+T,KAAKzb,Q/Hy2hBtBpK,E+Hp2hBD8lC,aAAA,WAAe,IAAAhkB,EAAAxnB,KACdA,KAAK8P,QAAU,CACdQ,KAAM2O,GACNukB,YAAa,CAAEC,SAAU,EAAGC,UAAW,GACvC4T,KAAM,EACNxsC,QAAS,CAAC,EAAG,EAAG,IAEjB9K,KAAKosE,cAAgB,IAAIl0D,EAAAA,cAAc,GACvClY,KAAK+tE,WAAWx7D,KACfkE,EAAAA,UAAUzW,KAAK0W,eACdX,YACF,IAAM+vB,EAAY9lC,KAAK8lC,UAAYlC,GAAUiB,aAC7CiB,EAAUtB,SAASjyB,KAClBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAC+uB,GACZtd,EAAK+d,SAASb,GAAGspC,WAAWlpC,GACxBA,EACHtd,EAAKulD,cAELvlD,EAAKwlD,eAGPlnC,EAAUztB,OAAO9F,KAChBkE,EAAAA,UAAUzW,KAAK0W,cACfuiC,EAAAA,UAAUz+B,KAAKoK,MAAM,IAAO,MAC3B7O,WAAU,SAACX,GACZoS,EAAKylD,mBAAmB73D,MAEVpV,KAAKmmE,MAAM/M,SAASp5D,KAAKmsB,WAAW5Z,KAClDkK,EAAAA,YAAY,IAOelK,KAC3BvP,EAAAA,QAAO,SAAA2V,GAAK,OAAIA,aAAiBghD,MACjC1gB,EAAAA,UAAUz+B,KAAKoK,MAAM,IAAO,MAEhBrS,KACZkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA4C,GAEX6O,EAAKslD,4BAENt1D,EAAeS,KAAK1F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA0B,GACX,OAAQA,EAAQnH,MACf,KAAK2O,GACJxH,EAAQnH,KAAO2O,GACfxH,EAAQiT,OAASlD,EAAK7d,KAAKqH,GAC3ByG,EAAQ+rB,YAAchc,EAAK2+C,MAAMpL,iBACjCtjD,EAAQ6/B,KAAO9vB,EAAK2+C,MAAM7uB,KACtB9vB,EAAK7d,gBAAgB82B,KACxBhpB,EAAQ4vB,UAAY7f,EAAK7d,KAAKT,OAG/BsO,EAAeK,SAASJ,GACpBU,EAAa/C,MAAMyF,OAASxH,EAASC,WACxC6E,EAAaC,WAAW,CAAEuS,OAAO,IAElC,MACD,KAAK1L,GAEAmjB,GAAY1X,SAAWjT,EAAQiT,QAClC0X,GAAY1X,OAASjT,EAAQiT,OAC7BlD,EAAKwgD,kBAAoBvwD,IAEzB+P,EAAK2+C,MAAMrL,eAAerjD,EAAQ+rB,aAC7Bhc,EAAK+d,SAASb,GAAG0jC,eACrB5gD,EAAK2+C,MAAM7uB,KAAO7/B,EAAQ6/B,KAC1B9vB,EAAKuc,OAAOw3B,0BAET/zC,EAAK7d,gBAAgB82B,IAAoBhpB,EAAQ4vB,YACpD7f,EAAK7d,KAAKT,MAAQuO,EAAQ4vB,WAEtB7f,EAAK7d,MAAS6d,EAAK7d,KAAKs+D,QAC5BzgD,EAAKwgD,kBAAoBvwD,IAkB3B,MAcD,KAAKwH,GACAuI,EAAKlgB,MACRkgB,EAAKlgB,KAAK2mE,aAEXzmD,EAAK7d,KAAK61B,MAAMt7B,SAAQ,SAAAu7B,GAAI,OAAIA,EAAK8R,UAAa9R,EAAKzuB,KAAOyG,EAAQ81D,UACtE/lD,EAAKjS,cACL,MACD,KAAK0J,GACJ,IAAMwgB,EAAOjY,EAAK7d,KAAK61B,MAAMliB,MAAK,SAAAmiB,GAAI,OAAIA,EAAKzuB,KAAOyG,EAAQ81D,UAC1D9tC,GAAQA,EAAKivB,gBAAgB0F,IAChC30B,EAAKivB,KAAKqI,gBAAgBt/C,EAAQo/C,SAEnC,MACD,KAAK53C,GAEAuI,EAAK7d,KAAKqH,KAAOyG,EAAQiT,SAC5BlD,EAAK7d,KAAKT,MAAQuO,EAAQ4vB,WAE3B,MACD,KAAKpoB,GACJuI,EAAKmgD,kBAAkBlwD,GACvB,MACD,KAAKwH,GACJuI,EAAKqgD,qBAAqBpwD,GAC1B,MACD,KAAKwH,GACJuI,EAAKsgD,qBAAqBrwD,GACtBU,EAAa/C,MAAMkU,SAAW7R,EAAQM,UACzCyP,EAAK2+C,MAAM9J,YAAY5kD,EAAQssB,QAEhC,MACD,KAAK9kB,GACCuI,EAAK+d,SAASb,GAAG0jC,eACrB5gD,EAAK2+C,MAAMrL,eAAerjD,EAAQ+rB,aAClChc,EAAK2+C,MAAM7uB,KAAO7/B,EAAQ6/B,MAI3B9vB,EAAK1c,QAAQqyD,YAAY1lD,EAAQ3M,QAAQ,GAAI2M,EAAQ3M,QAAQ,GAAI2M,EAAQ3M,QAAQ,QAIpFqN,EAAaE,OAAO9F,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAX,GACXoS,EAAKpS,MAAQA,EACboS,EAAK0mD,YAAe/1D,EAAa/C,MAAMgV,QAAUjS,EAAa/C,MAAMkU,UAIrEtpB,KAAKw7C,OAASx7C,KAAKw7C,OAAOl7B,KAAKtgB,MAC/BA,KAAKyxD,OAASzxD,KAAKyxD,OAAOnxC,KAAKtgB,MAC/BA,KAAK+rE,YAAc/rE,KAAK+rE,YAAYzrD,KAAKtgB,MACzCA,KAAKqsE,YAAcrsE,KAAKqsE,YAAY/rD,KAAKtgB,MACzCA,KAAKssE,UAAYtsE,KAAKssE,UAAUhsD,KAAKtgB,MACrCA,KAAKysE,aAAezsE,KAAKysE,aAAansD,KAAKtgB,MAE3CyE,OAAO4yB,iBAAiB,SAAUr3B,KAAKw7C,QAAQ,GAC/Cx7C,KAAKmsB,UAAUkL,iBAAiB,QAASr3B,KAAKysE,cAAc,GAC5DzsE,KAAKmsB,UAAUkL,iBAAiB,YAAar3B,KAAK+rE,aAAa,GAC/D/rE,KAAKmsB,UAAUkL,iBAAiB,UAAWr3B,KAAKssE,WAAW,GAC3DznE,SAASwyB,iBAAiB,YAAar3B,KAAKqsE,aAAa,I/Hk4hBzD3mE,E+H/3hBDomC,gBAAA,WACCrnC,OAAOkzB,oBAAoB,SAAU33B,KAAKw7C,QAAQ,GAClD/2C,OAAOkzB,oBAAoB,SAAU33B,KAAKw7C,QAAQ,GAClD32C,SAAS8yB,oBAAoB,YAAa33B,KAAKqsE,aAAa,GAC5DxnE,SAAS8yB,oBAAoB,QAAS33B,KAAKysE,cAAc,GACzDzsE,KAAKmsB,UAAUwL,oBAAoB,YAAa33B,KAAK+rE,aAAa,GAClE/rE,KAAKmsB,UAAUwL,oBAAoB,UAAW33B,KAAKssE,WAAW,I/Hk4hB9DnqE,EAAa0jE,EAAgB,CAAC,CAC5BplE,IAAK,QACL8D,IAAK,W+H39jBP,OAAOvE,KAAK8lE,Q/H89jBVt/D,IAAK,S+H59jBE3F,GACLb,KAAK8lE,SAAWjlE,IACnBb,KAAK8lE,OAASjlE,EACdb,KAAKuV,iB/H+9jBH,CACD9U,IAAK,OACL8D,IAAK,W+H79jBP,OAAOvE,KAAK+nE,O/Hg+jBVvhE,IAAK,S+H99jBCmD,GACJ3J,KAAK+nE,QAAUp+D,IAClB3J,KAAK+nE,MAAQp+D,EACb3J,KAAK81C,a/Hi+jBH,CACDr1C,IAAK,YACL8D,IAAK,W+H99jBP,OAAOD,I/Hk+jBJ,CACD7D,IAAK,SACL8D,IAAK,W+Hj+jBP,OAAOvE,KAAKoV,MAAMgV,QAAUpqB,KAAKoV,MAAMkU,S/Ho+jBpC,CACD7oB,IAAK,aACL8D,IAAK,W+Hn+jBP,OAAOvE,KAAKoqB,QAAUpqB,KAAKulC,SAASb,GAAG0jC,e/Hs+jBpC,CACD3nE,IAAK,cACL8D,IAAK,W+Hp+jBP,OAAmC,MAA5BvE,KAAK8K,QAAQ4jD,KAAK0b,Q/Hu+jBvB5jE,IAAK,S+Hr+jBQ0nE,GACXluE,KAAKkuE,cAAgBA,IACxBA,EAAcluE,KAAKwlC,MAAMnZ,IAAIrsB,KAAK8K,QAAQ4jD,MAAQ1uD,KAAKwlC,MAAMn7B,OAAOrK,KAAK8K,QAAQ4jD,W/H0+jB3EmX,E+H9gkBYA,CAAuB94D,EAAAA,WA8lC5C84D,GAAe74D,KAAO,CACrBC,SAAU,UACViE,OAAQ,CAAC,OAAQ,QAAS,UAC1Bqf,QAAS,CAAC,QAAS,UAAW,UAAW,YAAa,WCznC3CzwB,MAAM0a,KAAKygD,SAAvB,IAEMkT,GAAW,IAAIruE,MAAM6rD,kBAAkB,EAAG,EAAG,GAG9ByiB,GAAAA,SAAAA,GhI6ikBnB,SAASA,IACP,OAAO9hE,EAAWjL,MAAMrB,KAAMoB,YAAcpB,KAH9CoD,EAAegrE,EAAgB9hE,GAM/B,IAAI5G,EAAS0oE,EAAe7rE,UA4L5B,OA1LAmD,EgI7ikBD6G,OAAA,WAAS,IAAAtI,EAAAjE,KAGR,IAAKA,KAAKiF,KACT,KAAO,mCAERjF,KAAKmkC,MAAQ,IAAIrkC,MAAMkkC,QAAQ,EAAK,EAAK,GACzChkC,KAAKu6B,SAAW,IAAIz6B,MAAMkkC,QAC1B,IAAMp0B,EAAQ5P,KAAK4P,MAAQ,IAAI9P,MAAM+yD,MACrCjjD,EAAMH,KAAOzP,KAAKquE,UAClBz+D,EAAMs5D,SAASzX,OAAS,SAAC6Z,EAAMC,GAE9BtnE,EAAKwtD,OAAOxtD,EAAMqnE,EAAMC,IAGzBvrE,KAAKsuE,eAAejiD,IAAIzc,GACxB5P,KAAKuuE,UACJ,SAAC7f,EAAMjvB,GAAP,OAAgBx7B,EAAKuqE,QAAQ9f,EAAMjvB,MACnC,SAACivB,EAAMjvB,GAAP,OAAgBx7B,EAAKwqE,WAAW/f,EAAMjvB,OhIujkBvC/5B,EgInjkBDgyB,UAAA,WACC,IAAM9nB,EAAQ5P,KAAK4P,MACnB5P,KAAKsuE,eAAejkE,OAAOuF,UACpBA,EAAMs5D,SAASzX,OACtBzxD,KAAK0uE,cAAc9+D,GACnB5P,KAAK4P,MAAQ,MhIsjkBblK,EgInjkBD4oE,aAAA,WACC,OAAOtuE,KAAKiF,KAAKkiE,ShIsjkBjBzhE,EgInjkBD2oE,QAAA,SAAQ5+D,GACP,OAAUzP,KAAKwD,YAAYwJ,KAAKC,SAAhC,IAA4CjN,KAAK4iD,UAAWnzC,EAAI,IAAOA,EAAS,KhIsjkBhF/J,EgInjkBD6oE,SAAA,SAASI,EAAQC,GAChB,IAAMljB,EAAW,IAAI5rD,MAAMyxD,qBAAqB,CAC/C1F,MAAO,IAAI/rD,MAAMm1D,MAAM,WACvB4Z,UAAW,GACXC,UAAW,IACXC,aAAa,EACbpa,aAAa,EACbp8B,QAAS,KAEJm2B,EAAO,IAAI5uD,MAAMssD,KAAK+hB,GAAUziB,GAItC,MAHsB,mBAAXijB,GACVA,EAAOjgB,GAEDA,GhIwjkBPhpD,EgIrjkBD8oE,QAAA,SAAQ9f,EAAMjvB,GAAM,IAAAjrB,EAAAxU,KACfA,KAAK0uD,MAER1uD,KAAKyuE,WAAWzuE,KAAK0uD,MAEtBA,EAAKj/C,KAAOzP,KAAKquE,QAAQ,QACzBruE,KAAK0uD,KAAOA,EACRjvB,IACHA,EAAKivB,KAAOA,EACZjvB,EAAKgO,SAAW,WACfj5B,EAAKi5B,SAAShO,EAAMivB,IAErBjvB,EAAKmS,cAAgB,WACpBp9B,EAAKo9B,cAAcnS,EAAMivB,KAG3B1uD,KAAK4P,MAAMyc,IAAIqiC,IhIykkBfhpD,EgI5jkBD+oE,WAAA,SAAW/f,EAAMjvB,GAChBz/B,KAAK4P,MAAMvF,OAAOqkD,GACU,mBAAjBA,EAAKr5B,SACfq5B,EAAKr5B,UAENr1B,KAAK0uE,cAAchgB,GACnB1uD,KAAK0uD,KAAO,KACRjvB,WACIA,EAAKivB,YACLjvB,EAAKgO,gBACLhO,EAAKmS,gBhImkkBblsC,EgI/jkBDgpE,cAAA,SAAc/rE,GACbA,EAAOgiE,UAAS,SAAAC,IACXA,EAAMoK,mBAAqBpK,EAAMqK,sBACpC1iB,GAAYl3B,QAAQuvC,GAEjBA,EAAMC,QACLD,EAAMlZ,SAASr8C,MAAyC,IAAlCu1D,EAAMlZ,SAASr8C,IAAI8nD,YAC5CyN,EAAMlZ,SAASr8C,IAAIgmB,UAEpBuvC,EAAMlZ,SAASr2B,UACfuvC,EAAMnZ,SAASp2B,WACLuvC,EAAMsK,WACZtK,EAAMlZ,SAASr8C,MAAyC,IAAlCu1D,EAAMlZ,SAASr8C,IAAI8nD,YAC5CyN,EAAMlZ,SAASr8C,IAAIgmB,UAEpBuvC,EAAMlZ,SAASr2B,ehIukkBjB3vB,EgIjkkBDypE,0BAAA,WAA4B,IACnBziE,EAASC,EAAAA,WAAW3M,MAApB0M,KACR1M,KAAKiF,KAAKimE,MAAMlrE,KAAM0M,EAAKk7C,0BhIskkB3BliD,EgInkkBD+rD,OAAA,SAAO6Z,EAAMC,KhIilkBZ7lE,EgInkkBD0pE,UAAA,SAAUvf,GAGT,OAFe7vD,KAAKgtD,aAAa8C,OAAOD,IhIwkkBxCnqD,EgInkkBD2pE,SAAA,SAASxf,GACR,IAAI7B,EAAQxzC,KAAKO,IAAI,EAAK/a,KAAKgtD,aAAa6C,OAAOA,IAAW,EAI9D,OAHA7B,EAAQxzC,KAAKC,IAAI,EAAKuzC,GAEtBA,GAAS,GhIwkkBTtoD,EgInkkBD+nC,SAAA,SAAShO,EAAMivB,KhIskkBdhpD,EgInkkBDksC,cAAA,SAAcnS,EAAMivB,KhIqkkBnBvsD,EAAaisE,EAAgB,CAAC,CAC5B3tE,IAAK,cACL+F,IAAK,SgItukBQiE,GACfzK,KAAK4P,MAAMnF,YAAcA,MhI0ukBlB2jE,EgI7ukBYA,CAAuBrhE,EAAAA,WAqK5CqhE,GAAephE,KAAO,CACrBC,SAAU,UACVkE,MAAO,CAAElM,KAAM4gE,IACf30D,OAAQ,CAAC,SC7KV,IAAMo+D,GAAeC,OAGAC,IAFN,IAAI1vE,MAAMkkC,QAEJwrC,SAAAA,GjI6vkBnB,SAASA,IACP,OAAOC,EAAgBpuE,MAAMrB,KAAMoB,YAAcpB,KAHnDoD,EAAeosE,EAAsBC,GAMrC,IAAI/pE,EAAS8pE,EAAqBjtE,UAiQlC,OAhPAmD,EiIjvkBD8pB,UAAA,WAECxvB,KAAKuL,MAAQvL,KAAKy/B,KAAKl0B,OjIovkBvB7F,EiIjvkBDgqE,aAAA,WAAe,IAAAzrE,EAAAjE,KACdA,KAAK2vE,mBAAmB3uE,MAAK,SAAA6yC,GAC5B,IAAMzpC,EAAUypC,EAAOzpC,QAEvBA,EAAQsjD,MAAQtjD,EAAQwlE,MAAQ9vE,MAAMi0D,eACtC3pD,EAAQylE,OAAOvgE,EAFA,GAGflF,EAAQ0lE,SAAWhwE,MAAM8wD,aACzB,IAAM2B,EAJS,GAIC1e,EAAOn4B,MAAkBm4B,EAAOl4B,OAC1Cu7B,EAAM18B,KAAK2zC,GAAK,IAAM,IAEtBxyC,EADQ2zD,GAAep4B,EACNqb,EACjB9G,EAAW,IAAI3rD,MAAMiwE,uBAAuBT,GAAcA,GAAc3zD,EAAQ,GAAI,GAAG,EAAM,EAAGu7B,GACtGuU,EAAStnB,OAAO,EAAG,EAAG,GACtB,IAAMunB,EAAW,IAAI5rD,MAAM8rD,kBAAkB,CAC5Cv8C,IAAKjF,EACLuqD,aAAa,EACbp8B,QAAS,IAGJm2B,EAAOzqD,EAAKyqD,MACFzqD,EAAK+rE,QAAU,IAAI7rE,MAAM,GAAGqzB,KAAK,GAAGnoB,KAAI,SAAAC,GAAC,OAAI,IAAIxP,MAAMssD,KAAKX,EAAUC,OAC9ExnD,SAAQ,SAACyG,EAAQhJ,GACxBgJ,EAAOqsC,SAAS1V,EAAI9mB,KAAK2zC,GAAK,EAAIxsD,KAInC,IAAMgQ,EAAO,CAAE/Q,MAAO,GACtB41D,KAAKrZ,GAAGxrC,EAAM,CACb86B,SAAU,GACV7rC,MAAO,EACP8vC,MAAO,EACP+lB,KAAMC,OAAOC,UACblpB,SAAU,WACTie,EAASnzB,QAAU5mB,EAAK/Q,MACxB8qD,EAAShB,aAAc,KAGzBgE,EAAKwa,SAAW,CACfzX,OAAQ,WACP/C,EAAK1X,SAAS1V,GAAK9mB,KAAK2zC,GAAK,IAAM,IAEnCzC,EAAShB,aAAc,QjI4vkB1BhlD,EiItvkBDuqE,aAAA,WACCjwE,KAAK2vE,mBAAmB3uE,MAAK,SAAA6yC,QjI8ykB7BnuC,EiIrvkBD6oE,SAAA,SAAS2B,EAAOtB,GACf,IAAMlgB,EAAO,IAAI5uD,MAAM+yD,MACF,mBAAVqd,GACVA,EAAMxhB,IjI0vkBPhpD,EiItvkBDiqE,iBAAA,WAAmB,IAAAn7D,EAAAxU,KAClB,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5B,IAKI8zC,EAJA+7B,EADU,IAEVC,EAAI,IACFC,EAAI71D,KAAKoK,MAAMwrD,OACfE,EAAI91D,KAAKoK,MAAMwrD,MAGpBh8B,EADG5/B,EAAK4/B,OACC5/B,EAAK4/B,OAEL5/B,EAAK4/B,OAASvvC,SAAS0W,cAAc,WAIxCG,MAAQy0D,EACf/7B,EAAOz4B,OAASy0D,EAChB,IA0BIhmE,EA1BEgI,EAAOoC,EAAKirB,KAAKl0B,MACjB8oC,EAAMD,EAAOznC,WAAW,MAE9B0nC,EAAI+hB,uBAAwB,EAC5B/hB,EAAIgiB,sBAAwB,OAC5BhiB,EAAIk8B,KAAUF,EAAd,MAAqBtlE,EAAYP,WAEjC2lE,EADgB97B,EAAIm8B,YAAYp+D,GACpBsJ,MAAQ,EACpBy0D,EAAI31D,KAAKC,IAvBK,IAuBMD,KAAK4d,IAAI,EAAG5d,KAAKqiD,KAAKriD,KAAK9T,IAAIypE,GAAK31D,KAAK9T,IAAI,MAGjE0tC,EAAO14B,MAAQy0D,EACf97B,EAAIo8B,UAAU,EAAG,EAAGN,EAAGC,GACvB/7B,EAAI0d,UAAY,YAChB1d,EAAI2d,SAAS,EAAG,EAAGme,EAAGC,GACtB/7B,EAAIk8B,KAAUF,EAAd,MAAqBtlE,EAAYP,WACjC6pC,EAAIq8B,UAAY,SAChBr8B,EAAIs8B,aAAe,SACnBt8B,EAAIu8B,YAAc,qBAClBv8B,EAAIw8B,UAAYP,EAChBj8B,EAAIy8B,SAAW,QACfz8B,EAAI08B,WAAa,EACjB18B,EAAI28B,WAAW5+D,EAAM+9D,EAAI,EAAGC,IAC5B/7B,EAAI0d,UAAY,QAChB1d,EAAI48B,SAAS7+D,EAAM+9D,EAAI,EAAGC,GAAOD,GAG7B37D,EAAKpK,SACRA,EAAUoK,EAAKpK,SACPsgD,aAAc,EAEtBtgD,EAAUoK,EAAKpK,QAAU,IAAItK,MAAMwxD,cAAcld,GAGlD/zC,EAAQ,CAAE+J,QAASA,EAASsR,MAAOy0D,EAAGx0D,OAAQy0D,QjIsykB/CjuE,EAAaqtE,EAAsB,CAAC,CAClC/uE,IAAK,QACL8D,IAAK,WiI9+kBP,OAAOvE,KAAKkxE,QjIi/kBV1qE,IAAK,SiI/+kBE+E,GACT,GAAIvL,KAAKkxE,SAAW3lE,EAAO,CAC1B,IAAMmX,EAAsB,MAAf1iB,KAAKkxE,OAClBlxE,KAAKkxE,OAAS3lE,EACTmX,EAGJ1iB,KAAKiwE,eAFLjwE,KAAK0vE,oBjIw/kBAF,EiIlglBYA,CAA6BpB,KA+OlDoB,GAAqB34B,OAAS,IAAI/2C,MAAMkkC,QAExCwrC,GAAqBxiE,KAAO,CAC3BC,SAAU,iBACVkE,MAAO,CAAElM,KAAM4gE,IACf30D,OAAQ,CAAC,SAHV,ICtPqBigE,GAAAA,SAAAA,GlImhlBnB,SAASA,IACP,OAAO1B,EAAgBpuE,MAAMrB,KAAMoB,YAAcpB,KAHnDoD,EAAe+tE,EAAwB1B,GAMvC,IAAI/pE,EAASyrE,EAAuB5uE,UA6CpC,OA3CAmD,EkI7glBD6G,OAAA,WACCkjE,EAAAltE,UAAMgK,OAAN1I,KAAA7D,MACAA,KAAKoxE,OAAS,KlIihlBd1rE,EkI9glBDgyB,UAAA,WACC13B,KAAKqxE,SAAU,EACf5B,EAAAltE,UAAMm1B,UAAN7zB,KAAA7D,OlIkhlBA0F,EkI/glBD4rE,UAAA,SAAUC,GACLA,GACEvxE,KAAKwxE,SACTxxE,KAAKwxE,OAAS,IAAI1xE,MAAM2xE,UAAUzxE,KAAK0uD,KAAM,QAE9C1uD,KAAKiF,KAAKugC,MAAMnZ,IAAIrsB,KAAKwxE,SACfxxE,KAAKwxE,QACfxxE,KAAKiF,KAAKugC,MAAMn7B,OAAOrK,KAAKwxE,SlIohlB7B9rE,EkIhhlBDgsE,aAAA,WACK1xE,KAAKwxE,QACRxxE,KAAKwxE,OAAOG,cAAc3xE,KAAK0uD,OlIohlBhCvsD,EAAagvE,EAAwB,CAAC,CACpC1wE,IAAK,UACL8D,IAAK,WkItjlBP,OAAOvE,KAAK4xE,UlIyjlBVprE,IAAK,SkIvjlBI6qE,GACPrxE,KAAK4xE,WAAaP,IACrBrxE,KAAK4xE,SAAWP,EAChBrxE,KAAKsxE,UAAUD,QlI4jlBTF,EkIpklBYA,CAA+B/C,IAyCpD+C,GAAuBnkE,KAAO,CAC7BC,SAAU,mBACVkE,MAAO,CAAElM,KAAM4gE,IACf30D,OAAQ,CAAC,SAHV,ICvCqB2gE,GAAAA,SAAAA,GnI6klBnB,SAASA,IACP,OAAOC,EAAsBzwE,MAAMrB,KAAMoB,YAAcpB,KAHzDoD,EAAeyuE,EAA2BC,GAM1C,IAAIpsE,EAASmsE,EAA0BtvE,UA2JvC,OAzJAmD,EmIjllBD6G,OAAA,WACCulE,EAAAvvE,UAAMgK,OAAN1I,KAAA7D,OnIqllBA0F,EmIjllBD8pB,UAAA,WACCxvB,KAAKqxE,QAAUrxE,KAAKy/B,KAAKwB,UnIollBzBv7B,EmIjllBD6oE,SAAA,SAAS2B,EAAOtB,GAAU,IAIrBlgB,EACAX,EALqB9pD,EAAAjE,KACnBy/B,EAAOz/B,KAAKy/B,KACZD,EAAQx/B,KAAKw/B,MACbisB,EAAWzrD,KAAK+xE,uBAAuBtyC,GAG7C20B,GAAUoB,aAAa/1B,GAAMltB,KAC5BkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAACqH,GACRnZ,EAAKmZ,WAAaA,IACrBnZ,EAAKmZ,SAAWA,EAOZ2wC,IACHA,EAAa53C,cACb43C,EAAe,MAGZ3wC,IAAaqiB,EAAKU,OACrBV,EAAKriB,SAAWA,GAChBsxC,EAAO,IAAI0F,GAAU30B,EAAMD,EAAOisB,IAC7Bh8C,KAAO,eACRgwB,EAAKlF,UACRm0B,EAAKn0B,SAASy3C,UAAUvyC,EAAKlF,UAE1BkF,EAAKuX,UACR0X,EAAK1X,SAASg7B,UAAUvyC,EAAKuX,UAE1BvX,EAAK0E,OACRuqB,EAAKvqB,MAAM6tC,UAAUvyC,EAAK0E,OAE3BuqB,EAAK5F,MAAK,WACY,mBAAVonB,GACVA,EAAMxhB,EAAMjvB,GAEbsuB,EAAeW,EAAK5wB,UAAUvrB,KAC7BkE,EAAAA,UAAUxS,EAAKyS,eACdX,WAAU,kBAEb24C,EAAKj2C,GAAG,QAAQ,WAEfxU,EAAKyxC,KAAKzhC,KAAKhQ,MAEhByqD,EAAKj2C,GAAG,WAAW,SAACo+C,GAEnB5yD,EAAKsY,KAAKtI,KAAK,CAAEs5D,OAAQtpE,EAAKw7B,KAAKzuB,GAAI6lD,QAAAA,QAE9B5yD,EAAKyqD,MACfkgB,EAAS3qE,EAAKyqD,KAAMjvB,QnIgmlBvB/5B,EmIzllBDgyB,UAAA,WACCo6C,EAAAvvE,UAAMm1B,UAAN7zB,KAAA7D,MACIA,KAAK0uD,MACR1uD,KAAK0uD,KAAKr5B,WnI+llBX3vB,EmI1llBD+nC,SAAA,SAAShO,EAAMivB,GAYd,GAVIjvB,EAAKlF,UACRm0B,EAAKn0B,SAASy3C,UAAUvyC,EAAKlF,UAE1BkF,EAAKuX,UACR0X,EAAK1X,SAASg7B,UAAUvyC,EAAKuX,UAE1BvX,EAAK0E,OACRuqB,EAAKvqB,MAAM6tC,UAAUvyC,EAAK0E,OAGd1E,EAAKwX,SAAWj3C,KAAKiyE,SAAWxyC,EAAK9jB,SAAW3b,KAAKkyE,SAAWzyC,EAAKyX,MAAQl3C,KAAKmyE,KAAO,CACrGnyE,KAAK0uD,KAAKjD,SAASp2B,UACnB,IAAMo2B,EAAWzrD,KAAK+xE,uBAAuBtyC,GAC7Cz/B,KAAK0uD,KAAKjD,SAAWA,EAEtBzrD,KAAK0xE,gBnIkmlBLhsE,EmI9llBDksC,cAAA,SAAcnS,EAAMivB,GAAM,IAAAl6C,EAAAxU,KAEzBA,KAAK0uD,KAAKsI,aAAav3B,GACvB20B,GAAUoB,aAAa/1B,GAAMltB,KAC5BvP,EAAAA,QAAO,SAAAoa,GAAQ,OAAiB,OAAbA,KACnBg1D,EAAAA,KAAK,IACJr8D,WAAU,SAACqH,GACZqiB,EAAKriB,SAAWA,EAChB5I,EAAKk6C,KAAK5F,MAAK,mBnIsmlBhBpjD,EmI/llBDwmE,WAAA,SAAW3xC,GACVv6B,KAAKy/B,KAAK8R,WAAY,EACtBvxC,KAAKqxE,SAAU,EACfrxE,KAAK0uD,KAAKn0B,SAAS/zB,IAAI+zB,EAASjrB,EAAGirB,EAAS+G,EAAG/G,EAASoL,GAAGmR,eAAe,IAC1E92C,KAAK0uD,KAAK9X,OAAOi7B,EAA0Bh7B,QAC3C72C,KAAK0xE,gBnImmlBLhsE,EmI/llBDyrC,UAAA,WACCnxC,KAAKy/B,KAAKlF,SAAWv6B,KAAK0uD,KAAKn0B,SAASwc,UACxC/2C,KAAKy/B,KAAKuX,SAAWh3C,KAAK0uD,KAAK1X,SAASD,UACxC/2C,KAAKy/B,KAAK0E,MAAQnkC,KAAK0uD,KAAKvqB,MAAM4S,UAClC/2C,KAAKqxE,SAAU,GnIkmlBf3rE,EmI/llBDqsE,uBAAA,SAAuBtyC,GACtBz/B,KAAKiyE,QAAUxyC,EAAKwX,OACpBj3C,KAAKkyE,QAAUzyC,EAAK9jB,OACpB3b,KAAKmyE,KAAO1yC,EAAKyX,IACjB,IAAMA,EAAM18B,KAAK2zC,GAAK,IAAM1uB,EAAKyX,IAC3BuU,EAAW,IAAI3rD,MAAMiwE,uBAAuBtwC,EAAKwX,OAAQxX,EAAKwX,OAAQxX,EAAK9jB,OAAQ,GAAI,GAAG,EAAM,EAAGu7B,GAGzG,OAFAuU,EAASyC,SAAS1zC,KAAK2zC,GAAKjX,EAAM,GAClCuU,EAAStnB,OAAO,EAAG,EAAG,GACfsnB,GnIkmlBAomB,EmI5ulBYA,CAAkCV,IA+IvDU,GAA0Bh7B,OAAS,IAAI/2C,MAAMkkC,QAC7C6tC,GAA0BQ,SAAW,GAErCR,GAA0B7kE,KAAO,CAChCC,SAAU,uBACVkE,MAAO,CAAElM,KAAM4gE,IACft1C,QAAS,CAAC,OAAQ,QAClBrf,OAAQ,CAAC,OAAQ,UAJlB,IC3IqBohE,GAAAA,WAapB,SAAAA,IACC,GAAIA,EAAazuC,SAChB,KAAO,qCAER7jC,KAAK0X,SAAW,IAAIxC,EAAAA,gBAAgB,MpI+vlBpC,OA/BAo9D,EoI/ulBMztC,WAAP,WAIC,OAHK7kC,KAAK6jC,WACT7jC,KAAK6jC,SAAW,IAAIyuC,GAEdtyE,KAAK6jC,UpImvlBZ1hC,EAAamwE,EAAc,CAAC,CAC1B7xE,IAAK,UACL8D,IAAK,WoIjvlBP,OAAOvE,KAAK0X,SAASY,epI8vlBRg6D,EAAa/vE,UoIpvlB3BgwE,WAAA,SAAW96D,GACNzX,KAAKyX,UAAYA,GACpBzX,KAAK0X,SAASzD,KAAKwD,IpI0vlBb66D,EoIhxlBYA,GCLAE,GAAAA,SAAAA,GrIyxlBnB,SAASA,IACP,OAAO/C,EAAgBpuE,MAAMrB,KAAMoB,YAAcpB,KAHnDoD,EAAeovE,EAAqB/C,GAMpC+C,EqI3xlBMnf,UAAP,WACC,OAAOmf,EAAoB/oB,SAAW+oB,EAAoB/oB,OAAS,IAAI3pD,MAAM2yE,arI8xlB7ED,EqI3xlBME,cAAP,SAAqBh6D,GACpB,OAAO85D,EAAoBG,aAAeH,EAAoBG,WAAaH,EAAoBnf,YAAYvK,KAAK/9C,EAAY1E,QAAQ,qDAAsDqS,KrI8xlB1L,IAAIhT,EAAS8sE,EAAoBjwE,UA6JjC,OA3JAmD,EqI3wlBD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRyvE,EAAAltE,UAAMgK,OAAN1I,KAAA7D,OAGkBA,KAAK8lC,UAAYlC,GAAUiB,cACnCL,SAASjyB,KAClBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAC+uB,GACRA,EACC7gC,EAAKmO,MACRnO,EAAK2uE,UAAUvmD,IAAIpoB,EAAKmO,MAGrBnO,EAAKmO,MACRnO,EAAKmO,KAAKg4D,OAAO//D,OAAOpG,EAAKmO,UAIXpS,KAAK6yE,aAAeP,GAAaztC,cACzCntB,SAASnF,KACrBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA0B,GAAO,OAAIxT,EAAKwT,QAAUA,MrI+wlBtC/R,EqI5wlBDotE,WAAA,WACC,IAAM1+B,EAASvvC,SAAS0W,cAAc,UAEtC64B,EAAO14B,MAAQ82D,EAAoBrC,EACnC/7B,EAAOz4B,OAAS62D,EAAoBpC,EACpC,IAAMhmE,EAAU,IAAItK,MAAMwxD,cAAcld,GACxChqC,EAAQ0lE,SAAWhwE,MAAM8wD,aACzBxmD,EAAQggD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UACxBpgD,EAAQsgD,aAAc,EACtB,IAAMe,EAAW,IAAI3rD,MAAMi9D,oBAAoB,EAAG,EAAG,EAAG,GAClDrR,EAAW,IAAI5rD,MAAM8rD,kBAAkB,CAC5CyB,WAAW,EACXgB,YAAY,EACZh/C,IAAKjF,EACLyhD,MAAO,SACP8I,aAAa,EACbp8B,QAAS,IAIJnmB,EAAO,IAAItS,MAAMssD,KAAKX,EAAUC,GAGtC,OAFAt5C,EAAKmzB,SAAWx6B,EAAYN,YAAYI,MACxCuH,EAAKmoB,SAAS+G,EAAI,EACXlvB,GrIgxlBP1M,EqI7wlBDqtE,SAAA,WAAW,IAAAv+D,EAAAxU,KACVA,KAAK2yE,WAAaH,EAAoBE,eAAc,SAACnC,GACpD/7D,EAAK+7D,KAAOA,EACR/7D,EAAKw+D,UACRx+D,EAAKy+D,QAAQz+D,EAAKw+D,crIqxlBpBttE,EqIhxlBD6oE,SAAA,SAAS2B,EAAOtB,GACf,IAAMgE,EAAY5yE,KAAK4yE,UAAY,IAAI9yE,MAAM+yD,MAC5B7yD,KAAK0rD,SAAW,IAAI5rD,MAAM8rD,kBAAkB,CAC5DyB,WAAW,EACXxB,MAAO,SACP8I,aAAa,EACbp8B,QAAS,EACT68B,KAAMt1D,MAAMu1D,aAEAr1D,KAAKoS,KAAOpS,KAAK8yE,aACT,mBAAV5C,GACVA,EAAM0C,IrIwxlBPltE,EqIhxlBD+rD,OAAA,SAAO6Z,EAAMC,GACZ,IAAM37D,EAAQ5P,KAAK4P,MACfm0B,EAAS/jC,KAAKiF,KAAK8+B,OACjBxJ,EAAWv6B,KAAKu6B,SAClBv6B,KAAKiF,KAAKsgC,SAASb,GAAG0jC,eACzBrkC,EAAS/jC,KAAKiF,KAAKsgC,SAASb,GAAGwuC,UAAUnvC,IAI1CA,EAAOovC,kBAAkB54C,GAKzBA,EAASuc,eAAe,GAIxBlnC,EAAM2qB,SAASoc,KAAKpc,GACpB3qB,EAAMgnC,OAAO47B,EAAoB37B,SrIoxlBjCnxC,EqIhxlBDutE,QAAA,SAAQx7D,GACP,IAAMrF,EAAOpS,KAAKoS,KAClB,GAAIA,EACH,GAAIpS,KAAKiF,KAAKsgC,SAASb,GAAG0jC,cAA2B,MAAX3wD,EAAiB,CAE1D,IAAM48B,EAAMjiC,EAAKs5C,SAASr8C,IAAIlH,MAAMwE,WAAW,MAC/C0nC,EAAIo8B,UAAU,EAAG,EAAG+B,EAAoBrC,EAAGqC,EAAoBpC,GAG/D/7B,EAAIk8B,KAAJ,QAAmBxlE,EAAYP,WAC/B6pC,EAAIs8B,aAAe,SACnBt8B,EAAIq8B,UAAY,SAChBr8B,EAAI0d,UAAY,UAChB1d,EAAIu8B,YAAc,UAClBv8B,EAAIw8B,UAAY,EAChBx8B,EAAI48B,SAASx5D,EAAS+6D,EAAoBrC,EAAI,EAAGqC,EAAoBpC,EAAI,EAAGoC,EAAoBrC,EAAI,IACpG/9D,EAAKs5C,SAASr8C,IAAIq7C,aAAc,EAEhC1qD,KAAK4yE,UAAUvmD,IAAIja,QACTA,EAAKg4D,QACfh4D,EAAKg4D,OAAO//D,OAAO+H,IrIsxlBrBjQ,EAAaqwE,EAAqB,CAAC,CACjC/xE,IAAK,UACL8D,IAAK,WqIp6lBP,OAAOvE,KAAKgzE,UrIu6lBVxsE,IAAK,SqIp6lBIiR,GACXA,EAAUA,GAAuB,KAAZA,EAAiBA,EAAU,KAC5CzX,KAAKgzE,WAAav7D,IACrBzX,KAAKgzE,SAAWv7D,EAEhBzX,KAAKizE,QAAQx7D,QrI+6lBP+6D,EqIl8lBYA,CAA4BpE,IA8JjDoE,GAAoB37B,OAAS,IAAI/2C,MAAMkkC,QACvCwuC,GAAoBrC,EAAI,KACxBqC,GAAoBpC,EAAI,IAExBoC,GAAoBxlE,KAAO,CAC1BC,SAAU,gBACVkE,MAAO,CAAElM,KAAM4gE,KCrKhB,IA6BqBuN,GAAAA,SAAAA,GtIs7lBnB,SAASA,IACP,OAAO3D,EAAgBpuE,MAAMrB,KAAMoB,YAAcpB,KAHnDoD,EAAegwE,EAAoB3D,GAMnC2D,EsIx7lBM/f,UAAP,WACC,OAAO+f,EAAmB3pB,SAAW2pB,EAAmB3pB,OAAS,IAAI3pD,MAAM4pD,gBtI27lB3E0pB,EsIx7lBMC,WAAP,WACC,OAAOD,EAAmBhpE,UAAYgpE,EAAmBhpE,QAAUgpE,EAAmB/f,YAAYvK,KAAK/9C,EAAY1E,QAAQ,gCtI27lB3H+sE,EsIx7lBME,eAAP,WACC,OAAOF,EAAmBG,cAAgBH,EAAmBG,YAAcH,EAAmB/f,YAAYvK,KAAK/9C,EAAY1E,QAAQ,qCtI27lBnI,IAAIX,EAAS0tE,EAAmB7wE,UAgUhC,OA9TAmD,EsIh3lBD8tE,UAAA,SAAUrmB,GACT,IAAMsmB,EAAgBL,EAAmBhC,OAAS,GAC5CnrB,EAAMzrC,KAAKqiD,MAAM1P,EAAM79C,EAAImkE,EAAgB,GAAKA,GAAiB,EACjEC,EAAMl5D,KAAKqiD,MAAM1P,EAAMxnB,EAAI8tC,EAAgB,GAAKA,GAAiB,EACjEE,EAAKn5D,KAAKoK,MAAMwuD,EAAmBQ,KAAO,GAC1CC,EAAKr5D,KAAKoK,MAAMwuD,EAAmBU,KAAO,GAC1CC,EAAKv5D,KAAKO,IAAI44D,EAAIn5D,KAAKub,IAAIkwB,KAASA,EAAMzrC,KAAKub,IAAIkwB,GAAOA,EAAM,GAChE+tB,EAAKx5D,KAAKO,IAAI84D,EAAIr5D,KAAKub,IAAI29C,KAASA,EAAMl5D,KAAKub,IAAI29C,GAAOA,EAAM,GACtE,GAAI1zE,KAAK2J,KAAK+3B,QAAQ1hC,KAAKohC,QAAQ9xB,EAAIykE,EAAI/zE,KAAKohC,QAAQE,EAAI0yC,GAE3D,OAAO,IAAIl0E,MAAMuhC,QAAQ0yC,EAAIC,ItIs3lB9BtuE,EsIl3lBD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRyvE,EAAAltE,UAAMgK,OAAN1I,KAAA7D,MACAA,KAAKohC,QAAU,IAAIthC,MAAMuhC,QAEzBrhC,KAAK2J,KAAKq3B,OAAOzuB,KAChBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA7M,GACXjF,EAAKgwE,YAAY/qE,OtIu3lBlBxD,EsIn3lBDwuE,SAAA,SAASxlB,GAAM,IAAAl6C,EAAAxU,KAERyzE,EAAgBL,EAAmBhC,OAAS,GAC5C+C,EAAgC,GAAhBV,EAChBhoB,EAAW,IAAI3rD,MAAMi9D,oBAAoBoX,EAAeA,EAAe,EAAG,GAChF1oB,EAAS2oB,SAAS55D,KAAK2zC,GAAK,GAC5B,IAAM9+C,EAAM+jE,EAAmBC,aAC/BhkE,EAAI8nD,YAAa,EACjB9nD,EAAIygE,SAAWhwE,MAAM8wD,aACrB,IAAMyjB,EAAUjB,EAAmBE,iBACnCe,EAAQld,YAAa,EACrBkd,EAAQvE,SAAWhwE,MAAM8wD,aAEzB,IAAM0jB,EAAUt0E,KAAKs0E,QAAU,GACjBt0E,KAAK2/B,MAAQ,IAAIx7B,MAAMivE,EAAmBQ,KAAOR,EAAmBU,MAAMt8C,KAAK,GAAGnoB,KAAI,SAACC,EAAG3N,GACvG,IAAM+pD,EAAW,IAAI5rD,MAAMsuD,eAAe,CACzCf,WAAW,EACXgB,YAAY,EACZsG,aAAa,EACbrG,aAjKe,2KAkKfC,eAxJiB,kaAyJjBC,SAAU,CACToG,SAAU,CAAEtkD,KAAM,IAAK1P,MAAOyO,GAC9BwlD,SAAU,CAAEvkD,KAAM,IAAK1P,MAAOyzE,GAC9BrmB,MAAO,CAAEptD,MAAO,GAChB23B,QAAS,CAAE33B,MAAO,MAcd8J,EAAO,IAAI5K,MAAMssD,KAAKX,EAAUC,GAChCioB,EAAKn5D,KAAKoK,MAAMwuD,EAAmBQ,KAAO,GAC1CC,EAAKr5D,KAAKoK,MAAMwuD,EAAmBU,KAAO,GAC1CJ,EAAMl5D,KAAKoK,MAAMjjB,EAAIyxE,EAAmBQ,MAExCG,GAAMJ,EADAhyE,EAAIyxE,EAAmBQ,KAE7BI,GAAMH,EAAKH,EAEjBhpE,EAAK6vB,SAAS/zB,IAAIutE,EAAKN,EAA4C,KAA5BL,EAAmBhC,OAAe4C,EAAKP,GAC9E/oE,EAAK+E,KAAO+E,EAAK65D,QAAL,QAAqB0F,EAArB,IAA2BC,GACtBtpE,EAAK8jD,SAAW,CAChCR,MAAO,EACPz1B,QAAS,EACTw7C,GAAIA,EACJC,GAAIA,GAIL,OAFAM,EAAWP,EAAJ,IAAUC,GAAQtpE,EACzBgkD,EAAKriC,IAAI3hB,GACFA,KAER1K,KAAKu0E,atIo4lBL7uE,EsIj4lBD6uE,UAAA,WAAY,IAAA5/D,EAAA3U,KACXA,KAAK2/B,MAAMz7B,SAAQ,SAACwG,EAAM/I,GACzB,IAAM6yE,EAAK7/D,EAAKysB,QAAUzsB,EAAKysB,QAAQ9xB,EAAI,EACrCmlE,EAAK9/D,EAAKysB,QAAUzsB,EAAKysB,QAAQE,EAAI,EACrC2jC,EAAUtwD,EAAKhL,KAAK+3B,QAAQ8yC,EAAK9pE,EAAK8jD,SAASulB,GAAIU,EAAK/pE,EAAK8jD,SAASwlB,IACtExlB,EAAW9jD,EAAK8jD,SACtBgI,KAAKrZ,GAAGqR,EAAU,CACjBj2B,QAAS0sC,EAAU,EAAI,EACvBx4B,SAAU,GAEVgqB,KAAMC,OAAOC,UACblpB,SAAU,WACT/iC,EAAKghD,SAAS8C,SAASj2B,QAAQ33B,MAAQ4tD,EAASj2B,QAChD7tB,EAAKghD,SAAShB,aAAc,StI24lB/BhlD,EsIr4lBDgvE,WAAA,SAAWhmB,GACV1uD,KAAK20E,aAAe30E,KAAK20E,aAAar0D,KAAKtgB,MAC3CA,KAAK40E,aAAe50E,KAAK40E,aAAat0D,KAAKtgB,MAC3CA,KAAK60E,aAAe70E,KAAK60E,aAAav0D,KAAKtgB,MAC3CA,KAAK80E,YAAc90E,KAAK80E,YAAYx0D,KAAKtgB,MAGzC,IAAMyrD,EAAW,IAAI3rD,MAAMi9D,oBAAoBqW,EAAmBhC,OAAQgC,EAAmBhC,OAAQ,GAAI,IACzG3lB,EAAS2oB,SAAS55D,KAAK2zC,GAAK,GAE5B,IAAMzC,EAAW,IAAI5rD,MAAM8rD,kBAAkB,CAC5CyB,WAAW,EACXgB,YAAY,EACZsG,aAAa,EACbp8B,QAAS,IAGJw8C,EAAS/0E,KAAK+0E,OAAS,IAAIznB,GAAgB7B,EAAUC,GAC3DqpB,EAAOtlE,KAAOzP,KAAKquE,QAAQ,UAC3B0G,EAAOx6C,SAAS/zB,IAAI,EAAgC,KAA5B4sE,EAAmBhC,OAAe,GAC1D2D,EAAOt8D,GAAG,OAAQzY,KAAK20E,cACvBI,EAAOt8D,GAAG,OAAQzY,KAAK40E,cACvBG,EAAOt8D,GAAG,MAAOzY,KAAK80E,aACtBC,EAAOt8D,GAAG,OAAQzY,KAAK60E,cACvBnmB,EAAKriC,IAAI0oD,ItIs4lBTrvE,EsIn4lBDivE,aAAA,WACC,IAAMI,EAAS/0E,KAAK+0E,OACdC,EAASh1E,KAAKwzE,UAAUuB,EAAO/nB,aAAaG,OAClDntD,KAAKg1E,OAASA,GtIs4lBdtvE,EsIn4lBDkvE,aAAA,WACC,IAAMG,EAAS/0E,KAAK+0E,OACdC,EAASh1E,KAAKwzE,UAAUuB,EAAO/nB,aAAaG,OAClDntD,KAAKg1E,OAASA,GtIs4lBdtvE,EsIn4lBDmvE,aAAA,WACC,IAAME,EAAS/0E,KAAK+0E,OACdC,EAASh1E,KAAKwzE,UAAUuB,EAAO/nB,aAAaG,OAElD,GADAntD,KAAKg1E,OAASA,EACVA,EAAQ,CACX,IAAM9rE,EAAQlJ,KAAK2J,KAAK83B,aAAazhC,KAAKohC,QAAQ9xB,EAAI0lE,EAAO1lE,EAAGtP,KAAKohC,QAAQE,EAAI0zC,EAAO1zC,GACxFthC,KAAK2J,KAAKT,MAAQA,EAClBlJ,KAAKiK,IAAIgK,KAAK/K,KtIk5lBfxD,EsIp4lBDovE,YAAA,WACC90E,KAAKg1E,OAAS,MtIu4lBdtvE,EsIp4lBDuuE,YAAA,SAAY/qE,GAEXlJ,KAAKg1E,OAAS,KACd,IAAMtqE,EAAO1K,KAAK2J,KAAKg2B,MAAMz2B,GACvB8rE,EAAS,IAAIl1E,MAAMuhC,QAAQ32B,EAAK02B,QAAQ9xB,EAAItP,KAAKohC,QAAQ9xB,EAAG5E,EAAK02B,QAAQE,EAAIthC,KAAKohC,QAAQE,GAChGthC,KAAKohC,QAAQ9xB,EAAI5E,EAAK02B,QAAQ9xB,EAC9BtP,KAAKohC,QAAQE,EAAI52B,EAAK02B,QAAQE,EAC9BthC,KAAKu0E,YACL,IAAMd,EAAgBL,EAAmBhC,OAAS,GAClDpxE,KAAKi1E,KAAKhhE,KAAK,CACdmtB,QAASphC,KAAKohC,QACd4zC,OAAAA,EACAz6C,SAAUy6C,EAAOzhD,QAAQujB,eAAe28B,MtIy4lBzC/tE,EsIr4lBD6oE,SAAA,SAAS2B,EAAOtB,GAEf,IAAMlgB,EAAO,IAAI5uD,MAAM+yD,MACvB7yD,KAAKk0E,SAASxlB,GACd1uD,KAAK00E,WAAWhmB,GAQK,mBAAVwhB,GACVA,EAAMxhB,ItIy4lBPhpD,EsIr4lBDgyB,UAAA,WACC+3C,EAAAltE,UAAMm1B,UAAN7zB,KAAA7D,MACA,IAAM+0E,EAAS/0E,KAAK+0E,OACpBA,EAAOn8D,IAAI,OAAQ5Y,KAAK20E,cACxBI,EAAOn8D,IAAI,OAAQ5Y,KAAK40E,cACxBG,EAAOn8D,IAAI,OAAQ5Y,KAAK60E,cACxBE,EAAOn8D,IAAI,MAAO5Y,KAAK80E,ctIy4lBvB3yE,EAAaixE,EAAoB,CAAC,CAChC3yE,IAAK,SACL+F,IAAK,SsItqmBGwuE,GACV,IAAMA,GAAUh1E,KAAKk1E,UAAYF,IAAYh1E,KAAKk1E,SAAWF,EAAO1lE,IAAMtP,KAAKk1E,QAAQ5lE,GAAK0lE,EAAO1zC,IAAMthC,KAAKk1E,QAAQ5zC,EAAG,CAExH,IAAMgzC,EAAUt0E,KAAKs0E,QACrB,GAAIt0E,KAAKk1E,QAAS,CACjB,IAAMC,EAAeb,EAAWt0E,KAAKk1E,QAAQ5lE,EAAjB,IAAsBtP,KAAKk1E,QAAQ5zC,GACzD8zC,EAAmBD,EAAa3mB,SACtCgI,KAAKrZ,GAAGi4B,EAAkB,CACzBpnB,MAAO,EACPvhB,SAAU,GACViE,MAAO,EACP+lB,KAAMC,OAAOC,UACblpB,SAAU,WACT0nC,EAAazpB,SAAS8C,SAASR,MAAMptD,MAAQw0E,EAAiBpnB,MAC9DmnB,EAAazpB,SAAShB,aAAc,KAIvC,GAAIsqB,EAAQ,CACX,IAAMtjC,EAAc1xC,KAAK0xC,YAAc4iC,EAAWU,EAAO1lE,EAAX,IAAgB0lE,EAAO1zC,GAC/D+zC,EAAkB3jC,EAAY8c,SACpCgI,KAAKrZ,GAAGk4B,EAAiB,CACxBrnB,MAAO,EACPvhB,SAAU,GACViE,MAAO,EACP+lB,KAAMC,OAAOC,UACblpB,SAAU,WACTiE,EAAYga,SAAS8C,SAASR,MAAMptD,MAAQy0E,EAAgBrnB,MAC5Dtc,EAAYga,SAAShB,aAAc,KAKtC1qD,KAAKk1E,QAAUF,KtI2qmBb,CACDv0E,IAAK,WACL+F,IAAK,SsIzqmBKwuE,GACZ,IAAMA,GAAUh1E,KAAKk1E,UAAYF,IAAYh1E,KAAKk1E,SAAWF,EAAO1lE,IAAMtP,KAAKk1E,QAAQ5lE,GAAK0lE,EAAO1zC,IAAMthC,KAAKk1E,QAAQ5zC,EAAG,CAExH,IAAMgzC,EAAUt0E,KAAKs0E,QACrB,GAAIt0E,KAAKk1E,QAAS,CACjB,IAAMC,EAAeb,EAAWt0E,KAAKk1E,QAAQ5lE,EAAjB,IAAsBtP,KAAKk1E,QAAQ5zC,GACzD3vB,EAAO,CAAEq8C,MAAO,GACtBwI,KAAKrZ,GAAGxrC,EAAM,CACb86B,SAAU,GACVuhB,MAAO,EACPtd,MAAO,EACP+lB,KAAMC,OAAOC,UACblpB,SAAU,WACT0nC,EAAazpB,SAASnzB,QAAU5mB,EAAKq8C,SAKxC,GAAIgnB,EAAQ,CACX,IAAMtjC,EAAc1xC,KAAK0xC,YAAc4iC,EAAWU,EAAO1lE,EAAX,IAAgB0lE,EAAO1zC,GAC/D3vB,EAAO,CAAEq8C,MAAO,GACtBwI,KAAKrZ,GAAGxrC,EAAM,CACb86B,SAAU,GACVuhB,MAAO,EACPtd,MAAO,EACP+lB,KAAMC,OAAOC,UACblpB,SAAU,WACTiE,EAAYga,SAASnzB,QAAU5mB,EAAKq8C,SAMvChuD,KAAKk1E,QAAUF,OtIkrmBT5B,EsItwmBYA,CAA2BhF,IA8ShDgF,GAAmBv8B,OAAS,IAAI/2C,MAAMkkC,QACtCovC,GAAmBhC,OAAS,IAC5BgC,GAAmBQ,KAAO,GAC1BR,GAAmBU,KAAO,GAE1BV,GAAmBpmE,KAAO,CACzBC,SAAU,eACVkE,MAAO,CAAElM,KAAM4gE,IACft1C,QAAS,CAAC,OAAQ,OAClBrf,OAAQ,CAAC,SAJV,ICtUaokE,GAAb,SAAAhhB,GA8DC,SAAAghB,EAAY71C,EAAMv2B,EAAO08C,GAAO,IAAA3hD,EACzBwnD,EAAW6pB,EAAW7pB,SACtBC,EAAW4pB,EAAW5pB,UAC5BznD,EAAAqwD,EAAAzwD,KAAA7D,KAAMyrD,EAAUC,IAAhB1rD,MAGKyK,YAAcM,EAAYN,YAAYnD,KAC3CrD,EAAKwL,KAAOgwB,EAAKhwB,KACjBxL,EAAKw7B,KAAOA,EACZx7B,EAAKiF,MAAQA,EACbjF,EAAK2hD,MAAQA,EACb3hD,EAAK+pD,MAAQ,EACb/pD,EAAKs0B,QAAU,EACf,IAAMq8B,EAAW3wD,EAAK2wD,SAAW3wD,EAAKsxE,YAAY91C,EAAKhwB,MAEvDi8C,EAAS8C,SAASoG,SAASh0D,MAAQg0D,EACnClJ,EAAS8C,SAASsG,YAAYl0D,MAAQ,IAAId,MAAMuhC,QAAQuzB,EAASl5C,MAAOk5C,EAASj5C,QACjF,IAAMk5C,EAAW5wD,EAAK4wD,SAAW5wD,EAAKuxE,YAAY/1C,EAAKhwB,MAjBxB,OAmB/Bi8C,EAAS8C,SAASqG,SAASj0D,MAAQi0D,EACnCnJ,EAAS8C,SAASsG,YAAYl0D,MAAQ,IAAId,MAAMuhC,QAAQwzB,EAASn5C,MAAOm5C,EAASl5C,QACjF+vC,EAAS8C,SAASR,MAAMptD,MAAQqD,EAAK+pD,MACrCtC,EAAS8C,SAASj2B,QAAQ33B,MAAQqD,EAAKs0B,QACvCmzB,EAAShB,aAAc,EACvBzmD,EAAKs2B,SAAS/zB,IAAI8uE,EAAWG,KAAKvsE,EAAO08C,GAAQ0vB,EAAWI,KAAKxsE,EAAO08C,GAAQ,GAChF3hD,EAAK8xD,OAAS9xD,EAAK8xD,OAAOz1C,KAAZ5c,EAAAO,IACdA,EAAK+xD,MAAQ/xD,EAAK+xD,MAAM11C,KAAX5c,EAAAO,IA1BkBA,EA9DjCb,EAAAkyE,EAAAhhB,GAAAghB,EAEQK,QAAP,SAAe/vB,GACd,IAAMT,EAAO3qC,KAAKqiD,KAAKjX,EAAQ0vB,EAAWxB,MAE1C,MAAO,CADMt5D,KAAKqiD,KAAKjX,EAAQT,GACjBA,IALhBmwB,EAQQG,KAAP,SAAYvsE,EAAO08C,GAClB,IAAMT,EAAO3qC,KAAKqiD,KAAKjX,EAAQ0vB,EAAWxB,MAEpC1jE,EAAIlH,EAAQi8C,EACZvf,EAAK,EAAI0vC,EAAWnF,GAAKmF,EAAWnF,EAAImF,EAAWM,GACzD,OAAQhwC,EAAI,EAAIuf,EAAOvf,EAAI,EAAKx1B,EAAIw1B,GAbtC0vC,EAgBQI,KAAP,SAAYxsE,EAAO08C,GAClB,IAAMT,EAAO3qC,KAAKqiD,KAAKjX,EAAQ0vB,EAAWxB,MACpC+B,EAAOr7D,KAAKqiD,KAAKjX,EAAQT,GAEzBuX,EAAIliD,KAAKoK,MAAM1b,EAAQi8C,GACvBzC,EAAK,EAAI4yB,EAAWnF,GAAKmF,EAAWlF,EAAIkF,EAAWM,GACzD,OAAQC,EAAOnzB,EAAI,EAAIA,EAAI,EAAKga,GAAKha,GAtBvCvgD,EAAAmzE,EAAA,KAAA,CAAA,CAAA70E,IAAA,WAAA8D,IAAA,WA0BE,GAAIvE,KAAK81E,UACR,OAAO91E,KAAK81E,UAEb,IAAMrqB,EAAW,IAAI3rD,MAAMi9D,oBAAoB,EAAG,EAAIuY,EAAWnF,EAAImF,EAAWlF,EAAG,EAAG,GAItF,OADApwE,KAAK81E,UAAYrqB,EACVA,IAjCT,CAAAhrD,IAAA,WAAA8D,IAAA,WA2DE,OAtBiB,IAAIzE,MAAMsuD,eAAe,CACzCf,WAAW,EACXsH,aAAa,EACbrG,aAAcynB,GAAmB7hB,cACjC3F,eAAgBwnB,GAAmBC,gBACnCxnB,SAAU,CACToG,SAAU,CAAEtkD,KAAM,IAAK1P,MAAO,MAC9Bi0D,SAAU,CAAEvkD,KAAM,IAAK1P,MAAO,MAC9Bk0D,YAAa,CAAEl0D,MAAO,IAAId,MAAMuhC,SAChC0zB,YAAa,CAAEn0D,MAAO,IAAId,MAAMuhC,SAChC2sB,MAAO,CAAEptD,MAAO,GAChB23B,QAAS,CAAE33B,MAAO,UAhDtB,IAAA8E,EAAA4vE,EAAA/yE,UAAA,OAAAmD,EA2FC6vE,YAAA,SAAYnjE,GACX,IAAMwzB,EAAI0vC,EAAWnF,EACfztB,EAAI4yB,EAAWlF,EACfh8B,EAASvvC,SAAS0W,cAAc,UACtC64B,EAAO14B,MAAQkqB,EACfwO,EAAOz4B,OAAS+mC,EAChB,IAAMrO,EAAMD,EAAOznC,WAAW,MAC9B0nC,EAAI0d,UAAYhnD,EAAY1C,OAAOC,eACnC+rC,EAAI2d,SAAS,EAAG,EAAGpsB,EAAG8c,GACtBrO,EAAIk8B,KAAJ,QAAmBxlE,EAAYP,WAC/B6pC,EAAI0d,UAAYhnD,EAAY1C,OAAOE,eACnC8rC,EAAI48B,SAAS7+D,EAAM,GAAI,GAAIwzB,EAAI,IAC/B,IAAMx7B,EAAU,IAAItK,MAAMwxD,cAAcld,GAMxC,OALAhqC,EAAQggD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UACxBpgD,EAAQ0lE,SAAWhwE,MAAM8wD,aACzBxmD,EAAQsgD,aAAc,EACftgD,GA7GT1E,EAgHC8vE,YAAA,SAAYpjE,GACX,IAAMwzB,EAAI0vC,EAAWnF,EACfztB,EAAI4yB,EAAWlF,EACfh8B,EAASvvC,SAAS0W,cAAc,UACtC64B,EAAO14B,MAAQkqB,EACfwO,EAAOz4B,OAAS+mC,EAChB,IAAMrO,EAAMD,EAAOznC,WAAW,MAC9B0nC,EAAI0d,UAAYhnD,EAAY1C,OAAOG,mBACnC6rC,EAAI2d,SAAS,EAAG,EAAGpsB,EAAG8c,GACtBrO,EAAIk8B,KAAJ,QAAmBxlE,EAAYP,WAC/B6pC,EAAI0d,UAAYhnD,EAAY1C,OAAOI,mBACnC4rC,EAAI48B,SAAS7+D,EAAM,GAAI,GAAIwzB,EAAI,IAC/B,IAAMx7B,EAAU,IAAItK,MAAMwxD,cAAcld,GAIxC,OAHAhqC,EAAQ0lE,SAAWhwE,MAAM8wD,aACzBxmD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQsgD,aAAc,EACftgD,GAhIT1E,EAmICqwD,OAAA,WAAS,IAAAvhD,EAAAxU,KAERw2D,KAAKrZ,GAAGn9C,KAAM,CACbysC,SAAU,GACVuhB,MAAO,EACPyI,KAAMC,OAAOmW,QACbp/B,SAAU,WACTj5B,EAAK+lB,SAASoL,EAAI,GAAMnxB,EAAKw5C,MAC7Bx5C,EAAKk3C,SAAS8C,SAASR,MAAMptD,MAAQ4T,EAAKw5C,MAC1Cx5C,EAAKk3C,SAAShB,aAAc,MA5IhChlD,EAiJCswD,MAAA,WAAQ,IAAArhD,EAAA3U,KACPw2D,KAAKrZ,GAAGn9C,KAAM,CACbysC,SAAU,GACVuhB,MAAO,EACPyI,KAAMC,OAAOmW,QACbp/B,SAAU,WACT94B,EAAK4lB,SAASoL,EAAI,GAAMhxB,EAAKq5C,MAC7Br5C,EAAK+2C,SAAS8C,SAASR,MAAMptD,MAAQ+T,EAAKq5C,MAC1Cr5C,EAAK+2C,SAAShB,aAAc,MAzJhChlD,EA8JC2vB,QAAA,WACCk3B,GAAYl3B,QAAQr1B,MACpBA,KAAK40D,SAASv/B,UACdr1B,KAAK60D,SAASx/B,UACdr1B,KAAK0rD,SAASr2B,UACdr1B,KAAKyrD,SAASp2B,WAnKhBigD,EAAA,CAAgChoB,IAuKhCgoB,GAAWnF,EAAI,IACfmF,GAAWlF,EAAI,GACfkF,GAAWM,EAAI,EACfN,GAAWxB,KAAO,EvI00mBlB,IuIx0mBamC,GAAb,SAAAC,GAEC,SAAAD,EAAYx2C,EAAMv2B,EAAO08C,GAAO,OAC/BswB,EAAAryE,KAAA7D,KAAMy/B,EAAMv2B,EAAO08C,IADY5lD,KAFjCoD,EAAA6yE,EAAAC,GAAA,IAAArnD,EAAAonD,EAAA1zE,UAAA,OAAAssB,EAMC0mD,YAAA,SAAYnjE,GACX,IAAMwzB,EAAI0vC,GAAWnF,EACfztB,EAAI4yB,GAAWlF,EACfh8B,EAASvvC,SAAS0W,cAAc,UACtC64B,EAAO14B,MAAQkqB,EACfwO,EAAOz4B,OAAS+mC,EAChB,IAAMrO,EAAMD,EAAOznC,WAAW,MAC9B0nC,EAAI0d,UAAYhnD,EAAY1C,OAAOK,mBACnC2rC,EAAI2d,SAAS,EAAG,EAAGpsB,EAAG8c,GACtBrO,EAAIk8B,KAAJ,QAAmBxlE,EAAYP,WAC/B6pC,EAAI0d,UAAYhnD,EAAY1C,OAAOM,mBACnC0rC,EAAI48B,SAAS7+D,EAAM,GAAI,GAAIwzB,EAAI,IAC/B,IAAMx7B,EAAU,IAAItK,MAAMwxD,cAAcld,GAKxC,OAJAhqC,EAAQggD,UAAYtqD,MAAMuqD,aAC1BjgD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQmgD,QAAUzqD,MAAM0qD,UACxBpgD,EAAQsgD,aAAc,EACftgD,GAvBTykB,EA0BC2mD,YAAA,SAAYpjE,GACX,IAAMwzB,EAAI0vC,GAAWnF,EACfztB,EAAI4yB,GAAWlF,EACfh8B,EAASvvC,SAAS0W,cAAc,UACtC64B,EAAO14B,MAAQkqB,EACfwO,EAAOz4B,OAAS+mC,EAChB,IAAMrO,EAAMD,EAAOznC,WAAW,MAC9B0nC,EAAI0d,UAAYhnD,EAAY1C,OAAOO,uBACnCyrC,EAAI2d,SAAS,EAAG,EAAGpsB,EAAG8c,GACtBrO,EAAIk8B,KAAJ,QAAmBxlE,EAAYP,WAC/B6pC,EAAI0d,UAAYhnD,EAAY1C,OAAOQ,uBACnCwrC,EAAI48B,SAAS7+D,EAAM,GAAI,GAAIwzB,EAAI,IAC/B,IAAMx7B,EAAU,IAAItK,MAAMwxD,cAAcld,GAIxC,OAHAhqC,EAAQ0lE,SAAWhwE,MAAM8wD,aACzBxmD,EAAQkgD,UAAYxqD,MAAMuqD,aAC1BjgD,EAAQsgD,aAAc,EACftgD,GA1CT6rE,EAAA,CAAgCX,IA8CXS,GAAAA,SAAAA,GvIg1mBnB,SAASA,IACP,OAAOtG,EAAgBpuE,MAAMrB,KAAMoB,YAAcpB,KAHnDoD,EAAe2yE,EAAoBtG,GAMnC,IAAI0G,EAAUJ,EAAmBxzE,UAwUjC,OAtUA4zE,EuIx0mBD5pE,OAAA,WAAS,IAAAsI,EAAA7U,KACRyvE,EAAAltE,UAAMgK,OAAN1I,KAAA7D,MACAA,KAAKo2E,OAASp2E,KAAKo2E,OAAO91D,KAAKtgB,MAC/BA,KAAKi2D,SAAWj2D,KAAKi2D,SAAS31C,KAAKtgB,MAcnCmoD,GAAcE,UAAU91C,KACvBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAAikC,GAAQ,OAAInlC,EAAKpH,QAAUusC,EAASqK,MAAQ,KACxD7sC,EAAeI,IAAIrF,KAClBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA0B,GAEX,OAAQA,EAAQnH,MACf,KAAK2O,GACJpK,EAAKohD,gBvIi1mBRkgB,EuI30mBD3mD,UAAA,avI80mBC2mD,EuI10mBDE,UAAA,WAAY,IAAAthE,EAAA/U,KACNA,KAAKw/B,OAGVuS,GAAYS,cAAcxyC,KAAKw/B,MAAOx/B,KAAKoH,QAAQmL,KAClDuD,EAAAA,SACCC,WAAU,SAAAzO,GAAI,OAAIyN,EAAKuhE,OAAShvE,MvIi3mBlC6uE,EuI70mBDz+C,UAAA,WACK13B,KAAKs9D,SACRt9D,KAAKs9D,QAAQp5D,SAAQ,SAAAoL,GAAC,OAAIi9C,GAAYl3B,QAAQ/lB,MAE/CmgE,EAAAltE,UAAMm1B,UAAN7zB,KAAA7D,OvIm1mBAm2E,EuIh1mBD7H,aAAA,WACC,OAAOtuE,KAAKiF,KAAKyhE,avIm1mBjByP,EuIh1mBD5H,SAAA,SAAS2B,EAAOtB,GAEf,IAAM2H,EAAYv2E,KAAKu2E,UAAY,IAAIz2E,MAAM+yD,MAExB,mBAAVqd,GACVA,EAAMqG,IvIo1mBPJ,EuIh1mBD1kB,OAAA,SAAO6Z,EAAMC,GACZ,IAAM37D,EAAQ5P,KAAK4P,MACfm0B,EAAS/jC,KAAKiF,KAAK8+B,OACjBxJ,EAAWv6B,KAAKu6B,SACtB,GAAIv6B,KAAKiF,KAAKsgC,SAASb,GAAG0jC,cACzBrkC,EAAS/jC,KAAKiF,KAAKsgC,SAASb,GAAGwuC,UAAUnvC,IAClCovC,kBAAkB54C,GACzBA,EAAS+G,GAAK,GACd/G,EAASuc,eAAe,GACxB92C,KAAKiF,KAAKyhE,YAAY4D,aAAa/vC,GACnCA,EAAS+G,GAAKthC,KAAKiF,KAAKyhE,YAAYnsC,SAAS+G,EAC7C1xB,EAAM2qB,SAASoc,KAAKpc,GACpB3qB,EAAMu0B,MAAM39B,IAAI,EAAG,EAAG,GACtBoJ,EAAMgnC,OAAO7S,EAAOxJ,cAEd,CACNwJ,EAAOovC,kBAAkB54C,GACrBy/B,GAAa3+C,OAASg+C,GACzB9+B,EAASuc,eAAe,KAExBvc,EAASuc,eAAe,GAEzBlnC,EAAM2qB,SAASoc,KAAKpc,GACpB,IAAMgB,EAAI,EAAIwI,EAAOuT,KACrB1nC,EAAMu0B,MAAM39B,IAAI+0B,EAAGA,EAAGA,GACtB3rB,EAAMgnC,OAAOm/B,EAAmBl/B,UvIs1mBjCs/B,EuIl1mBDt7B,OAAA,SAAOpb,GACN,YADmB,IAAbA,IAAAA,EAAO,MACTA,EACIrrB,EAAAA,GAAGqrB,EAAKD,OAERuS,GAAYS,cAAcxyC,KAAKw/B,MAAOx/B,KAAKoH,QAAQmL,KACzDuD,EAAAA,UvIy1mBFqgE,EuIp1mBDK,QAAA,SAAQ/2C,GAAa,IAAA3Y,EAAA9mB,UAAA,IAAby/B,IAAAA,EAAO,MACdz/B,KAAKiuE,aAEDxuC,GAA2B,eAAnBA,EAAKnvB,KAAKb,KAMrBzP,KAAKiK,IAAIgK,KAAKwrB,IAGfsS,GAAYc,QAAS,EACrB7yC,KAAK66C,OAAOpb,GAAM1pB,WAAU,SAAAypB,GAC3B,GAAIA,EAAO,CACVA,EAAQA,EAAM1uB,QACd,IAAM2lE,EAAO,CACZnmE,KAAM,CAAEb,KAAM,QACdA,KAAMgwB,EAAO,OAAS,QACtBi3C,SAAUj3C,GAEXD,EAAMr8B,KAAKszE,GACX,IAAMnZ,EAAUx2C,EAAKw2C,QAAU99B,EAAMnwB,KAAI,SAACC,EAAG3N,EAAGgZ,GAE/C,OADArL,EAAEonE,SAAWj3C,EACW,SAAhBnwB,EAAEgB,KAAKb,KAAmB,IAAIwmE,GAAW3mE,EAAG3N,EAAGgZ,EAAE/Y,QAAU,IAAI0zE,GAAWhmE,EAAG3N,EAAGgZ,EAAE/Y,WAE3F07D,EAAQp5D,SAAQ,SAAAw0D,GACfA,EAAOrL,WAAY,EACnBqL,EAAOjgD,GAAG,OAAQigD,EAAO3C,QACzB2C,EAAOjgD,GAAG,MAAOigD,EAAO1C,OACxB0C,EAAOjgD,GAAG,OAAQqO,EAAKsvD,QACvBtvD,EAAKyvD,UAAUlqD,IAAIqsC,MAMpBlC,KAAKrZ,GAAGmgB,EAAS,CAChB7wB,SAAU,GACVlU,QAAS,GACTk+B,KAAMC,OAAOmW,QACb8J,QAAS,CACRC,KAAMtB,GAAWK,QAAQrY,EAAQ17D,QACjC+P,KAAM,EACNklE,OAAQ,IAAOvZ,EAAQ17D,QAExB6rC,SAAU,WACT6vB,EAAQp5D,SAAQ,SAAAw0D,GACfA,EAAOhN,SAAS8C,SAASj2B,QAAQ33B,MAAS83D,EAAOngC,SAAWmgC,EAAOj5B,KAAKiT,OAAS,GAAM,evIw2mB5FyjC,EuI/1mBDlI,WAAA,WACCl8B,GAAYc,QAAS,EACrB7yC,KAAK82E,gBACL92E,KAAK+2E,iBvIk2mBLZ,EuI/1mBDW,cAAA,WAAgB,IAAA3vD,EAAAnnB,KACTs9D,EAAUt9D,KAAKs9D,QACjBA,GACHA,EAAQp5D,SAAQ,SAAAw0D,GACfvxC,EAAKovD,UAAUlsE,OAAOquD,GACtBA,EAAO9/C,IAAI,OAAQ8/C,EAAO3C,QAC1B2C,EAAO9/C,IAAI,MAAO8/C,EAAO1C,OACzB0C,EAAO9/C,IAAI,OAAQuO,EAAKivD,QACxB1d,EAAOrjC,aAGTr1B,KAAKs9D,QAAU,MvIu2mBf6Y,EuIp2mBDa,WAAA,WACCh3E,KAAKiuE,aACL,IAAMgJ,EAAUj3E,KAAKi3E,QAAU,IAAI3B,GAAW,CAC7ChlE,KAAM,CAAEb,KAAM,QACdA,KAAM,QACJ,EAAG,GAENwnE,EAAQ1+C,QAAU,GAClB0+C,EAAQvrB,SAAS8C,SAASj2B,QAAQ33B,MAAQq2E,EAAQ1+C,QAClD0+C,EAAQvrB,SAAShB,aAAc,EAC/BusB,EAAQx+D,GAAG,OAAQw+D,EAAQlhB,QAC3BkhB,EAAQx+D,GAAG,MAAOw+D,EAAQjhB,OAC1BihB,EAAQx+D,GAAG,OAAQzY,KAAKi2D,UACxBj2D,KAAKu2E,UAAUlqD,IAAI4qD,IvIy2mBnBd,EuIt2mBDY,cAAA,WACC,IAAME,EAAUj3E,KAAKi3E,QACjBA,IACHj3E,KAAKu2E,UAAUlsE,OAAO4sE,GACtBA,EAAQr+D,IAAI,OAAQq+D,EAAQlhB,QAC5BkhB,EAAQr+D,IAAI,MAAOq+D,EAAQjhB,OAC3BihB,EAAQr+D,IAAI,OAAQ5Y,KAAKi2D,UACzBghB,EAAQ5hD,WAETr1B,KAAKi3E,QAAU,MvI22mBfd,EuIx2mBDC,OAAA,SAAO1d,GAEFA,EAAOj5B,MAAkC,SAA1Bi5B,EAAOj5B,KAAKnvB,KAAKb,MACnCzP,KAAKiuE,aACDvV,EAAOj5B,KAAKi3C,SACf12E,KAAKw2E,QAAQ9d,EAAOj5B,KAAKi3C,SAASA,UAOlC12E,KAAKozD,OAAOn/C,QAGbjU,KAAKw2E,QAAQ9d,EAAOj5B,OvI62mBrB02C,EuIz2mBDlgB,SAAA,WACK99C,EAAa/C,MAAMgV,QAAUjS,EAAa/C,MAAMkU,SAGhDyoB,GAAYc,QACf7yC,KAAKiuE,aACLjuE,KAAKozD,OAAOn/C,SAEZjU,KAAKw2E,UACLx2E,KAAKozD,OAAOn/C,KAAKjU,SvI82mBlBmC,EAAa4zE,EAAoB,CAAC,CAChCt1E,IAAK,UACL8D,IAAK,WuIzonBP,OAAOvE,KAAKk3E,UvI4onBV1wE,IAAK,SuI1onBIiH,GACPzN,KAAKk3E,WAAazpE,IACrBzN,KAAKk3E,SAAWzpE,EACCd,EAAAA,WAAW3M,MAApB0M,KACS5H,cAAc,cAC3BsnB,UAAUgnC,OAAO,UAAW3lD,QvIkpnB1BsoE,EuI5pnBYA,CAA2B3H,IAiShD2H,GAAmBl/B,OAAS,IAAI/2C,MAAMkkC,QACtC+xC,GAAmB7hB,cAAnB,2KASA6hB,GAAmBC,gBAAnB,qaAmBAD,GAAmB/oE,KAAO,CACzBC,SAAU,eACVkE,MAAO,CAAElM,KAAM4gE,IAEft1C,QAAS,CAAC,MAAO,UACjBrf,OAAQ,CAAC,QAAS,WALnB,IC3hBqBimE,GAAAA,SAAAA,GxIy4nBnB,SAASA,IACP,OAAOrF,EAAsBzwE,MAAMrB,KAAMoB,YAAcpB,KAHzDoD,EAAe+zE,EAAqBrF,GAMpC,IAAIpsE,EAASyxE,EAAoB50E,UAydjC,OAvdAmD,EwIt3nBD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACR8xE,EAAAvvE,UAAMgK,OAAN1I,KAAA7D,MACAA,KAAKg6C,SAAW,KAChBh6C,KAAKooE,cAAe,EAWpBr2B,GAAYe,QAAQvgC,KACnBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAA88B,GAAM,OAAI5uC,EAAK8nD,QAAUlZ,MxI63nBrCntC,EwIz3nBD8pB,UAAA,WACCxvB,KAAKqxE,QAAUrxE,KAAKy/B,KAAKwB,UxI43nBzBv7B,EwIz3nBD6oE,SAAA,SAAS2B,EAAOtB,GAAU,IAAAp6D,EAAAxU,KAEzBA,KAAKo3E,QAAQrsE,EAAY1E,QAAQrG,KAAKy/B,KAAKU,MAAMW,QAAS9gC,KAAKy/B,KAAKU,MAAMC,MAAM,SAACsuB,EAAM2oB,GACtF7iE,EAAK8iE,YAAY5oB,EAAM2oB,EAAYnH,EAAOtB,OxI+3nB3ClpE,EwI33nBD0xE,QAAA,SAAQnxE,EAAMm6B,EAAM1nB,GACF1Y,KAAKiF,KAAKsgC,SAA3B,IAEMikB,EAAcrB,GAAcG,SAE5BmB,GAAS,IAAI3pD,MAAMylE,YAAa5b,QAAQ1jD,GAExCsxE,EAAiBxsE,EAAY/B,OAAlB,YAEXwuE,EAAc,IAAI13E,MAAM23E,YAC9BD,EAAYE,eAAeH,GAC3B9tB,EAAOkuB,eAAeH,GACtB/tB,EAAOX,KAAK1oB,GAAM,SAACw3C,GAQM,mBAAbl/D,GACVA,EAASk/D,EAAIpyC,MAAOoyC,EAAIP,YAEzBlvB,GAAcM,YAAYe,EAAa,MAIrC,SAACquB,GAYH1vB,GAAcM,YAAYe,EAAaquB,EAAcrvB,OAAQqvB,EAAcjyB,WxI+3nB5ElgD,EwI33nBDoyE,gBAAA,SAAgBppB,EAAM2oB,GAGDr3E,KAAK+3E,aAAe,EAAxC,IACMC,EAAUh4E,KAAKg4E,QAAU,GAC/B,GAAIX,GAAcA,EAAWz1E,OAAQ,CACtB5B,KAAKi4E,MAAQ,IAAIn4E,MAAMo4E,MAArC,IACMC,EAAQn4E,KAAKm4E,MAAQ,IAAIr4E,MAAMs4E,eAAe1pB,GACpDypB,EAAME,UAAY,EAClBhB,EAAWnzE,SAAQ,SAAAo0E,GAClB,IAAM11C,EAASu1C,EAAMI,WAAWD,GAChC11C,EAAOmkC,SAAU,EACjBnkC,EAAO41C,sBAAsB,GAC7B51C,EAAO61C,mBAAmB,GAE1B71C,EAAO81C,QAAQ54E,MAAM64E,YAErBX,EAAQ70E,KAAKy/B,QxIi4nBfl9B,EwI53nBDkzE,aAAA,WACC,IAAMZ,EAAUh4E,KAAKg4E,QACrB,GAAuB,IAAnBA,EAAQp2E,OAAc,CACzB,IAAMghC,EAASo1C,EAAQ,IACG,IAAtBh4E,KAAK+3E,aACR/3E,KAAK+3E,YAAc,EACfn1C,EAAOsX,QAA+B,IAArBtX,EAAOy1C,UAC3Bz1C,EAAOsX,QAAS,EAEhBtX,EAAOrmB,QAEuB,IAArBvc,KAAK+3E,cACf/3E,KAAK+3E,aAAe,EACpBn1C,EAAOi2C,KAAK,UAEP,GAAIb,EAAQp2E,OAAS,EAAG,CAC9B,GAAI5B,KAAK+3E,aAAe,GAAK/3E,KAAK+3E,YAAcC,EAAQp2E,OAClCo2E,EAAQh4E,KAAK+3E,aACrBc,KAAK,IAGnB,GADA74E,KAAK+3E,cACD/3E,KAAK+3E,cAAgBC,EAAQp2E,OAChC5B,KAAK+3E,aAAe,MAEd,CACN,IAAMn1C,EAASo1C,EAAQh4E,KAAK+3E,aAExBn1C,EAAOsX,SACVtX,EAAOsX,QAAS,GAEQ,IAArBtX,EAAOy1C,YACVz1C,EAAOy1C,UAAY,GAEpBz1C,EAAOrmB,UxIu4nBT7W,EwIl4nBD4xE,YAAA,SAAY5oB,EAAM2oB,EAAYnH,EAAOtB,GAAU,IAAAj6D,EAAA3U,KAE9CA,KAAK83E,gBAAgBppB,EAAM2oB,GAE3B,IAMIyB,EANElmB,GAAM,IAAI9yD,MAAMi5E,MAAOpH,cAAcjjB,GACrC5hD,EAAO8lD,EAAIn4C,IAAI8Y,QAAQylD,IAAIpmB,EAAI73C,KAE/BopB,EAAQ,EADF3pB,KAAKC,IAAI3N,EAAKwC,EAAGxC,EAAKw0B,EAAGx0B,EAAK64B,GAE1C+oB,EAAKvqB,MAAM39B,IAAI29B,EAAOA,EAAOA,GAG7B,IAAMx6B,EAAO3J,KAAK2J,KACZ81B,EAAOz/B,KAAKy/B,KAClB,GAAI91B,EAAK2G,KAAKb,OAASkvB,GAASK,MAAMvvB,KAAM,EAE3CqpE,EAAQ,IAAIh5E,MAAM+yD,OACZxmC,IAAIqiC,GACVkE,EAAI+e,cAAcmH,GAClB,IAAMnpB,EAASiD,EAAIqmB,UAAU,IAAIn5E,MAAMkkC,SACvC80C,EAAMv+C,SAAS/zB,IACdkoD,EAAKn0B,SAASjrB,EAAIqgD,EAAOrgD,EACzBo/C,EAAKn0B,SAAS+G,EAAIquB,EAAOruB,EACzBotB,EAAKn0B,SAASoL,EAAIgqB,EAAOhqB,GAAK3lC,KAAKiF,KAAKsgC,SAASb,GAAG0jC,cAAgB,EAAI,IAGzE,IAAM8Q,EAAOJ,EAAMv+C,SAAS+G,EACtB3vB,EAAO,CAAEq8C,MAAO,GAChBvgB,EAAW,WAChBqrC,EAAMv+C,SAAS+G,EAAI43C,EAAO,EAAIvnE,EAAKq8C,MACnC8qB,EAAM9hC,SAAS1V,EAAI,EAAI9mB,KAAK2zC,GAAKx8C,EAAKq8C,OAEvCvgB,IACAztC,KAAKm5E,gBAAgBzqB,GACrB8H,KAAKrZ,GAAGxrC,EAAM,CACb86B,SAAU,IACVuhB,MAAO,EACPtd,MAAO,GACP+lB,KAAMC,OAAOC,UACblpB,SAAUA,EACV9a,WAAY,WACXhe,EAAK+8D,sBAGD,CACN9e,EAAI+e,cAAcjjB,GAClB,IAAMiB,EAASiD,EAAIqmB,UAAU,IAAIn5E,MAAMkkC,SACvC0qB,EAAKn0B,SAAS/zB,KACXmpD,EAAOrgD,GACPqgD,EAAOruB,GACPquB,EAAOhqB,IAEVmzC,EAAQ,IAAIh5E,MAAM+yD,OACZxmC,IAAIqiC,GACNjvB,EAAKlF,UACRu+C,EAAMv+C,SAASy3C,UAAUvyC,EAAKlF,UAE3BkF,EAAKuX,UACR8hC,EAAM9hC,SAASg7B,UAAUvyC,EAAKuX,UAE3BvX,EAAK0E,OACR20C,EAAM30C,MAAM6tC,UAAUvyC,EAAK0E,OAE5BnkC,KAAKm5E,gBAAgBzqB,GAuBrB1uD,KAAK0xE,eAEe,mBAAVxB,IACVA,EAAM4I,EAAO94E,KAAKy/B,MAClBz/B,KAAK+rD,QAAUha,GAAYc,SxI45nB5BntC,EwI34nBD+rD,OAAA,SAAO6Z,EAAMC,GACZ,IAAM5hE,EAAO3J,KAAK2J,KAEZ+kD,GADO1uD,KAAKy/B,KACLz/B,KAAK0uD,MACZ0Z,EAAepoE,KAAKiF,KAAKsgC,SAASb,GAAG0jC,aAC7BpoE,KAAK4P,MACf8+C,IACC/kD,EAAK2G,KAAKb,OAASkvB,GAASK,MAAMvvB,MACjCzP,KAAKooE,eAAiBA,IACzBpoE,KAAKooE,aAAeA,EAChBA,GACH1Z,EAAKn0B,SAASjrB,EAAI,EAClBo/C,EAAKn0B,SAAS+G,EAAI,EAClBotB,EAAKn0B,SAASoL,GAAK,EACnB+oB,EAAK1X,SAAS1V,EAAI,IAElBotB,EAAKn0B,SAASjrB,EAAI,EAClBo/C,EAAKn0B,SAAS+G,EAAI,EAClBotB,EAAKn0B,SAASoL,EAAI,EAClB+oB,EAAK1X,SAAS1V,EAAI,IAGhB8mC,IACH1Z,EAAK1X,SAAS1V,GAAM9mB,KAAK2zC,GAAK,IAAM,GAAK,IAGtCia,IACH1Z,EAAK1X,SAAS1V,GAAM9mB,KAAK2zC,GAAK,IAAM,GAAK,IAI5C,IAAMgqB,EAAQn4E,KAAKm4E,MACbF,EAAQj4E,KAAKi4E,MACnB,GAAIE,EAAO,CACV,IAAM9M,EAAQ4M,EAAMmB,WACpBjB,EAAMtqE,OAAOw9D,KxIq5nBd3lE,EwIh5nBD+nC,SAAA,SAAShO,EAAMivB,GAED1uD,KAAK2J,KACT2G,KAAKb,OAASkvB,GAASK,MAAMvvB,OACjCgwB,EAAKlF,UACRm0B,EAAKn0B,SAASy3C,UAAUvyC,EAAKlF,UAE1BkF,EAAKuX,UACR0X,EAAK1X,SAASg7B,UAAUvyC,EAAKuX,UAE1BvX,EAAK0E,OACRuqB,EAAKvqB,MAAM6tC,UAAUvyC,EAAK0E,QAG5BnkC,KAAK0xE,gBxIw5nBLhsE,EwIp5nBDksC,cAAA,SAAcnS,EAAMivB,GAAM,IAAA75C,EAAA7U,KAEzBA,KAAKo3E,QAAQrsE,EAAY1E,QAAQo5B,EAAKU,MAAMW,QAASrB,EAAKU,MAAMC,MAAM,SAACsuB,EAAM2oB,GAC5ExiE,EAAKyiE,YAAY5oB,EAAM2oB,GAAY,SAAC3oB,EAAMjvB,GAAP,OAAgB5qB,EAAK25D,QAAQ9f,EAAMjvB,MAAO,SAACivB,EAAMjvB,GAAP,OAAgB5qB,EAAK45D,WAAW/f,EAAMjvB,UxIq6nBpH/5B,EwI15nBDwmE,WAAA,SAAW3xC,GAEVv6B,KAAKqxE,SAAU,EACFrxE,KAAK2J,KACT2G,KAAKb,OAASkvB,GAASK,MAAMvvB,MACrCzP,KAAK0uD,KAAKn0B,SAAS/zB,IAAI+zB,EAASjrB,EAAGirB,EAAS+G,EAAG/G,EAASoL,GAAGmR,eAAe,GAG3E92C,KAAK0xE,gBxI+5nBLhsE,EwI35nBDyrC,UAAA,WAEcnxC,KAAK2J,KACT2G,KAAKb,OAASkvB,GAASK,MAAMvvB,OACrCzP,KAAKy/B,KAAKlF,SAAWv6B,KAAK0uD,KAAKn0B,SAASwc,UACxC/2C,KAAKy/B,KAAKuX,SAAWh3C,KAAK0uD,KAAK1X,SAASD,UACxC/2C,KAAKy/B,KAAK0E,MAAQnkC,KAAK0uD,KAAKvqB,MAAM4S,WAEnC/2C,KAAKqxE,SAAU,GxIg6nBf8F,EwI75nBMkC,0BAAP,WACC,IAAIC,EAAcnC,EAAoBoC,uBACtC,IAAKD,EAAa,CACjB,IAAME,EAAuBv3E,OAAOohE,0BAA0B7X,GAAcjpD,WACtEk3E,EAAuBx3E,OAAOohE,0BAA0BhX,GAAc9pD,WACtEg3E,EAAyBt3E,OAAOohE,0BAA0B/V,GAAgB/qD,WAChF+2E,EAAcr3E,OAAO8D,OAAO,GAAIyzE,EAAsBC,EAAsBF,GAC5EpC,EAAoBoC,uBAAyBD,EAE9C,OAAOA,GxIk6nBP5zE,EwI/5nBDyzE,gBAAA,SAAgBzqB,GAAM,IAAA35C,EAAA/U,KACfu5E,EAAyBpC,EAAoBkC,4BACnD3qB,EAAKiW,UAAS,SAACC,GACVA,EAAMC,SACT5iE,OAAOY,KAAK02E,GAAwBr1E,SAAQ,SAAAzD,GAC/B,gBAARA,GACHwB,OAAOC,eAAe0iE,EAAOnkE,EAAK84E,EAAuB94E,OAG3DmkE,EAAM7Y,SAAU,EAChB6Y,EAAMpsD,OAAS,GACfosD,EAAMvX,WAAY,EAClBuX,EAAMpX,OAAQ,EACdoX,EAAMnX,OAAQ,EACdlB,GAAY/sB,MAAMr8B,KAAKyhE,GACvBA,EAAMnsD,GAAG,QAAQ,WAEhB1D,EAAK6jE,eACL7jE,EAAK2gC,KAAKzhC,KAAKc,WxIq8nBlB5S,EAAag1E,EAAqB,CAAC,CACjC12E,IAAK,UAOL8D,IAAK,WwI10oBP,OAAOvE,KAAKgsD,UxI60oBVxlD,IAAK,SwI30oBIulD,GACX,GAAI/rD,KAAKgsD,WAAaD,EAAS,CAC9B/rD,KAAKgsD,SAAWD,EAChB,IAAM2C,EAAO1uD,KAAK0uD,KACdA,GACHA,EAAKiW,UAAS,SAACC,GACVA,EAAMoK,oBACTpK,EAAM7Y,QAAUA,WxIo1oBborB,EwIt2oBYA,CAA4BhG,IA2ajDgG,GAAoBtgC,OAAS,IAAI/2C,MAAMkkC,QAEvCmzC,GAAoBnqE,KAAO,CAC1BC,SAAU,gBACVkE,MAAO,CAAElM,KAAM4gE,IACft1C,QAAS,CAAC,QACVrf,OAAQ,CAAC,OAAQ,SCxbX,IAAMwoE,GACN,OADMA,GAEN,OAFMA,GAGN,OAHMA,GAIL,QAJKA,GAKL,QAGaC,GAAAA,SAAAA,GzI03oBnB,SAASA,IACP,OAAO7H,EAAsBzwE,MAAMrB,KAAMoB,YAAcpB,KAHzDoD,EAAeu2E,EAAmB7H,GAMlC6H,EyI53oBMC,eAAP,WAGC,OAAOD,EAAkBE,cAAgBF,EAAkBE,YAAc,IAAI/5E,MAAMmuD,qBAAqB,EAAG,GAAI,MzI+3oB/G0rB,EyI53oBMtmB,UAAP,WACC,OAAOsmB,EAAkBlwB,SAAWkwB,EAAkBlwB,OAAS,IAAI3pD,MAAM4pD,gBzI+3oBzEiwB,EyI53oBMG,gBAAP,WACC,OAAOH,EAAkBI,eAAiBJ,EAAkBI,aAAeJ,EAAkBtmB,YAAYvK,KAAK/9C,EAAY1E,QAAQ,gCzI+3oBlIszE,EyI53oBMK,eAAP,WACC,OAAOL,EAAkBM,cAAgBN,EAAkBM,YAAcN,EAAkBtmB,YAAYvK,KAAK/9C,EAAY1E,QAAQ,+BzI+3oBhIszE,EyI53oBMO,eAAP,WACC,OAAOP,EAAkBQ,cAAgBR,EAAkBQ,YAAcR,EAAkBtmB,YAAYvK,KAAK/9C,EAAY1E,QAAQ,+BzI+3oBhIszE,EyI53oBMtG,WAAP,SAAkBh4D,GACjB,IAAIjR,EACJ,OAAQiR,GACP,KAAKq+D,GACJtvE,EAAUpK,KAAKg6E,iBACf,MACD,KAAKN,GACJtvE,EAAUpK,KAAKk6E,iBACf,MACD,KAAKR,GACL,KAAKA,GACJtvE,EAAUpK,KAAK85E,kBAKjB,OAAO1vE,GzIi4oBPuvE,EyI93oBMS,gBAAP,SAAuB36C,EAAMpkB,GAC5B,IAAIjR,EACJ,GAAIiR,IAASq+D,GAAmB,CAC/B,IAAMtnE,EAAOqtB,EAAKl0B,MACZ6oC,EAASvvC,SAAS0W,cAAc,UAEtC64B,EAAO14B,MAAQ,IACf04B,EAAOz4B,OAAS,GAChB,IAAM04B,EAAMD,EAAOznC,WAAW,MAC9B0nC,EAAI+hB,uBAAwB,EAC5B/hB,EAAIgiB,sBAAwB,OAC5BhiB,EAAIk8B,KAAJ,QAAmBxlE,EAAYP,WAC/B,IACIo7B,EADYyO,EAAIm8B,YAAYp+D,GAChBsJ,MAAQ,EAElBpM,GADNs2B,EAAIprB,KAAK4d,IAAI,EAAG5d,KAAKqiD,KAAKriD,KAAK9T,IAAIk/B,GAAKprB,KAAK9T,IAAI,MACnC,EAEd0tC,EAAO14B,MAAQkqB,EACfyO,EAAIk8B,KAAJ,QAAmBxlE,EAAYP,WAC/B6pC,EAAIq8B,UAAY,SAChBr8B,EAAIs8B,aAAe,SACnBt8B,EAAIu8B,YAAc,qBAClBv8B,EAAIw8B,UAAY,EAChBx8B,EAAIy8B,SAAW,QACfz8B,EAAI08B,WAAa,EACjB18B,EAAI28B,WAAW5+D,EAAM9C,EATX,IAUV+kC,EAAI0d,UAAY,QAChB1d,EAAI48B,SAAS7+D,EAAM9C,EAXT,IAYVlF,EAAU,IAAItK,MAAMwxD,cAAcld,GAEnC,OAAOhqC,GzIo4oBPuvE,EyIj4oBMU,WAAP,SAAkB56C,EAAM91B,GACvB,IAAI0R,EAAOq+D,GAiBX,OAhBIj6C,EAAK/U,SAAW/gB,EAAKqH,IACxBqK,EAAOq+D,GACH15E,KAAKs6E,YAAY76C,EAAKl0B,SACzB8P,EAAOq+D,KAEJ15E,KAAKs6E,YAAY76C,EAAKsC,WACxBtC,EAAKU,OAASV,EAAKU,MAAMnvB,IACzByuB,EAAKhzB,MAAQgzB,EAAKhzB,KAAKlG,QACxB8U,EAAOq+D,MAEE15E,KAAKs6E,YAAY76C,EAAKl0B,QAChCvL,KAAKs6E,YAAY76C,EAAKsC,WACrBtC,EAAKU,OAASV,EAAKU,MAAMnvB,IACzByuB,EAAKhzB,MAAQgzB,EAAKhzB,KAAKlG,QACxB8U,EAAOq+D,IAEDr+D,GzIm4oBPs+D,EyIh4oBMW,YAAP,SAAmBloE,GAClB,OAAOA,GAAQA,EAAKxQ,OAAS,GzIm4oB7B,IAAI8D,EAASi0E,EAAkBp3E,UAkP/B,OAhPAmD,EyIl4oBD6G,OAAA,WACCulE,EAAAvvE,UAAMgK,OAAN1I,KAAA7D,OzI+4oBA0F,EyIn4oBD8pB,UAAA,WACCxvB,KAAKqxE,QAAUrxE,KAAKy/B,KAAKwB,UzIs4oBzBv7B,EyIn4oBD6oE,SAAA,SAAS2B,EAAOtB,GAAU,IAAA3Q,EAAAh6D,EAAAjE,KAGzB,IADaA,KAAKqb,KAAOs+D,EAAkBU,WAAWr6E,KAAKy/B,KAAMz/B,KAAK2J,SACzD+vE,GAAb,CAGA,IAAMzvE,EAAM,IAAInK,MAAM+yD,MAChBt4B,GAAW0jC,EAAA,IAAIn+D,MAAMkkC,SAAUx9B,IAApBnF,MAAA48D,EAA2Bj+D,KAAKy/B,KAAKlF,UAAUmhC,YAAY5kB,eAAe6iC,EAAkBvI,QAC7GnnE,EAAIswB,SAAS/zB,IAAI+zB,EAASjrB,EAAGirB,EAAS+G,EAAG/G,EAASoL,GAElD3lC,KAAKu6E,gBAAgBtwE,GAErB,IAAMwhD,EAAWkuB,EAAkBC,iBAC7BtV,EAAS,IAAIhX,GAAgB7B,EAAU,IAAI3rD,MAAM8rD,kBAAkB,CACxEyB,WAAW,EACXgB,YAAY,EACZsG,aAAa,EACbp8B,QAAS,EACTszB,MAAO,SAERyY,EAAO70D,KAAP,SAAuBzP,KAAKy/B,KAAKzuB,GACjCszD,EAAO1tB,OAAO+iC,EAAkB9iC,QAChCytB,EAAOjX,WAAY,EACnBiX,EAAO75D,YAAc,EACrBR,EAAIoiB,IAAIi4C,GACRA,EAAO7rD,GAAG,QAAQ,WAOjBxU,EAAKmpD,KAAKn5C,KAAKhQ,GACf,IAAMu2E,EAAOv2E,EAAKu2E,KACZ7oE,EAAO,CAAEwyB,MAAOq2C,EAAKr2C,MAAM70B,GACjCknD,KAAKrZ,GAAGxrC,EAAM,CACb86B,SAAU,IACVtI,MAAO,IACPuM,MAAO,EACP+lB,KAAMC,OAAOmW,QACb/V,WAAW,EACXrpB,SAAU,WACT+sC,EAAKr2C,MAAM39B,IAAImL,EAAKwyB,MAAOxyB,EAAKwyB,MAAOxyB,EAAKwyB,QAE7CxR,WAAY,kBASd2xC,EAAO7rD,GAAG,OAAO,WAChBxU,EAAK+T,IAAI/D,KAAKhQ,GACd,IAAMu2E,EAAOv2E,EAAKu2E,KACZ7oE,EAAO,CAAEwyB,MAAOq2C,EAAKr2C,MAAM70B,GACjCknD,KAAKrZ,GAAGxrC,EAAM,CACb86B,SAAU,IACVtI,MAAO,IACPuM,MAAO,EACP+lB,KAAMC,OAAOmW,QACb/V,WAAW,EACXrpB,SAAU,WACT+sC,EAAKr2C,MAAM39B,IAAImL,EAAKwyB,MAAOxyB,EAAKwyB,MAAOxyB,EAAKwyB,QAE7CxR,WAAY,kBAOd2xC,EAAO7rD,GAAG,QAAQ,WACjBxU,EAAKyxC,KAAKzhC,KAAKhQ,MAEhB,IAAM0N,EAAO,CAAE4mB,QAAS,GACxBi+B,KAAKrZ,GAAGxrC,EAAM,CACb86B,SAAU,GACVlU,QAAS,EACTmY,MAAO,GAAM,GAAM1wC,KAAKy/B,KAAKv2B,MAC7ButD,KAAMC,OAAOC,UACbG,WAAW,EACXrpB,SAAU,WACTxpC,EAAKw2E,UAAUv2E,SAAQ,SAAAwnD,GACtBA,EAASnzB,QAAU5mB,EAAK4mB,QACxBmzB,EAAShB,aAAc,QAIL,mBAAVwlB,GACVA,EAAMjmE,EAAKjK,KAAKy/B,QzIs5oBjB/5B,EyIl5oBD60E,gBAAA,SAAgB7rB,EAAMn2B,QAAa,IAAbA,IAAAA,EAAU,GAC/Bv4B,KAAK06E,eAAe16E,KAAKw6E,MACzBx6E,KAAK06E,eAAe16E,KAAKuL,OACzB,IAAM8P,EAAOrb,KAAKqb,KAAOs+D,EAAkBU,WAAWr6E,KAAKy/B,KAAMz/B,KAAK2J,MACtE,GAAI0R,IAASq+D,GAAb,CAGA,IAAMrqE,EAAMsqE,EAAkBtG,WAAWh4D,GACzChM,EAAI8nD,YAAa,EACjB9nD,EAAIygE,SAAWhwE,MAAM8wD,aACrB,IAaI+pB,EAbEjvB,EAAW,IAAI5rD,MAAM86E,eAAe,CACzCvtB,WAAW,EACXgB,YAAY,EACZsG,aAAa,EACbtlD,IAAKA,EACLwrE,iBAAiB,EACjBtiD,QAASA,IAGJkiD,EAAY,CAAC/uB,GACb8uB,EAAOx6E,KAAKw6E,KAAO,IAAI16E,MAAMg7E,OAAOpvB,GAC1C8uB,EAAKr2C,MAAM39B,IAAI,IAAM,IAAM,KAC3BkoD,EAAKriC,IAAImuD,GAET,IAAMO,EAAepB,EAAkBS,gBAAgBp6E,KAAKy/B,KAAMpkB,GAClE,GAAI0/D,EAAc,CACjBJ,EAAgB,IAAI76E,MAAM86E,eAAe,CACxCvtB,WAAW,EACXgB,YAAY,EACZsG,aAAa,EACbtlD,IAAK0rE,EACLF,iBAAiB,EACjBtiD,QAASA,IAIV,IAAMpwB,EAAQ4yE,EAAa5yE,MACrBoD,EAAQvL,KAAKuL,MAAQ,IAAIzL,MAAMg7E,OAAOH,GAC5CpvE,EAAM44B,MAAM39B,IAAI,IAAO2B,EAAMuT,MAAQvT,EAAMwT,OAAQ,IAAM,KACzDpQ,EAAMgvB,SAAS/zB,IAAI,GAAI,IAAK,GAC5BkoD,EAAKriC,IAAI9gB,GACTkvE,EAAUt3E,KAAKw3E,GAEhB36E,KAAKy6E,UAAYA,IzI65oBjB/0E,EyI15oBDg1E,eAAA,SAAeM,GACVA,IACCA,EAAO5Q,QACV4Q,EAAO5Q,OAAO//D,OAAO2wE,GAElBA,EAAOtvB,SAASr8C,MAA0C,IAAnC2rE,EAAOtvB,SAASr8C,IAAI8nD,YAC9C6jB,EAAOtvB,SAASr8C,IAAIgmB,UAErB2lD,EAAOtvB,SAASr2B,YzIg6oBjB3vB,EyI55oBDgyB,UAAA,WACC60B,GAAYl3B,QAAQr1B,KAAKskE,QACzBwN,EAAAvvE,UAAMm1B,UAAN7zB,KAAA7D,OzIg6oBA0F,EyI75oBD4nE,gBAAA,WACC,OAASttE,KAAKqxE,SAAWrxE,KAAKqb,OAASq+D,IAAoB15E,KAAKqb,OAASq+D,IzIi6oBzEh0E,EyI75oBD+nC,SAAA,SAAShO,EAAMivB,GAAM,IAAAusB,EACpBj7E,KAAKy/B,KAAOA,EACZz/B,KAAKu6E,gBAAgBv6E,KAAK0uD,KAAM,GAChC,IAAMn0B,GAAW0gD,EAAA,IAAIn7E,MAAMkkC,SAAUx9B,IAApBnF,MAAA45E,EAA2Bx7C,EAAKlF,UAAUmhC,YAAY5kB,eAAe6iC,EAAkBvI,QACxG1iB,EAAKn0B,SAAS/zB,IAAI+zB,EAASjrB,EAAGirB,EAAS+G,EAAG/G,EAASoL,GAEnD3lC,KAAK0xE,gBzI26oBLhsE,EyIj6oBDwmE,WAAA,SAAW3xC,GACVv6B,KAAKqxE,SAAU,EACfrxE,KAAKy/B,KAAK8R,WAAY,EACtBvxC,KAAK0uD,KAAKn0B,SAAS/zB,IAAI+zB,EAASjrB,EAAGirB,EAAS+G,EAAG/G,EAASoL,GAAGmR,eAAe6iC,EAAkBvI,QAC5FpxE,KAAK0xE,gBzIq6oBLhsE,EyIj6oBDyrC,UAAA,WACCnxC,KAAKy/B,KAAKlF,UAAW,IAAIz6B,MAAMkkC,SAAU2S,KAAK32C,KAAK0uD,KAAKn0B,UAAUmhC,YAAY3kB,UAC9E/2C,KAAKqxE,SAAU,GzIo6oBRsI,EyIvtpBYA,CAA0BxI,IAuT/CwI,GAAkB9iC,OAAS,IAAI/2C,MAAMkkC,QACrC21C,GAAkBvI,OAAS,IAE3BuI,GAAkB3sE,KAAO,CACxBC,SAAU,cACVkE,MAAO,CAAElM,KAAM4gE,IACft1C,QAAS,CAAC,OAAQ,MAAO,QACzBrf,OAAQ,CAAC,OAAQ,SAJlB,ICrUqBgqE,GAAAA,SAAAA,GAEpB,SAAAA,EAAYxvB,GAAU,IAAAznD,EAAA,OACrBA,EAAAk3E,EAAAt3E,KAAA7D,KAAM0rD,IAAN1rD,MACKqtD,WAAY,EACjBppD,EAAKupD,OAAQ,EACbvpD,EAAKwpD,OAAQ,EACblB,GAAY/sB,MAAMr8B,KAAlBO,EAAAO,IALqBA,E1I84pBrB,OA3DAb,EAAe83E,EAAmBC,GAalCh5E,EAAa+4E,EAAmB,CAAC,CAC/Bz6E,IAAK,sBACL8D,IAAK,W0Iz1pBP,OAAO,I1I41pBJ,CACD9D,IAAK,OACL8D,IAAK,W0I11pBP,OAAOvE,KAAKwtD,O1I61pBVhnD,IAAK,S0I31pBC4mD,GACJptD,KAAKwtD,OAASJ,IACjBptD,KAAKwtD,MAAQJ,EAMTA,EACHptD,KAAK8Y,KAAK,OAAQ9Y,MAElBA,KAAK8Y,KAAK,MAAO9Y,S1Ig2pBhB,CACDS,IAAK,OACL8D,IAAK,W0I51pBP,OAAOvE,KAAKytD,O1I+1pBVjnD,IAAK,S0I71pBCkvC,GACRA,EAAOA,GAAQ11C,KAAKotD,KAChBptD,KAAKytD,OAAS/X,IACjB11C,KAAKytD,MAAQ/X,EACTA,EACH11C,KAAK8Y,KAAK,OAAQ9Y,MAElBA,KAAK8Y,KAAK,KAAM9Y,W1Iq2pBXk7E,E0Ih5pBYA,CCDAE,SAAAA,GAEpB,SAAAA,EAAY1vB,GAAU,IAAAznD,EAAA,OACrBynD,EAAWA,GAAY,IAAI5rD,MAAM86E,eAAe,CAC/C/uB,MAAO,YAIR5nD,EAAAo3E,EAAAx3E,KAAA7D,KAAM0rD,IAAN1rD,MACKwY,OAAS,GAPOvU,E3IwxpBrBb,EAAeg4E,EAAiBC,GAehC,IAAI31E,EAAS01E,EAAgB74E,UA2C7B,OAzCAmD,E2I/xpBD+S,GAAA,SAAGnI,EAAMoI,GAAU,IAAAlE,EAAAxU,KACZ2Y,EAAQ3Y,KAAKwY,OAAOlI,GAAQtQ,KAAKwY,OAAOlI,IAAS,GAEvD,OADAqI,EAAMxV,KAAKuV,GACJ,WACNlE,EAAKgE,OAAOlI,GAAQqI,EAAM3V,QAAO,SAAAsM,GAAC,OAAIA,IAAMoJ,O3IuypB7ChT,E2InypBDkT,IAAA,SAAItI,EAAMoI,GACT,IAAMC,EAAQ3Y,KAAKwY,OAAOlI,GACtBqI,IACH3Y,KAAKwY,OAAOlI,GAAQqI,EAAM3V,QAAO,SAAAsM,GAAC,OAAIA,IAAMoJ,O3I0ypB7ChT,E2ItypBDoT,KAAA,SAAKxI,EAAMkB,GACV,IAAMmH,EAAQ3Y,KAAKwY,OAAOlI,GACtBqI,GACHA,EAAMzU,SAAQ,SAAAwU,GAEbA,EAASlH,MAGX,IAAMuH,EAAY/Y,KAAKwY,OAAOO,UAC1BA,GACHA,EAAU7U,SAAQ,SAAAwU,GACjBA,EAASpI,EAAMkB,O3I8ypBV4pE,E2Ip1pBYA,CCDAE,SAAAA,GAYpB,SAAAA,EAAY5vB,GAAU,IAAAznD,EAAA,OACrBynD,EAAWA,GAAY,IAAI5rD,MAAM86E,eAAe,CAC/C/uB,MAAO,YAIR5nD,EAAAs3E,EAAA13E,KAAA7D,KAAM0rD,IAAN1rD,MACK+rD,SAAU,EAPM9nD,E5IoupBrBb,EAAek4E,EAAiBC,GAEhCp5E,EAAam5E,EAAiB,CAAC,CAC7B76E,IAAK,UACL8D,IAAK,W4IjvpBP,OAAOvE,KAAKgsD,U5IovpBVxlD,IAAK,S4IjvpBIulD,GAEX/rD,KAAKgsD,SAAWD,EAChB/rD,KAAKw9C,SAASx6C,QAAO,SAAAsM,GAAC,OAAIA,EAAE28C,iBAAiB,cAAY/nD,SAAQ,SAAAoL,GAAC,OAAIA,EAAEy8C,QAAUA,S5IswpBlF,IAAIrmD,EAAS41E,EAAgB/4E,UAU7B,OARAmD,E4I3vpBDwmD,OAAA,WACClsD,KAAK+rD,SAAU,G5I8vpBfrmD,E4I3vpBDymD,SAAA,WACCnsD,KAAK+rD,SAAU,G5I8vpBRuvB,E4IzxpBYA,CAAwBx7E,MAAMg7E,UCO9BU,GAAAA,SAAAA,G7I+4pBnB,SAASA,IACP,OAAO/L,EAAgBpuE,MAAMrB,KAAMoB,YAAcpB,KAHnDoD,EAAeo4E,EAAqB/L,GAMpC,IAAI/pE,EAAS81E,EAAoBj5E,UAkNjC,OAhNAmD,E6In5pBD6G,OAAA,WACCkjE,EAAAltE,UAAMgK,OAAN1I,KAAA7D,O7Iu5pBA0F,E6In5pBD6pB,OAAA,WAAS,IAAAtrB,EAAAjE,KACR,IAAIA,KAAKy7E,OAAT,CAGAz7E,KAAKy7E,QAAS,EAJN,IAKA/uE,EAASC,EAAAA,WAAW3M,MAApB0M,KACR1M,KAAK2vE,iBAAiBjjE,GAAM1L,MAAK,SAAAoJ,GAChC,GAAInG,EAAKyqD,KAAM,CACd,IAAMvqB,EAAQ,IAAOlgC,EAAKw7B,KAAKU,MAAQ,IAAM,GACvCoyB,EAASnoD,EAAQsR,MAAQtR,EAAQuR,OACjCD,EAAQ8/D,EAAoBlM,aAAenrC,EAC3CxoB,EAAS6/D,EAAoBlM,aAAenrC,EAAQouB,EACpDshB,EAAa,IAARn4D,EACL6e,EAAWt2B,EAAKw7B,KAAKivB,KAAKn0B,SAASmhC,YAAY5kB,eAAe0kC,EAAoBlM,cAClF5jB,EAAW,IAAI5rD,MAAM86E,eAAe,CACzCvtB,WAAW,EACXsH,aAAa,EACbp8B,QAAS,EACTlpB,IAAKjF,EAAQiF,IACbwrE,iBAAiB,IAEZjwE,EAAQ3G,EAAK2G,MAAQ,IAAIswE,GAAkBxvB,GACjD9gD,EAAMH,YAAcM,EAAYN,YAAYG,MAC5CA,EAAMu5B,MAAM39B,IAAI,IAAOkV,EAAO,IAAOC,EAAQ,GAC7C/Q,EAAM2vB,SAAS/zB,IAAI+zB,EAASjrB,EAAGirB,EAAS+G,GAAK3lB,EAAc,EAALk4D,GAASt5C,EAASoL,GACxE/6B,EAAM6N,GAAG,QAAQ,SAACE,GACjB,IAAM+iE,EAAK,CAAEpsE,EAAGiyB,SAAS5oB,EAAMq0C,aAAa2uB,GAAGrsE,EAAI5C,EAAKm6D,aAAcvlC,EAAGC,UAAU,EAAI5oB,EAAMq0C,aAAa2uB,GAAGr6C,GAAK50B,EAAK+5C,eAEjHh6C,EAAOtI,MAAM5B,UAAUuO,MAAMjN,KAAK6I,EAAKkvE,iBAAiB,iBAAiBt+D,MAAK,SAAA7Q,GACnF,OAAOivE,EAAGpsE,GAAK7C,EAAKovE,YAAcH,EAAGp6C,GAAK70B,EAAKixC,WAAag+B,EAAGpsE,GAAM7C,EAAKovE,WAAapvE,EAAKo6D,aAAgB6U,EAAGp6C,GAAM70B,EAAKixC,UAAYjxC,EAAKg6C,gBAG5I,GAAIh6C,EAAM,CACTxI,EAAKyxC,KAAKzhC,KAAKxH,GACf,IAAM05C,EAAOz5C,EAAKk7C,wBACZjvC,EAAQ,IAAIs/C,WAAW,UAAW,CACvCS,OAAQ,EACR4E,QAAS,EACTpF,QAASwjB,EAAGpsE,EAAI62C,EAAK7tB,KACrB6/B,QAASujB,EAAGp6C,EAAI6kB,EAAK3rB,IACrBshD,UAAW,EACXC,UAAW,EACXC,cAAevvE,EACfwvE,QAASP,EAAGpsE,EACZ4sE,QAASR,EAAGp6C,IAGb70B,EAAKokC,cAAcl4B,GACnBmK,YAAW,WACVi1C,GAAYkB,aAAatgD,EAAOo/C,GAAYj6B,QAASi6B,GAAYc,SAAUd,GAAYU,aACrF,OAGLx0D,EAAKyqD,KAAKriC,IAAIzhB,GACd,IAAM+G,EAAO,CAAE/Q,MAAO,GACtB41D,KAAKrZ,GAAGxrC,EAAM,CACb86B,SAAU,GACV7rC,MAAO,EACP8vC,MAAO,EACP+lB,KAAMC,OAAOC,UACblpB,SAAU,WACT7iC,EAAM2vB,SAAS/zB,IAAI+zB,EAASjrB,EAAGirB,EAAS+G,GAAK3lB,EAAc,EAALk4D,GAAUA,EAAKliE,EAAK/Q,MAAO25B,EAASoL,GAC1F/6B,EAAMgsC,OAAO4kC,EAAoB3kC,QACjCjsC,EAAM8gD,SAASnzB,QAAU5mB,EAAK/Q,MAC9BgK,EAAM8gD,SAAShB,aAAc,SAI9B,SAAA7pD,GACF4F,QAAQC,IAAI,6CAA8C7F,Q7Iy6pB3D6E,E6Ir6pBD6oE,SAAA,SAAS2B,EAAOtB,GACf,IAAMlgB,EAAO,IAAI5uD,MAAM+yD,MACF,mBAAVqd,GACVA,EAAMxhB,I7I06pBPhpD,E6It6pBDgyB,UAAA,WAEC+3C,EAAAltE,UAAMm1B,UAAN7zB,KAAA7D,O7Iy6pBA0F,E6It6pBDy2E,aAAA,WAAe,IACNzvE,EAASC,EAAAA,WAAW3M,MAApB0M,KACR,GAAIA,EAAM,CACT,IACM0vE,EADSj4E,MAAM5B,UAAUuO,MAAMjN,KAAK6I,EAAKkvE,iBAAiB,QACxCvsE,KAAI,SAAAC,GAAC,OAAI,IAAIvO,SAAQ,SAASV,EAASC,GAC9D,IAAM+7E,EAAO/sE,EAAEwM,MAA2C,IAApCxM,EAAEwM,IAAI5W,QAAQR,SAASyB,QAC7C,GAAImJ,EAAE6qC,SACL,OAAOr3B,YAAW,WACjBziB,EAAQg8E,KACN,IAEJ,IAAMvwC,EAAkB,WACvBx8B,EAAEqoB,oBAAoB,OAAQ2kD,GAC9BhtE,EAAEqoB,oBAAoB,QAASvT,IAE1Bk4D,EAAS,WAEdxwC,IACAhpB,YAAW,WACVziB,EAAQg8E,KACN,KAEEj4D,EAAU,WAEf0nB,IACAzrC,GAAQ,IAGRiP,EAAE+nB,iBAAiB,OAAQilD,GAC3BhtE,EAAE+nB,iBAAiB,QAASjT,SAI9B,OAAIg4D,EAASx6E,OACLb,QAAQkmB,IAAIm1D,GAEZr7E,QAAQV,Y7Is7pBjBqF,E6Ij7pBDiqE,iBAAA,SAAiBjjE,GAAM,IAAA8H,EAAAxU,KACtB,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5BwiB,YAAW,WACNtO,EAAKirB,KAAK88C,aACbl8E,EAAQmU,EAAKirB,KAAK88C,cAElB/nE,EAAK2nE,eAAen7E,MAAK,SAACw7E,GACzB,IAAMnpD,EAAU1mB,EAAAA,WAAW6H,GAC3B,GAAI6e,GAAWA,EAAQ3mB,KAAM,CAC5BA,EAAO2mB,EAAQ3mB,KACf,IAAM+vE,EAAUD,GAA6C,MAAjCA,EAAQl/D,MAAK,SAAAhO,GAAC,OAAU,IAANA,KAE9CvP,EAAY2M,EAAM,CACjBgwE,gBAAiB,YACjBv4C,MAAO,EACPs4C,QAAAA,IAEEz7E,MAAK,SAAAozC,GAKP,IAAM/kC,EAAM,IAAIvP,MAAMwxD,cAAcld,GAGpC5/B,EAAKirB,KAAK88C,aAAe,CACxBltE,IAAKA,EACLqM,MAAO04B,EAAO14B,MACdC,OAAQy4B,EAAOz4B,QAEhBtb,EAAQmU,EAAKirB,KAAK88C,iBAChB,SAAA17E,GACFP,EAAOO,YAKT,O7I27pBG26E,E6IrmqBYA,CAA4BpN,IA+KjDoN,GAAoB3kC,OAAS,IAAI/2C,MAAMkkC,QACvCw3C,GAAoBlM,aAAe,GAEnCkM,GAAoBxuE,KAAO,CAC1BC,SAAU,gBACVkE,MAAO,CAAElM,KAAM4gE,IACft1C,QAAS,CAAC,OAAQ,MAAO,QACzBrf,OAAQ,CAAC,SAJV,ICvLqByrE,GAAAA,SAAAA,G9IwnqBnB,SAASA,IACP,OAAOlN,EAAgBpuE,MAAMrB,KAAMoB,YAAcpB,KAHnDoD,EAAeu5E,EAAuBlN,GAMtC,IAAI/pE,EAASi3E,EAAsBp6E,UAiBnC,OAfAmD,E8I5nqBD6G,OAAA,WACCkjE,EAAAltE,UAAMgK,OAAN1I,KAAA7D,O9IgoqBA0F,E8I5nqBD6oE,SAAA,SAAS2B,EAAOtB,GACf,IAAMlgB,EAAO,IAAI5uD,MAAM+yD,MACF,mBAAVqd,GACVA,EAAMxhB,I9ImoqBAiuB,E8I7oqBYA,CAA8BvO,IAmBnDuO,GAAsB3vE,KAAO,CAC5BC,SAAU,kBACVkE,MAAO,CAAElM,KAAM4gE,IACf30D,OAAQ,CAAC,SAHV,ICjBqB0rE,GAAAA,SAAAA,G/IspqBnB,SAASA,IACP,OAAO9K,EAAsBzwE,MAAMrB,KAAMoB,YAAcpB,KAHzDoD,EAAew5E,EAAqB9K,GAMpC,IAAIpsE,EAASk3E,EAAoBr6E,UAyIjC,OAvIAmD,E+I1pqBD6G,OAAA,WACCulE,EAAAvvE,UAAMgK,OAAN1I,KAAA7D,O/I8pqBA0F,E+I1pqBD8pB,UAAA,WACCxvB,KAAKqxE,QAAUrxE,KAAKy/B,KAAKwB,U/I6pqBzBv7B,E+I1pqBD6oE,SAAA,SAAS2B,EAAOtB,GAAU,IAIrBlgB,EACAX,EALqB9pD,EAAAjE,KACnBy/B,EAAOz/B,KAAKy/B,KACZD,EAAQx/B,KAAKw/B,MACbisB,EAAW,IAAI3rD,MAAMi9D,oBAAoB,EAAG,EAAG,EAAG,GAGxD3I,GAAUoB,aAAa/1B,GAAMltB,KAC5BkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAACqH,GACRnZ,EAAKmZ,WAAaA,IACrBnZ,EAAKmZ,SAAWA,EAOZ2wC,IACHA,EAAa53C,cACb43C,EAAe,MAEZ3wC,IAAaqiB,EAAKU,OACrBV,EAAKriB,SAAWA,EAChBsxC,EAAO,IAAI0F,GAAU30B,EAAMD,EAAOisB,GAC9BhsB,EAAKlF,UACRm0B,EAAKn0B,SAASy3C,UAAUvyC,EAAKlF,UAE1BkF,EAAKuX,UACR0X,EAAK1X,SAASg7B,UAAUvyC,EAAKuX,UAE1BvX,EAAK0E,OACRuqB,EAAKvqB,MAAM6tC,UAAUvyC,EAAK0E,OAE3BuqB,EAAK5F,MAAK,WACY,mBAAVonB,GACVA,EAAMxhB,EAAMjvB,GAEbsuB,EAAeW,EAAK5wB,UAAUvrB,KAC7BkE,EAAAA,UAAUxS,EAAKyS,eACdX,WAAU,kBAEb24C,EAAKj2C,GAAG,QAAQ,WAEfxU,EAAKyxC,KAAKzhC,KAAKhQ,MAEhByqD,EAAKj2C,GAAG,WAAW,SAACo+C,GAEnB5yD,EAAKsY,KAAKtI,KAAK,CAAEs5D,OAAQtpE,EAAKw7B,KAAKzuB,GAAI6lD,QAAAA,QAE9B5yD,EAAKyqD,MACfkgB,EAAS3qE,EAAKyqD,KAAMjvB,Q/IyqqBvB/5B,E+IlqqBDgyB,UAAA,WACCo6C,EAAAvvE,UAAMm1B,UAAN7zB,KAAA7D,MACIA,KAAK0uD,MACR1uD,KAAK0uD,KAAKr5B,W/IwqqBX3vB,E+InqqBD+nC,SAAA,SAAShO,EAAMivB,GAEVjvB,EAAKlF,UACRm0B,EAAKn0B,SAASy3C,UAAUvyC,EAAKlF,UAE1BkF,EAAKuX,UACR0X,EAAK1X,SAASg7B,UAAUvyC,EAAKuX,UAE1BvX,EAAK0E,OACRuqB,EAAKvqB,MAAM6tC,UAAUvyC,EAAK0E,OAE3BnkC,KAAK0xE,gB/I0qqBLhsE,E+ItqqBDksC,cAAA,SAAcnS,EAAMivB,GAAM,IAAAl6C,EAAAxU,KAEzBA,KAAK0uD,KAAKsI,aAAav3B,GACvB20B,GAAUoB,aAAa/1B,GAAMltB,KAC5BvP,EAAAA,QAAO,SAAAoa,GAAQ,OAAiB,OAAbA,KACnBg1D,EAAAA,KAAK,IACJr8D,WAAU,SAACqH,GACZqiB,EAAKriB,SAAWA,EAChB5I,EAAKk6C,KAAK5F,MAAK,mB/I8qqBhBpjD,E+IvqqBDwmE,WAAA,SAAW3xC,GAEVv6B,KAAKy/B,KAAK8R,WAAY,EACtBvxC,KAAKqxE,SAAU,EACfrxE,KAAK0uD,KAAKn0B,SAAS/zB,IAAI+zB,EAASjrB,EAAGirB,EAAS+G,EAAG/G,EAASoL,GAAGmR,eAAe,IAC1E92C,KAAK0uD,KAAK9X,OAAOgmC,EAAoB/lC,QACrC72C,KAAK0xE,gB/I2qqBLhsE,E+IvqqBDyrC,UAAA,WAECnxC,KAAKy/B,KAAKlF,SAAWv6B,KAAK0uD,KAAKn0B,SAASwc,UACxC/2C,KAAKy/B,KAAKuX,SAAWh3C,KAAK0uD,KAAK1X,SAASD,UACxC/2C,KAAKy/B,KAAK0E,MAAQnkC,KAAK0uD,KAAKvqB,MAAM4S,UAClC/2C,KAAKqxE,SAAU,G/I0qqBRuL,E+InyqBYA,CAA4BzL,IA8HjDyL,GAAoB/lC,OAAS,IAAI/2C,MAAMkkC,QACvC44C,GAAoBvK,SAAW,GAE/BuK,GAAoB5vE,KAAO,CAC1BC,SAAU,gBACVkE,MAAO,CAAElM,KAAM4gE,IACft1C,QAAS,CAAC,OAAQ,QAClBrf,OAAQ,CAAC,OAAQ,UChIX,IAAM2rE,GAAiB,CAAEtxE,MAAOwD,EAAUE,UAAU,YAC9C6tE,GAAiB,CAAEvxE,MAAOwD,EAAUE,UAAU,iBAErDqgE,GAAeC,OAEAwN,GAAAA,SAAAA,GhJ+yqBnB,SAASA,IACP,OAAOtN,EAAgBpuE,MAAMrB,KAAMoB,YAAcpB,KAHnDoD,EAAe25E,EAAwBtN,GAMvC,IAAI/pE,EAASq3E,EAAuBx6E,UA8OpC,OA5OAmD,EgJrxqBD6G,OAAA,WAAS,IAAAtI,EAAAjE,KACRA,KAAKkxE,OAAS,GACdlxE,KAAKg9E,SAAWh9E,KAAKiF,KAAKsgC,SAASb,GAAG0jC,aACtCqH,EAAAltE,UAAMgK,OAAN1I,KAAA7D,OACkBA,KAAK8lC,UAAYlC,GAAUiB,cACnCL,SAASjyB,KAClBkE,EAAAA,UAAUzW,KAAK0W,eACdX,WAAU,SAAC+uB,GAAD,OAAa7gC,EAAKghE,QAAqB,MAAXngC,MhJ6xqBxCp/B,EgJzxqBD6oE,SAAA,SAAS2B,EAAOtB,GAAU,IAAAp6D,EAAAxU,KAEzBA,KAAK2vE,mBAAmB3uE,MAAK,SAAA6yC,GAC5B,IAAM6a,EAAOl6C,EAAKyoE,WAAWppC,GACR,mBAAVq8B,GACVA,EAAMxhB,GAEPvG,GAAcE,UAAU91C,KACvBkE,EAAAA,UAAUjC,EAAKkC,eACdX,WAAU,SAAAikC,GACPA,EAASqK,MACZ7vC,EAAKjJ,MAA2B,IAAnByuC,EAASp5C,MAAci8E,GAAetxE,MAAQyuC,EAASzuC,MAEpEiJ,EAAKjJ,MAAQiJ,EAAKokC,kBhJiyqBrBlzC,EgJ3xqBDkzC,SAAA,WACC,OAAI54C,KAAK2J,MAAQ3J,KAAK2J,KAAK2G,KAAKb,OAASkvB,GAASC,YAAYnvB,KACtDqtE,GAAevxE,MAEf,IhJ+xqBR7F,EgJ3xqBDw3E,KAAA,WACCl9E,KAAK0uD,KAAKriC,IAAIrsB,KAAK2K,QACnB3K,KAAK0rD,SAASnzB,QAAU,EACxBv4B,KAAK0rD,SAAShB,aAAc,GhJ6yqB5BhlD,EgJ3xqBDy3E,KAAA,WACCn9E,KAAK0uD,KAAKrkD,OAAOrK,KAAK2K,QACtB3K,KAAK0rD,SAASnzB,QAAU,EACxBv4B,KAAK0rD,SAAShB,aAAc,GhJ+yqB5BhlD,EgJ3xqBDu3E,WAAA,SAAWppC,GACV,IAAM6a,EAAO,IAAI5uD,MAAM+yD,MAGjB3b,EAAM18B,KAAK2zC,GAAK,IAAM,IACtBzyC,EAAQ4zD,GAAep4B,EACvBv7B,EAASD,EAAQ,IAAM,IAEvBm0D,EAASn0D,GADLm4B,EAAOn4B,MAAQC,EAASk4B,EAAOl4B,QAEnC8vC,EAAW,IAAI3rD,MAAMiwE,uBAAuBT,GAAcA,GAAc3zD,EAAQ,GAAI,GAAG,EAAM,EAAGu7B,GACtGuU,EAAStnB,OAAO,EAAG,EAAG,GACtB,IAAM/5B,EAAUypC,EAAOzpC,QACvBA,EAAQsjD,MAAQtjD,EAAQwlE,MAAQ9vE,MAAMi0D,eACtC3pD,EAAQylE,OAAOvgE,EAAIugE,EACnBzlE,EAAQ0lE,SAAWhwE,MAAM8wD,aACzB,IAAMlF,EAAW1rD,KAAK0rD,SAAW,IAAI5rD,MAAM8rD,kBAAkB,CAC5Dv8C,IAAKjF,EACLuqD,aAAa,EACbp8B,QAAS,IAGKv4B,KAAK2K,OAAS,IAAI7K,MAAMssD,KAAKX,EAAUC,GAQtD,OAPAgD,EAAKwa,SAAW,CACfzX,OAAQ,WACP/C,EAAK1X,SAAS1V,GAAK9mB,KAAK2zC,GAAK,IAAM,MAK9BO,GhJ6xqBPhpD,EgJ1xqBD03E,eAAA,WAAiB,IAAAzoE,EAAA3U,KAChBA,KAAK2vE,mBAAmB3uE,MAAK,SAAA6yC,GAE5B,IAAMqD,EAAM18B,KAAK2zC,GAAK,IAAM,IACtBzyC,EAAQ4zD,GAAep4B,EACvBv7B,EAASD,EAAQ,IAAM,IAEvBm0D,EAASn0D,GADLm4B,EAAOn4B,MAAQC,EAASk4B,EAAOl4B,QAEzChH,EAAKvK,QAAQylE,OAAOvgE,EAAIugE,MhJgyqBzBnqE,EgJ5xqBDiqE,iBAAA,WAAmB,IAAA96D,EAAA7U,KAClB,OAAO,IAAIe,SAAQ,SAACV,EAASC,GAC5B,IAKI8zC,EAJA+7B,EADU,IAEVC,EAAI,GACFC,EAAI71D,KAAKoK,MAAMwrD,IACfE,EAAI91D,KAAKoK,MAAMwrD,MAGpBh8B,EADGv/B,EAAKu/B,OACCv/B,EAAKu/B,OAELv/B,EAAKu/B,OAASvvC,SAAS0W,cAAc,WAIxCG,MAAQy0D,EACf/7B,EAAOz4B,OAASy0D,EAChB,IA2BIhmE,EA3BEgI,EAAOyC,EAAKq8D,OAEZ78B,EAAMD,EAAOznC,WAAW,MAE9B0nC,EAAI+hB,uBAAwB,EAC5B/hB,EAAIgiB,sBAAwB,OAC5BhiB,EAAIk8B,KAAJ,OAAkBF,EAAlB,MAAyBtlE,EAAYP,WAErC2lE,EADgB97B,EAAIm8B,YAAYp+D,GACpBsJ,MAAQ,EACpBy0D,EAAI31D,KAAKC,IAxBK,IAwBMD,KAAK4d,IAAI,EAAG5d,KAAKqiD,KAAKriD,KAAK9T,IAAIypE,GAAK31D,KAAK9T,IAAI,MAGjE0tC,EAAO14B,MAAQy0D,EACf97B,EAAIo8B,UAAU,EAAG,EAAGN,EAAGC,GACvB/7B,EAAI0d,UAAY,YAChB1d,EAAI2d,SAAS,EAAG,EAAGme,EAAGC,GACtB/7B,EAAIk8B,KAAJ,OAAkBF,EAAlB,MAAyBtlE,EAAYP,WACrC6pC,EAAIq8B,UAAY,SAChBr8B,EAAIs8B,aAAe,SACnBt8B,EAAIu8B,YAAc,sBAClBv8B,EAAIw8B,UAAYP,EAChBj8B,EAAIy8B,SAAW,QACfz8B,EAAI08B,WAAa,EACjB18B,EAAI28B,WAAW5+D,EAAM+9D,EAAI,EAAGC,IAC5B/7B,EAAI0d,UAAY,QAChB1d,EAAI48B,SAAS7+D,EAAM+9D,EAAI,EAAGC,GAAOD,GAG7Bt7D,EAAKzK,SACRA,EAAUyK,EAAKzK,SACPsgD,aAAc,EAEtBtgD,EAAUyK,EAAKzK,QAAU,IAAItK,MAAMwxD,cAAcld,GAGlD/zC,EAAQ,CAAE+J,QAASA,EAASsR,MAAOy0D,EAAGx0D,OAAQy0D,QhJ2yqB/CjuE,EAAa46E,EAAwB,CAAC,CACpCt8E,IAAK,QACL8D,IAAK,WgJ5/qBP,OAAOvE,KAAKkxE,QhJ+/qBV1qE,IAAK,SgJ7/qBE+E,GACLvL,KAAKkxE,SAAW3lE,IACnBvL,KAAKkxE,OAAS3lE,EACVA,IAAUuxE,GAAevxE,OAAoB,KAAVA,GAAgBvL,KAAKg9E,UAC3Dh9E,KAAKo9E,iBACLp9E,KAAKk9E,QAELl9E,KAAKm9E,UhJkgrBJ,CACD18E,IAAK,UACL8D,IAAK,WgJ9/qBP,OAAOvE,KAAKg9E,UhJigrBVx2E,IAAK,SgJ//qBIy+D,GACPjlE,KAAKg9E,WAAa/X,IACrBjlE,KAAKg9E,SAAW/X,EACZA,GAA2B,KAAhBjlE,KAAKkxE,QACnBlxE,KAAKo9E,iBACLp9E,KAAKk9E,QAELl9E,KAAKm9E,YhJsgrBAJ,EgJjirBYA,CAA+B3O,IAuNpD2O,GAAuB/vE,KAAO,CAC7BC,SAAU,mBACVkE,MAAO,CAAElM,KAAM4gE,IACf30D,OAAQ,CAAC,SAHV,IC/NqBmsE,GAAAA,SAAAA,GjJojrBnB,SAASA,IACP,OAAO5N,EAAgBpuE,MAAMrB,KAAMoB,YAAcpB,KAHnDoD,EAAei6E,EAAoB5N,GAMnC,IAAI/pE,EAAS23E,EAAmB96E,UA0LhC,OAxLAmD,EiJxjrBD6G,OAAA,WACCkjE,EAAAltE,UAAMgK,OAAN1I,KAAA7D,MACAA,KAAKg6C,SAAW,GjJ4jrBhBt0C,EiJxjrBD6oE,SAAA,SAAS2B,EAAOtB,GAAU,IAAA3qE,EAAAjE,KACzBA,KAAKs9E,UAAUvyE,EAAY1E,QAAQrG,KAAKy/B,KAAK89C,aAAcv9E,KAAKy/B,KAAK+9C,WAAW,SAAC9uB,GAC3D,mBAAVwhB,GACVA,EAAMxhB,GAEPzqD,EAAK+1C,SAAW,EAChB/1C,EAAKsR,kBjJkkrBN7P,EiJ1jrBD2tD,UAAA,SAAUptD,EAAMm6B,GACf,IAAIqpB,EAOJ,OALCA,GAD6B,IAA1BrpB,EAAKl7B,QAAQ,QACP,IAAIpF,MAAM29E,UAEV,IAAI39E,MAAMylE,YAEb5b,QAAQ1jD,GACRwjD,GjJ+jrBP/jD,EiJ5jrBD43E,UAAA,SAAUr3E,EAAMm6B,EAAM1nB,GAAU,IAAAlE,EAAAxU,KAGhBA,KAAKqzD,UAAUptD,EAAMm6B,GAC7B0oB,KAAK1oB,GAAM,SAACr2B,GAClB,IAAI2kD,EACElpB,EAAQz7B,EAAMy7B,MAEnBkpB,EADGlpB,GAGIz7B,EAER,IAAMy1B,EAAQhrB,EAAKirB,KAAKD,MACxBkvB,EAAKvqB,MAAM39B,IAAI,IAAM,IAAM,KAE3BkoD,EAAKiW,UAAS,SAACC,GACd,GAAIA,EAAMC,OAAQ,CAEjB,IAAMplC,EAAOD,EAAMliB,MAAK,SAAAhO,GAAC,OAAIA,EAAE0B,KAAO4zD,EAAMn1D,QAC5C,GAAIgwB,EACHA,EAAKivB,KAAOkW,MACN,CAONA,EAAMlZ,SAASr2B,UAEf,IAAMq2B,EAAW,IAAI5rD,MAAMyxD,qBAAqB,CAC/C1F,MAAO,QACPgjB,UAAW,KAEZjK,EAAMlZ,SAAWA,OAIpBgD,EAAKn0B,SAAS+G,EAAY,GAAP,KACnB9B,EAAMt7B,SAAQ,SAAAu7B,GACb,IAAMrJ,EAAWqJ,EAAKivB,KACtB,GAAIt4B,EAAU,CACTA,EAASs1B,UACZt1B,EAASs1B,SAASG,MAAM6xB,OAAO,GAEhC,IAAMtT,EAASh0C,EAASg0C,OAClB1b,EAAOjvB,EAAKivB,KAAO,IAAI0F,GAAU30B,EAAMD,EAAOpJ,EAASq1B,UAC7DiD,EAAKrB,WAAY,EACjBqB,EAAKjkD,YAAc,EACnBikD,EAAKj/C,KAAO2mB,EAAS3mB,KACrBi/C,EAAKn0B,SAASoc,KAAKvgB,EAASmE,UAC5Bm0B,EAAK1X,SAASL,KAAKvgB,EAAS4gB,UAC5B0X,EAAKvqB,MAAMwS,KAAKvgB,EAAS+N,OACzBuqB,EAAK5F,MAAK,WAETshB,EAAO/9C,IAAIqiC,GACX0b,EAAO//D,OAAO+rB,GACVA,EAASs1B,UACZt1B,EAASs1B,SAASr2B,aAGpBq5B,EAAKj2C,GAAG,QAAQ,WACfhS,QAAQC,IAAI,2BACZ8N,EAAKkhC,KAAKzhC,KAAKO,MAEhBk6C,EAAKj2C,GAAG,WAAW,SAACo+C,GACnBpwD,QAAQC,IAAI,6BAA8BmwD,GAC1CriD,EAAK+H,KAAKtI,KAAK,CAAEs5D,OAAQ9tC,EAAKzuB,GAAI6lD,QAAAA,WAItB,IAAI1yD,MAAM,GAAGqzB,KAAK,GAAGnoB,KAAI,SAACC,EAAG3N,GAC3C,IAAMqvD,EAAQ,IAAIlxD,MAAMmxD,WAAW,SAAU,GAAK,IAAM,GAQlD0sB,EAAUnjE,KAAK2zC,GAAK,IAAM,GAAK3zC,KAAK2zC,GAAK,IAAM,IAAMxsD,EAO3D,OANAqvD,EAAMz2B,SAAS/zB,IAAwB,EAApBgU,KAAKs3C,IAAI6rB,GAAc,EAAuB,EAApBnjE,KAAKo3C,IAAI+rB,IAKtDnpE,EAAK5E,MAAMyc,IAAI2kC,GACRA,KAEgB,mBAAbt4C,GACVA,EAASg2C,GAEVl6C,EAAKwlC,SAAW,EAChBxlC,EAAKe,iBAEH,SAACsiE,GACCA,EAAc+F,iBACjBppE,EAAKwlC,SAAWx/B,KAAKouC,MAAMivB,EAAcrvB,OAASqvB,EAAcjyB,MAAQ,MAExEpxC,EAAKwlC,SAAWxlC,EAAKwlC,UAAY,EACjCxlC,EAAKwlC,SAAWx/B,KAAKO,IAAI,IAAKvG,EAAKwlC,SAAW,IAG/CxlC,EAAKe,kBjJulrBN7P,EiJnlrBDgyB,UAAA,WACC+3C,EAAAltE,UAAMm1B,UAAN7zB,KAAA7D,MACA,IAAMy/B,EAAOz/B,KAAKy/B,KAClB,GAAIA,EAAM,CACT,IAAMD,EAAQC,EAAKD,MACfA,GACHA,EAAMt7B,SAAQ,SAAAu7B,GACTA,EAAKivB,OACRjvB,EAAKivB,KAAKr5B,iBACHoK,EAAKivB,WjJ6lrBT2uB,EiJlvrBYA,CAA2BjP,IA8JhDiP,GAAmBhL,SAAW,GAE9BgL,GAAmBrwE,KAAO,CACzBC,SAAU,eACVkE,MAAO,CAAElM,KAAM4gE,IACft1C,QAAS,CAAC,OAAQ,QAClBrf,OAAQ,CAAC,SAJV,ICpKqB2sE,GAAAA,SAAAA,GlJmwrBnB,SAASA,IACP,OAAOpO,EAAgBpuE,MAAMrB,KAAMoB,YAAcpB,KAHnDoD,EAAey6E,EAAoBpO,GAMnC,IAAI/pE,EAASm4E,EAAmBt7E,UAiBhC,OAfAmD,EkJvwrBD6G,OAAA,WACCkjE,EAAAltE,UAAMgK,OAAN1I,KAAA7D,OlJ2wrBA0F,EkJvwrBD6oE,SAAA,SAAS2B,EAAOtB,GACf,IAAMlgB,EAAO,IAAI5uD,MAAM+yD,MACF,mBAAVqd,GACVA,EAAMxhB,IlJ8wrBAmvB,EkJxxrBYA,CAA2BzP,IAmBhDyP,GAAmB7wE,KAAO,CACzBC,SAAU,eACVkE,MAAO,CAAElM,KAAM4gE,IACf30D,OAAQ,CAAC,SAHV,ICkDa4sE,GAAb,SAAApkC,GAAA,SAAAokC,IAAA,OAAApkC,EAAAr4C,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAA06E,EAAApkC,GAAAokC,EAAA,CAA+BnkC,EAAAA,QAE/BmkC,GAAU9wE,KAAO,CAChB4sC,QAAS,CACRmkC,EAAAA,WACAC,EAAAA,WACAvkC,IAEDI,aAAc,CACbxtC,EACA8I,EACAyZ,GACA6B,GACAc,GACAsU,GACApN,GACAxB,GACAiC,GACAsC,GACAI,GACAC,GACAkO,GACA2K,GACA+G,GACAY,GACAgB,GACAW,GACAE,GACArJ,GACA0J,GACAC,GACAI,GACAxU,GACA16B,EACAmvC,GACAE,GACAD,GACAE,GACAC,GACA1U,GACAU,GACAiB,GACAgT,GACApF,GACAiK,GACA/D,GACAM,GACAnB,GACApwC,EACAwxC,GACAwB,GACAI,GACAjkB,GACAsxC,GACApB,GACAyD,GACAW,GACAY,GACA2C,GACAoB,GACAwC,GACA6B,GACAmB,GACAC,GACAG,GACAM,GACAQ,GACAz7B,GACAC,GACAzC,GACAmD,GACAzkB,GACAolB,GACA3D,GACA2E,GACAmhB,IAEDoY,UAAWn2C,IClJZo2C,EAAAA,QAAQD,UAAUH","file":"docs\\js\\main.min.js","sourcesContent":[null,"\r\nexport const environmentServed = {\r\n\tappKey: '865af1430a854af5b01733ff9b725a2b',\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\tproduction: true,\r\n\t\tuseProxy: false,\r\n\t\tuseToken: false,\r\n\t\tselfService: true,\r\n\t\tguidedTourRequest: true,\r\n\t\teditor: false,\r\n\t\teditorAssetScreen: false,\r\n\t\tar: true,\r\n\t\tmenu: true,\r\n\t\tchat: false,\r\n\t\tattendee: true,\r\n\t\tstreamer: true,\r\n\t\tviewer: true,\r\n\t\tsmartDevice: true,\r\n\t\tmaxQuality: false,\r\n\t},\r\n\tlogo: null, //'/Modules/B-Here/Client/docs/img/logo.png'\r\n\tbackground: {\r\n\t\timage: '/Modules/B-Here/Client/docs/img/background.jpg',\r\n\t\tvideo: '/Modules/B-Here/Client/docs/img/background.mp4',\r\n\t},\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room', 'room-3d'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\tassets: '/Modules/B-Here/Client/docs/',\r\n\tworker: '/Modules/B-Here/Client/docs/js/workers/image.service.worker.js',\r\n\tgithubDocs: 'https://raw.githubusercontent.com/diegoUE8/b-here-master/ws/docs/',\r\n\tlanguage: '/it',\r\n\tmarket: '/it',\r\n\turl: {\r\n\t\tindex: '/',\r\n\t\taccess: '/',\r\n\t\teditor: '/editor',\r\n\t\tselfServiceTour: '/self-service-tour',\r\n\t\tguidedTour: '/guided-tour',\r\n\t\taccessCode: '/access-code',\r\n\t},\r\n\ttemplate: {\r\n\t\ttryInAr: '/template/modules/b-here/try-in-ar.cshtml?viewId=$viewId',\r\n\t\tmodal: {\r\n\t\t\tcontrolRequest: '/template/modules/b-here/control-request-modal.cshtml',\r\n\t\t\ttryInAr: '/template/modules/b-here/try-in-ar-modal.cshtml',\r\n\t\t\tview: {\r\n\t\t\t\t'panorama': '/template/modules/b-here/panorama-modal.cshtml',\r\n\t\t\t\t'panorama-grid': '/template/modules/b-here/panorama-grid-modal.cshtml',\r\n\t\t\t\t'room-3d': '/template/modules/b-here/room-3d-modal.cshtml',\r\n\t\t\t\t'model': '/template/modules/b-here/model-modal.cshtml',\r\n\t\t\t},\r\n\t\t\tviewItem: {\r\n\t\t\t\t'nav': '/template/modules/b-here/nav-modal.cshtml',\r\n\t\t\t\t'plane': '/template/modules/b-here/plane-modal.cshtml',\r\n\t\t\t\t'curved-plane': '/template/modules/b-here/curved-plane-modal.cshtml',\r\n\t\t\t\t'texture': '/template/modules/b-here/texture-modal.cshtml',\r\n\t\t\t\t'model': '/template/modules/b-here/item-model-modal.cshtml',\r\n\t\t\t},\r\n\t\t\tremove: '/template/modules/b-here/remove-modal.cshtml',\r\n\t\t}\r\n\t},\r\n\tlanguages: ['en'],\r\n\tdefaultLanguage: 'en',\r\n};\r\n","\r\nexport class Utils {\r\n\r\n\tstatic merge(target, source) {\r\n\t\tif (typeof source === 'object') {\r\n\t\t\tObject.keys(source).forEach(key => {\r\n\t\t\t\tconst value = source[key];\r\n\t\t\t\tif (typeof value === 'object' && !Array.isArray(value)) {\r\n\t\t\t\t\ttarget[key] = this.merge(target[key], value);\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttarget[key] = value;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn target;\r\n\t}\r\n\r\n}\r\n","import { environmentServed } from './environment.served';\r\nimport { environmentStatic } from './environment.static';\r\nimport { Utils } from './utils/utils';\r\n\r\nexport const NODE = (typeof module !== 'undefined' && module.exports);\r\nexport const PARAMS = NODE ? { get: () => { } } : new URLSearchParams(window.location.search);\r\nexport const DEBUG = false || (PARAMS.get('debug') != null);\r\nexport const BASE_HREF = NODE ? null : document.querySelector('base').getAttribute('href');\r\nexport const HEROKU = NODE ? false : (window && window.location.host.indexOf('herokuapp') !== -1);\r\nexport const STATIC = NODE ? false : (HEROKU || (window && (window.location.port === '41789' || window.location.port === '5000' || window.location.port === '6443' || window.location.host === 'diegoUE8.github.io')));\r\nexport const DEVELOPMENT = NODE ? false : (window && ['localhost', '127.0.0.1', '0.0.0.0'].indexOf(window.location.host.split(':')[0]) !== -1);\r\nexport const PRODUCTION = !DEVELOPMENT;\r\nexport const ENV = {\r\n\tSTATIC,\r\n\tDEVELOPMENT,\r\n\tPRODUCTION\r\n};\r\n\r\nexport class Environment {\r\n\r\n\tget STATIC() {\r\n\t\treturn ENV.STATIC;\r\n\t}\r\n\tset STATIC(STATIC) {\r\n\t\tENV.STATIC = (STATIC === true || STATIC === 'true');\r\n\t\tconsole.log('Environment.STATIC.set', ENV.STATIC);\r\n\t}\r\n\r\n\tget href() {\r\n\t\tif (HEROKU) {\r\n\t\t\treturn this.githubDocs;\r\n\t\t} else {\r\n\t\t\treturn BASE_HREF;\r\n\t\t}\r\n\t}\r\n\r\n\tgetAbsoluteUrl(path, params) {\r\n\t\tlet url = `${window.location.origin}${path}`;\r\n\t\t// let url = `${window.location.protocol}//${window.location.host}${path}`;\r\n\t\tObject.keys(params).forEach(key => {\r\n\t\t\turl = url.replace(`$${key}`, params[key]);\r\n\t\t});\r\n\t\treturn url;\r\n\t}\r\n\r\n\tgetPath(path) {\r\n\t\treturn this.isLocal(path) ? (this.href + path) : path;\r\n\t}\r\n\r\n\tisLocal(path) {\r\n\t\treturn path.indexOf('://') === -1;\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tif (typeof options.url === 'object') {\r\n\t\t\t\tconst language = options.language || '';\r\n\t\t\t\tconst market = options.market || '';\r\n\t\t\t\tObject.keys(options.url).forEach(key => {\r\n\t\t\t\t\toptions.url[key] = language + market + options.url[key];\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nconst defaultOptions = {\r\n\tport: 5000,\r\n\tfontFamily: 'GT Walsheim, sans-serif',\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room', 'room-3d'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\trenderOrder: {\r\n\t\tpanorama: 0,\r\n\t\tmodel: 10,\r\n\t\tplane: 20,\r\n\t\ttile: 30,\r\n\t\tbanner: 40,\r\n\t\tnav: 50,\r\n\t\tpanel: 60,\r\n\t\tmenu: 70,\r\n\t\tdebug: 80,\r\n\t\tpointer: 90,\r\n\t}\r\n};\r\n\r\nconst defaultAppOptions = {\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\tproduction: false,\r\n\t\tuseProxy: false,\r\n\t\tuseToken: false,\r\n\t\tselfService: true,\r\n\t\tguidedTourRequest: true,\r\n\t\teditor: true,\r\n\t\tar: true,\r\n\t\tmenu: true,\r\n\t\tattendee: true,\r\n\t\tstreamer: true,\r\n\t\tviewer: true,\r\n\t\tsmartDevice: true,\r\n\t\tmaxQuality: false,\r\n\t\theroku: HEROKU,\r\n\t},\r\n};\r\n\r\nconst environmentOptions = window.STATIC ? environmentStatic : environmentServed;\r\n\r\nlet options = Object.assign(defaultOptions, defaultAppOptions, environmentOptions);\r\noptions = Utils.merge(options, window.bhere);\r\n\r\nexport const environment = new Environment(options);\r\n\r\nconsole.log('environment', environment);\r\n","\r\nexport const environmentStatic = {\r\n\tappKey: '865af1430a854af5b01733ff9b725a2b',\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\tproduction: false,\r\n\t\tuseProxy: false,\r\n\t\tuseToken: false,\r\n\t\tselfService: true,\r\n\t\tguidedTourRequest: true,\r\n\t\teditor: true,\r\n\t\teditorAssetScreen: true,\r\n\t\tar: true,\r\n\t\tmenu: true,\r\n\t\tchat: true,\r\n\t\tattendee: true,\r\n\t\tstreamer: true,\r\n\t\tviewer: true,\r\n\t\tsmartDevice: true,\r\n\t\tmaxQuality: false,\r\n\t},\r\n\tlogo: null, //'/b-here/img/logo.png'\r\n\tbackground: {\r\n\t\timage: '/b-here/img/background.jpg',\r\n\t\tvideo: '/b-here/img/background.mp4',\r\n\t},\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room', 'room-3d'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\tassets: '/b-here/',\r\n\tworker: './js/workers/image.service.worker.js',\r\n\tgithubDocs: 'https://raw.githubusercontent.com/diegoUE8/b-here-master/ws/docs/',\r\n\tlanguage: '',\r\n\tmarket: '',\r\n\turl: {\r\n\t\tindex: '/',\r\n\t\taccess: '/',\r\n\t\teditor: '/editor',\r\n\t\tselfServiceTour: '/self-service-tour',\r\n\t\tguidedTour: '/guided-tour',\r\n\t\taccessCode: '/access-code',\r\n\t},\r\n\ttemplate: {\r\n\t\ttryInAr: '/try-in-ar.html?viewId=$viewId',\r\n\t\tmodal: {\r\n\t\t\tcontrolRequest: '/control-request-modal.html',\r\n\t\t\ttryInAr: '/try-in-ar-modal.html',\r\n\t\t\tview: {\r\n\t\t\t\t'panorama': '/panorama-modal.html',\r\n\t\t\t\t'panorama-grid': '/panorama-grid-modal.html',\r\n\t\t\t\t'room-3d': '/room-3d-modal.html',\r\n\t\t\t\t'model': '/model-modal.html',\r\n\t\t\t},\r\n\t\t\tviewItem: {\r\n\t\t\t\t'nav': '/nav-modal.html',\r\n\t\t\t\t'plane': '/plane-modal.html',\r\n\t\t\t\t'curved-plane': '/curved-plane-modal.html',\r\n\t\t\t\t'texture': '/texture-modal.html',\r\n\t\t\t\t'model': '/item-model-modal.html',\r\n\t\t\t},\r\n\t\t\tremove: '/remove-modal.html',\r\n\t\t}\r\n\t},\r\n\tlanguages: ['en'],\r\n\tdefaultLanguage: 'en',\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\n\r\nexport default class AccessCodeComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.env = environment;\r\n\t\tconst link = LocationService.get('link');\r\n\t\tif (!link) {\r\n\t\t\twindow.location.href = `${window.location.origin}${environment.url.guidedTour}`;\r\n\t\t}\r\n\t\tconst url = `${window.location.origin}${environment.url.guidedTour}?link=${link}`;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst qrcode = new QRious({\r\n\t\t\telement: node.querySelector('.qrcode'),\r\n\t\t\tvalue: url,\r\n\t\t\tsize: 256\r\n\t\t});\r\n\t}\r\n}\r\n\r\nAccessCodeComponent.meta = {\r\n\tselector: '[access-code-component]',\r\n};\r\n","export default class LocationService {\r\n\r\n\tstatic has(key) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t// console.log('LocationService.has', params);\r\n\t\treturn params.has(key);\r\n\t}\r\n\r\n\tstatic get(key) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t// console.log('LocationService.get', params);\r\n\t\treturn params.get(key);\r\n\t}\r\n\r\n\tstatic set(keyOrValue, value) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\tif (typeof keyOrValue === 'string') {\r\n\t\t\tparams.set(keyOrValue, value);\r\n\t\t} else {\r\n\t\t\tparams.set(keyOrValue, '');\r\n\t\t}\r\n\t\tthis.replace(params);\r\n\t\t// console.log('LocationService.set', params, keyOrValue, value);\r\n\t}\r\n\r\n\tstatic replace(params) {\r\n\t\tif (window.history && window.history.pushState) {\r\n\t\t\tconst title = document.title;\r\n\t\t\tconst url = `${window.location.href.split('?')[0]}?${params.toString()}`;\r\n\t\t\twindow.history.pushState(params.toString(), title, url);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic deserialize(key) {\r\n\t\tconst encoded = this.get('params');\r\n\t\treturn this.decode(key, encoded);\r\n\t}\r\n\r\n\tstatic serialize(keyOrValue, value) {\r\n\t\tconst params = this.deserialize();\r\n\t\tconst encoded = this.encode(keyOrValue, value, params);\r\n\t\tthis.set('params', encoded);\r\n\t}\r\n\r\n\tstatic decode(key, encoded) {\r\n\t\tlet decoded = null;\r\n\t\tif (encoded) {\r\n\t\t\tconst json = window.atob(encoded);\r\n\t\t\tdecoded = JSON.parse(json);\r\n\t\t}\r\n\t\tif (key && decoded) {\r\n\t\t\tdecoded = decoded[key];\r\n\t\t}\r\n\t\treturn decoded || null;\r\n\t}\r\n\r\n\tstatic encode(keyOrValue, value, params) {\r\n\t\tparams = params || {};\r\n\t\tlet encoded = null;\r\n\t\tif (typeof keyOrValue === 'string') {\r\n\t\t\tparams[keyOrValue] = value;\r\n\t\t} else {\r\n\t\t\tparams = keyOrValue;\r\n\t\t}\r\n\t\tconst json = JSON.stringify(params);\r\n\t\tencoded = window.btoa(json);\r\n\t\treturn encoded;\r\n\t}\r\n\r\n}\r\n","import { Pipe } from \"rxcomp\";\r\nimport { Utils } from \"../utils/utils\";\r\n\r\nexport const LABELS = Utils.merge({\r\n\tbrowse: 'Browse',\r\n\tcancel: 'Cancel',\r\n\tdrag_and_drop_images: 'Drag And Drop your images here',\r\n\terror_email: 'Invalid email',\r\n\terror_match: 'Fields do not match',\r\n\terror_required: 'Field is required',\r\n\tloading: 'loading',\r\n\tremove: 'Remove',\r\n\trequired: 'Required',\r\n\tselect: 'Select',\r\n\tselect_file: 'Select a file...',\r\n\tupdate: 'Update',\r\n\tupload: 'Upload',\r\n\twaiting_host: 'waiting host',\r\n\t// editor\r\n\teditor_image: 'Image',\r\n\teditor_video: 'Video',\r\n\teditor_model: 'Model',\r\n\teditor_publisher_stream: 'Publisher Stream',\r\n\teditor_next_attendee_stream: 'Next Attendee Stream',\r\n\teditor_waiting_room: 'Waiting Room',\r\n\teditor_panorama: 'Panorama',\r\n\teditor_panorama_grid: 'Panorama Grid',\r\n\teditor_room_3d: 'Room 3D',\r\n\teditor_model: 'Model',\r\n\teditor_nav: 'Nav Tooltip',\r\n\teditor_gltf: 'Gltf Model',\r\n\teditor_plane: 'Plane',\r\n\teditor_curved_plane: 'Curved Plane',\r\n\teditor_texture: 'Texture',\r\n}, window.labels);\r\n\r\nexport default class LabelPipe extends Pipe {\r\n\r\n\tstatic transform(key) {\r\n\t\tconst labels = LABELS;\r\n\t\treturn labels[key] || `#${key}#`;\r\n\t}\r\n\r\n\tstatic getKeys(...keys) {\r\n\t\treturn this.transform(keys.map(x => x.replace('-','_')).join('_'));\r\n\t}\r\n}\r\n\r\nLabelPipe.meta = {\r\n\tname: 'label',\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormAbstractCollectionDirective, FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport LabelPipe from '../label/label.pipe';\r\n\r\nexport default class ControlsComponent extends Component {\r\n\r\n\tget group() {\r\n\t\tif (this.formGroup) {\r\n\t\t\treturn this.formGroup;\r\n\t\t} else {\r\n\t\t\tif (!this.host) {\r\n\t\t\t\tthrow ('missing form collection');\r\n\t\t\t}\r\n\t\t\treturn this.host.control;\r\n\t\t}\r\n\t}\r\n\r\n\tgetControl(name) {\r\n\t\treturn this.group.get(name);\r\n\t}\r\n}\r\n\r\nControlsComponent.meta = {\r\n\tselector: '[controls]',\r\n\tinputs: ['formGroup', 'fields'],\r\n\thosts: { host: FormAbstractCollectionDirective },\r\n\ttemplate: /* html */`\r\n\t\t<div *for=\"let field of fields\">\r\n\t\t\t<div *if=\"['text', 'email', 'url'].indexOf(field.type) !== -1\" control-text [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'select'\" control-select [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'custom-select'\" control-custom-select [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'textarea'\" control-textarea [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'checkbox'\" control-checkbox [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<input *if=\"field.type == 'hidden'\" [name]=\"field.name\" [formControl]=\"getControl(field.name)\" value=\"\" type=\"text\" style=\"display:none !important;\" />\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nexport function fieldsToFormControls(fields) {\r\n\tconst controls = fields.reduce((p, c, i) => {\r\n\t\tconst validators = [];\r\n\t\tif (c.required) {\r\n\t\t\tvalidators.push(c.type === 'checkbox' ? Validators.RequiredTrueValidator() : Validators.RequiredValidator());\r\n\t\t}\r\n\t\tif (c.type === 'email') {\r\n\t\t\tvalidators.push(Validators.EmailValidator());\r\n\t\t}\r\n\t\tif (c.type === 'url') {\r\n\t\t\tvalidators.push(Validators.PatternValidator('(https?:\\/\\/(?:www\\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|www\\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|https?:\\/\\/(?:www\\.|(?!www))[a-zA-Z0-9]+\\.[^\\s]{2,}|www\\.[a-zA-Z0-9]+\\.[^\\s]{2,})'));\r\n\t\t}\r\n\t\tif (c.pattern != null) {\r\n\t\t\tvalidators.push(Validators.PatternValidator(c.pattern));\r\n\t\t}\r\n\t\tp[c.name] = new FormControl((c.value != null ? c.value : null), validators);\r\n\t\tif (c.type === 'select' || c.type === 'custom-select') {\r\n\t\t\tconst options = (c.options || []).slice();\r\n\t\t\toptions.unshift({ id: null, name: LabelPipe.transform('select') });\r\n\t\t\tp[c.name].options = options;\r\n\t\t}\r\n\t\treturn p;\r\n\t}, {});\r\n\treturn controls;\r\n}\r\n\r\nexport function fieldsToFormGroup(fields) {\r\n\treturn new FormGroup(fieldsToFormControls(fields));\r\n}\r\n\r\nexport function patchFields(fields, form) {\r\n\tconst testValues = fields.reduce((p, c, i) => {\r\n\t\tif (c.test) {\r\n\t\t\tp[c.name] = c.test;\r\n\t\t}\r\n\t\treturn p;\r\n\t}, {});\r\n\tform.patch(testValues);\r\n}\r\n","import { from, throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nexport class HttpResponse {\r\n\r\n\tget static() {\r\n\t\treturn this.url.indexOf('.json') === this.url.length - 5;\r\n\t}\r\n\r\n\tconstructor(response) {\r\n\t\tthis.data = null;\r\n\t\tif (response) {\r\n\t\t\tthis.url = response.url;\r\n\t\t\tthis.status = response.status;\r\n\t\t\tthis.statusText = response.statusText;\r\n\t\t\tthis.ok = response.ok;\r\n\t\t\tthis.redirected = response.redirected;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport default class HttpService {\r\n\r\n\tstatic http$(method, url, data, format = 'json') {\r\n\t\tconst methods = ['POST', 'PUT', 'PATCH'];\r\n\t\tlet response_ = null;\r\n\t\t// url = this.getUrl(url, format);\r\n\t\treturn from(fetch(url, {\r\n\t\t\tmethod: method,\r\n\t\t\theaders: {\r\n\t\t\t\t'Accept': 'application/json',\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t},\r\n\t\t\tbody: methods.indexOf(method) !== -1 ? JSON.stringify(data) : undefined\r\n\t\t}).then((response) => {\r\n\t\t\tresponse_ = response;\r\n\t\t\t// console.log(response);\r\n\t\t\ttry {\r\n\t\t\t\tconst contentType = response.headers.get('content-type');\r\n\t\t\t\tlet typedResponse;\r\n\t\t\t\tif (contentType && contentType.indexOf('application/json') !== -1) {\r\n\t\t\t\t\ttypedResponse = response.json();\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttypedResponse = response.text();\r\n\t\t\t\t}\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\treturn typedResponse;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn typedResponse.then(data => {\r\n\t\t\t\t\t\treturn Promise.reject(data);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} catch(error) {\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\tconsole.warn('HttpService.http$', 'Cannot parse response');\r\n\t\t\t\t\treturn Promise.resolve();\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn Promise.reject(error);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})).pipe(\r\n\t\t\tcatchError(error => {\r\n\t\t\t\treturn throwError(this.getError(error, response_));\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\t/*\r\n\t// !!! todo mapping response.data\r\n\tstatic http$(method, url, data, format = 'json') {\r\n\t\tconst methods = ['POST', 'PUT', 'PATCH'];\r\n\t\tconst body = (data && methods.indexOf(method) !== -1) ? JSON.stringify(data) : undefined;\r\n\t\tconst queryString = (data && methods.indexOf(method) !== -1) ? Object.keys(data).map(function(key) {\r\n\t\t    return key + '=' + encodeURI(data[key]);\r\n\t\t}).join('&') : undefined;\r\n\t\tif (queryString) {\r\n\t\t\turl = `${url}?${queryString}`;\r\n\t\t}\r\n\t\tlet response_ = null;\r\n\t\treturn from(fetch(url, {\r\n\t\t\tmethod: method,\r\n\t\t\theaders: {\r\n\t\t\t\t'Accept': 'application/json',\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t},\r\n\t\t\tbody: body,\r\n\t\t}).then((response) => {\r\n\t\t\tresponse_ = new HttpResponse(response);\r\n\t\t\ttry {\r\n\t\t\t\tconst contentType = response.headers.get('content-type');\r\n\t\t\t\tlet typedResponse;\r\n\t\t\t\tif (contentType && format === 'json' && contentType.indexOf('application/json') !== -1) {\r\n\t\t\t\t\ttypedResponse = response.json();\r\n\t\t\t\t} else if (format === 'blob') {\r\n\t\t\t\t\ttypedResponse = response.blob();\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttypedResponse = response.text();\r\n\t\t\t\t}\r\n\t\t\t\treturn typedResponse.then(data => {\r\n\t\t\t\t\tresponse_.data = data;\r\n\t\t\t\t\tif (response.ok) {\r\n\t\t\t\t\t\treturn Promise.resolve(response_);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn Promise.reject(response_);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t} catch(error) {\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\tconsole.warn('HttpService.http$', 'Cannot parse response');\r\n\t\t\t\t\treturn Promise.resolve(response_);\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn Promise.reject(this.getError(error, response_));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})).pipe(\r\n\t\t\tcatchError(error => {\r\n\t\t\t\treturn throwError(this.getError(error, response_));\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\t*/\r\n\r\n\tstatic get$(url, data, format) {\r\n\t\tconst query = this.query(data);\r\n\t\treturn this.http$('GET', `${url}${query}`, undefined, format);\r\n\t}\r\n\r\n\tstatic delete$(url) {\r\n\t\treturn this.http$('DELETE', url);\r\n\t}\r\n\r\n\tstatic post$(url, data) {\r\n\t\treturn this.http$('POST', url, data);\r\n\t}\r\n\r\n\tstatic put$(url, data) {\r\n\t\treturn this.http$('PUT', url, data);\r\n\t}\r\n\r\n\tstatic patch$(url, data) {\r\n\t\treturn this.http$('PATCH', url, data);\r\n\t}\r\n\r\n\tstatic query(data) {\r\n\t\treturn ''; // todo\r\n\t}\r\n\r\n\tstatic getError(object, response) {\r\n\t\tlet error = typeof object === 'object' ? object : {};\r\n\t\tif (!error.status) {\r\n\t\t\terror.status = response ? response.status : 0;\r\n\t\t}\r\n\t\tif (!error.statusCode) {\r\n\t\t\terror.statusCode = response ? response.status : 0;\r\n\t\t}\r\n\t\tif (!error.statusMessage) {\r\n\t\t\terror.statusMessage = response ? response.statusText : object;\r\n\t\t}\r\n\t\t// console.log('HttpService.getError', error, object);\r\n\t\treturn error;\r\n\t}\r\n\r\n}\r\n","\r\nexport const RoleType = {\r\n\tPublisher: 'publisher',\r\n\tAttendee: 'attendee',\r\n\tStreamer: 'streamer',\r\n\tViewer: 'viewer',\r\n\tSmartDevice: 'smart-device',\r\n\tSelfService: 'self-service',\r\n};\r\n\r\nexport class User {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n","import { BehaviorSubject, of } from 'rxjs';\r\nimport { catchError, map, switchMap, tap } from 'rxjs/operators';\r\nimport HttpService from '../http/http.service';\r\nimport { User } from './user';\r\n\r\nexport class UserService {\r\n\r\n\tstatic setUser(user) {\r\n\t\tthis.user$.next(user);\r\n\t}\r\n\r\n\tstatic me$() {\r\n\t\treturn HttpService.get$('/api/user/me').pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\t// console.log('UserService.me$.error', error);\r\n\t\t\t\tif (error.status === 404 || error.statusCode === 404) {\r\n\t\t\t\t\treturn of(null);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow (error);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tswitchMap(user => {\r\n\t\t\t\tthis.setUser(user);\r\n\t\t\t\treturn this.user$;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic login$(payload) {\r\n\t\treturn HttpService.post$('/api/user/login', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic logout$() {\r\n\t\treturn HttpService.get$('/api/user/logout').pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(null)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic guidedTour$(payload) {\r\n\t\treturn HttpService.post$('/api/user/guided-tour', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic selfServiceTour$(payload) {\r\n\t\treturn HttpService.post$('/api/user/self-service-tour', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic resolve$(payload, status) {\r\n\t\tif (status === 'login') {\r\n\t\t\treturn this.login$(payload);\r\n\t\t}\r\n\t\tif (status === 'guided-tour') {\r\n\t\t\treturn this.guidedTour$(payload);\r\n\t\t}\r\n\t\tif (status === 'self-service-tour') {\r\n\t\t\treturn this.selfServiceTour$(payload);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic log$(payload) {\r\n\t\treturn HttpService.post$('/api/user/log', payload);\r\n\t}\r\n\r\n\t/*\r\n\tstatic retrieve$(payload) {\r\n\t\treturn HttpService.post$('/api/user/retrievepassword', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic register$(payload) {\r\n\t\treturn HttpService.post$('/api/user/register', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic update(payload) {\r\n\t\treturn HttpService.post$('/api/user/updateprofile', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\t*/\r\n\r\n\tstatic mapUser(user) {\r\n\t\treturn new User(user);\r\n\t}\r\n\r\n}\r\n\r\nUserService.user$ = new BehaviorSubject(null);\r\n","import { Component } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { environment, STATIC } from '../environment';\r\nimport { fieldsToFormGroup, patchFields } from '../forms/controls.component';\r\nimport { UserService } from '../user/user.service';\r\n\r\nexport default class AccessComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.env = environment;\r\n\t\tthis.state = {\r\n\t\t\tstatus: 'access',\r\n\t\t};\r\n\t\t/*\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tconsole.log('AccessComponent.state', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tonSelfServiceTourRequest() {\r\n\t\tthis.initRequestForm();\r\n\t\tthis.state.status = 'self-service-tour';\r\n\t\tthis.pushChanges();\r\n\t\tif (STATIC && window.navigator.userAgent.indexOf('OculusBrowser') !== -1) {\r\n\t\t\tthis.test();\r\n\t\t\tthis.onSubmit();\r\n\t\t}\r\n\t}\r\n\r\n\tonGuidedTourRequest() {\r\n\t\tthis.initRequestForm();\r\n\t\tthis.state.status = 'guided-tour';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonGuidedTourAccess() {\r\n\t\tUserService.logout$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\twindow.location.href = environment.url.guidedTour;\r\n\t\t});\r\n\t}\r\n\r\n\tonLogin() {\r\n\t\tthis.initLoginForm();\r\n\t\tthis.state.status = 'login';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tinitRequestForm() {\r\n\t\tif (this.formSubscription) {\r\n\t\t\tthis.formSubscription.unsubscribe();\r\n\t\t}\r\n\r\n\t\tconst data = this.data = window.data || {\r\n\t\t\troles: [\r\n\t\t\t\t{ id: 1, name: 'Show room' },\r\n\t\t\t\t{ id: 2, name: 'Architetto' },\r\n\t\t\t\t{ id: 3, name: 'Interior designer' },\r\n\t\t\t\t{ id: 4, name: 'Privato' },\r\n\t\t\t\t{ id: 5, name: 'Altro' }\r\n\t\t\t],\r\n\t\t};\r\n\r\n\t\tconst fields = this.fields = window.fields || [\r\n\t\t\t{ type: 'text', name: 'firstName', label: 'access_first_name', required: true, test: 'Jhon' },\r\n\t\t\t{ type: 'text', name: 'lastName', label: 'access_last_name', required: true, test: 'Appleseed' },\r\n\t\t\t{ type: 'email', name: 'email', label: 'access_email', required: true, test: 'jhonappleseed@gmail.com' },\r\n\t\t\t{ type: 'custom-select', name: 'role', label: 'access_role', required: true, options: window.data.roles, test: window.data.roles[0].id },\r\n\t\t\t{ type: 'checkbox', name: 'privacy', label: 'access_privacy_disclaimer', required: true, test: true },\r\n\t\t];\r\n\r\n\t\tfields.push(\r\n\t\t\t{ type: 'hidden', name: 'checkField', value: '', test: '' },\r\n\t\t\t{ type: 'none', name: 'checkRequest', value: window.antiforgery || '', test: window.antiforgery || '' }\r\n\t\t);\r\n\r\n\t\tconst form = this.form = fieldsToFormGroup(fields);\r\n\t\t/*\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tfirstName: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tlastName: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\temail: new FormControl(null, [Validators.RequiredValidator(), Validators.EmailValidator()]),\r\n\t\t\trole: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tprivacy: new FormControl(null, Validators.RequiredTrueValidator()),\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: '',\r\n\t\t});\r\n\t\t*/\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\t/*\r\n\t\tconst options = data.roles.slice();\r\n\t\toptions.unshift({ id: null, name: LabelPipe.transform('select') });\r\n\t\tcontrols.role.options = options;\r\n\t\t*/\r\n\r\n\t\tthis.formSubscription = form.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\tinitLoginForm() {\r\n\t\tif (this.formSubscription) {\r\n\t\t\tthis.formSubscription.unsubscribe();\r\n\t\t}\r\n\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tusername: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tpassword: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: '',\r\n\t\t});\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\r\n\t\tthis.formSubscription = form.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\ttest() {\r\n\t\tif (this.state.status === 'login') {\r\n\t\t\tthis.form.patch({\r\n\t\t\t\tusername: 'publisher',\r\n\t\t\t\tpassword: 'publisher',\r\n\t\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\t\tcheckField: ''\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tpatchFields(this.fields, this.form);\r\n\t\t\t/*\r\n\t\t\tthis.form.patch({\r\n\t\t\t\tfirstName: 'Jhon',\r\n\t\t\t\tlastName: 'Appleseed',\r\n\t\t\t\temail: 'jhonappleseed@gmail.com',\r\n\t\t\t\trole: this.controls.role.options.find(x => x.id !== null).id,\r\n\t\t\t\tprivacy: true,\r\n\t\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\t\tcheckField: ''\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\treset() {\r\n\t\tthis.form.reset();\r\n\t}\r\n\r\n\tonBack() {\r\n\t\tthis.state.status = 'access';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst payload = this.form.value;\r\n\t\t\tconst status = this.state.status;\r\n\t\t\tUserService.resolve$(payload, status).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('AccessComponent.onSubmit', response);\r\n\t\t\t\tswitch (status) {\r\n\t\t\t\t\tcase 'guided-tour':\r\n\t\t\t\t\t\tthis.state.status = 'guided-tour-success';\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'self-service-tour':\r\n\t\t\t\t\t\twindow.location.href = environment.url.selfServiceTour;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'login':\r\n\t\t\t\t\t\twindow.location.href = environment.url.guidedTour;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('AccessComponent.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n}\r\n\r\nAccessComponent.meta = {\r\n\tselector: '[access-component]',\r\n};\r\n","import { ReplaySubject } from \"rxjs\";\r\n\r\nexport default class MessageService {\r\n\tstatic message$ = new ReplaySubject(1);\r\n\tstatic message(message) {\r\n\t\tthis.message$.next(message);\r\n\t}\r\n\r\n\tstatic in$ = new ReplaySubject(1);\r\n\tstatic in(message) {\r\n\t\tthis.in$.next(message);\r\n\t}\r\n\tstatic send = MessageService.in;\r\n\tstatic sendBack(message) {\r\n\t\tmessage = Object.assign({}, message, { remoteId: message.clientId });\r\n\t\t// console.log('MessageService.sendBack', message);\r\n\t\tthis.in$.next(message);\r\n\t}\r\n\r\n\tstatic out$ = new ReplaySubject(1);\r\n\tstatic out(message) {\r\n\t\tthis.out$.next(message);\r\n\t}\r\n}\r\n","import { BehaviorSubject } from \"rxjs\";\r\n\r\nexport default class StateService {\r\n\tstatic state$ = new BehaviorSubject({});\r\n\tstatic set state(state) {\r\n\t\tthis.state$.next(state);\r\n\t}\r\n\tstatic get state() {\r\n\t\treturn this.state$.getValue();\r\n\t}\r\n\tstatic patchState(state) {\r\n\t\tstate = Object.assign({}, this.state, state);\r\n\t\tthis.state = state;\r\n\t}\r\n}\r\n","export default class Emittable {\r\n\r\n\tconstructor() {\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\tonce(type, callback) {\r\n\t\tconst once = (data) => {\r\n\t\t\tcallback(data);\r\n\t\t\tthis.off(type, once);\r\n\t\t};\r\n\t\tthis.on(type, once);\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\thas(type) {\r\n\t\tconst callbacks = this.events[type];\r\n\t\treturn callbacks && callbacks.length;\r\n\t}\r\n\r\n}\r\n","export default class SessionStorageService {\r\n\r\n\tstatic delete(name) {\r\n\t\tif (this.isSessionStorageSupported()) {\r\n\t\t\twindow.sessionStorage.removeItem(name);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic exist(name) {\r\n\t\tif (this.isSessionStorageSupported()) {\r\n\t\t\treturn window.sessionStorage[name] !== undefined;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get(name) {\r\n\t\tlet value = null;\r\n\t\tif (this.isSessionStorageSupported() && window.sessionStorage[name] !== undefined) {\r\n\t\t\ttry {\r\n\t\t\t\tvalue = JSON.parse(window.sessionStorage[name]);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('SessionStorageService.get.error parsing', name, e);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn value;\r\n\t}\r\n\r\n\tstatic set(name, value) {\r\n\t\tif (this.isSessionStorageSupported()) {\r\n\t\t\ttry {\r\n\t\t\t\tconst cache = [];\r\n\t\t\t\tconst json = JSON.stringify(value, function(key, value) {\r\n\t\t\t\t\tif (typeof value === 'object' && value !== null) {\r\n\t\t\t\t\t\tif (cache.indexOf(value) !== -1) {\r\n\t\t\t\t\t\t\t// Circular reference found, discard key\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcache.push(value);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn value;\r\n\t\t\t\t});\r\n\t\t\t\twindow.sessionStorage.setItem(name, json);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('SessionStorageService.set.error serializing', name, value, e);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic isSessionStorageSupported() {\r\n\t\tif (this.supported) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tlet supported = false;\r\n\t\ttry {\r\n\t\t\tsupported = 'sessionStorage' in window && window.sessionStorage !== null;\r\n\t\t\tif (supported) {\r\n\t\t\t\twindow.sessionStorage.setItem('test', '1');\r\n\t\t\t\twindow.sessionStorage.removeItem('test');\r\n\t\t\t} else {\r\n\t\t\t\tsupported = false;\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tsupported = false;\r\n\t\t}\r\n\t\tthis.supported = supported;\r\n\t\treturn supported;\r\n\t}\r\n}\r\n","import { BehaviorSubject, combineLatest, interval, of } from 'rxjs';\r\nimport { distinctUntilChanged, filter, map, shareReplay, switchMap } from 'rxjs/operators';\r\nimport { RoleType } from '../user/user';\r\n\r\nconst MAX_VISIBLE_STREAMS = 8;\r\n\r\nexport const StreamServiceMode = {\r\n\tClient: 'client',\r\n\tEditor: 'editor',\r\n};\r\n\r\nexport default class StreamService {\r\n\r\n\tstatic mode = StreamServiceMode.Client;\r\n\r\n\tstatic editorStreams$ = new BehaviorSubject(null);\r\n\tstatic set editorStreams(editorStreams) {\r\n\t\tthis.editorStreams$.next(editorStreams);\r\n\t}\r\n\tstatic get editorStreams() {\r\n\t\treturn this.editorStreams$.getValue();\r\n\t}\r\n\r\n\tstatic editorScreens$ = new BehaviorSubject(null);\r\n\tstatic set editorScreens(editorScreens) {\r\n\t\tthis.editorScreens$.next(editorScreens);\r\n\t}\r\n\tstatic get editorScreens() {\r\n\t\treturn this.editorScreens$.getValue();\r\n\t}\r\n\r\n\tstatic local$ = new BehaviorSubject(null);\r\n\tstatic set local(local) {\r\n\t\tthis.local$.next(local);\r\n\t}\r\n\tstatic get local() {\r\n\t\treturn this.local$.getValue();\r\n\t}\r\n\r\n\tstatic screen$ = new BehaviorSubject(null);\r\n\tstatic set screen(screen) {\r\n\t\tthis.screen$.next(screen);\r\n\t}\r\n\tstatic get screen() {\r\n\t\treturn this.screen$.getValue();\r\n\t}\r\n\r\n\tstatic remotes$ = new BehaviorSubject([]);\r\n\tstatic set remotes(remotes) {\r\n\t\tthis.remotes$.next(remotes);\r\n\t}\r\n\tstatic get remotes() {\r\n\t\treturn this.remotes$.getValue();\r\n\t}\r\n\r\n\tstatic peers$ = new BehaviorSubject([]);\r\n\tstatic set peers(peers) {\r\n\t\tthis.peers$.next(peers);\r\n\t}\r\n\tstatic get peers() {\r\n\t\treturn this.peers$.getValue();\r\n\t}\r\n\r\n\tstatic orderedRemotes$() {\r\n\t\treturn combineLatest([StreamService.remotes$, interval(1000)]).pipe(\r\n\t\t\tmap(datas => {\r\n\t\t\t\tconst orderedRemotes = [];\r\n\t\t\t\tconst remotes = datas[0];\r\n\t\t\t\tremotes.forEach(remote => {\r\n\t\t\t\t\t// const audioLevel = remote.getAudioLevel();\r\n\t\t\t\t\t// console.log('audioLevel', audioLevel, remote);\r\n\t\t\t\t\tif (remote.clientInfo) {\r\n\t\t\t\t\t\tremote.clientInfo.audioLevel = remote.getAudioLevel();\r\n\t\t\t\t\t\tremote.clientInfo.peekAudioLevel = Math.max(remote.clientInfo.audioLevel, 0.2);\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tif (remote.clientInfo.screenUid !== remote.getId()) {\r\n\t\t\t\t\t\t\torderedRemotes.push(remote);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t}\r\n\t\t\t\t\torderedRemotes.push(remote);\r\n\t\t\t\t});\r\n\t\t\t\torderedRemotes.sort((a, b) => {\r\n\t\t\t\t\tif (a.clientInfo && b.clientInfo) {\r\n\t\t\t\t\t\tif (a.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\t\t\treturn -1;\r\n\t\t\t\t\t\t} else if (b.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\t\t\treturn 1;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t// sort on audioLevel or lastOrder\r\n\t\t\t\t\t\t\treturn b.clientInfo.peekAudioLevel - a.clientInfo.peekAudioLevel ||\r\n\t\t\t\t\t\t\t(a.clientInfo.order || 0) - (b.clientInfo.order || 0);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\torderedRemotes.forEach((remote, i) => {\r\n\t\t\t\t\tif (remote.clientInfo) {\r\n\t\t\t\t\t\tremote.clientInfo.order = i;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// !!! hard limit max visible stream\r\n\t\t\t\torderedRemotes.length = Math.min(orderedRemotes.length, MAX_VISIBLE_STREAMS);\r\n\t\t\t\treturn orderedRemotes;\r\n\t\t\t}),\r\n\t\t\tdistinctUntilChanged((a, b) => {\r\n\t\t\t\treturn a.map(remote => remote.clientInfo ? remote.clientInfo.uid : '').join('|') ===\r\n\t\t\t\tb.map(remote => remote.clientInfo ? remote.clientInfo.uid : '').join('|');\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic streams$ = combineLatest([StreamService.local$, StreamService.screen$, StreamService.remotes$, StreamService.getEditorStreams$(), StreamService.getEditorScreens$()]).pipe(\r\n\t\tmap(data => {\r\n\t\t\tconst local = data[0];\r\n\t\t\tconst screen = data[1];\r\n\t\t\tconst remotes = data[2];\r\n\t\t\tconst editorStreams = data[3];\r\n\t\t\tconst editorScreens = data[4];\r\n\t\t\tlet streams = remotes;\r\n\t\t\tif (local) { // my stream\r\n\t\t\t\tstreams = streams.slice();\r\n\t\t\t\tstreams.push(local);\r\n\t\t\t}\r\n\t\t\tif (screen) { // my screen\r\n\t\t\t\tstreams = streams.slice();\r\n\t\t\t\tstreams.push(screen);\r\n\t\t\t}\r\n\t\t\tif (editorStreams) { // editor streams\r\n\t\t\t\tstreams.push(...editorStreams);\r\n\t\t\t}\r\n\t\t\tif (editorScreens) { // editor screens\r\n\t\t\t\tstreams.push(...editorScreens);\r\n\t\t\t}\r\n\t\t\t// console.log('StreamService.streams$', streams, local, screen, remotes);\r\n\t\t\treturn streams;\r\n\t\t}),\r\n\t\tshareReplay(1),\r\n\t);\r\n\r\n\tstatic getEditorStreams$() {\r\n\t\treturn of(null).pipe(\r\n\t\t\tswitchMap(() => {\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia && this.mode === StreamServiceMode.Editor) {\r\n\t\t\t\t\tconst body = document.querySelector('body');\r\n\t\t\t\t\tconst media = document.createElement('div');\r\n\t\t\t\t\tconst video = document.createElement('video');\r\n\t\t\t\t\tmedia.setAttribute('id', 'stream-editor');\r\n\t\t\t\t\tmedia.setAttribute('style', 'position:absolute; top: 5000px; line-height: 0;');\r\n\t\t\t\t\tmedia.appendChild(video);\r\n\t\t\t\t\tbody.appendChild(media);\r\n\t\t\t\t\tnavigator.mediaDevices.getUserMedia({\r\n\t\t\t\t\t\tvideo: { width: 800, height: 450 },\r\n\t\t\t\t\t}).then((stream) => {\r\n\t\t\t\t\t\t// console.log(stream);\r\n\t\t\t\t\t\tif ('srcObject' in video) {\r\n\t\t\t\t\t\t\tvideo.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvideo.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\t\t\tconst fakePublisherStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Publisher,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeAttendeeStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Attendee,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeSmartDeviceStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.SmartDevice,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tthis.editorStreams$.next([fakePublisherStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeSmartDeviceStream]);\r\n\t\t\t\t\t\t\t// StreamService.editorStreams = [fakePublisherStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.play();\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\tconsole.log('EditorComponent.getUserMedia.error', error.name, error.message);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn this.editorStreams$;\r\n\t\t\t}),\r\n\t\t\tshareReplay(1),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getEditorScreens$() {\r\n\t\treturn of(null).pipe(\r\n\t\t\tswitchMap(() => {\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia && this.mode === StreamServiceMode.Editor) {\r\n\t\t\t\t\tconst body = document.querySelector('body');\r\n\t\t\t\t\tconst media = document.createElement('div');\r\n\t\t\t\t\tconst video = document.createElement('video');\r\n\t\t\t\t\tmedia.setAttribute('id', 'stream-editor-screen');\r\n\t\t\t\t\tmedia.setAttribute('style', 'position:absolute; top: 5000px; line-height: 0;');\r\n\t\t\t\t\tmedia.appendChild(video);\r\n\t\t\t\t\tbody.appendChild(media);\r\n\t\t\t\t\tnavigator.mediaDevices.getDisplayMedia({\r\n\t\t\t\t\t\tscreen: { width: 800, height: 450 },\r\n\t\t\t\t\t}).then((stream) => {\r\n\t\t\t\t\t\t// console.log(stream);\r\n\t\t\t\t\t\tif ('srcObject' in video) {\r\n\t\t\t\t\t\t\tvideo.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvideo.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\t\t\tconst fakePublisherScreen = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor-screen',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Publisher,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor-screen_',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeAttendeeScreen = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor-screen',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Attendee,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor-screen_',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tthis.editorScreens$.next([fakePublisherScreen, fakeAttendeeScreen]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.play();\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\tconsole.log('EditorComponent.getUserMedia.error', error.name, error.message);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn this.editorScreens$;\r\n\t\t\t}),\r\n\t\t\tshareReplay(1),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic get publisherStreamId() {\r\n\t\tconst streams = this.remotes.slice();\r\n\t\tconst local = this.local;\r\n\t\tif (local) {\r\n\t\t\tstreams.unshift(local);\r\n\t\t}\r\n\t\tconst publisherStream = streams.find(x => x.clientInfo && x.clientInfo.role === RoleType.Publisher);\r\n\t\tif (publisherStream) {\r\n\t\t\treturn publisherStream.getId();\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\tstatic getPublisherStreamId$() {\r\n\t\tconst publisherStreamId = this.publisherStreamId;\r\n\t\tif (publisherStreamId) {\r\n\t\t\treturn of(publisherStreamId);\r\n\t\t} else {\r\n\t\t\treturn this.streams$.pipe(\r\n\t\t\t\tmap(() => this.publisherStreamId),\r\n\t\t\t\tfilter(x => x),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getRemoteById(streamId) {\r\n\t\t// console.log('StreamService.getRemoteById', streamId);\r\n\t\tconst remotes = StreamService.remotes;\r\n\t\tconst remote = remotes.find(x => x.getId() === streamId);\r\n\t\tif (remote) {\r\n\t\t\treturn remote;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic remoteAdd(stream) {\r\n\t\tconst remotes = this.remotes.slice();\r\n\t\tremotes.push(stream);\r\n\t\tthis.remotes = remotes;\r\n\t}\r\n\r\n\tstatic remoteRemove(streamId) {\r\n\t\tconst remotes = this.remotes.slice();\r\n\t\tconst remote = remotes.find(x => x.getId() === streamId);\r\n\t\t// console.log('StreamService.remoteRemove', streamId, remote);\r\n\t\tif (remote) {\r\n\t\t\tif (remote.isPlaying()) {\r\n\t\t\t\tremote.stop();\r\n\t\t\t}\r\n\t\t\tremotes.splice(remotes.indexOf(remote), 1);\r\n\t\t\tthis.remotes = remotes;\r\n\t\t}\r\n\t\treturn remote;\r\n\t}\r\n\r\n\tstatic remoteSetClientInfo(remoteId, clientInfo) {\r\n\t\tconst remotes = this.remotes;\r\n\t\tconst remote = remotes.find(x => x.getId() === remoteId);\r\n\t\tif (remote) {\r\n\t\t\tremote.clientInfo = clientInfo;\r\n\t\t}\r\n\t\tthis.remotes = remotes;\r\n\t}\r\n\r\n}\r\n","import { environment } from '../environment';\r\nimport { RoleType } from '../user/user';\r\n\r\nexport const USE_AUTODETECT = false;\r\nexport const USE_VOLUME_INDICATOR = false;\r\nexport const USE_RTM = true;\r\n\r\nexport const StreamQualities = [{\r\n\t// id: 1,\r\n\t// name: '4K 2160p 3840x2160',\r\n\tprofile: '4K',\r\n\tresolution: {\r\n\t\twidth: 3840,\r\n\t\theight: 2160\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 8910,\r\n\t\tmax: 13500\r\n\t}\r\n}, {\r\n\t// id: 2,\r\n\t// name: 'HD 1440p 2560×1440',\r\n\tprofile: '1440p',\r\n\tresolution: {\r\n\t\twidth: 2560,\r\n\t\theight: 1440\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 4850,\r\n\t\tmax: 7350\r\n\t}\r\n}, {\r\n\t// id: 3,\r\n\t// name: 'HD 1080p 1920x1080',\r\n\tprofile: '1080p',\r\n\tresolution: {\r\n\t\twidth: 1920,\r\n\t\theight: 1080\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 2080,\r\n\t\tmax: 4780\r\n\t}\r\n}, {\r\n\t// id: 4,\r\n\t// name: 'LOW 720p 1280x720',\r\n\tprofile: '720p_3',\r\n\tresolution: {\r\n\t\twidth: 1280,\r\n\t\theight: 720\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 1130,\r\n\t\tmax: 1710\r\n\t}\r\n}, {\r\n\t// id: 5,\r\n\t// name: 'LOWEST 240p 320x240',\r\n\tprofile: '240p_1',\r\n\tresolution: {\r\n\t\twidth: 320,\r\n\t\theight: 240\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 15\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 140,\r\n\t\tmax: 200\r\n\t}\r\n}];\r\n\r\nexport function getStreamQuality(state) {\r\n\tconst lowestQuality = StreamQualities[StreamQualities.length - 1];\r\n\tconst highestQuality = environment.flags.maxQuality ? StreamQualities[0] : StreamQualities[StreamQualities.length - 2];\r\n\treturn (state.role === RoleType.Publisher || state.role === RoleType.SmartDevice) ? highestQuality : lowestQuality;\r\n}\r\n\r\nexport const AgoraStatus = {\r\n\tIdle: 'idle',\r\n\tChecklist: 'checklist',\r\n\tLink: 'link',\r\n\tLogin: 'login',\r\n\tName: 'name',\r\n\tDevice: 'device',\r\n\tShouldConnect: 'should-connect',\r\n\tConnecting: 'connecting',\r\n\tConnected: 'connected',\r\n\tDisconnected: 'disconnected',\r\n};\r\n\r\nexport const MessageType = {\r\n\tAgoraEvent: 'agoraEvent',\r\n\tPing: 'ping',\r\n\tRequestControl: 'requestControl',\r\n\tRequestControlAccepted: 'requestControlAccepted',\r\n\tRequestControlRejected: 'requestControlRejected',\r\n\tRequestControlDismiss: 'requestControlDismiss',\r\n\tRequestControlDismissed: 'requestControlDismissed',\r\n\tRequestPeerInfo: 'requestPeerInfo',\r\n\tRequestPeerInfoResult: 'requestPeerInfoResult',\r\n\tRequestInfo: 'requestInfo',\r\n\tRequestInfoResult: 'requestInfoResult',\r\n\tRequestInfoDismiss: 'requestInfoDismiss',\r\n\tRequestInfoDismissed: 'requestInfoDismissed',\r\n\tRequestInfoRejected: 'requestInfoRejected',\r\n\tSlideChange: 'slideChange',\r\n\tControlInfo: 'controlInfo',\r\n\tAddLike: 'addLike',\r\n\tShowPanel: 'showPanel',\r\n\tPlayMedia: 'playMedia',\r\n\tNavToView: 'navToView',\r\n\tNavToGrid: 'navToGrid',\r\n\tVRStarted: 'vrStarted',\r\n\tVREnded: 'vrEnded',\r\n\tVRState: 'vrState',\r\n\tMenuToggle: 'menuToggle',\r\n\tChatMessage: 'chatMessage',\r\n\tChatTypingBegin: 'chatTypingBegin',\r\n\tChatTypingEnd: 'chatTypingEnd',\r\n};\r\nexport class AgoraEvent {\r\n\tconstructor(options) {\r\n\t\tObject.assign(this, options);\r\n\t}\r\n}\r\nexport class AgoraPeerEvent extends AgoraEvent { }\r\nexport class AgoraRemoteEvent extends AgoraEvent { }\r\nexport class AgoraMuteVideoEvent extends AgoraEvent { }\r\nexport class AgoraUnmuteVideoEvent extends AgoraEvent { }\r\nexport class AgoraMuteAudioEvent extends AgoraEvent { }\r\nexport class AgoraUnmuteAudioEvent extends AgoraEvent { }\r\nexport class AgoraVolumeLevelsEvent extends AgoraEvent { }\r\n","/* global AgoraRTM */\r\n// import AgoraRTM from 'agora-rtm-sdk';\r\nimport { from, interval, of } from 'rxjs';\r\nimport { distinctUntilChanged, map, switchMap } from 'rxjs/operators';\r\nimport Emittable from '../emittable/emittable';\r\nimport { DEBUG, environment } from '../environment';\r\nimport HttpService from '../http/http.service';\r\nimport SessionStorageService from '../local-storage/session-storage.service';\r\n// import LocationService from '../location/location.service';\r\nimport MessageService from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport StreamService from '../stream/stream.service';\r\nimport { RoleType } from '../user/user';\r\nimport { AgoraMuteAudioEvent, AgoraMuteVideoEvent, AgoraPeerEvent, AgoraRemoteEvent, AgoraStatus, AgoraUnmuteAudioEvent, AgoraUnmuteVideoEvent, AgoraVolumeLevelsEvent, getStreamQuality, MessageType, USE_AUTODETECT, USE_RTM, USE_VOLUME_INDICATOR } from './agora.types';\r\n\r\nexport default class AgoraService extends Emittable {\r\n\r\n\tstatic getSingleton(defaultDevices) {\r\n\t\tif (DEBUG) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (!this.AGORA) {\r\n\t\t\tthis.AGORA = new AgoraService(defaultDevices);\r\n\t\t}\r\n\t\treturn this.AGORA;\r\n\t}\r\n\r\n\tconstructor(defaultDevices) {\r\n\t\tif (AgoraService.AGORA) {\r\n\t\t\tthrow ('AgoraService is a singleton');\r\n\t\t}\r\n\t\tsuper();\r\n\t\tthis.onStreamPublished = this.onStreamPublished.bind(this);\r\n\t\tthis.onStreamUnpublished = this.onStreamUnpublished.bind(this);\r\n\t\tthis.onStreamAdded = this.onStreamAdded.bind(this);\r\n\t\tthis.onStreamRemoved = this.onStreamRemoved.bind(this);\r\n\t\tthis.onStreamSubscribed = this.onStreamSubscribed.bind(this);\r\n\t\tthis.onMuteVideo = this.onMuteVideo.bind(this);\r\n\t\tthis.onUnmuteVideo = this.onUnmuteVideo.bind(this);\r\n\t\tthis.onMuteAudio = this.onMuteAudio.bind(this);\r\n\t\tthis.onUnmuteAudio = this.onUnmuteAudio.bind(this);\r\n\t\tthis.onVolumeIndicator = this.onVolumeIndicator.bind(this);\r\n\t\tthis.onPeerConnect = this.onPeerConnect.bind(this);\r\n\t\tthis.onPeerLeaved = this.onPeerLeaved.bind(this);\r\n\t\tthis.onConnectionStateChange = this.onConnectionStateChange.bind(this);\r\n\t\tthis.onTokenPrivilegeWillExpire = this.onTokenPrivilegeWillExpire.bind(this);\r\n\t\tthis.onTokenPrivilegeDidExpire = this.onTokenPrivilegeDidExpire.bind(this);\r\n\t\tthis.onMessage = this.onMessage.bind(this);\r\n\t\tconst state = StateService.state;\r\n\t\tStateService.patchState({\r\n\t\t\tdevices: (state.role !== RoleType.Attendee && defaultDevices) ? defaultDevices : { videos: [], audios: [] },\r\n\t\t\tquality: getStreamQuality(state),\r\n\t\t\tmembersCount: 0,\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tgetInitialStatus(role, link, name) {\r\n\t\tif (!link) {\r\n\t\t\treturn AgoraStatus.Link;\r\n\t\t}\r\n\t\tif (!name) {\r\n\t\t\treturn AgoraStatus.Name;\r\n\t\t}\r\n\t\tif (role !== RoleType.Viewer && role !== RoleType.SmartDevice) {\r\n\t\t\treturn AgoraStatus.Device;\r\n\t\t}\r\n\t\treturn AgoraStatus.ShouldConnect;\r\n\t}\r\n\t*/\r\n\r\n\taddStreamDevice(src) {\r\n\t\tthis.removeStreamDevice();\r\n\t\tconst video = {\r\n\t\t\tdeviceId: 'video-stream',\r\n\t\t\tlabel: 'videostream',\r\n\t\t\tkind: 'videostream',\r\n\t\t\tsrc: src,\r\n\t\t};\r\n\t\tconst audio = {\r\n\t\t\tdeviceId: 'audio-stream',\r\n\t\t\tlabel: 'videostream',\r\n\t\t\tkind: 'videostream',\r\n\t\t\tsrc: src,\r\n\t\t};\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tdevices.videos.push(video);\r\n\t\tdevices.audios.push(audio);\r\n\t\tStateService.patchState({ devices: devices });\r\n\t}\r\n\r\n\tremoveStreamDevice() {\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tdevices.videos = devices.videos.filter(x => x.kind !== 'videostream');\r\n\t\tdevices.audios = devices.audios.filter(x => x.kind !== 'videostream');\r\n\t\tStateService.patchState({ devices: devices });\r\n\t}\r\n\r\n\tdevices$() {\r\n\t\tconst inputs = StateService.state.devices;\r\n\t\tconst defaultVideos = this.defaultVideos = (this.defaultVideos || inputs.videos.slice());\r\n\t\tconst defaultAudios = this.defaultAudios = (this.defaultAudios || inputs.videos.slice());\r\n\t\tinputs.videos = defaultVideos.slice();\r\n\t\tinputs.audios = defaultAudios.slice();\r\n\t\treturn from(new Promise((resolve, reject) => {\r\n\t\t\tconst getDevices = () => {\r\n\t\t\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\t\t\t// console.log('AgoraRTC.getDevices', devices);\r\n\t\t\t\t\ttempStream.close();\r\n\t\t\t\t\tfor (let i = 0; i < devices.length; i++) {\r\n\t\t\t\t\t\tconst device = devices[i];\r\n\t\t\t\t\t\t// console.log('device', device.deviceId);\r\n\t\t\t\t\t\tif (device.kind === 'videoinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.videos.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'camera-' + inputs.videos.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (device.kind === 'audioinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.audios.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'microphone-' + inputs.audios.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (inputs.videos.length > 0 || inputs.audios.length > 0) {\r\n\t\t\t\t\t\tresolve(inputs);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treject(inputs);\r\n\t\t\t\t\t}\r\n\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t\t/*\r\n\t\t\t\tAgoraRTC.getDevices((devices) => {\r\n\t\t\t\t\t// console.log('AgoraRTC.getDevices', devices);\r\n\t\t\t\t\ttempStream.close();\r\n\t\t\t\t\tfor (let i = 0; i < devices.length; i++) {\r\n\t\t\t\t\t\tconst device = devices[i];\r\n\t\t\t\t\t\t// console.log('device', device.deviceId);\r\n\t\t\t\t\t\tif (device.kind === 'videoinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.videos.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'camera-' + inputs.videos.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (device.kind === 'audioinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.audios.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'microphone-' + inputs.audios.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (inputs.videos.length > 0 || inputs.audios.length > 0) {\r\n\t\t\t\t\t\tresolve(inputs);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treject(inputs);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t*/\r\n\t\t\t};\r\n\t\t\tconst tempStream = AgoraRTC.createStream({ audio: true, video: true });\r\n\t\t\ttempStream.init(() => {\r\n\t\t\t\tgetDevices();\r\n\t\t\t}, () => {\r\n\t\t\t\tgetDevices();\r\n\t\t\t});\r\n\t\t}));\r\n\t}\r\n\r\n\tconnect$(preferences) {\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tif (preferences) {\r\n\t\t\tdevices.video = preferences.video;\r\n\t\t\tdevices.audio = preferences.audio;\r\n\t\t}\r\n\t\t// console.log('AgoraService.connect$', preferences, devices);\r\n\t\tif (!StateService.state.connecting) {\r\n\t\t\tStateService.patchState({ status: AgoraStatus.Connecting, connecting: true, devices });\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.createClient(() => {\r\n\t\t\t\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\t\t// console.log('AgoraService.rtcToken$', token);\r\n\t\t\t\t\t\tthis.join(token.token, channelNameLink);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}, 250);\r\n\t\t}\r\n\t\treturn StateService.state$;\r\n\t}\r\n\r\n\tmembersCount$(channelId) {\r\n\t\tconst messageClient = this.messageClient;\r\n\t\treturn interval(2000).pipe(\r\n\t\t\tswitchMap(() => from(messageClient.getChannelMemberCount([channelId]))),\r\n\t\t\tmap(counters => counters[channelId]),\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t);\r\n\t}\r\n\r\n\tobserveMemberCount() {\r\n\t\tthis.unobserveMemberCount();\r\n\t\tthis.membersCountSubscription = this.membersCount$(StateService.state.channelNameLink).subscribe(\r\n\t\t\tmembersCount => {\r\n\t\t\t\tStateService.patchState({ membersCount: membersCount });\r\n\t\t\t}\r\n\t\t);\r\n\t}\r\n\r\n\tunobserveMemberCount() {\r\n\t\tif (this.membersCountSubscription) {\r\n\t\t\tthis.membersCountSubscription.unsubscribe();\r\n\t\t\tthis.membersCountSubscription = null;\r\n\t\t\tStateService.patchState({ membersCount: 0 });\r\n\t\t}\r\n\t}\r\n\r\n\tcreateClient(next) {\r\n\t\tif (this.client) {\r\n\t\t\tnext();\r\n\t\t}\r\n\t\t// console.log('agora rtc sdk version: ' + AgoraRTC.VERSION + ' compatible: ' + AgoraRTC.checkSystemRequirements());\r\n\t\t// AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.ERROR);\r\n\t\tAgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.NONE);\r\n\t\tconst client = this.client = AgoraRTC.createClient({ mode: 'live', codec: 'h264' }); // rtc\r\n\t\tconst clientInit = () => {\r\n\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\tclient.startProxyServer(3);\r\n\t\t\t\tconsole.log('AgoraService.client.startProxyServer');\r\n\t\t\t}\r\n\t\t\tclient.init(environment.appKey, () => {\r\n\t\t\t\t// console.log('AgoraRTC client initialized');\r\n\t\t\t\tnext();\r\n\t\t\t}, (error) => {\r\n\t\t\t\t// console.log('AgoraRTC client init failed', error);\r\n\t\t\t\tthis.client = null;\r\n\t\t\t});\r\n\t\t}\r\n\t\tif (StateService.state.role === RoleType.Viewer) {\r\n\t\t\tclient.setClientRole('audience', function(error) {\r\n\t\t\t\tif (!error) {\r\n\t\t\t\t\tclientInit();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tclientInit();\r\n\t\t}\r\n\t\tclient.on('error', this.onError);\r\n\t\tclient.on('stream-published', this.onStreamPublished);\r\n\t\tclient.on('stream-unpublished', this.onStreamUnpublished);\r\n\t\t//subscribe remote stream\r\n\t\tclient.on('stream-added', this.onStreamAdded);\r\n\t\tclient.on('stream-removed', this.onStreamRemoved);\r\n\t\tclient.on('stream-subscribed', this.onStreamSubscribed);\r\n\t\tclient.on('mute-video', this.onMuteVideo);\r\n\t\tclient.on('unmute-video', this.onUnmuteVideo);\r\n\t\tclient.on('mute-audio', this.onMuteAudio);\r\n\t\tclient.on('unmute-audio', this.onUnmuteAudio);\r\n\t\tif (USE_VOLUME_INDICATOR) {\r\n\t\t\tclient.enableAudioVolumeIndicator(); // Triggers the \"volume-indicator\" callback event every two seconds.\r\n\t\t\tclient.on(\"volume-indicator\", this.onVolumeIndicator);\r\n\t\t}\r\n\t\tclient.on('peer-online', this.onPeerConnect);\r\n\t\t// Occurs when the peer user leaves the channel; for example, the peer user calls Client.leave.\r\n\t\tclient.on('peer-leave', this.onPeerLeaved);\r\n\t\t// client.on('connection-state-change', this.onConnectionStateChange);\r\n\t\tclient.on('onTokenPrivilegeWillExpire', this.onTokenPrivilegeWillExpire);\r\n\t\tclient.on('onTokenPrivilegeDidExpire', this.onTokenPrivilegeDidExpire);\r\n\t\t// console.log('agora rtm sdk version: ' + AgoraRTM.VERSION + ' compatible');\r\n\t\tif (USE_RTM) {\r\n\t\t\t/*\r\n\t\t\tAgoraRTM.LOG_FILTER_OFF\r\n\t\t\tAgoraRTM.LOG_FILTER_ERROR\r\n\t\t\tAgoraRTM.LOG_FILTER_INFO (Default)\r\n\t\t\tAgoraRTM.LOG_FILTER_WARNING\r\n\t\t\t*/\r\n\t\t\tconst messageClient = this.messageClient = AgoraRTM.createInstance(environment.appKey, { logFilter: AgoraRTM.LOG_FILTER_OFF }); // LOG_FILTER_DEBUG\r\n\t\t\tmessageClient.setParameters({ logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\t// messageClient.on('ConnectionStateChanged', console.warn);\r\n\t\t\t// messageClient.on('MessageFromPeer', console.log);\r\n\t\t}\r\n\t}\r\n\r\n\tgetChannelNameLink() {\r\n\t\tlet link = StateService.state.link || '';\r\n\t\tconst match = link.match(/(\\d{9})-(\\d{4})-(\\d{13})/);\r\n\t\tif (match) {\r\n\t\t\tlink = `${match[1]}-${match[3]}`;\r\n\t\t}\r\n\t\tconst channelName = StateService.state.channelName;\r\n\t\tconst channelNameLink = `${channelName}-${link}`;\r\n\t\t// console.log('AgoraService.getChannelNameLink', channelNameLink);\r\n\t\treturn channelNameLink;\r\n\t}\r\n\r\n\tstatic getUniqueUserId() {\r\n\t\t// max safe integer 9007199254740991 length 16\r\n\t\t// max allowed integer 4294967296 2^32\r\n\t\tconst m = 9007199254740991;\r\n\t\tconst mult = 10000000000000;\r\n\t\tconst a = (1 + Math.floor(Math.random() * 8)) * 100;\r\n\t\tconst b = (1 + Math.floor(Math.random() * 8)) * 10;\r\n\t\tconst c = (1 + Math.floor(Math.random() * 8)) * 1;\r\n\t\tconst combo = (a + b + c);\r\n\t\tconst date = Date.now();\r\n\t\tconst uid = combo * mult + date;\r\n\t\t// console.log(combo);\r\n\t\t// console.log(date);\r\n\t\t// console.log(m);\r\n\t\t// console.log('AgoraService.getUniqueUserId', uid);\r\n\t\treturn uid.toString();\r\n\t}\r\n\r\n\tjoin(token, channelNameLink) {\r\n\t\tthis.channel = null;\r\n\t\tconst client = this.client;\r\n\t\tconst clientId = SessionStorageService.get('bHereClientId') || AgoraService.getUniqueUserId();\r\n\t\t// console.log('AgoraService.join', { token, channelNameLink, clientId });\r\n\t\tclient.join(token, channelNameLink, clientId, (uid) => {\r\n\t\t\t// console.log('AgoraService.join', uid);\r\n\t\t\tStateService.patchState({ status: AgoraStatus.Connected, channelNameLink, connected: true, uid: uid });\r\n\t\t\tSessionStorageService.set('bHereClientId', uid);\r\n\t\t\tif (USE_RTM) {\r\n\t\t\t\tAgoraService.rtmToken$(uid).subscribe(token => {\r\n\t\t\t\t\t// console.log('AgoraService.rtmToken$', token);\r\n\t\t\t\t\tthis.joinMessageChannel(token.token, uid).then((success) => {\r\n\t\t\t\t\t\t// console.log('joinMessageChannel.success', success);\r\n\t\t\t\t\t\tif (StateService.state.role !== RoleType.Viewer) {\r\n\t\t\t\t\t\t\tthis.autoDetectDevice().then(devices => {\r\n\t\t\t\t\t\t\t\tthis.createMediaStream(uid, devices.video, devices.audio);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.observeMemberCount();\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\tconsole.log('joinMessageChannel.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tif (StateService.state.role !== RoleType.Viewer) {\r\n\t\t\t\t\tthis.autoDetectDevice().then(devices => {\r\n\t\t\t\t\t\tthis.createMediaStream(uid, devices.video, devices.audio);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.join.error', error);\r\n\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\tthis.join(token.token, channelNameLink);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\t// https://console.agora.io/invite?sign=YXBwSWQlM0RhYjQyODlhNDZjZDM0ZGE2YTYxZmQ4ZDY2Nzc0YjY1ZiUyNm5hbWUlM0RaYW1wZXR0aSUyNnRpbWVzdGFtcCUzRDE1ODY5NjM0NDU=// join link expire in 30 minutes\r\n\t}\r\n\r\n\tjoinMessageChannel(token, uid) {\r\n\t\tlet channel;\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst messageClient = this.messageClient;\r\n\t\t\tmessageClient.login({ token: token, uid: uid.toString() }).then(() => {\r\n\t\t\t\t// console.log('AgoraService.messageClient.login.success');\r\n\t\t\t\tchannel = messageClient.createChannel(StateService.state.channelNameLink);\r\n\t\t\t\treturn channel.join();\r\n\t\t\t}).then(() => {\r\n\t\t\t\tthis.channel = channel;\r\n\t\t\t\tchannel.on('ChannelMessage', this.onMessage);\r\n\t\t\t\tthis.emit('channel', channel);\r\n\t\t\t\t// console.log('AgoraService.joinMessageChannel.success');\r\n\t\t\t\tresolve(uid);\r\n\t\t\t}).catch(reject);\r\n\t\t});\r\n\t}\r\n\r\n\tdetectDevices(next) {\r\n\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\tconst videos = [];\r\n\t\t\tconst audios = [];\r\n\t\t\tfor (let i = 0; i < devices.length; i++) {\r\n\t\t\t\tconst device = devices[i];\r\n\t\t\t\tif ('videoinput' == device.kind) {\r\n\t\t\t\t\tvideos.push({\r\n\t\t\t\t\t\tlabel: device.label || 'camera-' + videos.length,\r\n\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\tif ('audioinput' == device.kind) {\r\n\t\t\t\t\taudios.push({\r\n\t\t\t\t\t\tlabel: device.label || 'microphone-' + videos.length,\r\n\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tnext({ videos: videos, audios: audios });\r\n\t\t}).catch((error) => {\r\n\t\t\tconsole.log('AgoraService.detectDevices', error);\r\n\t\t});\r\n\t}\r\n\r\n\tgetVideoOptions(options, video) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (video) {\r\n\t\t\t\tif (video.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + video.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\tvar hls = new Hls();\r\n\t\t\t\t\thls.attachMedia(element);\r\n\t\t\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\t\t\thls.loadSource(video.src);\r\n\t\t\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t\t\t\t// console.log('AgoraService.getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\tconsole.log('AgoraService.getVideoOptions.error', error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (video.kind === 'videoplayer' || video.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + video.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// element.oncanplay = () => {\r\n\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t// console.log('getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t// };\r\n\t\t\t\t\t/*\r\n\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t\t// console.log('getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t// console.log('AgoraService.getVideoOptions.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t*/\r\n\t\t\t\t} else {\r\n\t\t\t\t\toptions.cameraId = video.deviceId;\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tresolve(options);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tgetAudioOptions(options, audio) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (audio) {\r\n\t\t\t\tif (audio.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + audio.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// !!! try hls.service;\r\n\t\t\t\t\tvar hls = new Hls();\r\n\t\t\t\t\thls.attachMedia(element);\r\n\t\t\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\t\t\thls.loadSource(audio.src);\r\n\t\t\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\t\t\thls.loadLevel = data.levels.length - 1;\r\n\t\t\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t\t\t\t// console.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\tconsole.log('AgoraService.getAudioOptions.error', error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (audio.kind === 'videoplayer' || audio.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + audio.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// element.oncanplay = () => {\r\n\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t// console.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t// };\r\n\t\t\t\t\t/*\r\n\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t\t// console.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t// console.log('AgoraService.getAudioOptions.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t*/\r\n\t\t\t\t} else {\r\n\t\t\t\t\toptions.microphoneId = audio.deviceId;\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tresolve(options);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tautoDetectDevice() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst state = StateService.state;\r\n\t\t\tif (state.role === RoleType.SmartDevice || USE_AUTODETECT) {\r\n\t\t\t\tAgoraService.getDevices().then(inputDevices => {\r\n\t\t\t\t\tconst devices = { videos: [], audios: [], video: null, audio: null };\r\n\t\t\t\t\tinputDevices.forEach(x => {\r\n\t\t\t\t\t\tif (x.kind === 'videoinput') {\r\n\t\t\t\t\t\t\tdevices.videos.push(x);\r\n\t\t\t\t\t\t} else if (x.kind === 'audioinput') {\r\n\t\t\t\t\t\t\tdevices.audios.push(x);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tconsole.log(devices)\r\n\t\t\t\t\tdevices.video = devices.videos[0] || null;\r\n\t\t\t\t\tdevices.audio = devices.audios[0] || null;\r\n\t\t\t\t\tStateService.patchState({ devices });\r\n\t\t\t\t\tresolve(devices);\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve(state.devices);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcreateMediaStream(uid, video, audio) {\r\n\t\t// this.releaseStream('_mediaVideoStream')\r\n\t\tconst options = {\r\n\t\t\tstreamID: uid,\r\n\t\t\tvideo: Boolean(video),\r\n\t\t\taudio: Boolean(audio),\r\n\t\t\tscreen: false,\r\n\t\t};\r\n\t\tPromise.all([\r\n\t\t\tthis.getVideoOptions(options, video),\r\n\t\t\tthis.getAudioOptions(options, audio)\r\n\t\t]).then(success => {\r\n\t\t\tconst quality = Object.assign({}, StateService.state.quality);\r\n\t\t\tthis.createLocalStreamWithOptions(options, quality);\r\n\t\t});\r\n\t}\r\n\r\n\tcreateLocalStreamWithOptions(options, quality) {\r\n\t\t/*\r\n\t\tconst getUserMedia = navigator.mediaDevices.getUserMedia;\r\n\t\tnavigator.mediaDevices.getUserMedia = function(options) {\r\n\t\t\tif (options.video) {\r\n\t\t\t\toptions.video.width = { ideal: 4096 };\r\n\t\t\t\toptions.video.height = { ideal: 2160 };\r\n\t\t\t\tconsole.log('getUserMedia', options.video.width.ideal, options.video.height.ideal);\r\n\t\t\t}\r\n\t\t\tconsole.log('getUserMedia', options);\r\n\t\t\treturn getUserMedia.call(navigator.mediaDevices, options);\r\n\t\t}\r\n\t\t*/\r\n\t\tconst local = AgoraRTC.createStream(options);\r\n\t\t/*\r\n\t\t// force video quality\r\n\t\tquality = {\r\n\t\t\tresolution: {\r\n\t\t\t\twidth: 1920,\r\n\t\t\t\theight: 1080\r\n\t\t\t},\r\n\t\t\tframeRate: {\r\n\t\t\t\tmin: 30,\r\n\t\t\t\tmax: 30\r\n\t\t\t},\r\n\t\t\tbitrate: {\r\n\t\t\t\tmin: 2000,\r\n\t\t\t\tmax: 4000\r\n\t\t\t}\r\n\t\t};\r\n\t\t*/\r\n\t\tif (quality) {\r\n\t\t\tlocal.setVideoProfile(quality.profile);\r\n\t\t\tlocal.setVideoEncoderConfiguration(quality);\r\n\t\t}\r\n\t\t// console.log('local', local.attributes);\r\n\t\tlocal.init(() => {\r\n\t\t\tStreamService.local = local;\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.publishLocalStream();\r\n\t\t\t}, 1);\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.initLocalStream.init.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tinitLocalStream() {\r\n\t\tconst local = StreamService.local;\r\n\t\tlocal.init(() => {\r\n\t\t\tthis.publishLocalStream();\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.initLocalStream.init.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tcreateMediaVideoStream(video, callback) {\r\n\t\tconst videoStream = video.captureStream(60);\r\n\t\tconst stream = AgoraRTC.createStream({\r\n\t\t\taudio: true,\r\n\t\t\tvideo: true,\r\n\t\t\tvideoSource: videoStream.getVideoTracks()[0],\r\n\t\t\taudioSource: videoStream.getAudioTracks()[0],\r\n\t\t});\r\n\t\tstream.init(() => {\r\n\t\t\tcallback(stream.getVideoTrack(), stream.getAudioTrack());\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\tpublishLocalStream() {\r\n\t\tconst client = this.client;\r\n\t\tconst local = StreamService.local;\r\n\t\t// publish local stream\r\n\t\tclient.publish(local, (error) => {\r\n\t\t\tconsole.log('AgoraService.publishLocalStream.error', local.getId(), error);\r\n\t\t});\r\n\t\tlocal.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.local = local;\r\n\t}\r\n\r\n\tunpublishLocalStream() {\r\n\t\tconst client = this.client;\r\n\t\tconst local = StreamService.local;\r\n\t\tif (local) {\r\n\t\t\tclient.unpublish(local, (error) => {\r\n\t\t\t\tconsole.log('AgoraService.unpublishLocalStream.error', local.getId(), error);\r\n\t\t\t});\r\n\t\t}\r\n\t\tStreamService.local = null;\r\n\t}\r\n\r\n\tleaveChannel() {\r\n\t\tStateService.patchState({ connecting: false });\r\n\t\tthis.unpublishLocalStream();\r\n\t\tthis.unpublishScreenStream();\r\n\t\tStreamService.remotes = [];\r\n\t\tStreamService.peers = [];\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.leaveMessageChannel().then(() => {\r\n\t\t\t\treturn Promise.all([this.leaveClient(), this.leaveScreenClient()]);\r\n\t\t\t}, reject);\r\n\t\t});\r\n\t}\r\n\r\n\tleaveClient() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst client = this.client;\r\n\t\t\tif (client) {\r\n\t\t\t\tclient.leave(() => {\r\n\t\t\t\t\tthis.client = null;\r\n\t\t\t\t\t// console.log('Leave channel successfully');\r\n\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\tclient.stopProxyServer();\r\n\t\t\t\t\t\tconsole.log('AgoraService.client.stopProxyServer');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tconsole.log('AgoraService.leaveClient.error', error);\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tleaveMessageChannel() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (USE_RTM) {\r\n\t\t\t\tthis.unobserveMemberCount();\r\n\t\t\t\tconst channel = this.channel;\r\n\t\t\t\tconst messageClient = this.messageClient;\r\n\t\t\t\tchannel.leave().then(() => {\r\n\t\t\t\t\tthis.channel = null;\r\n\t\t\t\t\tmessageClient.logout().then(() => {\r\n\t\t\t\t\t\tthis.messageClient = null;\r\n\t\t\t\t\t\tresolve();\r\n\t\t\t\t\t}, reject);\r\n\t\t\t\t}, reject)\r\n\t\t\t} else {\r\n\t\t\t\treturn resolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tconst local = StreamService.local;\r\n\t\t// console.log('toggleCamera', local);\r\n\t\tif (local && local.video) {\r\n\t\t\tif (local.userMuteVideo) {\r\n\t\t\t\tlocal.unmuteVideo();\r\n\t\t\t\tStateService.patchState({ cameraMuted: false });\r\n\t\t\t\tthis.broadcastEvent(new AgoraUnmuteVideoEvent({ streamId: local.getId() }));\r\n\t\t\t} else {\r\n\t\t\t\tlocal.muteVideo();\r\n\t\t\t\tStateService.patchState({ cameraMuted: true });\r\n\t\t\t\tthis.broadcastEvent(new AgoraMuteVideoEvent({ streamId: local.getId() }));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tconst local = StreamService.local;\r\n\t\t// console.log(local);\r\n\t\tif (local && local.audio) {\r\n\t\t\tif (local.userMuteAudio) {\r\n\t\t\t\tlocal.unmuteAudio();\r\n\t\t\t\tStateService.patchState({ audioMuted: false });\r\n\t\t\t\tthis.broadcastEvent(new AgoraUnmuteAudioEvent({ streamId: local.getId() }));\r\n\t\t\t} else {\r\n\t\t\t\tlocal.muteAudio();\r\n\t\t\t\tStateService.patchState({ audioMuted: true });\r\n\t\t\t\tthis.broadcastEvent(new AgoraMuteAudioEvent({ streamId: local.getId() }));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleControl() {\r\n\t\tif (StateService.state.control) {\r\n\t\t\tthis.sendRemoteControlDismiss().then((control) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlDismiss', control);\r\n\t\t\t\tStateService.patchState({ control: !control });\r\n\t\t\t});\r\n\t\t} else if (StateService.state.spying) {\r\n\t\t\tthis.sendRemoteInfoDismiss(StateService.state.spying).then((spying) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteInfoDismiss', spying);\r\n\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\tthis.sendRemoteControlRequest().then((control) => {\r\n\t\t\t\t\t// console.log('AgoraService.sendRemoteControlRequest', control);\r\n\t\t\t\t\tStateService.patchState({ control: control });\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.sendRemoteControlRequest().then((control) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlRequest', control);\r\n\t\t\t\tStateService.patchState({ control: control });\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleSpy(remoteId) {\r\n\t\tif (StateService.state.control) {\r\n\t\t\tthis.sendRemoteControlDismiss().then((control) => {\r\n\t\t\t\tStateService.patchState({ control: false });\r\n\t\t\t\tthis.sendSpyRemoteRequestInfo(remoteId).then((info) => {\r\n\t\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t} else if (StateService.state.spying) {\r\n\t\t\tthis.sendRemoteInfoDismiss(StateService.state.spying).then((spying) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteInfoDismiss', spying);\r\n\t\t\t\t// StateService.patchState({ spying: !spying });\r\n\t\t\t\tif (StateService.state.spying !== remoteId) {\r\n\t\t\t\t\tthis.sendSpyRemoteRequestInfo(remoteId).then((info) => {\r\n\t\t\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.sendSpyRemoteRequestInfo(remoteId).then((info) => {\r\n\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tnewMessageId() {\r\n\t\treturn `${StateService.state.uid}-${Date.now().toString()}`;\r\n\t}\r\n\r\n\tsendRemoteControlDismiss() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestControlDismiss,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlDismiss return', message);\r\n\t\t\t\tif (message.type === MessageType.RequestControlDismissed) {\r\n\t\t\t\t\tresolve(true);\r\n\t\t\t\t} else if (message.type === MessageType.RequestControlRejected) {\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRemoteControlRequest() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestControl,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlRequest.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestControlAccepted) {\r\n\t\t\t\t\tresolve(true);\r\n\t\t\t\t} else if (message.type === MessageType.RequestControlRejected) {\r\n\t\t\t\t\t// this.remoteDeviceInfo = undefined\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRemoteRequestPeerInfo(remoteId) {\r\n\t\t// console.log('AgoraService.sendRemoteRequestPeerInfo', remoteId);\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestPeerInfo,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteRequestPeerInfo.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestPeerInfoResult) {\r\n\t\t\t\t\tif (message.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\t\tconst state = { hosted: true };\r\n\t\t\t\t\t\tif (message.clientInfo.control === true) {\r\n\t\t\t\t\t\t\tstate.locked = true;\r\n\t\t\t\t\t\t\tthis.sendControlRemoteRequestInfo(message.clientInfo.uid);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tStateService.patchState(state);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tresolve(message);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendControlRemoteRequestInfo(remoteId) {\r\n\t\t// console.log('AgoraService.sendControlRemoteRequestInfo', remoteId);\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestInfo,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\tif (message.type === MessageType.RequestInfoResult) {\r\n\t\t\t\t\tresolve(message);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendSpyRemoteRequestInfo(remoteId) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestInfo,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendSpyRemoteRequestInfo.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestInfoResult) {\r\n\t\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t\t\tresolve(message);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRemoteInfoDismiss(remoteId) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestInfoDismiss,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteInfoDismiss.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestInfoDismissed) {\r\n\t\t\t\t\tresolve(true);\r\n\t\t\t\t} else if (message.type === MessageType.RequestInfoRejected) {\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tnavToView(viewId) {\r\n\t\tif (StateService.state.control || StateService.state.spyed) {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.NavToView,\r\n\t\t\t\tviewId: viewId,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tgetSessionStats() {\r\n\t\tconst client = this.client;\r\n\t\tclient.getSessionStats((stats) => {\r\n\t\t\tconsole.log(`Current Session Duration: ${stats.Duration}`);\r\n\t\t\tconsole.log(`Current Session UserCount: ${stats.UserCount}`);\r\n\t\t\tconsole.log(`Current Session SendBytes: ${stats.SendBytes}`);\r\n\t\t\tconsole.log(`Current Session RecvBytes: ${stats.RecvBytes}`);\r\n\t\t\tconsole.log(`Current Session SendBitrate: ${stats.SendBitrate}`);\r\n\t\t\tconsole.log(`Current Session RecvBitrate: ${stats.RecvBitrate}`);\r\n\t\t});\r\n\t}\r\n\r\n\tgetSystemStats() {\r\n\t\tconst client = this.client;\r\n\t\tclient.getSystemStats((stats) => {\r\n\t\t\tconsole.log(`Current battery level: ${stats.BatteryLevel}`);\r\n\t\t});\r\n\t}\r\n\r\n\tsendMessage(message) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (StateService.state.connected) {\r\n\t\t\t\tmessage.clientId = StateService.state.uid;\r\n\t\t\t\tswitch (message.type) {\r\n\t\t\t\t\tcase MessageType.ControlInfo:\r\n\t\t\t\t\tcase MessageType.NavToGrid:\r\n\t\t\t\t\tcase MessageType.ShowPanel:\r\n\t\t\t\t\tcase MessageType.PlayMedia:\r\n\t\t\t\t\t\tif (!StateService.state.control && !StateService.state.spyed) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\t// message.wrc_version = 'beta';\r\n\t\t\t\t// message.uid = StateService.state.uid;\r\n\t\t\t\tconst send = (message, channel) => {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst text = JSON.stringify(message);\r\n\t\t\t\t\t\tif (message.messageId) {\r\n\t\t\t\t\t\t\tthis.once(`message-${message.messageId}`, (message) => {\r\n\t\t\t\t\t\t\t\tresolve(message);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// console.log('AgoraService.sendMessage.sending', message.type);\r\n\t\t\t\t\t\tchannel.sendMessage({ text: text }).then(() => {\r\n\t\t\t\t\t\t\t// console.log('AgoraService.sendMessage', text);\r\n\t\t\t\t\t\t\tif (!message.messageId) {\r\n\t\t\t\t\t\t\t\tresolve(message);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}).catch(error => {\r\n\t\t\t\t\t\t\tconsole.log('AgoraService.sendMessage.error', error);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} catch (error) {\r\n\t\t\t\t\t\tconsole.log('AgoraService.sendMessage.error', error);\r\n\t\t\t\t\t\t// reject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tconst channel = this.channel;\r\n\t\t\t\tif (channel) {\r\n\t\t\t\t\tsend(message, channel);\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tthis.once(`channel`, (channel) => {\r\n\t\t\t\t\t\t\tsend(message, channel);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} catch (error) {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// console.log('StateService.state.connected', StateService.state.connected)\r\n\t\t\t\t// reject();\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\r\n\taddOrUpdateChannelAttributes(messages) {\r\n\t\tconst messageClient = this.messageClient;\r\n\t\tif (messageClient) {\r\n\t\t\tconst attributes = {};\r\n\t\t\tmessages.forEach(message => {\r\n\t\t\t\tconst key = message.date.toString();\r\n\t\t\t\tattributes[key] = JSON.stringify(message);\r\n\t\t\t});\r\n\t\t\tif (Object.keys(attributes).length) {\r\n\t\t\t\t// console.log('AgoraService.setChannelAttributes', attributes);\r\n\t\t\t\tconst promise = messageClient.addOrUpdateChannelAttributes(StateService.state.channelNameLink, attributes, { enableNotificationToChannelMembers: false });\r\n\t\t\t\treturn from(promise);\r\n\t\t\t} else {\r\n\t\t\t\treturn of(null);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tgetChannelAttributes() {\r\n\t\tconst messageClient = this.messageClient;\r\n\t\tif (messageClient) {\r\n\t\t\tconst promise = messageClient.getChannelAttributes(StateService.state.channelNameLink);\r\n\t\t\treturn from(promise).pipe(\r\n\t\t\t\tmap(attributes => Object.keys(attributes).map(key => attributes[key])),\r\n\t\t\t\tmap(attributes => {\r\n\t\t\t\t\tattributes.sort((a, b) => {\r\n\t\t\t\t\t\treturn a.lastUpdateTs - b.lastUpdateTs;\r\n\t\t\t\t\t});\r\n\t\t\t\t\tconst messages = attributes.map(attribute => {\r\n\t\t\t\t\t\tconst message = JSON.parse(attribute.value);\r\n\t\t\t\t\t\t// console.log('AgoraService.getChannelAttributes.attribute', attribute, message);\r\n\t\t\t\t\t\treturn message;\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log('AgoraService.getChannelAttributes', messages);\r\n\t\t\t\t\treturn messages;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tcheckBroadcastMessage(message) {\r\n\t\t// filter for broadcast\r\n\t\t// !!! filter events here\r\n\t\tswitch (message.type) {\r\n\t\t\tcase MessageType.RequestControlDismiss:\r\n\t\t\t\tStateService.patchState({ locked: false });\r\n\t\t\t\tthis.sendMessage({\r\n\t\t\t\t\ttype: MessageType.RequestControlDismissed,\r\n\t\t\t\t\tmessageId: message.messageId\r\n\t\t\t\t});\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.RequestInfoDismiss:\r\n\t\t\t\t// console.log('checkBroadcastMessage.RequestInfoDismiss', message);\r\n\t\t\t\tStateService.patchState({ spyed: false });\r\n\t\t\t\tthis.sendMessage({\r\n\t\t\t\t\ttype: MessageType.RequestInfoDismissed,\r\n\t\t\t\t\tmessageId: message.messageId,\r\n\t\t\t\t\tremoteId: message.remoteId,\r\n\t\t\t\t});\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.RequestInfoResult:\r\n\t\t\t\t// console.log('checkBroadcastMessage.RequestInfoResult', message);\r\n\t\t\t\tif (StateService.state.role === RoleType.Publisher) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t} else if (StateService.state.locked) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.ControlInfo:\r\n\t\t\tcase MessageType.ShowPanel:\r\n\t\t\tcase MessageType.PlayMedia:\r\n\t\t\tcase MessageType.NavToView:\r\n\t\t\tcase MessageType.NavToGrid:\r\n\t\t\t\tif (StateService.state.locked || (StateService.state.spying && StateService.state.spying === message.clientId)) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthis.broadcastMessage(message);\r\n\t\t}\r\n\t}\r\n\r\n\tbroadcastMessage(message) {\r\n\t\tMessageService.out(message);\r\n\t}\r\n\r\n\tbroadcastEvent(event) {\r\n\t\tMessageService.out({\r\n\t\t\ttype: MessageType.AgoraEvent,\r\n\t\t\tevent,\r\n\t\t});\r\n\t}\r\n\r\n\tonMessage(data, uid) {\r\n\t\t// console.log('AgoraService.onMessage', data.text, uid, StateService.state.uid);\r\n\t\t// discard message delivered by current state uid;\r\n\t\tif (uid !== StateService.state.uid) {\r\n\t\t\t// console.log('AgoraService.onMessage', data.text);\r\n\t\t\tconst message = JSON.parse(data.text);\r\n\t\t\tif (message.messageId && this.has(`message-${message.messageId}`)) {\r\n\t\t\t\t// !!! removed return\r\n\t\t\t\tthis.emit(`message-${message.messageId}`, message);\r\n\t\t\t}\r\n\t\t\t// discard message delivered to specific remoteId when differs from current state uid;\r\n\t\t\tif (message.remoteId && message.remoteId !== StateService.state.uid && message.remoteId !== StateService.state.screenUid) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// !!! check position !!!\r\n\t\t\tif (message.type === MessageType.VRStarted) {\r\n\t\t\t\tconst container = document.createElement('div');\r\n\t\t\t\tcontainer.classList.add('player__vr');\r\n\t\t\t\tmessage.container = container;\r\n\t\t\t}\r\n\t\t\t/*\r\n\t\t\tif (message.type === MessageType.VRStarted || message.type === MessageType.VREnded) {\r\n\t\t\t\tconsole.log('AgoraService.onMessage', message.type, message);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.checkBroadcastMessage(message);\r\n\t\t}\r\n\t}\r\n\r\n\tonError(error) {\r\n\t\tconsole.log('AgoraService.onError', error);\r\n\t}\r\n\r\n\tonStreamPublished(event) {\r\n\t\t// console.log('AgoraService.onStreamPublished');\r\n\t\tconst local = StreamService.local;\r\n\t\tlocal.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.local = local;\r\n\t}\r\n\r\n\tonStreamUnpublished(event) {\r\n\t\t// console.log('AgoraService.onStreamUnpublished');\r\n\t\tStreamService.local = null;\r\n\t}\r\n\r\n\tonStreamAdded(event) {\r\n\t\tconst client = this.client;\r\n\t\tconst stream = event.stream;\r\n\t\tif (!stream) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst streamId = stream.getId();\r\n\t\tif (streamId !== StateService.state.uid && streamId !== StateService.state.screenUid) {\r\n\t\t\t// console.log('AgoraService.onStreamAdded', streamId, StateService.state.uid, StateService.state.screenUid);\r\n\t\t\tclient.subscribe(stream, (error) => {\r\n\t\t\t\tconsole.log('AgoraService.onStreamAdded.subscribe.error', error);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonStreamRemoved(event) {\r\n\t\tconst stream = event.stream;\r\n\t\tconst streamId = stream.getId();\r\n\t\tif (streamId !== StateService.state.uid && streamId !== StateService.state.screenUid) {\r\n\t\t\t// !!! this happen on oculus removed timeout\r\n\t\t\t// console.log('AgoraService.onStreamRemoved', streamId);\r\n\t\t\tthis.remoteRemove(streamId);\r\n\t\t}\r\n\t}\r\n\r\n\tonStreamSubscribed(event) {\r\n\t\t// console.log('AgoraService.onStreamSubscribed', event.stream.getId());\r\n\t\tthis.remoteAdd(event.stream);\r\n\t}\r\n\r\n\tonPeerConnect(event) {\r\n\t\t// console.log('AgoraService.onPeerConnect', event);\r\n\t\tthis.peerAdd(event);\r\n\t}\r\n\r\n\tonPeerLeaved(event) {\r\n\t\tconst clientId = event.uid;\r\n\t\tif (clientId !== StateService.state.uid) {\r\n\t\t\t// console.log('AgoraService.onPeerLeaved', event.uid);\r\n\t\t\tconst remote = this.remoteRemove(clientId);\r\n\t\t\tif (remote.clientInfo) {\r\n\t\t\t\t// !!! remove screenRemote?\r\n\t\t\t\tif (remote.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\tStateService.patchState({ hosted: false, locked: false, control: false, spyed: false });\r\n\t\t\t\t} else if (StateService.state.spying === clientId) {\r\n\t\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.peerRemove(clientId);\r\n\t}\r\n\r\n\tpeerAdd(event) {\r\n\t\t// console.log('AgoraService.peerAdd', event);\r\n\t\tconst peer = {\r\n\t\t\tuid: event.uid\r\n\t\t};\r\n\t\tconst peers = StreamService.peers;\r\n\t\tpeers.push(peer);\r\n\t\tStreamService.peers = peers;\r\n\t\tthis.broadcastEvent(new AgoraPeerEvent({ peer }));\r\n\t}\r\n\r\n\tpeerRemove(peerId) {\r\n\t\t// console.log('AgoraService.peerRemove', peerId);\r\n\t\tconst peers = StreamService.peers;\r\n\t\tconst peer = peers.find(x => x.uid === peerId);\r\n\t\tif (peer) {\r\n\t\t\tpeers.splice(peers.indexOf(peer), 1);\r\n\t\t\tStreamService.peers = peers;\r\n\t\t}\r\n\t}\r\n\r\n\tremoteAdd(stream) {\r\n\t\t// console.log('AgoraService.remoteAdd', stream);\r\n\t\tStreamService.remoteAdd(stream);\r\n\t\tthis.broadcastEvent(new AgoraRemoteEvent({ stream }));\r\n\t\tconst remoteId = stream.getId();\r\n\t\tthis.sendRemoteRequestPeerInfo(remoteId).then((message) => {\r\n\t\t\tStreamService.remoteSetClientInfo(remoteId, message.clientInfo);\r\n\t\t});\r\n\t}\r\n\r\n\tremoteRemove(streamId) {\r\n\t\t// console.log('AgoraService.remoteRemove', streamId);\r\n\t\tconst remote = StreamService.remoteRemove(streamId);\r\n\t\tif (remote && remote.clientInfo && remote.clientInfo.role === RoleType.Publisher && remote.clientInfo.screenUid !== streamId) {\r\n\t\t\tStateService.patchState({ hosted: false });\r\n\t\t}\r\n\t\treturn remote;\r\n\t}\r\n\r\n\tonMuteVideo(event) {\r\n\t\t// console.log('AgoraService.onMuteVideo', event);\r\n\t\tthis.broadcastEvent(new AgoraMuteVideoEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonUnmuteVideo(event) {\r\n\t\t// console.log('AgoraService.onUnmuteVideo', event);\r\n\t\tthis.broadcastEvent(new AgoraUnmuteVideoEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonMuteAudio(event) {\r\n\t\t// console.log('AgoraService.onMuteAudio', event);\r\n\t\tthis.broadcastEvent(new AgoraMuteAudioEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonUnmuteAudio(event) {\r\n\t\t// console.log('AgoraService.onUnmuteAudio', event);\r\n\t\tthis.broadcastEvent(new AgoraUnmuteAudioEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonVolumeIndicator(event) {\r\n\t\t// console.log('AgoraService.onVolumeIndicator', event);\r\n\t\tconst streams = event.attr.map(x => {\r\n\t\t\treturn { streamId: x.uid, level: x.level };\r\n\t\t});\r\n\t\tthis.broadcastEvent(new AgoraVolumeLevelsEvent({ streams: streams }));\r\n\t}\r\n\r\n\tonConnectionStateChange(event) {\r\n\t\tconsole.log('AgoraService.onConnectionStateChange', event);\r\n\t}\r\n\r\n\tonTokenPrivilegeWillExpire(event) {\r\n\t\tconsole.log('AgoraService.onTokenPrivilegeWillExpire');\r\n\t\tconst client = this.client;\r\n\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\tif (token.token) {\r\n\t\t\t\tclient.renewToken(token.token);\r\n\t\t\t\tconsole.log('AgoraService.onTokenPrivilegeWillExpire.renewed');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonTokenPrivilegeDidExpire(event) {\r\n\t\tconsole.log('AgoraService.onTokenPrivilegeDidExpire');\r\n\t\tconst client = this.client;\r\n\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\tif (token.token) {\r\n\t\t\t\tclient.renewToken(token.token);\r\n\t\t\t\tconsole.log('AgoraService.onTokenPrivilegeDidExpire.renewed');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t// screen\r\n\r\n\ttoggleScreen() {\r\n\t\tconst screen = StreamService.screen;\r\n\t\tif (screen) {\r\n\t\t\tthis.unpublishScreenStream();\r\n\t\t} else {\r\n\t\t\tif (this.screenClient) {\r\n\t\t\t\tthis.createScreenStream(StateService.state.screenUid);\r\n\t\t\t} else {\r\n\t\t\t\tthis.createScreenClient(() => {\r\n\t\t\t\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\t\t// console.log('AgoraService.rtcToken$', token);\r\n\t\t\t\t\t\tthis.screenJoin(token.token, channelNameLink);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\t// console.log(screen);\r\n\t}\r\n\r\n\tcreateScreenClient(next) {\r\n\t\tif (this.screenClient) {\r\n\t\t\tnext();\r\n\t\t}\r\n\t\tconst screenClient = this.screenClient = AgoraRTC.createClient({ mode: 'live', codec: 'h264' }); // rtc, vp8\r\n\t\tconst clientInit = () => {\r\n\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\tscreenClient.startProxyServer(3);\r\n\t\t\t\tconsole.log('AgoraService.screenClient.startProxyServer');\r\n\t\t\t}\r\n\t\t\tscreenClient.init(environment.appKey, () => {\r\n\t\t\t\t// console.log('AgoraRTC screenClient initialized');\r\n\t\t\t\tnext();\r\n\t\t\t}, (error) => {\r\n\t\t\t\t// console.log('AgoraRTC client init failed', error);\r\n\t\t\t\tthis.screenClient = null;\r\n\t\t\t});\r\n\t\t}\r\n\t\tclientInit();\r\n\t\tscreenClient.on('error', this.onScreenError);\r\n\t\tscreenClient.on('stream-published', this.onScreenStreamPublished);\r\n\t\tscreenClient.on('stream-unpublished', this.onScreenStreamUnpublished);\r\n\t\t// only for remotes\r\n\t\t// screenClient.on('stream-added', this.onScreenStreamAdded);\r\n\t\t// screenClient.on('stream-removed', this.onScreenStreamRemoved);\r\n\t\t// screenClient.on('stream-subscribed', this.onScreenStreamSubscribed);\r\n\t\t// screenClient.on('peer-online', this.onScreenPeerConnect);\r\n\t\t// screenClient.on('peer-leave', this.onScreenPeerLeaved);\r\n\t\t// screenClient.on('onTokenPrivilegeWillExpire', this.onScreenTokenPrivilegeWillExpire);\r\n\t\t// screenClient.on('onTokenPrivilegeDidExpire', this.onScreenTokenPrivilegeDidExpire);\r\n\t}\r\n\r\n\tscreenJoin(token, channelNameLink) {\r\n\t\tconst screenClient = this.screenClient;\r\n\t\tconst screenClientId = null;\r\n\t\t// console.log('AgoraService.join', { token, channelNameLink, screenClientId });\r\n\t\tscreenClient.join(token, channelNameLink, screenClientId, (uid) => {\r\n\t\t\t// console.log('AgoraService.join', uid);\r\n\t\t\tStateService.patchState({ screenUid: uid });\r\n\t\t\tthis.createScreenStream(uid);\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.screenJoin.error', error);\r\n\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\tthis.screenJoin(token.token, channelNameLink);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcreateScreenStream(screenUid) {\r\n\t\tconst options = {\r\n\t\t\tstreamID: screenUid,\r\n\t\t\taudio: false,\r\n\t\t\tvideo: false,\r\n\t\t\tscreen: true\r\n\t\t}\r\n\t\t/*\r\n\t\t// Set relevant properties according to the browser.\r\n\t\t// Note that you need to implement isFirefox and isCompatibleChrome.\r\n\t\tif (isFirefox()) {\r\n\t\t\toptions.mediaSource = 'window';\r\n\t\t} else if (!isCompatibleChrome()) {\r\n\t\t\toptions.extensionId = 'minllpmhdgpndnkomcoccfekfegnlikg';\r\n\t\t}\r\n\t\t*/\r\n\t\tconst quality = Object.assign({}, StateService.state.quality);\r\n\t\tconst stream = AgoraRTC.createStream(options);\r\n\t\tif (quality) {\r\n\t\t\tstream.setScreenProfile('720p_1');\r\n\t\t\t// stream.setVideoProfile(quality.profile);\r\n\t\t\t// stream.setVideoEncoderConfiguration(quality);\r\n\t\t}\r\n\t\t// Initialize the stream.\r\n\t\tstream.init(() => {\r\n\t\t\tStreamService.screen = stream;\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.publishScreenStream();\r\n\t\t\t}, 1);\r\n\t\t}, function(error) {\r\n\t\t\tconsole.log('AgoraService.createScreenStream.screen.init.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tpublishScreenStream() {\r\n\t\tconst screenClient = this.screenClient;\r\n\t\tconst screen = StreamService.screen;\r\n\t\t// publish screen stream\r\n\t\tscreenClient.publish(screen, (error) => {\r\n\t\t\tconsole.log('AgoraService.publishScreenStream.error', screen.getId(), error);\r\n\t\t});\r\n\t\tscreen.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.screen = screen;\r\n\t}\r\n\r\n\tunpublishScreenStream() {\r\n\t\tconst screenClient = this.screenClient;\r\n\t\tconst screen = StreamService.screen;\r\n\t\t// console.log('AgoraService.unpublishScreenStream', screen, screenClient);\r\n\t\tif (screenClient && screen) {\r\n\t\t\tscreenClient.unpublish(screen, (error) => {\r\n\t\t\t\tconsole.log('AgoraService.unpublishScreenStream.error', screen.getId(), error);\r\n\t\t\t});\r\n\t\t}\r\n\t\tStreamService.screen = null;\r\n\t}\r\n\r\n\tleaveScreenClient() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst screenClient = this.screenClient;\r\n\t\t\tif (screenClient) {\r\n\t\t\t\tscreenClient.leave(() => {\r\n\t\t\t\t\tthis.screenClient = null;\r\n\t\t\t\t\t// console.log('Leave channel successfully');\r\n\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\tscreenClient.stopProxyServer();\r\n\t\t\t\t\t\tconsole.log('AgoraService.screenClient.stopProxyServer');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tconsole.log('AgoraService.leaveScreenClient.error', error);\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonScreenError(error) {\r\n\t\tconsole.log('AgoraService.onScreenError', error);\r\n\t}\r\n\r\n\tonScreenStreamPublished(event) {\r\n\t\t// console.log('AgoraService.onScreenStreamPublished');\r\n\t\tconst screen = StreamService.screen;\r\n\t\tscreen.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.screen = screen;\r\n\t}\r\n\r\n\tonScreenStreamUnpublished(event) {\r\n\t\t// console.log('AgoraService.onScreenStreamUnpublished');\r\n\t\tStreamService.screen = null;\r\n\t}\r\n\r\n\t// tokens\r\n\tstatic rtcToken$(channelNameLink) {\r\n\t\tif (environment.flags.useToken) {\r\n\t\t\treturn HttpService.post$('/api/token/rtc', { channelName: channelNameLink, uid: null });\r\n\t\t} else {\r\n\t\t\treturn of({ token: null });\r\n\t\t}\r\n\t}\r\n\r\n\tstatic rtmToken$(uid) {\r\n\t\tif (environment.flags.useToken) {\r\n\t\t\treturn HttpService.post$('/api/token/rtm', { uid: uid });\r\n\t\t} else {\r\n\t\t\treturn of({ token: null });\r\n\t\t}\r\n\t}\r\n\r\n\t// checks\r\n\tstatic checkRtcConnection() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst client = AgoraRTC.createClient({ mode: 'live', codec: 'h264' });\r\n\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\tclient.startProxyServer(3);\r\n\t\t\t}\r\n\t\t\tclient.init(environment.appKey, () => {\r\n\t\t\t\tAgoraService.checkRtcTryJoin(client).then(uid => {\r\n\t\t\t\t\tresolve(uid);\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t// clear\r\n\t\t\t\t\tclient.leave(() => {\r\n\t\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\t\tclient.stopProxyServer();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, () => {});\r\n\t\t\t\t});\r\n\t\t\t}, (error) => {\r\n\t\t\t\treject(error);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tstatic checkRtcTryJoin(client) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst channelName = 'checkRtcConnection';\r\n\t\t\tAgoraService.rtcToken$(channelName).subscribe(token => {\r\n\t\t\t\tclient.join(token.token, channelName, null, (uid) => {\r\n\t\t\t\t\t// this.createMediaStream(uid, StateService.state.devices.video, StateService.state.devices.audio);\r\n\t\t\t\t\tresolve(uid);\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\t\t\treturn AgoraService.checkRtcTryJoin(client);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.log('AgoraService.checkRtcConnection.error', error);\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tstatic checkRtmConnection(uid) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (!USE_RTM) {\r\n\t\t\t\treturn resolve();\r\n\t\t\t}\r\n\t\t\tlet client = AgoraRTM.createInstance(environment.appKey, { logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\tclient.setParameters({ logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\tlet channel;\r\n\t\t\tAgoraService.rtmToken$(uid).subscribe(token => {\r\n\t\t\t\t// console.log('AgoraService.rtmToken$', token);\r\n\t\t\t\tconst channelName = 'checkRtcConnection';\r\n\t\t\t\tclient.login({ token: token.token, uid: uid.toString() }).then(() => {\r\n\t\t\t\t\tchannel = client.createChannel(channelName);\r\n\t\t\t\t\tchannel.join().then(() => {\r\n\t\t\t\t\t\tresolve(uid);\r\n\t\t\t\t\t\tchannel.leave();\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t\t// clear\r\n\t\t\t\t\t\tchannel.leave().then(() => {\r\n\t\t\t\t\t\t\tchannel = null;\r\n\t\t\t\t\t\t\tclient.logout().then(() => {\r\n\t\t\t\t\t\t\t\tclient = null;\r\n\t\t\t\t\t\t\t}).catch(() => {});\r\n\t\t\t\t\t\t}).catch(() => {});\r\n\t\t\t\t\t})\r\n\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t// clear\r\n\t\t\t\t\tif (client) {\r\n\t\t\t\t\t\tclient.logout().then(() => {\r\n\t\t\t\t\t\t\tclient = null;\r\n\t\t\t\t\t\t}).catch(() => {});\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tstatic getDevices() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tlet devices_ = AgoraService.devices_;\r\n\t\t\tif (devices_) {\r\n\t\t\t\tresolve(devices_);\r\n\t\t\t} else {\r\n\t\t\t\tdevices_ = AgoraService.devices_ = [];\r\n\t\t\t\tvar constraints = {\r\n\t\t\t\t\taudio: true,\r\n\t\t\t\t\tvideo: true,\r\n\t\t\t\t};\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\r\n\t\t\t\t\tnavigator.mediaDevices.getUserMedia(constraints).then((stream) => {\r\n\t\t\t\t\t\tnavigator.mediaDevices.enumerateDevices().then((devices) => {\r\n\t\t\t\t\t\t\tstream.getTracks().forEach((track) => {\r\n\t\t\t\t\t\t\t\ttrack.stop();\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tdevices.forEach((device) => {\r\n\t\t\t\t\t\t\t\tdevices_.push(device);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tresolve(devices_);\r\n\t\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\treject('Media device not available');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormGroup } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport MessageService from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport AgoraService from './agora.service';\r\nimport { MessageType } from './agora.types';\r\n\r\nexport class ChatMessage {\r\n\r\n\tconstructor(message, clientId, name) {\r\n\t\tthis.type = MessageType.ChatMessage;\r\n\t\tthis.clientId_ = clientId;\r\n\t\tif (typeof message === 'string') {\r\n\t\t\tthis.date = Date.now();\r\n\t\t\tthis.clientId = clientId;\r\n\t\t\tthis.name = name;\r\n\t\t\tthis.message = message;\r\n\t\t} else if (typeof message === 'object') {\r\n\t\t\tthis.date = message.date;\r\n\t\t\tthis.clientId = message.clientId;\r\n\t\t\tthis.name = message.name;\r\n\t\t\tthis.message = message.message;\r\n\t\t}\r\n\t\tconst names = this.name.split(' ');\r\n\t\tthis.shortName = names[0].substr(0, 1).toUpperCase() + (names.length > 1 ? names[1] : names[0]).substr(0, 1).toUpperCase();\r\n\t}\r\n\r\n\tget me() {\r\n\t\treturn this.clientId === this.clientId_;\r\n\t}\r\n\r\n\tgetPayload() {\r\n\t\treturn {\r\n\t\t\tdate: this.date,\r\n\t\t\tclientId: this.clientId,\r\n\t\t\tname: this.name,\r\n\t\t\tmessage: this.message,\r\n\t\t};\r\n\t}\r\n\r\n\tgetCopy() {\r\n\t\treturn new ChatMessage({\r\n\t\t\tdate: this.date,\r\n\t\t\tclientId: this.clientId,\r\n\t\t\tname: this.name,\r\n\t\t\tmessage: this.message,\r\n\t\t}, this.clientId_);\r\n\t}\r\n}\r\n\r\nexport default class AgoraChatComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tmessage: null,\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraChatComponent.changes$', form.value);\r\n\t\t\tthis.checkTypings(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraChatComponent.state', state);\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// console.log('AgoraChatComponent.MessageService', message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\tthis.pushMessage(new ChatMessage(message, StateService.state.uid, StateService.state.name));\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatTypingBegin:\r\n\t\t\t\t\tthis.typingBegin(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatTypingEnd:\r\n\t\t\t\t\tthis.typingEnd(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.messages = [];\r\n\t\tthis.groupedMessages = [];\r\n\t\tif (this.demo) {\r\n\t\t\t// !!! only for demo\r\n\t\t\tconst messages = AgoraChatComponent.getFakeList().map(x => new ChatMessage(x, StateService.state.uid, StateService.state.name));\r\n\t\t\tthis.updateMessages(messages);\r\n\t\t\tMessageService.in$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(message => {\r\n\t\t\t\tmessage.clientId = message.clientId || StateService.state.uid;\r\n\t\t\t\t// console.log('AgoraChatComponent.MessageService.in$', message);\r\n\t\t\t\tswitch (message.type) {\r\n\t\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase MessageType.ChatTypingBegin:\r\n\t\t\t\t\t\tMessageService.out(message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase MessageType.ChatTypingEnd:\r\n\t\t\t\t\t\tMessageService.out(message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t// !!! only for demo\r\n\t\t} else {\r\n\t\t\tconst agora = this.agora = AgoraService.getSingleton();\r\n\t\t\tif (agora) {\r\n\t\t\t\tagora.getChannelAttributes().pipe(\r\n\t\t\t\t\tfirst(),\r\n\t\t\t\t).subscribe(messages => {\r\n\t\t\t\t\tmessages = messages.map(x => new ChatMessage(x, StateService.state.uid, StateService.state.name));\r\n\t\t\t\t\t// console.log('AgoraChatComponent.getChannelAttributes.messages', messages);\r\n\t\t\t\t\tthis.updateMessages(messages);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonView() {\r\n\t\t// this.scrollToBottom();\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\t// this.scrollToBottom();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tconst message = this.createMessage(this.form.value.message);\r\n\t\tthis.sendMessage(message);\r\n\t\tthis.form.get('message').value = null;\r\n\t\tif (this.demo) {\r\n\t\t\tthis.randomMessage();\r\n\t\t}\r\n\t}\r\n\r\n\tcreateMessage(text) {\r\n\t\tconst message = new ChatMessage(text, StateService.state.uid, StateService.state.name);\r\n\t\treturn message;\r\n\t}\r\n\r\n\tsendMessage(message) {\r\n\t\tthis.pushMessage(message);\r\n\t\tconst agora = this.agora;\r\n\t\tif (agora) {\r\n\t\t\tagora.addOrUpdateChannelAttributes([message.getPayload()]).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe();\r\n\t\t}\r\n\t\tMessageService.send(message);\r\n\t}\r\n\r\n\tonClose(event) {\r\n\t\tthis.close.next();\r\n\t}\r\n\r\n\tscrollToBottom() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst scrollView = node.querySelector('.group--scrollview');\r\n\t\tscrollView.scrollTop = scrollView.scrollHeight;\r\n\t}\r\n\r\n\tpushMessage(message) {\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tthis.removeTyping({ type: MessageType.ChatTypingBegin, clientId: message.clientId }, this.messages);\r\n\t\tmessages.push(message);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\ttypingBegin(message) {\r\n\t\t// console.log('AgoraChatComponent.typingBegin', message);\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tmessages.push(message);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\ttypingEnd(message) {\r\n\t\t// console.log('AgoraChatComponent.typingEnd', message);\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tthis.removeTyping({ type: MessageType.ChatTypingBegin, clientId: message.clientId }, messages);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\tremoveTyping(message, messages, recursive = true) {\r\n\t\tconst index = messages.reduce((p,c,i) => {\r\n\t\t\treturn (c.type === message.type && c.clientId === message.clientId) ? i : p;\r\n\t\t}, -1);\r\n\t\tif (index !== -1) {\r\n\t\t\tmessages.splice(index, 1);\r\n\t\t\tif (recursive === true) {\r\n\t\t\t\tthis.removeTyping(message, messages, true);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn index;\r\n\t}\r\n\r\n\tcheckTypings(changes) {\r\n\t\tconst typings = (changes.message && changes.message.length > 0);\r\n\t\t// console.log('AgoraChatComponent.checkTypings', typings);\r\n\t\tif (this.typings_ !== typings) {\r\n\t\t\tthis.typings_ = typings;\r\n\t\t\tif (typings) {\r\n\t\t\t\tMessageService.send({ type: MessageType.ChatTypingBegin });\r\n\t\t\t} else {\r\n\t\t\t\tMessageService.send({ type: MessageType.ChatTypingEnd });\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tupdateMessages(messages) {\r\n\t\tthis.messages = messages;\r\n\t\tif (true) {\r\n\t\t\tthis.groupedMessages = [];\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t\tconst groupedMessages = [];\r\n\t\tmessages.forEach(message => {\r\n\t\t\tif (message.type === MessageType.ChatMessage) {\r\n\t\t\t\t// ChatMessage\r\n\t\t\t\tconst lastMessage = groupedMessages.length ? groupedMessages[groupedMessages.length - 1] : null;\r\n\t\t\t\tif (lastMessage && lastMessage.clientId === message.clientId) {\r\n\t\t\t\t\tlastMessage.message += `<br />${message.message}`;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tgroupedMessages.push(message.getCopy());\r\n\t\t\t\t}\r\n\t\t\t} else if (message.type === MessageType.ChatTypingBegin) {\r\n\t\t\t\t// ChatTypingBegin\r\n\t\t\t\tconst lastMessage = groupedMessages.reduce((p, c, i) => {\r\n\t\t\t\t\treturn (c.clientId === message.clientId) ? c : p;\r\n\t\t\t\t}, null);\r\n\t\t\t\tif (lastMessage) {\r\n\t\t\t\t\tlastMessage.typing = true;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('MessageType.ChatTypingBegin', lastMessage, message);\r\n\t\t\t}\r\n\t\t});\r\n\t\tsetTimeout(() => {\r\n\t\t\tthis.groupedMessages = groupedMessages;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// console.log('AgoraChatComponent.updateMessages', messages, groupedMessages);\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.scrollToBottom();\r\n\t\t\t}, 1);\r\n\t\t}, 1);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid && this.form.value.message && this.form.value.message.length > 0;\r\n\t}\r\n\r\n\t// demo\r\n\r\n\trandomMessage() {\r\n\t\tsetTimeout(() => {\r\n\t\t\tconst message = this.createRandomMessage();\r\n\t\t\tthis.sendMessage(message);\r\n\t\t}, (1 + Math.random() * 5) * 1000);\r\n\t}\r\n\r\n\tcreateRandomMessage(text) {\r\n\t\tconst message = new ChatMessage({\r\n\t\t\tdate: Date.now(),\r\n\t\t\tclientId: '9fe0e1b9-6a6b-418b-b916-4bbff3eeb123',\r\n\t\t\tname: 'Herman frederick',\r\n\t\t\tmessage: 'Lorem ipsum dolor',\r\n\t\t}, StateService.state.uid, StateService.state.name);\r\n\t\treturn message;\r\n\t}\r\n}\r\n\r\nAgoraChatComponent.meta = {\r\n\tselector: '[agora-chat]',\r\n\toutputs: ['close'],\r\n\tinputs: ['demo'],\r\n};\r\n\r\nAgoraChatComponent.getFakeList = () => {\r\n\tlet messages = [\r\n\t\t{\r\n\t\t\t\"date\": 1614592230000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Function-based web-enabled benchmark\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592240000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Customizable exuding superstructure\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592250000,\r\n\t\t\t\"name\": \"Gilles Pitkins\",\r\n\t\t\t\"message\": \"Synergistic interactive archive\",\r\n\t\t\t\"clientId\": \"cfe9ff5b-f7da-449d-bf5a-3184b5eba6ea\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592260000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Digitized client-server initiative\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592270000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Quality-focused tertiary open system\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592280000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Exclusive uniform middleware\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592290000,\r\n\t\t\t\"name\": \"John Pruckner\",\r\n\t\t\t\"message\": \"Decentralized disintermediate extranet\",\r\n\t\t\t\"clientId\": \"ae51e846-d043-41e9-bb5c-3189181e5b43\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592300000,\r\n\t\t\t\"name\": \"Lamont Georgievski\",\r\n\t\t\t\"message\": \"Enhanced static approach\",\r\n\t\t\t\"clientId\": \"1961cd9e-93aa-4bd0-b96a-89fcbd36b257\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592310000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Ergonomic clear-thinking info-mediaries\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592320000,\r\n\t\t\t\"name\": \"Jeri Pedroni\",\r\n\t\t\t\"message\": \"Grass-roots dynamic encryption\",\r\n\t\t\t\"clientId\": \"13d69bba-3656-449b-8fe3-d7a87062b044\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592330000,\r\n\t\t\t\"name\": \"Frederik Dechelle\",\r\n\t\t\t\"message\": \"Compatible disintermediate policy\",\r\n\t\t\t\"clientId\": \"9151ebe0-efa8-40b4-a341-b8fd489e9c88\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592340000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Inverse user-facing adapter\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592350000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Future-proofed even-keeled application\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592360000,\r\n\t\t\t\"name\": \"Cassie Jonathon\",\r\n\t\t\t\"message\": \"Profit-focused content-based budgetary management\",\r\n\t\t\t\"clientId\": \"5b3dc6f3-2a3d-493d-aac5-66ddfce2d709\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592370000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Managed intermediate monitoring\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592380000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Exclusive client-server encoding\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592390000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Cross-group system-worthy matrices\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592400000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Upgradable encompassing benchmark\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592410000,\r\n\t\t\t\"name\": \"Emelen Beevors\",\r\n\t\t\t\"message\": \"Function-based full-range knowledge base\",\r\n\t\t\t\"clientId\": \"c93aea47-ebd8-4e5e-88fd-52053dd35cd1\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592420000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Synergistic system-worthy capability\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t}\r\n\t];\r\n\twhile (messages.length < 100) {\r\n\t\tmessages = messages.concat(messages);\r\n\t}\r\n\t// return messages;\r\n\treturn messages.slice(0, 5);\r\n}\r\n","import { Component } from 'rxcomp';\r\n\r\nexport default class AgoraCheckComponent extends Component {}\r\n\r\nAgoraCheckComponent.meta = {\r\n\tselector: '[agora-check]',\r\n\tinputs: ['value'],\r\n\ttemplate: /* html */ `\r\n\t\t<svg *if=\"value == null\" class=\"checkmark idle\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t</svg>\r\n\t\t<svg *if=\"value === true\" class=\"checkmark success\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t\t<path class=\"checkmark__icon\" fill=\"none\" d=\"M14.1 27.2l7.1 7.2 16.7-16.8\" stroke-linecap=\"round\"/>\r\n\t\t</svg>\r\n\t\t<svg *if=\"value === false\" class=\"checkmark error\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t\t<path class=\"checkmark__icon\" stroke-linecap=\"round\" fill=\"none\" d=\"M16 16 36 36 M36 16 16 36\"/>\r\n\t\t</svg>\r\n\t`\r\n};\r\n","\r\nexport const DevicePlatform = {\r\n\tUnknown: 'unknown',\r\n\tIOS: 'ios',\r\n\tAndroid: 'android',\r\n\tWindowsPhone: 'windowsPhone',\r\n\tVRHeadset: 'vrHeadset',\r\n};\r\n\r\nexport class DeviceService {\r\n\r\n\tstatic get platform() {\r\n\t\tif (!this.platform_) {\r\n\t\t\tthis.platform_ = this.getDevicePlatform();\r\n\t\t}\r\n\t\treturn this.platform_;\r\n\t}\r\n\r\n\tstatic get isIOS() {\r\n\t\treturn ['iPad Simulator', 'iPhone Simulator', 'iPod Simulator', 'iPad', 'iPhone', 'iPod'].indexOf(navigator.platform) !== -1\r\n\t\t\t// iPad on iOS 13 detection\r\n\t\t\t|| (navigator.userAgent.indexOf('Mac') !== -1 && 'ontouchend' in document);\r\n\t}\r\n\r\n\tstatic get isVRHeadset() {\r\n\t\treturn navigator.userAgent.indexOf('VR') !== -1 || navigator.userAgent.indexOf('Quest') !== -1 || navigator.userAgent.indexOf('Oculus') !== -1;\r\n\t}\r\n\r\n\tstatic getDevicePlatform() {\r\n\t\tconst userAgent = navigator.userAgent || navigator.vendor || window.opera;\r\n\t\t// Windows Phone must come first because its UA also contains 'Android'\r\n\t\tif (/windows phone/i.test(userAgent)) {\r\n\t\t\treturn DevicePlatform.WindowsPhone;\r\n\t\t}\r\n\t\tif (/android/i.test(userAgent)) {\r\n\t\t\treturn DevicePlatform.Android;\r\n\t\t}\r\n\t\t// iOS detection from: http://stackoverflow.com/a/9039885/177710\r\n\t\t// if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {\r\n\t\tif (this.isIOS) {\r\n\t\t\treturn DevicePlatform.IOS;\r\n\t\t}\r\n\t\tif (this.isVRHeadset) {\r\n\t\t\treturn DevicePlatform.VRHeadset;\r\n\t\t}\r\n\t\treturn DevicePlatform.Unknown;\r\n\t}\r\n\r\n}\r\n","export default class LocalStorageService {\r\n\r\n\tstatic delete(name) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\twindow.localStorage.removeItem(name);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic exist(name) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\treturn window.localStorage[name] !== undefined;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get(name) {\r\n\t\tlet value = null;\r\n\t\tif (this.isLocalStorageSupported() && window.localStorage[name] !== undefined) {\r\n\t\t\ttry {\r\n\t\t\t\tvalue = JSON.parse(window.localStorage[name]);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('LocalStorageService.get.error parsing', name, e);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn value;\r\n\t}\r\n\r\n\tstatic set(name, value) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\ttry {\r\n\t\t\t\tconst cache = [];\r\n\t\t\t\tconst json = JSON.stringify(value, function(key, value) {\r\n\t\t\t\t\tif (typeof value === 'object' && value !== null) {\r\n\t\t\t\t\t\tif (cache.indexOf(value) !== -1) {\r\n\t\t\t\t\t\t\t// Circular reference found, discard key\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcache.push(value);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn value;\r\n\t\t\t\t});\r\n\t\t\t\twindow.localStorage.setItem(name, json);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('LocalStorageService.set.error serializing', name, value, e);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic isLocalStorageSupported() {\r\n\t\tif (this.supported) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tlet supported = false;\r\n\t\ttry {\r\n\t\t\tsupported = 'localStorage' in window && window.localStorage !== null;\r\n\t\t\tif (supported) {\r\n\t\t\t\twindow.localStorage.setItem('test', '1');\r\n\t\t\t\twindow.localStorage.removeItem('test');\r\n\t\t\t} else {\r\n\t\t\t\tsupported = false;\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tsupported = false;\r\n\t\t}\r\n\t\tthis.supported = supported;\r\n\t\treturn supported;\r\n\t}\r\n}\r\n","import { Component } from 'rxcomp';\r\nimport { first } from 'rxjs/operators';\r\nimport { DeviceService } from '../device/device.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport LocalStorageService from '../local-storage/local-storage.service';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\nimport AgoraService from './agora.service';\r\n\r\nconst TIMEOUT = 100;\r\n\r\nexport default class AgoraChecklistComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform; // !!!\r\n\t\tthis.checklist = {};\r\n\t\tthis.errors = {};\r\n\t\tthis.state = {};\r\n\t\tthis.busy = true;\r\n\t\tthis.shouldCheckDevices = true;\r\n\t\tLocalStorageService.set('checklist', false);\r\n\t\tStateService.state$.pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(state => {\r\n\t\t\tconsole.log('AgoraChecklistComponent', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tif (state.role === RoleType.Viewer) {\r\n\t\t\t\tthis.shouldCheckDevices = false;\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.checkBrowser();\r\n\t\t\t}, 1000);\r\n\t\t});\r\n\t}\r\n\r\n\tcheckBrowser() {\r\n\t\tconst browser = AgoraRTC.checkSystemRequirements();\r\n\t\tthis.checklist.browser = browser;\r\n\t\tif (browser) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.checkHttps();\r\n\t\t\t}, TIMEOUT);\r\n\t\t} else {\r\n\t\t\tthis.errors.browser = LabelPipe.transform('bhere_browser_error');\r\n\t\t\tthis.checkHttps(true);\r\n\t\t\tthis.checkAudio(true);\r\n\t\t\tthis.checkVideo(true);\r\n\t\t\tthis.checkRtc(true);\r\n\t\t\tthis.checkRtm(true);\r\n\t\t}\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tcheckHttps(skip) {\r\n\t\tconst https = window.location.protocol === 'https:';\r\n\t\tthis.checklist.https = https;\r\n\t\tif (skip) {\r\n\t\t\tif (!https) {\r\n\t\t\t\tthis.errors.https = LabelPipe.transform('bhere_https_error');\r\n\t\t\t}\r\n\t\t} else if (https) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tif (this.shouldCheckDevices) {\r\n\t\t\t\t\tthis.checkAudio();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}\r\n\t\t\t}, TIMEOUT);\r\n\t\t\tthis.pushChanges();\r\n\t\t} else {\r\n\t\t\tthis.errors.https = LabelPipe.transform('bhere_https_error');\r\n\t\t\tthis.checkAudio(true);\r\n\t\t\tthis.checkVideo(true);\r\n\t\t\tthis.checkRtc(true);\r\n\t\t\tthis.checkRtm(true);\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tcheckAudio(skip) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.audio = false;\r\n\t\t} else {\r\n\t\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\t\t// console.log('checkAudio', devices);\r\n\t\t\t\tconst audioinput = devices.find(x => x.kind === 'audioinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.audio = audioinput != null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.audio = false;\r\n\t\t\t\tthis.errors.audio = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tAgoraRTC.getDevices((devices) => {\r\n\t\t\t\tconsole.log('checkAudio', devices);\r\n\t\t\t\tconst audioinput = devices.find(x => x.kind === 'audioinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.audio = audioinput != null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t}, (error) => {\r\n\t\t\t\tthis.checklist.audio = false;\r\n\t\t\t\tthis.errors.audio = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tcheckVideo(skip) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.video = false;\r\n\t\t} else {\r\n\t\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\t\t// console.log('checkVideo', devices);\r\n\t\t\t\tconst videoinput = devices.find(x => x.kind === 'videoinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.video = videoinput != null;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.video = false;\r\n\t\t\t\tthis.errors.video = error;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tAgoraRTC.getDevices((devices) => {\r\n\t\t\t\tconsole.log('checkVideo', devices);\r\n\t\t\t\tconst videoinput = devices.find(x => x.kind === 'videoinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.video = videoinput != null;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, (error) => {\r\n\t\t\t\tthis.checklist.video = false;\r\n\t\t\t\tthis.errors.video = error;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tcheckRtc(skip) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.rtc = false;\r\n\t\t} else {\r\n\t\t\tAgoraService.checkRtcConnection().then(uid => {\r\n\t\t\t\tthis.checklist.rtc = true;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtm(false, uid);\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.rtc = false;\r\n\t\t\t\tthis.errors.rtc = error;\r\n\t\t\t\tthis.checkRtm(true);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tcheckRtm(skip, uid) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.rtm = false;\r\n\t\t\tthis.onComplete();\r\n\t\t} else {\r\n\t\t\tAgoraService.checkRtmConnection(uid).then(_ => {\r\n\t\t\t\tthis.checklist.rtm = true;\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.rtm = false;\r\n\t\t\t\tthis.errors.rtm = error;\r\n\t\t\t}).finally(() => {\r\n\t\t\t\tthis.onComplete();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonComplete() {\r\n\t\tconsole.log('AgoraChecklistComponent.onComplete');\r\n\t\tconst success = Object.keys(this.checklist).reduce((p, c) => {\r\n\t\t\treturn p && this.checklist[c];\r\n\t\t}, true);\r\n\t\tthis.checklist.success = success;\r\n\t\tthis.checklist.error = !success;\r\n\t\tthis.busy = false;\r\n\t\tthis.pushChanges();\r\n\t\tif (state.role === RoleType.SmartDevice) {\r\n\t\t\tthis.onNext();\r\n\t\t}\r\n\t}\r\n\r\n\tonNext() {\r\n\t\tif (this.checklist.success) {\r\n\t\t\tLocalStorageService.set('checklist', true);\r\n\t\t}\r\n\t\tthis.checked.next(this.checklist);\r\n\t}\r\n\r\n\topenHttps() {\r\n\t\twindow.location.href = window.location.href.replace('http://', 'https://').replace(':5000', ':6443');\r\n\t}\r\n}\r\n\r\nAgoraChecklistComponent.meta = {\r\n\tselector: '[agora-checklist]',\r\n\toutputs: ['checked'],\r\n};\r\n","import { BehaviorSubject, Observable, of } from \"rxjs\";\r\nimport { expand, filter, finalize, map, share, tap, withLatestFrom } from \"rxjs/operators\";\r\n\r\nconst BUFF_SIZE = 512;\r\n\r\nexport default class AudioStreamService {\r\n\r\n\tstatic get context() {\r\n\t\tif (!this.context_ && 'AudioContext' in window) {\r\n\t\t\tthis.context_ = new AudioContext();\r\n\t\t}\r\n\t\treturn this.context_;\r\n\t}\r\n\r\n\t/*\r\n\tstatic get processorNode() {\r\n\t\tif (!this.processorNode_) {\r\n\t\t\tthis.processorNode_ = this.context.createScriptProcessor(BUFF_SIZE, 1, 1);\r\n\t\t}\r\n\t\treturn this.processorNode_;\r\n\t}\r\n\t*/\r\n\r\n\t/*\r\n\tstatic get gain() {\r\n\t\tif (!this.gain_) {\r\n\t\t\tthis.gain_ = this.context.createGain();\r\n\t\t}\r\n\t\treturn this.gain_;\r\n\t}\r\n\t*/\r\n\r\n\tstatic get analyser() {\r\n\t\tif (!this.analyser_) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.analyser_ = this.context.createAnalyser();\r\n\t\t\t} catch(error) {\r\n\t\t\t\tconsole.log('AudioStreamService.analyser', error);\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn this.analyser_;\r\n\t}\r\n\r\n\tstatic addSource(streamOrElement) {\r\n\t\tconst key = streamOrElement instanceof MediaStream ? streamOrElement.id : streamOrElement;\r\n\t\tif (!this.sources_[key]) {\r\n\t\t\tif (streamOrElement instanceof MediaStream) {\r\n\t\t\t\tthis.sources_[key] = this.context.createMediaStreamSource(streamOrElement.clone());\r\n\t\t\t} else {\r\n\t\t\t\tthis.sources_[key] = this.context.createMediaElementSource(streamOrElement);\r\n\t\t\t}\r\n\t\t\t// this.sources_[key] = streamOrElement instanceof MediaStream ? this.context.createMediaStreamSource(streamOrElement) : this.context.createMediaElementSource(streamOrElement);\r\n\t\t}\r\n\t\treturn this.sources_[key];\r\n\t}\r\n\r\n\tstatic removeSource(streamOrElement) {\r\n\t\tconst key = streamOrElement instanceof MediaStream ? streamOrElement.id : streamOrElement;\r\n\t\treturn this.removeSourceKey(key);\r\n\t}\r\n\r\n\tstatic removeSourceKey(key) {\r\n\t\t// console.log('AudioStreamService.removeSourceKey', key);\r\n\t\tlet source;\r\n\t\tif (this.sources_[key]) {\r\n\t\t\tsource = this.sources_[key];\r\n\t\t\t/*\r\n\t\t\tif (source.mediaStream) {\r\n\t\t\t\tsource.mediaStream.stop();\r\n\t\t\t}\r\n\t\t\tsource.stop();\r\n\t\t\t*/\r\n\t\t\tif (this.analyser) {\r\n\t\t\t\tsource.disconnect(this.analyser);\r\n\t\t\t}\r\n\t\t\tsource.disconnect();\r\n\t\t\tdelete this.sources_[key];\r\n\t\t}\r\n\t\treturn source;\r\n\t}\r\n\r\n\tstatic frequency$(streamOrElement, fftSize = 64) {\r\n\t\tif (fftSize % 2 === 1) {\r\n\t\t\tthrow ('AudioStreamService.error', 'wrong fftSize', fftSize);\r\n\t\t}\r\n\t\tconst state = new Uint8Array(fftSize / 2);\r\n\t\tconst context = this.context;\r\n\t\tif (context) {\r\n\t\t\tconst analyser = this.analyser;\r\n\t\t\tif (analyser) {\r\n\t\t\t\t// Connect the output of the analyser to the destination\r\n\t\t\t\t// analyser.connect(context.destination); // no audio !\r\n\t\t\t\t// console.log(analyser.fftSize); // 2048 by default\r\n\t\t\t\t// console.log(analyser.frequencyBinCount); // will give us 1024 data points\r\n\t\t\t\tanalyser.fftSize = fftSize; // 64\r\n\t\t\t\t// console.log(analyser.frequencyBinCount); // fftSize/2 = 32 data points\r\n\t\t\t\tconst source = this.addSource(streamOrElement);\r\n\t\t\t\t// source.connect(context.destination); // no audio!\r\n\t\t\t\t// Connect the output of the source to the input of the analyser\r\n\t\t\t\tsource.connect(analyser);\r\n\t\t\t}\r\n\t\t\tconst state$ = new BehaviorSubject(state);\r\n\t\t\treturn AudioStreamService.frame$.pipe(\r\n\t\t\t\twithLatestFrom(state$),\r\n\t\t\t\tmap(([deltaTime, state]) => {\r\n\t\t\t\t\tif (analyser) {\r\n\t\t\t\t\t\t// Get the new frequency data\r\n\t\t\t\t\t\tanalyser.getByteFrequencyData(state);\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tconst max = state.reduce((p, c, i) => {\r\n\t\t\t\t\t\t\treturn Math.max(c, p);\r\n\t\t\t\t\t\t}, 0);\r\n\t\t\t\t\t\tif (max > 0) {\r\n\t\t\t\t\t\t\t// console.log(max);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t// Update the visualisation\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn state;\r\n\t\t\t\t}),\r\n\t\t\t\ttap((state) => state$.next(state)),\r\n\t\t\t\tfinalize(() => {\r\n\t\t\t\t\tthis.removeSource(streamOrElement);\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(state);\r\n\t\t}\r\n\t}\r\n\r\n\t// unused\r\n\tstatic volume$(streamOrElement) {\r\n\t\tconst state = { volume: 0, clipped: false };\r\n\t\tconst context = this.context;\r\n\t\t// console.log('AudioStreamService.volume$', context, state);\r\n\t\tif (context) {\r\n\t\t\tconst source = this.addSource(streamOrElement);\r\n\t\t\tconst meter = AudioStreamService.audioMeterCreate();\r\n\t\t\tsource.connect(meter);\r\n\t\t\tconst state$ = new BehaviorSubject(state);\r\n\t\t\treturn AudioStreamService.frame$.pipe(\r\n\t\t\t\twithLatestFrom(state$),\r\n\t\t\t\tmap(([deltaTime, state]) => {\r\n\t\t\t\t\tstate.clipped = meter.checkClipping();\r\n\t\t\t\t\tstate.volume = meter.volume;\r\n\t\t\t\t\treturn state;\r\n\t\t\t\t}),\r\n\t\t\t\ttap((state) => state$.next(state)),\r\n\t\t\t\tfinalize(() => {\r\n\t\t\t\t\tthis.removeSource(streamOrElement);\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(state);\r\n\t\t}\r\n\t}\r\n\r\n\t// unused\r\n\tstatic audioMeterCreate(clipLevel = 0.98, averaging = 0.95, clipLag = 750) {\r\n\t\tconst context = this.context;\r\n\t\tif (context) {\r\n\t\t\tconst processor = context.createScriptProcessor(512);\r\n\t\t\tprocessor.onaudioprocess = this.audioMeterProcess;\r\n\t\t\tprocessor.checkClipping = this.audioMeterClip;\r\n\t\t\tprocessor.dispose = this.audioMeterDispose;\r\n\t\t\tprocessor.clipping = false;\r\n\t\t\tprocessor.lastClip = 0;\r\n\t\t\tprocessor.volume = 0;\r\n\t\t\tprocessor.clipLevel = clipLevel;\r\n\t\t\tprocessor.averaging = averaging;\r\n\t\t\tprocessor.clipLag = clipLag;\r\n\t\t\t// this will have no effect, since we don't copy the input to the output,\r\n\t\t\t// but works around a current Chrome bug.\r\n\t\t\tprocessor.connect(context.destination);\r\n\t\t\treturn processor;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic audioMeterProcess(event) {\r\n\t\tconst buffer = event.inputBuffer.getChannelData(0);\r\n\t\tconst bufferLength = buffer.length;\r\n\t\tlet sum = 0;\r\n\t\tlet x;\r\n\r\n\t\t// Do a root-mean-square on the samples: sum up the squares...\r\n\t\tfor (let i = 0; i < bufferLength; i++) {\r\n\t\t\tx = buffer[i];\r\n\t\t\tif (Math.abs(x) >= this.clipLevel) {\r\n\t\t\t\tthis.clipping = true;\r\n\t\t\t\tthis.lastClip = window.performance.now();\r\n\t\t\t}\r\n\t\t\tsum += x * x;\r\n\t\t}\r\n\r\n\t\t// ... then take the square root of the sum.\r\n\t\tconst rms = Math.sqrt(sum / bufferLength);\r\n\r\n\t\t// Now smooth this out with the averaging factor applied\r\n\t\t// to the previous sample - take the max here because we\r\n\t\t// want \"fast attack, slow release.\"\r\n\t\tthis.volume = Math.max(rms, this.volume * this.averaging);\r\n\t}\r\n\r\n\tstatic audioMeterClip() {\r\n\t\tif (!this.clipping) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif ((this.lastClip + this.clipLag) < window.performance.now()) {\r\n\t\t\tthis.clipping = false;\r\n\t\t}\r\n\t\treturn this.clipping;\r\n\t}\r\n\r\n\tstatic audioMeterDispose() {\r\n\t\tthis.disconnect();\r\n\t\tthis.onaudioprocess = null;\r\n\t}\r\n\r\n\tstatic step$(previous) {\r\n\t\t/**\r\n\t\t * This function returns an observable that will emit the next frame once the\r\n\t\t * browser has returned an animation frame step. Given the previous frame it calculates\r\n\t\t * the delta time, and we also clamp it to 30FPS in case we get long frames.\r\n\t\t */\r\n\t\treturn Observable.create((observer) => {\r\n\t\t\trequestAnimationFrame((startTime) => {\r\n\t\t\t\t// Millis to seconds\r\n\t\t\t\tconst deltaTime = previous ? (startTime - previous.startTime) / 1000 : 0;\r\n\t\t\t\tobserver.next({\r\n\t\t\t\t\tstartTime,\r\n\t\t\t\t\tdeltaTime\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}).pipe(\r\n\t\t\tmap(frame => {\r\n\t\t\t\tif (frame.deltaTime > (1 / 30)) {\r\n\t\t\t\t\tframe.deltaTime = 1 / 30;\r\n\t\t\t\t}\r\n\t\t\t\treturn frame;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic dispose() {\r\n\t\tObject.keys(this.sources_).forEach(key => {\r\n\t\t\tthis.removeSourceKey(key);\r\n\t\t});\r\n\t\tconst analyser = this.analyser;\r\n\t\tif (analyser) {\r\n\t\t\tanalyser.disconnect();\r\n\t\t}\r\n\t\tthis.sources_ = {};\r\n\t\t// this.context_.close().then(() => console.log('AudioStreamService.dispose'));\r\n\t\t// this.context_ = null;\r\n\t}\r\n\r\n}\r\n\r\nAudioStreamService.sources_ = {};\r\nAudioStreamService.frame$ = of(undefined).pipe(\r\n\texpand((value) => AudioStreamService.step$(value)),\r\n\t// Expand emits the first value provided to it, and in this\r\n\t//  case we just want to ignore the undefined input frame\r\n\tfilter(frame => frame !== undefined),\r\n\tmap(frame => frame.deltaTime),\r\n\tshare()\r\n);\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport AudioStreamService from '../audio/audio-stream.service';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport StateService from '../state/state.service';\r\nimport { getStreamQuality } from './agora.types';\r\n\r\nexport default class AgoraDevicePreviewComponent extends Component {\r\n\r\n\tget video() {\r\n\t\treturn this.video_;\r\n\t}\r\n\r\n\tset video(video) {\r\n\t\tif (this.video_ !== video) {\r\n\t\t\tthis.video_ = video;\r\n\t\t\tif (this.change) {\r\n\t\t\t\tthis.change.next();\r\n\t\t\t\tthis.init();\r\n\t\t\t\tthis.initStream();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget audio() {\r\n\t\treturn this.audio_;\r\n\t}\r\n\r\n\tset audio(audio) {\r\n\t\tif (this.audio_ !== audio) {\r\n\t\t\tthis.audio_ = audio;\r\n\t\t\tif (this.change) {\r\n\t\t\t\tthis.change.next();\r\n\t\t\t\tthis.init();\r\n\t\t\t\tthis.initStream();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget hasPreview() {\r\n\t\treturn this.platform !== DevicePlatform.IOS && this.platform !== DevicePlatform.VRHeadset;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.init();\r\n\t}\r\n\r\n\tinit() {\r\n\t\tif (this.initialized_) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.initialized_ = true;\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.onLoadedMetadata = this.onLoadedMetadata.bind(this);\r\n\t\tconst preview = this.preview = node.querySelector('video');\r\n\t\tpreview.addEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\tconst audio = node.querySelector('.audio');\r\n\t\tif (this.hasPreview) {\r\n\t\t\tconst bars = this.bars = new Array(32).fill(0).map(x => {\r\n\t\t\t\tconst bar = document.createElement('div');\r\n\t\t\t\tbar.classList.add('bar');\r\n\t\t\t\taudio.appendChild(bar);\r\n\t\t\t\treturn bar;\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tconst preview = this.preview;\r\n\t\tpreview.removeEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\tif (this.hasPreview) {\r\n\t\t\tAudioStreamService.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\tinitStream() {\r\n\t\tconst preview = this.preview;\r\n\t\tif (!this.preview) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// console.log(this.video_, this.audio_);\r\n\t\tif (this.video_ || this.audio_) {\r\n\t\t\t// const { node } = getContext(this);\r\n\t\t\t// node.classList.remove('ready');\r\n\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\r\n\t\t\t\tconst state = StateService.state;\r\n\t\t\t\tconst quality = getStreamQuality(state);\r\n\t\t\t\tconst options = {\r\n\t\t\t\t\tvideo: this.video_ ? {\r\n\t\t\t\t\t\tdeviceId: this.video_,\r\n\t\t\t\t\t\twidth: { ideal: quality.resolution.width },\r\n\t\t\t\t\t\theight: { ideal: quality.resolution.height },\r\n\t\t\t\t\t\tframeRate: { ideal: quality.frameRate.min, max: quality.frameRate.max },\r\n\t\t\t\t\t} : false,\r\n\t\t\t\t\taudio: this.audio_ ? { deviceId: this.audio_ } : false,\r\n\t\t\t\t};\r\n\t\t\t\t// console.log('AgoraDevicePreviewComponent.initStream.getUserMedia', options);\r\n\t\t\t\tnavigator.mediaDevices.getUserMedia(options).then((stream) => {\r\n\t\t\t\t\tif (this.hasPreview) {\r\n\t\t\t\t\t\tif ('srcObject' in preview) {\r\n\t\t\t\t\t\t\tpreview.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tpreview.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this.audio_) {\r\n\t\t\t\t\t\t\tthis.analyzeData(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.loadingStream_ = stream;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.stream.next(stream);\r\n\t\t\t\t\t}\r\n\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\tconsole.log('AgoraDevicePreviewComponent.initStream.error', error.name, error.message);\r\n\t\t\t\t\tthis.stream.next(null);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (this.hasPreview) {\r\n\t\t\t\tif ('srcObject' in preview) {\r\n\t\t\t\t\tpreview.srcObject = null;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpreview.src = null;\r\n\t\t\t\t}\r\n\t\t\t\tthis.analyzeData(null);\r\n\t\t\t}\r\n\t\t\tthis.stream.next(null);\r\n\t\t}\r\n\t}\r\n\r\n\tonLoadedMetadata(event) {\r\n\t\t// console.log('AgoraDevicePreview.onLoadedMetadata', event);\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('ready');\r\n\t\tthis.preview.play();\r\n\t\tthis.stream.next(this.loadingStream_);\r\n\t}\r\n\r\n\tanalyzeData(stream) {\r\n\t\tif (this.frequencySubscription) {\r\n\t\t\tthis.frequencySubscription.unsubscribe();\r\n\t\t}\r\n\t\t// console.log('AgoraDevicePreviewComponent.analyzeData', stream);\r\n\t\tif (stream) {\r\n\t\t\tthis.frequencySubscription = AudioStreamService.frequency$(stream, 64).pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(frequency => {\r\n\t\t\t\t// 32 data points\r\n\t\t\t\t// console.log(frequency);\r\n\t\t\t\tconst spacing = 100 / 32;\r\n\t\t\t\tconst bars = this.bars;\r\n\t\t\t\tbars.forEach((bar, i) => {\r\n\t\t\t\t\tconst pow = Math.min(100, (5 + frequency[i])) / 100;\r\n\t\t\t\t\tbar.style.left = i * spacing + '%';\r\n\t\t\t\t\tbar.style.transform = `scale(1,${pow})`;\r\n\t\t\t\t\tbar.style.opacity = pow;\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nAgoraDevicePreviewComponent.meta = {\r\n\tselector: '[agora-device-preview]',\r\n\toutputs: ['stream', 'change'],\r\n\tinputs: ['video', 'audio']\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport StateService from '../state/state.service';\r\nimport AgoraService from './agora.service';\r\n\r\nexport default class AgoraDeviceComponent extends Component {\r\n\r\n\tget hasPreview() {\r\n\t\treturn this.platform !== DevicePlatform.IOS && this.platform !== DevicePlatform.VRHeadset; // && this.form && this.form.value.video;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.isHttps = window.location.protocol === 'https:';\r\n\t\tthis.state = {};\r\n\t\tthis.devices = { videos: [], audios: [] };\r\n\t\tthis.stream = null;\r\n\t\tthis.form = null;\r\n\t\tif (this.isHttps) {\r\n\t\t\tconst agora = this.agora = AgoraService.getSingleton();\r\n\t\t\tStateService.state$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(state => {\r\n\t\t\t\t// console.log('AgoraDeviceComponent.state', state);\r\n\t\t\t\tthis.state = state;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t\tif (agora) {\r\n\t\t\t\tagora.devices$().subscribe(devices => {\r\n\t\t\t\t\t// console.log(devices);\r\n\t\t\t\t\tthis.devices = devices;\r\n\t\t\t\t\tthis.initForm(devices);\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\topenHttps(event) {\r\n\t\twindow.location.href = window.location.href.replace('http://', 'https://').replace(':5000', ':6443');\r\n\t}\r\n\r\n\tinitForm(devices) {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tvideo: new FormControl(null, devices.videos.length ? Validators.RequiredValidator() : undefined),\r\n\t\t\taudio: new FormControl(null, devices.audios.length ? Validators.RequiredValidator() : undefined),\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tconst videoOptions = devices.videos.map(x => {\r\n\t\t\treturn {\r\n\t\t\t\tid: x.deviceId,\r\n\t\t\t\tname: x.label,\r\n\t\t\t};\r\n\t\t});\r\n\t\tif (videoOptions.length > 0) {\r\n\t\t\tvideoOptions.unshift({\r\n\t\t\t\tid: null, name: LabelPipe.transform('bhere_select_video')\r\n\t\t\t});\r\n\t\t}\r\n\t\tcontrols.video.options = videoOptions;\r\n\t\tconst audioOptions = devices.audios.map(x => {\r\n\t\t\treturn {\r\n\t\t\t\tid: x.deviceId,\r\n\t\t\t\tname: x.label,\r\n\t\t\t};\r\n\t\t});\r\n\t\tif (audioOptions.length > 0) {\r\n\t\t\taudioOptions.unshift({\r\n\t\t\t\tid: null, name: LabelPipe.transform('bhere_select_audio')\r\n\t\t\t});\r\n\t\t}\r\n\t\tcontrols.audio.options = audioOptions;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraDeviceComponent.changes$', form.value);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonStreamDidChange(event) {\r\n\t\tthis.stream = null;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonStream(stream) {\r\n\t\tthis.stream = stream;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid && (this.stream || !this.hasPreview);\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonEnter(event) {\r\n\t\tconst preferences = this.form.value;\r\n\t\tconst devices = this.devices;\r\n\t\tdevices.video = devices.videos.find(x => x.deviceId === preferences.video);\r\n\t\tdevices.audio = devices.audios.find(x => x.deviceId === preferences.audio);\r\n\t\tthis.enter.next(devices);\r\n\t}\r\n\r\n}\r\n\r\nAgoraDeviceComponent.meta = {\r\n\tselector: '[agora-device]',\r\n\toutputs: ['enter'],\r\n};\r\n","import { Component } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\n\r\nexport default class AgoraLinkComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.state = {};\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tlink: new FormControl(null, [Validators.PatternValidator(/^\\d{9}-\\d{4}-\\d{13}$/), Validators.RequiredValidator()]),\r\n\t\t\tlinkAttendee: null,\r\n\t\t\tlinkStreamer: null,\r\n\t\t\tlinkViewer: null,\r\n\t\t\tlinkSmartDevice: null,\r\n\t\t\t// link: new FormControl(null),\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraLinkComponent.changes$', form.value);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraLinkComponent.state', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonGenerateMeetingId($event) {\r\n\t\t// const timestamp = (performance.now() * 10000000000000).toString();\r\n\t\tconst timestamp = new Date().valueOf().toString();\r\n\t\tthis.form.patch({\r\n\t\t\tlink: this.getRoleMeetingId(timestamp, RoleType.Publisher),\r\n\t\t\tlinkAttendee: this.getRoleMeetingId(timestamp, RoleType.Attendee),\r\n\t\t\tlinkStreamer: this.getRoleMeetingId(timestamp, RoleType.Streamer),\r\n\t\t\tlinkViewer: this.getRoleMeetingId(timestamp, RoleType.Viewer),\r\n\t\t\tlinkSmartDevice: this.getRoleMeetingId(timestamp, RoleType.SmartDevice),\r\n\t\t});\r\n\t}\r\n\r\n\treplaceRoleMeetingId(meetingId, role) {\r\n\t\tconst components = meetingId.split('-');\r\n\t\tcomponents[1] = this.padded(this.getRoleIndex(role), 4);\r\n\t\treturn components.join('-');\r\n\t}\r\n\r\n\tonInputDidChange($event) {\r\n\t\t// console.log('onInputDidChange', this.form.get('link').value, this.form.get('link').valid);\r\n\t\tif (this.state.role !== 'publisher') {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tsetTimeout(() => {\r\n\t\t\tif (this.form.get('link').valid) {\r\n\t\t\t\tconst value = this.form.get('link').value;\r\n\t\t\t\tthis.form.patch({\r\n\t\t\t\t\tlink: this.setRoleMeetingId(value, RoleType.Publisher),\r\n\t\t\t\t\tlinkAttendee: this.setRoleMeetingId(value, RoleType.Attendee),\r\n\t\t\t\t\tlinkStreamer: this.setRoleMeetingId(value, RoleType.Streamer),\r\n\t\t\t\t\tlinkViewer: this.setRoleMeetingId(value, RoleType.Viewer),\r\n\t\t\t\t\tlinkSmartDevice: this.setRoleMeetingId(value, RoleType.SmartDevice),\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tthis.form.get('linkAttendee').reset();\r\n\t\t\t\tthis.form.get('linkStreamer').reset();\r\n\t\t\t\tthis.form.get('linkViewer').reset();\r\n\t\t\t}\r\n\t\t}, 1);\r\n\t}\r\n\r\n\tsetRoleMeetingId(meetingId, role) {\r\n\t\tconst meetingIdSegments = meetingId.split('-');\r\n\t\treturn `${meetingIdSegments[0]}-${this.padded(this.getRoleIndex(role), 4)}-${meetingIdSegments[2]}`;\r\n\t}\r\n\r\n\tgetRoleMeetingId(timestamp, role) {\r\n\t\treturn `${this.padded(this.state.user.id, 9)}-${this.padded(this.getRoleIndex(role), 4)}-${timestamp}`;\r\n\t}\r\n\r\n\tgetRoleIndex(role) {\r\n\t\treturn Object.keys(RoleType).reduce((p, c, i) => {\r\n\t\t\treturn RoleType[c] === role ? i : p;\r\n\t\t}, -1);\r\n\t}\r\n\r\n\tonCopyToClipBoard(meetingId, asAccessCode = false) {\r\n\t\tconst input = document.createElement('input');\r\n\t\tinput.style.position = 'absolute';\r\n\t\tinput.style.top = '1000vh';\r\n\t\t// input.style.visibility = 'hidden';\r\n\t\tdocument.querySelector('body').appendChild(input);\r\n\t\tinput.value = asAccessCode ? this.getAccessCodeUrl(meetingId, true) : this.getUrl(meetingId, true);\r\n\t\tinput.focus();\r\n\t\tinput.select();\r\n\t\tinput.setSelectionRange(0, 99999);\r\n\t\tdocument.execCommand('copy');\r\n\t\tinput.parentNode.removeChild(input);\r\n\t\talert(`link copiato!\\n ${input.value}`);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonNext(event) {\r\n\t\tlet meetingId = this.controls.link.value;\r\n\t\t/*\r\n\t\tif (this.state.role === RoleType.Publisher) {\r\n\t\t\tmeetingId = this.replaceRoleMeetingId(meetingId, RoleType.Publisher);\r\n\t\t}\r\n\t\t*/\r\n\t\tthis.replaceUrl(meetingId);\r\n\t\tthis.link.next(meetingId);\r\n\t}\r\n\r\n\tgetUrl(meetingId, shareable = false) {\r\n\t\tconst role = LocationService.get('role') || null;\r\n\t\tconst name = LocationService.get('name') || null;\r\n\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${meetingId}` + (name ? `&name=${name}` : '') + ((role && !shareable) ? `&role=${role}` : '');\r\n\t\treturn url;\r\n\t}\r\n\r\n\tgetAccessCodeUrl(meetingId, shareable = false) {\r\n\t\tconst role = LocationService.get('role') || null;\r\n\t\tconst name = LocationService.get('name') || null;\r\n\t\tconst url = `${window.location.origin}${environment.url.accessCode}?link=${meetingId}` + (name ? `&name=${name}` : '') + ((role && !shareable) ? `&role=${role}` : '');\r\n\t\treturn url;\r\n\t}\r\n\r\n\treplaceUrl(meetingId) {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst url = this.getUrl(meetingId);\r\n\t\t\t// console.log('AgoraLinkComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n\r\n\tpadded(num, size) {\r\n\t\tconst s = '000000000' + num;\r\n\t\treturn s.substr(s.length - size);\r\n\t}\r\n}\r\n\r\nAgoraLinkComponent.meta = {\r\n\tselector: '[agora-link]',\r\n\toutputs: ['link'],\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { UserService } from '../user/user.service';\r\n\r\nexport default class AgoraLoginComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tusername: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tpassword: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: '',\r\n\t\t});\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\ttest() {\r\n\t\tthis.form.patch({\r\n\t\t\tusername: 'publisher',\r\n\t\t\tpassword: 'publisher',\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: ''\r\n\t\t});\r\n\t}\r\n\r\n\treset() {\r\n\t\tthis.form.reset();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst payload = this.form.value;\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tthis.error = null;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tUserService.login$(payload).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(user => {\r\n\t\t\t\tif (StateService.state.role === user.type) {\r\n\t\t\t\t\t// this.login.next(user);\r\n\t\t\t\t\tthis.onNext(user);\r\n\t\t\t\t\tthis.form.reset();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.error = { friendlyMessage: LabelPipe.transform('error_credentials') };\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('AccessComponent.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonNext(user) {\r\n\t\tthis.replaceUrl(user);\r\n\t\tthis.login.next(user);\r\n\t}\r\n\r\n\treplaceUrl(user) {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst role = LocationService.get('role') || null;\r\n\t\t\tconst link = LocationService.get('link') || null;\r\n\t\t\tconst name = LocationService.get('name') || (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null);\r\n\t\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${link}`\r\n\t\t\t\t+ (name ? `&name=${name}` : '')\r\n\t\t\t\t+ (role ? `&role=${role}` : '');\r\n\t\t\t// console.log('AgoraLoginComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nAgoraLoginComponent.meta = {\r\n\tselector: '[agora-login]',\r\n\toutputs: ['login'],\r\n};\r\n","import { Component } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\n\r\nexport default class AgoraNameComponent extends Component {\r\n\tonInit() {\r\n\t\tconst name = LocationService.get('name') || null;\r\n\t\tthis.state = {};\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tname: new FormControl(name, [Validators.PatternValidator(/^\\w{2,}\\s\\w{2,}/), Validators.RequiredValidator()]),\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraNameComponent.changes$', form.value);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraNameComponent.state', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonNext(event) {\r\n\t\tthis.replaceUrl();\r\n\t\tthis.name.next(this.controls.name.value);\r\n\t}\r\n\r\n\treplaceUrl() {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst role = LocationService.get('role') || null;\r\n\t\t\tconst link = LocationService.get('link') || null;\r\n\t\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${link}&name=${this.controls.name.value}` + (role ? `&role=${role}` : '');\r\n\t\t\t// console.log('AgoraNameComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nAgoraNameComponent.meta = {\r\n\tselector: '[agora-name]',\r\n\toutputs: ['name'],\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport MessageService from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport { AgoraMuteAudioEvent, AgoraMuteVideoEvent, AgoraUnmuteAudioEvent, AgoraUnmuteVideoEvent, MessageType } from './agora.types';\r\n\r\nexport default class AgoraStreamComponent extends Component {\r\n\r\n\tset videoMuted(videoMuted) {\r\n\t\tif (this.videoMuted_ !== videoMuted) {\r\n\t\t\tthis.videoMuted_ = videoMuted;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tvideoMuted ? node.classList.add('video--muted') : node.classList.remove('video--muted');\r\n\t\t}\r\n\t}\r\n\r\n\tset audioMuted(audioMuted) {\r\n\t\tif (this.audioMuted_ !== audioMuted) {\r\n\t\t\tthis.audioMuted_ = audioMuted;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\taudioMuted ? node.classList.add('audio--muted') : node.classList.remove('audio--muted');\r\n\t\t}\r\n\t}\r\n\r\n\tget streamId() {\r\n\t\treturn this.streamId_;\r\n\t}\r\n\r\n\tset streamId(streamId) {\r\n\t\tthis.streamId_ = streamId;\r\n\t}\r\n\r\n\tget stream() {\r\n\t\treturn this.stream_;\r\n\t}\r\n\r\n\tset stream(stream) {\r\n\t\tif (this.stream_ !== stream) {\r\n\t\t\t// console.log('AgoraStreamComponent set stream', stream);\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst player = this.player = node.querySelector('.agora-stream__player');\r\n\t\t\twhile (player.childElementCount > 0) {\r\n\t\t\t\tplayer.removeChild(player.firstElementChild);\r\n\t\t\t}\r\n\t\t\t// player.textContent = '';\r\n\t\t\tif (this.stream_ && this.stream_.isPlaying() && this.stream_.player.div.parentNode === player) {\r\n\t\t\t\t// console.log('AgoraStreamComponent stopping stream', this.stream_.getId(), 'on', this.stream_.player.div.parentNode);\r\n\t\t\t\tthis.stream_.stop();\r\n\t\t\t}\r\n\t\t\tthis.stream_ = stream;\r\n\t\t\tif (stream) {\r\n\t\t\t\tthis.videoMuted = stream.userMuteVideo;\r\n\t\t\t\tthis.audioMuted = stream.userMuteAudio;\r\n\t\t\t}\r\n\t\t\tconst streamId = stream ? stream.getId() : null;\r\n\t\t\tthis.streamId = streamId;\r\n\t\t\t// console.log('AgoraStreamComponent streamId', streamId);\r\n\t\t\tif (streamId) {\r\n\t\t\t\tconst name = `stream-${streamId}`;\r\n\t\t\t\tplayer.setAttribute('id', name);\r\n\t\t\t\tconst self = this;\r\n\t\t\t\tif (stream.isPlaying()) {\r\n\t\t\t\t\tplayer.appendChild(stream.player.div);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.shouldUseResumeGesture = false;\r\n\t\t\t\t\tstream.play(name, { fit: 'cover' }, (error) => {\r\n\t\t\t\t\t\tif (error && error.status !== 'aborted') {\r\n\t\t\t\t\t\t\t// The playback fails, probably due to browser policy. You can resume the playback by user gesture.\r\n\t\t\t\t\t\t\tself.shouldUseResumeGesture = true;\r\n\t\t\t\t\t\t\tself.pushChanges();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tplayer.removeAttribute('id');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tset vrContainer(vrContainer) {\r\n\t\tif (this.vrContainer_ !== vrContainer) {\r\n\t\t\tthis.vrContainer_ = vrContainer;\r\n\t\t\tif (vrContainer) {\r\n\t\t\t\tthis.stream_.vrContainer = vrContainer;\r\n\t\t\t\tthis.player.appendChild(vrContainer);\r\n\t\t\t} else if (this.stream_.vrContainer && this.stream_.vrContainer.parentNode) {\r\n\t\t\t\tthis.stream_.vrContainer.parentNode.removeChild(this.stream_.vrContainer);\r\n\t\t\t\tthis.stream_.vrContainer = null;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget videoNode() {\r\n\t\tlet videoNode = this.videoNode_;\r\n\t\tif (!videoNode) {\r\n\t\t\tconst player = getContext(this).node.querySelector('.agora-stream__player');\r\n\t\t\tvideoNode = document.createElement('video');\r\n\t\t\tthis.onLoadedMetadata = this.onLoadedMetadata.bind(this);\r\n\t\t\tvideoNode.addEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\t\tplayer.appendChild(videoNode);\r\n\t\t\tthis.videoNode_ = videoNode;\r\n\t\t}\r\n\t\treturn videoNode;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.videoMuted = false;\r\n\t\tthis.audioMuted = false;\r\n\t\tthis.shouldUseResumeGesture = false;\r\n\t\tthis.state = {};\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// console.log('AgoraStreamComponent.StateService.state$', this.streamId, state);\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// console.log('AgoraStreamComponent.MessageService.out$', this.streamId, message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.AgoraEvent:\r\n\t\t\t\t\tconst event = message.event;\r\n\t\t\t\t\t// console.log('AgoraStreamComponent.AgoraEvent', message.event);\r\n\t\t\t\t\tif (this.streamId && event.streamId === this.streamId) {\r\n\t\t\t\t\t\tif (event instanceof AgoraMuteVideoEvent) {\r\n\t\t\t\t\t\t\tthis.videoMuted = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (event instanceof AgoraUnmuteVideoEvent) {\r\n\t\t\t\t\t\t\tthis.videoMuted = false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (event instanceof AgoraMuteAudioEvent) {\r\n\t\t\t\t\t\t\tthis.audioMuted = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (event instanceof AgoraUnmuteAudioEvent) {\r\n\t\t\t\t\t\t\tthis.audioMuted = false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VRStarted:\r\n\t\t\t\t\t// console.log('AgoraStreamComponent.VRStarted', this.streamId, message.clientId, message.container);\r\n\t\t\t\t\tif (this.streamId === message.clientId) {\r\n\t\t\t\t\t\tthis.vrContainer = message.container;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VREnded:\r\n\t\t\t\t\t// console.log('AgoraStreamComponent.VREnded', this.streamId, message.clientId);\r\n\t\t\t\t\tif (this.streamId === message.clientId) {\r\n\t\t\t\t\t\tthis.vrContainer = null;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tsetMediaStream(mediaStream) {\r\n\t\tconst videoNode = this.videoNode;\r\n\t\tif ('srcObject' in videoNode) {\r\n\t\t\tvideoNode.srcObject = mediaStream;\r\n\t\t} else {\r\n\t\t\tvideoNode.src = mediaStream ? window.URL.createObjectURL(mediaStream) : null;\r\n\t\t}\r\n\t}\r\n\r\n\tonLoadedMetadata(event) {\r\n\t\t// console.log('AgoraStreamComponent.onLoadedMetadata', event);\r\n\t\tthis.videoNode.play().then(success => {\r\n\t\t\t// console.log('AgoraStreamComponent.play.success', success);\r\n\t\t}, error => {\r\n\t\t\tconsole.log('AgoraStreamComponent.play.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tonToggleSpy($event) {\r\n\t\tthis.toggleSpy.next($event);\r\n\t}\r\n}\r\n\r\nAgoraStreamComponent.meta = {\r\n\tselector: '[agora-stream]',\r\n\toutputs: ['toggleSpy'],\r\n\tinputs: ['stream'],\r\n};\r\n","function push_(event) {\r\n\tconst dataLayer = window.dataLayer || [];\r\n\tdataLayer.push(event);\r\n\tconsole.log('GtmService.dataLayer', event);\r\n}\r\n\r\nexport default class GtmService {\r\n\r\n\tstatic push(event) {\r\n\t\treturn push_(event);\r\n\t}\r\n\r\n}\r\n","import { from, Subject } from 'rxjs';\r\nimport { map, switchMap, tap } from 'rxjs/operators';\r\n\r\nexport class ModalEvent {\r\n\r\n\tconstructor(data) {\r\n\t\tthis.data = data;\r\n\t}\r\n\r\n}\r\n\r\nexport class ModalResolveEvent extends ModalEvent { }\r\nexport class ModalRejectEvent extends ModalEvent { }\r\n\r\nexport default class ModalService {\r\n\r\n\tstatic open$(modal) {\r\n\t\treturn this.getTemplate$(modal.src).pipe(\r\n\t\t\tmap(template => {\r\n\t\t\t\treturn { node: this.getNode(template), data: modal.data, modal: modal };\r\n\t\t\t}),\r\n\t\t\ttap(node => this.modal$.next(node)),\r\n\t\t\tswitchMap(node => this.events$),\r\n\t\t)\r\n\t}\r\n\r\n\tstatic load$(modal) {\r\n\r\n\t}\r\n\r\n\tstatic getTemplate$(url) {\r\n\t\treturn from(fetch(url).then(response => {\r\n\t\t\treturn response.text();\r\n\t\t}));\r\n\t}\r\n\r\n\tstatic getNode(template) {\r\n\t\tconst div = document.createElement('div');\r\n\t\tdiv.innerHTML = template;\r\n\t\tconst node = div.firstElementChild;\r\n\t\treturn node;\r\n\t}\r\n\r\n\tstatic reject(data) {\r\n\t\tthis.modal$.next(null);\r\n\t\tthis.events$.next(new ModalRejectEvent(data));\r\n\t}\r\n\r\n\tstatic resolve(data) {\r\n\t\tthis.modal$.next(null);\r\n\t\tthis.events$.next(new ModalResolveEvent(data));\r\n\t}\r\n\r\n}\r\n\r\nModalService.modal$ = new Subject();\r\nModalService.events$ = new Subject();\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport ModalService from './modal.service';\r\n\r\nexport default class ModalOutletComponent extends Component {\r\n\tget modal() {\r\n\t\treturn this.modal_;\r\n\t}\r\n\r\n\tset modal(modal) {\r\n\t\t// console.log('ModalOutletComponent set modal', modal, this);\r\n\t\tconst { module } = getContext(this);\r\n\t\tif (this.modal_ && this.modal_.node) {\r\n\t\t\tmodule.remove(this.modal_.node, this);\r\n\t\t\tthis.modalNode.removeChild(this.modal_.node);\r\n\t\t}\r\n\t\tif (modal && modal.node) {\r\n\t\t\tthis.modal_ = modal;\r\n\t\t\tthis.modalNode.appendChild(modal.node);\r\n\t\t\tconst instances = module.compile(modal.node);\r\n\t\t}\r\n\t\tthis.modal_ = modal;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.modalNode = node.querySelector('.modal-outlet__modal');\r\n\t\tModalService.modal$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(modal => {\r\n\t\t\tthis.modal = modal;\r\n\t\t});\r\n\t}\r\n\r\n\treject(event) {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nModalOutletComponent.meta = {\r\n\tselector: '[modal-outlet]',\r\n\ttemplate: /* html */ `\r\n\t<div class=\"modal-outlet__container\" [class]=\"{ active: modal }\">\r\n\t\t<div class=\"modal-outlet__background\" (click)=\"reject($event)\"></div>\r\n\t\t<div class=\"modal-outlet__modal\"></div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport ModalOutletComponent from '../modal/modal-outlet.component';\r\nimport ModalService from '../modal/modal.service';\r\n\r\nexport default class TryInARModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tconst { parentInstance, node } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tconst data = this.data = parentInstance.modal.data;\r\n\t\t\t// console.log('data', data);\r\n\t\t\tif (data && data.ar) {\r\n\t\t\t\tconst url = TryInARModalComponent.getUrl(data);\r\n\t\t\t\tconst qrcode = new QRious({\r\n\t\t\t\t\telement: node.querySelector('.qrcode'),\r\n\t\t\t\t\tvalue: url,\r\n\t\t\t\t\tsize: 256\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\tstatic getUrl(data) {\r\n\t\tconst url = environment.getAbsoluteUrl(environment.template.tryInAr, { viewId: data.id });\r\n\t\tconsole.log('TryInARModalComponent.getUrl', url);\r\n\t\treturn url;\r\n\t}\r\n\r\n\tstatic openInAR(data) {\r\n\t\tconst url = this.getUrl(data);\r\n\t\twindow.open(url, '_blank');\r\n\t}\r\n\r\n}\r\n\r\nTryInARModalComponent.meta = {\r\n\tselector: '[try-in-ar-modal]'\r\n};\r\n","/* global THREE */\r\n\r\nimport { Subject } from \"rxjs\";\r\n\r\nexport const ViewType = {\r\n\tWaitingRoom: { id: 1, name: 'waiting-room' },\r\n\tPanorama: { id: 2, name: 'panorama' },\r\n\tPanoramaGrid: { id: 3, name: 'panorama-grid' },\r\n\tRoom3d: { id: 4, name: 'room-3d' },\r\n\tModel: { id: 5, name: 'model' },\r\n};\r\n\r\nexport const ViewItemType = {\r\n\tNav: { id: 1, name: 'nav' },\r\n\tPlane: { id: 2, name: 'plane' },\r\n\tCurvedPlane: { id: 3, name: 'curved-plane' },\r\n\tModel: { id: 4, name: 'model' },\r\n\tTexture: { id: 5, name: 'texture' },\r\n};\r\n\r\nexport class View {\r\n\t// 'liked'\r\n\tstatic allowedProps = ['id', 'type', 'name', 'hidden', 'likes', 'asset', 'items', 'orientation', 'zoom', 'ar', 'tiles', 'invertAxes', 'flipAxes'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t\tthis.updateIndices(options.items);\r\n\t\t}\r\n\t\tthis.items = (this.items || []).map(item => mapViewItem(item));\r\n\t\tif (this.tiles) {\r\n\t\t\tthis.tiles = this.tiles.map(tile => mapViewTile(tile));\r\n\t\t}\r\n\t\tthis.originalItems = this.items.slice();\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (View.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'items':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(item => mapViewItem(item).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'tiles':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(tile => mapViewTile(tile).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tpayload[key] = this[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n\r\n\tget shortType() {\r\n\t\treturn this.type ? this.type.split('-').map(x => x.substring(0, 1).toUpperCase()).join('') : '??';\r\n\t}\r\n\r\n\tupdateIndices(items) {\r\n\t\tif (items) {\r\n\t\t\tlet publisherStreamIndex = 0;\r\n\t\t\tlet attendeeStreamIndex = 0;\r\n\t\t\tlet smartDeviceStream = 0;\r\n\t\t\tlet publisherScreenIndex = 0;\r\n\t\t\tlet attendeeScreenIndex = 0;\r\n\t\t\titems.forEach((item, index) => {\r\n\t\t\t\titem.index = index;\r\n\t\t\t\tif (item.asset) {\r\n\t\t\t\t\tswitch(item.asset.file) {\r\n\t\t\t\t\t\tcase 'publisherStream':\r\n\t\t\t\t\t\t\titem.asset.index = publisherStreamIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'nextAttendeeStream':\r\n\t\t\t\t\t\t\titem.asset.index = attendeeStreamIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'smartDeviceStream':\r\n\t\t\t\t\t\t\titem.asset.index = smartDeviceStream++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'publisherScreen':\r\n\t\t\t\t\t\t\titem.asset.index = publisherScreenIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'attendeeScreen':\r\n\t\t\t\t\t\t\titem.asset.index = attendeeScreenIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t/*\r\n\t\t\t\tif (item.asset && item.asset.file === 'publisherStream') {\r\n\t\t\t\t\titem.asset.index = publisherStreamIndex++;\r\n\t\t\t\t}\r\n\t\t\t\tif (item.asset && item.asset.file === 'nextAttendeeStream') {\r\n\t\t\t\t\titem.asset.index = attendeeStreamIndex++;\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class PanoramaView extends View {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nexport class PanoramaGridView extends View {\r\n\r\n\tstatic mapTiles(tiles = [], flipAxes = false, invertAxes = false, folder = '') {\r\n\t\tconst axes = flipAxes ? -1 : 1;\r\n\t\treturn tiles.map((tile, i) => {\r\n\t\t\tconst indices = new THREE.Vector2();\r\n\t\t\ttile = typeof tile === 'string' ? { id: i + 1, asset: { folder: folder, file: tile }, navs: [] } : tile;\r\n\t\t\ttile.asset.file.replace(/_x([-|\\d]+)_y([-|\\d]+)/g, (a, b, c) => {\r\n\t\t\t\tif (invertAxes) {\r\n\t\t\t\t\tindices.y = parseInt(b);\r\n\t\t\t\t\tindices.x = parseInt(c) * axes;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tindices.x = parseInt(b);\r\n\t\t\t\t\tindices.y = parseInt(c) * axes;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn {\r\n\t\t\t\tid: tile.id,\r\n\t\t\t\tasset: tile.asset,\r\n\t\t\t\tnavs: tile.navs || [],\r\n\t\t\t\tindices,\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\r\n\tset index(index) {\r\n\t\tif (this.index_ !== index) {\r\n\t\t\tthis.index_ = index;\r\n\t\t\tthis.tiles.forEach((tile, i) => tile.selected = i === index);\r\n\t\t\tthis.updateCurrentItems();\r\n\t\t\t// console.log('PanoramaGridView.index.set', index, this.items);\r\n\t\t\tthis.index$.next(index);\r\n\t\t}\r\n\t}\r\n\tget index() {\r\n\t\treturn this.index_;\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\toptions.tiles = PanoramaGridView.mapTiles(options.tiles, options.flipAxes, options.invertAxes, options.asset ? options.asset.folder : '');\r\n\t\tsuper(options);\r\n\t\t/*\r\n\t\tif (!this.tiles.length) {\r\n\t\t\tthrow new Error('PanoramaGridView.constructor tile list is empty!');\r\n\t\t}\r\n\t\t*/\r\n\t\tthis.index_ = 0;\r\n\t\tthis.index$ = new Subject();\r\n\t\tthis.tiles.forEach((tile, i) => tile.selected = i === 0);\r\n\t\tif (this.tiles.length) {\r\n\t\t\tthis.items = this.originalItems.concat(this.tiles[0].navs);\r\n\t\t\tthis.asset = this.tiles[0].asset;\r\n\t\t}\r\n\t}\r\n\r\n\tupdateCurrentItems() {\r\n\t\tthis.items = this.originalItems.concat(this.tiles[this.index_].navs);\r\n\t}\r\n\r\n\tgetTileIndex(x, y) {\r\n\t\treturn this.tiles.reduce((p, c, i) => {\r\n\t\t\tif (c.indices.x === x && c.indices.y === y) {\r\n\t\t\t\treturn i;\r\n\t\t\t} else {\r\n\t\t\t\treturn p;\r\n\t\t\t}\r\n\t\t}, -1);\r\n\t}\r\n\thasTile(x, y) {\r\n\t\treturn this.getTileIndex(x, y) !== -1;\r\n\t}\r\n\tgetTile(x, y) {\r\n\t\tconst index = this.getTileIndex(x, y);\r\n\t\tif (index !== -1) {\r\n\t\t\tthis.index = index;\r\n\t\t\treturn this.tiles[index];\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ModelView extends View {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nexport class ViewItem {\r\n\tstatic allowedProps = ['id', 'type', 'title', 'abstract', 'asset', 'link', 'viewId', 'keepOrientation', 'position', 'rotation', 'scale', 'radius', 'height', 'arc'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (ViewItem.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tpayload[key] = this[key];\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (payload.link && (!payload.link.title || !payload.link.href)) {\r\n\t\t\tdelete payload.link;\r\n\t\t}\r\n\t\treturn payload;\r\n\t}\r\n\tget hasPanel() {\r\n\t\treturn this.type.name === ViewItemType.Nav.name && (\r\n\t\t\t(this.title && this.title !== '') ||\r\n\t\t\t(this.abstract && this.abstract !== '') ||\r\n\t\t\tthis.asset ||\r\n\t\t\tthis.link\r\n\t\t);\r\n\t}\r\n}\r\n\r\nexport class NavViewItem extends ViewItem {\r\n\r\n}\r\n\r\nexport class ViewTile {\r\n\tstatic allowedProps = ['id', 'asset', 'navs'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t\tthis.navs = (this.navs || []).map(nav => mapViewItem(nav));\r\n\t\tthis.originalItems = this.navs.slice();\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (ViewTile.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'navs':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(nav => mapViewItem(nav).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tpayload[key] = this[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n}\r\n\r\nexport function mapView(view) {\r\n\tswitch (view.type.name) {\r\n\t\tcase ViewType.Panorama.name:\r\n\t\t\tview = new PanoramaView(view);\r\n\t\t\tbreak;\r\n\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\tview = new PanoramaGridView(view);\r\n\t\t\tbreak;\r\n\t\tcase ViewType.Model.name:\r\n\t\t\tview = new ModelView(view);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tview = new View(view);\r\n\t}\r\n\treturn view;\r\n}\r\n\r\nexport function mapViewItem(item) {\r\n\tswitch (item.type.name) {\r\n\t\tcase ViewItemType.Nav.name:\r\n\t\t\titem = new NavViewItem(item);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\titem = new ViewItem(item);\r\n\t}\r\n\treturn item;\r\n}\r\n\r\nexport function mapViewTile(tile) {\r\n\treturn new ViewTile(tile);\r\n}\r\n","import { BehaviorSubject, combineLatest, of } from 'rxjs';\r\nimport { distinctUntilChanged, map, shareReplay, tap } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport HttpService from '../http/http.service';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { mapView } from '../view/view';\r\n\r\nexport default class ViewService {\r\n\r\n\t// action: { viewId:number, keepOrientation:boolean };\r\n\tstatic action$_ = new BehaviorSubject(null);\r\n\tstatic set action(action) {\r\n\t\tthis.action$_.next(action);\r\n\t}\r\n\tstatic get action() {\r\n\t\treturn this.action$_.getValue();\r\n\t}\r\n\r\n\t// static viewId$_ = new BehaviorSubject(null);\r\n\tstatic set viewId(viewId) {\r\n\t\tthis.action$_.next({ viewId, keepOrientation: false });\r\n\t}\r\n\tstatic get viewId() {\r\n\t\tconst action = this.action$_.getValue();\r\n\t\treturn action ? action.viewId : null;\r\n\t}\r\n\r\n\tstatic data$() {\r\n\t\tif (!this.data$_) {\r\n\t\t\tconst dataUrl = environment.flags.production ? '/api/view' : './api/data.json';\r\n\t\t\tthis.data$_ = HttpService.get$(dataUrl).pipe(\r\n\t\t\t\tmap(data => {\r\n\t\t\t\t\tdata.views = data.views.map(view => mapView(view));\r\n\t\t\t\t\treturn data;\r\n\t\t\t\t}),\r\n\t\t\t\t// tap(data => console.log('ViewService.data$', data)),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.data$_;\r\n\t}\r\n\r\n\tstatic view$(data, editor) {\r\n\t\tconst views = editor ? data.views : data.views.filter(x => x.type.name !== 'waiting-room');\r\n\t\tconst initialViewId = LocationService.has('viewId') ? parseInt(LocationService.get('viewId')) : (views.length ? views[0].id : null);\r\n\t\tthis.action$_.next({ viewId: initialViewId });\r\n\t\treturn this.action$_.pipe(\r\n\t\t\tdistinctUntilChanged((a, b) => a.viewId === b.viewId),\r\n\t\t\tmap(action => {\r\n\t\t\t\tconst view = data.views.find(view => view.id === action.viewId);\r\n\t\t\t\tif (view) {\r\n\t\t\t\t\tview.keepOrientation = action.keepOrientation || false;\r\n\t\t\t\t}\r\n\t\t\t\treturn view || this.getWaitingRoom(data);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic hostedView$(data) {\r\n\t\tconst waitingRoom = this.getWaitingRoom(data);\r\n\t\treturn combineLatest([this.view$(data), this.hosted$()]).pipe(\r\n\t\t\tmap(datas => {\r\n\t\t\t\tconst view = datas[0];\r\n\t\t\t\tconst hosted = datas[1];\r\n\t\t\t\treturn hosted ? view : waitingRoom;\r\n\t\t\t}),\r\n\t\t\ttap(view => {\r\n\t\t\t\tif (view.id !== waitingRoom.id) {\r\n\t\t\t\t\tLocationService.set('viewId', view.id);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic editorView$(data) {\r\n\t\tconst waitingRoom = this.getWaitingRoom(data);\r\n\t\treturn this.view$(data, true).pipe(\r\n\t\t\ttap(view => {\r\n\t\t\t\tif (view.id !== waitingRoom.id) {\r\n\t\t\t\t\tLocationService.set('viewId', view.id);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic hosted$() {\r\n\t\treturn StateService.state$.pipe(\r\n\t\t\tmap(state => state.hosted),\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewById$(viewId) {\r\n\t\treturn this.data$().pipe(\r\n\t\t\tmap(data => data.views.find(x => x.id === viewId))\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewLike$(view) {\r\n\t\tif (!view.liked) {\r\n\t\t\tview.liked = true;\r\n\t\t\tif (environment.flags.production) {\r\n\t\t\t\treturn HttpService.get$(`/api/view/${view.id}/like`);\r\n\t\t\t} else {\r\n\t\t\t\tview.likes = view.likes || 0;\r\n\t\t\t\tview.likes++;\r\n\t\t\t\treturn of(view);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic setViewLike$(message) {\r\n\t\treturn this.viewById$(message.viewId).pipe(\r\n\t\t\ttap(view => {\r\n\t\t\t\tif (view) {\r\n\t\t\t\t\tview.likes = message.likes;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getWaitingRoom(data) {\r\n\t\treturn data && data.views.find(x => x.type.name === 'waiting-room') || {\r\n\t\t\tid: 'waiting-room',\r\n\t\t\ttype: { id: 1, name: 'waiting-room' },\r\n\t\t\tname: 'Waiting Room',\r\n\t\t\tlikes: 0,\r\n\t\t\tliked: false,\r\n\t\t\tasset: {\r\n\t\t\t\ttype: { id: 1, name: 'image' },\r\n\t\t\t\tfolder: '/textures/waiting-room/',\r\n\t\t\t\tfile: 'waiting-room.jpg',\r\n\t\t\t},\r\n\t\t\titems: [],\r\n\t\t\torientation: {\r\n\t\t\t\tlatitude: 0,\r\n\t\t\t\tlongitude: 0\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n}\r\n","import { BehaviorSubject, Subject } from \"rxjs\";\r\n\r\nexport const XRStatus = {\r\n\tWaiting: 'waiting',\r\n\tEnabled: 'enabled',\r\n\tEnded: 'ended',\r\n\tStarted: 'started',\r\n\tDisabled: 'disabled',\r\n\tNeedsHttps: 'needs-https',\r\n\tUnavailable: 'unavailable',\r\n};\r\n\r\nexport default class VRService {\r\n\r\n\tstatic getService() {\r\n\t\tif (!this.service_) {\r\n\t\t\tthis.service_ = new VRService();\r\n\t\t}\r\n\t\treturn this.service_;\r\n\t}\r\n\r\n\tget status() {\r\n\t\treturn this.status$.getValue();\r\n\t}\r\n\r\n\tget state() {\r\n\t\treturn this.state$.getValue();\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tif (VRService.service_) {\r\n\t\t\tthrow ('VRService is a singleton class!');\r\n\t\t}\r\n\t\tconst state = this.state_ = {\r\n\t\t\tcamera: {\r\n\t\t\t\tposition: new THREE.Vector3(),\r\n\t\t\t\tquaternion: new THREE.Quaternion(),\r\n\t\t\t\tscale: new THREE.Vector3(),\r\n\t\t\t\tarray: new Array(3 + 4 + 3).fill(0),\r\n\t\t\t}\r\n\t\t};\r\n\t\tthis.onSessionStarted = this.onSessionStarted.bind(this);\r\n\t\tthis.onSessionEnded = this.onSessionEnded.bind(this);\r\n\t\tthis.status$ = new BehaviorSubject(XRStatus.Waiting);\r\n\t\tthis.session$ = new Subject();\r\n\t\tthis.state$ = new BehaviorSubject(state);\r\n\t\tthis.currentSession = null;\r\n\t\tif ('xr' in navigator) {\r\n\t\t\tnavigator.xr.isSessionSupported('immersive-vr').then((supported) => {\r\n\t\t\t\tif (supported) {\r\n\t\t\t\t\tthis.status$.next(XRStatus.Enabled);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.status$.next(XRStatus.Disabled);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tif (window.isSecureContext === false) {\r\n\t\t\t\tthis.status$.next(XRStatus.NeedsHttps);\r\n\t\t\t} else {\r\n\t\t\t\tthis.status$.next(XRStatus.Unavailable);\r\n\t\t\t\t// 'https://immersiveweb.dev/';\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonSessionStarted(session) {\r\n\t\tsession.addEventListener('end', this.onSessionEnded);\r\n\t\tthis.currentSession = session;\r\n\t\tthis.session$.next(session);\r\n\t\tthis.status$.next(XRStatus.Started);\r\n\t}\r\n\r\n\tonSessionEnded( /*event*/) {\r\n\t\tthis.currentSession.removeEventListener('end', this.onSessionEnded);\r\n\t\tthis.currentSession = null;\r\n\t\tthis.session$.next(null);\r\n\t\tthis.status$.next(XRStatus.Ended);\r\n\t}\r\n\r\n\ttoggleVR(event) {\r\n\t\tif (this.currentSession === null) {\r\n\t\t\t// WebXR's requestReferenceSpace only works if the corresponding feature\r\n\t\t\t// was requested at session creation time. For simplicity, just ask for\r\n\t\t\t// the interesting ones as optional features, but be aware that the\r\n\t\t\t// requestReferenceSpace call will fail if it turns out to be unavailable.\r\n\t\t\t// ('local' is always available for immersive sessions and doesn't need to\r\n\t\t\t// be requested separately.)\r\n\t\t\tconst sessionInit = { optionalFeatures: ['local-floor', 'bounded-floor'] };\r\n\t\t\tnavigator.xr.requestSession('immersive-vr', sessionInit).then(this.onSessionStarted);\r\n\t\t} else {\r\n\t\t\tthis.currentSession.end();\r\n\t\t}\r\n\t}\r\n\r\n\tisDisabled() {\r\n\t\tconst status = this.status$.getValue();\r\n\t\tswitch (status) {\r\n\t\t\tcase XRStatus.Waiting:\r\n\t\t\tcase XRStatus.Disabled:\r\n\t\t\tcase XRStatus.NeedsHttps:\r\n\t\t\tcase XRStatus.Unavailable:\r\n\t\t\t\treturn true;\r\n\t\t\tdefault:\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tgetLabel() {\r\n\t\tlet label;\r\n\t\tconst status = this.status$.getValue();\r\n\t\tswitch (status) {\r\n\t\t\tcase XRStatus.Waiting:\r\n\t\t\t\tlabel = 'Waiting VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Enabled:\r\n\t\t\tcase XRStatus.Ended:\r\n\t\t\t\tlabel = 'Enter VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Started:\r\n\t\t\t\tlabel = 'Exit VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Disabled:\r\n\t\t\t\tlabel = 'VR Disabled';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.NeedsHttps:\r\n\t\t\t\tlabel = 'VR Needs Https';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Unavailable:\r\n\t\t\t\tlabel = 'VR Unavailable';\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\treturn label;\r\n\t}\r\n\r\n\tupdateState(world) {\r\n\t\tif (this.status === XRStatus.Started) {\r\n\t\t\tconst renderer = world.renderer,\r\n\t\t\t\tscene = world.scene,\r\n\t\t\t\tcamera = world.camera,\r\n\t\t\t\tstate = this.state_;\r\n\t\t\tcamera.matrixWorld.decompose(state.camera.position, state.camera.quaternion, state.camera.scale);\r\n\t\t\tstate.camera.array[0] = state.camera.position.x;\r\n\t\t\tstate.camera.array[1] = state.camera.position.y;\r\n\t\t\tstate.camera.array[2] = state.camera.position.z;\r\n\t\t\tstate.camera.array[3] = state.camera.quaternion.x;\r\n\t\t\tstate.camera.array[4] = state.camera.quaternion.y;\r\n\t\t\tstate.camera.array[5] = state.camera.quaternion.z;\r\n\t\t\tstate.camera.array[6] = state.camera.quaternion.w;\r\n\t\t\tstate.camera.array[7] = state.camera.scale.x;\r\n\t\t\tstate.camera.array[8] = state.camera.scale.y;\r\n\t\t\tstate.camera.array[9] = state.camera.scale.z;\r\n\t\t\tthis.state$.next(state);\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { first, switchMap, takeUntil, tap } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport { DEBUG, environment } from '../environment';\r\nimport GtmService from '../gtm/gtm.service';\r\nimport LocalStorageService from '../local-storage/local-storage.service';\r\nimport LocationService from '../location/location.service';\r\nimport MessageService from '../message/message.service';\r\nimport ModalService from '../modal/modal.service';\r\nimport StateService from '../state/state.service';\r\nimport StreamService from '../stream/stream.service';\r\nimport TryInARModalComponent from '../try-in-ar/try-in-ar-modal.component';\r\nimport { RoleType } from '../user/user';\r\nimport { UserService } from '../user/user.service';\r\nimport { PanoramaGridView } from '../view/view';\r\nimport ViewService from '../view/view.service';\r\nimport VRService from '../world/vr.service';\r\nimport AgoraService from './agora.service';\r\nimport { AgoraStatus, MessageType } from './agora.types';\r\n\r\nexport default class AgoraComponent extends Component {\r\n\r\n\tget uiClass() {\r\n\t\tconst uiClass = {};\r\n\t\tuiClass[this.state.role] = true;\r\n\t\tuiClass.chat = this.state.chat;\r\n\t\treturn uiClass;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t\tthis.env = environment;\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.state = {};\r\n\t\tthis.hosted = null;\r\n\t\tthis.data = null;\r\n\t\tthis.views = null;\r\n\t\tthis.view = null;\r\n\t\tthis.form = null;\r\n\t\tthis.local = null;\r\n\t\tthis.screen = null;\r\n\t\tthis.remotes = [];\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.status$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(status => this.pushChanges());\r\n\t\tthis.resolveUser();\r\n\t}\r\n\r\n\tgetLinkRole() {\r\n\t\tlet linkRole = null;\r\n\t\tconst match = (LocationService.get('link') || '').match(/\\d{9}-(\\d{4})-\\d{13}/);\r\n\t\tif (match) {\r\n\t\t\tconst index = parseInt(match[1]);\r\n\t\t\tlinkRole = Object.keys(RoleType).reduce((p, c, i) => {\r\n\t\t\t\treturn i === index ? RoleType[c] : p;\r\n\t\t\t}, null)\r\n\t\t}\r\n\t\treturn linkRole;\r\n\t}\r\n\r\n\tresolveUser() {\r\n\t\tUserService.me$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(user => {\r\n\t\t\tthis.initWithUser(user);\r\n\t\t\t// this.userGuard(user);\r\n\t\t});\r\n\t}\r\n\r\n\tuserGuard(user) {\r\n\t\tconst linkRole = this.getLinkRole();\r\n\t\tif (user && (!linkRole || user.type === linkRole)) {\r\n\t\t\tthis.initWithUser(user);\r\n\t\t} else {\r\n\t\t\tthis.initWithUser({ type: linkRole });\r\n\t\t}\r\n\t}\r\n\r\n\tuserGuardRedirect(user) {\r\n\t\tconst linkRole = this.getLinkRole();\r\n\t\tif (user && (!linkRole || linkRole === user.type)) {\r\n\t\t\tthis.initWithUser(user);\r\n\t\t} else if (linkRole === RoleType.Publisher || linkRole === RoleType.Attendee) {\r\n\t\t\twindow.location.href = environment.url.access;\r\n\t\t} else {\r\n\t\t\tthis.initWithUser({ type: linkRole });\r\n\t\t}\r\n\t}\r\n\r\n\tsetNextStatus() {\r\n\t\tlet status = AgoraStatus.Idle;\r\n\t\tconst state = StateService.state;\r\n\t\tif (state.role === RoleType.SmartDevice) {\r\n\t\t\tstate.name = state.name || 'Smart Device';\r\n\t\t}\r\n\t\tif (!state.checklist) {\r\n\t\t\tstatus = AgoraStatus.Checklist;\r\n\t\t} else if (!state.link) {\r\n\t\t\tstatus = AgoraStatus.Link;\r\n\t\t} else if (!state.user.id && (state.role === RoleType.Publisher || state.role === RoleType.Attendee)) {\r\n\t\t\tstatus = AgoraStatus.Login;\r\n\t\t} else if (!state.name) {\r\n\t\t\tstatus = AgoraStatus.Name;\r\n\t\t} else if (state.role !== RoleType.Viewer && state.role !== RoleType.SmartDevice) {\r\n\t\t\tstatus = AgoraStatus.Device;\r\n\t\t} else {\r\n\t\t\tstatus = AgoraStatus.ShouldConnect;\r\n\t\t}\r\n\t\tStateService.patchState({ status });\r\n\t\treturn status;\r\n\t}\r\n\r\n\tinitWithUser(user) {\r\n\t\tconsole.log('initWithUser', user);\r\n\t\tconst link = LocationService.get('link') || null;\r\n\t\tconst role = this.getLinkRole() || (user ? user.type : null);\r\n\t\tuser = user || { type: role };\r\n\t\tif (role !== user.type) {\r\n\t\t\tuser = { type: role };\r\n\t\t}\r\n\t\tconst has3D = role !== RoleType.SmartDevice;\r\n\t\tconst name = LocationService.get('name') || (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null);\r\n\t\tconst checklist = LocalStorageService.get('checklist') || null;\r\n\t\tconst hosted = role === RoleType.Publisher ? true : false;\r\n\t\tconst live = (DEBUG || role === RoleType.SelfService) ? false : true;\r\n\t\tconst state = {\r\n\t\t\tuser: user,\r\n\t\t\trole: role,\r\n\t\t\thas3D: has3D,\r\n\t\t\tname: name,\r\n\t\t\tchecklist: checklist,\r\n\t\t\tlink: link,\r\n\t\t\tchannelName: environment.channelName,\r\n\t\t\tuid: null,\r\n\t\t\tstatus: 'idle',\r\n\t\t\tconnecting: false,\r\n\t\t\tconnected: false,\r\n\t\t\tlocked: false,\r\n\t\t\tcontrol: false,\r\n\t\t\tspyed: false,\r\n\t\t\thosted: hosted,\r\n\t\t\tlive: live,\r\n\t\t\tcameraMuted: false,\r\n\t\t\taudioMuted: false,\r\n\t\t};\r\n\t\tStateService.state = state;\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.hosted = state.hosted;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// console.log(state);\r\n\t\t});\r\n\t\tthis.initAgora();\r\n\t\tthis.viewObserver$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(view => {\r\n\t\t\t// console.log('AgoraComponent.viewObserver$', view);\r\n\t\t});\r\n\t}\r\n\r\n\tviewObserver$() {\r\n\t\treturn ViewService.data$().pipe(\r\n\t\t\tswitchMap(data => {\r\n\t\t\t\tthis.data = data;\r\n\t\t\t\tthis.views = data.views.filter(x => x.type.name !== 'waiting-room');\r\n\t\t\t\treturn ViewService.hostedView$(data);\r\n\t\t\t}),\r\n\t\t\t/*\r\n\t\t\ttap(view => {\r\n\t\t\t\tthis.view = null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t\tdelay(1),\r\n\t\t\t*/\r\n\t\t\ttap(view => {\r\n\t\t\t\t// !!! move navToView to user action?\r\n\t\t\t\tif (this.agora) {\r\n\t\t\t\t\tthis.agora.navToView(view.id);\r\n\t\t\t\t}\r\n\t\t\t\tthis.view = view;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tinitAgora() {\r\n\t\tlet agora = null;\r\n\t\tif (DEBUG || this.state.role === RoleType.SelfService) {\r\n\t\t\tStateService.patchState({ status: AgoraStatus.Connected, hosted: true });\r\n\t\t} else {\r\n\t\t\tagora = this.agora = AgoraService.getSingleton();\r\n\t\t\tconst role = this.getLinkRole();\r\n\t\t\tconst status = this.setNextStatus();\r\n\t\t\t// console.log('initAgora', status, role);\r\n\t\t}\r\n\t\tStreamService.local$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(local => {\r\n\t\t\t// console.log('AgoraComponent.local', local);\r\n\t\t\tthis.local = local;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStreamService.screen$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(screen => {\r\n\t\t\t// console.log('AgoraComponent.screen', screen);\r\n\t\t\tthis.screen = screen;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStreamService.orderedRemotes$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(remotes => {\r\n\t\t\t// console.log('AgoraComponent.remotes', remotes);\r\n\t\t\tthis.remotes = remotes;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// console.log('AgoraComponent.message', message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.RequestPeerInfo:\r\n\t\t\t\t\tmessage.type = MessageType.RequestPeerInfoResult;\r\n\t\t\t\t\tmessage.clientInfo = {\r\n\t\t\t\t\t\trole: StateService.state.role,\r\n\t\t\t\t\t\tname: StateService.state.name,\r\n\t\t\t\t\t\tuid: StateService.state.uid,\r\n\t\t\t\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t\t\t\t\tcontrol: StateService.state.control,\r\n\t\t\t\t\t};\r\n\t\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.RequestControl:\r\n\t\t\t\t\t// console.log('AgoraComponent', 'MessageType.RequestControlAccepted');\r\n\t\t\t\t\tmessage.type = MessageType.RequestControlAccepted;\r\n\t\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\t\tStateService.patchState({ locked: true });\r\n\t\t\t\t\tif (this.agora) {\r\n\t\t\t\t\t\tthis.agora.sendControlRemoteRequestInfo(message.clientId);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// !!! control request permission not required\r\n\t\t\t\t\t// this.onRemoteControlRequest(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t// !!! moved to WorldComponent\r\n\t\t\t\t/*\r\n\t\t\t\tcase MessageType.RequestInfo:\r\n\t\t\t\t\tif (StateService.state.role !== RoleType.Publisher) {\r\n\t\t\t\t\t\tStateService.patchState({ spyed: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.RequestInfoResult:\r\n\t\t\t\t\tconsole.log('AgoraComponent.RequestInfoResult', ViewService.viewId, message.viewId);\r\n\t\t\t\t\tViewService.viewId = message.viewId;\r\n\t\t\t\t\t// console.log('AgoraComponent.RequestInfoResult', message.viewId);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t*/\r\n\t\t\t\tcase MessageType.NavToView:\r\n\t\t\t\t\tthis.onRemoteNavTo(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.AddLike:\r\n\t\t\t\t\tViewService.setViewLike$(message).pipe(\r\n\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t).subscribe(view => this.showLove(view));\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\tif (!StateService.state.chat) {\r\n\t\t\t\t\t\tStateService.patchState({ chatDirty: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tMessageService.in$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\tif (agora) {\r\n\t\t\t\tagora.sendMessage(message);\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (agora && StateService.state.status === AgoraStatus.ShouldConnect) {\r\n\t\t\tthis.connect();\r\n\t\t}\r\n\t}\r\n\r\n\tonChecked(checklist) {\r\n\t\t// console.log('AgoraComponent.onChecked', checklist);\r\n\t\tStateService.patchState({ checklist: true });\r\n\t\tthis.setNextStatus();\r\n\t}\r\n\r\n\tonLink(link) {\r\n\t\tconst role = this.getLinkRole();\r\n\t\tconst has3D = role !== RoleType.SmartDevice;\r\n\t\tconst user = StateService.state.user;\r\n\t\tif ((role === RoleType.Publisher || role === RoleType.Attendee) && (!user.id || user.type !== role)) {\r\n\t\t\tStateService.patchState({ link, role, has3D, status: AgoraStatus.Login });\r\n\t\t} else if (StateService.state.name) {\r\n\t\t\tif (role === RoleType.Viewer || role === RoleType.SmartDevice) {\r\n\t\t\t\tStateService.patchState({ link, role, has3D });\r\n\t\t\t\tthis.connect();\r\n\t\t\t} else {\r\n\t\t\t\tStateService.patchState({ link, role, has3D, status: AgoraStatus.Device });\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ link, role, has3D, status: AgoraStatus.Name });\r\n\t\t}\r\n\t}\r\n\r\n\tonLogin(user) {\r\n\t\tconst name = StateService.state.name || (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null);\r\n\t\tif (name) {\r\n\t\t\tStateService.patchState({ user, name, status: AgoraStatus.Device });\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ user, status: AgoraStatus.Name });\r\n\t\t}\r\n\t}\r\n\r\n\tonName(name) {\r\n\t\tif (StateService.state.role === RoleType.Viewer || StateService.state.role === RoleType.SmartDevice) {\r\n\t\t\tStateService.patchState({ name });\r\n\t\t\tthis.connect();\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ name, status: AgoraStatus.Device });\r\n\t\t}\r\n\t}\r\n\r\n\tonEnter(preferences) {\r\n\t\tthis.connect(preferences);\r\n\t}\r\n\r\n\tconnect(preferences) {\r\n\t\tthis.agora.connect$(preferences).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\t// console.log('AgoraComponent.connect', this.state.role);\r\n\t\tif (this.state.role !== RoleType.SelfService) {\r\n\t\t\tconst sharedMeetingId = this.state.link.replace(/-\\d+-/, '-');\r\n\t\t\tconst log = {\r\n\t\t\t\tmeetingId: this.state.link,\r\n\t\t\t\tsharedMeetingId: sharedMeetingId,\r\n\t\t\t\tfullName: this.state.name,\r\n\t\t\t\tuserType: this.state.role\r\n\t\t\t};\r\n\t\t\t// console.log('AgoraComponent.connect', log);\r\n\t\t\tUserService.log$(log).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe();\r\n\t\t\tGtmService.push({\r\n\t\t\t\taction: 'b-here-meeting',\r\n\t\t\t\tmeetingId: this.state.link,\r\n\t\t\t\tsharedMeetingId: sharedMeetingId,\r\n\t\t\t\tuserType: this.state.role\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tdisconnect() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.leaveChannel().then(() => {\r\n\t\t\t\t// StateService.patchState({ status: AgoraStatus.Disconnected, connected: false });\r\n\t\t\t\twindow.location.href = window.location.href;\r\n\t\t\t}, console.log);\r\n\t\t} else {\r\n\t\t\tthis.patchState({ connecting: false, connected: false });\r\n\t\t}\r\n\t}\r\n\r\n\tonNavTo(navItem) {\r\n\t\tconst viewId = navItem.viewId;\r\n\t\tconst view = this.data.views.find(x => x.id === viewId);\r\n\t\tif (view) {\r\n\t\t\tViewService.action = { viewId, keepOrientation: navItem.keepOrientation };\r\n\t\t}\r\n\t}\r\n\r\n\tonRemoteNavTo(message) {\r\n\t\tconst viewId = message.viewId;\r\n\t\tconst gridIndex = message.gridIndex;\r\n\t\tif (viewId && ViewService.viewId !== viewId) {\r\n\t\t\tconst view = this.data.views.find(x => x.id === viewId);\r\n\t\t\tif (view) {\r\n\t\t\t\tViewService.action = { viewId, keepOrientation: message.keepOrientation };\r\n\t\t\t\tif (gridIndex != null && view instanceof PanoramaGridView) {\r\n\t\t\t\t\tview.index = gridIndex;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// console.log('AgoraComponent.onRemoteNavTo', viewId, gridIndex);\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\tonRemoteControlRequest(message) {\r\n\t\tModalService.open$({ src: environment.template.modal.controlRequest, data: null }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (!DEBUG) {\r\n\t\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\t\tmessage.type = MessageType.RequestControlAccepted;\r\n\t\t\t\t\tthis.state.locked = true;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmessage.type = MessageType.RequestControlRejected;\r\n\t\t\t\t\tthis.state.locked = false;\r\n\t\t\t\t}\r\n\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t} else {\r\n\t\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\t\tthis.patchState({ control: true, spying: false });\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.patchState({ control: false, spying: false });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\t// !!! why locally?\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.pushChanges();\r\n\t\t// console.log(this.state);\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleCamera();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ cameraMuted: !this.state.cameraMuted });\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleAudio();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ audioMuted: !this.state.audioMuted });\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleScreen() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleScreen();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ screen: !this.state.screen });\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleVolume() {\r\n\t\tconst volumeMuted = !this.state.volumeMuted;\r\n\t\tStateService.patchState({ volumeMuted })\r\n\t}\r\n\r\n\ttoggleChat() {\r\n\t\tStateService.patchState({ chat: !this.state.chat, chatDirty: false });\r\n\t}\r\n\r\n\tonChatClose() {\r\n\t\tthis.patchState({ chat: false });\r\n\t}\r\n\r\n\tonToggleControl() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleControl();\r\n\t\t} else if (this.state.control) {\r\n\t\t\tthis.patchState({ control: false });\r\n\t\t}/* else {\r\n\t\t\tthis.onRemoteControlRequest({});\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tonToggleSpy(remoteId) {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleSpy(remoteId);\r\n\t\t} else {\r\n\t\t\tthis.patchState({ spying: !this.state.spying, control: false });\r\n\t\t}\r\n\t}\r\n\r\n\taddLike() {\r\n\t\tViewService.viewLike$(this.view).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe((view) => {\r\n\t\t\tif (view) {\r\n\t\t\t\tthis.view.liked = true; // view.liked;\r\n\t\t\t\tthis.showLove(view);\r\n\t\t\t\t// this.view.likes = view.likes;\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t\tMessageService.send({\r\n\t\t\t\t\ttype: MessageType.AddLike,\r\n\t\t\t\t\tviewId: this.view.id,\r\n\t\t\t\t\tlikes: this.view.likes,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tshowLove(view) {\r\n\t\tif (view && this.view.id === view.id) {\r\n\t\t\tconst skipTimeout = this.view.showLove;\r\n\t\t\tthis.view.likes = view.likes;\r\n\t\t\tthis.view.showLove = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (!skipTimeout) {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.view.showLove = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 3100);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttryInAr() {\r\n\t\tif (this.platform === DevicePlatform.IOS || this.platform === DevicePlatform.Android) {\r\n\t\t\tTryInARModalComponent.openInAR(this.view);\r\n\t\t} else {\r\n\t\t\tModalService.open$({ src: environment.template.modal.tryInAr, data: this.view }).pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(event => {\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\tonPrevent(event) {\r\n\t\tevent.preventDefault();\r\n\t\tevent.stopImmediatePropagation();\r\n\t}\r\n\t*/\r\n}\r\n\r\nAgoraComponent.meta = {\r\n\tselector: '[agora-component]',\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\n\r\nexport default class AppComponent extends Component {\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t}\r\n}\r\n\r\nAppComponent.meta = {\r\n\tselector: '[app-component]',\r\n};\r\n","import { environment } from \"../environment\";\r\n\r\nexport const EXT_IMAGE = [\r\n\t'jpeg', 'jpg', 'png',\r\n];\r\nexport const EXT_VIDEO = [\r\n\t'mp4', 'webm',\r\n];\r\nexport const EXT_MODEL = [\r\n\t'fbx', 'gltf', 'glb', 'usdz'\r\n];\r\n\r\nexport const AssetType = {\r\n\tImage: { id: 1, name: 'image' }, // jpg, png, ...\r\n\tVideo: { id: 2, name: 'video' }, // mp4, webm, ...\r\n\tModel: { id: 3, name: 'model' }, // fbx, gltf, glb, usdz ...\r\n\tPublisherStream: { id: 4, name: 'publisher-stream', file: 'publisherStream' }, // valore fisso di file a ‘publisherStream’ e folder string.empty\r\n\tAttendeeStream: { id: 5, name: 'next-attendee-stream', file: 'nextAttendeeStream' }, // valore fisso di file a ‘nextAttendeeStream’ e folder string.empty\r\n\tPublisherScreen: { id: 6, name: 'publisher-screen', file: 'publisherScreen' }, // valore fisso di file a ‘publisherScreen’ e folder string.empty\r\n\tAttendeeScreen: { id: 7, name: 'attendee-screen', file: 'attendeeScreen' }, // valore fisso di file a ‘attendeeScreen’ e folder string.empty\r\n\tSmartDeviceStream: { id: 8, name: 'smart-device-stream', file: 'smartDeviceStream' }, // valore fisso di file a smartDeviceStream e folder string.empty\r\n};\r\n\r\nexport const AssetGroupType = {\r\n\tImageOrVideo: { id: 1, name: 'Image or Video', ids: [1, 2] },\r\n\t// Model: { id: 2, name: 'Model 3D', ids: [3] },\r\n\tPublisher: { id: 3, name: 'Publisher', ids: [4] },\r\n\tAttendee: { id: 4, name: 'Attendee', ids: [5] },\r\n\t// PublisherScreen: { id: 5, name: 'PublisherScreen', ids: [6] },\r\n\t// AttendeeScreen: { id: 6, name: 'AttendeeScreen', ids: [7] },\r\n};\r\n\r\nif (environment.flags.editorAssetScreen) {\r\n\tAssetGroupType.PublisherScreen = { id: 5, name: 'PublisherScreen', ids: [6] };\r\n\tAssetGroupType.AttendeeScreen = { id: 6, name: 'AttendeeScreen', ids: [7] };\r\n}\r\n\r\nAssetGroupType.SmartDevice = { id: 7, name: 'Smart Device', ids: [8] };\r\n\r\nexport const STREAM_TYPES = [\r\n\tAssetType.PublisherStream.name,\r\n\tAssetType.AttendeeStream.name,\r\n\tAssetType.PublisherScreen.name,\r\n\tAssetType.AttendeeScreen.name,\r\n\tAssetType.SmartDeviceStream.name,\r\n];\r\n\r\nexport function assetIsStream(asset) {\r\n\treturn asset && STREAM_TYPES.indexOf(asset.type.name) !== -1;\r\n}\r\n\r\nexport function assetTypeById(id) {\r\n\tconst type = Object.keys(AssetType).reduce((p, key) => {\r\n\t\tconst type = AssetType[key];\r\n\t\treturn type.id === id ? type : p;\r\n\t}, null);\r\n\treturn type;\r\n\t// return Object.keys(AssetType).map(x => AssetType[x]).find(x => x.id === id);\r\n}\r\n\r\nexport function assetGroupTypeById(id) {\r\n\tconst type = Object.keys(AssetGroupType).reduce((p, key) => {\r\n\t\tconst type = AssetGroupType[key];\r\n\t\treturn type.id === id ? type : p;\r\n\t}, null);\r\n\treturn type;\r\n\t// return Object.keys(AssetGroupType).map(x => AssetGroupType[x]).find(x => x.id === id);\r\n}\r\n\r\nexport function assetGroupTypeFromItem(item) {\r\n\tlet key;\r\n\tif (item && item.asset) {\r\n\t\tkey = Object.keys(AssetGroupType).find(key => {\r\n\t\t\t// console.log(key, AssetGroupType[key].ids, item.asset.type.id);\r\n\t\t\treturn AssetGroupType[key].ids.indexOf(item.asset.type.id) !== -1;\r\n\t\t});\r\n\t}\r\n\treturn AssetGroupType[key || 'ImageOrVideo'];\r\n}\r\n\r\nexport function assetPayloadFromGroupTypeId(groupTypeId) {\r\n\tconst groupType = assetGroupTypeById(groupTypeId);\r\n\tconst type = assetTypeById(groupType.ids[0]);\r\n\tconst file = type.file;\r\n\tconst asset = {\r\n\t\ttype: type,\r\n\t\tfolder: '',\r\n\t\tfile: file,\r\n\t}\r\n\tconsole.log('assetPayloadFromGroupTypeId', asset);\r\n\treturn new Asset(asset);\r\n}\r\n\r\nexport function assetTypeFromPath(path) {\r\n\tconst extension = path.split('.').pop().toLowerCase();\r\n\tif (EXT_IMAGE.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Image;\r\n\t} else if (EXT_VIDEO.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Video;\r\n\t} else if (EXT_MODEL.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Model;\r\n\t}\r\n}\r\n\r\nexport function isAssetType(path, type) {\r\n\tconst assetType = assetTypeFromPath(path);\r\n\treturn assetType === type;\r\n}\r\n\r\nexport class Asset {\r\n\tstatic allowedProps = ['id', 'type', 'folder', 'file', 'linkedPlayId', 'chromaKeyColor'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (Asset.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tpayload[key] = this[key];\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n\tstatic fromUrl(url) {\r\n\t\tconst segments = url.split('/');\r\n\t\tconst file = segments.pop();\r\n\t\tconst folder = segments.join('/') + '/';\r\n\t\tconst type = assetTypeFromPath(file);\r\n\t\treturn new Asset({\r\n\t\t\ttype: type,\r\n\t\t\tfolder: folder,\r\n\t\t\tfile: file,\r\n\t\t});\r\n\t}\r\n}\r\n\r\nexport function mapAsset(asset) {\r\n\tswitch (asset.type) {\r\n\t\tdefault:\r\n\t\t\tasset = new Asset(asset);\r\n\t}\r\n\treturn asset;\r\n}\r\n","import { Pipe } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport { AssetType } from './asset';\r\n\r\nexport const MIME_IMAGE = [\r\n\t'bmp', 'gif', 'ico', 'jpeg', 'jpg', 'png', 'svg', 'tif', 'tiff', 'webp',\r\n];\r\nexport const MIME_AUDIO = [\r\n\t'aac', 'mid', 'midi', 'mp3', 'oga', 'opus', 'wav', 'weba',\r\n];\r\nexport const MIME_VIDEO = [\r\n\t'mp4', 'avi', 'mpeg', 'ogv', 'ts', 'webm', '3gp', '3g2',\r\n];\r\nexport const MIME_MODEL = [\r\n\t'fbx', 'gltf', 'glb', 'obj', 'usdz',\r\n];\r\nexport const MIME_STREAM = [\r\n\t'publisherStream', 'nextAttendeeStream', 'publisherScreen', 'attendeeScreen',\r\n];\r\nexport function isImage(path) {\r\n\treturn new RegExp(`/\\.(${MIME_IMAGE.join('|')})$/i`).test(path);\r\n}\r\nexport function isVideo(path) {\r\n\treturn new RegExp(`/\\.(${MIME_VIDEO.join('|')})$/i`).test(path);\r\n}\r\nexport function isModel(path) {\r\n\treturn new RegExp(`/\\.(${MIME_MODEL.join('|')})$/i`).test(path);\r\n}\r\nexport function isStream(path) {\r\n\treturn MIME_STREAM.indexOf(path) !== -1;\r\n}\r\nexport default class AssetPipe extends Pipe {\r\n\tstatic transform(asset, type = null) {\r\n\t\tif (type != null) { // keep loose equality\r\n\t\t\tasset = asset.type.name === type ? asset : null;\r\n\t\t}\r\n\t\tif (asset) {\r\n\t\t\t// console.log(asset.type.name, AssetType.Image.name);\r\n\t\t\tswitch (asset.type.name) {\r\n\t\t\t\tcase AssetType.Image.name:\r\n\t\t\t\tcase AssetType.Video.name:\r\n\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase AssetType.Model.name:\r\n\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase AssetType.PublisherStream.name:\r\n\t\t\t\tcase AssetType.AttendeeStream.name:\r\n\t\t\t\tcase AssetType.PublisherScreen.name:\r\n\t\t\t\tcase AssetType.AttendeeScreen.name:\r\n\t\t\t\tcase AssetType.SmartDeviceStream.name:\r\n\t\t\t\t\tasset = environment.getPath(asset.file);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tif (isImage(asset.file) || isVideo(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\t} else if (isModel(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\t} else if (isStream(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.file;\r\n\t\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tasset = asset;\r\n\t\t} else {\r\n\t\t\tasset = null;\r\n\t\t}\r\n\t\t// console.log('AssetPipe.transform', asset);\r\n\t\treturn asset;\r\n\t}\r\n}\r\nAssetPipe.meta = {\r\n\tname: 'asset',\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from '../modal/modal-outlet.component';\r\nimport ModalService from '../modal/modal.service';\r\n\r\nexport default class ControlRequestModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tthis.data = parentInstance.modal.data;\r\n\t\t}\r\n\t}\r\n\r\n\tonAccept(user) {\r\n\t\tModalService.resolve();\r\n\t}\r\n\r\n\tonReject(user) {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\t/*\r\n\tonDestroy() {\r\n\t\t// console.log('ControlRequestModalComponent.onDestroy');\r\n\t}\r\n\t*/\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nControlRequestModalComponent.meta = {\r\n\tselector: '[control-request-modal]'\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\nimport { fromEvent } from 'rxjs';\r\nimport { shareReplay, takeUntil } from 'rxjs/operators';\r\n\r\nexport default class DropDirective extends Directive {\r\n\r\n\tonInit() {\r\n\t\tconst { module, node, parentInstance, selector } = getContext(this);\r\n\t\tconst event = 'drop';\r\n\t\tconst event$ = fromEvent(node, event).pipe(shareReplay(1));\r\n\t\tconst expression = node.getAttribute(`(${event})`);\r\n\t\tif (expression) {\r\n\t\t\tconst outputFunction = module.makeFunction(expression, ['$event']);\r\n\t\t\tevent$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(event => {\r\n\t\t\t\tmodule.resolve(outputFunction, parentInstance, event);\r\n\t\t\t});\r\n\t\t\tfromEvent(node, 'dragover').pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(event => event.preventDefault());\r\n\t\t} else {\r\n\t\t\tparentInstance[`${event}$`] = event$;\r\n\t\t}\r\n\t\t// console.log('DropDirective.onInit', 'selector', selector, 'event', event);\r\n\t}\r\n\r\n}\r\n\r\nDropDirective.meta = {\r\n\tselector: `[(drop)]`,\r\n};\r\n","import { Directive, getContext } from \"rxcomp\";\r\nimport { BehaviorSubject } from \"rxjs\";\r\nimport { takeUntil } from \"rxjs/operators\";\r\n\r\nlet DROPDOWN_ID = 1000000;\r\n\r\nexport default class DropdownDirective extends Directive {\r\n\r\n\tget id() {\r\n\t\treturn this.dropdown || this.id_ || (this.id_ = DropdownDirective.nextId());\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst trigger = node.getAttribute('dropdown-trigger');\r\n\t\tthis.trigger = trigger ? node.querySelector(trigger) : node;\r\n\t\tthis.opened = null;\r\n\t\tthis.onClick = this.onClick.bind(this);\r\n\t\tthis.onDocumentClick = this.onDocumentClick.bind(this);\r\n\t\tthis.openDropdown = this.openDropdown.bind(this);\r\n\t\tthis.closeDropdown = this.closeDropdown.bind(this);\r\n\t\tthis.addListeners();\r\n\t\tDropdownDirective.dropdown$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(id => {\r\n\t\t\t// console.log('DropdownDirective', id, this['dropdown-item']);\r\n\t\t\tif (this.id === id) {\r\n\t\t\t\tnode.classList.add('dropped');\r\n\t\t\t} else {\r\n\t\t\t\tnode.classList.remove('dropped');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonClick(event) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (this.opened === null) {\r\n\t\t\tthis.openDropdown();\r\n\t\t} else {\r\n\t\t\tconst dropdownItemNode = node.querySelector('[dropdown-item]');\r\n\t\t\t// console.log('dropdownItemNode', dropdownItemNode);\r\n\t\t\tif (!dropdownItemNode) { // if (this.trigger !== node) {\r\n\t\t\t\tthis.closeDropdown();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDocumentClick(event) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst clickedInside = node === event.target || node.contains(event.target);\r\n\t\tif (!clickedInside) {\r\n\t\t\tthis.closeDropdown();\r\n\t\t}\r\n\t}\r\n\r\n\topenDropdown() {\r\n\t\tif (this.opened === null) {\r\n\t\t\tthis.opened = true;\r\n\t\t\tthis.addDocumentListeners();\r\n\t\t\tDropdownDirective.dropdown$.next(this.id);\r\n\t\t\tthis.dropped.next(this.id);\r\n\t\t}\r\n\t}\r\n\r\n\tcloseDropdown() {\r\n\t\tif (this.opened !== null) {\r\n\t\t\tthis.removeDocumentListeners();\r\n\t\t\tthis.opened = null;\r\n\t\t\tif (DropdownDirective.dropdown$.getValue() === this.id) {\r\n\t\t\t\tDropdownDirective.dropdown$.next(null);\r\n\t\t\t\tthis.dropped.next(null);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddListeners() {\r\n\t\tthis.trigger.addEventListener('click', this.onClick);\r\n\t}\r\n\r\n\taddDocumentListeners() {\r\n\t\tdocument.addEventListener('click', this.onDocumentClick);\r\n\t}\r\n\r\n\tremoveListeners() {\r\n\t\tthis.trigger.removeEventListener('click', this.onClick);\r\n\t}\r\n\r\n\tremoveDocumentListeners() {\r\n\t\tdocument.removeEventListener('click', this.onDocumentClick);\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.removeListeners();\r\n\t\tthis.removeDocumentListeners();\r\n\t}\r\n\r\n\tstatic nextId() {\r\n\t\treturn DROPDOWN_ID++;\r\n\t}\r\n\r\n}\r\n\r\nDropdownDirective.meta = {\r\n\tselector: '[dropdown]',\r\n\tinputs: ['dropdown', 'dropdown-trigger'],\r\n\toutputs: ['dropped']\r\n};\r\n\r\nDropdownDirective.dropdown$ = new BehaviorSubject(null);\r\n","import { Directive, getContext } from \"rxcomp\";\r\nimport { takeUntil } from \"rxjs/operators\";\r\nimport DropdownDirective from \"./dropdown.directive\";\r\n\r\nexport default class DropdownItemDirective extends Directive {\r\n\r\n\tget id() {\r\n\t\treturn this['dropdown-item'];\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('dropdown-item');\r\n\t\tDropdownDirective.dropdown$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(id => {\r\n\t\t\t// console.log('DropdownItemDirective', id, this['dropdown-item']);\r\n\t\t\tif (this.id === id) {\r\n\t\t\t\tnode.classList.add('dropped');\r\n\t\t\t} else {\r\n\t\t\t\tnode.classList.remove('dropped');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nDropdownItemDirective.meta = {\r\n\tselector: '[dropdown-item], [[dropdown-item]]',\r\n\tinputs: ['dropdown-item']\r\n};\r\n","import { Subject } from 'rxjs';\r\n\r\nexport class ToastEvent {\r\n\tconstructor(toast) {\r\n\t\tthis.toast = toast;\r\n\t}\r\n}\r\n\r\nexport class ToastResolveEvent extends ToastEvent { }\r\n\r\nexport default class ToastService {\r\n\tstatic open$(toast) {\r\n\t\ttoast.id = new Date().getTime();\r\n\t\tthis.toast$.next(toast);\r\n\t\tsetTimeout(() => {\r\n\t\t\tthis.resolve(toast);\r\n\t\t}, toast.duration || 3000);\r\n\t\treturn this.events$;\r\n\t\t/*\r\n\t\treturn of(toast).pipe(\r\n\t\t\ttap(toast => this.toast$.next(toast)),\r\n\t\t\tswitchMap(toast => this.events$),\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\tstatic resolve(toast) {\r\n\t\tthis.toast$.next(null);\r\n\t\tthis.events$.next(new ToastResolveEvent(toast));\r\n\t}\r\n}\r\n\r\nToastService.toast$ = new Subject();\r\nToastService.events$ = new Subject();\r\n","import { Component } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport ToastService from './toast.service';\r\n\r\nexport default class ToastOutletComponent extends Component {\r\n\tonInit() {\r\n\t\tthis.toast = null;\r\n\t\tthis.lastMessage = '';\r\n\t\tToastService.toast$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(toast => {\r\n\t\t\tif (toast) {\r\n\t\t\t\tthis.lastMessage = toast.message;\r\n\t\t\t}\r\n\t\t\tthis.toast = toast;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\t// console.log('ToastOutletComponent.onInit');\r\n\t}\r\n}\r\n\r\nToastOutletComponent.meta = {\r\n\tselector: '[toast-outlet]',\r\n\ttemplate: /* html */ `\r\n\t<div class=\"toast-outlet__container\" [class]=\"{ active: toast }\">\r\n\t\t<div class=\"toast-outlet__toast\" [innerHTML]=\"lastMessage\"></div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport { ViewItemType, ViewType } from '../../view/view';\r\n\r\nexport default class AsideComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.mode = 1;\r\n\t\tthis.viewTypes = Object.keys(ViewType).map(key => {\r\n\t\t\tconst type = ViewType[key];\r\n\t\t\treturn {\r\n\t\t\t\ttype: type,\r\n\t\t\t\tname: LabelPipe.getKeys('editor', type.name),\r\n\t\t\t\tdisabled: environment.editor.disabledViewTypes.indexOf(type.name) !== -1,\r\n\t\t\t};\r\n\t\t});\r\n\t\tthis.viewItemTypes = Object.keys(ViewItemType).map(key => {\r\n\t\t\tconst type = ViewItemType[key];\r\n\t\t\treturn {\r\n\t\t\t\ttype: type,\r\n\t\t\t\tname: LabelPipe.getKeys('editor', type.name),\r\n\t\t\t\tdisabled: environment.editor.disabledViewItemTypes.indexOf(type.name) !== -1,\r\n\t\t\t};\r\n\t\t});\r\n\t\tthis.setSupportedViewTypes();\r\n\t\tthis.setSupportedViewItemTypes();\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.setSupportedViewTypes();\r\n\t\tthis.setSupportedViewItemTypes();\r\n\t}\r\n\r\n\tsetSupportedViewTypes() {\r\n\t\tthis.supportedViewTypes = this.viewTypes.filter(x => this.supportedViewType(x.type.name)).sort((a, b) => {\r\n\t\t\tif (a.disabled === b.disabled) {\r\n\t\t\t\treturn 0; // (a.type.name < b.type.name) ? -1 : (a.type.name > b.type.name) ? 1 : 0;\r\n\t\t\t} else {\r\n\t\t\t\treturn a.disabled ? 1 : -1;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tsetSupportedViewItemTypes() {\r\n\t\tif (this.view) {\r\n\t\t\tthis.supportedViewItemTypes = this.viewItemTypes.filter(x => this.supportedViewItemType(this.view.type.name, x.type.name)).sort((a, b) => {\r\n\t\t\t\tif (a.disabled === b.disabled) {\r\n\t\t\t\t\treturn 0; // (a.type.name < b.type.name) ? -1 : (a.type.name > b.type.name) ? 1 : 0;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn a.disabled ? 1 : -1;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.supportedViewItemTypes = [];\r\n\t\t}\r\n\t}\r\n\r\n\tsetMode(mode) {\r\n\t\tif (this.mode !== mode) {\r\n\t\t\tthis.mode = mode;\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tsupportedViewType(viewTypeName) {\r\n\t\tlet supported = [ViewType.Panorama.name, ViewType.PanoramaGrid.name, ViewType.Room3d.name, ViewType.Model.name].indexOf(viewTypeName) !== -1; // ViewType.WaitingRoom,\r\n\t\t// console.log('supportedViewType', viewType, supported);\r\n\t\treturn supported;\r\n\t}\r\n\r\n\tsupportedViewItemType(viewTypeName, viewItemTypeName) {\r\n\t\tlet supported;\r\n\t\tswitch (viewTypeName) {\r\n\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\tsupported = false;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Texture.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Model.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\t// console.log('supportedViewItemType', viewTypeName, viewItemTypeName, supported);\r\n\t\treturn supported;\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next(event);\r\n\t}\r\n\r\n\tonUpdate(event) {\r\n\t\tthis.update.next(event);\r\n\t}\r\n\r\n\tonDelete(event) {\r\n\t\tthis.delete.next(event);\r\n\t}\r\n}\r\n\r\nAsideComponent.meta = {\r\n\tselector: '[aside]',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view'],\r\n};\r\n","import { fromEvent, merge, of } from \"rxjs\";\r\nimport { filter, map } from \"rxjs/operators\";\r\nimport HttpService from \"../http/http.service\";\r\nimport { Asset, mapAsset } from './asset';\r\n\r\nexport class AssetService {\r\n\r\n\tstatic assetCreate$(asset) {\r\n\t\treturn HttpService.post$(`/api/asset`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic assetUpdate$(asset) {\r\n\t\treturn HttpService.put$(`/api/asset/${asset.id}`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic assetDelete$(asset) {\r\n\t\tif (asset && asset.id) {\r\n\t\t\treturn HttpService.delete$(`/api/asset/${asset.id}`).pipe(\r\n\t\t\t\tmap(() => null),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic localizedAssetCreate$(lg, asset) {\r\n\t\treturn HttpService.post$(`/api/${lg}/asset`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic localizedAssetUpdate$(lg, asset) {\r\n\t\treturn HttpService.put$(`/api/${lg}/asset/${asset.id}`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic upload$(files) {\r\n\t\tconst formData = new FormData();\r\n\t\tfiles.forEach(file => formData.append('file', file, file.name));\r\n\t\tconst xhr = new XMLHttpRequest();\r\n\t\tconst events$ = merge(\r\n\t\t\tfromEvent(xhr.upload, 'loadstart'),\r\n\t\t\tfromEvent(xhr.upload, 'progress'),\r\n\t\t\tfromEvent(xhr.upload, 'load'),\r\n\t\t\tfromEvent(xhr, 'readystatechange'),\r\n\t\t).pipe(\r\n\t\t\tmap(event => {\r\n\t\t\t\tswitch (event.type) {\r\n\t\t\t\t\tcase 'readystatechange':\r\n\t\t\t\t\t\tif (xhr.readyState === 4) {\r\n\t\t\t\t\t\t\treturn JSON.parse(xhr.responseText);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event !== null)\r\n\t\t);\r\n\t\txhr.open('POST', `/api/upload/`, true);\r\n\t\txhr.send(formData);\r\n\t\treturn events$;\r\n\t}\r\n\r\n\tstatic createOrUpdateAsset$(uploads, control) {\r\n\t\tconst upload = uploads[0];\r\n\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\tif (control.value && control.value.id) { // !!! must check for id\r\n\t\t\tasset.id = control.value.id;\r\n\t\t\treturn AssetService.assetUpdate$(asset);\r\n\t\t} else {\r\n\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic createOrUpdateLocalizedAsset$(uploads, control, lg) {\r\n\t\tconst upload = uploads[0];\r\n\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\tif (control.value && control.value.id) { // !!! must check for id\r\n\t\t\tasset.id = control.value.id;\r\n\t\t\treturn AssetService.localizedAssetUpdate$(lg, asset);\r\n\t\t} else {\r\n\t\t\treturn AssetService.localizedAssetCreate$(lg, asset);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic assetDidChange(previous, current) {\r\n\t\tlet previousId = null;\r\n\t\tlet previousFile = null;\r\n\t\tlet currentId = null;\r\n\t\tlet currentFile = null;\r\n\t\tif (previous) {\r\n\t\t\tpreviousId = previous.id;\r\n\t\t\tpreviousFile = previous.file;\r\n\t\t}\r\n\t\tif (current) {\r\n\t\t\tcurrentId = current.id;\r\n\t\t\tcurrentFile = current.file;\r\n\t\t}\r\n\t\treturn (previousId !== currentId || previousFile !== currentFile);\r\n\t}\r\n\r\n}\r\n","import { map, shareReplay } from 'rxjs/operators';\r\nimport HttpService from '../http/http.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport { mapView, mapViewItem, ViewType } from '../view/view';\r\n\r\nexport default class EditorService {\r\n\r\n\tstatic data$() {\r\n\t\tif (!this.data$_) {\r\n\t\t\tthis.data$_ = HttpService.get$(`/api/view`).pipe(\r\n\t\t\t\tmap(data => {\r\n\t\t\t\t\tdata.views = data.views.map(view => mapView(view));\r\n\t\t\t\t\treturn data;\r\n\t\t\t\t}),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.data$_;\r\n\t}\r\n\r\n\tstatic viewIdOptions$() {\r\n\t\treturn this.data$().pipe(\r\n\t\t\tmap(data => {\r\n\t\t\t\tconst options = data.views.map(view => ({ id: view.id, name: view.name }));\r\n\t\t\t\toptions.unshift({ id: null, name: LabelPipe.transform('select') });\r\n\t\t\t\treturn options;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewCreate$(view) {\r\n\t\treturn HttpService.post$(`/api/view`, view).pipe(\r\n\t\t\tmap(view => mapView(view)),\r\n\t\t);\r\n\t}\r\n\tstatic viewUpdate$(view) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}`, view.payload).pipe(\r\n\t\t\tmap(view => mapView(view)),\r\n\t\t);\r\n\t}\r\n\tstatic viewDelete$(view) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}`);\r\n\t}\r\n\r\n\tstatic getTile(view) {\r\n\t\tlet tile;\r\n\t\tif (view.type.name === ViewType.PanoramaGrid.name) {\r\n\t\t\ttile = view.tiles[view.index];\r\n\t\t}\r\n\t\treturn tile;\r\n\t}\r\n\r\n\tstatic inferItemCreate$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemCreate$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemCreate$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemUpdate$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemUpdate$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemUpdate$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemDelete$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemDelete$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemDelete$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemUpdateResult$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tlet currentItem;\r\n\t\tif (tile) {\r\n\t\t\tcurrentItem = tile.navs.find(i => i.id === item.id);\r\n\t\t} else {\r\n\t\t\tcurrentItem = view.items.find(i => i.id === item.id);\r\n\t\t}\r\n\t\tif (currentItem) {\r\n\t\t\tObject.assign(currentItem, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemDeleteResult$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tlet items;\r\n\t\tif (tile) {\r\n\t\t\titems = tile.navs;\r\n\t\t} else {\r\n\t\t\titems = view.items;\r\n\t\t}\r\n\t\tif (items) {\r\n\t\t\tconst index = items.indexOf(item);\r\n\t\t\tif (index !== -1) {\r\n\t\t\t\titems.splice(index, 1);\r\n\t\t\t}\r\n\t\t\tif (tile) {\r\n\t\t\t\tview.updateCurrentItems();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic itemCreate$(view, item) {\r\n\t\treturn HttpService.post$(`/api/view/${view.id}/item`, item).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic itemUpdate$(view, item) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}/item/${item.id}`, item.payload).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic itemDelete$(view, item) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}/item/${item.id}`);\r\n\t}\r\n\r\n\tstatic tileItemCreate$(view, tile, item) {\r\n\t\treturn HttpService.post$(`/api/view/${view.id}/tile/${tile.id}/item`, item).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic tileItemUpdate$(view, tile, item) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}/tile/${tile.id}/item/${item.id}`, item.payload).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic tileItemDelete$(view, tile, item) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}/tile/${tile.id}/item/${item.id}`);\r\n\t}\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { Subject } from 'rxjs';\r\nimport { delay, first, switchMap, takeUntil, tap } from 'rxjs/operators';\r\nimport { AgoraStatus } from '../agora/agora.types';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { environment } from '../environment';\r\nimport ModalService, { ModalResolveEvent } from '../modal/modal.service';\r\nimport StateService from '../state/state.service';\r\nimport StreamService, { StreamServiceMode } from '../stream/stream.service';\r\nimport ToastService from '../toast/toast.service';\r\nimport { RoleType } from '../user/user';\r\nimport { UserService } from '../user/user.service';\r\nimport { ViewItemType, ViewType } from '../view/view';\r\nimport ViewService from '../view/view.service';\r\nimport VRService from '../world/vr.service';\r\nimport EditorService from './editor.service';\r\n\r\nexport default class EditorComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t\tthis.aside = false;\r\n\t\tthis.settings = false;\r\n\t\tthis.state = {};\r\n\t\tthis.data = null;\r\n\t\tthis.views = null;\r\n\t\tthis.view = null;\r\n\t\tthis.form = null;\r\n\t\tthis.local = null;\r\n\t\tthis.remotes = [];\r\n\t\tthis.viewHit = new Subject();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.status$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(status => this.pushChanges());\r\n\t\tthis.resolveUser();\r\n\t}\r\n\r\n\tresolveUser() {\r\n\t\tUserService.me$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(user => {\r\n\t\t\tif (user && user.type === RoleType.Publisher) {\r\n\t\t\t\tthis.user = user;\r\n\t\t\t\tthis.initState();\r\n\t\t\t} else {\r\n\t\t\t\twindow.location.href = environment.url.access;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tinitState() {\r\n\t\tconst user = this.user;\r\n\t\tconst role = user.type;\r\n\t\tconst name = user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null;\r\n\t\tconst state = {\r\n\t\t\tuser: user,\r\n\t\t\trole: role,\r\n\t\t\tname: name,\r\n\t\t\tlink: null,\r\n\t\t\tchannelName: environment.channelName,\r\n\t\t\tuid: null,\r\n\t\t\tstatus: AgoraStatus.Connected,\r\n\t\t\tconnecting: false,\r\n\t\t\tconnected: true,\r\n\t\t\tlocked: false,\r\n\t\t\tcontrol: false,\r\n\t\t\tspyed: false,\r\n\t\t\thosted: true,\r\n\t\t\tlive: false,\r\n\t\t\tcameraMuted: false,\r\n\t\t\taudioMuted: false,\r\n\t\t};\r\n\t\tStateService.state = state;\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.hosted = state.hosted;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tthis.viewObserver$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(view => {\r\n\t\t\t// console.log('EditorComponent.viewObserver$', view);\r\n\t\t});\r\n\t\tStreamService.mode = StreamServiceMode.Editor;\r\n\t\t// this.getUserMedia();\r\n\t}\r\n\r\n\tviewObserver$() {\r\n\t\treturn EditorService.data$().pipe(\r\n\t\t\tswitchMap(data => {\r\n\t\t\t\tthis.data = data;\r\n\t\t\t\tthis.views = data.views.filter(x => x.type.name !== 'waiting-room');\r\n\t\t\t\treturn ViewService.editorView$(data);\r\n\t\t\t}),\r\n\t\t\ttap(view => {\r\n\t\t\t\tthis.view = null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t\tdelay(1),\r\n\t\t\ttap(view => {\r\n\t\t\t\tthis.view = view;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tonNavTo(navItem) {\r\n\t\t// console.log('EditorComponent.onNavTo', navItem);\r\n\t\tconst viewId = navItem.viewId;\r\n\t\tconst view = this.data.views.find(x => x.id === viewId);\r\n\t\tif (view) {\r\n\t\t\tViewService.action = { viewId, keepOrientation: navItem.keepOrientation };\r\n\t\t}\r\n\t}\r\n\r\n\tonRemoteControlRequest(message) {\r\n\t\tModalService.open$({ src: environment.template.modal.controlRequest, data: null }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.patchState({ control: true, spying: false });\r\n\t\t\t} else {\r\n\t\t\t\tthis.patchState({ control: false, spying: false });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.pushChanges();\r\n\t\t// console.log(this.state);\r\n\t}\r\n\r\n\ttryInAr() {\r\n\t\tModalService.open$({ src: environment.template.modal.tryInAr, data: this.view }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\t// this.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tonPrevent(event) {\r\n\t\tevent.preventDefault();\r\n\t\tevent.stopImmediatePropagation();\r\n\t}\r\n\t*/\r\n\r\n\treplaceUrl() {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t\tconst debug = params.get('debug') || null;\r\n\t\t\tconst editor = params.get('editor') || null;\r\n\t\t\tconst role = params.get('role') || null;\r\n\t\t\tconst link = params.get('link') || null;\r\n\t\t\tconst name = params.get('name') || null;\r\n\t\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${link}${name ? `&name=${name}` : ''}${role ? `&role=${role}` : ''}${debug ? `&debug` : ''}${editor ? `&editor` : ''}`;\r\n\t\t\t// console.log('AgoraNameComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n\r\n\tonToggleAside() {\r\n\t\tthis.aside = !this.aside;\r\n\t\tthis.pushChanges();\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\tonToggleSettings() {\r\n\t\tthis.settings = !this.settings;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\t// editor\r\n\r\n\tonViewHit(event) {\r\n\t\t// console.log('onViewHit');\r\n\t\tthis.viewHit.next(event);\r\n\t}\r\n\r\n\tonViewHitted(callback) {\r\n\t\tif (this.viewHitSubscription) {\r\n\t\t\tthis.viewHitSubscription.unsubscribe();\r\n\t\t\tthis.viewHitSubscription = null;\r\n\t\t}\r\n\t\tif (typeof callback === 'function') {\r\n\t\t\tthis.viewHitSubscription = this.viewHit.pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(position => callback(position))\r\n\t\t}\r\n\t}\r\n\r\n\tonDragEnd(event) {\r\n\t\tEditorService.inferItemUpdate$(this.view, event.item).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(response => {\r\n\t\t\t// console.log('EditorComponent.onDragEnd.inferItemUpdate$.success', response);\r\n\t\t\tthis.pushChanges();\r\n\t\t}, error => console.log('EditorComponent.onDragEnd.inferItemUpdate$.error', error));\r\n\t}\r\n\r\n\tonResizeEnd(event) {\r\n\t\tconsole.log('EditorComponent.onResizeEnd');\r\n\t\t/*\r\n\t\tEditorService.inferItemUpdate$(this.view, event.item).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(response => {\r\n\t\t\t// console.log('EditorComponent.onResizeEnd.inferItemUpdate$.success', response);\r\n\t\t\tthis.pushChanges();\r\n\t\t}, error => console.log('EditorComponent.onResizeEnd.inferItemUpdate$.error', error));\r\n\t\t*/\r\n\t}\r\n\r\n\tonWorldSelect(event) {\r\n\t\t// console.log('EditorComponent.onWorldSelect', this.view);\r\n\t\tif (this.view) {\r\n\t\t\tlet selectedItem;\r\n\t\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\t\tthis.view.items.forEach(item => {\r\n\t\t\t\titem.selected = item === event.item;\r\n\t\t\t\tselectedItem = item.selected ? item : selectedItem;\r\n\t\t\t});\r\n\t\t\tthis.view.selected = !selectedItem;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (selectedItem) {\r\n\t\t\t\tthis.aside = true;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\twindow.dispatchEvent(new Event('resize'));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonOpenModal(modal, data) {\r\n\t\tModalService.open$({ src: environment.template.modal[modal.type][modal.value], data }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tconsole.log('EditorComponent.onOpenModal.resolve', event);\r\n\t\t\t\tswitch(modal.type) {\r\n\t\t\t\t\tcase 'view':\r\n\t\t\t\t\t\tswitch (modal.value) {\r\n\t\t\t\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\t\t\t\tthis.data.views.push(event.data);\r\n\t\t\t\t\t\t\t\tViewService.viewId = event.data.id;\r\n\t\t\t\t\t\t\t\tthis.pushChanges(); // !!!\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'viewItem':\r\n\t\t\t\t\t\tswitch (modal.value) {\r\n\t\t\t\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\t\t\t\tconst tile = EditorService.getTile(this.view);\r\n\t\t\t\t\t\t\t\tif (tile) {\r\n\t\t\t\t\t\t\t\t\tconst navs = tile.navs || [];\r\n\t\t\t\t\t\t\t\t\tnavs.push(event.data);\r\n\t\t\t\t\t\t\t\t\tObject.assign(tile, { navs });\r\n\t\t\t\t\t\t\t\t\tthis.view.updateCurrentItems();\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tconst items = this.view.items || [];\r\n\t\t\t\t\t\t\t\t\titems.push(event.data);\r\n\t\t\t\t\t\t\t\t\tObject.assign(this.view, { items });\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonAsideSelect(event) {\r\n\t\t// console.log('onAsideSelect', event);\r\n\t\tif (event.value) {\r\n\t\t\tswitch (event.value) {\r\n\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\tthis.onViewHitted((position) => {\r\n\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view, position });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tToastService.open$({ message: 'Click a point on the view' });\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\tif (event.type === 'viewItem') {\r\n\t\t\t\t\t\tif (this.view.type.name === ViewType.Model.name) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.onViewHitted((position) => {\r\n\t\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view, position });\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tToastService.open$({ message: 'Click a point on the view' });\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tthis.onOpenModal(event, { view: this.view });\r\n\t\t\t}\r\n\t\t} else if (event.view && (event.item || event.item === null)) {\r\n\t\t\tevent.view.selected = false;\r\n\t\t\tevent.view.items.forEach(item => item.selected = item === event.item);\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.view && (event.tile || event.tile === null)) {\r\n\t\t\tevent.view.selected = false;\r\n\t\t\tevent.view.tiles.forEach(tile => tile.selected = tile === event.tile);\r\n\t\t\t/*\r\n\t\t\t// if tile selected\r\n\t\t\t// send ChangeTile message to world component\r\n\t\t\tthis.orbit.walk(event.position, (headingLongitude, headingLatitude) => {\r\n\t\t\t\tconst item = this.view.getTile(event.indices.x, event.indices.y);\r\n\t\t\t\tif (item) {\r\n\t\t\t\t\tthis.panorama.crossfade(item, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t\t\t// this.scene.background = envMap;\r\n\t\t\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t\t\t\tthis.orbit.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\t\t\t// this.render();\r\n\t\t\t\t\t\t// this.pushChanges();\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.view || event.view === null) {\r\n\t\t\tthis.view.selected = (this.view === event.view);\r\n\t\t\tthis.view.items.forEach(item => item.selected = false);\r\n\t\t\tconst currentTile = EditorService.getTile(this.view);\r\n\t\t\tif (currentTile) {\r\n\t\t\t\tthis.view.tiles.forEach(tile => tile.selected = tile === currentTile);\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tonAsideUpdate(event) {\r\n\t\t// console.log('onAsideUpdate', event);\r\n\t\tif (event.item && event.view) {\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.tile && event.view) {\r\n\t\t\t/*\r\n\t\t\tEditorService.tileUpdate$...\r\n\t\t\t*/\r\n\t\t} else if (event.view) {\r\n\t\t\tif (ViewService.viewId !== event.view.id) {\r\n\t\t\t\tViewService.viewId = event.view.id;\r\n\t\t\t} else {\r\n\t\t\t\tconst assetDidChange = AssetService.assetDidChange(this.view.asset, event.view.asset);\r\n\t\t\t\tObject.assign(this.view, event.view);\r\n\t\t\t\tif (assetDidChange) {\r\n\t\t\t\t\tif (typeof this.view.onUpdateAsset === 'function') {\r\n\t\t\t\t\t\tthis.view.onUpdateAsset();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonAsideDelete(event) {\r\n\t\tconsole.log('onAsideDelete', event);\r\n\t\tif (event.item && event.view) {\r\n\t\t\tEditorService.inferItemDelete$(event.view, event.item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('EditorComponent.onAsideDelete.inferItemDelete$.success', response);\r\n\t\t\t\tEditorService.inferItemDeleteResult$(event.view, event.item);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, error => console.log('EditorComponent.onAsideDelete.inferItemDelete$.error', error));\r\n\t\t} else if (event.view) {\r\n\t\t\tEditorService.viewDelete$(event.view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('EditorComponent.onAsideDelete.viewDelete$.success', response);\r\n\t\t\t\tconst index = this.data.views.indexOf(event.view);\r\n\t\t\t\tif (index !== -1) {\r\n\t\t\t\t\tthis.data.views.splice(index, 1);\r\n\t\t\t\t}\r\n\t\t\t\tthis.views = this.data.views.slice();\r\n\t\t\t\tViewService.viewId = this.views[0].id;\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t}, error => console.log('EditorComponent.onAsideDelete.viewDelete$.error', error));\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nEditorComponent.meta = {\r\n\tselector: '[editor-component]',\r\n};\r\n","import { BehaviorSubject } from 'rxjs';\r\nimport { map, switchMap } from 'rxjs/operators';\r\nimport HttpService from '../../http/http.service';\r\nimport { ViewType } from '../../view/view';\r\n\r\nlet MENU_UID = 0;\r\n\r\nexport default class MenuService {\r\n\r\n\tstatic active$ = new BehaviorSubject(false);\r\n\tstatic set active(active) {\r\n\t\tthis.active$.next(active);\r\n\t}\r\n\tstatic get active() {\r\n\t\treturn this.active$.getValue();\r\n\t}\r\n\r\n\tstatic menu$_ = new BehaviorSubject([]);\r\n\r\n\tstatic menu$() {\r\n\t\treturn this.getMenu$().pipe(\r\n\t\t\tswitchMap(menu => {\r\n\t\t\t\tthis.menu$_.next(menu);\r\n\t\t\t\treturn this.menu$_;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getMenu$() {\r\n\t\treturn HttpService.get$(`/api/menu`).pipe(\r\n\t\t\tmap(data => {\r\n\t\t\t\tdata.menu.sort((a, b) => {\r\n\t\t\t\t\treturn a.order - b.order;\r\n\t\t\t\t});\r\n\t\t\t\treturn data.menu;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic updateMenu$(menu) {\r\n\t\treturn HttpService.put$(`/api/menu`, menu);\r\n\t}\r\n\r\n\tstatic createMenuItem$(parentId = null, order = 0) {\r\n\t\tconst payload = {\r\n\t\t\tparentId: parentId,\r\n\t\t\tviewId: null,\r\n\t\t\torder: order * 10,\r\n\t\t\tname: 'Folder ' + (++MENU_UID),\r\n\t\t}\r\n\t\treturn HttpService.post$(`/api/menu`, payload);\r\n\t}\r\n\r\n\tstatic updateMenuItem$(item) {\r\n\t\treturn HttpService.put$(`/api/menu/${item.id}`, item);\r\n\t}\r\n\r\n\tstatic deleteMenuItem$(item) {\r\n\t\treturn HttpService.delete$(`/api/menu/${item.id}`);\r\n\t}\r\n\r\n\tstatic getModelMenu$(views, editor = false) {\r\n\t\treturn this.menu$().pipe(\r\n\t\t\tmap(menu => {\r\n\t\t\t\tif (menu && menu.length) {\r\n\t\t\t\t\treturn this.mapMenuItems(menu);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst keys = {};\r\n\t\t\t\t\tviews.forEach(item => {\r\n\t\t\t\t\t\tif (item.type.name !== ViewType.WaitingRoom.name && (!item.hidden || editor)) {\r\n\t\t\t\t\t\t\tlet group = keys[item.type.name];\r\n\t\t\t\t\t\t\tif (!group) {\r\n\t\t\t\t\t\t\t\tgroup = keys[item.type.name] = [];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tgroup.push(item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tconst menu = Object.keys(keys).map(typeName => {\r\n\t\t\t\t\t\tlet name = 'Button';\r\n\t\t\t\t\t\tswitch (typeName) {\r\n\t\t\t\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\t\t\t\t\tname = 'Waiting Room';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\t\t\t\tname = 'Experience';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\t\t\t\tname = 'Virtual Tour';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\t\t\t\t\tname = 'Stanze 3D';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\t\t\t\tname = 'Modelli 3D';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn { name, type: { name: 'menu-group' }, items: views.filter(x => x.type.name === typeName && (!x.hidden || editor)) };\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn menu;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic mapMenuItem(item, items) {\r\n\t\tif (item.viewId) {\r\n\t\t\treturn { id: item.viewId, name: item.name, type: { name: 'panorama' } };\r\n\t\t} else {\r\n\t\t\treturn { name: item.name, type: { name: 'menu-group' }, items: this.mapMenuItems(items, item.id) };\r\n\t\t}\r\n\t}\r\n\r\n\tstatic mapMenuItems(items, parentId = null) {\r\n\t\treturn items.filter(item => (item.parentId || null) === parentId ).map(item => this.mapMenuItem(item, items))\r\n\t}\r\n\r\n}\r\n","import { isPlatformBrowser } from 'rxcomp';\r\nimport { combineLatest, EMPTY, from, fromEvent, merge } from 'rxjs';\r\nimport { filter, map, switchMap, tap } from 'rxjs/operators';\r\nimport { Asset } from '../asset/asset';\r\nimport { AssetService } from '../asset/asset.service';\r\n\r\nexport class DropService {\r\n\r\n\tstatic drop$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\tconst body = document.querySelector('body');\r\n\t\t\treturn merge(fromEvent(body, 'drop'), fromEvent(body, 'dragover')).pipe(\r\n\t\t\t\tmap((event) => {\r\n\t\t\t\t\tconsole.log('DropService.drop$', event);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\tif (event.target === input) {\r\n\t\t\t\t\t\tinput.files = event.dataTransfer.files;\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic change$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'change').pipe(\r\n\t\t\t\tfilter((event) => input.files && input.files.length),\r\n\t\t\t\tmap((event) => Array.from(input.files)),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic asset$(input, previews = []) {\r\n\t\treturn this.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tpreviews.length = files.length;\r\n\t\t\t\tpreviews.fill(null);\r\n\t\t\t\t// output.previews = files.map(() => null);\r\n\t\t\t\tconst uploads$ = files.map((file, i) => this.read$(file, i, previews).pipe(\r\n\t\t\t\t\tmap(() => file),\r\n\t\t\t\t\tswitchMap((file) => AssetService.upload$([file])),\r\n\t\t\t\t\tswitchMap((uploads) => {\r\n\t\t\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t\t\t}),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic read$(file, i, previews = []) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\treturn this.resize$(blob);\r\n\t\t\t}),\r\n\t\t\ttap(resized => {\r\n\t\t\t\tpreviews[i] = resized;\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tstatic resize$(blob) {\r\n\t\treturn from(this.resize_(blob));\r\n\t}\r\n\r\n\tstatic resize_(blob) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tresolve(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.onerror = function() {\r\n\t\t\t\treject(blob);\r\n\t\t\t}\r\n\t\t\timg.src = blob;\r\n\t\t});\r\n\t}\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\n\r\nexport default class ControlComponent extends Component {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log(this, node, this.control);\r\n\t\tconst control = this.control;\r\n\t\tconst flags = control.flags;\r\n\t\tObject.keys(flags).forEach((key) => {\r\n\t\t\tflags[key] ? node.classList.add(key) : node.classList.remove(key);\r\n\t\t});\r\n\t}\r\n}\r\n\r\nControlComponent.meta = {\r\n\tselector: '[control]',\r\n\tinputs: ['control']\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest } from 'rxjs';\r\nimport { switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlAssetComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tDropService.drop$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => AssetService.createOrUpdateAsset$(uploads, this.control)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(assets => {\r\n\t\t\t// console.log('ControlAssetComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n}\r\n\r\nControlAssetComponent.meta = {\r\n\tselector: '[control-asset]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--picture\">\r\n\t\t\t\t<div class=\"group--picture__info\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<img [lazy]=\"control.value | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"control.value && control.value.type.name === 'image'\" />\r\n\t\t\t\t<video [src]=\"control.value | asset\" *if=\"control.value && control.value.type.name === 'video'\"></video>\r\n\t\t\t\t<input type=\"file\">\r\n\t\t\t</div>\r\n\t\t\t<div class=\"file-name\" *if=\"control.value\" [innerHTML]=\"control.value.file\"></div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { FormArray, FormGroup } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport DropdownDirective from '../dropdown/dropdown.directive';\r\nimport EditorService from '../editor/editor.service';\r\nimport MenuService from '../editor/menu/menu.service';\r\nimport ControlAssetComponent from './control-asset.component';\r\n\r\nlet MENU_UID = 0;\r\n\r\nexport default class ControlMenuComponent extends ControlAssetComponent {\r\n\r\n\tstatic itemToFormGroup(item) {\r\n\t\treturn new FormGroup({\r\n\t\t\tid: item.id,\r\n\t\t\tparentId: item.parentId,\r\n\t\t\tviewId: item.viewId,\r\n\t\t\tname: item.name,\r\n\t\t\titems: new FormArray(),\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tstatic newFormGroup(parentId = null) {\r\n\t\treturn new FormGroup({\r\n\t\t\tid: null,\r\n\t\t\tparentId: parentId,\r\n\t\t\tviewId: null,\r\n\t\t\tname: 'Folder ' + (++MENU_UID),\r\n\t\t\titems: new FormArray(),\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\tonInit() {\r\n\t\tthis.dropdownId = DropdownDirective.nextId();\r\n\t\tthis.controls = this.control.controls;\r\n\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(options => {\r\n\t\t\tthis.controls.viewId.options = options;\r\n\t\t});\r\n\t}\r\n\r\n\tonAddItem() {\r\n\t\tMenuService.createMenuItem$(this.controls.id.value, this.controls.items.length).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(item => {\r\n\t\t\tthis.controls.items.push(ControlMenuComponent.itemToFormGroup(item));\r\n\t\t});\r\n\t\t// this.controls.items.push(ControlMenuComponent.newFormGroup(this.controls.id.value));\r\n\t}\r\n\r\n\tonRemoveItem() {\r\n\t\tthis.remove.next(this.control);\r\n\t}\r\n\r\n\tonRemoveControl(control) {\r\n\t\tMenuService.deleteMenuItem$(control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.items.remove(control);\r\n\t\t});\r\n\t\t// this.controls.items.remove(control);\r\n\t}\r\n\r\n\tonLinkItem() {\r\n\t\tthis.link.next(this.control);\r\n\t}\r\n\r\n\tonLinkControl(control) {\r\n\t\tthis.link.next(control);\r\n\t}\r\n\r\n\tonItemUp() {\r\n\t\tthis.up.next(this.control);\r\n\t}\r\n\r\n\tonItemDown() {\r\n\t\tthis.down.next(this.control);\r\n\t}\r\n\r\n\tonUpControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index > 0) {\r\n\t\t\tindex --;\r\n\t\t} else {\r\n\t\t\tindex = length - 1;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonDownControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index < length - 1) {\r\n\t\t\tindex ++;\r\n\t\t} else {\r\n\t\t\tindex = 0;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tsetView(view) {\r\n\t\tconsole.log('ControlMenuComponent.setView', view.id);\r\n\t\tconst payload = Object.assign({}, this.control.value);\r\n\t\tpayload.viewId = view.id;\r\n\t\tif (view.id) {\r\n\t\t\tpayload.name = view.name;\r\n\t\t}\r\n\t\tMenuService.updateMenuItem$(payload).pipe(\r\n\t\t\tfirst()\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.viewId.value = view.id;\r\n\t\t\tif (view.id) {\r\n\t\t\t\tthis.controls.name.value = view.name;\r\n\t\t\t\t// clear sub items\r\n\t\t\t\tthis.controls.items.controls = [];\r\n\t\t\t\tthis.controls.items.switchSubjects_();\r\n\t\t\t}\r\n\t\t\t// this.change.next(value);\r\n\t\t});\r\n\t}\r\n\r\n\tonTextDidChange(event) {\r\n\t\tconsole.log('ControlMenuComponent.onTextDidChange', this.controls.name.value);\r\n\t\tMenuService.updateMenuItem$(this.control.value).pipe(\r\n\t\t\tfirst()\r\n\t\t).subscribe();\r\n\t}\r\n\r\n\thasOption(item) {\r\n\t\treturn this.controls.viewId.value === item.id;\r\n\t}\r\n\r\n\tonDropped(id) {\r\n\t\t// console.log('ControlMenuComponent.onDropped', id);\r\n\t}\r\n\r\n}\r\n\r\nControlMenuComponent.meta = {\r\n\tselector: '[control-menu]',\r\n\toutputs: ['remove', 'link', 'up', 'down'],\r\n\tinputs: ['control'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\">\r\n\t\t\t<button type=\"button\" class=\"control-menu__link\" [class]=\"{ active: control.controls.viewId.value }\" (click)=\"onLinkItem($event)\" [dropdown]=\"dropdownId\" (dropped)=\"onDropped($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#link\"></use></svg>\r\n\t\t\t\t<div class=\"dropdown\" [dropdown-item]=\"dropdownId\">\r\n\t\t\t\t\t<div class=\"category\">View</div>\r\n\t\t\t\t\t<ul class=\"nav--dropdown\">\r\n\t\t\t\t\t\t<li (click)=\"setView(item)\" [class]=\"{ empty: item.id == null }\" *for=\"let item of control.controls.viewId.options\">\r\n\t\t\t\t\t\t\t<span [class]=\"{ active: hasOption(item) }\" [innerHTML]=\"item.name\"></span>\r\n\t\t\t\t\t\t</li>\r\n\t\t\t\t\t</ul>\r\n\t\t\t\t</div>\r\n\t\t\t</button>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control.controls.name\" placeholder=\"Name\" (change)=\"onTextDidChange($event)\" />\r\n\t\t\t<!--\r\n\t\t\t<button type=\"button\" class=\"control-menu__add\" (click)=\"onAddItem($event)\">\r\n\t\t\t\t<span [innerHTML]=\"control.controls.viewId.value\"></span>\r\n\t\t\t</button>\r\n\t\t\t-->\r\n\t\t\t<!--\r\n\t\t\t<select class=\"control--select\" [formControl]=\"control.controls.viewId\">\r\n\t\t\t\t<option [value]=\"item.id\" *for=\"let item of control.controls.viewId.options\" [innerHTML]=\"item.name\"></option>\r\n\t\t\t</select>\r\n\t\t\t-->\r\n\t\t\t<button type=\"button\" class=\"control-menu__up\" (click)=\"onItemUp($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#up\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__down\" (click)=\"onItemDown($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#down\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__add\" (click)=\"onAddItem($event)\" *if=\"!control.controls.viewId.value\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#add\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__remove\" (click)=\"onRemoveItem($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#remove\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"group--items\">\r\n\t\t\t<div control-menu *for=\"let sub of control.controls.items.controls\" [control]=\"sub\" (remove)=\"onRemoveControl($event)\" (link)=\"onLinkControl($event)\" (up)=\"onUpControl($event)\" (down)=\"onDownControl($event)\"></div>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormArray, FormGroup } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport ControlMenuComponent from '../../forms/control-menu.component';\r\nimport MenuService from './menu.service';\r\n\r\nexport default class MenuBuilderComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.changes = 0;\r\n\t\tthis.form = null;\r\n\t\tMenuService.getMenu$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(menu => this.initForm(menu));\r\n\t}\r\n\r\n\tinitForm(menu = []) {\r\n\t\tconst items = this.menuToControls(menu);\r\n\t\t// console.log('MenuBuilderComponent', items);\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\titems: items,\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('MenuBuilderComponent', changes);\r\n\t\t\tthis.changes ++;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonLinkControl(control) {\r\n\r\n\t}\r\n\r\n\tonUpControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index > 0) {\r\n\t\t\tindex --;\r\n\t\t} else {\r\n\t\t\tindex = length - 1;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonDownControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index < length - 1) {\r\n\t\t\tindex ++;\r\n\t\t} else {\r\n\t\t\tindex = 0;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonAddItem() {\r\n\t\tMenuService.createMenuItem$(null, this.controls.items.length).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(item => {\r\n\t\t\tthis.controls.items.push(ControlMenuComponent.itemToFormGroup(item));\r\n\t\t});\r\n\t\t// this.controls.items.push(ControlMenuComponent.newFormGroup());\r\n\t}\r\n\r\n\tonRemoveControl(control) {\r\n\t\tMenuService.deleteMenuItem$(control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.items.remove(control);\r\n\t\t});\r\n\t\t// this.controls.items.remove(control);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonSubmit(event) {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst changes = this.form.value;\r\n\t\t\tconst menu = this.controlsToMenu(changes);\r\n\t\t\tMenuService.updateMenu$(menu);\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tmenuToControls(menu, parentId = null) {\r\n\t\tconst items = new FormArray(menu.filter(x => {\r\n\t\t\treturn (x.parentId || null) === parentId;\r\n\t\t}).map(x => {\r\n\t\t\tconst subitems = this.menuToControls(menu, x.id);\r\n\t\t\treturn new FormGroup({\r\n\t\t\t\tid: x.id,\r\n\t\t\t\tparentId: x.parentId,\r\n\t\t\t\tviewId: x.viewId,\r\n\t\t\t\tname: x.name,\r\n\t\t\t\titems: subitems,\r\n\t\t\t});\r\n\t\t}))\r\n\t\treturn items;\r\n\t}\r\n\r\n\tcontrolsToMenu(changes) {\r\n\t\tconst menu = [];\r\n\t\tconst pushItem = (items) => {\r\n\t\t\tif (items) {\r\n\t\t\t\titems.forEach((item, i) => {\r\n\t\t\t\t\tconst menuItem = Object.assign({}, item);\r\n\t\t\t\t\tmenuItem.order = i * 10;\r\n\t\t\t\t\tdelete menuItem.items;\r\n\t\t\t\t\tmenu.push(menuItem);\r\n\t\t\t\t\tpushItem(item.items);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\tpushItem(changes.items);\r\n\t\treturn menu;\r\n\t}\r\n\r\n}\r\n\r\nMenuBuilderComponent.meta = {\r\n\tselector: '[menu-builder]',\r\n\tinputs: ['views'],\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class CurvedPlaneModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tobject.position.copy(this.position);\r\n\t\tobject.lookAt(CurvedPlaneModalComponent.ORIGIN);\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.CurvedPlane,\r\n\t\t\tposition: new FormControl(this.position.multiplyScalar(20).toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([1, 1, 1], RequiredValidator()),\r\n\t\t\tradius: new FormControl(35, RequiredValidator()),\r\n\t\t\theight: new FormControl(20, RequiredValidator()),\r\n\t\t\tarc: new FormControl(90, RequiredValidator()),\r\n\t\t\tasset: null,\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('CurvedPlaneModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\tconsole.log('CurvedPlaneModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('CurvedPlaneModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('CurvedPlaneModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nCurvedPlaneModalComponent.ORIGIN = new THREE.Vector3();\r\n\r\nCurvedPlaneModalComponent.meta = {\r\n\tselector: '[curved-plane-modal]'\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class ItemModelModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t/*\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tobject.position.copy(this.position);\r\n\t\tobject.lookAt(ItemModelModalComponent.ORIGIN);\r\n\t\t*/\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Model,\r\n\t\t\tposition: new FormControl(this.position.multiplyScalar(4).toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl([0, 0, 0], RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\t// rotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([1, 1, 1], RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('ItemModelModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\tconsole.log('ItemModelModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('ItemModelModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('ItemModelModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nItemModelModalComponent.ORIGIN = new THREE.Vector3();\r\n\r\nItemModelModalComponent.meta = {\r\n\tselector: '[item-model-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first, map, switchMap } from 'rxjs/operators';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class ModelModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.Model,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t\tmodel: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('ModelModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: values.type,\r\n\t\t\t\tname: values.name,\r\n\t\t\t\tasset: values.asset,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\tconsole.log('ModelModalComponent.onSubmit.view', view);\r\n\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\tswitchMap(view => {\r\n\t\t\t\t\tconst item = {\r\n\t\t\t\t\t\ttype: ViewItemType.Model,\r\n\t\t\t\t\t\tasset: values.model,\r\n\t\t\t\t\t};\r\n\t\t\t\t\treturn EditorService.itemCreate$(view, item).pipe(\r\n\t\t\t\t\t\tmap(item => {\r\n\t\t\t\t\t\t\tview.items = [item];\r\n\t\t\t\t\t\t\treturn view;\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t);\r\n\t\t\t\t}),\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('ModelModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('ModelModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nModelModalComponent.meta = {\r\n\tselector: '[model-modal]'\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class NavModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Nav,\r\n\t\t\ttitle: null,\r\n\t\t\tabstract: null,\r\n\t\t\tviewId: new FormControl(null, RequiredValidator()),\r\n\t\t\tkeepOrientation: false,\r\n\t\t\tposition: this.position.toArray(),\r\n\t\t\tasset: null,\r\n\t\t\tlink: new FormGroup({\r\n\t\t\t\ttitle: new FormControl(null),\r\n\t\t\t\thref: new FormControl(null),\r\n\t\t\t\ttarget: '_blank',\r\n\t\t\t}),\r\n\t\t\t// upload: new FormControl(null, RequiredValidator()),\r\n\t\t\t// items: new FormArray([null, null, null], RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\t/*\r\n\t\tthis.controls.viewId.options = [{\r\n\t\t\tname: \"Name\",\r\n\t\t\tid: 2,\r\n\t\t}];\r\n\t\t*/\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('NavModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(options => {\r\n\t\t\tthis.controls.viewId.options = options;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\titem.viewId = parseInt(item.viewId);\r\n\t\t\tif (item.link && (!item.link.title || !item.link.href)) {\r\n\t\t\t\titem.link = null;\r\n\t\t\t}\r\n\t\t\t// console.log('NavModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('NavModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('NavModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.submitted = false;\r\n\t\t\t\t// this.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nNavModalComponent.meta = {\r\n\tselector: '[nav-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { PanoramaGridView, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class PanoramaGridModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.PanoramaGrid,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tassets: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PanoramaGridModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit', this.form.value);\r\n\t\t\tconst assets = this.form.value.assets;\r\n\t\t\tconst tiles = PanoramaGridView.mapTiles(assets.map(asset => ({\r\n\t\t\t\tasset,\r\n\t\t\t\tnavs: [],\r\n\t\t\t})), false, true);\r\n\t\t\ttiles.sort((a, b) => {\r\n\t\t\t\tconst ai = a.indices.x * 10000 + a.indices.y;\r\n\t\t\t\tconst bi = b.indices.x * 10000 + b.indices.y;\r\n\t\t\t\treturn ai - bi;\r\n\t\t\t});\r\n\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit', tiles);\r\n\t\t\tconst asset = tiles[0].asset;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: this.form.value.type,\r\n\t\t\t\tname: this.form.value.name,\r\n\t\t\t\tasset,\r\n\t\t\t\ttiles: tiles,\r\n\t\t\t\tinvertAxes: true,\r\n\t\t\t\tflipAxes: false,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\tEditorService.viewCreate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nPanoramaGridModalComponent.meta = {\r\n\tselector: '[panorama-grid-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class PanoramaModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.Panorama,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t\t// upload: new FormControl(null, RequiredValidator()),\r\n\t\t\t// items: new FormArray([null, null, null], RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PanoramaModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: values.type,\r\n\t\t\t\tname: values.name,\r\n\t\t\t\tasset: values.asset,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\tconsole.log('PanoramaModalComponent.onSubmit.view', view);\r\n\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tconst asset = Asset.fromUrl(this.form.value.upload);\r\n\t\t\tconsole.log('PanoramaModalComponent.onSubmit.asset', asset);\r\n\t\t\tAssetService.assetCreate$(asset).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t\tswitchMap(response => {\r\n\t\t\t\t\tconst view = {\r\n\t\t\t\t\t\ttype: this.form.value.type,\r\n\t\t\t\t\t\tname: this.form.value.name,\r\n\t\t\t\t\t\tasset: response,\r\n\t\t\t\t\t\torientation: {\r\n\t\t\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\t\t\tlongitude: 0\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tzoom: 75\r\n\t\t\t\t\t};\r\n\t\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.view', view);\r\n\t\t\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t);\r\n\t\t\t\t})\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\tEditorService.viewCreate$({\r\n\t\t\t\"id\": 1,\r\n\t\t\t\"type\": \"panorama\",\r\n\t\t\t\"name\": \"Welcome Room\",\r\n\t\t\t\"likes\": 134,\r\n\t\t\t\"liked\": false,\r\n\t\t\t\"asset\": {\r\n\t\t\t\t\"type\": \"image\",\r\n\t\t\t\t\"folder\": \"waiting-room/\",\r\n\t\t\t\t\"file\": \"mod2.jpg\"\r\n\t\t\t},\r\n\t\t\t\"items\": [\r\n\t\t\t\t{\r\n\t\t\t\t\t\"id\": 110,\r\n\t\t\t\t\t\"type\": \"nav\",\r\n\t\t\t\t\t\"title\": \"Barilla Experience\",\r\n\t\t\t\t\t\"abstract\": \"Abstract\",\r\n\t\t\t\t\t\"asset\": {\r\n\t\t\t\t\t\t\"type\": \"image\",\r\n\t\t\t\t\t\t\"folder\": \"barilla/\",\r\n\t\t\t\t\t\t\"file\": \"logo-barilla.jpg\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"link\": {\r\n\t\t\t\t\t\t\"title\": \"Scopri di più...\",\r\n\t\t\t\t\t\t\"href\": \"https://www.barilla.com/it-it/\",\r\n\t\t\t\t\t\t\"target\": \"_blank\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"position\": [\r\n\t\t\t\t\t\t0.9491595148619703,\r\n\t\t\t\t\t\t-0.3147945860255039,\r\n\t\t\t\t\t\t0\r\n\t\t\t\t\t],\r\n\t\t\t\t\t\"viewId\": 23\r\n\t\t\t\t}\r\n\t\t\t],\r\n\t\t\t\"orientation\": {\r\n\t\t\t\t\"latitude\": -10,\r\n\t\t\t\t\"longitude\": 360\r\n\t\t\t},\r\n\t\t\t\"zoom\": 75\r\n\t\t}).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(data => {\r\n\t\t\tconsole.log('EditorService.viewCreate$', data);\r\n\t\t});\r\n\t\t\t*/\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nPanoramaModalComponent.meta = {\r\n\tselector: '[panorama-modal]'\r\n};\r\n\r\n/*\r\n{\r\n\t\"id\": 1,\r\n\t\"type\": \"panorama\",\r\n\t\"name\": \"Welcome Room\",\r\n\t\"likes\": 134,\r\n\t\"liked\": false,\r\n\t\"asset\": {\r\n\t\t\"type\": \"image\",\r\n\t\t\"folder\": \"waiting-room/\",\r\n\t\t\"file\": \"mod2.jpg\"\r\n\t},\r\n\t\"items\": [{\r\n\t\t\"id\": 110,\r\n\t\t\"type\": \"nav\",\r\n\t\t\"title\": \"Barilla Experience\",\r\n\t\t\"abstract\": \"Abstract\",\r\n\t\t\"asset\": {\r\n\t\t\t\"type\": \"image\",\r\n\t\t\t\"folder\": \"barilla/\",\r\n\t\t\t\"file\": \"logo-barilla.jpg\"\r\n\t\t},\r\n\t\t\"link\": {\r\n\t\t\t\"title\": \"Scopri di più...\",\r\n\t\t\t\"href\": \"https://www.barilla.com/it-it/\",\r\n\t\t\t\"target\": \"_blank\"\r\n\t\t},\r\n\t\t\"position\": [0.9491595148619703,-0.3147945860255039,0],\r\n\t\t\"viewId\": 23\r\n\t}],\r\n\t\"orientation\": {\r\n\t\t\"latitude\": -10,\r\n\t\t\"longitude\": 360\r\n\t},\r\n\t\"zoom\": 75\r\n}\r\n*/\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class PlaneModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tobject.position.copy(this.position);\r\n\t\tobject.lookAt(PlaneModalComponent.ORIGIN);\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Plane,\r\n\t\t\tposition: new FormControl(this.position.multiplyScalar(20).toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([12, 6.75, 1], RequiredValidator()),\r\n\t\t\tasset: null,\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PlaneModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\tconsole.log('PlaneModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PlaneModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('PlaneModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nPlaneModalComponent.ORIGIN = new THREE.Vector3();\r\n\r\nPlaneModalComponent.meta = {\r\n\tselector: '[plane-modal]'\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\n\r\nexport default class RemoveModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget item() {\r\n\t\tlet item = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\titem = data.item;\r\n\t\t}\r\n\t\treturn item;\r\n\t}\r\n\r\n\tonRemove() {\r\n\t\tModalService.resolve();\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nRemoveModalComponent.meta = {\r\n\tselector: '[remove-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { of } from 'rxjs';\r\nimport { first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetGroupType, assetGroupTypeFromItem, assetPayloadFromGroupTypeId } from '../../asset/asset';\r\nimport { AssetService } from '../../asset/asset.service';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport ModalService, { ModalResolveEvent } from '../../modal/modal.service';\r\nimport { ViewItem, ViewItemType, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class UpdateViewItemComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tthis.active = false;\r\n\t\tconst form = this.form = new FormGroup();\r\n\t\tthis.controls = form.controls;\r\n\t\tconst item = this.item;\r\n\t\tthis.originalItem = Object.assign({}, item);\r\n\t\titem.hasChromaKeyColor = (item.asset && item.asset.chromaKeyColor) ? true : false;\r\n\t\titem.assetType = assetGroupTypeFromItem(item).id;\r\n\t\tthis.doUpdateForm();\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewItemComponent.form.changes$', changes);\r\n\t\t\tthis.doUpdateItem(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tgetAssetDidChange(changes) {\r\n\t\tconst item = this.item;\r\n\t\t// console.log('UpdateViewItemComponent.getAssetDidChange', item, changes);\r\n\t\tconst itemHasChromaKeyColor = item.hasChromaKeyColor === true;\r\n\t\tconst changesHasChromaKeyColor = changes.hasChromaKeyColor === true;\r\n\t\tif (AssetService.assetDidChange(item.asset, changes.asset) ||\r\n\t\t\titemHasChromaKeyColor !== changesHasChromaKeyColor) {\r\n\t\t\treturn true;\r\n\t\t} else {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateItem(changes) {\r\n\t\tconst item = this.item;\r\n\t\tconst assetDidChange = this.getAssetDidChange(changes);\r\n\t\t// console.log('doUpdateItem.assetDidChange', assetDidChange);\r\n\t\tObject.assign(item, changes);\r\n\t\tif (item.asset) {\r\n\t\t\titem.asset.chromaKeyColor = item.hasChromaKeyColor ? [0.0, 1.0, 0.0] : null;\r\n\t\t}\r\n\t\tif (assetDidChange) {\r\n\t\t\tconst asset$ = item.asset ? AssetService.assetUpdate$(item.asset) : of(null);\r\n\t\t\tasset$.pipe(\r\n\t\t\t\tswitchMap(() => EditorService.inferItemUpdate$(this.view, item)),\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe();\r\n\t\t\t// !!! create indices for nextAttendeeStream\r\n\t\t\tthis.view.updateIndices(this.view.items);\r\n\t\t\tif (typeof item.onUpdateAsset === 'function') {\r\n\t\t\t\titem.onUpdateAsset();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (typeof item.onUpdate === 'function') {\r\n\t\t\titem.onUpdate();\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateForm() {\r\n\t\tconst item = this.item;\r\n\t\tconst form = this.form;\r\n\t\tif (!this.type || this.type.name !== item.type.name) {\r\n\t\t\tthis.type = item.type;\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tform.removeKey(key);\r\n\t\t\t});\r\n\t\t\tlet keys;\r\n\t\t\tswitch (item.type.name) {\r\n\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'title?', 'abstract?', 'viewId', 'keepOrientation?', 'position', 'asset?', 'link?'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'scale', 'assetType?', 'asset?', 'hasChromaKeyColor?'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'scale', 'radius', 'height', 'arc', 'assetType?', 'asset?', 'hasChromaKeyColor?'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Texture.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'assetType?', 'asset?', 'hasChromaKeyColor?']; // asset, key no id!!\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\tif (this.view.type.name === ViewType.Model) {\r\n\t\t\t\t\t\tkeys = ['id', 'type', 'asset?'];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'asset?'];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tkeys = ['id', 'type'];\r\n\t\t\t}\r\n\t\t\tkeys.forEach(key => {\r\n\t\t\t\tconst optional = key.indexOf('?') !== -1;\r\n\t\t\t\tkey = key.replace('?', '');\r\n\t\t\t\tconst value = (item[key] != null ? item[key] : null);\r\n\t\t\t\tlet control;\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'viewId':\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t\t).subscribe(options => {\r\n\t\t\t\t\t\t\tcontrol.options = options;\r\n\t\t\t\t\t\t\tcontrol.value = control.value || null;\r\n\t\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'assetType':\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t\t\tcontrol.options = Object.keys(AssetGroupType).map(x => AssetGroupType[x]);\r\n\t\t\t\t\t\t// console.log(control.options);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'link':\r\n\t\t\t\t\t\tconst title = item.link ? item.link.title : null;\r\n\t\t\t\t\t\tconst href = item.link ? item.link.href : null;\r\n\t\t\t\t\t\tconst target = '_blank';\r\n\t\t\t\t\t\tcontrol = new FormGroup({\r\n\t\t\t\t\t\t\ttitle: new FormControl(title),\r\n\t\t\t\t\t\t\thref: new FormControl(href),\r\n\t\t\t\t\t\t\ttarget\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t}\r\n\t\t\t\tform.add(control, key);\r\n\t\t\t});\r\n\t\t\tthis.controls = form.controls;\r\n\t\t} else {\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'link':\r\n\t\t\t\t\t\tconst title = item.link ? item.link.title : null;\r\n\t\t\t\t\t\tconst href = item.link ? item.link.href : null;\r\n\t\t\t\t\t\tconst target = '_blank';\r\n\t\t\t\t\t\tthis.controls[key].value = { title, href, target };\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'hasChromaKeyColor':\r\n\t\t\t\t\t\tthis.controls[key].value = (item.asset && item.asset.chromaKeyColor) ? true : false;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'assetType':\r\n\t\t\t\t\t\tthis.controls[key].value = assetGroupTypeFromItem(item).id;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tthis.controls[key].value = (item[key] != null ? item[key] : null);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonAssetTypeDidChange(assetType) {\r\n\t\tconst item = this.item;\r\n\t\tconst currentType = assetGroupTypeFromItem(item).id;\r\n\t\t// console.log('UpdateViewItemComponent.onAssetTypeDidChange', assetType, currentType);\r\n\t\tif (assetType !== currentType) {\r\n\t\t\titem.assetType = assetType;\r\n\t\t\tlet asset$ = of(null); // AssetService.assetDelete$(item.asset);\r\n\t\t\tif (assetType !== AssetGroupType.ImageOrVideo.id) {\r\n\t\t\t\tasset$ = asset$.pipe(\r\n\t\t\t\t\tswitchMap(() => {\r\n\t\t\t\t\t\tconst asset = assetPayloadFromGroupTypeId(assetType);\r\n\t\t\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t\t\t}),\r\n\t\t\t\t)\r\n\t\t\t}\r\n\t\t\tasset$.pipe(\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe(asset => {\r\n\t\t\t\t// console.log('UpdateViewItemComponent.asset$', asset);\r\n\t\t\t\tthis.controls.asset.value = asset;\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tasset$.pipe(\r\n\t\t\t\ttap(asset => {\r\n\t\t\t\t\titem.asset = asset;\r\n\t\t\t\t\tif (typeof item.onUpdateAsset === 'function') {\r\n\t\t\t\t\t\titem.onUpdateAsset();\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t\tswitchMap(() => EditorService.inferItemUpdate$(this.view, item)),\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe();\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\t// console.log('UpdateViewItemComponent.onChanges', changes);\r\n\t\tthis.doUpdateForm();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst changes = this.form.value;\r\n\t\t\tconst payload = Object.assign({}, changes);\r\n\t\t\tconst view = this.view;\r\n\t\t\tconst item = new ViewItem(payload);\r\n\t\t\tEditorService.inferItemUpdate$(view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('UpdateViewItemComponent.onSubmit.inferItemUpdate$.success', response);\r\n\t\t\t\tEditorService.inferItemUpdateResult$(view, item);\r\n\t\t\t\tthis.update.next({ view, item });\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.busy = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 300);\r\n\t\t\t}, error => console.log('UpdateViewItemComponent.onSubmit.inferItemUpdate$.error', error));\r\n\t\t\t// this.update.next({ view: this.view, item: new ViewItem(payload) });\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ src: environment.template.modal.remove, data: { item: this.item } }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view, item: this.item });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view, item: this.item.selected ? null : this.item });\r\n\t\t/*\r\n\t\tthis.item.active = !this.item.active;\r\n\t\tthis.pushChanges();\r\n\t\t*/\r\n\t}\r\n\r\n\tgetTitle(item) {\r\n\t\treturn LabelPipe.getKeys('editor', item.type.name);\r\n\t}\r\n}\r\n\r\nUpdateViewItemComponent.meta = {\r\n\tselector: 'update-view-item',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view', 'item'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: item.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<!-- <div class=\"id\" [innerHTML]=\"item.id\"></div> -->\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon [name]=\"item.type.name\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\" [innerHTML]=\"getTitle(item)\"></div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"item.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<!-- <div control-text [control]=\"controls.type\" label=\"Type\" [disabled]=\"true\"></div> -->\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'nav'\">\r\n\t\t\t\t<div control-text [control]=\"controls.title\" label=\"Title\"></div>\r\n\t\t\t\t<div control-textarea [control]=\"controls.abstract\" label=\"Abstract\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.viewId\" label=\"NavToView\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.keepOrientation\" label=\"Keep Orientation\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"3\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg, image/png\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.link.controls.title\" label=\"Link Title\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.link.controls.href\" label=\"Link Url\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'plane'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"1\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Localized Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'curved-plane'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"1\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\"></div>\r\n\t\t\t\t<!-- <div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\" [disabled]=\"true\"></div> -->\r\n\t\t\t\t<div control-number [control]=\"controls.radius\" label=\"Radius\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-number [control]=\"controls.height\" label=\"Height\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-number [control]=\"controls.arc\" label=\"Arc\" [precision]=\"0\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'model'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"1\" *if=\"view.type.name !== 'model'\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\" *if=\"view.type.name !== 'model'\"></div>\r\n\t\t\t\t<div control-model [control]=\"controls.asset\" label=\"Model (.glb)\" accept=\".glb\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'texture'\">\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport ModalService, { ModalResolveEvent } from '../../modal/modal.service';\r\n\r\nexport default class UpdateViewTileComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tthis.active = false;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tid: new FormControl(this.tile.id, RequiredValidator()),\r\n\t\t\tasset: new FormControl(this.tile.asset, RequiredValidator()),\r\n\t\t\tnavs: new FormControl(this.tile.navs, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewTileComponent.form.changes$', changes);\r\n\t\t\tconst tile = this.tile;\r\n\t\t\tObject.assign(tile, changes);\r\n\t\t\tif (typeof tile.onUpdate === 'function') {\r\n\t\t\t\ttile.onUpdate();\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tconsole.log('UpdateViewTileComponent.onInit', this.view, this.tile);\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst payload = Object.assign({}, this.form.value);\r\n\t\t\tconst view = this.view;\r\n\t\t\tconst tile = payload;\r\n\t\t\t/*\r\n\t\t\tEditorService.tileUpdate$...\r\n\t\t\t*/\r\n\t\t\tthis.update.next({ view, tile });\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.busy = false;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, 300);\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ src: environment.template.modal.remove, data: { tile: this.tile } }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view, tile: this.tile });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view, tile: this.tile.selected ? null : this.tile });\r\n\t}\r\n}\r\n\r\nUpdateViewTileComponent.meta = {\r\n\tselector: 'update-view-tile',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view', 'tile'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: tile.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon name=\"tile\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\">Tile {{tile.id}}</div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"tile.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg, image/png\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<!--\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t-->\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { auditTime, distinctUntilChanged, filter, first, takeUntil } from 'rxjs/operators';\r\nimport { MessageType } from '../../agora/agora.types';\r\nimport { AssetService } from '../../asset/asset.service';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport MessageService from '../../message/message.service';\r\nimport ModalService, { ModalResolveEvent } from '../../modal/modal.service';\r\nimport { View, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class UpdateViewComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tconst form = this.form = new FormGroup();\r\n\t\tthis.controls = form.controls;\r\n\t\tthis.doUpdateForm();\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewComponent.form.changes$', changes);\r\n\t\t\tthis.doUpdateView(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tthis.orbit$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\tswitch (this.view.type.name) {\r\n\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\tthis.form.patch({\r\n\t\t\t\t\t\tlatitude: message.orientation.latitude,\r\n\t\t\t\t\t\tlongitude: message.orientation.longitude,\r\n\t\t\t\t\t\tzoom: message.zoom,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\torbit$() {\r\n\t\tlet latitude, longitude, zoom = null;\r\n\t\treturn MessageService.in$.pipe(\r\n\t\t\tfilter(message => message.type === MessageType.ControlInfo),\r\n\t\t\tauditTime(65),\r\n\t\t\tdistinctUntilChanged((previous, current) => {\r\n\t\t\t\tconst didChange = (latitude !== current.orientation.latitude ||\r\n\t\t\t\t\tlongitude !== current.orientation.longitude ||\r\n\t\t\t\t\tzoom !== current.zoom);\r\n\t\t\t\tlatitude = current.orientation.latitude;\r\n\t\t\t\tlongitude = current.orientation.longitude;\r\n\t\t\t\tzoom = current.zoom;\r\n\t\t\t\treturn !didChange;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tgetAssetDidChange(changes) {\r\n\t\tconst view = this.view;\r\n\t\tconst assetDidChange = AssetService.assetDidChange(view.asset, changes.asset);\r\n\t\tconst usdzDidChange = AssetService.assetDidChange(view.ar ? view.ar.usdz : null, changes.usdz);\r\n\t\tconst gltfDidChange = AssetService.assetDidChange(view.ar ? view.ar.gltf : null, changes.gltf);\r\n\t\tif (assetDidChange || usdzDidChange || gltfDidChange) {\r\n\t\t\t// console.log('UpdateViewComponent.getAssetDidChange', assetDidChange, usdzDidChange, gltfDidChange);\r\n\t\t\treturn true;\r\n\t\t} else {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateView(changes) {\r\n\t\tconst assetDidChange = this.getAssetDidChange(changes);\r\n\t\t// console.log('doUpdateItem.assetDidChange', assetDidChange);\r\n\t\tif (assetDidChange) {\r\n\t\t\tthis.onSubmit();\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateForm() {\r\n\t\tconst view = this.view;\r\n\t\tif (!this.type || this.type.name !== view.type.name) {\r\n\t\t\tthis.type = view.type;\r\n\t\t\tconst form = this.form;\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tform.removeKey(key);\r\n\t\t\t});\r\n\t\t\tlet keys;\r\n\t\t\tswitch (view.type.name) {\r\n\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name'];\r\n\t\t\t}\r\n\t\t\tif (view.type.name !== ViewType.WaitingRoom.name && environment.flags.ar) {\r\n\t\t\t\tkeys.push('usdz?');\r\n\t\t\t\tkeys.push('gltf?');\r\n\t\t\t}\r\n\t\t\tkeys.forEach(key => {\r\n\t\t\t\tconst optional = key.indexOf('?') !== -1;\r\n\t\t\t\tkey = key.replace('?', '');\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'latitude':\r\n\t\t\t\t\tcase 'longitude':\r\n\t\t\t\t\t\tconst orientation = view.orientation || { latitude: 0, longitude: 0 };\r\n\t\t\t\t\t\tform.add(new FormControl(orientation[key], RequiredValidator()), key);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'usdz':\r\n\t\t\t\t\tcase 'gltf':\r\n\t\t\t\t\t\tform.add(new FormControl((view.ar ? (view.ar[key] || null) : null), optional ? undefined : RequiredValidator()), key);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tform.add(new FormControl((view[key] != null ? view[key] : null), optional ? undefined : RequiredValidator()), key);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.controls = form.controls;\r\n\t\t}\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\tthis.doUpdateForm();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst payload = Object.assign({}, this.view, this.form.value);\r\n\t\t\tif (payload.latitude != null) { // !!! keep loose inequality\r\n\t\t\t\tpayload.orientation = {\r\n\t\t\t\t\tlatitude: payload.latitude,\r\n\t\t\t\t\tlongitude: payload.longitude,\r\n\t\t\t\t};\r\n\t\t\t\tdelete payload.latitude;\r\n\t\t\t\tdelete payload.longitude;\r\n\t\t\t}\r\n\t\t\tconst usdz = payload.usdz || null;\r\n\t\t\tconst gltf = payload.gltf || null;\r\n\t\t\tdelete payload.usdz;\r\n\t\t\tdelete payload.gltf;\r\n\t\t\tpayload.ar = (usdz || gltf) ? { usdz, gltf } : null;\r\n\t\t\tconst view = new View(payload);\r\n\t\t\tEditorService.viewUpdate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('UpdateViewComponent.onSubmit.viewUpdate$.success', response);\r\n\t\t\t\tthis.update.next({ view });\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.busy = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 300);\r\n\t\t\t}, error => console.log('UpdateViewComponent.onSubmit.viewUpdate$.error', error));\r\n\t\t\t// this.update.next({ view: new View(payload) });\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ src: environment.template.modal.remove, data: { item: this.item } }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view.selected ? null : this.view });\r\n\t}\r\n\r\n\tgetTitle(view) {\r\n\t\treturn LabelPipe.getKeys('editor', view.type.name);\r\n\t}\r\n}\r\n\r\nUpdateViewComponent.meta = {\r\n\tselector: 'update-view',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: view.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<!-- <div class=\"id\" [innerHTML]=\"view.id\"></div> -->\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon [name]=\"view.type.name\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\" [innerHTML]=\"getTitle(view)\"></div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"view.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<!-- <div control-text [control]=\"controls.type\" label=\"Type\" [disabled]=\"true\"></div> -->\r\n\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'waiting-room'\">\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'panorama'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'panorama-grid'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'model'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name != 'waiting-room' && ('ar' | flag)\">\r\n\t\t\t\t<div control-model [control]=\"controls.usdz\" label=\"AR IOS (.usdz)\" accept=\".usdz\"></div>\r\n\t\t\t\t<div control-model [control]=\"controls.gltf\" label=\"AR Android (.glb)\" accept=\".glb\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" *if=\"view.type.name != 'waiting-room'\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Module } from 'rxcomp';\r\nimport ToastOutletComponent from '../toast/toast-outlet.component';\r\nimport AsideComponent from './aside/aside.component';\r\nimport EditorComponent from './editor.component';\r\nimport MenuBuilderComponent from './menu/menu-builder.component';\r\nimport CurvedPlaneModalComponent from './modals/curved-plane-modal.component';\r\nimport ItemModelModalComponent from './modals/item-model-modal.component';\r\nimport ModelModalComponent from './modals/model-modal.component';\r\nimport NavModalComponent from './modals/nav-modal.component';\r\nimport PanoramaGridModalComponent from './modals/panorama-grid-modal.component';\r\nimport PanoramaModalComponent from './modals/panorama-modal.component';\r\nimport PlaneModalComponent from './modals/plane-modal.component';\r\nimport RemoveModalComponent from './modals/remove-modal.component';\r\nimport UpdateViewItemComponent from './update/update-view-item.component';\r\nimport UpdateViewTileComponent from './update/update-view-tile.component';\r\nimport UpdateViewComponent from './update/update-view.component';\r\n\r\nconst factories = [\r\n\tAsideComponent,\r\n\tCurvedPlaneModalComponent,\r\n\tEditorComponent,\r\n\tItemModelModalComponent,\r\n\tMenuBuilderComponent,\r\n\tModelModalComponent,\r\n\tNavModalComponent,\r\n\tPanoramaModalComponent,\r\n\tPanoramaGridModalComponent,\r\n\tPlaneModalComponent,\r\n\tRemoveModalComponent,\r\n\tToastOutletComponent,\r\n\tUpdateViewItemComponent,\r\n\tUpdateViewTileComponent,\r\n\tUpdateViewComponent,\r\n];\r\n\r\nconst pipes = [];\r\n\r\nexport class EditorModule extends Module { }\r\n\r\nEditorModule.meta = {\r\n\timports: [],\r\n\tdeclarations: [\r\n\t\t...factories,\r\n\t\t...pipes,\r\n\t],\r\n\texports: [\r\n\t\t...factories,\r\n\t\t...pipes,\r\n\t]\r\n};\r\n","import { Pipe } from \"rxcomp\";\r\nimport { environment } from \"../environment\";\r\n\r\nexport default class FlagPipe extends Pipe {\r\n\r\n\tstatic transform(key) {\r\n\t\tconst flags = environment.flags;\r\n\t\treturn flags[key] || false;\r\n\t}\r\n\r\n}\r\n\r\nFlagPipe.meta = {\r\n\tname: 'flag',\r\n};\r\n","import { isPlatformBrowser } from 'rxcomp';\r\nimport { BehaviorSubject, combineLatest, EMPTY, fromEvent, merge, of, ReplaySubject } from \"rxjs\";\r\nimport { delayWhen, filter, first, map, switchMap, tap } from \"rxjs/operators\";\r\nimport { Asset, assetTypeFromPath } from '../asset/asset';\r\nimport { AssetService } from '../asset/asset.service';\r\n\r\nexport class UploadItem {\r\n\r\n\tconstructor(file) {\r\n\t\tthis.file = file;\r\n\t\tthis.name = file.name;\r\n\t\tthis.type = assetTypeFromPath(file.name);\r\n\t\tthis.progress = 0;\r\n\t\tthis.size = file.size;\r\n\t\tthis.uploading = false;\r\n\t\tthis.paused = false;\r\n\t\tthis.success = false;\r\n\t\tthis.complete = false;\r\n\t\tthis.error = null;\r\n\t\tthis.preview = null;\r\n\t}\r\n\r\n}\r\n\r\nexport class UploadEvent {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class UploadStartEvent extends UploadEvent { }\r\n\r\nexport class UploadCompleteEvent extends UploadEvent { }\r\n\r\nexport class UploadAssetEvent extends UploadEvent { }\r\n\r\nexport class UploadService {\r\n\r\n\tconstructor() {\r\n\t\tthis.concurrent$ = new BehaviorSubject(0);\r\n\t\tthis.items$ = new BehaviorSubject([]);\r\n\t\tthis.events$ = new ReplaySubject(1);\r\n\t}\r\n\r\n\tupload$() {\r\n\t\tconst items = this.items$.getValue();\r\n\t\tconst uploadItems = items.filter(item => !item.uploading);\r\n\t\treturn combineLatest(uploadItems.map(item => this.uploadItem$(item)));\r\n\t}\r\n\r\n\tuploadItem$(item) {\r\n\t\t// max 4 concurrent upload\r\n\t\titem.uploading = true;\r\n\t\tthis.events$.next(new UploadStartEvent({ item }));\r\n\t\tconst files = [item.file];\r\n\t\treturn of(files).pipe(\r\n\t\t\tdelayWhen(() => this.concurrent$.pipe(\r\n\t\t\t\tfilter(x => x < 4)\r\n\t\t\t)),\r\n\t\t\ttap(() => this.concurrent$.next(this.concurrent$.getValue() + 1)),\r\n\t\t\tfirst(),\r\n\t\t\tswitchMap(files => AssetService.upload$(files)),\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\titem.uploading = false;\r\n\t\t\t\titem.complete = true;\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\tthis.events$.next(new UploadCompleteEvent({ item, asset }));\r\n\t\t\t\treturn AssetService.assetCreate$(asset).pipe(\r\n\t\t\t\t\ttap(asset => {\r\n\t\t\t\t\t\tthis.remove(item);\r\n\t\t\t\t\t\tthis.events$.next(new UploadAssetEvent({ item, asset }));\r\n\t\t\t\t\t\tthis.concurrent$.next(this.concurrent$.getValue() - 1);\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t);\r\n\t\t/*\r\n\t\t// concurrent upload\r\n\t\treturn AssetService.upload$([item.file]).pipe(\r\n\t\t\t// tap(upload => console.log('upload', upload)),\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\titem.uploading = false;\r\n\t\t\t\titem.complete = true;\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\tthis.events$.next(new UploadCompleteEvent({ item, asset }));\r\n\t\t\t\treturn AssetService.assetCreate$(asset).pipe(\r\n\t\t\t\t\ttap(asset => {\r\n\t\t\t\t\t\tthis.remove(item);\r\n\t\t\t\t\t\tthis.events$.next(new UploadAssetEvent({ item, asset }));\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\taddItems(files) {\r\n\t\tif (files && files.length) {\r\n\t\t\t// console.log('addItems', files);\r\n\t\t\tconst items = this.items$.getValue();\r\n\t\t\tconst newItems = Array.from(files).map(file => new UploadItem(file));\r\n\t\t\titems.push(...newItems);\r\n\t\t\tthis.items$.next(items);\r\n\t\t}\r\n\t}\r\n\r\n\tremove(item) {\r\n\t\tconst items = this.items$.getValue();\r\n\t\tconst index = items.indexOf(item);\r\n\t\tif (index !== -1) {\r\n\t\t\titems.splice(index, 1);\r\n\t\t}\r\n\t\tthis.items$.next(items);\r\n\t}\r\n\r\n\tremoveAll() {\r\n\t\t// !!!\r\n\t\tthis.items$.next([]);\r\n\t}\r\n\r\n\tdrop$(input, dropArea) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\tdropArea = dropArea || input;\r\n\t\t\tconst body = document.querySelector('body');\r\n\t\t\treturn merge(fromEvent(body, 'drop'), fromEvent(body, 'dragover')).pipe(\r\n\t\t\t\tmap((event) => {\r\n\t\t\t\t\t// console.log('UploadService.drop$', event);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\tif (event.target === dropArea) {\r\n\t\t\t\t\t\tthis.addItems(event.dataTransfer.files);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.items$;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tchange$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'change').pipe(\r\n\t\t\t\tswitchMap((event) => {\r\n\t\t\t\t\tif (input.files.length) {\r\n\t\t\t\t\t\tthis.addItems(input.files);\r\n\t\t\t\t\t\tinput.value = '';\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.items$;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tfiles$(files) {\r\n\t\treturn combineLatest(Array.from(files).map((file, i) => this.file$(file, i)));\r\n\t}\r\n\r\n\tfile$(file, i) {\r\n\t\treturn this.read$(file, i).pipe(\r\n\t\t\tswitchMap(() => this.uploadFile$(file)),\r\n\t\t);\r\n\t}\r\n\r\n\t/*\r\n\tstatic files$(files) {\r\n\t\tconst fileArray = Array.from(files);\r\n\t\tthis.previews = fileArray.map(() => null);\r\n\t\tconst uploads$ = fileArray.map((file, i) => this.read$(file, i).pipe(\r\n\t\t\tswitchMap(() => this.uploadFile$(file)),\r\n\t\t));\r\n\t\treturn combineLatest(uploads$);\r\n\t}\r\n\t*/\r\n\r\n\tread$(file, i) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\ttap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\tthis.resize(blob, (resized) => {\r\n\t\t\t\t\tthis.previews[i] = resized;\r\n\t\t\t\t\t// console.log('resized', resized);\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tuploadFile$(file) {\r\n\t\treturn AssetService.upload$([file]).pipe(\r\n\t\t\t// tap(upload => console.log('upload', upload)),\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\t/*\r\n\t\t\t\tid: 1601303293569\r\n\t\t\t\ttype: \"image/jpeg\"\r\n\t\t\t\tfile: \"1601303293569_ambiente1_x0_y2.jpg\"\r\n\t\t\t\toriginalFileName: \"ambiente1_x0_y2.jpg\"\r\n\t\t\t\turl: \"/uploads/1601303293569_ambiente1_x0_y2.jpg\"\r\n\t\t\t\t*/\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tresize(blob, callback) {\r\n\t\tif (typeof callback === 'function') {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tcallback(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.src = blob;\r\n\t\t}\r\n\t}\r\n\r\n\tsupported() {\r\n\t\treturn supportFileAPI() && supportAjaxUploadProgressEvents() && supportFormData();\r\n\t\tfunction supportFileAPI() {\r\n\t\t\tvar input = document.createElement('input');\r\n\t\t\tinput.type = 'file';\r\n\t\t\treturn 'files' in input;\r\n\t\t}\r\n\t\tfunction supportAjaxUploadProgressEvents() {\r\n\t\t\tvar xhr = new XMLHttpRequest();\r\n\t\t\treturn !!(xhr && ('upload' in xhr) && ('onprogress' in xhr.upload));\r\n\t\t}\r\n\t\tfunction supportFormData() {\r\n\t\t\treturn !!window.FormData;\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import { getContext } from 'rxcomp';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { UploadAssetEvent, UploadService } from '../upload/upload.service';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlAssetsComponent extends ControlComponent {\r\n\r\n\tget items() {\r\n\t\treturn this.items_;\r\n\t}\r\n\tset items(items) {\r\n\t\tthis.items_ = items;\r\n\t\tthis.uploadCount = items.reduce((p, c) => {\r\n\t\t\treturn p + (c.uploading || c.completed ? 0 : 1);\r\n\t\t}, 0);\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tthis.multiple = (this.multiple !== false);\r\n\t\tthis.items = [];\r\n\t\tthis.assets = this.control.value || [];\r\n\t\tthis.hasFiles = false;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tconst dropArea = node.querySelector('.upload-drop');\r\n\t\tconst service = this.service = new UploadService();\r\n\t\tservice.drop$(input, dropArea).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(items => {\r\n\t\t\t// console.log('ControlAssetComponent.drop$', items);\r\n\t\t\tthis.items = items;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tservice.change$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(items => {\r\n\t\t\t// console.log('ControlAssetComponent.change$', items);\r\n\t\t\tthis.items = items;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tservice.events$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\t// console.log('ControlAssetComponent.events$', event);\r\n\t\t\tif (event instanceof UploadAssetEvent) {\r\n\t\t\t\tthis.assets.push(event.asset);\r\n\t\t\t\tthis.control.value = this.assets;\r\n\t\t\t}\r\n\t\t\tthis.items = this.items;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// this.control.value = assets;\r\n\t\t});\r\n\t}\r\n\r\n\tonUpload() {\r\n\t\t// console.log('ControlAssetsComponent.onUpload');\r\n\t\tthis.service.upload$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe();\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\t// console.log('ControlAssetsComponent.onCancel');\r\n\t\tthis.service.removeAll();\r\n\t}\r\n\r\n\tonItemPause(item) {\r\n\t\t// console.log('ControlAssetsComponent.onPause', item);\r\n\t}\r\n\r\n\tonItemResume(item) {\r\n\t\t// console.log('ControlAssetsComponent.onResume', item);\r\n\t}\r\n\r\n\tonItemCancel(item) {\r\n\t\t// console.log('ControlAssetsComponent.onCancel', item);\r\n\t}\r\n\r\n\tonItemRemove(item) {\r\n\t\t// console.log('ControlAssetsComponent.onRemove', item);\r\n\t\tthis.service.remove(item);\r\n\t}\r\n}\r\n\r\nControlAssetsComponent.meta = {\r\n\tselector: '[control-assets]',\r\n\tinputs: ['control', 'label', 'multiple'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"listing--assets\">\r\n\t\t\t\t<div class=\"listing__item\" *for=\"let item of assets\">\r\n\t\t\t\t\t<div class=\"upload-item\">\r\n\t\t\t\t\t\t<div class=\"picture\">\r\n\t\t\t\t\t\t\t<img [lazy]=\"item | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"item.type.name === 'image'\" />\r\n\t\t\t\t\t\t\t<video [src]=\"item | asset\" *if=\"item.type.name === 'video'\"></video>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"name\" [innerHTML]=\"item.file\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"listing__item\" *for=\"let item of items\">\r\n\t\t\t\t\t<div upload-item [item]=\"item\" (pause)=\"onItemPause($event)\" (resume)=\"onItemResume($event)\" (cancel)=\"onItemCancel($event)\" (remove)=\"onItemRemove($event)\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<div class=\"btn--browse\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t\t<input type=\"file\" accept=\"image/jpeg\" multiple />\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"btn--upload\" (click)=\"onUpload()\" *if=\"uploadCount > 0\" [innerHTML]=\"'upload' | label\"></div>\r\n\t\t\t\t<div class=\"btn--cancel\" (click)=\"onCancel()\" *if=\"uploadCount > 0\" [innerHTML]=\"'cancel' | label\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"upload-drop\">\r\n    \t\t\t<span [innerHTML]=\"'drag_and_drop_images' | label\"></span>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlCheckboxComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t}\r\n\r\n}\r\n\r\nControlCheckboxComponent.meta = {\r\n\tselector: '[control-checkbox]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--checkbox\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label>\r\n\t\t\t\t<input type=\"checkbox\" class=\"control--checkbox\" [formControl]=\"control\" [value]=\"true\" />\r\n\t\t\t\t<span [innerHTML]=\"label | html\"></span>\r\n\t\t\t</label>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { fromEvent, merge } from 'rxjs';\r\nimport { filter, map, shareReplay, startWith } from 'rxjs/operators';\r\n\r\nexport default class KeyboardService {\r\n\r\n\tstatic keys = {};\r\n\r\n\tstatic keydown$() {\r\n\t\tif (!this.keydown$_) {\r\n\t\t\tthis.keydown$_ = fromEvent(window, 'keydown').pipe(\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.keydown$_;\r\n\t}\r\n\r\n\tstatic keyup$() {\r\n\t\tif (!this.keyup$_) {\r\n\t\t\tthis.keyup$_ = fromEvent(window, 'keyup').pipe(\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.keyup$_;\r\n\t}\r\n\r\n\tstatic keys$() {\r\n\t\tif (!this.keys$_) {\r\n\t\t\tthis.keys$_ = merge(this.keydown$(), this.keyup$()).pipe(\r\n\t\t\t\tmap(event => {\r\n\t\t\t\t\tconst keys = this.keys;\r\n\t\t\t\t\tif (event.type === 'keydown') {\r\n\t\t\t\t\t\tkeys[event.key] = true;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdelete keys[event.key];\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.keys;\r\n\t\t\t\t}),\r\n\t\t\t\tstartWith(this.keys),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.keys$_;\r\n\t}\r\n\r\n\tstatic key$() {\r\n\t\tif (!this.key$_) {\r\n\t\t\tconst regexp = /\\w/;\r\n\t\t\tthis.key$_ = this.keydown$().pipe(\r\n\t\t\t\tfilter(event => event.key && event.key.match(regexp)),\r\n\t\t\t\tmap(event => event.key),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.key$_;\r\n\t}\r\n\r\n\tstatic typing$() {\r\n\t\tif (!this.typing$_) {\r\n\t\t\tlet typing = '',\r\n\t\t\t\tto;\r\n\t\t\tthis.typing$_ = this.key$().pipe(\r\n\t\t\t\tmap(key => {\r\n\t\t\t\t\tif (to) {\r\n\t\t\t\t\t\tclearTimeout(to);\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttyping += key;\r\n\t\t\t\t\tto = setTimeout(() => {\r\n\t\t\t\t\t\ttyping = '';\r\n\t\t\t\t\t}, 1500);\r\n\t\t\t\t\treturn typing;\r\n\t\t\t\t}),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.typing$_;\r\n\t}\r\n\r\n}\r\n","import { getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport DropdownDirective from '../dropdown/dropdown.directive';\r\nimport KeyboardService from '../keyboard/keyboard.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlCustomSelectComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.dropped = false;\r\n\t\tthis.dropdownId = DropdownDirective.nextId();\r\n\t\tKeyboardService.typing$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(word => {\r\n\t\t\tthis.scrollToWord(word);\r\n\t\t});\r\n\t\t/*\r\n\t\tKeyboardService.key$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(key => {\r\n\t\t\tthis.scrollToKey(key);\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tscrollToWord(word) {\r\n\t\t// console.log('ControlCustomSelectComponent.scrollToWord', word);\r\n\t\tconst items = this.control.options || [];\r\n\t\tlet index = -1;\r\n\t\tfor (let i = 0; i < items.length; i++) {\r\n\t\t\tconst x = items[i];\r\n\t\t\tif (x.name.toLowerCase().indexOf(word.toLowerCase()) === 0) {\r\n\t\t\t\t// console.log(word, x.name);\r\n\t\t\t\tindex = i;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (index !== -1) {\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst dropdown = node.querySelector('.dropdown');\r\n\t\t\tconst navDropdown = node.querySelector('.nav--dropdown');\r\n\t\t\tconst item = navDropdown.children[index];\r\n\t\t\tdropdown.scrollTo(0, item.offsetTop);\r\n\t\t}\r\n\t}\r\n\r\n\tsetOption(item) {\r\n\t\t// console.log('setOption', item, this.isMultiple);\r\n\t\tlet value;\r\n\t\tif (this.isMultiple) {\r\n\t\t\tconst value = this.control.value || [];\r\n\t\t\tconst index = value.indexOf(item.id);\r\n\t\t\tif (index !== -1) {\r\n\t\t\t\t// if (value.length > 1) {\r\n\t\t\t\tvalue.splice(index, 1);\r\n\t\t\t\t// }\r\n\t\t\t} else {\r\n\t\t\t\tvalue.push(item.id);\r\n\t\t\t}\r\n\t\t\tvalue = value.length ? value.slice() : null;\r\n\t\t} else {\r\n\t\t\tvalue = item.id;\r\n\t\t\t// DropdownDirective.dropdown$.next(null);\r\n\t\t}\r\n\t\tthis.control.value = value;\r\n\t\tthis.change.next(value);\r\n\t}\r\n\r\n\thasOption(item) {\r\n\t\tif (this.isMultiple) {\r\n\t\t\tconst values = this.control.value || [];\r\n\t\t\treturn values.indexOf(item.id) !== -1;\r\n\t\t} else {\r\n\t\t\treturn this.control.value === item.id;\r\n\t\t}\r\n\t}\r\n\r\n\tgetLabel() {\r\n\t\tlet value = this.control.value;\r\n\t\tconst items = this.control.options || [];\r\n\t\tif (this.isMultiple) {\r\n\t\t\tvalue = value || [];\r\n\t\t\tif (value.length) {\r\n\t\t\t\treturn value.map(v => {\r\n\t\t\t\t\tconst item = items.find(x => x.id === v || x.name === v);\r\n\t\t\t\t\treturn item ? item.name : '';\r\n\t\t\t\t}).join(', ');\r\n\t\t\t} else {\r\n\t\t\t\treturn LabelPipe.transform('select');\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconst item = items.find(x => x.id === value || x.name === value);\r\n\t\t\tif (item) {\r\n\t\t\t\treturn item.name;\r\n\t\t\t} else {\r\n\t\t\t\treturn LabelPipe.transform('select');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDropped($event) {\r\n\t\t// console.log('ControlCustomSelectComponent.onDropped', id);\r\n\t\tif (this.dropped && $event === null) {\r\n\t\t\tthis.control.touched = true;\r\n\t\t}\r\n\t\tthis.dropped = $event === this.dropdownId;\r\n\t}\r\n\r\n\tget isMultiple() {\r\n\t\treturn this.multiple && this.multiple !== false && this.multiple !== 'false';\r\n\t}\r\n}\r\n\r\nControlCustomSelectComponent.meta = {\r\n\tselector: '[control-custom-select]',\r\n\toutputs: ['change'],\r\n\tinputs: ['control', 'label', 'multiple'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--select\" [class]=\"{ required: control.validators.length, multiple: isMultiple }\" [dropdown]=\"dropdownId\" (dropped)=\"onDropped($event)\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<span class=\"control--custom-select\" [innerHTML]=\"getLabel()\"></span>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t\t<div class=\"dropdown\" [dropdown-item]=\"dropdownId\">\r\n\t\t\t<div class=\"category\" [innerHTML]=\"label\"></div>\r\n\t\t\t<ul class=\"nav--dropdown\" [class]=\"{ multiple: isMultiple }\">\r\n\t\t\t\t<li (click)=\"setOption(item)\" [class]=\"{ empty: item.id == null }\" *for=\"let item of control.options\">\r\n\t\t\t\t\t<span [class]=\"{ active: hasOption(item) }\" [innerHTML]=\"item.name\"></span>\r\n\t\t\t\t</li>\r\n\t\t\t</ul>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlLinkComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\tmerge(fromEvent(input, 'input')).pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidChange(event));\r\n\t\tfromEvent(input, 'blur').pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidBlur(event));\r\n\t}\r\n\r\n\tonInputDidChange(event) {\r\n\t\tconsole.log('ControlLinkComponent.onInputDidChange', event.target.value);\r\n\t\t// event.target.value = event.target.value.replace(/[^\\d|\\.]/g, '');\r\n\t\t/*\r\n\t\tconst value = parseFloat(event.target.value);\r\n\t\tif (this.value !== value) {\r\n\t\t\tif (value !== NaN) {\r\n\t\t\t\tthis.value = value;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t}\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tonInputDidBlur(event) {\r\n\t\tconsole.log('ControlLinkComponent.onInputDidBlur', event.target.value);\r\n\t\tthis.control.touched = true;\r\n\t\tthis.value = this.input.value;\r\n\t}\r\n\r\n}\r\n\r\nControlLinkComponent.meta = {\r\n\tselector: '[control-link]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [disabled]=\"disabled\" />\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest } from 'rxjs';\r\nimport { switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport { environment } from '../environment';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlLocalizedAssetComponent extends ControlComponent {\r\n\r\n\tget localizedValue() {\r\n\t\tlet asset = this.control.value;\r\n\t\tif (asset && asset.locale) {\r\n\t\t\tconst localizedAsset = asset.locale[this.currentLanguage];\r\n\t\t\tif (localizedAsset) {\r\n\t\t\t\tasset = localizedAsset;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn asset;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tthis.languages = environment.languages;\r\n\t\tthis.currentLanguage = environment.defaultLanguage;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tDropService.drop$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => (this.languages.length > 1 ? AssetService.createOrUpdateLocalizedAsset$ : AssetService.createOrUpdateAsset$)(uploads, this.control, this.currentLanguage)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(assets => {\r\n\t\t\t// console.log('ControlLocalizedAssetComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n\r\n\tsetLanguage(language) {\r\n\t\tthis.currentLanguage = language;\r\n\t\tthis.pushChanges();\r\n\t}\r\n}\r\n\r\nControlLocalizedAssetComponent.meta = {\r\n\tselector: '[control-localized-asset]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--picture\">\r\n\t\t\t\t<div class=\"group--picture__info\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<img [lazy]=\"localizedValue | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"localizedValue && localizedValue.type.name === 'image'\" />\r\n\t\t\t\t<video [src]=\"localizedValue | asset\" *if=\"localizedValue && localizedValue.type.name === 'video'\"></video>\r\n\t\t\t\t<input type=\"file\">\r\n\t\t\t</div>\r\n\t\t\t<div class=\"file-name\" *if=\"localizedValue\" [innerHTML]=\"localizedValue.file\"></div>\r\n\t\t\t<ul class=\"nav--languages\" *if=\"languages.length > 1\">\r\n\t\t\t\t<li class=\"nav__item\" [class]=\"{ active: lang == currentLanguage }\" (click)=\"setLanguage(lang)\" [innerHTML]=\"lang\" *for=\"let lang of languages\"></li>\r\n\t\t\t</ul>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest, of } from 'rxjs';\r\nimport { first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport ControlAssetComponent from './control-asset.component';\r\n\r\nexport default class ControlModelComponent extends ControlAssetComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || '.glb';\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\t/*\r\n\t\tthis.click$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\t*/\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => AssetService.createOrUpdateAsset$(uploads, this.control)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(assets => {\r\n\t\t\tconsole.log('ControlModelComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tAssetService.assetDelete$(this.control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.control.value = null;\r\n\t\t\tthis.input.value = null;\r\n\t\t\tthis.control.touched = true; // !!!\r\n\t\t});\r\n\t\t// !!! delete upload\r\n\t\t// !!! delete asset\r\n\t}\r\n\r\n\t/*\r\n\tclick$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'click').pipe(\r\n\t\t\t\ttap(() => input.value = null),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\tread$(file, i) {\r\n\t\treturn of(file);\r\n\t}\r\n}\r\n\r\nControlModelComponent.meta = {\r\n\tselector: '[control-model]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--model\">\r\n\t\t\t\t<div class=\"file-name\" *if=\"!control.value\" [innerHTML]=\"'select_file' | label\"></div>\r\n\t\t\t\t<div class=\"file-name\" *if=\"control.value\" [innerHTML]=\"control.value.file\"></div>\r\n\t\t\t\t<div class=\"btn--upload\"><input type=\"file\"><span [innerHTML]=\"'browse' | label\"></span></div>\r\n\t\t\t\t<div class=\"btn--remove\" *if=\"control.value\" (click)=\"onRemove($event)\"><span [innerHTML]=\"'remove' | label\"></span></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlNumberComponent extends ControlComponent {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\tupdateValue(value) {\r\n\t\tthis.control.value = value;\r\n\t}\r\n}\r\n\r\nControlNumberComponent.meta = {\r\n\tselector: '[control-number]',\r\n\tinputs: ['control', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"control--content control--number\">\r\n\t\t\t\t<input-value label=\"\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value\" (update)=\"updateValue($event)\"></input-value>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlPasswordComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t}\r\n\r\n}\r\n\r\nControlPasswordComponent.meta = {\r\n\tselector: '[control-password]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<input type=\"password\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" />\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlSelectComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t}\r\n\r\n}\r\n\r\nControlSelectComponent.meta = {\r\n\tselector: '[control-select]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--select\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<select class=\"control--select\" [formControl]=\"control\" required>\r\n\t\t\t\t<option [value]=\"null\" [innerHTML]=\"'select' | label\"></option>\r\n\t\t\t\t<option [value]=\"item.id\" *for=\"let item of control.options\" [innerHTML]=\"item.name\"></option>\r\n\t\t\t</select>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlTextComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\r\n}\r\n\r\nControlTextComponent.meta = {\r\n\tselector: '[control-text]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [disabled]=\"disabled\" />\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlTextareaComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\r\n}\r\n\r\nControlTextareaComponent.meta = {\r\n\tselector: '[control-textarea]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--textarea\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<textarea class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [innerHTML]=\"label\" rows=\"6\" [disabled]=\"disabled\"></textarea>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlVectorComponent extends ControlComponent {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\tupdateValue(index, value) {\r\n\t\tconst values = this.control.value;\r\n\t\tvalues[index] = value;\r\n\t\tthis.control.value = values.slice();\r\n\t}\r\n}\r\n\r\nControlVectorComponent.meta = {\r\n\tselector: '[control-vector]',\r\n\tinputs: ['control', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"control--content control--vector\">\r\n\t\t\t\t<input-value label=\"x\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[0]\" (update)=\"updateValue(0, $event)\"></input-value>\r\n\t\t\t\t<input-value label=\"y\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[1]\" (update)=\"updateValue(1, $event)\"></input-value>\r\n\t\t\t\t<input-value label=\"z\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[2]\" (update)=\"updateValue(2, $event)\"></input-value>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class DisabledDirective extends Directive {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log('DisabledDirective.onChanges', this.disabled);\r\n\t\tif (this.disabled === true) {\r\n\t\t\tnode.disabled = this.disabled;\r\n\t\t\tnode.setAttribute('disabled', this.disabled);\r\n\t\t} else {\r\n\t\t\tdelete node.disabled;\r\n\t\t\tnode.removeAttribute('disabled');\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nDisabledDirective.meta = {\r\n\tselector: 'input[disabled],textarea[disabled]',\r\n\tinputs: ['disabled'],\r\n};\r\n","import LabelPipe from '../label/label.pipe';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ErrorsComponent extends ControlComponent {\r\n\tgetLabel(key, value) {\r\n\t\tconst label = LabelPipe.transform(`error_${key}`);\r\n\t\treturn label;\r\n\t}\r\n}\r\n\r\nErrorsComponent.meta = {\r\n\tselector: 'errors-component',\r\n\tinputs: ['control'],\r\n\ttemplate: /* html */ `\r\n\t<div class=\"inner\" [style]=\"{ display: control.invalid && control.touched ? 'block' : 'none' }\">\r\n\t\t<div class=\"error\" *for=\"let [key, value] of control.errors\">\r\n\t\t\t<span [innerHTML]=\"getLabel(key, value)\"></span>\r\n\t\t\t<!-- <span class=\"key\" [innerHTML]=\"key\"></span> <span class=\"value\" [innerHTML]=\"value | json\"></span> -->\r\n\t\t</div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { fromEvent, interval, merge, race } from 'rxjs';\r\nimport { filter, map, switchMap, takeUntil, tap } from 'rxjs/operators';\r\n\r\nexport default class InputValueComponent extends Component {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.value = this.value || 0;\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.increment$('.btn--more', 1)\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe((event) => {\r\n\t\t\t\t// console.log('InputValueComponent.increment$', event);\r\n\t\t\t\tthis.value += event;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\tthis.increment$('.btn--less', -1)\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe((event) => {\r\n\t\t\t\t// console.log('InputValueComponent.increment$', event);\r\n\t\t\t\tthis.value += event;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\t// fromEvent(input, 'change')\r\n\t\tmerge(fromEvent(input, 'input')).pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidChange(event));\r\n\t\tfromEvent(input, 'blur').pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidBlur(event));\r\n\t\t// fromEvent(node, 'focus').pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onFocus(event));\r\n\t}\r\n\r\n\tonInputDidChange(event) {\r\n\t\t// const node = getContext(this).node;\r\n\t\t// const value = node.value === '' ? null : node.value;\r\n\t\tevent.target.value = event.target.value.replace(/[^\\d|\\.]/g, '');\r\n\t\t// console.log('InputValueComponent.onInputDidChange', event.target.value);\r\n\t\t/*\r\n\t\tconst value = parseFloat(event.target.value);\r\n\t\tif (this.value !== value) {\r\n\t\t\tif (value !== NaN) {\r\n\t\t\t\tthis.value = value;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t}\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tonInputDidBlur(event) {\r\n\t\t// this.control.touched = true;\r\n\t\t// console.log('InputValueComponent.onInputDidBlur', event.target.value);\r\n\t\tconst value = parseFloat(this.input.value);\r\n\t\tif (this.value !== value) {\r\n\t\t\tif (value !== NaN) {\r\n\t\t\t\tthis.value = value;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t} else {\r\n\t\t\t\tthis.input.value = this.getValue();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tincrement$(selector, sign) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst element = node.querySelector(selector);\r\n\t\tlet m, increment;\r\n\t\treturn race(fromEvent(element, 'mousedown'), fromEvent(element, 'touchstart')).pipe(\r\n\t\t\ttap(() => {\r\n\t\t\t\tincrement = this.increment;\r\n\t\t\t\tm = 32;\r\n\t\t\t}),\r\n\t\t\tswitchMap((e) => {\r\n\t\t\t\treturn interval(30).pipe(\r\n\t\t\t\t\tfilter((i) => {\r\n\t\t\t\t\t\treturn i % m === 0;\r\n\t\t\t\t\t}),\r\n\t\t\t\t\tmap(() => {\r\n\t\t\t\t\t\tconst i = increment * sign;\r\n\t\t\t\t\t\t// increment = Math.min(this.increment * 100, increment * 2);\r\n\t\t\t\t\t\tm = Math.max(1, Math.floor(m * 0.85));\r\n\t\t\t\t\t\treturn i;\r\n\t\t\t\t\t}),\r\n\t\t\t\t\t// startWith(increment * sign),\r\n\t\t\t\t\ttakeUntil(race(fromEvent(element, 'mouseup'), fromEvent(element, 'touchend')))\r\n\t\t\t\t);\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\tgetValue() {\r\n\t\treturn this.value.toFixed(this.precision);\r\n\t}\r\n\tsetValue(sign) {\r\n\t\tthis.value += this.increment * sign;\r\n\t\tthis.update.next(this.value);\r\n\t\tthis.pushChanges();\r\n\t}\r\n}\r\n\r\nInputValueComponent.meta = {\r\n\tselector: 'input-value',\r\n\toutputs: ['update'],\r\n\tinputs: ['value', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--control\" [class]=\"{ disabled: disabled }\">\r\n\t\t\t<input type=\"text\" class=\"control--text\" [placeholder]=\"label\" [value]=\"getValue()\" [disabled]=\"disabled\" />\r\n\t\t\t<div class=\"control--trigger\">\r\n\t\t\t\t<div class=\"btn--more\" (click)=\"setValue(1)\">+</div>\r\n\t\t\t\t<div class=\"btn--less\" (click)=\"setValue(-1)\">-</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { ENV } from '../environment';\r\n\r\nexport default class TestComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.env = ENV;\r\n\t}\r\n\r\n\tonTest(event) {\r\n\t\tthis.test.next(event);\r\n\t}\r\n\r\n\tonReset(event) {\r\n\t\tthis.reset.next(event);\r\n\t}\r\n\r\n}\r\n\r\nTestComponent.meta = {\r\n\tselector: 'test-component',\r\n\tinputs: ['form'],\r\n\toutputs: ['test', 'reset'],\r\n\ttemplate: /* html */ `\r\n\t<div class=\"group--form--results\" *if=\"env.DEVELOPMENT\">\r\n\t\t<code [innerHTML]=\"form.value | json\"></code>\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onTest($event)\"><span>test</span></button>\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onReset($event)\"><span>reset</span></button>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class ValueDirective extends Directive {\r\n\r\n\tonChanges(changes) {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log('ValueDirective.onChanges', this.value);\r\n\t\tnode.value = this.value;\r\n\t\tnode.setAttribute('value', this.value);\r\n\t}\r\n\r\n}\r\n\r\nValueDirective.meta = {\r\n\tselector: '[value]',\r\n\tinputs: ['value'],\r\n};\r\n","import { Pipe } from \"rxcomp\";\r\n\r\n/*\r\n['quot', 'amp', 'apos', 'lt', 'gt', 'nbsp', 'iexcl', 'cent', 'pound', 'curren', 'yen', 'brvbar', 'sect', 'uml', 'copy', 'ordf', 'laquo', 'not', 'shy', 'reg', 'macr', 'deg', 'plusmn', 'sup2', 'sup3', 'acute', 'micro', 'para', 'middot', 'cedil', 'sup1', 'ordm', 'raquo', 'frac14', 'frac12', 'frac34', 'iquest', 'Agrave', 'Aacute', 'Acirc', 'Atilde', 'Auml', 'Aring', 'AElig', 'Ccedil', 'Egrave', 'Eacute', 'Ecirc', 'Euml', 'Igrave', 'Iacute', 'Icirc', 'Iuml', 'ETH', 'Ntilde', 'Ograve', 'Oacute', 'Ocirc', 'Otilde', 'Ouml', 'times', 'Oslash', 'Ugrave', 'Uacute', 'Ucirc', 'Uuml', 'Yacute', 'THORN', 'szlig', 'agrave', 'aacute', 'atilde', 'auml', 'aring', 'aelig', 'ccedil', 'egrave', 'eacute', 'ecirc', 'euml', 'igrave', 'iacute', 'icirc', 'iuml', 'eth', 'ntilde', 'ograve', 'oacute', 'ocirc', 'otilde', 'ouml', 'divide', 'oslash', 'ugrave', 'uacute', 'ucirc', 'uuml', 'yacute', 'thorn', 'yuml', 'amp', 'bull', 'deg', 'infin', 'permil', 'sdot', 'plusmn', 'dagger', 'mdash', 'not', 'micro', 'perp', 'par', 'euro', 'pound', 'yen', 'cent', 'copy', 'reg', 'trade', 'alpha', 'beta', 'gamma', 'delta', 'epsilon', 'zeta', 'eta', 'theta', 'iota', 'kappa', 'lambda', 'mu', 'nu', 'xi', 'omicron', 'pi', 'rho', 'sigma', 'tau', 'upsilon', 'phi', 'chi', 'psi', 'omega', 'Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta', 'Iota', 'Kappa', 'Lambda', 'Mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho', 'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'];\r\n['\"', '&', ''', '<', '>', ' ', '¡', '¢', '£', '¤', '¥', '¦', '§', '¨', '©', 'ª', '«', '¬', '­', '®', '¯', '°', '±', '²', '³', '´', 'µ', '¶', '·', '¸', '¹', 'º', '»', '¼', '½', '¾', '¿', 'À', 'Á', 'Â', 'Ã', 'Ä', 'Å', 'Æ', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ð', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', '×', 'Ø', 'Ù', 'Ú', 'Û', 'Ü', 'Ý', 'Þ', 'ß', 'à', 'á', 'ã', 'ä', 'å', 'æ', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ð', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', '÷', 'ø', 'ù', 'ú', 'û', 'ü', 'ý', 'þ', 'ÿ', '&', '•', '°', '∞', '‰', '⋅', '±', '†', '—', '¬', 'µ', '⊥', '∥', '€', '£', '¥', '¢', '©', '®', '™', 'α', 'β', 'γ', 'δ', 'ε', 'ζ', 'η', 'θ', 'ι', 'κ', 'λ', 'μ', 'ν', 'ξ', 'ο', 'π', 'ρ', 'σ', 'τ', 'υ', 'φ', 'χ', 'ψ', 'ω', 'Α', 'Β', 'Γ', 'Δ', 'Ε', 'Ζ', 'Η', 'Θ', 'Ι', 'Κ', 'Λ', 'Μ', 'Ν', 'Ξ', 'Ο', 'Π', 'Ρ', 'Σ', 'Τ', 'Υ', 'Φ', 'Χ', 'Ψ', 'Ω'];\r\n*/\r\n\r\nexport default class HtmlPipe extends Pipe {\r\n\r\n\tstatic transform(value) {\r\n\t\tif (value) {\r\n\t\t\tvalue = value.replace(/&#(\\d+);/g, function(m, n) {\r\n\t\t\t\treturn String.fromCharCode(parseInt(n));\r\n\t\t\t});\r\n\t\t\tconst escapes = ['quot', 'amp', 'apos', 'lt', 'gt', 'nbsp', 'iexcl', 'cent', 'pound', 'curren', 'yen', 'brvbar', 'sect', 'uml', 'copy', 'ordf', 'laquo', 'not', 'shy', 'reg', 'macr', 'deg', 'plusmn', 'sup2', 'sup3', 'acute', 'micro', 'para', 'middot', 'cedil', 'sup1', 'ordm', 'raquo', 'frac14', 'frac12', 'frac34', 'iquest', 'Agrave', 'Aacute', 'Acirc', 'Atilde', 'Auml', 'Aring', 'AElig', 'Ccedil', 'Egrave', 'Eacute', 'Ecirc', 'Euml', 'Igrave', 'Iacute', 'Icirc', 'Iuml', 'ETH', 'Ntilde', 'Ograve', 'Oacute', 'Ocirc', 'Otilde', 'Ouml', 'times', 'Oslash', 'Ugrave', 'Uacute', 'Ucirc', 'Uuml', 'Yacute', 'THORN', 'szlig', 'agrave', 'aacute', 'atilde', 'auml', 'aring', 'aelig', 'ccedil', 'egrave', 'eacute', 'ecirc', 'euml', 'igrave', 'iacute', 'icirc', 'iuml', 'eth', 'ntilde', 'ograve', 'oacute', 'ocirc', 'otilde', 'ouml', 'divide', 'oslash', 'ugrave', 'uacute', 'ucirc', 'uuml', 'yacute', 'thorn', 'yuml', 'amp', 'bull', 'deg', 'infin', 'permil', 'sdot', 'plusmn', 'dagger', 'mdash', 'not', 'micro', 'perp', 'par', 'euro', 'pound', 'yen', 'cent', 'copy', 'reg', 'trade', 'alpha', 'beta', 'gamma', 'delta', 'epsilon', 'zeta', 'eta', 'theta', 'iota', 'kappa', 'lambda', 'mu', 'nu', 'xi', 'omicron', 'pi', 'rho', 'sigma', 'tau', 'upsilon', 'phi', 'chi', 'psi', 'omega', 'Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta', 'Iota', 'Kappa', 'Lambda', 'Mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho', 'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'];\r\n\t\t\tconst unescapes = ['\"', '&', '\\'', '<', '>', ' ', '¡', '¢', '£', '¤', '¥', '¦', '§', '¨', '©', 'ª', '«', '¬', '­', '®', '¯', '°', '±', '²', '³', '´', 'µ', '¶', '·', '¸', '¹', 'º', '»', '¼', '½', '¾', '¿', 'À', 'Á', 'Â', 'Ã', 'Ä', 'Å', 'Æ', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ð', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', '×', 'Ø', 'Ù', 'Ú', 'Û', 'Ü', 'Ý', 'Þ', 'ß', 'à', 'á', 'ã', 'ä', 'å', 'æ', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ð', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', '÷', 'ø', 'ù', 'ú', 'û', 'ü', 'ý', 'þ', 'ÿ', '&', '•', '°', '∞', '‰', '⋅', '±', '†', '—', '¬', 'µ', '⊥', '∥', '€', '£', '¥', '¢', '©', '®', '™', 'α', 'β', 'γ', 'δ', 'ε', 'ζ', 'η', 'θ', 'ι', 'κ', 'λ', 'μ', 'ν', 'ξ', 'ο', 'π', 'ρ', 'σ', 'τ', 'υ', 'φ', 'χ', 'ψ', 'ω', 'Α', 'Β', 'Γ', 'Δ', 'Ε', 'Ζ', 'Η', 'Θ', 'Ι', 'Κ', 'Λ', 'Μ', 'Ν', 'Ξ', 'Ο', 'Π', 'Ρ', 'Σ', 'Τ', 'Υ', 'Φ', 'Χ', 'Ψ', 'Ω'];\r\n\t\t\tconst rx = new RegExp(`(&${escapes.join(';)|(&')};)`, 'g');\r\n\t\t\tvalue = value.replace(rx, function() {\r\n\t\t\t\tfor (let i = 1; i < arguments.length; i++) {\r\n\t\t\t\t\tif (arguments[i]) {\r\n\t\t\t\t\t\t// console.log(arguments[i], unescapes[i - 1]);\r\n\t\t\t\t\t\treturn unescapes[i - 1];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t// console.log(value);\r\n\t\t\treturn value;\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nHtmlPipe.meta = {\r\n\tname: 'html',\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class IdDirective extends Directive {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.setAttribute('id', this.id);\r\n\t}\r\n\r\n}\r\n\r\nIdDirective.meta = {\r\n\tselector: '[id]',\r\n\tinputs: ['id']\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\n\r\nexport default class LayoutComponent extends Component {\r\n\r\n\tget uiClass() {\r\n\t\tconst uiClass = {};\r\n\t\tuiClass[this.state.role] = true;\r\n\t\tuiClass.chat = this.state.chat;\r\n\t\treturn uiClass;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.env = environment;\r\n\t\tthis.state = {\r\n\t\t\tstatus: LocationService.get('status') || 'connected',\r\n\t\t\trole: LocationService.get('role') || 'publisher',\r\n\t\t\tmembersCount: 1,\r\n\t\t\tlive: true,\r\n\t\t\tchat: false,\r\n\t\t\tchatDirty: true,\r\n\t\t\tname: \"Jhon Appleseed\",\r\n\t\t\tuid: \"7341614597544882\"\r\n\t\t};\r\n\t\tthis.state.has3D = this.state.role !== RoleType.SmartDevice;\r\n\t\tthis.view = {\r\n\t\t\tlikes: 41,\r\n\t\t};\r\n\t\tthis.local = {};\r\n\t\tthis.screen = null;\r\n\t\tthis.remotes = new Array(8).fill(0).map((x, i) => ({ id: i + 1, }));\r\n\t\tStateService.patchState(this.state);\r\n\t\tconsole.log('LayoutComponent', this);\r\n\t\t// console.log(AgoraService.getUniqueUserId());\r\n\t}\r\n\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tthis.patchState({ cameraMuted: !this.state.cameraMuted });\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tthis.patchState({ audioMuted: !this.state.audioMuted });\r\n\t}\r\n\r\n\ttoggleScreen() {\r\n\t\tthis.patchState({ screen: !this.state.screen });\r\n\t}\r\n\r\n\ttoggleVolume() {\r\n\t\tthis.patchState({ volumeMuted: !this.state.volumeMuted });\r\n\t}\r\n\r\n\ttoggleChat() {\r\n\t\tthis.patchState({ chat: !this.state.chat, chatDirty: false });\r\n\t}\r\n\r\n\tonChatClose() {\r\n\t\tthis.patchState({ chat: false });\r\n\t}\r\n\r\n\tonToggleControl() {\r\n\t\tthis.patchState({ control: !this.state.control, spying: false });\r\n\t}\r\n\r\n\tonToggleSpy(remoteId) {\r\n\t\tconst spying = this.state.spying === remoteId ? null : remoteId;\r\n\t\tthis.patchState({ spying, control: false });\r\n\t}\r\n\r\n\taddLike() {\r\n\t\tthis.view.liked = true; // view.liked;\r\n\t\tthis.showLove(this.view);\r\n\t}\r\n\r\n\tshowLove(view) {\r\n\t\tif (view && this.view.id === view.id) {\r\n\t\t\tconst skipTimeout = this.view.showLove;\r\n\t\t\tthis.view.likes = view.likes;\r\n\t\t\tthis.view.showLove = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (!skipTimeout) {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.view.showLove = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 3100);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tdisconnect() {\r\n\r\n\t}\r\n}\r\n\r\nLayoutComponent.meta = {\r\n\tselector: '[layout-component]',\r\n};\r\n","import { fromEvent, of } from 'rxjs';\r\nimport { auditTime, filter, finalize, map, takeWhile } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\n\r\nlet UID = 0;\r\n\r\nexport const ImageServiceEvent = {\r\n\tProgress: 'progress',\r\n\tComplete: 'complete',\r\n};\r\nexport default class ImageService {\r\n\r\n\tstatic worker() {\r\n\t\tif (!this.worker_) {\r\n\t\t\tthis.worker_ = new Worker(environment.worker);\r\n\t\t}\r\n\t\treturn this.worker_;\r\n\t}\r\n\r\n\tstatic events$(src, size) {\r\n\t\tif (!('Worker' in window) || this.isBlob(src) || this.isCors(src)) {\r\n\t\t\treturn of({ type: ImageServiceEvent.Complete, data:src });\r\n\t\t}\r\n\t\tconst id = ++UID;\r\n\t\tconst worker = this.worker();\r\n\t\tworker.postMessage({ src, id, size });\r\n\t\tlet lastEvent;\r\n\t\treturn fromEvent(worker, 'message').pipe(\r\n\t\t\tmap(event => event.data),\r\n\t\t\tfilter(event => event.src === src),\r\n\t\t\tauditTime(100),\r\n\t\t\tmap(event => {\r\n\t\t\t\t// console.log('ImageService', event);\r\n\t\t\t\tif (event.type === ImageServiceEvent.Complete && event.data instanceof Blob) {\r\n\t\t\t\t\tconst url = URL.createObjectURL(event.data);\r\n\t\t\t\t\tevent.data = url;\r\n\t\t\t\t}\r\n\t\t\t\tlastEvent = event;\r\n\t\t\t\treturn event;\r\n\t\t\t}),\r\n\t\t\ttakeWhile(event => event.type !== ImageServiceEvent.Complete, true),\r\n\t\t\tfinalize(() => {\r\n\t\t\t\t// console.log('ImageService.finalize', lastEvent);\r\n\t\t\t\tworker.postMessage({ id });\r\n\t\t\t\t/*\r\n\t\t\t\tif (lastEvent && lastEvent.type === ImageServiceEvent.Complete && lastEvent.data) {\r\n\t\t\t\t\tURL.revokeObjectURL(lastEvent.data);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic load$(src, size) {\r\n\t\treturn this.events$(src, size).pipe(\r\n\t\t\tfilter(event => event.type === ImageServiceEvent.Complete),\r\n\t\t\tmap(event => event.data),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic isCors(src) {\r\n\t\t// !!! handle cors environment flag\r\n\t\treturn false;\r\n\t\treturn src.indexOf('://') !== -1 && src.indexOf(window.location.host) === -1;\r\n\t}\r\n\r\n\tstatic isBlob(src) {\r\n\t\treturn src.indexOf('blob:') === 0;\r\n\t}\r\n\r\n}\r\n","import { BehaviorSubject, of , Subject } from 'rxjs';\r\nimport { filter, finalize, first, map } from 'rxjs/operators';\r\n\r\nexport default class IntersectionService {\r\n\r\n\tstatic observer() {\r\n\t\tif (!this.observer_) {\r\n\t\t\tthis.readySubject_ = new BehaviorSubject(false);\r\n\t\t\tthis.observerSubject_ = new Subject();\r\n\t\t\tthis.observer_ = new IntersectionObserver(entries => {\r\n\t\t\t\tthis.observerSubject_.next(entries);\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn this.observer_;\r\n\t}\r\n\r\n\tstatic intersection$(node) {\r\n\t\tif ('IntersectionObserver' in window) {\r\n\t\t\tconst observer = this.observer();\r\n\t\t\tobserver.observe(node);\r\n\t\t\treturn this.observerSubject_.pipe(\r\n\t\t\t\t// tap(entries => console.log(entries.length)),\r\n\t\t\t\tmap(entries => entries.find(entry => entry.target === node)),\r\n\t\t\t\t// tap(entry => console.log('IntersectionService.intersection$', entry)),\r\n\t\t\t\tfilter(entry => entry !== undefined && entry.isIntersecting), // entry.intersectionRatio > 0\r\n\t\t\t\tfirst(),\r\n\t\t\t\tfinalize(() => observer.unobserve(node)),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of({ target: node });\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\tfunction observer() {\r\n\t\t\tif ('IntersectionObserver' in window) {\r\n\t\t\t\treturn new IntersectionObserver(entries => {\r\n\t\t\t\t\tentries.forEach(function(entry) {\r\n\t\t\t\t\t\tif (entry.isIntersecting) {\r\n\t\t\t\t\t\t\tentry.target.classList.add('appear');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\treturn { observe: function(node) { node.classList.add('appear')}, unobserve: function() {} };\r\n\t\t\t}\r\n\t\t}\r\n\t\tobserver.observe(node);\r\n\t\tobserver.unobserve(node);\r\n\t\t*/\r\n\r\n\t}\r\n\r\n}\r\n","export default class LazyCache {\r\n\tstatic get cache() {\r\n\t\tif (!this.cache_) {\r\n\t\t\tthis.cache_ = {};\r\n\t\t}\r\n\t\treturn this.cache_;\r\n\t}\r\n\r\n\tstatic get(src) {\r\n\t\treturn this.cache[src];\r\n\t}\r\n\r\n\tstatic set(src, blob) {\r\n\t\tthis.cache[src] = blob;\r\n\t\tconst keys = Object.keys(this.cache);\r\n\t\tif (keys.length > 100) {\r\n\t\t\tthis.remove(keys[0]);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic remove(src) {\r\n\t\tdelete this.cache[src];\r\n\t}\r\n}\r\n","import { Directive, getContext } from 'rxcomp';\r\nimport { of, Subject } from 'rxjs';\r\nimport { distinctUntilChanged, first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport ImageService from '../image/image.service';\r\nimport IntersectionService from '../intersection/intersection.service';\r\nimport LazyCache from './lazy.cache';\r\n\r\nexport default class LazyDirective extends Directive {\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('lazy');\r\n\t\tthis.input$ = new Subject().pipe(\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t\tswitchMap(input => {\r\n\t\t\t\tconst src = LazyCache.get(input);\r\n\t\t\t\tif (src) {\r\n\t\t\t\t\treturn of(src);\r\n\t\t\t\t}\r\n\t\t\t\tnode.classList.remove('lazyed');\r\n\t\t\t\treturn this.lazy$(input);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t);\r\n\t\tthis.input$.subscribe(src => {\r\n\t\t\tLazyCache.set(this.lazy, src);\r\n\t\t\tnode.setAttribute('src', src);\r\n\t\t\tnode.classList.add('lazyed');\r\n\t\t});\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.input$.next(this.lazy);\r\n\t}\r\n\r\n\tlazy$(input) {\r\n\t\tconst { node } = getContext(this);\r\n\t\treturn IntersectionService.intersection$(node).pipe(\r\n\t\t\t// first(),\r\n\t\t\tswitchMap(() => ImageService.load$(input, this.size)),\r\n\t\t\tfirst(),\r\n\t\t\t// takeUntil(this.unsubscribe$),\r\n\t\t);\r\n\t}\r\n\r\n}\r\n\r\nLazyDirective.meta = {\r\n\tselector: '[lazy],[[lazy]]',\r\n\tinputs: ['lazy', 'size']\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from './modal-outlet.component';\r\nimport ModalService from './modal.service';\r\n\r\nexport default class ModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tthis.data = parentInstance.modal.data;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nModalComponent.meta = {\r\n\tselector: '[modal]'\r\n};\r\n","import { Pipe } from 'rxcomp';\r\nimport { environment } from '../environment';\r\n\r\nexport default class SlugPipe extends Pipe {\r\n\r\n\tstatic transform(key) {\r\n\t\tconst url = environment.url;\r\n\t\treturn url[key] || `#${key}`;\r\n\t}\r\n\r\n}\r\n\r\nSlugPipe.meta = {\r\n\tname: 'slug',\r\n};\r\n","import { getContext, Structure } from 'rxcomp';\r\n\r\nexport default class SvgIconStructure extends Structure {\r\n\tonInit() {\r\n\t\tthis.update();\r\n\t}\r\n\tonChanges() {\r\n\t\tthis.update();\r\n\t}\r\n\tupdate() {\r\n\t\tif (this.name_ !== this.name) {\r\n\t\t\tthis.name_ = this.name;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tif (node.parentNode) {\r\n\t\t\t\tconst xmlns = 'http://www.w3.org/2000/svg';\r\n\t\t\t\tconst element = document.createElementNS(xmlns, `svg`);\r\n\t\t\t\tconst w = this.width || 24;\r\n\t\t\t\tconst h = this.height || 24;\r\n\t\t\t\telement.setAttribute('class', `icon--${this.name}`);\r\n\t\t\t\t// element.setAttributeNS(null, 'width', w);\r\n\t\t\t\t// element.setAttributeNS(null, 'height', h);\r\n\t\t\t\telement.setAttributeNS(null, 'viewBox', `0 0 ${w} ${h}`);\r\n\t\t\t\telement.innerHTML = `<use xlink:href=\"#${this.name}\"></use>`;\r\n\t\t\t\telement.rxcompId = node.rxcompId;\r\n\t\t\t\telement.classList.add(...node.classList);\r\n\t\t\t\tnode.parentNode.replaceChild(element, node);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nSvgIconStructure.meta = {\r\n\tselector: 'svg-icon',\r\n\tinputs: ['name', 'width', 'height']\r\n};\r\n\r\n/*\r\n<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#copy\"></use></svg>\r\n*/\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { first } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\nimport ViewService from '../view/view.service';\r\n\r\nexport default class TryInARComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.missingAr = false;\r\n\t\tthis.missingUsdz = false;\r\n\t\tthis.missingGltf = false;\r\n\t\tconst viewId = this.viewId = this.getViewId();\r\n\t\t// console.log('TryInARComponent.viewId', viewId);\r\n\t\tif (viewId) {\r\n\t\t\tViewService.viewById$(viewId).pipe(\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe(view => {\r\n\t\t\t\tif (!view.ar) {\r\n\t\t\t\t\tthis.missingAr = true;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('TryInARComponent.view', view);\r\n\t\t\t\tif (this.platform === DevicePlatform.IOS) {\r\n\t\t\t\t\tconst usdzSrc = this.getUsdzSrc(view);\r\n\t\t\t\t\tif (usdzSrc) {\r\n\t\t\t\t\t\twindow.location.href = usdzSrc;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.missingUsdz = true;\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (this.getGltfSrc(view) !== null) {\r\n\t\t\t\t\tconst modelViewerNode = this.getModelViewerNode(view);\r\n\t\t\t\t\tconst { node } = getContext(this);\r\n\t\t\t\t\tnode.appendChild(modelViewerNode);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.missingGltf = true;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tgetUsdzSrc(view) {\r\n\t\treturn (view.ar && view.ar.usdz) ? environment.getPath(view.ar.usdz.folder + view.ar.usdz.file) : null;\r\n\t}\r\n\r\n\tgetGltfSrc(view) {\r\n\t\treturn (view.ar && view.ar.gltf) ? environment.getPath(view.ar.gltf.folder + view.ar.gltf.file) : null;\r\n\t}\r\n\r\n\tgetViewId() {\r\n\t\tlet viewId = LocationService.get('viewId') || null;\r\n\t\tif (viewId) {\r\n\t\t\tviewId = parseInt(viewId);\r\n\t\t}\r\n\t\treturn viewId;\r\n\t}\r\n\r\n\tgetModelViewerNode(view) {\r\n\t\tconst panorama = environment.getPath(view.asset.folder + view.asset.file);\r\n\t\tconst usdzSrc = this.getUsdzSrc(view);\r\n\t\tconst gltfSrc = this.getGltfSrc(view);\r\n\t\tconst template = /* html */`\r\n\t\t\t<model-viewer alt=\"${view.name}\" skybox-image=\"${panorama}\" ios-src=\"${usdzSrc}\" src=\"${gltfSrc}\" ar ar-modes=\"webxr scene-viewer quick-look\" ar-scale=\"auto\" camera-controls></model-viewer>\r\n\t\t`;\r\n\t\tconst div = document.createElement(\"div\");\r\n\t\tdiv.innerHTML = template;\r\n\t\tconst node = div.firstElementChild;\r\n\t\treturn node;\r\n\t}\r\n\r\n}\r\n\r\nTryInARComponent.meta = {\r\n\tselector: '[try-in-ar]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { fromEvent, of } from 'rxjs';\r\nimport { switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetType } from '../asset/asset';\r\n\r\nexport default class UploadItemComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\t// console.log('UploadItemComponent.onInit', this.item);\r\n\t\tif (this.item.preview === null) {\r\n\t\t\tthis.read$(this.item.file).pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t).subscribe(preview => {\r\n\t\t\t\tthis.item.preview = preview;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tread$(file) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\tif (this.item.type.name === AssetType.Image.name) {\r\n\t\t\t\t\treturn this.resize$(blob);\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn of(blob);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tresize$(blob) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tresolve(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.onerror = function(error) {\r\n\t\t\t\treject(error);\r\n\t\t\t};\r\n\t\t\timg.src = blob;\r\n\t\t});\r\n\t}\r\n\r\n\tonPause() {\r\n\t\tthis.pause.next(this.item);\r\n\t}\r\n\r\n\tonResume() {\r\n\t\tthis.resume.next(this.item);\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\tthis.cancel.next(this.item);\r\n\t}\r\n\r\n\tonRemove() {\r\n\t\tthis.remove.next(this.item);\r\n\t}\r\n}\r\n\r\nUploadItemComponent.meta = {\r\n\tselector: '[upload-item]',\r\n\toutputs: ['pause', 'resume', 'cancel', 'remove'],\r\n\tinputs: ['item'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"upload-item\" [class]=\"{ 'error': item.error, 'success': item.success }\">\r\n\t\t<div class=\"picture\">\r\n\t\t\t<img [lazy]=\"item.preview\" [size]=\"{ width: 320, height: 240 }\" *if=\"item.preview && item.type.name === 'image'\" />\r\n\t\t\t<video [src]=\"item.preview\" *if=\"item.preview && item.type.name === 'video'\"></video>\r\n\t\t\t<svg class=\"spinner\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" [class]=\"{ uploading: item.uploading }\" *if=\"item.uploading\"><use xlink:href=\"#spinner\"></use></svg>\r\n\t\t</div>\r\n\t\t<div class=\"name\">{{item.name}}</div>\r\n\t\t<!--\r\n\t\t<div class=\"group--info\">\r\n\t\t\t<div>progress: {{item.progress}}</div>\r\n\t\t\t<div>size: {{item.size}} bytes</div>\r\n\t\t\t<div>current speed: {{item.currentSpeed}} bytes/s</div>\r\n\t\t\t<div>average speed: {{item.averageSpeed}} bytes/s</div>\r\n\t\t\t<div>time ramining: {{item.timeRemaining}}s</div>\r\n\t\t\t<div>paused: {{item.paused}}</div>\r\n\t\t\t<div>success: {{item.success}}</div>\r\n\t\t\t<div>complete: {{item.complete}}</div>\r\n\t\t\t<div>error: {{item.error}}</div>\r\n\t\t</div>\r\n\t\t-->\r\n\t\t<!--\r\n\t\t<div class=\"group--cta\" *if=\"!item.complete && item.uploading\">\r\n\t\t\t<div class=\"btn--pause\" (click)=\"onPause()\">pause</div>\r\n\t\t\t<div class=\"btn--resume\" (click)=\"onResume()\">resume</div>\r\n\t\t\t<div class=\"btn--cancel\" (click)=\"onCancel()\">cancel</div>\r\n\t\t</div>\r\n\t\t-->\r\n\t\t<div class=\"group--cta\">\r\n\t\t\t<div class=\"btn--remove\" (click)=\"onRemove()\" *if=\"!item.complete\">remove</div>\r\n\t\t</div>\r\n\t</div>\r\n\t`,\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class HlsDirective extends Directive {\r\n\r\n\tset hls(hls) {\r\n\t\tif (this.hls_ !== hls) {\r\n\t\t\tthis.hls_ = hls;\r\n\t\t\tthis.play(hls);\r\n\t\t}\r\n\t}\r\n\r\n\tget hls() {\r\n\t\treturn this.hls_;\r\n\t}\r\n\r\n\tplay(src) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (Hls.isSupported()) {\r\n\t\t\tvar hls = new Hls();\r\n\t\t\t// bind them together\r\n\t\t\thls.attachMedia(node);\r\n\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\thls.loadSource(src);\r\n\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\tnode.play();\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nHlsDirective.meta = {\r\n\tselector: '[[hls]]',\r\n\tinputs: ['hls'],\r\n};\r\n","import { Context } from 'rxcomp';\r\n\r\nexport default class VirtualItem extends Context {\r\n\tconstructor(key, $key, value, $value, index, count, parentInstance) {\r\n\t\tsuper(parentInstance);\r\n\t\tthis[key] = $key;\r\n\t\tthis[value] = $value;\r\n\t\tthis.index = index;\r\n\t\tthis.count = count;\r\n\t}\r\n\r\n\tget first() {\r\n\t\treturn this.index === 0;\r\n\t}\r\n\r\n\tget last() {\r\n\t\treturn this.index === this.count - 1;\r\n\t}\r\n\r\n\tget even() {\r\n\t\treturn this.index % 2 === 0;\r\n\t}\r\n\r\n\tget odd() {\r\n\t\treturn !this.even;\r\n\t}\r\n}\r\n","import { getContext, Structure } from 'rxcomp';\r\nimport { BehaviorSubject, fromEvent, merge } from 'rxjs';\r\nimport { auditTime, distinctUntilChanged, map, startWith, takeUntil, tap } from 'rxjs/operators';\r\nimport VirtualItem from './virtual.item';\r\n\r\nexport const VirtualMode = {\r\n\tResponsive: 1,\r\n\tGrid: 2,\r\n\tCentered: 3,\r\n\tList: 4\r\n};\r\n\r\nexport default class VirtualStructure extends Structure {\r\n\r\n\tonInit() {\r\n\t\tconst { module, node } = getContext(this);\r\n\t\tconst template = node.firstElementChild;\r\n\t\tconst expression = node.getAttribute('*virtual');\r\n\t\tnode.removeAttribute('*virtual');\r\n\t\tnode.removeChild(template);\r\n\t\tconst tokens = (this.tokens = this.getExpressionTokens(expression));\r\n\t\tthis.virtualFunction = module.makeFunction(tokens.iterable);\r\n\t\tthis.container = node;\r\n\t\tthis.template = template;\r\n\t\tthis.mode = this.mode || 1;\r\n\t\tthis.width = this.width || 250;\r\n\t\tthis.gutter = (this.gutter !== undefined) ? this.gutter : 20;\r\n\t\tthis.reverse = this.reverse === true ? true : false;\r\n\t\tthis.options = {\r\n\t\t\twidth: this.width,\r\n\t\t\tgutter: this.gutter,\r\n\t\t\treverse: this.reverse,\r\n\t\t\tcontainerWidth: 0,\r\n\t\t\tcontainerHeight: 0,\r\n\t\t\ttop: 0,\r\n\t\t\tcols: [0],\r\n\t\t};\r\n\t\tthis.cachedRects = {};\r\n\t\tthis.cachedInstances = [];\r\n\t\tthis.cacheNodes = [];\r\n\t\tthis.items$ = new BehaviorSubject([]);\r\n\t\tthis.update$()\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe(visibleItems => {\r\n\t\t\t\t// console.log(visibleItems.length);\r\n\t\t\t});\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\tconst context = getContext(this);\r\n\t\tconst module = context.module;\r\n\t\t// resolve\r\n\t\tconst items = module.resolve(this.virtualFunction, context.parentInstance, this) || [];\r\n\t\tthis.mode = this.mode || 1;\r\n\t\tthis.width = this.width || 250;\r\n\t\tthis.gutter = (this.gutter !== undefined) ? this.gutter : 20;\r\n\t\tthis.options.width = this.width;\r\n\t\tthis.updateView(true);\r\n\t\tthis.items$.next(items);\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t}\r\n\r\n\tupdate$() {\r\n\t\treturn merge(this.scroll$(), this.resize$(), this.items$.pipe(\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t)).pipe(\r\n\t\t\tmap(_ => {\r\n\t\t\t\tconst visibleItems = this.updateForward();\r\n\t\t\t\treturn visibleItems;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tupdateForward() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet highestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = [];\r\n\t\tfor (let i = 0, len = items.length; i < len; i++) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\ttop = options.cols[col];\r\n\t\t\tif (this.intersect(top + options.top, top + height + options.top, options.top, options.top + options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.bottom = bottom;\r\n\t\t\t\t}\r\n\t\t\t\tvisibleItems.push(item);\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t}\r\n\t\t}\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tconst parentContainer = this.container.parentNode;\r\n\t\tif (this.reverse && (highestHeight < parentContainer.offsetHeight - 1)) {\r\n\t\t\tconst diff = parentContainer.offsetHeight - 1 - highestHeight;\r\n\t\t\titems.forEach((item, i) => {\r\n\t\t\t\tif (visibleItems.indexOf(item) !== -1) {\r\n\t\t\t\t\tconst rect = this.cachedRects[i];\r\n\t\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\t\tnode.style.top = (rect.top + diff) + 'px';\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.container.style.height = `${parentContainer.offsetHeight - 1}px`;\r\n\t\t} else {\r\n\t\t\tthis.container.style.height = `${highestHeight}px`;\r\n\t\t}\r\n\t\treturn visibleItems;\r\n\t}\r\n\r\n\t/*\r\n\tupdateForward__() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet highestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = items.filter((item, i) => {\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\ttop = options.cols[col];\r\n\t\t\tif (this.intersect(top + options.top, top + height + options.top, options.top, options.top + options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.bottom = bottom;\r\n\t\t\t\t}\r\n\t\t\t\treturn true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t});\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tthis.container.style.height = `${highestHeight}px`;\r\n\t\treturn visibleItems;\r\n\t}\r\n\r\n\tupdateBackward__() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet lowestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = [];\r\n\t\tfor (let i = items.length - 1; i >= 0; i--) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\tbottom = options.cols[col];\r\n\t\t\tif (this.intersect(bottom - height + options.top, bottom + options.top, options.top, options.top + options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\ttop = bottom - height - options.gutter;\r\n\t\t\t\tlowestHeight = Math.min(lowestHeight, -top);\r\n\t\t\t\toptions.cols[col] = top;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom: bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.top = top;\r\n\t\t\t\t}\r\n\t\t\t\tvisibleItems.push(item);\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\ttop = bottom - height - options.gutter;\r\n\t\t\t\toptions.cols[col] = top;\r\n\t\t\t\tlowestHeight = Math.min(lowestHeight, top);\r\n\t\t\t}\r\n\t\t}\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tthis.container.style.height = `${-lowestHeight}px`;\r\n\t\treturn visibleItems;\r\n\t}\r\n\t*/\r\n\r\n\tgetCols() {\r\n\t\tconst options = this.options;\r\n\t\tconst cols = Math.floor((options.containerWidth + options.gutter) / (options.width + options.gutter)) || 1;\r\n\t\treturn new Array(cols).fill(0);\r\n\t}\r\n\r\n\tgetCol() {\r\n\t\tconst options = this.options;\r\n\t\tlet col;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tcol = options.cols.reduce((p, c, i, a) => {\r\n\t\t\t\t\treturn c < a[p] ? i : p;\r\n\t\t\t\t}, 0);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tcol = 0;\r\n\t\t}\r\n\t\treturn col;\r\n\t}\r\n\r\n\tgetWidth() {\r\n\t\tconst options = this.options;\r\n\t\tlet width;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\twidth = options.width;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\twidth = (options.containerWidth - (options.cols.length - 1) * options.gutter) / options.cols.length;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\twidth = options.containerWidth;\r\n\t\t}\r\n\t\treturn width;\r\n\t}\r\n\r\n\tgetHeight(width, item) {\r\n\t\tconst options = this.options;\r\n\t\tlet height;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\theight = options.width;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\theight = 80;\r\n\t\t}\r\n\t\treturn height;\r\n\t}\r\n\r\n\tgetGutter(width) {\r\n\t\tconst options = this.options;\r\n\t\tlet gutter;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\tgutter = options.gutter;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tgutter = (options.containerWidth - options.cols.length * width) / (options.cols.length - 1);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tgutter = 0;\r\n\t\t}\r\n\t\treturn gutter;\r\n\t}\r\n\r\n\tgetLeft(index, width, gutter) {\r\n\t\tconst options = this.options;\r\n\t\tlet left;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tleft = index * (width + gutter);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\tleft = (options.containerWidth - options.cols.length * (width + gutter) + gutter) / 2 + index * (width + gutter);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tleft = 0;\r\n\t\t}\r\n\t\treturn left;\r\n\t}\r\n\r\n\tcachedNode(index, i, value, total) {\r\n\t\tif (this.cacheNodes[index]) {\r\n\t\t\treturn this.updateNode(index, i, value);\r\n\t\t} else {\r\n\t\t\treturn this.createNode(index, i, value, total);\r\n\t\t}\r\n\t}\r\n\r\n\tcreateNode(index, i, value, total) {\r\n\t\tconst clonedNode = this.template.cloneNode(true);\r\n\t\tdelete clonedNode.rxcompId;\r\n\t\tthis.container.appendChild(clonedNode);\r\n\t\tthis.cacheNodes[index] = clonedNode;\r\n\t\tconst context = getContext(this);\r\n\t\tconst module = context.module;\r\n\t\tconst tokens = this.tokens;\r\n\t\tconst args = [tokens.key, i, tokens.value, value, i, total, context.parentInstance];\r\n\t\tconst instance = module.makeInstance(clonedNode, VirtualItem, context.selector, context.parentInstance, args);\r\n\t\tconst forItemContext = getContext(instance);\r\n\t\tmodule.compile(clonedNode, forItemContext.instance);\r\n\t\tthis.cachedInstances[index] = instance;\r\n\t\treturn clonedNode;\r\n\t}\r\n\r\n\tupdateNode(index, i, value) {\r\n\t\tconst instance = this.cachedInstances[index];\r\n\t\tconst tokens = this.tokens;\r\n\t\tif (instance[tokens.key] !== i) {\r\n\t\t\tinstance[tokens.key] = i;\r\n\t\t\tinstance[tokens.value] = value;\r\n\t\t\tinstance.pushChanges();\r\n\t\t}\r\n\t\t// console.log(index, i, value);\r\n\t\treturn this.cacheNodes[index];\r\n\t}\r\n\r\n\tremoveNode(index) {\r\n\t\tthis.cachedInstances[index] = undefined;\r\n\t\tconst node = this.cacheNodes[index];\r\n\t\tif (node) {\r\n\t\t\tconst context = getContext(this);\r\n\t\t\tconst module = context.module;\r\n\t\t\tnode.parentNode.removeChild(node);\r\n\t\t\tmodule.remove(node);\r\n\t\t}\r\n\t\tthis.cacheNodes[index] = undefined;\r\n\t\treturn node;\r\n\t}\r\n\r\n\tintersect(top1, bottom1, top2, bottom2) {\r\n\t\treturn top2 < bottom1 && bottom2 > top1;\r\n\t}\r\n\r\n\tresize$() {\r\n\t\treturn fromEvent(window, 'resize').pipe(\r\n\t\t\tauditTime(100),\r\n\t\t\tstartWith(null),\r\n\t\t\ttap(() => this.updateView(true))\r\n\t\t);\r\n\t}\r\n\r\n\tscroll$() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log(node.parentNode, getComputedStyle(node.parentNode).overflowY, node.parentNode.style.overflowY);\r\n\t\tif (node.parentNode && getComputedStyle(node.parentNode).overflowY === 'auto') {\r\n\t\t\treturn fromEvent(node.parentNode, 'scroll').pipe(tap(() => {\r\n\t\t\t\tthis.updateView();\r\n\t\t\t}));\r\n\t\t} else {\r\n\t\t\treturn fromEvent(window, 'scroll').pipe(tap(() => this.updateView()));\r\n\t\t}\r\n\t}\r\n\r\n\tupdateView(reset) {\r\n\t\tconst rect = this.container.getBoundingClientRect();\r\n\t\tconst options = this.options;\r\n\t\toptions.top = rect.top;\r\n\t\toptions.containerWidth = rect.width;\r\n\t\toptions.containerHeight = rect.height; // window.innerHeight;\r\n\t\toptions.cols = this.getCols();\r\n\t\tif (reset) {\r\n\t\t\tthis.cachedRects = {};\r\n\t\t}\r\n\t}\r\n\r\n\tgetExpressionTokens(expression) {\r\n\t\tif (expression === null) {\r\n\t\t\tthrow new Error('invalid virtual');\r\n\t\t}\r\n\t\tif (expression.trim().indexOf('let ') === -1 || expression.trim().indexOf(' of ') === -1) {\r\n\t\t\tthrow new Error('invalid virtual');\r\n\t\t}\r\n\t\tconst expressions = expression\r\n\t\t\t.split(';')\r\n\t\t\t.map(x => x.trim())\r\n\t\t\t.filter(x => x !== '');\r\n\t\tconst virtualExpressions = expressions[0].split(' of ').map(x => x.trim());\r\n\t\tlet value = virtualExpressions[0].replace(/\\s*let\\s*/, '');\r\n\t\tconst iterable = virtualExpressions[1];\r\n\t\tlet key = 'index';\r\n\t\tconst keyValueMatches = value.match(/\\[(.+)\\s*,\\s*(.+)\\]/);\r\n\t\tif (keyValueMatches) {\r\n\t\t\tkey = keyValueMatches[1];\r\n\t\t\tvalue = keyValueMatches[2];\r\n\t\t}\r\n\t\tif (expressions.length > 1) {\r\n\t\t\tconst indexExpressions = expressions[1].split(/\\s*let\\s*|\\s*=\\s*index/).map(x => x.trim());\r\n\t\t\tif (indexExpressions.length === 3) {\r\n\t\t\t\tkey = indexExpressions[1];\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn { key, value, iterable };\r\n\t}\r\n}\r\n\r\nVirtualStructure.meta = {\r\n\tselector: '[*virtual]',\r\n\tinputs: ['mode', 'width', 'gutter', 'reverse']\r\n};\r\n","import { BehaviorSubject, combineLatest, of, ReplaySubject } from 'rxjs';\r\nimport { map, switchAll } from 'rxjs/operators';\r\n\r\nlet LOADER_UID = 0;\r\n\r\nexport default class LoaderService {\r\n\r\n\tstatic progress = { value: 0, loaded: 0, total: 0, count: 0, title: '' };\r\n\r\n\tstatic items = {};\r\n\r\n\t// merge(this.statusSubject, this.validatorsSubject)\r\n\tstatic progress$ = new ReplaySubject(1).pipe(\r\n\t\tswitchAll(),\r\n\t\tmap(() => {\r\n\t\t\tconst items = Object.keys(this.items).map(key => this.items[key]);\r\n\t\t\tconst progress = items.reduce((progress, subject, i, items) => {\r\n\t\t\t\tconst item = subject.getValue();\r\n\t\t\t\tconst loaded = item.loaded || 0;\r\n\t\t\t\tconst total = item.total || 1;\r\n\t\t\t\tconst value = loaded / total;\r\n\t\t\t\tprogress.value += value;\r\n\t\t\t\tprogress.loaded += loaded;\r\n\t\t\t\tprogress.total += total;\r\n\t\t\t\treturn progress;\r\n\t\t\t}, { value: 0, loaded: 0, total: 0 });\r\n\t\t\tprogress.count = items.length;\r\n\t\t\tif (items.length) {\r\n\t\t\t\tprogress.value /= progress.count;\r\n\t\t\t}\r\n\t\t\tprogress.title = `${Math.round(progress.value * 100)}%`;\r\n\t\t\tthis.progress = progress;\r\n\t\t\treturn progress;\r\n\t\t}),\r\n\t);\r\n\r\n\tstatic switchLoaders() {\r\n\t\tconst items = Object.keys(this.items).map(key => this.items[key]);\r\n\t\tconst items$ = items.length ? combineLatest(items) : of(items);\r\n\t\tthis.progress$.next(items$);\r\n\t}\r\n\r\n\tstatic getRef() {\r\n\t\tconst ref = ++LOADER_UID;\r\n\t\tthis.items[ref] = new BehaviorSubject({ loaded: 0, total: 1 });\r\n\t\tthis.switchLoaders();\r\n\t\treturn ref;\r\n\t}\r\n\r\n\tstatic setProgress(ref, loaded, total = 1) {\r\n\t\tconst item = this.items[ref];\r\n\t\tif (item) {\r\n\t\t\titem.next({ loaded, total });\r\n\t\t}\r\n\t\tif (loaded >= total) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tdelete this.items[ref];\r\n\t\t\t\tthis.switchLoaders();\r\n\t\t\t}, 300);\r\n\t\t}\r\n\t\tthis.switchLoaders();\r\n\t}\r\n\r\n}\r\n","import { fromEvent } from 'rxjs';\r\nimport { filter, first, switchMap, takeWhile, tap } from 'rxjs/operators';\r\nimport { AssetType } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport ImageService, { ImageServiceEvent } from '../../image/image.service';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport StreamService from '../../stream/stream.service';\r\n// import DebugService from '../debug.service';\r\n\r\nexport class EnvMapLoader {\r\n\r\n\tstatic get video() {\r\n\t\treturn this.video_;\r\n\t}\r\n\r\n\tstatic set video(video) {\r\n\t\tif (this.video_) {\r\n\t\t\tthis.video_.muted = true;\r\n\t\t\tthis.video_.pause();\r\n\t\t\tif (this.video_.parentNode) {\r\n\t\t\t\tthis.video_.parentNode.removeChild(this.video_);\r\n\t\t\t}\r\n\t\t\tthis.video_ = null;\r\n\t\t}\r\n\t\tif (video) {\r\n\t\t\tconst video = this.video_ = document.createElement('video');\r\n\t\t\tvideo.loop = true;\r\n\t\t\t// video.muted = true;\r\n\t\t\tvideo.playsInline = true;\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\t// document.querySelector('body').appendChild(video);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get muted() {\r\n\t\treturn this.muted_;\r\n\t}\r\n\r\n\tstatic set muted(muted) {\r\n\t\tthis.muted_ = muted;\r\n\t\t// console.log('EnvMapLoader.muted', muted, this.video);\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.muted = muted === true;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic set cubeRenderTarget(cubeRenderTarget) {\r\n\t\tif (this.cubeRenderTarget_) {\r\n\t\t\tthis.cubeRenderTarget_.texture.dispose();\r\n\t\t\tthis.cubeRenderTarget_.dispose();\r\n\t\t}\r\n\t\tthis.cubeRenderTarget_ = cubeRenderTarget;\r\n\t}\r\n\r\n\tstatic set texture(texture) {\r\n\t\tif (this.texture_) {\r\n\t\t\tthis.texture_.dispose();\r\n\t\t}\r\n\t\tthis.texture_ = texture;\r\n\t}\r\n\r\n\tstatic load(item, renderer, callback) {\r\n\t\tthis.video = null;\r\n\t\tif (!item.asset) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (item.asset.type.name === AssetType.PublisherStream.name) {\r\n\t\t\treturn this.loadPublisherStreamBackground(renderer, callback);\r\n\t\t} else if (item.asset.file.indexOf('.mp4') !== -1 || item.asset.file.indexOf('.webm') !== -1) {\r\n\t\t\treturn this.loadVideoBackground(environment.getPath(item.asset.folder), item.asset.file, renderer, callback);\r\n\t\t} else if (item.asset.file.indexOf('.m3u8') !== -1) {\r\n\t\t\treturn this.loadHlslVideoBackground(item.asset.file, renderer, callback);\r\n\t\t} else if (item.asset.file.indexOf('.hdr') !== -1) {\r\n\t\t\treturn this.loadRgbeBackground(environment.getPath(item.asset.folder), item.asset.file, renderer, callback);\r\n\t\t} else {\r\n\t\t\treturn this.loadBackgroundImageService(environment.getPath(item.asset.folder), item.asset.file, renderer, callback);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic loadBackground(folder, file, renderer, callback) {\r\n\t\tconst pmremGenerator = new THREE.PMREMGenerator(renderer);\r\n\t\tpmremGenerator.compileEquirectangularShader();\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\t// console.log('loadBackground.progressRef');\r\n\t\tconst loader = new THREE.TextureLoader();\r\n\t\tloader.setPath(folder).load(file, (texture) => {\r\n\t\t\tconst envMap = pmremGenerator.fromEquirectangular(texture).texture;\r\n\t\t\tpmremGenerator.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t}, (request) => {\r\n\t\t\tconsole.log(request.loaded, request.total);\r\n\t\t\tLoaderService.setProgress(progressRef, request.loaded, request.total);\r\n\t\t});\r\n\t\treturn loader;\r\n\t}\r\n\r\n\tstatic loadBackgroundImageService(folder, file, renderer, callback) {\r\n\t\tconst pmremGenerator = new THREE.PMREMGenerator(renderer);\r\n\t\tpmremGenerator.compileEquirectangularShader();\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst image = new Image();\r\n\t\tImageService.events$(folder + file).pipe(\r\n\t\t\ttap(event => {\r\n\t\t\t\tif (event.type === ImageServiceEvent.Progress) {\r\n\t\t\t\t\tLoaderService.setProgress(progressRef, event.data.loaded, event.data.total);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event.type === ImageServiceEvent.Complete),\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst load = fromEvent(image, 'load');\r\n\t\t\t\timage.crossOrigin = 'anonymous';\r\n\t\t\t\timage.src = event.data;\r\n\t\t\t\treturn load;\r\n\t\t\t}),\r\n\t\t\ttakeWhile(event => event.type !== ImageServiceEvent.Complete, true),\r\n\t\t).subscribe(event => {\r\n\t\t\tURL.revokeObjectURL(event.data);\r\n\t\t\tconst texture = new THREE.Texture(image);\r\n\t\t\tconst envMap = pmremGenerator.fromEquirectangular(texture).texture;\r\n\t\t\tpmremGenerator.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t});\r\n\t}\r\n\r\n\tstatic loadRgbeBackground(folder, file, renderer, callback) {\r\n\t\tconst pmremGenerator = new THREE.PMREMGenerator(renderer);\r\n\t\tpmremGenerator.compileEquirectangularShader();\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst loader = new THREE.RGBELoader();\r\n\t\tloader\r\n\t\t\t.setDataType(THREE.UnsignedByteType)\r\n\t\t\t// .setDataType(THREE.FloatType)\r\n\t\t\t.setPath(folder)\r\n\t\t\t.load(file, (texture) => {\r\n\t\t\t\tconst envMap = pmremGenerator.fromEquirectangular(texture).texture;\r\n\t\t\t\t// texture.dispose();\r\n\t\t\t\tpmremGenerator.dispose();\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(envMap, texture, true);\r\n\t\t\t\t}\r\n\t\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t\t}, (request) => {\r\n\t\t\t\tLoaderService.setProgress(progressRef, request.loaded, request.total);\r\n\t\t\t});\r\n\t\treturn loader;\r\n\t}\r\n\r\n\tstatic loadHlslVideoBackground(src, renderer, callback) {\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst video = document.createElement('video');\r\n\t\tconst onPlaying = () => {\r\n\t\t\tvideo.oncanplay = null;\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\t// const envMap = new THREE.VideoTexture(video);\r\n\t\t\tconst cubeRenderTarget = new THREE.WebGLCubeRenderTarget(1024, {\r\n\t\t\t\tgenerateMipmaps: true,\r\n\t\t\t\t// minFilter: THREE.LinearMipmapLinearFilter,\r\n\t\t\t\tminFilter: THREE.LinearFilter,\r\n\t\t\t\tmagFilter: THREE.LinearFilter,\r\n\t\t\t\tmapping: THREE.UVMapping,\r\n\t\t\t\tformat: THREE.RGBFormat\r\n\t\t\t}).fromEquirectangularTexture(renderer, texture);\r\n\t\t\t// texture.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(cubeRenderTarget.texture, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t};\r\n\t\tvideo.oncanplay = () => {\r\n\t\t\t// console.log('videoReady', videoReady);\r\n\t\t\tonPlaying();\r\n\t\t};\r\n\t\tif (Hls.isSupported()) {\r\n\t\t\tvar hls = new Hls();\r\n\t\t\t// bind them together\r\n\t\t\thls.attachMedia(video);\r\n\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\thls.loadSource(src);\r\n\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\tvideo.play();\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tstatic loadVideoBackground(folder, file, renderer, callback) {\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\t// const debugService = DebugService.getService();\r\n\t\tthis.video = true;\r\n\t\tconst video = this.video;\r\n\t\tconst onPlaying = () => {\r\n\t\t\tvideo.oncanplay = null;\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\t// const envMap = new THREE.VideoTexture(video);\r\n\t\t\tconst cubeRenderTarget = this.cubeRenderTarget = new THREE.WebGLCubeRenderTarget(1024, {\r\n\t\t\t\tgenerateMipmaps: true,\r\n\t\t\t\t// minFilter: THREE.LinearMipmapLinearFilter,\r\n\t\t\t\tminFilter: THREE.LinearFilter,\r\n\t\t\t\tmagFilter: THREE.LinearFilter,\r\n\t\t\t\tmapping: THREE.UVMapping,\r\n\t\t\t\tformat: THREE.RGBFormat\r\n\t\t\t}).fromEquirectangularTexture(renderer, texture);\r\n\t\t\t// texture.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(cubeRenderTarget.texture, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t};\r\n\t\t// video.addEventListener('playing', onPlaying);\r\n\t\tvideo.oncanplay = () => {\r\n\t\t\t// console.log('EnvMapLoader.loadVideoBackground.oncanplay');\r\n\t\t\tonPlaying();\r\n\t\t};\r\n\t\tvideo.src = folder + file;\r\n\t\tvideo.load();\r\n\t\tvideo.play().then(() => {\r\n\t\t\t// console.log('EnvMapLoader.loadVideoBackground.play');\r\n\t\t\t// debugService.setMessage(`play ${video.src}`);\r\n\t\t}, error => {\r\n\t\t\tconsole.log('EnvMapLoader.loadVideoBackground.play.error', error);\r\n\t\t\t// debugService.setMessage(`play.error ${video.src}`);\r\n\t\t});\r\n\t}\r\n\r\n\tstatic loadPublisherStreamBackground(renderer, callback) {\r\n\t\tconst onPublisherStreamId = (publisherStreamId) => {\r\n\t\t\t// const target = StateService.state.role === RoleType.Publisher ? '.video--local' : '.video--remote';\r\n\t\t\tconst target = `#stream-${publisherStreamId}`;\r\n\t\t\tconst video = document.querySelector(`${target} video`);\r\n\t\t\tif (!video) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst onPlaying = () => {\r\n\t\t\t\tconst texture = this.texture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tconst cubeRenderTarget = this.cubeRenderTarget = new THREE.WebGLCubeRenderTarget(1024, {\r\n\t\t\t\t\tgenerateMipmaps: true,\r\n\t\t\t\t\t// minFilter: THREE.LinearMipmapLinearFilter,\r\n\t\t\t\t\tminFilter: THREE.LinearFilter,\r\n\t\t\t\t\tmagFilter: THREE.LinearFilter,\r\n\t\t\t\t\tmapping: THREE.UVMapping,\r\n\t\t\t\t\tformat: THREE.RGBFormat\r\n\t\t\t\t}).fromEquirectangularTexture(renderer, texture);\r\n\t\t\t\t// texture.dispose();\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(cubeRenderTarget.texture, texture, false);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\t\tonPlaying();\r\n\t\t\t} else {\r\n\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\tonPlaying();\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t};\r\n\t\tStreamService.getPublisherStreamId$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(publisherStreamId => onPublisherStreamId(publisherStreamId));\r\n\t}\r\n\r\n}\r\n","\r\nexport default class FreezableMesh extends THREE.Mesh {\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\r\n\tset freezed(freezed) {\r\n\t\t// !!! cycle through freezable and not freezable\r\n\t\tthis.freezed_ = freezed;\r\n\t\tthis.children.filter(x => x.__lookupGetter__('freezed')).forEach(x => x.freezed = freezed);\r\n\t}\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tgeometry = geometry || new THREE.BoxBufferGeometry(5, 5, 5);\r\n\t\tmaterial = material || new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(geometry, material);\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n\tfreeze() {\r\n\t\tthis.freezed = true;\r\n\t}\r\n\r\n\tunfreeze() {\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n}\r\n","import FreezableMesh from \"./freezable.mesh\";\r\n\r\nexport default class EmittableMesh extends FreezableMesh {\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tgeometry = geometry || new THREE.BoxBufferGeometry(5, 5, 5);\r\n\t\tmaterial = material || new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(geometry, material);\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","// import DebugService from '../debug.service';\r\n\r\nconst defaultEvent = {};\r\n\r\nexport default class Interactive { }\r\n\r\nInteractive.items = [];\r\nInteractive.hittest = interactiveHittest.bind(Interactive);\r\nInteractive.dispose = interactiveDispose.bind(Interactive);\r\n\r\nexport function interactiveHittest(raycaster, down = false, event = defaultEvent) {\r\n\t// const debugService = DebugService.getService();\r\n\tlet dirty = false;\r\n\tif (this.down !== down) {\r\n\t\tthis.down = down;\r\n\t\tthis.lock = false;\r\n\t\tdirty = true;\r\n\t}\r\n\tconst items = this.items.filter(x => !x.freezed);\r\n\tconst intersections = raycaster.intersectObjects(items);\r\n\tlet key, hit;\r\n\tconst hash = {};\r\n\tintersections.forEach((intersection, i) => {\r\n\t\tconst object = intersection.object;\r\n\t\tkey = object.uuid;\r\n\t\tif (i === 0) {\r\n\t\t\tif (this.lastIntersectedObject !== object || dirty) {\r\n\t\t\t\tthis.lastIntersectedObject = object;\r\n\t\t\t\thit = object;\r\n\t\t\t\t// debugService.setMessage(hit.name || hit.id);\r\n\t\t\t\t// haptic feedback\r\n\t\t\t} else if (\r\n\t\t\t\tobject.intersection && (\r\n\t\t\t\t\tMath.abs(object.intersection.point.x - intersection.point.x) > 0.01 ||\r\n\t\t\t\t\tMath.abs(object.intersection.point.y - intersection.point.y) > 0.01\r\n\t\t\t\t)\r\n\t\t\t) {\r\n\t\t\t\tobject.intersection = intersection;\r\n\t\t\t\tobject.emit('move', object);\r\n\t\t\t}\r\n\t\t}\r\n\t\thash[key] = intersection;\r\n\t});\r\n\tif (intersections.length === 0) {\r\n\t\tthis.lastIntersectedObject = null;\r\n\t}\r\n\titems.forEach(x => {\r\n\t\tx.intersection = hash[x.uuid];\r\n\t\tx.over = (x === this.lastIntersectedObject) || (x.intersection && !x.depthTest && (!this.lastIntersectedObject || this.lastIntersectedObject.depthTest));\r\n\t\tx.down = down && x.over && !this.lock;\r\n\t\tif (x.down) {\r\n\t\t\tthis.lock = true;\r\n\t\t}\r\n\t});\r\n\treturn hit;\r\n}\r\n\r\nexport function interactiveDispose(object) {\r\n\tif (object) {\r\n\t\tconst index = this.items.indexOf(object);\r\n\t\tif (index !== -1) {\r\n\t\t\tthis.items.splice(index, 1);\r\n\t\t}\r\n\t}\r\n}\r\n","import EmittableMesh from './emittable.mesh';\r\nimport Interactive from './interactive';\r\n\r\nexport default class InteractiveMesh extends EmittableMesh {\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tsuper(geometry, material);\r\n\t\tthis.depthTest = true;\r\n\t\tthis.over_ = false;\r\n\t\tthis.down_ = false;\r\n\t\tInteractive.items.push(this);\r\n\t}\r\n\r\n\tget isInteractiveMesh() {\r\n\t\treturn true;\r\n\t}\r\n\r\n\tget over() {\r\n\t\treturn this.over_;\r\n\t}\r\n\tset over(over) {\r\n\t\tif (this.over_ != over) {\r\n\t\t\tthis.over_ = over;\r\n\t\t\t/*\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('hit', this);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('over', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('out', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget down() {\r\n\t\treturn this.down_;\r\n\t}\r\n\tset down(down) {\r\n\t\tdown = down && this.over;\r\n\t\tif (this.down_ != down) {\r\n\t\t\tthis.down_ = down;\r\n\t\t\tif (down) {\r\n\t\t\t\tthis.emit('down', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('up', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","import { Texture } from 'three';\r\n\r\nfunction VideoTexture(video, mapping, wrapS, wrapT, magFilter, minFilter, format, type, anisotropy) {\r\n\tTexture.call(this, video, mapping, wrapS, wrapT, magFilter, minFilter, format, type, anisotropy);\r\n\tthis.format = format !== undefined ? format : THREE.RGBFormat;\r\n\tthis.minFilter = minFilter !== undefined ? minFilter : THREE.LinearFilter;\r\n\tthis.magFilter = magFilter !== undefined ? magFilter : THREE.LinearFilter;\r\n\tthis.mapping = THREE.UVMapping;\r\n\tthis.generateMipmaps = false;\r\n}\r\n\r\nVideoTexture.prototype = Object.assign(Object.create(Texture.prototype), {\r\n\r\n\tconstructor: VideoTexture,\r\n\r\n\tisVideoTexture: true,\r\n\r\n\tupdate: function() {\r\n\t\tvar video = this.image;\r\n\t\tif (video.readyState >= video.HAVE_CURRENT_DATA) {\r\n\t\t\tthis.needsUpdate = true;\r\n\t\t}\r\n\t}\r\n\r\n});\r\n\r\nexport { VideoTexture };\r\n","import StateService from '../../state/state.service';\r\nimport { PanoramaGridView } from '../../view/view';\r\nimport { EnvMapLoader } from '../envmap/envmap.loader';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport { VideoTexture } from '../video-texture';\r\n\r\nexport const PANORAMA_RADIUS = 101;\r\n\r\nconst VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\t// gl_PointSize = 8.0;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\n\r\nconst FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform vec2 resolution;\r\nuniform float tween;\r\nuniform bool rgbe;\r\nuniform sampler2D texture;\r\n\r\nvec3 ACESFilmicToneMapping_( vec3 color ) {\r\n\tcolor *= 1.8;\r\n\treturn saturate( ( color * ( 2.51 * color + 0.03 ) ) / ( color * ( 2.43 * color + 0.59 ) + 0.14 ) );\r\n}\r\n\r\nvec4 getColor(vec2 p) {\r\n\treturn texture2D(texture, p);\r\n}\r\n\r\nvec3 encodeColor(vec4 color) {\r\n\treturn ACESFilmicToneMapping_(RGBEToLinear(color).rgb);\r\n}\r\n\r\nfloat rand(vec2 co){\r\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\r\n}\r\n\r\nvec4 Blur(vec2 st, vec4 color) {\r\n\tconst float directions = 16.0;\r\n\tconst float quality = 3.0;\r\n\tfloat size = 16.0;\r\n\tconst float PI2 = 6.28318530718;\r\n\tconst float qq = 1.0;\r\n\tconst float q = 1.0 / quality;\r\n\tvec2 radius = size / resolution.xy;\r\n\tfor (float d = 0.0; d < PI2; d += PI2 / directions) {\r\n\t\tfor (float i = q; i <= qq; i += q) {\r\n\t\t\tvec2 dUv = vec2(cos(d), sin(d)) * radius * i;\r\n\t\t\tcolor += getColor(st + dUv);\r\n        }\r\n\t}\r\n\treturn color /= quality * directions - 15.0 + rand(st) * 4.0;\r\n}\r\n\r\nvoid main() {\r\n\tvec4 color = texture2D(texture, vUv);\r\n\t// color = Blur(vUv, color);\r\n\tif (rgbe) {\r\n\t\tcolor = vec4(encodeColor(color) * tween + rand(vUv) * 0.01, 1.0);\r\n\t} else {\r\n\t\tcolor = vec4(color.rgb * tween + rand(vUv) * 0.01, 1.0);\r\n\t}\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nexport default class Panorama {\r\n\r\n\tconstructor() {\r\n\t\tthis.muted_ = false;\r\n\t\tthis.subscription = StateService.state$.subscribe(state => EnvMapLoader.muted = state.volumeMuted);\r\n\t\tthis.tween = 0;\r\n\t\tthis.create();\r\n\t}\r\n\r\n\tcreate() {\r\n\t\tconst geometry = new THREE.SphereBufferGeometry(PANORAMA_RADIUS, 60, 40);\r\n\t\tgeometry.scale(-1, 1, 1);\r\n\t\tgeometry.rotateY(Math.PI);\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\tfragmentShader: FRAGMENT_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\ttexture: { type: \"t\", value: null },\r\n\t\t\t\tresolution: { value: new THREE.Vector2() },\r\n\t\t\t\ttween: { value: 0 },\r\n\t\t\t\trgbe: { value: false },\r\n\t\t\t},\r\n\t\t});\r\n\t\t/*\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0,\r\n\t\t});\r\n\t\t*/\r\n\t\tconst mesh = this.mesh = new InteractiveMesh(geometry, material);\r\n\t\t// mesh.renderOrder = environment.renderOrder.panorama;\r\n\t\tmesh.name = '[panorama]';\r\n\t}\r\n\r\n\t/*\r\n\tswap(view, renderer, callback, onexit) {\r\n\t\tconst item = view instanceof PanoramaGridView ? view.tiles[view.index_] : view;\r\n\t\tconst material = this.mesh.material;\r\n\t\tif (this.tween > 0) {\r\n\t\t\tgsap.to(this, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\ttween: 0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\tif (typeof onexit === 'function') {\r\n\t\t\t\t\t\tonexit(view);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t\t\tgsap.to(this, {\r\n\t\t\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\t\t\ttween: 1,\r\n\t\t\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tif (typeof onexit === 'function') {\r\n\t\t\t\tonexit(view);\r\n\t\t\t}\r\n\t\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\tgsap.to(this, {\r\n\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\ttween: 1,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\tchange(view, renderer, callback, onexit) {\r\n\t\tconst item = view instanceof PanoramaGridView ? view.tiles[view.index_] : view;\r\n\t\tconst material = this.mesh.material;\r\n\t\t// setTimeout(() => {\r\n\t\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t// setTimeout(() => {\r\n\t\t\t\t\tif (typeof onexit === 'function') {\r\n\t\t\t\t\t\tonexit(view);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tmaterial.uniforms.tween.value = 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\tsetTimeout(function () {\r\n\t\t\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, 100); // !!! delay\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tgsap.to(this, {\r\n\t\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\t\ttween: 1,\r\n\t\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tonComplete: () => {\r\n\t\t\t\t\t\t\tsetTimeout(function () {\r\n\t\t\t\t\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}, 100); // !!! delay\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t});\r\n\t\t\t\t\t*/\r\n\t\t\t\t// }, 100); // !!! delay\r\n\t\t\t});\r\n\t\t// }, 300); // !!! delay\r\n\t}\r\n\r\n\tcrossfade(item, renderer, callback) {\r\n\t\tconst material = this.mesh.material;\r\n\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\tmaterial.uniforms.tween.value = 1;\r\n\t\t\tmaterial.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tload(item, renderer, callback) {\r\n\t\tif (!item.asset) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.currentAsset = item.asset.folder + item.asset.file;\r\n\t\tconst material = this.mesh.material;\r\n\t\tEnvMapLoader.load(item, renderer, (envMap, texture, rgbe, video, pmremGenerator) => {\r\n\t\t\tif (item.asset.folder + item.asset.file !== this.currentAsset) {\r\n\t\t\t\ttexture.dispose();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (material.uniforms.texture.value) {\r\n\t\t\t\tmaterial.uniforms.texture.value.dispose();\r\n\t\t\t\tmaterial.uniforms.texture.value = null;\r\n\t\t\t}\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\t// material.map = texture;\r\n\t\t\tmaterial.uniforms.texture.value = texture;\r\n\t\t\tmaterial.uniforms.resolution.value = new THREE.Vector2(texture.width, texture.height);\r\n\t\t\tmaterial.uniforms.tween.value = 0;\r\n\t\t\tmaterial.uniforms.rgbe.value = rgbe;\r\n\t\t\tmaterial.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tloadVideo(src) {\r\n\t\tconst video = document.createElement('video');\r\n\t\tvideo.src = src;\r\n\t\tvideo.volume = 0.8;\r\n\t\tvideo.muted = true;\r\n\t\tvideo.playsInline = true;\r\n\t\tvideo.crossOrigin = 'anonymous';\r\n\t\tvideo.play();\r\n\t\tthis.setVideo(video);\r\n\t}\r\n\r\n\tsetVideo(video) {\r\n\t\t// console.log('Panorama.setVideo', video);\r\n\t\tif (video) {\r\n\t\t\tconst onPlaying = () => {\r\n\t\t\t\tconst texture = new VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tconst material = this.mesh.material;\r\n\t\t\t\tmaterial.map = texture;\r\n\t\t\t\tmaterial.uniforms.texture.value = texture;\r\n\t\t\t\tmaterial.uniforms.resolution.value = new THREE.Vector2(texture.width, texture.height);\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t};\r\n\t\t\t// video.addEventListener('canplay', onPlaying);\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\tonPlaying();\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.subscription.unsubscribe();\r\n\t}\r\n\r\n}\r\n","export class Rect {\r\n\r\n\tconstructor(rect) {\r\n\t\tthis.x = 0;\r\n\t\tthis.y = 0;\r\n\t\tthis.top = 0;\r\n\t\tthis.right = 0;\r\n\t\tthis.bottom = 0;\r\n\t\tthis.left = 0;\r\n\t\tthis.width = 0;\r\n\t\tthis.height = 0;\r\n\t\tthis.set(rect);\r\n\t}\r\n\r\n\tstatic contains(rect, left, top) {\r\n\t\treturn rect.top <= top && top <= rect.bottom && rect.left <= left && left <= rect.right;\r\n\t}\r\n\r\n\tstatic intersectRect(r1, r2) {\r\n\t\treturn !(r2.left > r1.right ||\r\n\t\t\tr2.right < r1.left ||\r\n\t\t\tr2.top > r1.bottom ||\r\n\t\t\tr2.bottom < r1.top);\r\n\t}\r\n\r\n\tstatic fromNode(node) {\r\n\t\tif (!node) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst rect = node.rect_ || (node.rect_ = new Rect());\r\n\t\tconst rects = node.getClientRects();\r\n\t\tif (!rects.length) {\r\n\t\t\t// console.log(rects, node);\r\n\t\t\treturn rect;\r\n\t\t}\r\n\t\tconst boundingRect = node.getBoundingClientRect();\r\n\t\t// rect.top: boundingRect.top + defaultView.pageYOffset,\r\n\t\t// rect.left: boundingRect.left + defaultView.pageXOffset,\r\n\t\trect.x = boundingRect.left;\r\n\t\trect.y = boundingRect.top;\r\n\t\trect.top = boundingRect.top;\r\n\t\trect.left = boundingRect.left;\r\n\t\trect.width = boundingRect.width;\r\n\t\trect.height = boundingRect.height;\r\n\t\trect.right = rect.left + rect.width;\r\n\t\trect.bottom = rect.top + rect.height;\r\n\t\trect.setCenter();\r\n\t\treturn rect;\r\n\t}\r\n\r\n\tset(rect) {\r\n\t\tif (rect) {\r\n\t\t\tObject.assign(this, rect);\r\n\t\t\tthis.right = this.left + this.width;\r\n\t\t\tthis.bottom = this.top + this.height;\r\n\t\t}\r\n\t\tthis.setCenter();\r\n\t}\r\n\r\n\tsetSize(w, h) {\r\n\t\tthis.width = w;\r\n\t\tthis.height = h;\r\n\t\tthis.right = this.left + this.width;\r\n\t\tthis.bottom = this.top + this.height;\r\n\t\tthis.setCenter();\r\n\t\t// console.log(w, h);\r\n\t}\r\n\r\n\tsetCenter() {\r\n\t\tconst center = this.center || (this.center = {});\r\n\t\tcenter.top = this.top + this.height / 2;\r\n\t\tcenter.left = this.left + this.width / 2;\r\n\t\tcenter.x = center.left;\r\n\t\tcenter.y = center.top;\r\n\t}\r\n\r\n\tcontains(left, top) {\r\n\t\treturn Rect.contains(this, left, top);\r\n\t}\r\n\r\n\tintersect(rect) {\r\n\t\treturn Rect.intersectRect(this, rect);\r\n\t}\r\n\r\n\tintersection(rect) {\r\n\t\tconst intersection = this.intersection_ || (this.intersection_ = {\r\n\t\t\tleft: 0,\r\n\t\t\ttop: 0,\r\n\t\t\twidth: 0,\r\n\t\t\theight: 0,\r\n\t\t\tx: 0,\r\n\t\t\ty: 0,\r\n\t\t\tpow: {\r\n\t\t\t\tx: -1,\r\n\t\t\t\ty: -1\r\n\t\t\t},\r\n\t\t\toffset: function(offset) {\r\n\t\t\t\toffset = offset || 0;\r\n\t\t\t\tconst pow = (this.top - this.rect.height / 2 + offset) / -this.height;\r\n\t\t\t\treturn pow;\r\n\t\t\t},\r\n\t\t\tscroll: function(offset) {\r\n\t\t\t\toffset = offset || 0;\r\n\t\t\t\tconst pow = (this.top - this.rect.height / 2 + offset) / -this.height;\r\n\t\t\t\treturn pow;\r\n\t\t\t}\r\n\t\t});\r\n\t\tintersection.left = this.left;\r\n\t\tintersection.top = this.top;\r\n\t\tintersection.width = this.width;\r\n\t\tintersection.height = this.height;\r\n\t\tintersection.x = this.left + this.width / 2;\r\n\t\tintersection.y = this.top + this.height / 2;\r\n\t\tintersection.rect = rect;\r\n\t\tconst pow = intersection.offset(0);\r\n\t\tintersection.pow.y = pow;\r\n\t\treturn intersection;\r\n\t}\r\n\r\n}\r\n","// import { auditTime, tap } from \"rxjs/operators\";\r\n// import AudioStreamService from \"../../audio/audio-stream.service\";\r\nimport StreamService from \"../../stream/stream.service\";\r\n\r\nexport const W = 320;\r\nexport const H = 240;\r\nexport const COLORS = [0xffcc00, 0x00ffcc, 0x00ccff, 0xccff00, 0xcc00ff, 0xffffff];\r\n\r\nexport default class AvatarElement {\r\n\r\n\tstatic get headGeometry() {\r\n\t\tif (!this.headGeometry_) {\r\n\t\t\tthis.headGeometry_ = new THREE.SphereBufferGeometry(0.2, 48, 48);\r\n\t\t}\r\n\t\treturn this.headGeometry_;\r\n\t}\r\n\r\n\tconstructor(message) {\r\n\t\tconst clientId = this.clientId = message.clientId;\r\n\t\tconst container = this.container = message.container;\r\n\t\tconst renderer = this.renderer = new THREE.WebGLRenderer({\r\n\t\t\tantialias: true,\r\n\t\t\talpha: false,\r\n\t\t\tpremultipliedAlpha: true,\r\n\t\t\t// physicallyCorrectLights: true,\r\n\t\t});\r\n\t\trenderer.setClearColor(0x000000, 1);\r\n\t\trenderer.setPixelRatio(window.devicePixelRatio);\r\n\t\trenderer.setSize(W, H);\r\n\t\trenderer.toneMapping = THREE.ACESFilmicToneMapping;\r\n\t\trenderer.toneMappingExposure = 0.8;\r\n\t\trenderer.outputEncoding = THREE.sRGBEncoding;\r\n\t\tcontainer.appendChild(renderer.domElement);\r\n\r\n\t\tconst camera = this.camera = new THREE.PerspectiveCamera(70, W / H, 0.01, 1000);\r\n\t\tcamera.position.set(0, 0, -0.5);\r\n\t\tcamera.target = new THREE.Vector3();\r\n\t\tcamera.lookAt(camera.target);\r\n\r\n\t\tconst scene = this.scene = new THREE.Scene();\r\n\r\n\t\t/*\r\n\t\tconst ambient = this.ambient = new THREE.AmbientLight(0x202020);\r\n\t\tscene.add(ambient);\r\n\t\t*/\r\n\r\n\t\tconst light = this.light = new THREE.PointLight(0xffffff, 1, 100);\r\n\t\tlight.position.set(0, 2, -2);\r\n\t\tscene.add(light);\r\n\r\n\t\tconst head = this.head = this.addHead();\r\n\t\tscene.add(head);\r\n\r\n\t\tconst remote = this.remote = StreamService.getRemoteById(clientId);\r\n\t\t/*\r\n\t\tif (remote) {\r\n\t\t\tthis.subscription = AudioStreamService.volume$(remote.stream).pipe(\r\n\t\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t\t\ttap(meter => {\r\n\t\t\t\t\tthis.chalk(meter.volume);\r\n\t\t\t\t})\r\n\t\t\t);\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\taddHead() {\r\n\t\tconst geometry = AvatarElement.headGeometry;\r\n\t\tconst canvas = this.canvas = document.createElement('canvas');\r\n\t\tcanvas.width = 1024;\r\n\t\tcanvas.height = 512;\r\n\t\tconst ctx = this.ctx = this.canvas.getContext('2d');\r\n\t\tconst map = this.map = new THREE.CanvasTexture(canvas);\r\n\t\tmap.offset.x = -0.25;\r\n\t\tconst color = COLORS[this.clientId % COLORS.length];\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\tmap: map,\r\n\t\t\tcolor: color,\r\n\t\t});\r\n\t\tthis.chalk(0);\r\n\t\treturn new THREE.Mesh(geometry, material);\r\n\t}\r\n\r\n\trender() {\r\n\t\tconst tick = this.tick_ ? ++this.tick_ : this.tick_ = 1;\r\n\t\t// if (tick % 2 === 1) {\r\n\t\tif (this.remote) {\r\n\t\t\tconst audioLevel = this.remote.getAudioLevel() * 12;\r\n\t\t\tthis.chalk(audioLevel);\r\n\t\t}\r\n\t\tconst renderer = this.renderer,\r\n\t\t\tscene = this.scene,\r\n\t\t\tcamera = this.camera;\r\n\t\trenderer.render(scene, camera);\r\n\t\t// }\r\n\t}\r\n\r\n\tupdate(message) {\r\n\t\tconst camera = message.camera;\r\n\t\tconst head = this.head;\r\n\t\thead.quaternion.set(camera[3], camera[4], camera[5], camera[6]);\r\n\t\t/*\r\n\t\thead.position.set(camera[0], camera[1], camera[2]);\r\n\t\t*/\r\n\t}\r\n\r\n\tdispose() {\r\n\t\t// !!! dispose threejs\r\n\t\tif (this.subscription) {\r\n\t\t\tthis.subscription.unsubscribe();\r\n\t\t}\r\n\t}\r\n\r\n\tchalk(i) {\r\n\t\ti = (i + Math.PI * 0.5) % (Math.PI * 2);\r\n\t\tconst vol = Math.sin(i) * 30;\r\n\t\tconst smile = Math.cos(i) * 10;\r\n\t\tconst x = 512;\r\n\t\tconst y = 256;\r\n\t\tconst ctx = this.ctx;\r\n\t\tctx.fillStyle = '#888888';\r\n\t\tctx.fillRect(0, 0, 1024, 512);\r\n\t\tctx.fillStyle = 'white';\r\n\t\tctx.beginPath();\r\n\t\tctx.arc(x - 40, y - 50, 7, 0, 2 * Math.PI);\r\n\t\tctx.arc(x + 40, y - 50, 7, 0, 2 * Math.PI);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tctx.beginPath();\r\n\t\t// ctx.quadraticCurveTo(x - 30, y + 30, x - 30, y + 30);\r\n\t\t// ctx.quadraticCurveTo(x - 30, y + 60, x, y + 60);\r\n\t\t// ctx.quadraticCurveTo(x + 30, y + 60, x + 30, y + 30);\r\n\t\t// ctx.quadraticCurveTo(x + 30, y, x, y);\r\n\t\tctx.moveTo(x - 40 - smile, y + 30);\r\n\t\tctx.bezierCurveTo(x - 40 - smile, y + 60, x + 40 + smile, y + 60, x + 40 + smile, y + 30);\r\n\t\tctx.bezierCurveTo(x + 40 + smile, y + vol, x - 40 - smile, y + vol, x - 40 - smile, y + 30);\r\n\t\t// ctx.arc(x, 256 + 50, 50, 0, 2 * Math.PI);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tthis.map.needsUpdate = true;\r\n\t}\r\n\r\n}\r\n","\r\n\r\nexport default class Camera extends THREE.PerspectiveCamera {\r\n\tconstructor(fov = 70, aspect = 1, near = 0.01, far = 1000, dolly = 70) {\r\n\t\tsuper(fov, aspect, near, far);\r\n\t\tthis.target = new THREE.Vector3();\r\n\t\tthis.box = new THREE.Group();\r\n\t\tthis.add(this.box);\r\n\t}\r\n}\r\n","import { ReplaySubject } from 'rxjs';\r\nimport { assetIsStream, AssetType } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport StateService from '../../state/state.service';\r\n\r\nexport class MediaLoaderEvent {\r\n\tconstructor(src, id) {\r\n\t\tthis.src = src;\r\n\t\tthis.id = id;\r\n\t}\r\n}\r\n\r\nexport class MediaLoaderPlayEvent extends MediaLoaderEvent { }\r\n\r\nexport class MediaLoaderPauseEvent extends MediaLoaderEvent { }\r\n\r\nexport default class MediaLoader {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn MediaLoader.loader || (MediaLoader.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getPath(item) {\r\n\t\treturn environment.getPath(item.asset.folder + item.asset.file);\r\n\t}\r\n\r\n\tstatic loadTexture(item, callback) {\r\n\t\tconst path = MediaLoader.getPath(item);\r\n\t\treturn MediaLoader.getLoader().load(path, callback);\r\n\t}\r\n\r\n\tstatic isVideo(item) {\r\n\t\treturn item.asset && item.asset.file && (item.asset.file.indexOf('.mp4') !== -1 || item.asset.file.indexOf('.webm') !== -1);\r\n\t}\r\n\r\n\tstatic isStream(item) {\r\n\t\treturn assetIsStream(item.asset);\r\n\t}\r\n\r\n\tstatic isPublisherStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.PublisherStream.name;\r\n\t}\r\n\r\n\tstatic isAttendeeStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.AttendeeStream.name;\r\n\t}\r\n\r\n\tstatic isSmartDeviceStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.SmartDeviceStream.name;\r\n\t}\r\n\r\n\tstatic isPublisherScreen(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.PublisherScreen.name;\r\n\t}\r\n\r\n\tstatic isAttendeeScreen(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.AttendeeScreen.name;\r\n\t}\r\n\r\n\tget isVideo() {\r\n\t\treturn MediaLoader.isVideo(this.item);\r\n\t}\r\n\r\n\tget isStream() {\r\n\t\treturn MediaLoader.isStream(this.item);\r\n\t}\r\n\r\n\tget isPublisherStream() {\r\n\t\treturn MediaLoader.isPublisherStream(this.item);\r\n\t}\r\n\r\n\tget isAttendeeStream() {\r\n\t\treturn MediaLoader.isAttendeeStream(this.item);\r\n\t}\r\n\r\n\tget isSmartDeviceStream() {\r\n\t\treturn MediaLoader.isSmartDeviceStream(this.item);\r\n\t}\r\n\r\n\tget isPublisherScreen() {\r\n\t\treturn MediaLoader.isPublisherScreen(this.item);\r\n\t}\r\n\r\n\tget isAttendeeScreen() {\r\n\t\treturn MediaLoader.isAttendeeScreen(this.item);\r\n\t}\r\n\r\n\tget isPlayableVideo() {\r\n\t\treturn this.isVideo && !this.item.asset.autoplay;\r\n\t}\r\n\r\n\tget isAutoplayVideo() {\r\n\t\treturn this.isStream || (this.isVideo && (this.item.asset.autoplay != null));\r\n\t}\r\n\r\n\tget muted() {\r\n\t\treturn this.muted_;\r\n\t}\r\n\r\n\tset muted(muted) {\r\n\t\tthis.muted_ = muted;\r\n\t\t// console.log('MediaLoader.muted', muted, this.video);\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.muted = muted === true;\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(item) {\r\n\t\tthis.item = item;\r\n\t\tthis.toggle = this.toggle.bind(this);\r\n\t\tthis.muted_ = false;\r\n\t\tthis.subscription = StateService.state$.subscribe(state => this.muted = state.volumeMuted);\r\n\t}\r\n\r\n\tload(callback) {\r\n\t\tconst item = this.item;\r\n\t\tlet texture;\r\n\t\t// console.log('MediaLoader.load', item, this.isStream);\r\n\t\tif (this.isStream && item.streamId) {\r\n\t\t\tconst streamId = item.streamId;\r\n\t\t\tconst target = `#stream-${streamId}`;\r\n\t\t\tconst video = document.querySelector(`${target} video`);\r\n\t\t\tif (!video) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst onCanPlay = () => {\r\n\t\t\t\tvideo.removeEventListener('canplay', onCanPlay);\r\n\t\t\t\ttexture = this.texture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\t// texture.image.width = video.videoWidth;\r\n\t\t\t\t// texture.image.height = video.videoHeight;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\t\tonCanPlay();\r\n\t\t\t} else {\r\n\t\t\t\tvideo.addEventListener('canplay', onCanPlay);\r\n\t\t\t}\r\n\t\t} else if (this.isVideo) {\r\n\t\t\t// create the video element\r\n\t\t\tconst video = this.video = document.createElement('video');\r\n\t\t\tvideo.preload = 'metadata';\r\n\t\t\tvideo.volume = 0.8;\r\n\t\t\tvideo.muted = true;\r\n\t\t\tvideo.playsInline = true;\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (item.asset && item.asset.autoplay) {\r\n\t\t\t\tvideo.loop = true;\r\n\t\t\t}\r\n\t\t\tconst onCanPlay = () => {\r\n\t\t\t\tvideo.oncanplay = null;\r\n\t\t\t\ttexture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\t// texture.image.width = video.videoWidth;\r\n\t\t\t\t// texture.image.height = video.videoHeight;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tif (!item.asset || !item.asset.autoplay) {\r\n\t\t\t\t\tvideo.pause();\r\n\t\t\t\t}\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.oncanplay = onCanPlay;\r\n\t\t\tvideo.src = MediaLoader.getPath(item);\r\n\t\t\tvideo.load(); // must call after setting/changing source\r\n\t\t\tthis.play(true);\r\n\t\t} else if (item.asset) {\r\n\t\t\tMediaLoader.loadTexture(item, texture => {\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\t// texture.format = THREE.RGBFormat;\r\n\t\t\t\ttexture.wrapS = THREE.RepeatWrapping;\r\n\t\t\t\ttexture.wrapT = THREE.RepeatWrapping;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tcallback(null, this);\r\n\t\t}\r\n\t\treturn this;\r\n\t}\r\n\r\n\tplay(silent) {\r\n\t\t// console.log('MediaLoader.play');\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.play().then(() => {\r\n\t\t\t\t// console.log('MediaLoader.play.success', this.item.asset.file);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('MediaLoader.play.error', this.item.asset.file, error);\r\n\t\t\t});\r\n\t\t\tif (!silent) {\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderPlayEvent(this.video.src, this.item.id));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpause(silent) {\r\n\t\t// console.log('MediaLoader.pause');\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.muted = true;\r\n\t\t\tthis.video.pause();\r\n\t\t\tif (!silent) {\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderPauseEvent(this.video.src, this.item.id));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggle() {\r\n\t\t// console.log('MediaLoader.toggle', this.video);\r\n\t\tif (this.video) {\r\n\t\t\tif (this.video.paused) {\r\n\t\t\t\tthis.video.muted = this.muted_;\r\n\t\t\t\tthis.play();\r\n\t\t\t\treturn true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.pause();\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.subscription.unsubscribe();\r\n\t\tthis.pause();\r\n\t\tdelete this.video;\r\n\t}\r\n\r\n}\r\n\r\nMediaLoader.events$ = new ReplaySubject(1);\r\n","import { of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\nimport { assetIsStream, AssetType } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport StreamService from '../../stream/stream.service';\r\nimport { RoleType } from '../../user/user';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport MediaLoader, { MediaLoaderPauseEvent, MediaLoaderPlayEvent } from './media-loader';\r\n\r\nconst VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\n\r\nconst FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform bool video;\r\nuniform float opacity;\r\nuniform float overlay;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\nuniform vec3 overlayColor;\r\n\r\nvoid main() {\r\n\tvec4 color;\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tif (video) {\r\n\t\tvec4 colorB = texture2D(textureB, vUv);\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2) + (colorB.rgb * tween * colorB.a), opacity);\r\n\t} else {\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2), opacity);\r\n\t}\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nconst FRAGMENT_CHROMA_KEY_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\n#define threshold 0.55\r\n#define padding 0.05\r\n\r\nvarying vec2 vUv;\r\nuniform bool video;\r\nuniform float opacity;\r\nuniform float overlay;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\nuniform vec3 chromaKeyColor;\r\nuniform vec3 overlayColor;\r\n\r\nvoid main() {\r\n\tvec4 color;\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tvec4 chromaKey = vec4(chromaKeyColor, 1.0);\r\n    vec3 chromaKeyDiff = colorA.rgb - chromaKey.rgb;\r\n    float chromaKeyValue = smoothstep(threshold - padding, threshold + padding, dot(chromaKeyDiff, chromaKeyDiff));\r\n\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2), opacity * chromaKeyValue);\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nexport default class MediaMesh extends InteractiveMesh {\r\n\r\n\tstatic getMaterial(useChromaKey) {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\tfragmentShader: useChromaKey ? FRAGMENT_CHROMA_KEY_SHADER : FRAGMENT_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\tvideo: { value: false },\r\n\t\t\t\ttextureA: { type: \"t\", value: null },\r\n\t\t\t\ttextureB: { type: \"t\", value: null },\r\n\t\t\t\tresolutionA: { value: new THREE.Vector2() },\r\n\t\t\t\tresolutionB: { value: new THREE.Vector2() },\r\n\t\t\t\toverlayColor: { value: new THREE.Color('#000000') },\r\n\t\t\t\toverlay: { value: 0 },\r\n\t\t\t\ttween: { value: 1 },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t},\r\n\t\t\t// side: THREE.DoubleSide\r\n\t\t});\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic getChromaKeyMaterial(chromaKeyColor = [0.0, 1.0, 0.0]) {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\tfragmentShader: FRAGMENT_CHROMA_KEY_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\tvideo: { value: false },\r\n\t\t\t\ttextureA: { type: \"t\", value: null },\r\n\t\t\t\ttextureB: { type: \"t\", value: null },\r\n\t\t\t\tresolutionA: { value: new THREE.Vector2() },\r\n\t\t\t\tresolutionB: { value: new THREE.Vector2() },\r\n\t\t\t\tchromaKeyColor: { value: new THREE.Vector3(chromaKeyColor[0], chromaKeyColor[1], chromaKeyColor[2]) },\r\n\t\t\t\toverlayColor: { value: new THREE.Color('#000000') },\r\n\t\t\t\toverlay: { value: 0 },\r\n\t\t\t\ttween: { value: 1 },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t},\r\n\t\t\tside: THREE.DoubleSide\r\n\t\t});\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic isPublisherStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Publisher;\r\n\t}\r\n\tstatic isAttendeeStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Attendee;\r\n\t}\r\n\tstatic isSmartDeviceStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.SmartDevice;\r\n\t}\r\n\tstatic isPublisherScreen(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Publisher && stream.clientInfo.uid !== stream.getId();\r\n\t}\r\n\tstatic isAttendeeScreen(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Attendee && stream.clientInfo.uid !== stream.getId();\r\n\t}\r\n\tstatic getTypeMatcher(assetType) {\r\n\t\tlet matcher;\r\n\t\tswitch (assetType.name) {\r\n\t\t\tcase AssetType.PublisherStream.name:\r\n\t\t\t\tmatcher = this.isPublisherStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.AttendeeStream.name:\r\n\t\t\t\tmatcher = this.isAttendeeStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.SmartDeviceStream.name:\r\n\t\t\t\tmatcher = this.isSmartDeviceStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.PublisherScreen.name:\r\n\t\t\t\tmatcher = this.isPublisherScreen;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.AttendeeScreen.name:\r\n\t\t\t\tmatcher = this.isAttendeeScreen;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tmatcher = (stream) => { return false; }\r\n\t\t}\r\n\t\treturn matcher;\r\n\t}\r\n\r\n\tstatic getStreamId$(item) {\r\n\t\tif (!item.asset) {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t\tconst assetType = item.asset.type;\r\n\t\tconst file = item.asset.file;\r\n\t\tif (assetIsStream(item.asset)) {\r\n\t\t\treturn StreamService.streams$.pipe(\r\n\t\t\t\tmap((streams) => {\r\n\t\t\t\t\tlet stream;\r\n\t\t\t\t\tlet i = 0;\r\n\t\t\t\t\tconst matchType = this.getTypeMatcher(assetType);\r\n\t\t\t\t\tstreams.forEach(x => {\r\n\t\t\t\t\t\tif (matchType(x)) {\r\n\t\t\t\t\t\t\tif (i === item.asset.index) {\r\n\t\t\t\t\t\t\t\tstream = x;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\ti++;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log('MediaMesh.getStreamId$', assetType.name, stream, streams);\r\n\t\t\t\t\tif (stream) {\r\n\t\t\t\t\t\treturn stream.getId();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(file);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getMaterialByItem(item) {\r\n\t\tlet material;\r\n\t\tif (item.asset && item.asset.chromaKeyColor) {\r\n\t\t\tmaterial = MediaMesh.getChromaKeyMaterial(item.asset.chromaKeyColor);\r\n\t\t} else if (item.asset) {\r\n\t\t\tmaterial = MediaMesh.getMaterial();\r\n\t\t} else {\r\n\t\t\tmaterial = new THREE.MeshBasicMaterial({ color: 0x888888 });\r\n\t\t}\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic getUniformsByItem(item) {\r\n\t\tlet uniforms = null;\r\n\t\tif (item.asset) {\r\n\t\t\tuniforms = {\r\n\t\t\t\toverlay: 0,\r\n\t\t\t\ttween: 1,\r\n\t\t\t\topacity: 0,\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn uniforms;\r\n\t}\r\n\r\n\tconstructor(item, items, geometry) {\r\n\t\tconst material = MediaMesh.getMaterialByItem(item);\r\n\t\tsuper(geometry, material);\r\n\t\tthis.item = item;\r\n\t\tthis.items = items;\r\n\t\tthis.renderOrder = environment.renderOrder.plane;\r\n\t\tthis.uniforms = MediaMesh.getUniformsByItem(item);\r\n\t\tconst mediaLoader = this.mediaLoader = new MediaLoader(item);\r\n\t\t/*\r\n\t\tif (item.asset && !mediaLoader.isVideo) {\r\n\t\t\tthis.freeze();\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tload(callback) {\r\n\t\tif (!this.item.asset) {\r\n\t\t\tthis.onAppear();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(this);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst material = this.material;\r\n\t\tconst mediaLoader = this.mediaLoader;\r\n\t\tmediaLoader.load((textureA) => {\r\n\t\t\t// console.log('MediaMesh.textureA', textureA);\r\n\t\t\tif (textureA) {\r\n\t\t\t\tmaterial.uniforms.textureA.value = textureA;\r\n\t\t\t\t// material.uniforms.resolutionA.value.x = textureA.image.width;\r\n\t\t\t\t// material.uniforms.resolutionA.value.y = textureA.image.height;\r\n\t\t\t\tmaterial.uniforms.resolutionA.value = new THREE.Vector2(textureA.image.width || textureA.image.videoWidth, textureA.image.height || textureA.image.videoHeight);\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\tif (mediaLoader.isPlayableVideo) {\r\n\t\t\t\t\tthis.createTextureB(textureA, (textureB) => {\r\n\t\t\t\t\t\t// console.log('MediaMesh.textureB', textureB);\r\n\t\t\t\t\t\ttextureB.minFilter = THREE.LinearFilter;\r\n\t\t\t\t\t\ttextureB.magFilter = THREE.LinearFilter;\r\n\t\t\t\t\t\ttextureB.mapping = THREE.UVMapping;\r\n\t\t\t\t\t\t// textureB.format = THREE.RGBFormat;\r\n\t\t\t\t\t\ttextureB.wrapS = THREE.RepeatWrapping;\r\n\t\t\t\t\t\ttextureB.wrapT = THREE.RepeatWrapping;\r\n\t\t\t\t\t\tmaterial.uniforms.textureB.value = textureB;\r\n\t\t\t\t\t\t// material.uniforms.resolutionB.value.x = textureB.image.width;\r\n\t\t\t\t\t\t// material.uniforms.resolutionB.value.y = textureB.image.height;\r\n\t\t\t\t\t\tmaterial.uniforms.resolutionB.value = new THREE.Vector2(textureB.image.width, textureB.image.height);\r\n\t\t\t\t\t\t// console.log(material.uniforms.resolutionB.value, textureB);\r\n\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.onAppear();\r\n\t\t\tif (mediaLoader.isPlayableVideo) {\r\n\t\t\t\tmaterial.uniforms.video.value = true;\r\n\t\t\t\tthis.onOver = this.onOver.bind(this);\r\n\t\t\t\tthis.onOut = this.onOut.bind(this);\r\n\t\t\t\tthis.onToggle = this.onToggle.bind(this);\r\n\t\t\t\tthis.on('over', this.onOver);\r\n\t\t\t\tthis.on('out', this.onOut);\r\n\t\t\t\tthis.on('down', this.onToggle);\r\n\t\t\t}\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(this);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcreateTextureB(textureA, callback) {\r\n\t\tconst aw = textureA.image.width || textureA.image.videoWidth;\r\n\t\tconst ah = textureA.image.height || textureA.image.videoHeight;\r\n\t\tconst ar = aw / ah;\r\n\t\tconst scale = 0.32;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\tcanvas.width = aw;\r\n\t\tcanvas.height = ah;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.imageSmoothingEnabled = true;\r\n\t\tctx.imageSmoothingQuality = 'high';\r\n\t\tconst image = new Image();\r\n\t\timage.onload = function() {\r\n\t\t\tconst bw = image.width;\r\n\t\t\tconst bh = image.height;\r\n\t\t\tconst br = bw / bh;\r\n\t\t\tlet w;\r\n\t\t\tlet h;\r\n\t\t\tif (ar > br) {\r\n\t\t\t\tw = ah * scale;\r\n\t\t\t\th = w / br;\r\n\t\t\t} else {\r\n\t\t\t\th = aw * scale;\r\n\t\t\t\tw = h * br;\r\n\t\t\t}\r\n\t\t\tctx.drawImage(image, aw / 2 - w / 2, ah / 2 - h / 2, w, h);\r\n\t\t\tconst textureB = new THREE.CanvasTexture(canvas);\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(textureB);\r\n\t\t\t}\r\n\t\t}\r\n\t\timage.crossOrigin = 'anonymous';\r\n\t\timage.src = environment.getPath('textures/ui/play.png');\r\n\t}\r\n\r\n\tevents$() {\r\n\t\tconst item = this.item;\r\n\t\tconst items = this.items;\r\n\t\tif (item.asset && item.asset.linkedPlayId) {\r\n\t\t\tthis.freeze();\r\n\t\t}\r\n\t\treturn MediaLoader.events$.pipe(\r\n\t\t\tmap(event => {\r\n\t\t\t\tif (item.asset && item.asset.linkedPlayId) {\r\n\t\t\t\t\tconst eventItem = items.find(x => x.asset && event.src.indexOf(x.asset.file) !== -1 && event.id === item.asset.linkedPlayId);\r\n\t\t\t\t\tif (eventItem) {\r\n\t\t\t\t\t\t// console.log('MediaLoader.events$.eventItem', event, eventItem);\r\n\t\t\t\t\t\tif (event instanceof MediaLoaderPlayEvent) {\r\n\t\t\t\t\t\t\tthis.play();\r\n\t\t\t\t\t\t} else if (event instanceof MediaLoaderPauseEvent) {\r\n\t\t\t\t\t\t\tthis.pause();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn event;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tonAppear() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonDisappear() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonOver() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\toverlay: 1,\r\n\t\t\t\ttween: this.playing ? 0 : 1,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.overlay.value = uniforms.overlay;\r\n\t\t\t\t\tmaterial.uniforms.tween.value = uniforms.tween;\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonOut() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\toverlay: 0,\r\n\t\t\t\ttween: this.playing ? 0 : 1,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.overlay.value = uniforms.overlay;\r\n\t\t\t\t\tmaterial.uniforms.tween.value = uniforms.tween;\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonToggle() {\r\n\t\tthis.playing = this.mediaLoader.toggle();\r\n\t\tthis.emit('playing', this.playing);\r\n\t\tthis.onOut();\r\n\t}\r\n\r\n\tplay() {\r\n\t\tthis.mediaLoader.play();\r\n\t\tthis.playing = true;\r\n\t\tthis.emit('playing', true);\r\n\t\tthis.onOut();\r\n\t}\r\n\r\n\tpause() {\r\n\t\tthis.mediaLoader.pause();\r\n\t\tthis.playing = false;\r\n\t\tthis.emit('playing', false);\r\n\t\tthis.onOut();\r\n\t}\r\n\r\n\tsetPlayingState(playing) {\r\n\t\tif (this.playing !== playing) {\r\n\t\t\tthis.playing = playing;\r\n\t\t\tplaying ? this.mediaLoader.play() : this.mediaLoader.pause();\r\n\t\t\tthis.onOut();\r\n\t\t}\r\n\t}\r\n\r\n\tupdateByItem(item) {\r\n\t\tthis.disposeMaterial();\r\n\t\tthis.disposeMediaLoader();\r\n\t\tthis.material = MediaMesh.getMaterialByItem(item);\r\n\t\tthis.uniforms = MediaMesh.getUniformsByItem(item);\r\n\t\tthis.mediaLoader = new MediaLoader(item);\r\n\t}\r\n\r\n\tdisposeMaterial() {\r\n\t\tif (this.material) {\r\n\t\t\tif (this.material.map && this.material.map.disposable !== false) {\r\n\t\t\t\tthis.material.map.dispose();\r\n\t\t\t}\r\n\t\t\tthis.material.dispose();\r\n\t\t\tthis.material = null;\r\n\t\t}\r\n\t}\r\n\r\n\tdisposeMediaLoader() {\r\n\t\tconst mediaLoader = this.mediaLoader;\r\n\t\tif (mediaLoader) {\r\n\t\t\tif (mediaLoader.isPlayableVideo) {\r\n\t\t\t\tthis.off('over', this.onOver);\r\n\t\t\t\tthis.off('out', this.onOut);\r\n\t\t\t\tthis.off('down', this.onToggle);\r\n\t\t\t}\r\n\t\t\tmediaLoader.dispose();\r\n\t\t\tthis.mediaLoader = null;\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.disposeMediaLoader();\r\n\t}\r\n\r\n}\r\n\r\n/*\r\nconst FRAGMENT_SHADER_BAK = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform bool video;\r\nuniform float opacity;\r\nuniform float overlay;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\nuniform vec3 overlayColor;\r\n\r\nmat3 rotate(float a) {\r\n\treturn mat3(\r\n\t\tcos(a), sin(a), 0.0,\r\n\t\t-sin(a), cos(a), 0.0,\r\n\t\t0.0, 0.0, 1.0\r\n\t);\r\n}\r\n\r\nmat3 translate(vec2 t) {\r\n\treturn mat3(\r\n\t\t1.0, 0.0, 0.0,\r\n\t\t0.0, 1.0, 0.0,\r\n\t\tt.x, t.y, 1.0\r\n\t);\r\n}\r\n\r\nmat3 scale(vec2 s) {\r\n\treturn mat3(\r\n\t\ts.x, 0.0, 0.0,\r\n\t\t0.0, s.y, 0.0,\r\n\t\t0.0, 0.0, 1.0\r\n\t);\r\n}\r\n\r\nvec2 getUV2(vec2 vUv, vec2 t, vec2 s, float a) {\r\n\tmat3 transform = scale(s) * rotate(a);\r\n\treturn (vec3(vUv + t, 0.0) * transform).xy;\r\n}\r\n\r\nvoid main() {\r\n\tvec4 color;\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tif (video) {\r\n\t\tfloat rA = resolutionA.x / resolutionA.y;\r\n\t\tfloat rB = resolutionB.x / resolutionB.y;\r\n\t\tfloat aspect = 1.0 / rA * rB;\r\n\t\tvec2 s = vec2(3.0 / aspect, 3.0);\r\n\t\tvec2 t = vec2(\r\n\t\t\t-(resolutionA.x - resolutionB.x / s.x) * 0.5 / resolutionA.x,\r\n\t\t\t-(resolutionA.y - resolutionB.y / s.y) * 0.5 / resolutionA.y\r\n\t\t);\r\n\t\tt = vec2(\r\n\t\t\t-(resolutionA.x - resolutionB.x / s.y) * 0.5 / resolutionA.x,\r\n\t\t\t-(resolutionA.y - resolutionB.y / s.y) * 0.5 / resolutionA.y\r\n\t\t);\r\n\t\t// float dx = (resolutionA.x - resolutionB.x) / resolutionA.x * 0.5;\r\n\t\t// float dy = (resolutionA.y - resolutionB.y) / resolutionA.y * 0.5;\r\n\t\t// t = vec2(-0.5 + dx, -0.5 - dy);\r\n\t\tvec2 uv2 = clamp(\r\n\t\t\tgetUV2(vUv, t, s, 0.0),\r\n\t\t\tvec2(0.0,0.0),\r\n\t\t\tvec2(1.0,1.0)\r\n\t\t);\r\n\t\tvec4 colorB = texture2D(textureB, uv2);\r\n\t\tcolorB = texture2D(textureB, vUv);\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2) + (colorB.rgb * tween * colorB.a), opacity);\r\n\t} else {\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2), opacity);\r\n\t}\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n*/\r\n","import { fromEvent, merge, ReplaySubject, Subject } from 'rxjs';\r\nimport { filter, map, startWith, switchMap, takeUntil } from 'rxjs/operators';\r\n\r\nexport class DragPoint {\r\n\tconstructor() {\r\n\t\tthis.x = 0;\r\n\t\tthis.y = 0;\r\n\t}\r\n}\r\n\r\nexport class DragEvent {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class DragDownEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.distance = new DragPoint();\r\n\t\tthis.strength = new DragPoint();\r\n\t\tthis.speed = new DragPoint();\r\n\t}\r\n}\r\n\r\nexport class DragMoveEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.distance = new DragPoint();\r\n\t\tthis.strength = new DragPoint();\r\n\t\tthis.speed = new DragPoint();\r\n\t}\r\n}\r\n\r\nexport class DragUpEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nlet upEvent;\r\n\r\nexport default class DragService {\r\n\r\n\tstatic getPosition(event, point) {\r\n\t\tif (event instanceof MouseEvent) {\r\n\t\t\tpoint ? (\r\n\t\t\t\tpoint.x = event.clientX,\r\n\t\t\t\tpoint.y = event.clientY\r\n\t\t\t) : point = {\r\n\t\t\t\tx: event.clientX,\r\n\t\t\t\ty: event.clientY,\r\n\t\t\t};\r\n\t\t} else if (window.TouchEvent && event instanceof TouchEvent) {\r\n\t\t\tif (event.touches.length > 0) {\r\n\t\t\t\tpoint ? (\r\n\t\t\t\t\tpoint.x = event.touches[0].pageX,\r\n\t\t\t\t\tpoint.y = event.touches[0].pageY\r\n\t\t\t\t) : point = {\r\n\t\t\t\t\tx: event.touches[0].pageX,\r\n\t\t\t\t\ty: event.touches[0].pageY\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn point;\r\n\t}\r\n\r\n\tstatic down$(target, events$) {\r\n\t\tlet downEvent;\r\n\t\treturn merge(\r\n\t\t\tfromEvent(target, 'mousedown').pipe(filter(event => event.button === 0)),\r\n\t\t\tfromEvent(target, 'touchstart')\r\n\t\t).pipe(\r\n\t\t\tmap((event) => {\r\n\t\t\t\tdownEvent = downEvent || new DragDownEvent();\r\n\t\t\t\tdownEvent.node = target;\r\n\t\t\t\tdownEvent.target = event.target;\r\n\t\t\t\tdownEvent.originalEvent = event;\r\n\t\t\t\tdownEvent.down = this.getPosition(event, downEvent.down);\r\n\t\t\t\tif (downEvent.down) {\r\n\t\t\t\t\tdownEvent.distance = new DragPoint();\r\n\t\t\t\t\tdownEvent.strength = new DragPoint();\r\n\t\t\t\t\tdownEvent.speed = new DragPoint();\r\n\t\t\t\t\tevents$.next(downEvent);\r\n\t\t\t\t\treturn downEvent;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event !== undefined),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic move$(target, events$, dismiss$, downEvent) {\r\n\t\tlet moveEvent;\r\n\t\treturn fromEvent(document, downEvent.originalEvent instanceof MouseEvent ? 'mousemove' : 'touchmove').pipe(\r\n\t\t\tstartWith(downEvent),\r\n\t\t\tmap((event) => {\r\n\t\t\t\tmoveEvent = moveEvent || new DragMoveEvent();\r\n\t\t\t\tmoveEvent.node = target;\r\n\t\t\t\tmoveEvent.target = event.target;\r\n\t\t\t\tmoveEvent.originalEvent = event;\r\n\t\t\t\tmoveEvent.position = this.getPosition(event, moveEvent.position);\r\n\t\t\t\tconst dragging = downEvent.down !== undefined && moveEvent.position !== undefined;\r\n\t\t\t\tif (dragging) {\r\n\t\t\t\t\tmoveEvent.distance.x = moveEvent.position.x - downEvent.down.x;\r\n\t\t\t\t\tmoveEvent.distance.y = moveEvent.position.y - downEvent.down.y;\r\n\t\t\t\t\tmoveEvent.strength.x = moveEvent.distance.x / window.innerWidth * 2;\r\n\t\t\t\t\tmoveEvent.strength.y = moveEvent.distance.y / window.innerHeight * 2;\r\n\t\t\t\t\tmoveEvent.speed.x = downEvent.speed.x + (moveEvent.strength.x - downEvent.strength.x) * 0.1;\r\n\t\t\t\t\tmoveEvent.speed.y = downEvent.speed.y + (moveEvent.strength.y - downEvent.strength.y) * 0.1;\r\n\t\t\t\t\tdownEvent.distance.x = moveEvent.distance.x;\r\n\t\t\t\t\tdownEvent.distance.y = moveEvent.distance.y;\r\n\t\t\t\t\tdownEvent.speed.x = moveEvent.speed.x;\r\n\t\t\t\t\tdownEvent.speed.y = moveEvent.speed.y;\r\n\t\t\t\t\tdownEvent.strength.x = moveEvent.strength.x;\r\n\t\t\t\t\tdownEvent.strength.y = moveEvent.strength.y;\r\n\t\t\t\t\tevents$.next(moveEvent);\r\n\t\t\t\t\treturn moveEvent;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic dismissEvent(event, events$, dismiss$, downEvent) {\r\n\t\t// console.log('DragService.dismissEvent', event);\r\n\t\tupEvent = upEvent || new DragUpEvent();\r\n\t\tevents$.next(upEvent);\r\n\t\tdismiss$.next();\r\n\t\t// console.log(downEvent.distance);\r\n\t\tif (downEvent && Math.abs(downEvent.distance.x) > 10) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tevent.stopImmediatePropagation();\r\n\t\t}\r\n\t\treturn upEvent;\r\n\t}\r\n\r\n\tstatic up$(target, events$, dismiss$, downEvent) {\r\n\t\treturn fromEvent(document, downEvent.originalEvent instanceof MouseEvent ? 'mouseup' : 'touchend').pipe(\r\n\t\t\tmap(event => this.dismissEvent(event, events$, dismiss$, downEvent)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic observe$(target) {\r\n\t\ttarget = target || document;\r\n\t\tconst events$ = DragService.events$ = new ReplaySubject(1);\r\n\t\tconst dismiss$ = DragService.dismiss$ = new Subject();\r\n\t\treturn this.down$(target, events$).pipe(\r\n\t\t\tswitchMap((downEvent) => {\r\n\t\t\t\tDragService.downEvent = downEvent;\r\n\t\t\t\treturn merge(\r\n\t\t\t\t\tthis.move$(target, events$, dismiss$, downEvent),\r\n\t\t\t\t\tthis.up$(target, events$, dismiss$, downEvent),\r\n\t\t\t\t).pipe(\r\n\t\t\t\t\ttakeUntil(dismiss$),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t\tswitchMap(() => events$),\r\n\t\t);\r\n\t}\r\n\r\n}\r\n","import { combineLatest, ReplaySubject } from 'rxjs';\r\nimport { filter, map, startWith, switchMap, tap } from 'rxjs/operators';\r\nimport DragService, { DragDownEvent, DragMoveEvent, DragUpEvent } from '../../drag/drag.service';\r\nimport KeyboardService from '../../keyboard/keyboard.service';\r\nimport StateService from '../../state/state.service';\r\n\r\nexport const OrbitMode = {\r\n\tPanorama: 'panorama',\r\n\tPanoramaGrid: 'panorama-grid',\r\n\tModel: 'model',\r\n};\r\n\r\nexport class OrbitEvent { }\r\nexport class OrbitDragEvent extends OrbitEvent { }\r\nexport class OrbitResizeEvent extends OrbitEvent { }\r\nexport class OrbitMoveEvent extends OrbitEvent { }\r\nconst orbitMoveEvent = new OrbitMoveEvent();\r\nconst orbitDragEvent = new OrbitDragEvent();\r\nconst orbitResizeEvent = new OrbitResizeEvent();\r\n\r\nexport const USE_DOLLY = false;\r\nexport const DOLLY_MIN = 15;\r\nexport const DOLLY_MAX = 75; // 115\r\nexport const ZOOM_MIN = 15;\r\nexport const ZOOM_MAX = 75;\r\n\r\nexport default class OrbitService {\r\n\r\n\tget dolly() {\r\n\t\treturn this.dolly_;\r\n\t}\r\n\tset dolly(dolly) {\r\n\t\tconst clampedDolly = THREE.Math.clamp(dolly, DOLLY_MIN, DOLLY_MAX);\r\n\t\tif (this.dolly_ !== clampedDolly) {\r\n\t\t\tthis.dolly_ = clampedDolly;\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\tgetDollyValue() {\r\n\t\treturn (1 - (this.dolly_ - DOLLY_MIN) / (DOLLY_MAX - DOLLY_MIN)) - 0.5;\r\n\t}\r\n\r\n\tget zoom() {\r\n\t\treturn this.zoom_;\r\n\t}\r\n\tset zoom(zoom) {\r\n\t\tconst clampedDolly = THREE.Math.clamp(zoom, DOLLY_MIN, DOLLY_MAX);\r\n\t\tif (this.zoom_ !== clampedDolly) {\r\n\t\t\tthis.zoom_ = clampedDolly;\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\tgetZoomValue() {\r\n\t\treturn 1 + 1 - (this.zoom_ - ZOOM_MIN) / (ZOOM_MAX - ZOOM_MIN);\r\n\t}\r\n\r\n\tget mode() {\r\n\t\treturn this.mode_;\r\n\t}\r\n\tset mode(mode) {\r\n\t\tif (this.mode_ !== mode) {\r\n\t\t\tthis.mode_ = mode;\r\n\t\t\tOrbitService.mode = mode;\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(camera) {\r\n\t\tthis.mode_ = OrbitService.mode = OrbitMode.Panorama;\r\n\t\tthis.dolly_ = 70;\r\n\t\tthis.zoom_ = 70;\r\n\t\tthis.longitude = 0;\r\n\t\tthis.latitude = 0;\r\n\t\tthis.direction = 1;\r\n\t\tthis.radius = 101;\r\n\t\tthis.position = new THREE.Vector3();\r\n\t\t// this.speed = 1;\r\n\t\tthis.inertia = new THREE.Vector2();\r\n\t\tthis.rotation = new THREE.Euler(0, 0, 0, 'XYZ');\r\n\t\tthis.target = new THREE.Vector3();\r\n\t\tthis.updatePosition = new THREE.Vector3();\r\n\t\tthis.updateTarget = new THREE.Vector3();\r\n\t\tthis.camera = camera;\r\n\t\tthis.setLongitudeLatitude(0, 0);\r\n\t\tthis.events$ = new ReplaySubject(1);\r\n\t}\r\n\r\n\tsetOrientation(orientation) {\r\n\t\tif (orientation) {\r\n\t\t\tthis.setLongitudeLatitude(orientation.longitude, orientation.latitude);\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\r\n\tgetOrientation() {\r\n\t\treturn {\r\n\t\t\tlatitude: this.latitude,\r\n\t\t\tlongitude: this.longitude,\r\n\t\t};\r\n\t}\r\n\r\n\tsetLongitudeLatitude(longitude, latitude) {\r\n\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\tthis.longitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\tthis.latitude = latitude;\r\n\t\t// console.log(this.longitude);\r\n\t\tconst phi = THREE.Math.degToRad(90 - latitude);\r\n\t\tconst theta = THREE.Math.degToRad(longitude);\r\n\t\tthis.phi = phi;\r\n\t\tthis.theta = theta;\r\n\t}\r\n\r\n\tobserve$(node) {\r\n\t\t// const camera = this.camera;\r\n\t\tlet latitude, longitude;\r\n\t\treturn combineLatest([KeyboardService.keys$(), DragService.observe$(node)]).pipe(\r\n\t\t\tfilter(event => (!StateService.state.locked && !StateService.state.spying)),\r\n\t\t\tmap((datas) => {\r\n\t\t\t\tconst keys = datas[0];\r\n\t\t\t\tconst event = datas[1];\r\n\t\t\t\t// const group = this.objects.children[this.index];\r\n\t\t\t\tif (event instanceof DragDownEvent) {\r\n\t\t\t\t\tlatitude = this.latitude;\r\n\t\t\t\t\tlongitude = this.longitude;\r\n\t\t\t\t} else if (event instanceof DragMoveEvent) {\r\n\t\t\t\t\tif (keys.Shift) {\r\n\t\t\t\t\t\tthis.events$.next(orbitDragEvent);\r\n\t\t\t\t\t} else if (keys.Control) {\r\n\t\t\t\t\t\tthis.events$.next(orbitResizeEvent);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst flip = this.mode_ === OrbitMode.Model ? -1 : 1;\r\n\t\t\t\t\t\tthis.setLongitudeLatitude(longitude - event.distance.x * 0.1 * flip, latitude + event.distance.y * 0.1);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (event instanceof DragUpEvent) {\r\n\r\n\t\t\t\t}\r\n\t\t\t\treturn event;\r\n\t\t\t}),\r\n\t\t\tfilter(event => event instanceof DragMoveEvent),\r\n\t\t\tstartWith({ latitude: this.latitude, longitude: this.longitude }),\r\n\t\t\ttap(event => this.update()),\r\n\t\t\tswitchMap(event => this.events$),\r\n\t\t);\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tlet radius, position = this.updatePosition, target = this.updateTarget;\r\n\t\tconst zoom = this.getZoomValue();\r\n\t\tconst dolly = this.getDollyValue();\r\n\t\t// console.log('dolly', dolly);\r\n\t\tconst phi = THREE.MathUtils.degToRad(90 - this.latitude);\r\n\t\tconst theta = THREE.MathUtils.degToRad(this.longitude);\r\n\t\tconst camera = this.camera;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = USE_DOLLY ? 3 + 3 * dolly : 3;\r\n\t\t\t\tposition.copy(this.position);\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tcamera.target.copy(position);\r\n\t\t\t\tcamera.position.copy(target);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tif (USE_DOLLY) {\r\n\t\t\t\t\tposition.copy(target).position.multiplyScalar(-1 * dolly);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tposition.copy(this.position);\r\n\t\t\t\t}\r\n\t\t\t\tcamera.position.copy(position);\r\n\t\t\t\tcamera.target.copy(target);\r\n\t\t}\r\n\t\t// console.log(camera.position.x, camera.position.y, camera.position.z);\r\n\t\t// console.log(camera.target.x, camera.target.y, camera.target.z);\r\n\t\t// console.log('phi', phi, 'theta', theta);\r\n\t\t// this.inverse();\r\n\t\tif (!USE_DOLLY) {\r\n\t\t\tcamera.zoom = zoom;\r\n\t\t}\r\n\t\tcamera.lookAt(camera.target);\r\n\t\tcamera.updateProjectionMatrix();\r\n\t\tthis.events$.next(orbitMoveEvent);\r\n\t}\r\n\r\n\t/*\r\n\tinverse() {\r\n\t\tlet position, radius;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = 3;\r\n\t\t\t\tposition = this.camera.position;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t\t\tposition = this.camera.target;\r\n\t\t}\r\n\t\tradius = Math.sqrt(position.x * position.x + position.y * position.y + position.z * position.z);\r\n\t\tconst phi = Math.acos(position.y / radius);\r\n\t\tconst theta = Math.atan2(position.z, position.x);\r\n\t\t// console.log('phi', phi, 'theta', theta);\r\n\t}\r\n\t*/\r\n\r\n\trender() {\r\n\t\tthis.longitude += 0.025;\r\n\t\tthis.update();\r\n\t}\r\n\r\n\twalk(position, callback) {\r\n\t\tlet radius;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = 3;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t}\r\n\t\tconst heading = new THREE.Vector2(position.x, position.y).normalize().multiplyScalar(radius);\r\n\t\tconst headingTheta = Math.atan2(heading.y, heading.x);\r\n\t\tlet headingLongitude = THREE.MathUtils.radToDeg(headingTheta);\r\n\t\theadingLongitude = (headingLongitude < 0 ? 360 + headingLongitude : headingLongitude) % 360;\r\n\t\tconst headingLatitude = 0;\r\n\t\tconst latitude = this.latitude;\r\n\t\tconst longitude = this.longitude;\r\n\t\tlet differenceLongitude = (headingLongitude - longitude);\r\n\t\tdifferenceLongitude = Math.abs(differenceLongitude) > 180 ? (differenceLongitude - 360 * (differenceLongitude / Math.abs(differenceLongitude))) : differenceLongitude;\r\n\t\tlet differenceLatitude = (headingLatitude - latitude);\r\n\t\tdifferenceLatitude = Math.abs(differenceLatitude) > 90 ? (differenceLatitude - 90 * (differenceLatitude / Math.abs(differenceLatitude))) : differenceLatitude;\r\n\t\t// console.log('headingTheta', headingTheta, 'headingLongitude', headingLongitude, 'differenceLongitude', differenceLongitude);\r\n\t\tconst from = { tween: 0 };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.7,\r\n\t\t\ttween: 1,\r\n\t\t\tdelay: 0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.setLongitudeLatitude(longitude + differenceLongitude * from.tween, latitude + differenceLatitude * from.tween);\r\n\t\t\t\tthis.position.set(position.x * from.tween, 0, position.y * from.tween);\r\n\t\t\t\tthis.update();\r\n\t\t\t},\r\n\t\t\tonComplete: () => {\r\n\t\t\t\t// this.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(headingLongitude, headingLatitude);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\twalkComplete(headingLongitude, headingLatitude) {\r\n\t\tthis.setLongitudeLatitude(headingLongitude, headingLatitude);\r\n\t\tthis.position.set(0, 0, 0);\r\n\t\tthis.update();\r\n\t}\r\n\r\n\tlookAt(object3d) {\r\n\t\t// !!! fix\r\n\t\tif (object3d) {\r\n\t\t\t/*\r\n\t\t\tconst camera = this.camera;\r\n\t\t\tcamera.target.copy(object3d.position);\r\n\t\t\tcamera.lookAt(camera.target);\r\n\t\t\tcamera.updateProjectionMatrix();\r\n\t\t\t*/\r\n\t\t\tconst position = object3d.position;\r\n\t\t\tlet radius;\r\n\t\t\tswitch (this.mode_) {\r\n\t\t\t\tcase OrbitMode.Model:\r\n\t\t\t\t\tradius = 3;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tradius = this.radius;\r\n\t\t\t}\r\n\t\t\tconst heading = new THREE.Vector3(position.x, position.z, position.y).normalize().multiplyScalar(radius);\r\n\t\t\tconst theta = Math.atan2(heading.y, heading.x);\r\n\t\t\tconst phi = Math.acos(heading.z / radius);\r\n\t\t\tlet longitude = THREE.MathUtils.radToDeg(theta);\r\n\t\t\tlongitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\t\tlet latitude = 90 - THREE.MathUtils.radToDeg(phi);\r\n\t\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\t\tthis.setLongitudeLatitude(longitude, latitude);\r\n\t\t\tthis.update();\r\n\t\t\t// this.events$.next(orbitMoveEvent);\r\n\t\t}\r\n\t\t/*\r\n\t\tlet radius, position = this.updatePosition, target = this.updateTarget;\r\n\t\tconst zoom = this.getZoomValue();\r\n\t\tconst dolly = this.getDollyValue();\r\n\t\t// console.log('dolly', dolly);\r\n\t\tconst phi = THREE.MathUtils.degToRad(90 - this.latitude);\r\n\t\tconst theta = THREE.MathUtils.degToRad(this.longitude);\r\n\t\tconst camera = this.camera;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = USE_DOLLY ? 3 + 3 * dolly : 3;\r\n\t\t\t\tposition.copy(this.position);\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tcamera.target.copy(position);\r\n\t\t\t\tcamera.position.copy(target);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tif (USE_DOLLY) {\r\n\t\t\t\t\tposition.copy(target).position.multiplyScalar(-1 * dolly);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tposition.copy(this.position);\r\n\t\t\t\t}\r\n\t\t\t\tcamera.position.copy(position);\r\n\t\t\t\tcamera.target.copy(target);\r\n\t\t}\r\n\t\t// console.log(camera.position.x, camera.position.y, camera.position.z);\r\n\t\t// console.log(camera.target.x, camera.target.y, camera.target.z);\r\n\t\t// console.log('phi', phi, 'theta', theta);\r\n\t\t// this.inverse();\r\n\t\tif (!USE_DOLLY) {\r\n\t\t\tcamera.zoom = zoom;\r\n\t\t}\r\n\t\tcamera.lookAt(camera.target);\r\n\t\tcamera.updateProjectionMatrix();\r\n\t\tthis.events$.next(orbitMoveEvent);\r\n\t\t*/\r\n\t}\r\n\r\n\tsetVRCamera(camera) {\r\n\t\tif (camera) {\r\n\t\t\t// head.quaternion.set(camera[3], camera[4], camera[5], camera[6]);\r\n\t\t\t// head.position.set(camera[0], camera[1], camera[2]);\r\n\t\t\tconst radius = this.radius;\r\n\t\t\tconst position = new THREE.Vector3(0, 0, -radius);\r\n\t\t\tconst quaternion = new THREE.Quaternion(camera[3], camera[4], camera[5], camera[6]);\r\n\t\t\tposition.applyQuaternion(quaternion);\r\n\t\t\tconst heading = new THREE.Vector3(position.x, position.z, position.y).normalize().multiplyScalar(radius);\r\n\t\t\tconst theta = Math.atan2(heading.y, heading.x);\r\n\t\t\tconst phi = Math.acos(heading.z / radius);\r\n\t\t\tlet longitude = THREE.MathUtils.radToDeg(theta);\r\n\t\t\tlongitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\t\tlet latitude = 90 - THREE.MathUtils.radToDeg(phi);\r\n\t\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\t\tthis.setLongitudeLatitude(longitude, latitude);\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import StreamService from \"../../stream/stream.service\";\r\n\r\nexport const W = 12;\r\nexport const H = 27;\r\nexport const D = 0.5;\r\nexport const R = 4 / 3;\r\nexport const COLORS = [0xffffff, 0xffcc00, 0x00ffcc, 0x00ccff, 0xccff00, 0xcc00ff];\r\n\r\nexport class PhoneStreamElement {\r\n\r\n\tstatic get geometry() {\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(0.01 * W, 0.01 * W / R, 2, 2);\r\n\t\treturn geometry;\r\n\t}\r\n\r\n\tsetRemote(remote, i, total) {\r\n\t\tthis.remote = remote;\r\n\t\tlet s, c, r, w, h, sx, sy, sz = 0.01 * D; // !!! double distance\r\n\t\tif (total < 4) {\r\n\t\t\ts = 1;\r\n\t\t\tc = 0;\r\n\t\t\tr = i;\r\n\t\t\tw = 0.01 * W * s;\r\n\t\t\th = w / R;\r\n\t\t\tsx = 0;\r\n\t\t\tsy = h / 2 - (total * h) / 2;\r\n\t\t\tthis.plane.position.set(sx, sy + h * i, sz);\r\n\t\t} else {\r\n\t\t\ts = 0.5;\r\n\t\t\tc = i % 2;\r\n\t\t\tr = Math.floor(i / 2);\r\n\t\t\tw = 0.01 * W * s;\r\n\t\t\th = w / R;\r\n\t\t\tsx = -w / 2;\r\n\t\t\tsy = h / 2 - (Math.ceil(total / 2) * h) / 2;\r\n\t\t\tthis.plane.position.set(sx + c * w, sy + r * h, sz);\r\n\t\t}\r\n\t\tthis.plane.scale.set(s, s, s);\r\n\t\t// console.log(this.plane.position);\r\n\t\tif (typeof remote === 'number') {\r\n\t\t\tthis.plane.material.color.set(COLORS[i % COLORS.length]);\r\n\t\t} else {\r\n\t\t\tif (remote.texture) {\r\n\t\t\t\tthis.plane.material.map = remote.texture;\r\n\t\t\t\tthis.plane.material.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.addStreamTexture(remote.getId(), (texture) => {\r\n\t\t\t\t\tremote.texture = texture;\r\n\t\t\t\t\tthis.plane.material.map = texture;\r\n\t\t\t\t\tthis.plane.material.needsUpdate = true;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddStreamTexture(streamId, callback) {\r\n\t\tconst target = `#stream-${streamId}`;\r\n\t\tconst video = document.querySelector(`${target} video`);\r\n\t\tif (!video) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst onPlaying = () => {\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(texture);\r\n\t\t\t}\r\n\t\t};\r\n\t\tvideo.crossOrigin = 'anonymous';\r\n\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\tonPlaying();\r\n\t\t} else {\r\n\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\tonPlaying();\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tconst geometry = PhoneStreamElement.geometry;\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\tcolor: 0xffffff,\r\n\t\t\tside: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst plane = this.plane = new THREE.Mesh(geometry, material);\r\n\t}\r\n\r\n}\r\n\r\nexport default class PhoneElement {\r\n\r\n\tset remotes(remotes) {\r\n\t\t// console.log('PhoneElement', remotes);\r\n\t\tremotes.forEach((remote, i) => {\r\n\t\t\tlet stream = this.streams[i];\r\n\t\t\tif (!stream) {\r\n\t\t\t\tstream = new PhoneStreamElement();\r\n\t\t\t}\r\n\t\t\tstream.setRemote(remote, i, remotes.length);\r\n\t\t\tthis.phone.add(stream.plane);\r\n\t\t\tthis.streams[i] = stream;\r\n\t\t});\r\n\t\tfor (let i = remotes.length; i < this.streams.length; i++) {\r\n\t\t\tthis.phone.remove(this.streams[i].plane);\r\n\t\t}\r\n\t\tthis.streams.length = remotes.length;\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tconst mesh = this.mesh = new THREE.Group();\r\n\t\tconst phone = this.phone = this.create();\r\n\t\tmesh.add(phone);\r\n\t\tconst streams = this.streams = [];\r\n\t\tStreamService.remotes$.subscribe(remotes => {\r\n\t\t\tthis.remotes = remotes;\r\n\t\t});\r\n\t}\r\n\r\n\tcreate() {\r\n\t\tconst geometry = new THREE.BoxBufferGeometry(0.01 * W, 0.01 * H, 0.01 * D, 2, 2, 1);\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\tcolor: 0x202020,\r\n\t\t});\r\n\t\tconst phone = new THREE.Mesh(geometry, material);\r\n\t\tphone.rotation.set(-Math.PI / 4, 0, 0);\r\n\t\treturn phone;\r\n\t}\r\n\r\n}\r\n","import { environment } from '../../environment';\r\nimport Interactive from '../interactive/interactive';\r\n\r\nconst ORIGIN = new THREE.Vector3();\r\n\r\nexport default class PointerElement {\r\n\r\n\tconstructor(color = '#ffffff') {\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(1.2, 1.2, 2, 2);\r\n\t\tconst loader = new THREE.TextureLoader();\r\n\t\tconst texture = loader.load(environment.getPath('textures/ui/nav-point.png'));\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: new THREE.Color(color),\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tmap: texture,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.9,\r\n\t\t});\r\n\t\tconst mesh = this.mesh = new THREE.Mesh(geometry, material);\r\n\t\tmesh.renderOrder = environment.renderOrder.pointer;\r\n\t\tmesh.position.set(-100000, -100000, -100000);\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tif (Interactive.lastIntersectedObject) {\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tconst position = Interactive.lastIntersectedObject.intersection.point.multiplyScalar(0.99);\r\n\t\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t\tconst s = mesh.position.length() / 80;\r\n\t\t\tmesh.scale.set(s, s, s);\r\n\t\t\tmesh.lookAt(ORIGIN);\r\n\t\t}\r\n\t}\r\n\r\n\tsetPosition(x, y, z) {\r\n\t\tconst mesh = this.mesh;\r\n\t\tmesh.position.set(x, y, z).multiplyScalar(80);\r\n\t\tconst s = mesh.position.length() / 80;\r\n\t\tmesh.scale.set(s, s, s);\r\n\t\tmesh.lookAt(ORIGIN);\r\n\t\t// console.log('PointerElement.setPosition', x, y, z);\r\n\t}\r\n}\r\n","import Emittable from '../interactive/emittable';\r\n\r\nexport class Gamepad extends Emittable {\r\n\tconstructor(gamepad) {\r\n\t\tsuper();\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.buttons = {};\r\n\t\tthis.axes = {};\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tthis.updateButtons();\r\n\t\tthis.updateAxes();\r\n\t}\r\n\r\n\tupdateButtons() {\r\n\t\tthis.gamepad.buttons.forEach((x, i) => {\r\n\t\t\tconst pressed = x.pressed;\r\n\t\t\tconst button = this.buttons[i] || (this.buttons[i] = new GamepadButton(i, this));\r\n\t\t\tif (button.pressed !== pressed) {\r\n\t\t\t\tbutton.pressed = pressed;\r\n\t\t\t\tif (pressed) {\r\n\t\t\t\t\tthis.emit('press', button);\r\n\t\t\t\t} else if (status !== undefined) {\r\n\t\t\t\t\tthis.emit('release', button);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tupdateAxes() {\r\n\t\tconst axes = this.gamepad.axes;\r\n\t\tfor (let i = 0; i < axes.length; i += 2) {\r\n\t\t\tconst index = Math.floor(i / 2);\r\n\t\t\tconst axis = this.axes[index] || (this.axes[index] = new GamepadAxis(index, this));\r\n\t\t\tconst x = axes[i];\r\n\t\t\tconst y = axes[i + 1];\r\n\t\t\tif (axis.x !== x || axis.y !== y) {\r\n\t\t\t\taxis.x = x;\r\n\t\t\t\taxis.y = y;\r\n\t\t\t\tif (Math.abs(x) > Math.abs(y)) {\r\n\t\t\t\t\tconst left = x < -0.85;\r\n\t\t\t\t\tconst right = x > 0.85;\r\n\t\t\t\t\tif (axis.left !== left) {\r\n\t\t\t\t\t\taxis.left = left;\r\n\t\t\t\t\t\tthis.emit((left ? 'left' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} left ${left}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (axis.right !== right) {\r\n\t\t\t\t\t\taxis.right = right;\r\n\t\t\t\t\t\tthis.emit((right ? 'right' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} right ${right}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst up = y < -0.85;\r\n\t\t\t\t\tconst down = y > 0.85;\r\n\t\t\t\t\tif (axis.up !== up) {\r\n\t\t\t\t\t\taxis.up = up;\r\n\t\t\t\t\t\tthis.emit((up ? 'up' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} up ${up}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (axis.down !== down) {\r\n\t\t\t\t\t\taxis.down = down;\r\n\t\t\t\t\t\tthis.emit((down ? 'down' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} down ${down}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.emit('axis', axis);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfeedback(strength = 0.1, duration = 50) {\r\n\t\t// !!! care for battery\r\n\t\tconst actuators = this.gamepad.hapticActuators;\r\n\t\tif (actuators && actuators.length) {\r\n\t\t\treturn actuators[0].pulse(strength, duration);\r\n\t\t} else {\r\n\t\t\treturn Promise.reject();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass GamepadButton {\r\n\tconstructor(index, gamepad) {\r\n\t\tthis.index = index;\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.pressed = false;\r\n\t}\r\n}\r\n\r\nclass GamepadAxis extends THREE.Vector2 {\r\n\tconstructor(index, gamepad) {\r\n\t\tsuper();\r\n\t\tthis.index = index;\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.left = this.right = this.up = this.down = false;\r\n\t}\r\n}\r\n","export default class Emittable {\r\n\r\n\tconstructor() {\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","/**\r\n * @webxr-input-profiles/motion-controllers 1.0.0 https://github.com/immersive-web/webxr-input-profiles\r\n */\r\n\r\nconst Constants = {\r\n  Handedness: Object.freeze({\r\n    NONE: 'none',\r\n    LEFT: 'left',\r\n    RIGHT: 'right'\r\n  }),\r\n\r\n  ComponentState: Object.freeze({\r\n    DEFAULT: 'default',\r\n    TOUCHED: 'touched',\r\n    PRESSED: 'pressed'\r\n  }),\r\n\r\n  ComponentProperty: Object.freeze({\r\n    BUTTON: 'button',\r\n    X_AXIS: 'xAxis',\r\n    Y_AXIS: 'yAxis',\r\n    STATE: 'state'\r\n  }),\r\n\r\n  ComponentType: Object.freeze({\r\n    TRIGGER: 'trigger',\r\n    SQUEEZE: 'squeeze',\r\n    TOUCHPAD: 'touchpad',\r\n    THUMBSTICK: 'thumbstick',\r\n    BUTTON: 'button'\r\n  }),\r\n\r\n  ButtonTouchThreshold: 0.05,\r\n\r\n  AxisTouchThreshold: 0.1,\r\n\r\n  VisualResponseProperty: Object.freeze({\r\n    TRANSFORM: 'transform',\r\n    VISIBILITY: 'visibility'\r\n  })\r\n};\r\n\r\n/**\r\n * @description Static helper function to fetch a JSON file and turn it into a JS object\r\n * @param {string} path - Path to JSON file to be fetched\r\n */\r\nasync function fetchJsonFile(path) {\r\n  const response = await fetch(path);\r\n  if (!response.ok) {\r\n    throw new Error(response.statusText);\r\n  } else {\r\n    return response.json();\r\n  }\r\n}\r\n\r\nasync function fetchProfilesList(basePath) {\r\n  if (!basePath) {\r\n    throw new Error('No basePath supplied');\r\n  }\r\n\r\n  const profileListFileName = 'profilesList.json';\r\n  const profilesList = await fetchJsonFile(`${basePath}/${profileListFileName}`);\r\n  return profilesList;\r\n}\r\n\r\nasync function fetchProfile(xrInputSource, basePath, defaultProfile = null, getAssetPath = true) {\r\n  if (!xrInputSource) {\r\n    throw new Error('No xrInputSource supplied');\r\n  }\r\n\r\n  if (!basePath) {\r\n    throw new Error('No basePath supplied');\r\n  }\r\n\r\n  // Get the list of profiles\r\n  const supportedProfilesList = await fetchProfilesList(basePath);\r\n\r\n  // Find the relative path to the first requested profile that is recognized\r\n  let match;\r\n  xrInputSource.profiles.some((profileId) => {\r\n    const supportedProfile = supportedProfilesList[profileId];\r\n    if (supportedProfile) {\r\n      match = {\r\n        profileId,\r\n        profilePath: `${basePath}/${supportedProfile.path}`,\r\n        deprecated: !!supportedProfile.deprecated\r\n      };\r\n    }\r\n    return !!match;\r\n  });\r\n\r\n  if (!match) {\r\n    if (!defaultProfile) {\r\n      throw new Error('No matching profile name found');\r\n    }\r\n\r\n    const supportedProfile = supportedProfilesList[defaultProfile];\r\n    if (!supportedProfile) {\r\n      throw new Error(`No matching profile name found and default profile \"${defaultProfile}\" missing.`);\r\n    }\r\n\r\n    match = {\r\n      profileId: defaultProfile,\r\n      profilePath: `${basePath}/${supportedProfile.path}`,\r\n      deprecated: !!supportedProfile.deprecated\r\n    };\r\n  }\r\n\r\n  const profile = await fetchJsonFile(match.profilePath);\r\n\r\n  let assetPath;\r\n  if (getAssetPath) {\r\n    let layout;\r\n    if (xrInputSource.handedness === 'any') {\r\n      layout = profile.layouts[Object.keys(profile.layouts)[0]];\r\n    } else {\r\n      layout = profile.layouts[xrInputSource.handedness];\r\n    }\r\n    if (!layout) {\r\n      throw new Error(\r\n        `No matching handedness, ${xrInputSource.handedness}, in profile ${match.profileId}`\r\n      );\r\n    }\r\n\r\n    if (layout.assetPath) {\r\n      assetPath = match.profilePath.replace('profile.json', layout.assetPath);\r\n    }\r\n  }\r\n\r\n  return { profile, assetPath };\r\n}\r\n\r\n/** @constant {Object} */\r\nconst defaultComponentValues = {\r\n  xAxis: 0,\r\n  yAxis: 0,\r\n  button: 0,\r\n  state: Constants.ComponentState.DEFAULT\r\n};\r\n\r\n/**\r\n * @description Converts an X, Y coordinate from the range -1 to 1 (as reported by the Gamepad\r\n * API) to the range 0 to 1 (for interpolation). Also caps the X, Y values to be bounded within\r\n * a circle. This ensures that thumbsticks are not animated outside the bounds of their physical\r\n * range of motion and touchpads do not report touch locations off their physical bounds.\r\n * @param {number} x The original x coordinate in the range -1 to 1\r\n * @param {number} y The original y coordinate in the range -1 to 1\r\n */\r\nfunction normalizeAxes(x = 0, y = 0) {\r\n  let xAxis = x;\r\n  let yAxis = y;\r\n\r\n  // Determine if the point is outside the bounds of the circle\r\n  // and, if so, place it on the edge of the circle\r\n  const hypotenuse = Math.sqrt((x * x) + (y * y));\r\n  if (hypotenuse > 1) {\r\n    const theta = Math.atan2(y, x);\r\n    xAxis = Math.cos(theta);\r\n    yAxis = Math.sin(theta);\r\n  }\r\n\r\n  // Scale and move the circle so values are in the interpolation range.  The circle's origin moves\r\n  // from (0, 0) to (0.5, 0.5). The circle's radius scales from 1 to be 0.5.\r\n  const result = {\r\n    normalizedXAxis: (xAxis * 0.5) + 0.5,\r\n    normalizedYAxis: (yAxis * 0.5) + 0.5\r\n  };\r\n  return result;\r\n}\r\n\r\n/**\r\n * Contains the description of how the 3D model should visually respond to a specific user input.\r\n * This is accomplished by initializing the object with the name of a node in the 3D model and\r\n * property that need to be modified in response to user input, the name of the nodes representing\r\n * the allowable range of motion, and the name of the input which triggers the change. In response\r\n * to the named input changing, this object computes the appropriate weighting to use for\r\n * interpolating between the range of motion nodes.\r\n */\r\nclass VisualResponse {\r\n  constructor(visualResponseDescription) {\r\n    this.componentProperty = visualResponseDescription.componentProperty;\r\n    this.states = visualResponseDescription.states;\r\n    this.valueNodeName = visualResponseDescription.valueNodeName;\r\n    this.valueNodeProperty = visualResponseDescription.valueNodeProperty;\r\n\r\n    if (this.valueNodeProperty === Constants.VisualResponseProperty.TRANSFORM) {\r\n      this.minNodeName = visualResponseDescription.minNodeName;\r\n      this.maxNodeName = visualResponseDescription.maxNodeName;\r\n    }\r\n\r\n    // Initializes the response's current value based on default data\r\n    this.value = 0;\r\n    this.updateFromComponent(defaultComponentValues);\r\n  }\r\n\r\n  /**\r\n   * Computes the visual response's interpolation weight based on component state\r\n   * @param {Object} componentValues - The component from which to update\r\n   * @param {number} xAxis - The reported X axis value of the component\r\n   * @param {number} yAxis - The reported Y axis value of the component\r\n   * @param {number} button - The reported value of the component's button\r\n   * @param {string} state - The component's active state\r\n   */\r\n  updateFromComponent({\r\n    xAxis, yAxis, button, state\r\n  }) {\r\n    const { normalizedXAxis, normalizedYAxis } = normalizeAxes(xAxis, yAxis);\r\n    switch (this.componentProperty) {\r\n      case Constants.ComponentProperty.X_AXIS:\r\n        this.value = (this.states.includes(state)) ? normalizedXAxis : 0.5;\r\n        break;\r\n      case Constants.ComponentProperty.Y_AXIS:\r\n        this.value = (this.states.includes(state)) ? normalizedYAxis : 0.5;\r\n        break;\r\n      case Constants.ComponentProperty.BUTTON:\r\n        this.value = (this.states.includes(state)) ? button : 0;\r\n        break;\r\n      case Constants.ComponentProperty.STATE:\r\n        if (this.valueNodeProperty === Constants.VisualResponseProperty.VISIBILITY) {\r\n          this.value = (this.states.includes(state));\r\n        } else {\r\n          this.value = this.states.includes(state) ? 1.0 : 0.0;\r\n        }\r\n        break;\r\n      default:\r\n        throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`);\r\n    }\r\n  }\r\n}\r\n\r\nclass Component {\r\n  /**\r\n   * @param {Object} componentId - Id of the component\r\n   * @param {Object} componentDescription - Description of the component to be created\r\n   */\r\n  constructor(componentId, componentDescription) {\r\n    if (!componentId\r\n     || !componentDescription\r\n     || !componentDescription.visualResponses\r\n     || !componentDescription.gamepadIndices\r\n     || Object.keys(componentDescription.gamepadIndices).length === 0) {\r\n      throw new Error('Invalid arguments supplied');\r\n    }\r\n\r\n    this.id = componentId;\r\n    this.type = componentDescription.type;\r\n    this.rootNodeName = componentDescription.rootNodeName;\r\n    this.touchPointNodeName = componentDescription.touchPointNodeName;\r\n\r\n    // Build all the visual responses for this component\r\n    this.visualResponses = {};\r\n    Object.keys(componentDescription.visualResponses).forEach((responseName) => {\r\n      const visualResponse = new VisualResponse(componentDescription.visualResponses[responseName]);\r\n      this.visualResponses[responseName] = visualResponse;\r\n    });\r\n\r\n    // Set default values\r\n    this.gamepadIndices = Object.assign({}, componentDescription.gamepadIndices);\r\n\r\n    this.values = {\r\n      state: Constants.ComponentState.DEFAULT,\r\n      button: (this.gamepadIndices.button !== undefined) ? 0 : undefined,\r\n      xAxis: (this.gamepadIndices.xAxis !== undefined) ? 0 : undefined,\r\n      yAxis: (this.gamepadIndices.yAxis !== undefined) ? 0 : undefined\r\n    };\r\n  }\r\n\r\n  get data() {\r\n    const data = { id: this.id, ...this.values };\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @description Poll for updated data based on current gamepad state\r\n   * @param {Object} gamepad - The gamepad object from which the component data should be polled\r\n   */\r\n  updateFromGamepad(gamepad) {\r\n    // Set the state to default before processing other data sources\r\n    this.values.state = Constants.ComponentState.DEFAULT;\r\n\r\n    // Get and normalize button\r\n    if (this.gamepadIndices.button !== undefined\r\n        && gamepad.buttons.length > this.gamepadIndices.button) {\r\n      const gamepadButton = gamepad.buttons[this.gamepadIndices.button];\r\n      this.values.button = gamepadButton.value;\r\n      this.values.button = (this.values.button < 0) ? 0 : this.values.button;\r\n      this.values.button = (this.values.button > 1) ? 1 : this.values.button;\r\n\r\n      // Set the state based on the button\r\n      if (gamepadButton.pressed || this.values.button === 1) {\r\n        this.values.state = Constants.ComponentState.PRESSED;\r\n      } else if (gamepadButton.touched || this.values.button > Constants.ButtonTouchThreshold) {\r\n        this.values.state = Constants.ComponentState.TOUCHED;\r\n      }\r\n    }\r\n\r\n    // Get and normalize x axis value\r\n    if (this.gamepadIndices.xAxis !== undefined\r\n        && gamepad.axes.length > this.gamepadIndices.xAxis) {\r\n      this.values.xAxis = gamepad.axes[this.gamepadIndices.xAxis];\r\n      this.values.xAxis = (this.values.xAxis < -1) ? -1 : this.values.xAxis;\r\n      this.values.xAxis = (this.values.xAxis > 1) ? 1 : this.values.xAxis;\r\n\r\n      // If the state is still default, check if the xAxis makes it touched\r\n      if (this.values.state === Constants.ComponentState.DEFAULT\r\n        && Math.abs(this.values.xAxis) > Constants.AxisTouchThreshold) {\r\n        this.values.state = Constants.ComponentState.TOUCHED;\r\n      }\r\n    }\r\n\r\n    // Get and normalize Y axis value\r\n    if (this.gamepadIndices.yAxis !== undefined\r\n        && gamepad.axes.length > this.gamepadIndices.yAxis) {\r\n      this.values.yAxis = gamepad.axes[this.gamepadIndices.yAxis];\r\n      this.values.yAxis = (this.values.yAxis < -1) ? -1 : this.values.yAxis;\r\n      this.values.yAxis = (this.values.yAxis > 1) ? 1 : this.values.yAxis;\r\n\r\n      // If the state is still default, check if the yAxis makes it touched\r\n      if (this.values.state === Constants.ComponentState.DEFAULT\r\n        && Math.abs(this.values.yAxis) > Constants.AxisTouchThreshold) {\r\n        this.values.state = Constants.ComponentState.TOUCHED;\r\n      }\r\n    }\r\n\r\n    // Update the visual response weights based on the current component data\r\n    Object.values(this.visualResponses).forEach((visualResponse) => {\r\n      visualResponse.updateFromComponent(this.values);\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n  * @description Builds a motion controller with components and visual responses based on the\r\n  * supplied profile description. Data is polled from the xrInputSource's gamepad.\r\n  * @author Nell Waliczek / https://github.com/NellWaliczek\r\n*/\r\nclass MotionController {\r\n  /**\r\n   * @param {Object} xrInputSource - The XRInputSource to build the MotionController around\r\n   * @param {Object} profile - The best matched profile description for the supplied xrInputSource\r\n   * @param {Object} assetUrl\r\n   */\r\n  constructor(xrInputSource, profile, assetUrl) {\r\n    if (!xrInputSource) {\r\n      throw new Error('No xrInputSource supplied');\r\n    }\r\n\r\n    if (!profile) {\r\n      throw new Error('No profile supplied');\r\n    }\r\n\r\n    this.xrInputSource = xrInputSource;\r\n    this.assetUrl = assetUrl;\r\n    this.id = profile.profileId;\r\n\r\n    // Build child components as described in the profile description\r\n    this.layoutDescription = profile.layouts[xrInputSource.handedness];\r\n    this.components = {};\r\n    Object.keys(this.layoutDescription.components).forEach((componentId) => {\r\n      const componentDescription = this.layoutDescription.components[componentId];\r\n      this.components[componentId] = new Component(componentId, componentDescription);\r\n    });\r\n\r\n    // Initialize components based on current gamepad state\r\n    this.updateFromGamepad();\r\n  }\r\n\r\n  get gripSpace() {\r\n    return this.xrInputSource.gripSpace;\r\n  }\r\n\r\n  get targetRaySpace() {\r\n    return this.xrInputSource.targetRaySpace;\r\n  }\r\n\r\n  /**\r\n   * @description Returns a subset of component data for simplified debugging\r\n   */\r\n  get data() {\r\n    const data = [];\r\n    Object.values(this.components).forEach((component) => {\r\n      data.push(component.data);\r\n    });\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @description Poll for updated data based on current gamepad state\r\n   */\r\n  updateFromGamepad() {\r\n    Object.values(this.components).forEach((component) => {\r\n      component.updateFromGamepad(this.xrInputSource.gamepad);\r\n    });\r\n  }\r\n}\r\n\r\nexport { Constants, MotionController, fetchProfile, fetchProfilesList };\r\n","\r\n// import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\n\r\nimport { Constants as MotionControllerConstants, fetchProfile, MotionController } from './motion-controllers.module.js';\r\n\r\nconst DEFAULT_PROFILES_PATH = 'https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles';\r\nconst DEFAULT_PROFILE = 'generic-trigger';\r\n\r\nfunction XRControllerModel() {\r\n\tTHREE.Object3D.call(this);\r\n\tthis.motionController = null;\r\n\tthis.envMap = null;\r\n}\r\n\r\nXRControllerModel.prototype = Object.assign(Object.create(THREE.Object3D.prototype), {\r\n\r\n\tconstructor: XRControllerModel,\r\n\r\n\tsetEnvironmentMap: function(envMap) {\r\n\r\n\t\tif (this.envMap == envMap) {\r\n\r\n\t\t\treturn this;\r\n\r\n\t\t}\r\n\r\n\t\tthis.envMap = envMap;\r\n\t\tthis.traverse((child) => {\r\n\r\n\t\t\tif (child.isMesh) {\r\n\r\n\t\t\t\tchild.material.envMap = this.envMap;\r\n\t\t\t\tchild.material.needsUpdate = true;\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t\treturn this;\r\n\r\n\t},\r\n\r\n\t/**\r\n\t * Polls data from the XRInputSource and updates the model's components to match\r\n\t * the real world data\r\n\t */\r\n\tupdateMatrixWorld: function(force) {\r\n\r\n\t\tTHREE.Object3D.prototype.updateMatrixWorld.call(this, force);\r\n\r\n\t\tif (!this.motionController) return;\r\n\r\n\t\t// Cause the MotionController to poll the Gamepad for data\r\n\t\tthis.motionController.updateFromGamepad();\r\n\r\n\t\t// Update the 3D model to reflect the button, thumbstick, and touchpad state\r\n\t\tObject.values(this.motionController.components).forEach((component) => {\r\n\r\n\t\t\t// Update node data based on the visual responses' current states\r\n\t\t\tObject.values(component.visualResponses).forEach((visualResponse) => {\r\n\r\n\t\t\t\tconst { valueNode, minNode, maxNode, value, valueNodeProperty } = visualResponse;\r\n\r\n\t\t\t\t// Skip if the visual response node is not found. No error is needed,\r\n\t\t\t\t// because it will have been reported at load time.\r\n\t\t\t\tif (!valueNode) return;\r\n\r\n\t\t\t\t// Calculate the new properties based on the weight supplied\r\n\t\t\t\tif (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.VISIBILITY) {\r\n\r\n\t\t\t\t\tvalueNode.visible = value;\r\n\r\n\t\t\t\t} else if (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.TRANSFORM) {\r\n\r\n\t\t\t\t\tTHREE.Quaternion.slerp(\r\n\t\t\t\t\t\tminNode.quaternion,\r\n\t\t\t\t\t\tmaxNode.quaternion,\r\n\t\t\t\t\t\tvalueNode.quaternion,\r\n\t\t\t\t\t\tvalue\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tvalueNode.position.lerpVectors(\r\n\t\t\t\t\t\tminNode.position,\r\n\t\t\t\t\t\tmaxNode.position,\r\n\t\t\t\t\t\tvalue\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n});\r\n\r\n/**\r\n * Walks the model's tree to find the nodes needed to animate the components and\r\n * saves them to the motionContoller components for use in the frame loop. When\r\n * touchpads are found, attaches a touch dot to them.\r\n */\r\nfunction findNodes(motionController, scene) {\r\n\r\n\t// Loop through the components and find the nodes needed for each components' visual responses\r\n\tObject.values(motionController.components).forEach((component) => {\r\n\r\n\t\tconst { type, touchPointNodeName, visualResponses } = component;\r\n\r\n\t\tif (type === MotionControllerConstants.ComponentType.TOUCHPAD) {\r\n\r\n\t\t\tcomponent.touchPointNode = scene.getObjectByName(touchPointNodeName);\r\n\t\t\tif (component.touchPointNode) {\r\n\r\n\t\t\t\t// Attach a touch dot to the touchpad.\r\n\t\t\t\tconst sphereGeometry = new THREE.SphereBufferGeometry(0.001);\r\n\t\t\t\tconst material = new THREE.MeshBasicMaterial({ color: 0x0000FF });\r\n\t\t\t\tconst sphere = new THREE.Mesh(sphereGeometry, material);\r\n\t\t\t\tcomponent.touchPointNode.add(sphere);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tconsole.warn(`Could not find touch dot, ${component.touchPointNodeName}, in touchpad component ${component.id}`);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t// Loop through all the visual responses to be applied to this component\r\n\t\tObject.values(visualResponses).forEach((visualResponse) => {\r\n\r\n\t\t\tconst { valueNodeName, minNodeName, maxNodeName, valueNodeProperty } = visualResponse;\r\n\r\n\t\t\t// If animating a transform, find the two nodes to be interpolated between.\r\n\t\t\tif (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.TRANSFORM) {\r\n\r\n\t\t\t\tvisualResponse.minNode = scene.getObjectByName(minNodeName);\r\n\t\t\t\tvisualResponse.maxNode = scene.getObjectByName(maxNodeName);\r\n\r\n\t\t\t\t// If the extents cannot be found, skip this animation\r\n\t\t\t\tif (!visualResponse.minNode) {\r\n\r\n\t\t\t\t\tconsole.warn(`Could not find ${minNodeName} in the model`);\r\n\t\t\t\t\treturn;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!visualResponse.maxNode) {\r\n\r\n\t\t\t\t\tconsole.warn(`Could not find ${maxNodeName} in the model`);\r\n\t\t\t\t\treturn;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// If the target node cannot be found, skip this animation\r\n\t\t\tvisualResponse.valueNode = scene.getObjectByName(valueNodeName);\r\n\t\t\tif (!visualResponse.valueNode) {\r\n\r\n\t\t\t\tconsole.warn(`Could not find ${valueNodeName} in the model`);\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction addAssetSceneToControllerModel(controllerModel, scene) {\r\n\r\n\t// Find the nodes needed for animation and cache them on the motionController.\r\n\tfindNodes(controllerModel.motionController, scene);\r\n\r\n\t// Apply any environment map that the mesh already has set.\r\n\tif (controllerModel.envMap) {\r\n\r\n\t\tscene.traverse((child) => {\r\n\r\n\t\t\tif (child.isMesh) {\r\n\r\n\t\t\t\tchild.material.envMap = controllerModel.envMap;\r\n\t\t\t\tchild.material.needsUpdate = true;\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n\t// Add the glTF scene to the controllerModel.\r\n\tcontrollerModel.add(scene);\r\n\r\n}\r\n\r\nvar XRControllerModelFactory = (function() {\r\n\r\n\tfunction XRControllerModelFactory(gltfLoader = null) {\r\n\r\n\t\tthis.gltfLoader = gltfLoader;\r\n\t\tthis.path = DEFAULT_PROFILES_PATH;\r\n\t\tthis._assetCache = {};\r\n\r\n\t\t// If a GLTFLoader wasn't supplied to the constructor create a new one.\r\n\t\tif (!this.gltfLoader) {\r\n\t\t\tthis.gltfLoader = new THREE.GLTFLoader();\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tXRControllerModelFactory.prototype = {\r\n\r\n\t\tconstructor: XRControllerModelFactory,\r\n\r\n\t\tcreateControllerModel: function(controller) {\r\n\r\n\t\t\tconst controllerModel = new XRControllerModel();\r\n\t\t\tlet scene = null;\r\n\r\n\t\t\tcontroller.addEventListener('connected', (event) => {\r\n\r\n\t\t\t\tconst xrInputSource = event.data;\r\n\r\n\t\t\t\tif (xrInputSource.targetRayMode !== 'tracked-pointer' || !xrInputSource.gamepad) return;\r\n\r\n\t\t\t\tfetchProfile(xrInputSource, this.path, DEFAULT_PROFILE).then(({ profile, assetPath }) => {\r\n\r\n\t\t\t\t\tcontrollerModel.motionController = new MotionController(\r\n\t\t\t\t\t\txrInputSource,\r\n\t\t\t\t\t\tprofile,\r\n\t\t\t\t\t\tassetPath\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tlet cachedAsset = this._assetCache[controllerModel.motionController.assetUrl];\r\n\t\t\t\t\tif (cachedAsset) {\r\n\r\n\t\t\t\t\t\tscene = cachedAsset.scene.clone();\r\n\r\n\t\t\t\t\t\taddAssetSceneToControllerModel(controllerModel, scene);\r\n\r\n\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\tif (!this.gltfLoader) {\r\n\r\n\t\t\t\t\t\t\tthrow new Error(`GLTFLoader not set.`);\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tthis.gltfLoader.setPath('');\r\n\t\t\t\t\t\tthis.gltfLoader.load(controllerModel.motionController.assetUrl, (asset) => {\r\n\r\n\t\t\t\t\t\t\tthis._assetCache[controllerModel.motionController.assetUrl] = asset;\r\n\r\n\t\t\t\t\t\t\tscene = asset.scene.clone();\r\n\r\n\t\t\t\t\t\t\taddAssetSceneToControllerModel(controllerModel, scene);\r\n\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tnull,\r\n\t\t\t\t\t\t\t() => {\r\n\r\n\t\t\t\t\t\t\t\tthrow new Error(`Asset ${controllerModel.motionController.assetUrl} missing or malformed.`);\r\n\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}).catch((err) => {\r\n\r\n\t\t\t\t\tconsole.warn(err);\r\n\r\n\t\t\t\t});\r\n\r\n\t\t\t});\r\n\r\n\t\t\tcontroller.addEventListener('disconnected', () => {\r\n\r\n\t\t\t\tcontrollerModel.motionController = null;\r\n\t\t\t\tcontrollerModel.remove(scene);\r\n\t\t\t\tscene = null;\r\n\r\n\t\t\t});\r\n\r\n\t\t\treturn controllerModel;\r\n\r\n\t\t}\r\n\r\n\t};\r\n\r\n\treturn XRControllerModelFactory;\r\n\r\n})();\r\n\r\nexport { XRControllerModelFactory };\r\n\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { ReplaySubject } from 'rxjs';\r\nimport { auditTime, filter, shareReplay, takeUntil, tap } from 'rxjs/operators';\r\nimport { MessageType } from '../agora/agora.types';\r\nimport { DEBUG } from '../environment';\r\nimport KeyboardService from '../keyboard/keyboard.service';\r\nimport MessageService from '../message/message.service';\r\nimport { Rect } from '../rect/rect';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\nimport { PanoramaGridView } from '../view/view';\r\nimport ViewService from '../view/view.service';\r\nimport AvatarElement from './avatar/avatar-element';\r\nimport Camera from './camera/camera';\r\n// import DebugService from './debug.service';\r\nimport Interactive from './interactive/interactive';\r\nimport MediaMesh from './media/media-mesh';\r\nimport OrbitService, { OrbitMoveEvent } from './orbit/orbit';\r\nimport Panorama from './panorama/panorama';\r\nimport PhoneElement from './phone/phone.element';\r\nimport PointerElement from './pointer/pointer.element';\r\nimport VRService from './vr.service';\r\nimport { Gamepad } from './webxr/gamepad';\r\nimport { XRControllerModelFactory } from './webxr/xr-controller-model-factory';\r\n\r\nconst ORIGIN = new THREE.Vector3();\r\nconst USE_SHADOW = false;\r\nconst USE_PHONE = true;\r\n\r\nexport default class WorldComponent extends Component {\r\n\r\n\tget error() {\r\n\t\treturn this.error_;\r\n\t}\r\n\tset error(error) {\r\n\t\tif (this.error_ !== error) {\r\n\t\t\tthis.error_ = error;\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\tget view() {\r\n\t\treturn this.view_;\r\n\t}\r\n\tset view(view) {\r\n\t\tif (this.view_ !== view) {\r\n\t\t\tthis.view_ = view;\r\n\t\t\tthis.setView();\r\n\t\t}\r\n\t}\r\n\tget debugging() {\r\n\t\t// return STATIC || DEBUG;\r\n\t\treturn DEBUG;\r\n\t}\r\n\tget locked() {\r\n\t\treturn this.state.locked || this.state.spying;\r\n\t}\r\n\tget lockedOrXR() {\r\n\t\treturn this.locked || this.renderer.xr.isPresenting;\r\n\t}\r\n\r\n\tget showPointer() {\r\n\t\treturn this.pointer.mesh.parent != null;\r\n\t}\r\n\tset showPointer(showPointer) {\r\n\t\tif (this.showPointer !== showPointer) {\r\n\t\t\tshowPointer ? this.scene.add(this.pointer.mesh) : this.scene.remove(this.pointer.mesh);\r\n\t\t\t// console.log('showPointer', showPointer);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t// console.log('WorldComponent.onInit');\r\n\t\tthis.index = 0;\r\n\t\tthis.error_ = null;\r\n\t\tthis.loading = null;\r\n\t\tthis.waiting = null;\r\n\t\tthis.avatars = {};\r\n\t\tthis.createScene();\r\n\t\tthis.setView();\r\n\t\tthis.addListeners();\r\n\t\tthis.animate(); // !!!\r\n\t\tKeyboardService.keys$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(keys => {\r\n\t\t\tthis.keys = keys;\r\n\t\t\t// console.log(keys);\r\n\t\t});\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tif (this.view) {\r\n\t\t\tconst selected = this.view.items.find(item => item.selected);\r\n\t\t\tif (selected && selected.mesh) {\r\n\t\t\t\tif (this.view.type.name !== 'model') {\r\n\t\t\t\t\tthis.orbit.lookAt(selected.mesh);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.removeListeners();\r\n\t\tconst renderer = this.renderer;\r\n\t\trenderer.setAnimationLoop(() => { });\r\n\t}\r\n\r\n\tcreateScene() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.size = { left: 0, top: 0, width: 0, height: 0, aspect: 0 };\r\n\t\tthis.mouse = new THREE.Vector2();\r\n\t\tthis.controllerMatrix_ = new THREE.Matrix4();\r\n\t\tthis.controllerWorldPosition_ = new THREE.Vector3();\r\n\t\tthis.controllerWorldDirection_ = new THREE.Vector3();\r\n\r\n\t\tconst container = this.container = node;\r\n\t\tconst info = this.info = node.querySelector('.world__info');\r\n\r\n\t\tconst worldRect = this.worldRect = Rect.fromNode(container);\r\n\t\tconst cameraRect = this.cameraRect = new Rect();\r\n\r\n\t\t// !!! eliminabile?\r\n\t\tconst cameraGroup = this.cameraGroup = new THREE.Group();\r\n\t\t// new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, ROOM_RADIUS * 2);\r\n\t\t// const camera = this.camera = new THREE.PerspectiveCamera(70, container.offsetWidth / container.offsetHeight, 0.01, 1000);\r\n\t\tconst camera = this.camera = new Camera(70, container.offsetWidth / container.offsetHeight, 0.01, 1000);\r\n\t\t/*\r\n\t\tcamera.position.set(0, 20, 20);\r\n\t\tcamera.lookAt(camera.target);\r\n\t\t*/\r\n\t\tcameraGroup.add(camera);\r\n\t\tcameraGroup.target = new THREE.Vector3();\r\n\r\n\t\tconst orbit = this.orbit = new OrbitService(camera);\r\n\r\n\t\tconst renderer = this.renderer = new THREE.WebGLRenderer({\r\n\t\t\tantialias: true,\r\n\t\t\talpha: false,\r\n\t\t\tpremultipliedAlpha: true,\r\n\t\t\tlogarithmicDepthBuffer: true,\r\n\t\t\t// physicallyCorrectLights: true,\r\n\t\t});\r\n\t\trenderer.setClearColor(0x000000, 1);\r\n\t\trenderer.setPixelRatio(window.devicePixelRatio);\r\n\t\trenderer.setSize(container.offsetWidth, container.offsetHeight);\r\n\t\trenderer.xr.enabled = true;\r\n\t\trenderer.toneMapping = THREE.ACESFilmicToneMapping;\r\n\t\trenderer.toneMappingExposure = 0.8;\r\n\t\trenderer.outputEncoding = THREE.sRGBEncoding;\r\n\t\tif (USE_SHADOW) {\r\n\t\t\trenderer.shadowMap.enabled = true;\r\n\t\t\trenderer.shadowMap.type = THREE.PCFShadowMap; // THREE.PCFSoftShadowMap; // default THREE.PCFShadowMap\r\n\t\t}\r\n\t\tif (container.childElementCount > 0) {\r\n\t\t\tcontainer.insertBefore(renderer.domElement, container.children[0]);\r\n\t\t} else {\r\n\t\t\tcontainer.appendChild(renderer.domElement);\r\n\t\t}\r\n\r\n\t\tconst raycaster = this.raycaster = new THREE.Raycaster();\r\n\t\traycaster.setFromCamera(this.mouse, camera);\r\n\r\n\t\tconst scene = this.scene = new THREE.Scene();\r\n\t\tscene.add(cameraGroup);\r\n\r\n\t\tconst objects = this.objects = new THREE.Group();\r\n\t\tobjects.name = '[objects]';\r\n\t\tscene.add(objects);\r\n\r\n\t\tconst panorama = this.panorama = new Panorama();\r\n\t\tobjects.add(panorama.mesh);\r\n\r\n\t\tconst indicator = this.indicator = new PointerElement();\r\n\r\n\t\tconst pointer = this.pointer = new PointerElement('#ff4332');\r\n\r\n\t\tconst mainLight = new THREE.PointLight(0xffffff);\r\n\t\tmainLight.position.set(-50, 0, -50);\r\n\t\tobjects.add(mainLight);\r\n\r\n\t\tconst light2 = new THREE.DirectionalLight(0xffe699, 1.5);\r\n\t\tlight2.position.set(40, -40, 40);\r\n\t\tlight2.target.position.set(0, 0, 0);\r\n\t\tobjects.add(light2);\r\n\r\n\t\tconst light3 = new THREE.DirectionalLight(0xffe699, 1);\r\n\t\tlight3.position.set(0, 50, 0);\r\n\t\tlight3.target.position.set(0, 0, 0);\r\n\t\tobjects.add(light3);\r\n\r\n\t\tconst light = new THREE.AmbientLight(0x101010);\r\n\t\tobjects.add(light);\r\n\r\n\t\tthis.addControllers();\r\n\t\t//\r\n\t\tthis.resize();\r\n\t\t//\r\n\t\t// console.log('WorldComponent.createScene');\r\n\t}\r\n\r\n\taddOffCanvasScene(message) {\r\n\t\tconst avatar = new AvatarElement(message);\r\n\t\tthis.avatars[message.clientId] = avatar;\r\n\t\t// avatar.container.appendChild(avatar.element);\r\n\t}\r\n\r\n\tremoveOffCanvasScene(message) {\r\n\t\tconst avatar = this.avatars[message.clientId];\r\n\t\t/*\r\n\t\tif (avatar && avatar.element.parentNode) {\r\n\t\t\tavatar.element.parentNode.removeChild(avatar.element);\r\n\t\t}\r\n\t\t*/\r\n\t\tdelete this.avatars[message.clientId];\r\n\t}\r\n\r\n\tupdateOffCanvasScene(message) {\r\n\t\tconst avatar = this.avatars[message.clientId];\r\n\t\tif (avatar) {\r\n\t\t\tavatar.update(message);\r\n\t\t}\r\n\t}\r\n\r\n\tsetView() {\r\n\t\tif (!this.panorama) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst view = this.view_;\r\n\t\tif (view) {\r\n\t\t\tif (this.views) {\r\n\t\t\t\tthis.views.forEach(view => delete view.onUpdateAsset);\r\n\t\t\t}\r\n\t\t\tconst message = this.requestInfoResult;\r\n\t\t\tif (message) {\r\n\t\t\t\tif (view instanceof PanoramaGridView && message.gridIndex !== undefined) {\r\n\t\t\t\t\tview.index_ = message.gridIndex;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tview.ready = false;\r\n\t\t\t// this.loading = LOADING_BANNER;\r\n\t\t\t// this.waiting = null;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tthis.panorama.change(view, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t// this.scene.background = envMap;\r\n\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t\tview.ready = true;\r\n\t\t\t\tview.onUpdateAsset = () => {\r\n\t\t\t\t\tthis.onViewAssetDidChange();\r\n\t\t\t\t};\r\n\t\t\t\t// this.waiting = (view && view.type.name === 'waiting-room') ? WAITING_BANNER : null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\t// this.render();\r\n\t\t\t}, (view) => {\r\n\t\t\t\tthis.setViewOrientation(view);\r\n\t\t\t\t// this.loading = null;\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonViewAssetDidChange() {\r\n\t\tif (this.panorama) {\r\n\t\t\tthis.panorama.crossfade(this.view, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tsetViewOrientation(view) {\r\n\t\tconst message = this.requestInfoResult;\r\n\t\tthis.requestInfoResult = null;\r\n\t\tif (this.orbit) {\r\n\t\t\tthis.orbit.mode = view.type.name;\r\n\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\tif (message) {\r\n\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t} else if (!view.keepOrientation) {\r\n\t\t\t\t\tthis.orbit.setOrientation(view.orientation);\r\n\t\t\t\t\tthis.orbit.zoom = view.zoom;\r\n\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddControllers() {\r\n\t\tconst controllerGroup = this.controllerGroup = new THREE.Group();\r\n\t\tthis.controllers = [];\r\n\t\tthis.controllerModelFactory = new XRControllerModelFactory();\r\n\t\tthis.addController(0);\r\n\t\tthis.addController(1);\r\n\t\tthis.cameraGroup.add(controllerGroup);\r\n\t}\r\n\r\n\taddController(index) {\r\n\t\tconst showPhone = USE_PHONE && StateService.state.live;\r\n\t\tconst renderer = this.renderer;\r\n\t\tconst controllerGroup = this.controllerGroup;\r\n\t\tconst controller = renderer.xr.getController(index);\r\n\t\tconst controllerModelFactory = this.controllerModelFactory;\r\n\t\tcontroller.name = `[controller${index + 1}]`;\r\n\t\tcontrollerGroup.add(controller);\r\n\t\tconst setController = (controller) => {\r\n\t\t\t// console.log('setController', this);\r\n\t\t\tthis.controller = controller;\r\n\t\t}\r\n\t\tconst onSelectStart = (event) => {\r\n\t\t\tcontroller.userData.isSelecting = true;\r\n\t\t\tsetController(controller);\r\n\t\t};\r\n\t\tconst onSelectEnd = (event) => {\r\n\t\t\tcontroller.userData.isSelecting = false;\r\n\t\t};\r\n\t\t// const debugService = DebugService.getService();\r\n\t\t// debugService.setMessage('DebugService 1001');\r\n\t\tconst onPress = (event) => {\r\n\t\t\t// console.log('Gamepad.onPress', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onPress ' + event.index);\r\n\t\t\t// 0: select\r\n\t\t\t// 1: squeeze\r\n\t\t\t// 4: x / a\r\n\t\t\t// 5: y / b\r\n\t\t\tswitch(event.index) {\r\n\t\t\t\tcase 0:\r\n\t\t\t\t\t// select\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 1:\r\n\t\t\t\t\t// squeeze\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 4:\r\n\t\t\t\t\t// x / a\r\n\t\t\t\t\tMessageService.send({\r\n\t\t\t\t\t\ttype: MessageType.MenuToggle,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t};\r\n\t\tconst onRelease = (event) => {\r\n\t\t\tthis.onModelUp();\r\n\t\t};\r\n\t\tconst onLeft = (event) => {\r\n\t\t\t// console.log('Gamepad.onLeft', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onLeft');\r\n\t\t\tthis.cameraGroup.rotation.y += Math.PI / 180 * 45;\r\n\t\t};\r\n\t\tconst onRight = (event) => {\r\n\t\t\t// console.log('Gamepad.onRight', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onRight');\r\n\t\t\tthis.cameraGroup.rotation.y -= Math.PI / 180 * 45;\r\n\t\t};\r\n\t\t/*\r\n\t\tconst onAxis = (event) => {\r\n\t\t\t// console.log('Gamepad.onAxis', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onAxis');\r\n\t\t\tthis.cameraGroup.rotation.y += (Math.PI / 180 * event.x);\r\n\t\t};\r\n\t\t*/\r\n\t\tconst onAxis = (event) => {\r\n\t\t\t// console.log('Gamepad.onAxis', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onAxis');\r\n\t\t\tthis.onModelDistance(event.y);\r\n\t\t};\r\n\t\t/*\r\n\t\tconst onUp = (event) => {\r\n\t\t\t// console.log('Gamepad.onUp', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onUp');\r\n\t\t\tthis.cameraGroup.position.y += 1;\r\n\t\t};\r\n\t\tconst onDown = (event) => {\r\n\t\t\t// console.log('Gamepad.onDown', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onDown');\r\n\t\t\tthis.cameraGroup.position.y -= 1;\r\n\t\t};\r\n\t\t*/\r\n\t\t/*\r\n\t\tconst onUp = (event) => {\r\n\t\t\tthis.onModelDistance(1);\r\n\t\t};\r\n\t\tconst onDown = (event) => {\r\n\t\t\tthis.onModelDistance(-1);\r\n\t\t};\r\n\t\t*/\r\n\t\tconst onConnected = (event) => {\r\n\t\t\tcontroller.add(this.buildController(event.data));\r\n\t\t\tif (showPhone && event.data.handedness === 'left') {\r\n\t\t\t\tconst phone = this.phone = new PhoneElement();\r\n\t\t\t\tcontroller.add(phone.mesh);\r\n\t\t\t}\r\n\t\t\tif (!showPhone || event.data.handedness === 'right') {\r\n\t\t\t\tconst controllerGrip = renderer.xr.getControllerGrip(index);\r\n\t\t\t\tcontrollerGrip.name = `[controller-grip${index + 1}]`;\r\n\t\t\t\tcontrollerGrip.add(controllerModelFactory.createControllerModel(controllerGrip));\r\n\t\t\t\tcontrollerGroup.add(controllerGrip);\r\n\t\t\t}\r\n\t\t\tconst gamepad = new Gamepad(event.data.gamepad);\r\n\t\t\tgamepad.on('press', onPress);\r\n\t\t\tgamepad.on('release', onRelease);\r\n\t\t\tgamepad.on('left', onLeft);\r\n\t\t\tgamepad.on('right', onRight);\r\n\t\t\tgamepad.on('axis', onAxis);\r\n\t\t\t// gamepad.on('up', onUp);\r\n\t\t\t// gamepad.on('down', onDown);\r\n\t\t\tcontroller.userData.gamepad = gamepad;\r\n\t\t}\r\n\t\tconst onDisconnected = (event) => {\r\n\t\t\twhile (controller.children.length) {\r\n\t\t\t\tcontroller.remove(controller.children[0]);\r\n\t\t\t}\r\n\t\t\tconst controllerGrip = renderer.xr.getControllerGrip(index);\r\n\t\t\twhile (controllerGrip.children.length) {\r\n\t\t\t\tcontrollerGrip.remove(controllerGrip.children[0]);\r\n\t\t\t}\r\n\t\t\tcontrollerGroup.remove(controllerGrip);\r\n\t\t\tconst gamepad = controller.userData.gamepad;\r\n\t\t\tgamepad.off('press', onPress);\r\n\t\t\tgamepad.off('release', onRelease);\r\n\t\t\tgamepad.off('left', onLeft);\r\n\t\t\tgamepad.off('right', onRight);\r\n\t\t\tgamepad.off('axis', onAxis);\r\n\t\t\t// gamepad.off('up', onUp);\r\n\t\t\t// gamepad.off('down', onDown);\r\n\t\t}\r\n\t\tcontroller.addEventListener('selectstart', onSelectStart);\r\n\t\tcontroller.addEventListener('selectend', onSelectEnd);\r\n\t\tcontroller.addEventListener('connected', onConnected);\r\n\t\tcontroller.addEventListener('disconnected', onDisconnected);\r\n\t\tconst controllers = this.controllers;\r\n\t\tcontrollers.push(controller);\r\n\t}\r\n\r\n\tbuildController(data) {\r\n\t\tconsole.log('buildController', data);\r\n\t\tlet geometry, material;\r\n\t\tswitch (data.targetRayMode) {\r\n\t\t\tcase 'tracked-pointer':\r\n\t\t\t\tgeometry = new THREE.BufferGeometry();\r\n\t\t\t\tgeometry.setAttribute('position', new THREE.Float32BufferAttribute([0, 0, 0, 0, 0, -1], 3));\r\n\t\t\t\tgeometry.setAttribute('color', new THREE.Float32BufferAttribute([0.5, 0.5, 0.5, 0, 0, 0], 3));\r\n\t\t\t\tmaterial = new THREE.LineBasicMaterial({\r\n\t\t\t\t\tvertexColors: true,\r\n\t\t\t\t\tblending: THREE.AdditiveBlending\r\n\t\t\t\t});\r\n\t\t\t\treturn new THREE.Line(geometry, material);\r\n\t\t\tcase 'gaze':\r\n\t\t\t\tgeometry = new THREE.RingBufferGeometry(0.02, 0.04, 32).translate(0, 0, -1);\r\n\t\t\t\tmaterial = new THREE.MeshBasicMaterial({\r\n\t\t\t\t\topacity: 0.5,\r\n\t\t\t\t\ttransparent: true\r\n\t\t\t\t});\r\n\t\t\t\treturn new THREE.Mesh(geometry, material);\r\n\t\t}\r\n\t}\r\n\r\n\tonModelDown(event) {\r\n\t\t// vr controller model grab\r\n\t\tconst controller = this.controller;\r\n\t\tif (controller && this.renderer.xr.isPresenting) {\r\n\t\t\tconst target = this.tempTarget = event.mesh;\r\n\t\t\t// console.log('WorldComponent.onModelDown', target);\r\n\t\t\t// DebugService.getService().setMessage('onModelDown ', target.name);\r\n\t\t\tconst parent = this.tempParent = target.parent;\r\n\t\t\tconst position = new THREE.Vector3();\r\n\t\t\ttarget.localToWorld(position);\r\n\t\t\tcontroller.worldToLocal(position);\r\n\t\t\tcontroller.add(target);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t}\r\n\t}\r\n\r\n\tonModelDistance(direction) {\r\n\t\t// vr controller model distance\r\n\t\tconst controller = this.controller;\r\n\t\tconst target = this.tempTarget;\r\n\t\tif (controller && target && this.renderer.xr.isPresenting) {\r\n\t\t\tlet position = new THREE.Vector3();\r\n\t\t\tposition = position.copy(target.position);\r\n\t\t\tconst distance = Math.max(1, Math.min(8, position.distanceTo(ORIGIN) + 0.02 * direction));\r\n\t\t\tposition.normalize();\r\n\t\t\tposition = position.multiplyScalar(distance);\r\n\t\t\t// DebugService.getService().setMessage('onModelDistance ' + distance);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t}\r\n\t}\r\n\r\n\tonModelUp() {\r\n\t\t// vr controller model release\r\n\t\tconst target = this.tempTarget;\r\n\t\tconst parent = this.tempParent;\r\n\t\tif (target && parent) {\r\n\t\t\t// console.log('WorldComponent.onModelUp', target, parent);\r\n\t\t\tconst position = new THREE.Vector3();\r\n\t\t\ttarget.localToWorld(position);\r\n\t\t\tparent.worldToLocal(position);\r\n\t\t\tparent.add(target);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t\tthis.tempTarget = null;\r\n\t\t\tthis.tempParent = null;\r\n\t\t}\r\n\t}\r\n\r\n\tonTween() {\r\n\t\t// this.render();\r\n\t}\r\n\r\n\tupdateRaycasterXR(controller, raycaster) {\r\n\t\tif (controller) {\r\n\t\t\tthis.controllerMatrix_.identity().extractRotation(controller.matrixWorld);\r\n\t\t\traycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);\r\n\t\t\traycaster.ray.direction.set(0, 0, -1).applyMatrix4(this.controllerMatrix_);\r\n\t\t\t// raycaster.camera = this.host.renderer.xr.getCamera(this.camera);\r\n\t\t\treturn raycaster;\r\n\t\t}\r\n\t}\r\n\r\n\traycasterHitTest() {\r\n\t\ttry {\r\n\t\t\tif (this.renderer.xr.isPresenting) {\r\n\t\t\t\tconst raycaster = this.updateRaycasterXR(this.controller, this.raycaster);\r\n\t\t\t\tif (raycaster) {\r\n\t\t\t\t\tconst hit = Interactive.hittest(raycaster, this.controller.userData.isSelecting);\r\n\t\t\t\t\tthis.indicator.update();\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t\t\t// controllers.feedback();\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t} else if (!this.dragItem && !this.resizeItem) {\r\n\t\t\t\treturn; // !!!\r\n\t\t\t\tconst raycaster = this.raycaster;\r\n\t\t\t\tif (raycaster) {\r\n\t\t\t\t\tconst hit = Interactive.hittest(raycaster);\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t\t\t// console.log('hit', hit);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\trepos(object, rect) {\r\n\t\tconst worldRect = this.worldRect;\r\n\t\tconst sx = 0.8;\r\n\t\t// const sx = rect.width / worldRect.width;\r\n\t\t// const sy = rect.height / worldRect.height;\r\n\t\tobject.scale.set(sx, sx, sx);\r\n\t\t// const tx = ((rect.x + rect.width / 2) - worldRect.width / 2) / worldRect.width * 2.0 * this.camera.aspect; // * cameraRect.width / worldRect.width - cameraRect.width / 2;\r\n\t\t// const ty = ((rect.y + rect.height / 2) - worldRect.height / 2) / worldRect.height * 2.0 * this.camera.aspect; // * cameraRect.height / worldRect.height - cameraRect.height / 2;\r\n\t\tconst tx = ((rect.x + rect.width / 2) - worldRect.width / 2) / worldRect.width * 2.0 * this.camera.aspect;\r\n\t\tconst ty = ((rect.y + rect.height / 2) - worldRect.height / 2) / worldRect.height * 2.0 * this.camera.aspect;\r\n\t\t// console.log(tx);\r\n\t\t// const position = new THREE.Vector3(tx, ty, 0).unproject(this.camera);\r\n\t\tobject.position.set(tx, -ty, 0);\r\n\t\t// console.log(tx, -ty, 0);\r\n\t}\r\n\r\n\trender(delta) {\r\n\t\ttry {\r\n\t\t\tconst renderer = this.renderer,\r\n\t\t\t\tscene = this.scene,\r\n\t\t\t\tcamera = this.camera;\r\n\t\t\tconst time = performance.now();\r\n\t\t\tconst tick = this.tick_ ? ++this.tick_ : this.tick_ = 1;\r\n\t\t\tthis.raycasterXRHitTest();\r\n\t\t\tthis.scene.traverse((child) => {\r\n\t\t\t\tif (typeof child.userData.render === 'function') {\r\n\t\t\t\t\tchild.userData.render(time, tick);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.vrService.updateState(this);\r\n\t\t\tObject.keys(this.avatars).forEach(key => {\r\n\t\t\t\tthis.avatars[key].render();\r\n\t\t\t});\r\n\t\t\tif (renderer.xr.isPresenting) {\r\n\t\t\t\tgsap.ticker.tick();\r\n\t\t\t\tthis.controllers.forEach(controller => {\r\n\t\t\t\t\tcontroller.userData.gamepad.update();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\t/*\r\n\t\t\tconst objects = this.objects;\r\n\t\t\tfor (let i = 0; i < objects.children.length; i++) {\r\n\t\t\t\tconst x = objects.children[i];\r\n\t\t\t\tif (typeof x.userData.render === 'function') {\r\n\t\t\t\t\tx.userData.render(time, tick);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\trenderer.render(this.scene, this.camera);\r\n\t\t\tif (this.state && !this.state.hosted) {\r\n\t\t\t\tthis.orbit.render();\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tanimate() {\r\n\t\tconst renderer = this.renderer;\r\n\t\trenderer.setAnimationLoop(this.render);\r\n\t}\r\n\r\n\tresize() {\r\n\t\ttry {\r\n\t\t\tconst container = this.container,\r\n\t\t\t\trenderer = this.renderer,\r\n\t\t\t\tcamera = this.camera;\r\n\t\t\tconst size = this.size;\r\n\t\t\tconst rect = container.getBoundingClientRect();\r\n\t\t\tsize.left = Math.floor(rect.left);\r\n\t\t\tsize.top = Math.floor(rect.top);\r\n\t\t\tsize.width = Math.ceil(rect.width);\r\n\t\t\tsize.height = Math.ceil(rect.height);\r\n\t\t\tsize.aspect = size.width / size.height;\r\n\t\t\tconst worldRect = this.worldRect;\r\n\t\t\tworldRect.setSize(size.width, size.height);\r\n\t\t\tif (!renderer.xr.isPresenting) {\r\n\t\t\t\trenderer.setSize(size.width, size.height);\r\n\t\t\t\tif (camera) {\r\n\t\t\t\t\tcamera.aspect = size.width / size.height;\r\n\t\t\t\t\tconst angle = camera.fov * Math.PI / 180;\r\n\t\t\t\t\tconst height = Math.abs(camera.position.z * Math.tan(angle / 2) * 2);\r\n\t\t\t\t\tconst cameraRect = this.cameraRect;\r\n\t\t\t\t\tcameraRect.width = height * camera.aspect;\r\n\t\t\t\t\tcameraRect.height = height;\r\n\t\t\t\t\t// console.log('position', camera.position.z, 'angle', angle, 'height', height, 'aspect', camera.aspect, cameraRect);\r\n\t\t\t\t\tcamera.updateProjectionMatrix();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// this.render();\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tupdateRaycasterMouse(event) {\r\n\t\tconst w2 = this.size.width / 2;\r\n\t\tconst h2 = this.size.height / 2;\r\n\t\tthis.mouse.x = (event.clientX - this.size.left - w2) / w2;\r\n\t\tthis.mouse.y = -(event.clientY - this.size.top - h2) / h2;\r\n\t\tconst raycaster = this.raycaster;\r\n\t\traycaster.setFromCamera(this.mouse, this.camera);\r\n\t\treturn raycaster;\r\n\t}\r\n\r\n\tonMouseDown(event) {\r\n\t\ttry {\r\n\t\t\tif (event.button !== 0) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\t\tconst hit = Interactive.hittest(raycaster, true);\r\n\t\t\tif (this.editor || DEBUG) {\r\n\t\t\t\tif (this.keys.Shift || this.keys.Control) {\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.select.next({ item: null });\r\n\t\t\t\t\tif (this.panorama.mesh.intersection) {\r\n\t\t\t\t\t\tconst position = new THREE.Vector3().copy(this.panorama.mesh.intersection.point).normalize();\r\n\t\t\t\t\t\tconsole.log(JSON.stringify({ position: position.toArray() }));\r\n\t\t\t\t\t\tthis.viewHit.next(position);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\traycasterXRHitTest() {\r\n\t\tif (this.renderer.xr.isPresenting) {\r\n\t\t\tconst raycaster = this.updateRaycasterXR(this.controller, this.raycaster);\r\n\t\t\tif (raycaster) {\r\n\t\t\t\tconst hit = Interactive.hittest(raycaster, this.controller.userData.isSelecting);\r\n\t\t\t\tthis.indicator.update();\r\n\t\t\t\t/*\r\n\t\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t\t// controllers.feedback();\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\traycasterDesktopHitTest(event) {\r\n\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\tif (this.lockedOrXR) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.dragItem) {\r\n\t\t\tif (typeof this.dragItem.onDragMove === 'function') {\r\n\t\t\t\tconst intersections = raycaster.intersectObjects([this.panorama.mesh]);\r\n\t\t\t\tif (intersections.length) {\r\n\t\t\t\t\tconst intersection = intersections[0];\r\n\t\t\t\t\t// this.panorama.mesh.intersection = intersection;\r\n\t\t\t\t\tconst position = new THREE.Vector3().copy(intersection.point).normalize();\r\n\t\t\t\t\tthis.dragItem.onDragMove(position);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (this.resizeItem) {\r\n\t\t\tif (typeof this.resizeItem.onResizeMove === 'function') {\r\n\t\t\t\t/*\r\n\t\t\t\t// calc arc x & y as scale;\r\n\t\t\t\tconst intersections = raycaster.intersectObjects([this.panorama.mesh]);\r\n\t\t\t\tif (intersections.length) {\r\n\t\t\t\t\tconst intersection = intersections[0];\r\n\t\t\t\t\t// this.panorama.mesh.intersection = intersection;\r\n\t\t\t\t\tconst position = new THREE.Vector3().copy(intersection.point).normalize();\r\n\t\t\t\t\tthis.resizeItem.onResizeMove(position);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconst hit = Interactive.hittest(raycaster);\r\n\t\t\t/*\r\n\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t// console.log('hit', hit);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.controlEvent$.next(this.control);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseMove(event) {\r\n\t\ttry {\r\n\t\t\tthis.raycasterDesktopHitTest(event);\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseUp(event) {\r\n\t\ttry {\r\n\t\t\tif (this.lockedOrXR) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (this.dragItem) {\r\n\t\t\t\tif (typeof this.dragItem.onDragEnd === 'function') {\r\n\t\t\t\t\tthis.dragItem.onDragEnd();\r\n\t\t\t\t\tthis.dragEnd.next(this.dragItem);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.dragItem = null;\r\n\t\t\tif (this.resizeItem) {\r\n\t\t\t\tif (typeof this.resizeItem.onResizeEnd === 'function') {\r\n\t\t\t\t\tthis.resizeItem.onResizeEnd();\r\n\t\t\t\t\tthis.resizeEnd.next(this.resizeItem);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.resizeItem = null;\r\n\t\t\t/*\r\n\t\t\tif (NavPointDragging) {\r\n\t\t\t\tstopDragging\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\t\tconst hit = Interactive.hittest(raycaster, false);\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseWheel(event) {\r\n\t\ttry {\r\n\t\t\tif (this.lockedOrXR) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst deltaY = event.deltaY * (event.wheelDeltaY !== undefined ? 1 : 37);\r\n\t\t\tconst orbit = this.orbit;\r\n\t\t\tgsap.to(orbit, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tzoom: orbit.zoom + deltaY * 0.1,\r\n\t\t\t\tease: Power4.easeOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t});\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonOrientationDidChange() {\r\n\t\tthis.controlEvent$.next(this.control);\r\n\t}\r\n\r\n\tonVRStarted() {\r\n\t\t// this.objects.rotation.y = - Math.PI / 2;\r\n\t\tthis.objects.position.y = 1.3;\r\n\t\tthis.scene.add(this.indicator.mesh);\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VRStarted,\r\n\t\t});\r\n\t}\r\n\r\n\tonVREnded() {\r\n\t\t// this.objects.rotation.y = 0;\r\n\t\tthis.objects.position.y = 0;\r\n\t\tthis.cameraGroup.rotation.y = 0;\r\n\t\tthis.cameraGroup.position.y = 0;\r\n\t\tthis.scene.remove(this.indicator.mesh);\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VREnded,\r\n\t\t});\r\n\t}\r\n\r\n\tonVRStateDidChange(state) {\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VRState,\r\n\t\t\tcamera: state.camera.array,\r\n\t\t});\r\n\t}\r\n\r\n\tonMenuNav(event) {\r\n\t\t// console.log('WorldComponent.onMenuNav', event.id, event);\r\n\t\tthis.menu = undefined;\r\n\t\tthis.navTo.next({ viewId: event.id });\r\n\t}\r\n\r\n\tonMenuToggle(event) {\r\n\t\t// console.log('WorldComponent.onMenuToggle', event.id, event);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.menu = event;\r\n\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonNavOver(nav) {\r\n\t\t// console.log('WorldComponent.onNavOver', nav);\r\n\t\tif (this.menu) {\r\n\t\t\treturn;\r\n\t\t\t// this.menu.removeMenu();\r\n\t\t}\r\n\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\tnav.item.showPanel = nav.shouldShowPanel();\r\n\t\tthis.pushChanges();\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.ShowPanel,\r\n\t\t\titemId: nav.item.showPanel ? nav.item.id : null,\r\n\t\t});\r\n\t}\r\n\r\n\tonNavOut(nav) {\r\n\t\t// console.log('WorldComponent.onNavOut', nav);\r\n\t\t// nav.item.showPanel = false;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonNavDown(event) {\r\n\t\tevent.item.showPanel = false;\r\n\t\t// console.log('WorldComponent.onNavDown', this.keys);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.editor && this.keys.Shift) {\r\n\t\t\tthis.dragItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else if (this.editor && this.keys.Control) {\r\n\t\t\tthis.resizeItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else {\r\n\t\t\tthis.navTo.next(event.item);\r\n\t\t}\r\n\t}\r\n\r\n\tonObjectDown(event) {\r\n\t\t// console.log('WorldComponent.onObjectDown', this.keys);\r\n\t\tif (this.lockedOrXR) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.editor && this.keys.Shift) {\r\n\t\t\tthis.dragItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else if (this.editor && this.keys.Control) {\r\n\t\t\tthis.resizeItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t}\r\n\t}\r\n\r\n\tonPlayMedia(event) {\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.PlayMedia,\r\n\t\t\titemId: event.itemId,\r\n\t\t\tplaying: event.playing,\r\n\t\t});\r\n\t}\r\n\r\n\tonPanelDown(event) {\r\n\t\t// console.log('WorldComponent.onPanelDown', href, target);\r\n\t\tconst href = event.getAttribute('href');\r\n\t\tconst target = event.getAttribute('target') || '_self';\r\n\t\tif (href) {\r\n\t\t\twindow.open(href, '_blank');\r\n\t\t}\r\n\t}\r\n\r\n\tonGridMove(event) {\r\n\t\t// console.log('WorldComponent.onGridMove', event, this.view);\r\n\t\tthis.view.items = [];\r\n\t\t// this.loading = LOADING_BANNER;\r\n\t\tthis.pushChanges();\r\n\t\tthis.orbit.walk(event.position, (headingLongitude, headingLatitude) => {\r\n\t\t\tconst tile = this.view.getTile(event.indices.x, event.indices.y);\r\n\t\t\tif (tile) {\r\n\t\t\t\tthis.panorama.crossfade(tile, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t\t// this.scene.background = envMap;\r\n\t\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t\t\tthis.orbit.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\t\tthis.view.updateCurrentItems();\r\n\t\t\t\t\t// this.loading = null;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t// this.render();\r\n\t\t\t\t\t// this.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonGridNav(event) {\r\n\t\t// console.log('WorldComponent.onGridNav', event);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.NavToGrid,\r\n\t\t\tviewId: this.view.id,\r\n\t\t\tgridIndex: event,\r\n\t\t});\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tcontrol$() {\r\n\t\treturn this.controlEvent$.pipe(\r\n\t\t\tfilter(() => StateService.state.control || StateService.state.spyed || this.editor),\r\n\t\t\tauditTime(40),\r\n\t\t\ttap((control) => {\r\n\t\t\t\tcontrol.orientation.latitude = this.orbit.latitude;\r\n\t\t\t\tcontrol.orientation.longitude = this.orbit.longitude;\r\n\t\t\t\tcontrol.zoom = this.orbit.zoom;\r\n\t\t\t\tconst intersections = this.raycaster.intersectObjects([this.panorama.mesh]);\r\n\t\t\t\tconst point = intersections.length ? intersections[0].point.normalize() : null;\r\n\t\t\t\tif (point) {\r\n\t\t\t\t\tcontrol.pointer[0] = point.x;\r\n\t\t\t\t\tcontrol.pointer[1] = point.y;\r\n\t\t\t\t\tcontrol.pointer[2] = point.z;\r\n\t\t\t\t}\r\n\t\t\t\tMessageService.send(control);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\taddListeners() {\r\n\t\tthis.control = {\r\n\t\t\ttype: MessageType.ControlInfo,\r\n\t\t\torientation: { latitude: 0, longitude: 0 },\r\n\t\t\tzoom: 1,\r\n\t\t\tpointer: [0, 0, 0],\r\n\t\t};\r\n\t\tthis.controlEvent$ = new ReplaySubject(1);\r\n\t\tthis.control$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tthis.renderer.xr.setSession(session);\r\n\t\t\tif (session) {\r\n\t\t\t\tthis.onVRStarted();\r\n\t\t\t} else {\r\n\t\t\t\tthis.onVREnded();\r\n\t\t\t}\r\n\t\t});\r\n\t\tvrService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t).subscribe((state) => {\r\n\t\t\tthis.onVRStateDidChange(state);\r\n\t\t});\r\n\t\tconst orbit$ = this.orbit.observe$(this.container).pipe(\r\n\t\t\tshareReplay(1)\r\n\t\t);\r\n\t\t/*\r\n\t\tconst drag$ = orbit$.pipe(\r\n\t\t\tfilter(event => event instanceof OrbitDragEvent),\r\n\t\t);\r\n\t\t*/\r\n\t\tconst orientation$ = orbit$.pipe(\r\n\t\t\tfilter(event => event instanceof OrbitMoveEvent),\r\n\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t);\r\n\t\torientation$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\t// this.render();\r\n\t\t\tthis.onOrientationDidChange();\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.RequestInfo:\r\n\t\t\t\t\tmessage.type = MessageType.RequestInfoResult;\r\n\t\t\t\t\tmessage.viewId = this.view.id;\r\n\t\t\t\t\tmessage.orientation = this.orbit.getOrientation();\r\n\t\t\t\t\tmessage.zoom = this.orbit.zoom;\r\n\t\t\t\t\tif (this.view instanceof PanoramaGridView) {\r\n\t\t\t\t\t\tmessage.gridIndex = this.view.index;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// console.log('WorldComponent', 'MessageType.RequestInfo', 'from', message.clientId, 'to', StateService.state.uid, message.orientation);\r\n\t\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\t\tif (StateService.state.role !== RoleType.Publisher) {\r\n\t\t\t\t\t\tStateService.patchState({ spyed: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.RequestInfoResult:\r\n\t\t\t\t\t// console.log('WorldComponent', 'MessageType.RequestInfoResult', 'from', message.clientId, 'to', StateService.state.uid, message.orientation);\r\n\t\t\t\t\tif (ViewService.viewId !== message.viewId) {\r\n\t\t\t\t\t\tViewService.viewId = message.viewId;\r\n\t\t\t\t\t\tthis.requestInfoResult = message;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this.view instanceof PanoramaGridView && message.gridIndex) {\r\n\t\t\t\t\t\t\tthis.view.index = message.gridIndex;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (!this.view || !this.view.ready) {\r\n\t\t\t\t\t\t\tthis.requestInfoResult = message;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (this.view && this.view.id === message.viewId) {\r\n\t\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this.view instanceof PanoramaGridView && message.gridIndex) {\r\n\t\t\t\t\t\t\tthis.view.index = message.gridIndex;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.requestInfoResult = message;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t\t// console.log('WorldComponent', 'MessageType.RequestInfoResult', message, StateService.state);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t// !!! old control accepted message\r\n\t\t\t\t/*\r\n\t\t\t\tcase MessageType.RequestControlAccepted:\r\n\t\t\t\t\tmessage = {\r\n\t\t\t\t\t\ttype: MessageType.NavToView,\r\n\t\t\t\t\t\tviewId: this.view.id,\r\n\t\t\t\t\t};\r\n\t\t\t\t\tif (this.view instanceof PanoramaGridView) {\r\n\t\t\t\t\t\tmessage.gridIndex = this.view.index;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tMessageService.send(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t*/\r\n\t\t\t\tcase MessageType.ShowPanel:\r\n\t\t\t\t\tif (this.menu) {\r\n\t\t\t\t\t\tthis.menu.removeMenu();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.view.items.forEach(item => item.showPanel = (item.id === message.itemId));\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.PlayMedia:\r\n\t\t\t\t\tconst item = this.view.items.find(item => item.id === message.itemId);\r\n\t\t\t\t\tif (item && item.mesh instanceof MediaMesh) {\r\n\t\t\t\t\t\titem.mesh.setPlayingState(message.playing);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.NavToGrid:\r\n\t\t\t\t\t// console.log('WorldComponent.NavToGrid', this.view.id, message);\r\n\t\t\t\t\tif (this.view.id === message.viewId) {\r\n\t\t\t\t\t\tthis.view.index = message.gridIndex;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VRStarted:\r\n\t\t\t\t\tthis.addOffCanvasScene(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VREnded:\r\n\t\t\t\t\tthis.removeOffCanvasScene(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VRState:\r\n\t\t\t\t\tthis.updateOffCanvasScene(message);\r\n\t\t\t\t\tif (StateService.state.spying === message.clientId) {\r\n\t\t\t\t\t\tthis.orbit.setVRCamera(message.camera);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ControlInfo:\r\n\t\t\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\t\t// this.camera.updateProjectionMatrix();\r\n\t\t\t\t\t\t// this.render();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.pointer.setPosition(message.pointer[0], message.pointer[1], message.pointer[2]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.showPointer = (StateService.state.locked || StateService.state.spying);\r\n\t\t\t// console.log(state);\r\n\t\t\t// this.pushChanges();\r\n\t\t});\r\n\t\tthis.resize = this.resize.bind(this);\r\n\t\tthis.render = this.render.bind(this);\r\n\t\tthis.onMouseDown = this.onMouseDown.bind(this);\r\n\t\tthis.onMouseMove = this.onMouseMove.bind(this);\r\n\t\tthis.onMouseUp = this.onMouseUp.bind(this);\r\n\t\tthis.onMouseWheel = this.onMouseWheel.bind(this);\r\n\t\t// this.controls.addEventListener('change', this.render); // use if there is no animation loop\r\n\t\twindow.addEventListener('resize', this.resize, false);\r\n\t\tthis.container.addEventListener('wheel', this.onMouseWheel, false);\r\n\t\tthis.container.addEventListener('mousedown', this.onMouseDown, false);\r\n\t\tthis.container.addEventListener('mouseup', this.onMouseUp, false);\r\n\t\tdocument.addEventListener('mousemove', this.onMouseMove, false);\r\n\t}\r\n\r\n\tremoveListeners() {\r\n\t\twindow.removeEventListener('resize', this.resize, false);\r\n\t\twindow.removeEventListener('resize', this.resize, false);\r\n\t\tdocument.removeEventListener('mousemove', this.onMouseMove, false);\r\n\t\tdocument.removeEventListener('wheel', this.onMouseWheel, false);\r\n\t\tthis.container.removeEventListener('mousedown', this.onMouseDown, false);\r\n\t\tthis.container.removeEventListener('mouseup', this.onMouseUp, false);\r\n\t}\r\n}\r\n\r\nWorldComponent.meta = {\r\n\tselector: '[world]',\r\n\tinputs: ['view', 'views', 'editor'],\r\n\toutputs: ['navTo', 'viewHit', 'dragEnd', 'resizeEnd', 'select'],\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport Interactive from '../interactive/interactive';\r\n// import Ease from '../ease/ease';\r\nimport WorldComponent from '../world.component';\r\n\r\nconst deg = THREE.Math.degToRad;\r\n\r\nconst GEOMETRY = new THREE.BoxBufferGeometry(1, 1, 1);\r\n// const GEOMETRY = new THREE.IcosahedronBufferGeometry(0.5, 1);\r\n\r\nexport default class ModelComponent extends Component {\r\n\r\n\tset renderOrder(renderOrder) {\r\n\t\tthis.group.renderOrder = renderOrder;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t// console.log('ModelComponent.onInit');\r\n\t\t// console.log('item', this.item, 'host', this.host);\r\n\t\tif (!this.host) {\r\n\t\t\tthrow ('ModelComponent host is undefined');\r\n\t\t}\r\n\t\tthis.scale = new THREE.Vector3(1.0, 1.0, 1.0);\r\n\t\tthis.position = new THREE.Vector3();\r\n\t\tconst group = this.group = new THREE.Group();\r\n\t\tgroup.name = this.getName();\r\n\t\tgroup.userData.render = (time, tick) => {\r\n\t\t\t// if (this.intersection) {\r\n\t\t\tthis.render(this, time, tick);\r\n\t\t\t// }\r\n\t\t};\r\n\t\tthis.getContainer().add(group);\r\n\t\tthis.onCreate(\r\n\t\t\t(mesh, item) => this.onMount(mesh, item),\r\n\t\t\t(mesh, item) => this.onDismount(mesh, item)\r\n\t\t);\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tconst group = this.group;\r\n\t\tthis.getContainer().remove(group);\r\n\t\tdelete group.userData.render;\r\n\t\tthis.disposeObject(group);\r\n\t\tthis.group = null;\r\n\t}\r\n\r\n\tgetContainer() {\r\n\t\treturn this.host.objects;\r\n\t}\r\n\r\n\tgetName(name) {\r\n\t\treturn `${this.constructor.meta.selector}-${this.rxcompId}${name ? `-${name}` : ''}`;\r\n\t}\r\n\r\n\tonCreate(mounth, dismount) {\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\tcolor: new THREE.Color('#ffcc00'),\r\n\t\t\troughness: 0.4,\r\n\t\t\tmetalness: 0.01,\r\n\t\t\tflatShading: true,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.9,\r\n\t\t});\r\n\t\tconst mesh = new THREE.Mesh(GEOMETRY, material);\r\n\t\tif (typeof mounth === 'function') {\r\n\t\t\tmounth(mesh);\r\n\t\t}\r\n\t\treturn mesh;\r\n\t}\r\n\r\n\tonMount(mesh, item) {\r\n\t\tif (this.mesh) {\r\n\t\t\t// console.log('ModelComponent.dismount.mesh');\r\n\t\t\tthis.onDismount(this.mesh);\r\n\t\t}\r\n\t\tmesh.name = this.getName('mesh');\r\n\t\tthis.mesh = mesh;\r\n\t\tif (item) {\r\n\t\t\titem.mesh = mesh;\r\n\t\t\titem.onUpdate = () => {\r\n\t\t\t\tthis.onUpdate(item, mesh);\r\n\t\t\t};\r\n\t\t\titem.onUpdateAsset = () => {\r\n\t\t\t\tthis.onUpdateAsset(item, mesh);\r\n\t\t\t};\r\n\t\t}\r\n\t\tthis.group.add(mesh);\r\n\t\t// this.host.render(); !!!\r\n\t\t/*\r\n\t\tconst node = this.node;\r\n\t\tDomService.scrollIntersection$(node).subscribe(event => {\r\n\t\t\tthis.scroll = event.scroll;\r\n\t\t\tthis.intersection = event.intersection;\r\n\t\t\tthis.calculateScaleAndPosition();\r\n\t\t});\r\n\t\t*/\r\n\t\t// console.log('Model.loaded', mesh);\r\n\t}\r\n\r\n\tonDismount(mesh, item) {\r\n\t\tthis.group.remove(mesh);\r\n\t\tif (typeof mesh.dispose === 'function') {\r\n\t\t\tmesh.dispose();\r\n\t\t}\r\n\t\tthis.disposeObject(mesh);\r\n\t\tthis.mesh = null;\r\n\t\tif (item) {\r\n\t\t\tdelete item.mesh;\r\n\t\t\tdelete item.onUpdate;\r\n\t\t\tdelete item.onUpdateAsset;\r\n\t\t}\r\n\t}\r\n\r\n\tdisposeObject(object) {\r\n\t\tobject.traverse(child => {\r\n\t\t\tif (child.isInteractiveMesh || child.isInteractiveSprite) {\r\n\t\t\t\tInteractive.dispose(child);\r\n\t\t\t}\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tif (child.material.map && child.material.map.disposable !== false) {\r\n\t\t\t\t\tchild.material.map.dispose();\r\n\t\t\t\t}\r\n\t\t\t\tchild.material.dispose();\r\n\t\t\t\tchild.geometry.dispose();\r\n\t\t\t} else if (child.isSprite) {\r\n\t\t\t\tif (child.material.map && child.material.map.disposable !== false) {\r\n\t\t\t\t\tchild.material.map.dispose();\r\n\t\t\t\t}\r\n\t\t\t\tchild.material.dispose();\r\n\t\t\t}\r\n\t\t});\r\n\t\t// console.log('ModelComponent.disposeObject', object);\r\n\t}\r\n\r\n\tcalculateScaleAndPosition() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.host.repos(this, node.getBoundingClientRect());\r\n\t}\r\n\r\n\trender(time, tick) {\r\n\t\t/*\r\n\t\tthis.calculateScaleAndPosition();\r\n\t\tconst group = this.group;\r\n\t\tconst scale = this.scale;\r\n\t\t// group.scale.set(scale.x, scale.y, scale.z);\r\n\t\tconst position = this.position;\r\n\t\tgroup.position.set(position.x, 0, 0);\r\n\t\t// const tween = this.tween();\r\n\t\t// group.rotation.x = deg(180) * tween;\r\n\t\t// group.rotation.y = deg(360) * tween;\r\n\t\t*/\r\n\t}\r\n\r\n\tgetScroll(offset) {\r\n\t\tconst scroll = this.intersection.scroll(offset);\r\n\t\t// console.log(scroll);\r\n\t\treturn scroll;\r\n\t}\r\n\r\n\tgetTween(offset) {\r\n\t\tlet tween = Math.min(0.0, this.intersection.offset(offset)) + 1;\r\n\t\ttween = Math.max(0.0, tween);\r\n\t\t// tween = Ease.Sine.InOut(tween);\r\n\t\ttween -= 1;\r\n\t\treturn tween;\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) { }\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) { }\r\n\r\n}\r\n\r\nModelComponent.meta = {\r\n\tselector: '[model]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { environment } from '../../environment';\r\nimport { PANORAMA_RADIUS } from '../panorama/panorama';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst PANEL_RADIUS = PANORAMA_RADIUS - 0.01;\r\nconst ORIGIN = new THREE.Vector3();\r\n\r\nexport default class ModelBannerComponent extends ModelComponent {\r\n\r\n\tget title() {\r\n\t\treturn this.title_;\r\n\t}\r\n\tset title(title) {\r\n\t\tif (this.title_ !== title) {\r\n\t\t\tconst init = this.title_ != null;\r\n\t\t\tthis.title_ = title;\r\n\t\t\tif (!init) {\r\n\t\t\t\tthis.createBanner();\r\n\t\t\t} else {\r\n\t\t\t\tthis.updateBanner();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tconsole.log('ModelBannerComponent.onInit', this.item);\r\n\t}\r\n\r\n\tonView() {\r\n\t\tconsole.log('ModelBannerComponent.onView', this.item);\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\t// this.createBanner();\r\n\t}\r\n\t*/\r\n\r\n\tonChanges() {\r\n\t\t// console.log('ModelBannerComponent.onChanges', this.item);\r\n\t\tthis.title = this.item.title;\r\n\t}\r\n\r\n\tcreateBanner() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst texture = result.texture;\r\n\t\t\tconst repeat = 24;\r\n\t\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\t\ttexture.repeat.x = repeat;\r\n\t\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\t\tconst aspect = (result.width * repeat) / result.height;\r\n\t\t\tconst arc = Math.PI / 180 * 360;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / aspect;\r\n\t\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 80, 2, true, 0, arc);\r\n\t\t\tgeometry.scale(-1, 1, 1);\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tmap: texture,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tconst banners = this.banners = new Array(1).fill(0).map(x => new THREE.Mesh(geometry, material));\r\n\t\t\tbanners.forEach((banner, i) => {\r\n\t\t\t\tbanner.rotation.y = Math.PI / 2 * i;\r\n\t\t\t\t// !!!\r\n\t\t\t\t// mesh.add(banner);\r\n\t\t\t});\r\n\t\t\tconst from = { value: 0 };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tvalue: 1,\r\n\t\t\t\tdelay: 0.0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tmesh.userData = {\r\n\t\t\t\trender: () => {\r\n\t\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.02;\r\n\t\t\t\t\t// texture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\r\n\tupdateBanner() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\t// console.log('ModelBannerComponent.updateBanner', result);\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tonViewBak() {\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst texture = result.texture;\r\n\t\t\tconst repeat = 3;\r\n\t\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\t\ttexture.repeat.x = repeat;\r\n\t\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\t\tconst aspect = (result.width * repeat) / result.height;\r\n\t\t\tconst arc = Math.PI / 180 * 45;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / aspect;\r\n\t\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 20, 2, true, 0, arc);\r\n\t\t\tgeometry.scale(-1, 1, 1);\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tmap: texture,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tconst banners = this.banners = new Array(4).fill(0).map(x => new THREE.Mesh(geometry, material));\r\n\t\t\tbanners.forEach((banner, i) => {\r\n\t\t\t\tbanner.rotation.y = Math.PI / 2 * i;\r\n\t\t\t\tmesh.add(banner);\r\n\t\t\t});\r\n\t\t\tconst from = { value: 0 };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tvalue: 1,\r\n\t\t\t\tdelay: 0.0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tmesh.userData = {\r\n\t\t\t\trender: () => {\r\n\t\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.2;\r\n\t\t\t\t\ttexture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tgetCanvasTexture() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst MIN_W = 512;\r\n\t\t\tlet W = MIN_W;\r\n\t\t\tlet H = 128;\r\n\t\t\tconst F = Math.floor(H * 0.8);\r\n\t\t\tconst L = Math.floor(H * 0.075);\r\n\t\t\tlet canvas;\r\n\t\t\tif (this.canvas) {\r\n\t\t\t\tcanvas = this.canvas;\r\n\t\t\t} else {\r\n\t\t\t\tcanvas = this.canvas = document.createElement('canvas');\r\n\t\t\t\t// canvas.classList.add('canvas--debug');\r\n\t\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\t}\r\n\t\t\tcanvas.width = W;\r\n\t\t\tcanvas.height = H;\r\n\t\t\tconst text = this.item.title;\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t// const ctx = text.material.map.image.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `${F}px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tW = metrics.width + 8;\r\n\t\t\tW = Math.max(MIN_W, Math.pow(2, Math.ceil(Math.log(W) / Math.log(2))));\r\n\t\t\t// const x = W / 2;\r\n\t\t\t// const y = 16;\r\n\t\t\tcanvas.width = W;\r\n\t\t\tctx.clearRect(0, 0, W, H);\r\n\t\t\tctx.fillStyle = '#0000005A'; // 35% // '#000000C0'; // 75%\r\n\t\t\tctx.fillRect(0, 0, W, H);\r\n\t\t\tctx.font = `${F}px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';\r\n\t\t\tctx.lineWidth = L;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with \"bevel\" & \"round\" for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, W / 2, H / 2);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, W / 2, H / 2, W);\r\n\t\t\t// text.material.map.needsUpdate = true;\r\n\t\t\tlet texture;\r\n\t\t\tif (this.texture) {\r\n\t\t\t\ttexture = this.texture;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\ttexture = this.texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t}\r\n\t\t\t// console.log(F, L, W, H);\r\n\t\t\tresolve({ texture: texture, width: W, height: H });\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tgetCanvasTexture_() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (this.item.bannerTexture) {\r\n\t\t\t\tresolve(this.item.bannerTexture);\r\n\t\t\t} else {\r\n\t\t\t\tconst { node } = getContext(this);\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\thtml2canvas(node, {\r\n\t\t\t\t\t\tbackgroundColor: '#00000000', // '#000000ff',\r\n\t\t\t\t\t\tscale: 2,\r\n\t\t\t\t\t}).then(canvas => {\r\n\t\t\t\t\t\t// !!!\r\n\t\t\t\t\t\t// document.body.appendChild(canvas);\r\n\t\t\t\t\t\t// const alpha = this.getAlphaFromCanvas(canvas);\r\n\t\t\t\t\t\t// document.body.appendChild(alpha);\r\n\t\t\t\t\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t\t\t\t// const alphaMap = new THREE.CanvasTexture(alpha);\r\n\t\t\t\t\t\tthis.item.bannerTexture = {\r\n\t\t\t\t\t\t\ttexture: texture,\r\n\t\t\t\t\t\t\twidth: canvas.width,\r\n\t\t\t\t\t\t\theight: canvas.height,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tresolve(this.item.bannerTexture);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t});\r\n\t\t\t\t}, 1);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t*/\r\n}\r\n\r\nModelBannerComponent.ORIGIN = new THREE.Vector3();\r\n\r\nModelBannerComponent.meta = {\r\n\tselector: '[model-banner]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelEditableComponent extends ModelComponent {\r\n\r\n\tget editing() {\r\n\t\treturn this.editing_;\r\n\t}\r\n\tset editing(editing) {\r\n\t\tif (this.editing_ !== editing) {\r\n\t\t\tthis.editing_ = editing;\r\n\t\t\tthis.setHelper(editing);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.RADIUS = 100;\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.editing = false;\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\tsetHelper(showHelper) {\r\n\t\tif (showHelper) {\r\n\t\t\tif (!this.helper) {\r\n\t\t\t\tthis.helper = new THREE.BoxHelper(this.mesh, 0x00ff00);\r\n\t\t\t}\r\n\t\t\tthis.host.scene.add(this.helper);\r\n\t\t} else if (this.helper) {\r\n\t\t\tthis.host.scene.remove(this.helper);\r\n\t\t}\r\n\t}\r\n\r\n\tupdateHelper() {\r\n\t\tif (this.helper) {\r\n\t\t\tthis.helper.setFromObject(this.mesh);\r\n\t\t\t// this.helper.update();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nModelEditableComponent.meta = {\r\n\tselector: '[model-editable]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { filter, take, takeUntil } from 'rxjs/operators';\r\nimport MediaMesh from '../media/media-mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport default class ModelCurvedPlaneComponent extends ModelEditableComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelCurvedPlaneComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst item = this.item;\r\n\t\tconst items = this.items;\r\n\t\tconst geometry = this.getCurvedPanelGeometry(item);\r\n\t\tlet mesh;\r\n\t\tlet subscription;\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((streamId) => {\r\n\t\t\tif (this.streamId !== streamId) {\r\n\t\t\t\tthis.streamId = streamId;\r\n\t\t\t\t// !!! called by ModelComponent\r\n\t\t\t\t/*\r\n\t\t\t\tif (mesh) {\r\n\t\t\t\t\tdismount(mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tif (subscription) {\r\n\t\t\t\t\tsubscription.unsubscribe();\r\n\t\t\t\t\tsubscription = null;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('ModelCurvedPanel', streamId, item.asset)\r\n\t\t\t\tif (streamId || !item.asset) {\r\n\t\t\t\t\titem.streamId = streamId;\r\n\t\t\t\t\tmesh = new MediaMesh(item, items, geometry);\r\n\t\t\t\t\tmesh.name = 'curved-plane';\r\n\t\t\t\t\tif (item.position) {\r\n\t\t\t\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.rotation) {\r\n\t\t\t\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.scale) {\r\n\t\t\t\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tmesh.load(() => {\r\n\t\t\t\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\t\t\t\tmount(mesh, item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsubscription = mesh.events$().pipe(\r\n\t\t\t\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t\t\t\t).subscribe(() => { });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('down', () => {\r\n\t\t\t\t\t\t// console.log('ModelCurvedPanelComponent.down');\r\n\t\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('playing', (playing) => {\r\n\t\t\t\t\t\t// console.log('ModelCurvedPanelComponent.playing', playing);\r\n\t\t\t\t\t\tthis.play.next({ itemId: this.item.id, playing });\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (this.mesh) {\r\n\t\t\t\t\tdismount(this.mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('streamId', streamId, mesh);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.mesh.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelCurvedPlaneComponent.onUpdate', item);\r\n\t\tif (item.position) {\r\n\t\t\tmesh.position.fromArray(item.position);\r\n\t\t}\r\n\t\tif (item.rotation) {\r\n\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t}\r\n\t\tif (item.scale) {\r\n\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t}\r\n\t\t// !!! deactivated\r\n\t\tif (true && (item.radius !== this.radius_ || item.height !== this.height_ || item.arc !== this.arc_)) {\r\n\t\t\tthis.mesh.geometry.dispose();\r\n\t\t\tconst geometry = this.getCurvedPanelGeometry(item);\r\n\t\t\tthis.mesh.geometry = geometry;\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelCurvedPlaneComponent.onUpdateAsset', item);\r\n\t\tthis.mesh.updateByItem(item);\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\tfilter(streamId => streamId !== null),\r\n\t\t\ttake(1),\r\n\t\t).subscribe((streamId) => {\r\n\t\t\titem.streamId = streamId;\r\n\t\t\tthis.mesh.load(() => {\r\n\t\t\t\t// console.log('ModelCurvedPlaneComponent.mesh.load.complete');\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\tthis.item.showPanel = false;\r\n\t\tthis.editing = true;\r\n\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(20);\r\n\t\tthis.mesh.lookAt(ModelCurvedPlaneComponent.ORIGIN);\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\tthis.item.position = this.mesh.position.toArray();\r\n\t\tthis.item.rotation = this.mesh.rotation.toArray();\r\n\t\tthis.item.scale = this.mesh.scale.toArray();\r\n\t\tthis.editing = false;\r\n\t}\r\n\r\n\tgetCurvedPanelGeometry(item) {\r\n\t\tthis.radius_ = item.radius;\r\n\t\tthis.height_ = item.height;\r\n\t\tthis.arc_ = item.arc;\r\n\t\tconst arc = Math.PI / 180 * item.arc;\r\n\t\tconst geometry = new THREE.CylinderBufferGeometry(item.radius, item.radius, item.height, 36, 2, true, 0, arc);\r\n\t\tgeometry.rotateY(-Math.PI - arc / 2);\r\n\t\tgeometry.scale(-1, 1, 1);\r\n\t\treturn geometry;\r\n\t}\r\n\r\n}\r\n\r\nModelCurvedPlaneComponent.ORIGIN = new THREE.Vector3();\r\nModelCurvedPlaneComponent.textures = {};\r\n\r\nModelCurvedPlaneComponent.meta = {\r\n\tselector: '[model-curved-plane]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play'],\r\n\tinputs: ['item', 'items'],\r\n};\r\n","import { BehaviorSubject } from \"rxjs\";\r\n\r\nexport const XRStatus = {\r\n\tWaiting: 'waiting',\r\n\tEnabled: 'enabled',\r\n\tEnded: 'ended',\r\n\tStarted: 'started',\r\n\tDisabled: 'disabled',\r\n\tNeedsHttps: 'needs-https',\r\n\tUnavailable: 'unavailable',\r\n};\r\n\r\nexport default class DebugService {\r\n\r\n\tstatic getService() {\r\n\t\tif (!this.service_) {\r\n\t\t\tthis.service_ = new DebugService();\r\n\t\t}\r\n\t\treturn this.service_;\r\n\t}\r\n\r\n\tget message() {\r\n\t\treturn this.message$.getValue();\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tif (DebugService.service_) {\r\n\t\t\tthrow ('DebugService is a singleton class!');\r\n\t\t}\r\n\t\tthis.message$ = new BehaviorSubject(null);\r\n\t}\r\n\r\n\tsetMessage(message) {\r\n\t\tif (this.message !== message) {\r\n\t\t\tthis.message$.next(message);\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport DebugService from '../debug.service';\r\nimport VRService from '../vr.service';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelDebugComponent extends ModelComponent {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelDebugComponent.loader || (ModelDebugComponent.loader = new THREE.FontLoader());\r\n\t}\r\n\r\n\tstatic getFontLoader(callback) {\r\n\t\treturn ModelDebugComponent.fontLoader || (ModelDebugComponent.fontLoader = ModelDebugComponent.getLoader().load(environment.getPath('fonts/helvetiker/helvetiker_regular.typeface.json'), callback));\r\n\t}\r\n\r\n\tget message() {\r\n\t\treturn this.message_;\r\n\t}\r\n\r\n\tset message(message) {\r\n\t\tmessage = message && message !== '' ? message : null;\r\n\t\tif (this.message_ !== message) {\r\n\t\t\tthis.message_ = message;\r\n\t\t\t// console.log('ModelDebugComponent.set.message', message);\r\n\t\t\tthis.setText(message);\r\n\t\t\t/*\r\n\t\t\tif (this.font) {\r\n\t\t\t\tthis.setText(message);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelDebugComponent.onInit');\r\n\t\t// this.loadFont();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tif (session) {\r\n\t\t\t\tif (this.text) {\r\n\t\t\t\t\tthis.textGroup.add(this.text);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (this.text) {\r\n\t\t\t\t\tthis.text.parent.remove(this.text);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tconst debugService = this.debugService = DebugService.getService();\r\n\t\tdebugService.message$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => this.message = message);\r\n\t}\r\n\r\n\tcreateText() {\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\tcanvas.width = ModelDebugComponent.W;\r\n\t\tcanvas.height = ModelDebugComponent.H;\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\ttexture.needsUpdate = true;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(4, 1, 2, 2);\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tmap: texture,\r\n\t\t\tcolor: 0xffffff, // 0x33c5f6,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 1,\r\n\t\t\t// blending: THREE.AdditiveBlending,\r\n\t\t\t// side: THREE.DoubleSide\r\n\t\t});\r\n\t\tconst text = new THREE.Mesh(geometry, material);\r\n\t\ttext.renderer = environment.renderOrder.debug;\r\n\t\ttext.position.y = 0;\r\n\t\treturn text;\r\n\t}\r\n\r\n\tloadFont() {\r\n\t\tthis.fontLoader = ModelDebugComponent.getFontLoader((font) => {\r\n\t\t\tthis.font = font;\r\n\t\t\tif (this.message_) {\r\n\t\t\t\tthis.setText(this.message_);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst textGroup = this.textGroup = new THREE.Group();\r\n\t\tconst material = this.material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tcolor: 0xffffff, // 0x33c5f6,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 1,\r\n\t\t\tside: THREE.DoubleSide\r\n\t\t});\r\n\t\tconst text = this.text = this.createText();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(textGroup);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n\r\n\trender(time, tick) {\r\n\t\tconst group = this.group;\r\n\t\tlet camera = this.host.camera;\r\n\t\tconst position = this.position;\r\n\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\tcamera = this.host.renderer.xr.getCamera(camera);\r\n\t\t\t// camera.updateMatrixWorld(); // make sure the camera matrix is updated\r\n\t\t\t// camera.matrixWorldInverse.getInverse(camera.matrixWorld);\r\n\t\t}\r\n\t\tcamera.getWorldDirection(position);\r\n\t\t// console.log(position);\r\n\t\t// if (position.lengthSq() > 0.01) {\r\n\t\t// normalize so we can get a constant speed\r\n\t\t// position.normalize();\r\n\t\tposition.multiplyScalar(3);\r\n\t\t// move body, not the camera\r\n\t\t// VR.body.position.add(lookDirection);\r\n\t\t// console.log(position.x + '|' + position.y + '|' + position.z);\r\n\t\tgroup.position.copy(position);\r\n\t\tgroup.lookAt(ModelDebugComponent.ORIGIN);\r\n\t\t// }\r\n\t}\r\n\r\n\tsetText(message) {\r\n\t\tconst text = this.text;\r\n\t\tif (text) {\r\n\t\t\tif (this.host.renderer.xr.isPresenting && message != null) {\r\n\t\t\t\t// draw\r\n\t\t\t\tconst ctx = text.material.map.image.getContext('2d');\r\n\t\t\t\tctx.clearRect(0, 0, ModelDebugComponent.W, ModelDebugComponent.H);\r\n\t\t\t\t// ctx.fillRect(0, 0, 10, 10);\r\n\t\t\t\t// ctx.fillRect(ModelDebugComponent.W - 10, ModelDebugComponent.H - 10, 10, 10);\r\n\t\t\t\tctx.font = `30px ${environment.fontFamily}`;\r\n\t\t\t\tctx.textBaseline = 'middle';\r\n\t\t\t\tctx.textAlign = \"center\";\r\n\t\t\t\tctx.fillStyle = '#FFFFFF';\r\n\t\t\t\tctx.strokeStyle = '#000000';\r\n\t\t\t\tctx.lineWidth = 5;\r\n\t\t\t\tctx.fillText(message, ModelDebugComponent.W / 2, ModelDebugComponent.H / 2, ModelDebugComponent.W - 20);\r\n\t\t\t\ttext.material.map.needsUpdate = true;\r\n\t\t\t\t// draw\r\n\t\t\t\tthis.textGroup.add(text);\r\n\t\t\t} else if (text.parent) {\r\n\t\t\t\ttext.parent.remove(text);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nModelDebugComponent.ORIGIN = new THREE.Vector3();\r\nModelDebugComponent.W = 1024;\r\nModelDebugComponent.H = 256;\r\n\r\nModelDebugComponent.meta = {\r\n\tselector: '[model-debug]',\r\n\thosts: { host: WorldComponent },\r\n};\r\n","import { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\n\r\nconst FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform float opacity;\r\nuniform float tween;\r\n\r\nvoid main() {\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tvec4 colorB = texture2D(textureB, vUv);\r\n\tvec4 color = mix(colorA, colorB, tween);\r\n\tcolor.a = clamp(color.a * opacity, 0.0, 1.0);\r\n\tcolor.rgb /= color.a;\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nexport default class ModelGridComponent extends ModelComponent {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelGridComponent.loader || (ModelGridComponent.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getTexture() {\r\n\t\treturn ModelGridComponent.texture || (ModelGridComponent.texture = ModelGridComponent.getLoader().load(environment.getPath('textures/ui/floor-nav.png')));\r\n\t}\r\n\r\n\tstatic getOverTexture() {\r\n\t\treturn ModelGridComponent.textureOver || (ModelGridComponent.textureOver = ModelGridComponent.getLoader().load(environment.getPath('textures/ui/floor-nav-over.png')));\r\n\t}\r\n\r\n\tset coords(coords) {\r\n\t\tif ((!coords && this.coords_ !== coords) || !this.coords_ || coords.x !== this.coords_.x || coords.y !== this.coords_.y) {\r\n\t\t\t// changed!\r\n\t\t\tconst tileMap = this.tileMap;\r\n\t\t\tif (this.coords_) {\r\n\t\t\t\tconst previousTile = tileMap[`${this.coords_.x}_${this.coords_.y}`];\r\n\t\t\t\tconst previousUniforms = previousTile.uniforms;\r\n\t\t\t\tgsap.to(previousUniforms, {\r\n\t\t\t\t\ttween: 0,\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tpreviousTile.material.uniforms.tween.value = previousUniforms.tween;\r\n\t\t\t\t\t\tpreviousTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tif (coords) {\r\n\t\t\t\tconst currentTile = this.currentTile = tileMap[`${coords.x}_${coords.y}`];\r\n\t\t\t\tconst currentUniforms = currentTile.uniforms;\r\n\t\t\t\tgsap.to(currentUniforms, {\r\n\t\t\t\t\ttween: 1,\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tcurrentTile.material.uniforms.tween.value = currentUniforms.tween;\r\n\t\t\t\t\t\tcurrentTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// console.log(currentTile, `${coords.x}_${coords.y}`);\r\n\t\t\t}\r\n\t\t\tthis.coords_ = coords;\r\n\t\t}\r\n\t}\r\n\r\n\tset coords__(coords) {\r\n\t\tif ((!coords && this.coords_ !== coords) || !this.coords_ || coords.x !== this.coords_.x || coords.y !== this.coords_.y) {\r\n\t\t\t// changed!\r\n\t\t\tconst tileMap = this.tileMap;\r\n\t\t\tif (this.coords_) {\r\n\t\t\t\tconst previousTile = tileMap[`${this.coords_.x}_${this.coords_.y}`];\r\n\t\t\t\tconst from = { tween: 1 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\ttween: 0,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tpreviousTile.material.opacity = from.tween;\r\n\t\t\t\t\t\t// previousTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tif (coords) {\r\n\t\t\t\tconst currentTile = this.currentTile = tileMap[`${coords.x}_${coords.y}`];\r\n\t\t\t\tconst from = { tween: 0 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\ttween: 1,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tcurrentTile.material.opacity = from.tween;\r\n\t\t\t\t\t\t// currentTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// console.log(currentTile, `${coords.x}_${coords.y}`);\r\n\t\t\t}\r\n\t\t\tthis.coords_ = coords;\r\n\t\t}\r\n\t}\r\n\r\n\tgetCoords(point) {\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst col = Math.ceil((point.x + outerTileSize / 2) / outerTileSize) - 1;\r\n\t\tconst row = Math.ceil((point.z + outerTileSize / 2) / outerTileSize) - 1;\r\n\t\tconst dx = Math.floor(ModelGridComponent.COLS / 2);\r\n\t\tconst dy = Math.floor(ModelGridComponent.ROWS / 2);\r\n\t\tconst ci = Math.min(dx, Math.abs(col)) * (col ? Math.abs(col) / col : 1);\r\n\t\tconst ri = Math.min(dy, Math.abs(row)) * (row ? Math.abs(row) / row : 1);\r\n\t\tif (this.view.hasTile(this.indices.x + ci, this.indices.y + ri)) {\r\n\t\t\t// console.log('col', col, 'row', row, 'ci', ci, 'ri', ri);\r\n\t\t\treturn new THREE.Vector2(ci, ri);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.indices = new THREE.Vector2();\r\n\t\t// console.log('ModelGridComponent.onInit', this.view);\r\n\t\tthis.view.index$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(index => {\r\n\t\t\tthis.moveToIndex(index);\r\n\t\t});\r\n\t}\r\n\r\n\taddTiles(mesh) {\r\n\t\t// console.log('addTiles');\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst innerTileSize = outerTileSize * 0.9;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(innerTileSize, innerTileSize, 2, 2);\r\n\t\tgeometry.rotateX(-Math.PI / 2);\r\n\t\tconst map = ModelGridComponent.getTexture();\r\n\t\tmap.disposable = false;\r\n\t\tmap.encoding = THREE.sRGBEncoding;\r\n\t\tconst mapOver = ModelGridComponent.getOverTexture();\r\n\t\tmapOver.disposable = false;\r\n\t\tmapOver.encoding = THREE.sRGBEncoding;\r\n\t\t// geometry.scale(-1, 1, 1);\r\n\t\tconst tileMap = this.tileMap = {};\r\n\t\tconst tiles = this.tiles = new Array(ModelGridComponent.COLS * ModelGridComponent.ROWS).fill(0).map((x, i) => {\r\n\t\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\t\tfragmentShader: FRAGMENT_SHADER,\r\n\t\t\t\tuniforms: {\r\n\t\t\t\t\ttextureA: { type: \"t\", value: map },\r\n\t\t\t\t\ttextureB: { type: \"t\", value: mapOver },\r\n\t\t\t\t\ttween: { value: 0 },\r\n\t\t\t\t\topacity: { value: 0 },\r\n\t\t\t\t},\r\n\t\t\t\t// side: THREE.DoubleSide\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\tmap: map,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tconst tile = new THREE.Mesh(geometry, material);\r\n\t\t\tconst dx = Math.floor(ModelGridComponent.COLS / 2);\r\n\t\t\tconst dy = Math.floor(ModelGridComponent.ROWS / 2);\r\n\t\t\tconst row = Math.floor(i / ModelGridComponent.COLS);\r\n\t\t\tconst col = i % ModelGridComponent.COLS;\r\n\t\t\tconst ci = -dx + col;\r\n\t\t\tconst ri = -dy + row;\r\n\t\t\t// console.log(ci, ri);\r\n\t\t\ttile.position.set(ci * outerTileSize, -ModelGridComponent.RADIUS * 0.15, ri * outerTileSize);\r\n\t\t\ttile.name = this.getName(`tile_${ci}_${ri}`);\r\n\t\t\tconst uniforms = tile.uniforms = {\r\n\t\t\t\ttween: 0,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\tci: ci,\r\n\t\t\t\tri: ri,\r\n\t\t\t};\r\n\t\t\ttileMap[`${ci}_${ri}`] = tile;\r\n\t\t\tmesh.add(tile);\r\n\t\t\treturn tile;\r\n\t\t});\r\n\t\tthis.showTiles();\r\n\t}\r\n\r\n\tshowTiles() {\r\n\t\tthis.tiles.forEach((tile, i) => {\r\n\t\t\tconst ix = this.indices ? this.indices.x : 0;\r\n\t\t\tconst iy = this.indices ? this.indices.y : 0;\r\n\t\t\tconst visible = this.view.hasTile(ix + tile.uniforms.ci, iy + tile.uniforms.ri);\r\n\t\t\tconst uniforms = tile.uniforms;\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\topacity: visible ? 1 : 0,\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\t// delay: 0 + i * 0.02,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\ttile.material.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\ttile.material.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\taddHitArea(mesh) {\r\n\t\tthis.onGroundOver = this.onGroundOver.bind(this);\r\n\t\tthis.onGroundMove = this.onGroundMove.bind(this);\r\n\t\tthis.onGroundDown = this.onGroundDown.bind(this);\r\n\t\tthis.onGroundOut = this.onGroundOut.bind(this);\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst innerTileSize = outerTileSize * 0.9;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(ModelGridComponent.RADIUS, ModelGridComponent.RADIUS, 20, 20);\r\n\t\tgeometry.rotateX(-Math.PI / 2);\r\n\t\t// geometry.scale(-1, 1, 1);\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst ground = this.ground = new InteractiveMesh(geometry, material);\r\n\t\tground.name = this.getName('ground');\r\n\t\tground.position.set(0, -ModelGridComponent.RADIUS * 0.15, 0);\r\n\t\tground.on('over', this.onGroundOver);\r\n\t\tground.on('move', this.onGroundMove);\r\n\t\tground.on('out', this.onGroundOut);\r\n\t\tground.on('down', this.onGroundDown);\r\n\t\tmesh.add(ground);\r\n\t}\r\n\r\n\tonGroundOver() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t}\r\n\r\n\tonGroundMove() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t}\r\n\r\n\tonGroundDown() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t\tif (coords) {\r\n\t\t\tconst index = this.view.getTileIndex(this.indices.x + coords.x, this.indices.y + coords.y);\r\n\t\t\tthis.view.index = index;\r\n\t\t\tthis.nav.next(index);\r\n\t\t\t/*\r\n\t\t\tthis.indices.x += coords.x;\r\n\t\t\tthis.indices.y += coords.y;\r\n\t\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\t\tthis.move.next({\r\n\t\t\t\tindices: this.indices,\r\n\t\t\t\tcoords,\r\n\t\t\t\tposition: coords.clone().multiplyScalar(outerTileSize)\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonGroundOut() {\r\n\t\tthis.coords = null;\r\n\t}\r\n\r\n\tmoveToIndex(index) {\r\n\t\t// console.log('ModelGridComponent.moveToIndex', index);\r\n\t\tthis.coords = null;\r\n\t\tconst tile = this.view.tiles[index];\r\n\t\tconst coords = new THREE.Vector2(tile.indices.x - this.indices.x, tile.indices.y - this.indices.y);\r\n\t\tthis.indices.x = tile.indices.x;\r\n\t\tthis.indices.y = tile.indices.y;\r\n\t\tthis.showTiles();\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tthis.move.next({\r\n\t\t\tindices: this.indices,\r\n\t\t\tcoords,\r\n\t\t\tposition: coords.clone().multiplyScalar(outerTileSize)\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.tile;\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tthis.addTiles(mesh);\r\n\t\tthis.addHitArea(mesh);\r\n\t\t/*\r\n\t\tmesh.userData = {\r\n\t\t\trender: () => {\r\n\r\n\t\t\t}\r\n\t\t};\r\n\t\t*/\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tconst ground = this.ground;\r\n\t\tground.off('over', this.onGroundOver);\r\n\t\tground.off('move', this.onGroundMove);\r\n\t\tground.off('down', this.onGroundDown);\r\n\t\tground.off('out', this.onGroundOut);\r\n\t}\r\n\r\n}\r\n\r\nModelGridComponent.ORIGIN = new THREE.Vector3();\r\nModelGridComponent.RADIUS = 101;\r\nModelGridComponent.COLS = 11;\r\nModelGridComponent.ROWS = 11;\r\n\r\nModelGridComponent.meta = {\r\n\tselector: '[model-grid]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['move', 'nav'],\r\n\tinputs: ['view'],\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { of } from 'rxjs';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { MessageType } from '../../agora/agora.types';\r\nimport MenuService from '../../editor/menu/menu.service';\r\nimport { environment } from '../../environment';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport MessageService from '../../message/message.service';\r\nimport StateService from '../../state/state.service';\r\n// import DebugService from '../debug.service';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport OrbitService, { OrbitMode } from '../orbit/orbit';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport class MenuButton extends InteractiveMesh {\r\n\r\n\tstatic getGrid(total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\treturn [rows, cols];\r\n\t}\r\n\r\n\tstatic getX(index, total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\tconst c = index % cols;\r\n\t\tconst w = (1 / MenuButton.W * (MenuButton.W + MenuButton.G));\r\n\t\treturn (w / 2 - cols * w / 2) + c * w;\r\n\t}\r\n\r\n\tstatic getY(index, total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\tconst c = index % cols;\r\n\t\tconst r = Math.floor(index / cols);\r\n\t\tconst h = (1 / MenuButton.W * (MenuButton.H + MenuButton.G));\r\n\t\treturn (rows * h / 2 - h / 2) + r * -h; // y flipped\r\n\t}\r\n\r\n\tstatic get geometry() {\r\n\t\tif (this.geometry_) {\r\n\t\t\treturn this.geometry_;\r\n\t\t}\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(1, 1 / MenuButton.W * MenuButton.H, 2, 2);\r\n\t\t// geometry.rotateX(-Math.PI);\r\n\t\t// geometry.scale(-1, 1, 1);\r\n\t\tthis.geometry_ = geometry;\r\n\t\treturn geometry;\r\n\t}\r\n\r\n\tstatic get material() {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tvertexShader: ModelMenuComponent.VERTEX_SHADER,\r\n\t\t\tfragmentShader: ModelMenuComponent.FRAGMENT_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\ttextureA: { type: \"t\", value: null },\r\n\t\t\t\ttextureB: { type: \"t\", value: null },\r\n\t\t\t\tresolutionA: { value: new THREE.Vector2() },\r\n\t\t\t\tresolutionB: { value: new THREE.Vector2() },\r\n\t\t\t\ttween: { value: 0 },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t},\r\n\t\t});\r\n\t\t/*\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.8,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\t*/\r\n\t\treturn material;\r\n\t}\r\n\r\n\tconstructor(item, index, total) {\r\n\t\tconst geometry = MenuButton.geometry;\r\n\t\tconst material = MenuButton.material;\r\n\t\tsuper(geometry, material);\r\n\t\t// this.userData.item = item;\r\n\t\t// this.userData.index = index;\r\n\t\tthis.renderOrder = environment.renderOrder.menu;\r\n\t\tthis.name = item.name;\r\n\t\tthis.item = item;\r\n\t\tthis.index = index;\r\n\t\tthis.total = total;\r\n\t\tthis.tween = 0;\r\n\t\tthis.opacity = 0;\r\n\t\tconst textureA = this.textureA = this.getTextureA(item.name);\r\n\t\t// material.map = textureA;\r\n\t\tmaterial.uniforms.textureA.value = textureA;\r\n\t\tmaterial.uniforms.resolutionA.value = new THREE.Vector2(textureA.width, textureA.height);\r\n\t\tconst textureB = this.textureB = this.getTextureB(item.name);\r\n\t\t// material.map = textureB;\r\n\t\tmaterial.uniforms.textureB.value = textureB;\r\n\t\tmaterial.uniforms.resolutionA.value = new THREE.Vector2(textureB.width, textureB.height);\r\n\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\tmaterial.uniforms.opacity.value = this.opacity;\r\n\t\tmaterial.needsUpdate = true;\r\n\t\tthis.position.set(MenuButton.getX(index, total), MenuButton.getY(index, total), 0);\r\n\t\tthis.onOver = this.onOver.bind(this);\r\n\t\tthis.onOut = this.onOut.bind(this);\r\n\t}\r\n\r\n\tgetTextureA(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tgetTextureB(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuOverBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuOverForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tonOver() {\r\n\t\t// DebugService.getService().setMessage('over ' + this.name);\r\n\t\tgsap.to(this, {\r\n\t\t\tduration: 0.4,\r\n\t\t\ttween: 1,\r\n\t\t\tease: Power2.easeOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.position.z = 0.1 * this.tween;\r\n\t\t\t\tthis.material.uniforms.tween.value = this.tween;\r\n\t\t\t\tthis.material.needsUpdate = true;\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\tonOut() {\r\n\t\tgsap.to(this, {\r\n\t\t\tduration: 0.4,\r\n\t\t\ttween: 0,\r\n\t\t\tease: Power2.easeOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.position.z = 0.1 * this.tween;\r\n\t\t\t\tthis.material.uniforms.tween.value = this.tween;\r\n\t\t\t\tthis.material.needsUpdate = true;\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tInteractive.dispose(this);\r\n\t\tthis.textureA.dispose();\r\n\t\tthis.textureB.dispose();\r\n\t\tthis.material.dispose();\r\n\t\tthis.geometry.dispose();\r\n\t}\r\n}\r\n\r\nMenuButton.W = 256;\r\nMenuButton.H = 64;\r\nMenuButton.G = 2;\r\nMenuButton.ROWS = 6;\r\n\r\nexport class BackButton extends MenuButton {\r\n\r\n\tconstructor(item, index, total) {\r\n\t\tsuper(item, index, total);\r\n\t}\r\n\r\n\tgetTextureA(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuBackForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tgetTextureB(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackOverBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuBackOverForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n}\r\n\r\nexport default class ModelMenuComponent extends ModelComponent {\r\n\r\n\tget loading() {\r\n\t\treturn this.loading_;\r\n\t}\r\n\tset loading(loading) {\r\n\t\tif (this.loading_ !== loading) {\r\n\t\t\tthis.loading_ = loading;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst btn = node.querySelector('.btn--menu');\r\n\t\t\tbtn.classList.toggle('loading', loading);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.onDown = this.onDown.bind(this);\r\n\t\tthis.onToggle = this.onToggle.bind(this);\r\n\t\t// console.log('ModelMenuComponent.onInit');\r\n\t\t/*\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tif (session) {\r\n\t\t\t\tthis.addToggler();\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeMenu();\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t\tLoaderService.progress$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(progress => this.loading = progress.count > 0);\r\n\t\tMessageService.in$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// DebugService.getService().setMessage('ModelMenuComponent.MessageService ' + message.type);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.MenuToggle:\r\n\t\t\t\t\tthis.onToggle();\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\t// this.buildMenu();\r\n\t}\r\n\r\n\tbuildMenu() {\r\n\t\tif (!this.items) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMenuService.getModelMenu$(this.items, this.editor).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(menu => this.groups = menu);\r\n\t\t/*\r\n\t\tconst menu = {};\r\n\t\tthis.items.forEach(item => {\r\n\t\t\tif (item.type.name !== ViewType.WaitingRoom.name && (!item.hidden || this.editor)) {\r\n\t\t\t\tlet group = menu[item.type.name];\r\n\t\t\t\tif (!group) {\r\n\t\t\t\t\tgroup = menu[item.type.name] = [];\r\n\t\t\t\t}\r\n\t\t\t\tgroup.push(item);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.groups = Object.keys(menu).map(typeName => {\r\n\t\t\tlet name = 'Button';\r\n\t\t\tswitch (typeName) {\r\n\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\t\tname = 'Waiting Room';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\tname = 'Experience';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\tname = 'Virtual Tour';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\t\tname = 'Stanze 3D';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\tname = 'Modelli 3D';\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\treturn { name, type: { name: 'menu-group' }, items: this.items.filter(x => x.type.name === typeName && (!x.hidden || this.editor)) };\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tif (this.buttons) {\r\n\t\t\tthis.buttons.forEach(x => Interactive.dispose(x));\r\n\t\t}\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\tgetContainer() {\r\n\t\treturn this.host.cameraGroup;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.menu;\r\n\t\tconst menuGroup = this.menuGroup = new THREE.Group();\r\n\t\t// menuGroup.lookAt(ModelMenuComponent.ORIGIN);\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(menuGroup);\r\n\t\t}\r\n\t}\r\n\r\n\trender(time, tick) {\r\n\t\tconst group = this.group;\r\n\t\tlet camera = this.host.camera;\r\n\t\tconst position = this.position;\r\n\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\tcamera = this.host.renderer.xr.getCamera(camera);\r\n\t\t\tcamera.getWorldDirection(position);\r\n\t\t\tposition.y += 0.5;\r\n\t\t\tposition.multiplyScalar(3);\r\n\t\t\tthis.host.cameraGroup.worldToLocal(position);\r\n\t\t\tposition.y += this.host.cameraGroup.position.y;\r\n\t\t\tgroup.position.copy(position);\r\n\t\t\tgroup.scale.set(1, 1, 1);\r\n\t\t\tgroup.lookAt(camera.position);\r\n\t\t\t// group.lookAt(ModelMenuComponent.ORIGIN);\r\n\t\t} else {\r\n\t\t\tcamera.getWorldDirection(position);\r\n\t\t\tif (OrbitService.mode === OrbitMode.Model) {\r\n\t\t\t\tposition.multiplyScalar(0.01);\r\n\t\t\t} else {\r\n\t\t\t\tposition.multiplyScalar(3);\r\n\t\t\t}\r\n\t\t\tgroup.position.copy(position);\r\n\t\t\tconst s = 1 / camera.zoom;\r\n\t\t\tgroup.scale.set(s, s, s);\r\n\t\t\tgroup.lookAt(ModelMenuComponent.ORIGIN);\r\n\t\t}\r\n\t}\r\n\r\n\titems$(item = null) {\r\n\t\tif (item) {\r\n\t\t\treturn of(item.items);\r\n\t\t} else {\r\n\t\t\treturn MenuService.getModelMenu$(this.items, this.editor).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\taddMenu(item = null) {\r\n\t\tthis.removeMenu();\r\n\t\t// nav to view\r\n\t\tif (item && item.type.name !== 'menu-group') {\r\n\t\t\t/*\r\n\t\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\t\tthis.addToggler();\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.nav.next(item);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMenuService.active = true;\r\n\t\tthis.items$(item).subscribe(items => {\r\n\t\t\tif (items) {\r\n\t\t\t\titems = items.slice();\r\n\t\t\t\tconst back = {\r\n\t\t\t\t\ttype: { name: 'back' },\r\n\t\t\t\t\tname: item ? 'Back' : 'Close',\r\n\t\t\t\t\tbackItem: item,\r\n\t\t\t\t};\r\n\t\t\t\titems.push(back);\r\n\t\t\t\tconst buttons = this.buttons = items.map((x, i, a) => {\r\n\t\t\t\t\tx.backItem = item;\r\n\t\t\t\t\treturn (x.type.name === 'back') ? new BackButton(x, i, a.length) : new MenuButton(x, i, a.length);\r\n\t\t\t\t});\r\n\t\t\t\tbuttons.forEach(button => {\r\n\t\t\t\t\tbutton.depthTest = false;\r\n\t\t\t\t\tbutton.on('over', button.onOver);\r\n\t\t\t\t\tbutton.on('out', button.onOut);\r\n\t\t\t\t\tbutton.on('down', this.onDown);\r\n\t\t\t\t\tthis.menuGroup.add(button);\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tvar box = new THREE.BoxHelper(button, 0xffff00);\r\n\t\t\t\t\tthis.host.scene.add(box);\r\n\t\t\t\t\t*/\r\n\t\t\t\t});\r\n\t\t\t\tgsap.to(buttons, {\r\n\t\t\t\t\tduration: 0.3,\r\n\t\t\t\t\topacity: 0.8,\r\n\t\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\t\tstagger: {\r\n\t\t\t\t\t\tgrid: MenuButton.getGrid(buttons.length),\r\n\t\t\t\t\t\tfrom: 0, // index\r\n\t\t\t\t\t\tamount: 0.02 * buttons.length\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tbuttons.forEach(button => {\r\n\t\t\t\t\t\t\tbutton.material.uniforms.opacity.value = (button.opacity * (button.item.hidden ? 0.5 : 1));\r\n\t\t\t\t\t\t\t// button.material.needsUpdate = true;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tremoveMenu() {\r\n\t\tMenuService.active = false;\r\n\t\tthis.removeButtons();\r\n\t\tthis.removeToggler();\r\n\t}\r\n\r\n\tremoveButtons() {\r\n\t\tconst buttons = this.buttons;\r\n\t\tif (buttons) {\r\n\t\t\tbuttons.forEach(button => {\r\n\t\t\t\tthis.menuGroup.remove(button);\r\n\t\t\t\tbutton.off('over', button.onOver);\r\n\t\t\t\tbutton.off('out', button.onOut);\r\n\t\t\t\tbutton.off('down', this.onDown);\r\n\t\t\t\tbutton.dispose();\r\n\t\t\t});\r\n\t\t}\r\n\t\tthis.buttons = null;\r\n\t}\r\n\r\n\taddToggler() {\r\n\t\tthis.removeMenu();\r\n\t\tconst toggler = this.toggler = new MenuButton({\r\n\t\t\ttype: { name: 'menu' },\r\n\t\t\tname: 'Menu'\r\n\t\t}, 0, 1);\r\n\t\t// toggler.position.y = -0.5;\r\n\t\ttoggler.opacity = 0.8;\r\n\t\ttoggler.material.uniforms.opacity.value = toggler.opacity;\r\n\t\ttoggler.material.needsUpdate = true;\r\n\t\ttoggler.on('over', toggler.onOver);\r\n\t\ttoggler.on('out', toggler.onOut);\r\n\t\ttoggler.on('down', this.onToggle);\r\n\t\tthis.menuGroup.add(toggler);\r\n\t}\r\n\r\n\tremoveToggler() {\r\n\t\tconst toggler = this.toggler;\r\n\t\tif (toggler) {\r\n\t\t\tthis.menuGroup.remove(toggler);\r\n\t\t\ttoggler.off('over', toggler.onOver);\r\n\t\t\ttoggler.off('out', toggler.onOut);\r\n\t\t\ttoggler.off('down', this.onToggle);\r\n\t\t\ttoggler.dispose();\r\n\t\t}\r\n\t\tthis.toggler = null;\r\n\t}\r\n\r\n\tonDown(button) {\r\n\t\t// this.down.next(this.item);\r\n\t\tif (button.item && button.item.type.name === 'back') {\r\n\t\t\tthis.removeMenu();\r\n\t\t\tif (button.item.backItem) {\r\n\t\t\t\tthis.addMenu(button.item.backItem.backItem);\r\n\t\t\t} else {\r\n\t\t\t\t/*\r\n\t\t\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\t\t\tthis.addToggler();\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tthis.toggle.next();\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis.addMenu(button.item);\r\n\t\t}\r\n\t}\r\n\r\n\tonToggle() {\r\n\t\tif (StateService.state.locked || StateService.state.spying) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (MenuService.active) {\r\n\t\t\tthis.removeMenu();\r\n\t\t\tthis.toggle.next();\r\n\t\t} else {\r\n\t\t\tthis.addMenu();\r\n\t\t\tthis.toggle.next(this);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nModelMenuComponent.ORIGIN = new THREE.Vector3();\r\nModelMenuComponent.VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\nModelMenuComponent.FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform float opacity;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\n\r\nvoid main() {\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tvec4 colorB = texture2D(textureB, vUv);\r\n\tvec4 color = vec4(mix(colorA.rgb, colorB.rgb, tween), opacity);\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nModelMenuComponent.meta = {\r\n\tselector: '[model-menu]',\r\n\thosts: { host: WorldComponent },\r\n\t// outputs: ['over', 'out', 'down', 'nav'],\r\n\toutputs: ['nav', 'toggle'],\r\n\tinputs: ['items', 'editor'],\r\n};\r\n","// import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport MenuService from '../../editor/menu/menu.service';\r\nimport { environment } from '../../environment';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport { ViewType } from '../../view/view';\r\nimport EmittableMesh from '../interactive/emittable.mesh';\r\nimport FreezableMesh from '../interactive/freezable.mesh';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport default class ModelModelComponent extends ModelEditableComponent {\r\n\r\n\t/*\r\n\tstatic getInteractiveGeometry() {\r\n\t\treturn ModelModelComponent.interactiveGeometry || (ModelModelComponent.interactiveGeometry = new THREE.SphereBufferGeometry(1, 8, 8));\r\n\t}\r\n\t*/\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\tset freezed(freezed) {\r\n\t\tif (this.freezed_ !== freezed) {\r\n\t\t\tthis.freezed_ = freezed;\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tif (mesh) {\r\n\t\t\t\tmesh.traverse((child) => {\r\n\t\t\t\t\tif (child.isInteractiveMesh) {\r\n\t\t\t\t\t\tchild.freezed = freezed;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.progress = null;\r\n\t\tthis.isPresenting = false;\r\n\t\t/*\r\n\t\tif (this.view.type.name === ViewType.Model.name) {\r\n\t\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\t\tvrService.session$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t).subscribe((session) => {\r\n\t\t\t\tthis.onUpdateVRSession(session);\r\n\t\t\t});\r\n\t\t}\r\n\t\t*/\r\n\t\tMenuService.active$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(active => this.freezed = active);\r\n\t\t// console.log('ModelModelComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.model;\r\n\t\tthis.loadGlb(environment.getPath(this.item.asset.folder), this.item.asset.file, (mesh, animations) => {\r\n\t\t\tthis.onGlbLoaded(mesh, animations, mount, dismount);\r\n\t\t});\r\n\t}\r\n\r\n\tloadGlb(path, file, callback) {\r\n\t\tconst renderer = this.host.renderer;\r\n\t\t// const roughnessMipmapper = new RoughnessMipmapper(renderer); // optional\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\t// console.log('progressRef');\r\n\t\tconst loader = new THREE.GLTFLoader().setPath(path);\r\n\t\t// Optional: Provide a DRACOLoader instance to decode compressed mesh data\r\n\t\tconst decoderPath = `${environment.assets}js/draco/`;\r\n\t\t// console.log(decoderPath);\r\n\t\tconst dracoLoader = new THREE.DRACOLoader();\r\n\t\tdracoLoader.setDecoderPath(decoderPath);\r\n\t\tloader.setDRACOLoader(dracoLoader);\r\n\t\tloader.load(file, (glb) => {\r\n\t\t\t/*\r\n\t\t\tglb.scene.traverse((child) => {\r\n\t\t\t\tif (child.isMesh) {\r\n\t\t\t\t\t// roughnessMipmapper.generateMipmaps(child.material);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(glb.scene, glb.animations);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t\t// this.progress = null;\r\n\t\t\t// this.pushChanges();\r\n\t\t\t// roughnessMipmapper.dispose();\r\n\t\t}, (progressEvent) => {\r\n\t\t\t/*\r\n\t\t\tlet value = this.progress ? this.progress.value : 0;\r\n\t\t\tif (progressEvent.lengthComputable) {\r\n\t\t\t\tvalue = Math.round(progressEvent.loaded / progressEvent.total * 100);\r\n\t\t\t} else {\r\n\t\t\t\tvalue = Math.floor(Math.min(100, value + 0.1));\r\n\t\t\t}\r\n\t\t\tthis.progress = { value, title: `${value}%` };\r\n\t\t\t// console.log('progressEvent', progressEvent.loaded, progressEvent.total);\r\n\t\t\tthis.pushChanges();\r\n\t\t\t*/\r\n\t\t\tLoaderService.setProgress(progressRef, progressEvent.loaded, progressEvent.total);\r\n\t\t});\r\n\t}\r\n\r\n\tparseAnimations(mesh, animations) {\r\n\t\t// animations\r\n\t\t// console.log('ModelModelComponent.onGlbLoaded', 'animations', animations);\r\n\t\tconst actionIndex = this.actionIndex = -1;\r\n\t\tconst actions = this.actions = [];\r\n\t\tif (animations && animations.length) {\r\n\t\t\tconst clock = this.clock = new THREE.Clock();\r\n\t\t\tconst mixer = this.mixer = new THREE.AnimationMixer(mesh);\r\n\t\t\tmixer.timeScale = 1;\r\n\t\t\tanimations.forEach(animation => {\r\n\t\t\t\tconst action = mixer.clipAction(animation);\r\n\t\t\t\taction.enabled = true;\r\n\t\t\t\taction.setEffectiveTimeScale(1);\r\n\t\t\t\taction.setEffectiveWeight(1);\r\n\t\t\t\t// action.setLoop(THREE.LoopPingPong);\r\n\t\t\t\taction.setLoop(THREE.LoopRepeat);\r\n\t\t\t\t// action.clampWhenFinished = true; // pause on last frame\r\n\t\t\t\tactions.push(action);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonClipToggle() {\r\n\t\tconst actions = this.actions;\r\n\t\tif (actions.length === 1) {\r\n\t\t\tconst action = actions[0];\r\n\t\t\tif (this.actionIndex === -1) {\r\n\t\t\t\tthis.actionIndex = 0;\r\n\t\t\t\tif (action.paused || action.timeScale === 0) {\r\n\t\t\t\t\taction.paused = false;\r\n\t\t\t\t} else {\r\n\t\t\t\t\taction.play();\r\n\t\t\t\t}\r\n\t\t\t} else if (this.actionIndex === 0) {\r\n\t\t\t\tthis.actionIndex = -1;\r\n\t\t\t\taction.halt(0.3);\r\n\t\t\t}\r\n\t\t} else if (actions.length > 1) {\r\n\t\t\tif (this.actionIndex > -1 && this.actionIndex < actions.length) {\r\n\t\t\t\tconst previousClip = actions[this.actionIndex];\r\n\t\t\t\tpreviousClip.halt(0.3);\r\n\t\t\t}\r\n\t\t\tthis.actionIndex ++;\r\n\t\t\tif (this.actionIndex === actions.length) {\r\n\t\t\t\tthis.actionIndex = -1;\r\n\t\t\t\t// nothing\r\n\t\t\t} else {\r\n\t\t\t\tconst action = actions[this.actionIndex];\r\n\t\t\t\t// console.log(this.actionIndex, action);\r\n\t\t\t\tif (action.paused) {\r\n\t\t\t\t\taction.paused = false;\r\n\t\t\t\t}\r\n\t\t\t\tif (action.timeScale === 0) {\r\n\t\t\t\t\taction.timeScale = 1;\r\n\t\t\t\t}\r\n\t\t\t\taction.play();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonGlbLoaded(mesh, animations, mount, dismount) {\r\n\t\t// animations\r\n\t\tthis.parseAnimations(mesh, animations);\r\n\t\t// scale\r\n\t\tconst box = new THREE.Box3().setFromObject(mesh);\r\n\t\tconst size = box.max.clone().sub(box.min);\r\n\t\tconst max = Math.max(size.x, size.y, size.z);\r\n\t\tconst scale = 2 / max; //1.7\r\n\t\tmesh.scale.set(scale, scale, scale);\r\n\t\t// repos\r\n\t\tlet dummy;\r\n\t\tconst view = this.view;\r\n\t\tconst item = this.item;\r\n\t\tif (view.type.name === ViewType.Model.name) {\r\n\t\t\t// this.onUpdateVRSession(this.vrService.currentSession);\r\n\t\t\tdummy = new THREE.Group();\r\n\t\t\tdummy.add(mesh);\r\n\t\t\tbox.setFromObject(dummy);\r\n\t\t\tconst center = box.getCenter(new THREE.Vector3());\r\n\t\t\tdummy.position.set(\r\n\t\t\t\tmesh.position.x - center.x,\r\n\t\t\t\tmesh.position.y - center.y,\r\n\t\t\t\tmesh.position.z - center.z + (this.host.renderer.xr.isPresenting ? -2 : 0),\r\n\t\t\t\t// mesh.position.z - center.z,\r\n\t\t\t);\r\n\t\t\tconst endY = dummy.position.y;\r\n\t\t\tconst from = { tween: 1 };\r\n\t\t\tconst onUpdate = () => {\r\n\t\t\t\tdummy.position.y = endY + 3 * from.tween;\r\n\t\t\t\tdummy.rotation.y = 0 + Math.PI * from.tween;\r\n\t\t\t};\r\n\t\t\tonUpdate();\r\n\t\t\tthis.makeInteractive(mesh);\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 1.5,\r\n\t\t\t\ttween: 0,\r\n\t\t\t\tdelay: 0.1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: onUpdate,\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\tthis.updateHelper();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tbox.setFromObject(mesh);\r\n\t\t\tconst center = box.getCenter(new THREE.Vector3());\r\n\t\t\tmesh.position.set(\r\n\t\t\t\t- center.x,\r\n\t\t\t\t- center.y,\r\n\t\t\t\t- center.z,\r\n\t\t\t);\r\n\t\t\tdummy = new THREE.Group();\r\n\t\t\tdummy.add(mesh);\r\n\t\t\tif (item.position) {\r\n\t\t\t\tdummy.position.fromArray(item.position);\r\n\t\t\t}\r\n\t\t\tif (item.rotation) {\r\n\t\t\t\tdummy.rotation.fromArray(item.rotation);\r\n\t\t\t}\r\n\t\t\tif (item.scale) {\r\n\t\t\t\tdummy.scale.fromArray(item.scale);\r\n\t\t\t}\r\n\t\t\tthis.makeInteractive(mesh);\r\n\t\t\t/*\r\n\t\t\tconst geometry = ModelModelComponent.getInteractiveGeometry();\r\n\t\t\tconst sphere = new InteractiveMesh(geometry, new THREE.MeshBasicMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\t// wireframe: true,\r\n\t\t\t\t// opacity: 1.0,\r\n\t\t\t\topacity: 0.0,\r\n\t\t\t\tcolor: 0x00ffff,\r\n\t\t\t}));\r\n\t\t\tconst radius = max * scale / 1.7;\r\n\t\t\tsphere.scale.set(radius, radius, radius);\r\n\t\t\tsphere.name = `[model] ${this.item.id}`;\r\n\t\t\t// sphere.depthTest = false;\r\n\t\t\tsphere.renderOrder = 0;\r\n\t\t\tdummy.add(sphere);\r\n\t\t\tsphere.on('down', () => {\r\n\t\t\t\t// console.log('ModelModelComponent.down');\r\n\t\t\t\tthis.down.next(this);\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tthis.updateHelper();\r\n\t\t}\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(dummy, this.item);\r\n\t\t\tthis.freezed = MenuService.active;\r\n\t\t}\r\n\t\t/*\r\n\t\tthis.progress = null;\r\n\t\tthis.pushChanges();\r\n\t\t*/\r\n\t}\r\n\r\n\t/*\r\n\tonUpdateVRSession(session) {\r\n\t\tconst mesh = this.mesh;\r\n\t\tif (session && mesh) {\r\n\t\t\tmesh.position.z = -2;\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\trender(time, tick) {\r\n\t\tconst view = this.view;\r\n\t\tconst item = this.item;\r\n\t\tconst mesh = this.mesh;\r\n\t\tconst isPresenting = this.host.renderer.xr.isPresenting;\r\n\t\tconst group = this.group;\r\n\t\tif (mesh) {\r\n\t\t\tif (view.type.name === ViewType.Model.name) {\r\n\t\t\t\tif (this.isPresenting !== isPresenting) {\r\n\t\t\t\t\tthis.isPresenting = isPresenting;\r\n\t\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\t\tmesh.position.x = 0;\r\n\t\t\t\t\t\tmesh.position.y = 0;\r\n\t\t\t\t\t\tmesh.position.z = -2;\r\n\t\t\t\t\t\tmesh.rotation.y = 0;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tmesh.position.x = 0;\r\n\t\t\t\t\t\tmesh.position.y = 0;\r\n\t\t\t\t\t\tmesh.position.z = 0;\r\n\t\t\t\t\t\tmesh.rotation.y = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\tmesh.rotation.y -= (Math.PI / 180 / 60 * 5);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\tmesh.rotation.y -= (Math.PI / 180 / 60 * 5);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tconst mixer = this.mixer;\r\n\t\tconst clock = this.clock;\r\n\t\tif (mixer) {\r\n\t\t\tconst delta = clock.getDelta();\r\n\t\t\tmixer.update(delta);\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelModelComponent.onUpdate', item);\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tif (item.position) {\r\n\t\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\t}\r\n\t\t\tif (item.rotation) {\r\n\t\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t\t}\r\n\t\t\tif (item.scale) {\r\n\t\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelModelComponent.onUpdateAsset', item);\r\n\t\tthis.loadGlb(environment.getPath(item.asset.folder), item.asset.file, (mesh, animations) => {\r\n\t\t\tthis.onGlbLoaded(mesh, animations, (mesh, item) => this.onMount(mesh, item), (mesh, item) => this.onDismount(mesh, item));\r\n\t\t});\r\n\t\t/*\r\n\t\tthis.mesh.updateByItem(item);\r\n\t\tthis.mesh.load(() => {\r\n\t\t\t// console.log('ModelModelComponent.mesh.load.complete');\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\t// console.log('ModelModelComponent.onDragMove', position);\r\n\t\tthis.editing = true;\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(4);\r\n\t\t\t// this.mesh.lookAt(ModelModelComponent.ORIGIN);\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\t// console.log('ModelModelComponent.onDragEnd');\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tthis.item.position = this.mesh.position.toArray();\r\n\t\t\tthis.item.rotation = this.mesh.rotation.toArray();\r\n\t\t\tthis.item.scale = this.mesh.scale.toArray();\r\n\t\t}\r\n\t\tthis.editing = false;\r\n\t}\r\n\r\n\tstatic getInteractiveDescriptors() {\r\n\t\tlet descriptors = ModelModelComponent.interactiveDescriptors;\r\n\t\tif (!descriptors) {\r\n\t\t\tconst freezableDescriptors = Object.getOwnPropertyDescriptors(FreezableMesh.prototype);\r\n\t\t\tconst emittableDescriptors = Object.getOwnPropertyDescriptors(EmittableMesh.prototype);\r\n\t\t\tconst interactiveDescriptors = Object.getOwnPropertyDescriptors(InteractiveMesh.prototype);\r\n\t\t\tdescriptors = Object.assign({}, freezableDescriptors, emittableDescriptors, interactiveDescriptors);\r\n\t\t\tModelModelComponent.interactiveDescriptors = descriptors;\r\n\t\t}\r\n\t\treturn descriptors;\r\n\t}\r\n\r\n\tmakeInteractive(mesh) {\r\n\t\tconst interactiveDescriptors = ModelModelComponent.getInteractiveDescriptors();\r\n\t\tmesh.traverse((child) => {\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tObject.keys(interactiveDescriptors).forEach(key => {\r\n\t\t\t\t\tif (key !== 'constructor') {\r\n\t\t\t\t\t\tObject.defineProperty(child, key, interactiveDescriptors[key]);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tchild.freezed = false;\r\n\t\t\t\tchild.events = {};\r\n\t\t\t\tchild.depthTest = true;\r\n\t\t\t\tchild.over_ = false;\r\n\t\t\t\tchild.down_ = false;\r\n\t\t\t\tInteractive.items.push(child);\r\n\t\t\t\tchild.on('down', () => {\r\n\t\t\t\t\t// console.log('ModelModelComponent.down', child);\r\n\t\t\t\t\tthis.onClipToggle();\r\n\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tmakeInteractive__(mesh) {\r\n\t\tlet newChild = null;\r\n\t\tmesh.traverse((child) => {\r\n\t\t\tif (newChild === null && child.isMesh && !(child.isInteractiveMesh)) {\r\n\t\t\t\t// roughnessMipmapper.generateMipmaps(child.material);\r\n\t\t\t\tconst parent = child.parent;\r\n\t\t\t\tnewChild = new InteractiveMesh(child.geometry, child.material);\r\n\t\t\t\t// newChild.depthTest = true;\r\n\t\t\t\t// newChild.renderOrder = 0;\r\n\t\t\t\tnewChild.name = child.name;\r\n\t\t\t\tnewChild.position.copy(child.position);\r\n\t\t\t\tnewChild.rotation.copy(child.rotation);\r\n\t\t\t\tnewChild.scale.copy(child.scale);\r\n\t\t\t\tnewChild.on('down', () => {\r\n\t\t\t\t\t// console.log('ModelModelComponent.down');\r\n\t\t\t\t\tthis.onClipToggle();\r\n\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t});\r\n\t\t\t\tparent.remove(child);\r\n\t\t\t\tparent.add(newChild);\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (newChild !== null) {\r\n\t\t\tthis.makeInteractive(mesh);\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n}\r\n\r\nModelModelComponent.ORIGIN = new THREE.Vector3();\r\n\r\nModelModelComponent.meta = {\r\n\tselector: '[model-model]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down'],\r\n\tinputs: ['item', 'view'],\r\n};\r\n","import { environment } from '../../environment';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport const NavModeType = {\r\n\tNone: 'none',\r\n\tMove: 'move',\r\n\tInfo: 'info',\r\n\tPoint: 'point',\r\n\tTitle: 'title',\r\n};\r\n\r\nexport default class ModelNavComponent extends ModelEditableComponent {\r\n\r\n\tstatic getNavGeometry() {\r\n\t\t// const geometry = new THREE.PlaneBufferGeometry(3, 2, 2, 2);\r\n\t\t// const geometry = new THREE.SphereBufferGeometry(3, 12, 12);\r\n\t\treturn ModelNavComponent.navGeometry || (ModelNavComponent.navGeometry = new THREE.SphereBufferGeometry(3, 12, 12));\r\n\t}\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelNavComponent.loader || (ModelNavComponent.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getTexturePoint() {\r\n\t\treturn ModelNavComponent.texturePoint || (ModelNavComponent.texturePoint = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-point.png')));\r\n\t}\r\n\r\n\tstatic getTextureMove() {\r\n\t\treturn ModelNavComponent.textureMove || (ModelNavComponent.textureMove = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-more.png')));\r\n\t}\r\n\r\n\tstatic getTextureInfo() {\r\n\t\treturn ModelNavComponent.textureInfo || (ModelNavComponent.textureInfo = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-info.png')));\r\n\t}\r\n\r\n\tstatic getTexture(mode) {\r\n\t\tlet texture;\r\n\t\tswitch (mode) {\r\n\t\t\tcase NavModeType.Move:\r\n\t\t\t\ttexture = this.getTextureMove();\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Info:\r\n\t\t\t\ttexture = this.getTextureInfo();\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Point:\r\n\t\t\tcase NavModeType.Title:\r\n\t\t\t\ttexture = this.getTexturePoint();\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tstatic getTitleTexture(item, mode) {\r\n\t\tlet texture;\r\n\t\tif (mode === NavModeType.Title) {\r\n\t\t\tconst text = item.title;\r\n\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\tcanvas.width = 512;\r\n\t\t\tcanvas.height = 32;\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `28px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tlet w = metrics.width + 8;\r\n\t\t\tw = Math.pow(2, Math.ceil(Math.log(w) / Math.log(2)));\r\n\t\t\tconst x = w / 2;\r\n\t\t\tconst y = 16;\r\n\t\t\tcanvas.width = w;\r\n\t\t\tctx.font = `28px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';\r\n\t\t\tctx.lineWidth = 6;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with \"bevel\" & \"round\" for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, x, y);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, x, y);\r\n\t\t\ttexture = new THREE.CanvasTexture(canvas);\r\n\t\t}\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tstatic getNavMode(item, view) {\r\n\t\tlet mode = NavModeType.None;\r\n\t\tif (item.viewId !== view.id) {\r\n\t\t\tmode = NavModeType.Move;\r\n\t\t\tif (this.isValidText(item.title)) {\r\n\t\t\t\tmode = NavModeType.Title;\r\n\t\t\t}\r\n\t\t\tif (this.isValidText(item.abstract) ||\r\n\t\t\t\t(item.asset && item.asset.id) ||\r\n\t\t\t\t(item.link && item.link.href)) {\r\n\t\t\t\tmode = NavModeType.Point;\r\n\t\t\t}\r\n\t\t} else if (this.isValidText(item.title) ||\r\n\t\t\tthis.isValidText(item.abstract) ||\r\n\t\t\t(item.asset && item.asset.id) ||\r\n\t\t\t(item.link && item.link.href)) {\r\n\t\t\tmode = NavModeType.Info;\r\n\t\t}\r\n\t\treturn mode;\r\n\t}\r\n\r\n\tstatic isValidText(text) {\r\n\t\treturn text && text.length > 0;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t/*\r\n\t\tthis.debouncedOver$ = new ReplaySubject(1).pipe(\r\n\t\t\tauditTime(250),\r\n\t\t\ttap(event => this.over.next(event)),\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t);\r\n\t\tthis.debouncedOver$.subscribe();\r\n\t\t*/\r\n\t\t// console.log('ModelNavComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.nav;\r\n\t\tconst mode = this.mode = ModelNavComponent.getNavMode(this.item, this.view);\r\n\t\tif (mode === NavModeType.None) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst nav = new THREE.Group();\r\n\t\tconst position = new THREE.Vector3().set(...this.item.position).normalize().multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\tnav.position.set(position.x, position.y, position.z);\r\n\r\n\t\tthis.onCreateSprites(nav);\r\n\r\n\t\tconst geometry = ModelNavComponent.getNavGeometry();\r\n\t\tconst sphere = new InteractiveMesh(geometry, new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.0,\r\n\t\t\tcolor: 0x00ffff,\r\n\t\t}));\r\n\t\tsphere.name = `[nav] ${this.item.id}`;\r\n\t\tsphere.lookAt(ModelNavComponent.ORIGIN);\r\n\t\tsphere.depthTest = false;\r\n\t\tsphere.renderOrder = 0;\r\n\t\tnav.add(sphere);\r\n\t\tsphere.on('over', () => {\r\n\t\t\t// console.log('ModelNavComponent.over');\r\n\t\t\t/*\r\n\t\t\tif ((mode !== NavModeType.Move && mode !== NavModeType.Title) && !this.editing) {\r\n\t\t\t\tthis.over.next(this);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.over.next(this);\r\n\t\t\tconst icon = this.icon;\r\n\t\t\tconst from = { scale: icon.scale.x };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.35,\r\n\t\t\t\tscale: 0.05,\r\n\t\t\t\tdelay: 0,\r\n\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\ticon.scale.set(from.scale, from.scale, from.scale);\r\n\t\t\t\t},\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (!this.editing) {\r\n\t\t\t\t\t\tthis.over.next(this);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t\tsphere.on('out', () => {\r\n\t\t\tthis.out.next(this);\r\n\t\t\tconst icon = this.icon;\r\n\t\t\tconst from = { scale: icon.scale.x };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.35,\r\n\t\t\t\tscale: 0.03,\r\n\t\t\t\tdelay: 0,\r\n\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\ticon.scale.set(from.scale, from.scale, from.scale);\r\n\t\t\t\t},\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tthis.out.next(this);\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t\tsphere.on('down', () => {\r\n\t\t\tthis.down.next(this);\r\n\t\t});\r\n\t\tconst from = { opacity: 0 };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.7,\r\n\t\t\topacity: 1,\r\n\t\t\tdelay: 0.5 + 0.1 * this.item.index,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\toverwrite: true,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.materials.forEach(material => {\r\n\t\t\t\t\tmaterial.opacity = from.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(nav, this.item);\r\n\t\t}\r\n\t}\r\n\r\n\tonCreateSprites(mesh, opacity = 0) {\r\n\t\tthis.onRemoveSprite(this.icon);\r\n\t\tthis.onRemoveSprite(this.title);\r\n\t\tconst mode = this.mode = ModelNavComponent.getNavMode(this.item, this.view);\r\n\t\tif (mode === NavModeType.None) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst map = ModelNavComponent.getTexture(mode);\r\n\t\tmap.disposable = false;\r\n\t\tmap.encoding = THREE.sRGBEncoding;\r\n\t\tconst material = new THREE.SpriteMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tmap: map,\r\n\t\t\tsizeAttenuation: false,\r\n\t\t\topacity: opacity,\r\n\t\t\t// color: 0xff0000,\r\n\t\t});\r\n\t\tconst materials = [material];\r\n\t\tconst icon = this.icon = new THREE.Sprite(material);\r\n\t\ticon.scale.set(0.03, 0.03, 0.03);\r\n\t\tmesh.add(icon);\r\n\t\tlet titleMaterial;\r\n\t\tconst titleTexture = ModelNavComponent.getTitleTexture(this.item, mode);\r\n\t\tif (titleTexture) {\r\n\t\t\ttitleMaterial = new THREE.SpriteMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\tmap: titleTexture,\r\n\t\t\t\tsizeAttenuation: false,\r\n\t\t\t\topacity: opacity,\r\n\t\t\t\t// color: 0xff0000,\r\n\t\t\t});\r\n\t\t\t// console.log(titleTexture);\r\n\t\t\tconst image = titleTexture.image;\r\n\t\t\tconst title = this.title = new THREE.Sprite(titleMaterial);\r\n\t\t\ttitle.scale.set(0.03 * image.width / image.height, 0.03, 0.03);\r\n\t\t\ttitle.position.set(0, -3.5, 0);\r\n\t\t\tmesh.add(title);\r\n\t\t\tmaterials.push(titleMaterial);\r\n\t\t}\r\n\t\tthis.materials = materials;\r\n\t}\r\n\r\n\tonRemoveSprite(sprite) {\r\n\t\tif (sprite) {\r\n\t\t\tif (sprite.parent) {\r\n\t\t\t\tsprite.parent.remove(sprite);\r\n\t\t\t}\r\n\t\t\tif (sprite.material.map && sprite.material.map.disposable !== false) {\r\n\t\t\t\tsprite.material.map.dispose();\r\n\t\t\t}\r\n\t\t\tsprite.material.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tInteractive.dispose(this.sphere);\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\tshouldShowPanel() {\r\n\t\treturn (!this.editing && this.mode !== NavModeType.Move && this.mode !== NavModeType.Title);\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\tthis.item = item;\r\n\t\tthis.onCreateSprites(this.mesh, 1);\r\n\t\tconst position = new THREE.Vector3().set(...item.position).normalize().multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t// console.log('onUpdate', item, mesh.position);\r\n\t\tthis.updateHelper();\r\n\t\t/*\r\n\t\tthis.onCreate(\r\n\t\t\t(mesh, item) => this.onMount(mesh, item),\r\n\t\t\t(mesh, item) => this.onDismount(mesh, item)\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\tthis.editing = true;\r\n\t\tthis.item.showPanel = false;\r\n\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\tthis.item.position = new THREE.Vector3().copy(this.mesh.position).normalize().toArray();\r\n\t\tthis.editing = false;\r\n\t}\r\n}\r\n\r\nModelNavComponent.ORIGIN = new THREE.Vector3();\r\nModelNavComponent.RADIUS = 100;\r\n\r\nModelNavComponent.meta = {\r\n\tselector: '[model-nav]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['over', 'out', 'down'],\r\n\tinputs: ['item', 'view'],\r\n};\r\n","import EmittableSprite from './emittable.sprite';\r\nimport Interactive from './interactive';\r\n\r\nexport default class InteractiveSprite extends EmittableSprite {\r\n\r\n\tconstructor(material) {\r\n\t\tsuper(material);\r\n\t\tthis.depthTest = true;\r\n\t\tthis.over_ = false;\r\n\t\tthis.down_ = false;\r\n\t\tInteractive.items.push(this);\r\n\t}\r\n\r\n\tget isInteractiveSprite() {\r\n\t\treturn true;\r\n\t}\r\n\r\n\tget over() {\r\n\t\treturn this.over_;\r\n\t}\r\n\tset over(over) {\r\n\t\tif (this.over_ != over) {\r\n\t\t\tthis.over_ = over;\r\n\t\t\t/*\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('hit', this);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('over', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('out', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget down() {\r\n\t\treturn this.down_;\r\n\t}\r\n\tset down(down) {\r\n\t\tdown = down && this.over;\r\n\t\tif (this.down_ != down) {\r\n\t\t\tthis.down_ = down;\r\n\t\t\tif (down) {\r\n\t\t\t\tthis.emit('down', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('up', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","import FreezableSprite from \"./freezable.sprite\";\r\n\r\nexport default class EmittableSprite extends FreezableSprite {\r\n\r\n\tconstructor(material) {\r\n\t\tmaterial = material || new THREE.SpriteMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(material);\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","\r\nexport default class FreezableSprite extends THREE.Sprite {\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\r\n\tset freezed(freezed) {\r\n\t\t// !!! cycle through freezable and not freezable\r\n\t\tthis.freezed_ = freezed;\r\n\t\tthis.children.filter(x => x.__lookupGetter__('freezed')).forEach(x => x.freezed = freezed);\r\n\t}\r\n\r\n\tconstructor(material) {\r\n\t\tmaterial = material || new THREE.SpriteMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(material);\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n\tfreeze() {\r\n\t\tthis.freezed = true;\r\n\t}\r\n\r\n\tunfreeze() {\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n}\r\n","import html2canvas from 'html2canvas';\r\nimport { getContext } from 'rxcomp';\r\nimport DragService from '../../drag/drag.service';\r\nimport { environment } from '../../environment';\r\nimport InteractiveSprite from '../interactive/interactive.sprite';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelPanelComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelPanelComponent.onInit', this.item);\r\n\t}\r\n\r\n\tonView() {\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.getCanvasTexture(node).then(texture => {\r\n\t\t\tif (this.mesh) {\r\n\t\t\t\tconst scale = 0.2 * (this.item.asset ? 1.5 : 1.0);\r\n\t\t\t\tconst aspect = texture.width / texture.height;\r\n\t\t\t\tconst width = ModelPanelComponent.PANEL_RADIUS * scale;\r\n\t\t\t\tconst height = ModelPanelComponent.PANEL_RADIUS * scale / aspect;\r\n\t\t\t\tconst dy = width * 0.25;\r\n\t\t\t\tconst position = this.item.mesh.position.normalize().multiplyScalar(ModelPanelComponent.PANEL_RADIUS);\r\n\t\t\t\tconst material = new THREE.SpriteMaterial({\r\n\t\t\t\t\tdepthTest: false,\r\n\t\t\t\t\ttransparent: true,\r\n\t\t\t\t\topacity: 0,\r\n\t\t\t\t\tmap: texture.map,\r\n\t\t\t\t\tsizeAttenuation: false,\r\n\t\t\t\t});\r\n\t\t\t\tconst panel = this.panel = new InteractiveSprite(material);\r\n\t\t\t\tpanel.renderOrder = environment.renderOrder.panel;\r\n\t\t\t\tpanel.scale.set(0.02 * width, 0.02 * height, 1);\r\n\t\t\t\tpanel.position.set(position.x, position.y + (height + dy * 2), position.z);\r\n\t\t\t\tpanel.on('down', (event) => {\r\n\t\t\t\t\tconst xy = { x: parseInt(event.intersection.uv.x * node.offsetWidth), y: parseInt((1 - event.intersection.uv.y) * node.offsetHeight) };\r\n\t\t\t\t\t// console.log('ModelPanelComponent.down.xy', xy);\r\n\t\t\t\t\tconst link = Array.prototype.slice.call(node.querySelectorAll('.panel__link')).find(link => {\r\n\t\t\t\t\t\treturn xy.x >= link.offsetLeft && xy.y >= link.offsetTop && xy.x <= (link.offsetLeft + link.offsetWidth) && xy.y <= (link.offsetTop + link.offsetHeight);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log('ModelPanelComponent.down.link', link);\r\n\t\t\t\t\tif (link) {\r\n\t\t\t\t\t\tthis.down.next(link);\r\n\t\t\t\t\t\tconst rect = node.getBoundingClientRect();\r\n\t\t\t\t\t\tconst event = new MouseEvent('mouseup', {\r\n\t\t\t\t\t\t\tbutton: 0,\r\n\t\t\t\t\t\t\tbuttons: 0,\r\n\t\t\t\t\t\t\tclientX: xy.x + rect.left,\r\n\t\t\t\t\t\t\tclientY: xy.y + rect.top,\r\n\t\t\t\t\t\t\tmovementX: 0,\r\n\t\t\t\t\t\t\tmovementY: 0,\r\n\t\t\t\t\t\t\trelatedTarget: link,\r\n\t\t\t\t\t\t\tscreenX: xy.x,\r\n\t\t\t\t\t\t\tscreenY: xy.y,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t// console.log('ModelPanelComponent.dispatchEvent', event);\r\n\t\t\t\t\t\tlink.dispatchEvent(event);\r\n\t\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\t\tDragService.dismissEvent(event, DragService.events$, DragService.dismiss$, DragService.downEvent);\r\n\t\t\t\t\t\t}, 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tthis.mesh.add(panel);\r\n\t\t\t\tconst from = { value: 0 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\tvalue: 1,\r\n\t\t\t\t\tdelay: 0.0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tpanel.position.set(position.x, position.y + (height + dy * 2) - dy * from.value, position.z);\r\n\t\t\t\t\t\tpanel.lookAt(ModelPanelComponent.ORIGIN);\r\n\t\t\t\t\t\tpanel.material.opacity = from.value;\r\n\t\t\t\t\t\tpanel.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}, error => {\r\n\t\t\tconsole.log('ModelPanelComponent.getCanvasTexture.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\t// console.log('ModelPanelComponent.onDestroy');\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\timagesLoaded() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (node) {\r\n\t\t\tconst images = Array.prototype.slice.call(node.querySelectorAll('img'));\r\n\t\t\tconst promises = images.map(x => new Promise(function(resolve, reject) {\r\n\t\t\t\tconst cors = x.src && x.src.indexOf(location.origin) === -1;\r\n\t\t\t\tif (x.complete) {\r\n\t\t\t\t\treturn setTimeout(() => {\r\n\t\t\t\t\t\tresolve(cors);\r\n\t\t\t\t\t}, 10);\r\n\t\t\t\t}\r\n\t\t\t\tconst removeListeners = () => {\r\n\t\t\t\t\tx.removeEventListener('load', onLoad);\r\n\t\t\t\t\tx.removeEventListener('error', onError);\r\n\t\t\t\t};\r\n\t\t\t\tconst onLoad = () => {\r\n\t\t\t\t\t// console.log('loaded!');\r\n\t\t\t\t\tremoveListeners();\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tresolve(cors);\r\n\t\t\t\t\t}, 10);\r\n\t\t\t\t};\r\n\t\t\t\tconst onError = () => {\r\n\t\t\t\t\t// console.log('error!');\r\n\t\t\t\t\tremoveListeners();\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t};\r\n\t\t\t\tconst addListeners = () => {\r\n\t\t\t\t\tx.addEventListener('load', onLoad);\r\n\t\t\t\t\tx.addEventListener('error', onError);\r\n\t\t\t\t};\r\n\t\t\t\taddListeners();\r\n\t\t\t}));\r\n\t\t\tif (promises.length) {\r\n\t\t\t\treturn Promise.all(promises);\r\n\t\t\t} else {\r\n\t\t\t\treturn Promise.resolve();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tgetCanvasTexture(node) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tif (this.item.panelTexture) {\r\n\t\t\t\t\tresolve(this.item.panelTexture);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.imagesLoaded().then((results) => {\r\n\t\t\t\t\t\tconst context = getContext(this);\r\n\t\t\t\t\t\tif (context && context.node) {\r\n\t\t\t\t\t\t\tnode = context.node;\r\n\t\t\t\t\t\t\tconst useCORS = results && (results.find(x => x === true) != null); // !!! keep loose equality\r\n\t\t\t\t\t\t\t// console.log('ModelPanelComponent.getCanvasTexture.useCORS', useCORS);\r\n\t\t\t\t\t\t\thtml2canvas(node, {\r\n\t\t\t\t\t\t\t\tbackgroundColor: '#ffffff00',\r\n\t\t\t\t\t\t\t\tscale: 2,\r\n\t\t\t\t\t\t\t\tuseCORS,\r\n\t\t\t\t\t\t\t\t// logging: true,\r\n\t\t\t\t\t\t\t}).then(canvas => {\r\n\t\t\t\t\t\t\t\t// !!!\r\n\t\t\t\t\t\t\t\t// document.body.appendChild(canvas);\r\n\t\t\t\t\t\t\t\t// const alpha = this.getAlphaFromCanvas(canvas);\r\n\t\t\t\t\t\t\t\t// document.body.appendChild(alpha);\r\n\t\t\t\t\t\t\t\tconst map = new THREE.CanvasTexture(canvas);\r\n\t\t\t\t\t\t\t\t// const alphaMap = new THREE.CanvasTexture(alpha);\r\n\t\t\t\t\t\t\t\t// console.log(canvas.width, canvas.height);\r\n\t\t\t\t\t\t\t\tthis.item.panelTexture = {\r\n\t\t\t\t\t\t\t\t\tmap: map,\r\n\t\t\t\t\t\t\t\t\twidth: canvas.width,\r\n\t\t\t\t\t\t\t\t\theight: canvas.height,\r\n\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\tresolve(this.item.panelTexture);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}, 1); // keep it for childnode images to be compiled\r\n\t\t});\r\n\t}\r\n}\r\n\r\nModelPanelComponent.ORIGIN = new THREE.Vector3();\r\nModelPanelComponent.PANEL_RADIUS = 99;\r\n\r\nModelPanelComponent.meta = {\r\n\tselector: '[model-panel]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['over', 'out', 'down'],\r\n\tinputs: ['item'],\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelPictureComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelPictureComponent.onInit');\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n}\r\n\r\nModelPictureComponent.meta = {\r\n\tselector: '[model-picture]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { filter, take, takeUntil } from 'rxjs/operators';\r\nimport MediaMesh from '../media/media-mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport default class ModelPlaneComponent extends ModelEditableComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelPlaneComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst item = this.item;\r\n\t\tconst items = this.items;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(1, 1, 2, 2);\r\n\t\tlet mesh;\r\n\t\tlet subscription;\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((streamId) => {\r\n\t\t\tif (this.streamId !== streamId) {\r\n\t\t\t\tthis.streamId = streamId;\r\n\t\t\t\t// !!! called by ModelComponent\r\n\t\t\t\t/*\r\n\t\t\t\tif (mesh) {\r\n\t\t\t\t\tdismount(mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tif (subscription) {\r\n\t\t\t\t\tsubscription.unsubscribe();\r\n\t\t\t\t\tsubscription = null;\r\n\t\t\t\t}\r\n\t\t\t\tif (streamId || !item.asset) {\r\n\t\t\t\t\titem.streamId = streamId;\r\n\t\t\t\t\tmesh = new MediaMesh(item, items, geometry);\r\n\t\t\t\t\tif (item.position) {\r\n\t\t\t\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.rotation) {\r\n\t\t\t\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.scale) {\r\n\t\t\t\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tmesh.load(() => {\r\n\t\t\t\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\t\t\t\tmount(mesh, item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsubscription = mesh.events$().pipe(\r\n\t\t\t\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t\t\t\t).subscribe(() => { });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('down', () => {\r\n\t\t\t\t\t\t// console.log('ModelPanelComponent.down');\r\n\t\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('playing', (playing) => {\r\n\t\t\t\t\t\t// console.log('ModelPanelComponent.playing', playing);\r\n\t\t\t\t\t\tthis.play.next({ itemId: this.item.id, playing });\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (this.mesh) {\r\n\t\t\t\t\tdismount(this.mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('streamId', streamId, mesh);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.mesh.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelPlaneComponent.onUpdate', item);\r\n\t\tif (item.position) {\r\n\t\t\tmesh.position.fromArray(item.position);\r\n\t\t}\r\n\t\tif (item.rotation) {\r\n\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t}\r\n\t\tif (item.scale) {\r\n\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelPlaneComponent.onUpdateAsset', item);\r\n\t\tthis.mesh.updateByItem(item);\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\tfilter(streamId => streamId !== null),\r\n\t\t\ttake(1),\r\n\t\t).subscribe((streamId) => {\r\n\t\t\titem.streamId = streamId;\r\n\t\t\tthis.mesh.load(() => {\r\n\t\t\t\t// console.log('ModelPlaneComponent.mesh.load.complete');\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\t// console.log('ModelPlaneComponent.onDragMove', position);\r\n\t\tthis.item.showPanel = false;\r\n\t\tthis.editing = true;\r\n\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(20);\r\n\t\tthis.mesh.lookAt(ModelPlaneComponent.ORIGIN);\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\t// console.log('ModelPlaneComponent.onDragEnd');\r\n\t\tthis.item.position = this.mesh.position.toArray();\r\n\t\tthis.item.rotation = this.mesh.rotation.toArray();\r\n\t\tthis.item.scale = this.mesh.scale.toArray();\r\n\t\tthis.editing = false;\r\n\t}\r\n\r\n}\r\n\r\nModelPlaneComponent.ORIGIN = new THREE.Vector3();\r\nModelPlaneComponent.textures = {};\r\n\r\nModelPlaneComponent.meta = {\r\n\tselector: '[model-plane]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play'],\r\n\tinputs: ['item', 'items'],\r\n};\r\n","import { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport { ViewType } from '../../view/view';\r\nimport { PANORAMA_RADIUS } from '../panorama/panorama';\r\nimport VRService from '../vr.service';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport const LOADING_BANNER = { title: LabelPipe.transform('loading') };\r\nexport const WAITING_BANNER = { title: LabelPipe.transform('waiting_host') };\r\n\r\nconst PANEL_RADIUS = PANORAMA_RADIUS - 0.01;\r\n\r\nexport default class ModelProgressComponent extends ModelComponent {\r\n\r\n\tget title() {\r\n\t\treturn this.title_;\r\n\t}\r\n\tset title(title) {\r\n\t\tif (this.title_ !== title) {\r\n\t\t\tthis.title_ = title;\r\n\t\t\tif (title === WAITING_BANNER.title || (title !== '' && this.visible_)) {\r\n\t\t\t\tthis.updateProgress();\r\n\t\t\t\tthis.show();\r\n\t\t\t} else {\r\n\t\t\t\tthis.hide();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget visible() {\r\n\t\treturn this.visible_;\r\n\t}\r\n\tset visible(visible) {\r\n\t\tif (this.visible_ !== visible) {\r\n\t\t\tthis.visible_ = visible;\r\n\t\t\tif (visible && this.title_ !== '') {\r\n\t\t\t\tthis.updateProgress();\r\n\t\t\t\tthis.show();\r\n\t\t\t} else {\r\n\t\t\t\tthis.hide();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.title_ = '';\r\n\t\tthis.visible_ = this.host.renderer.xr.isPresenting;\r\n\t\tsuper.onInit();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => this.visible = session != null); // loose\r\n\t\t// this.progress = LoaderService.progress;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// console.log('ModelProgressComponent.onCreate');\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst mesh = this.createMesh(result);\r\n\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\tmount(mesh);\r\n\t\t\t}\r\n\t\t\tLoaderService.progress$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(progress => {\r\n\t\t\t\tif (progress.count) {\r\n\t\t\t\t\tthis.title = progress.value === 0 ? LOADING_BANNER.title : progress.title;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.title = this.getTitle();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tgetTitle() {\r\n\t\tif (this.view && this.view.type.name === ViewType.WaitingRoom.name) {\r\n\t\t\treturn WAITING_BANNER.title;\r\n\t\t} else {\r\n\t\t\treturn '';\r\n\t\t}\r\n\t}\r\n\r\n\tshow() {\r\n\t\tthis.mesh.add(this.banner);\r\n\t\tthis.material.opacity = 1;\r\n\t\tthis.material.needsUpdate = true;\r\n\t\t/*\r\n\t\tconst material = this.material;\r\n\t\tconst from = { value: material.opacity };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.5,\r\n\t\t\tvalue: 1,\r\n\t\t\tdelay: 0.0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\toverwrite: 'all',\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\thide() {\r\n\t\tthis.mesh.remove(this.banner);\r\n\t\tthis.material.opacity = 0;\r\n\t\tthis.material.needsUpdate = true;\r\n\t\t/*\r\n\t\tconst from = { value: material.opacity };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.5,\r\n\t\t\tvalue: 0,\r\n\t\t\tdelay: 0.0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\toverwrite: 'all',\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t},\r\n\t\t\tonComplete: () => {\r\n\t\t\t\tthis.mesh.remove(this.banner);\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tcreateMesh(result) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\t// const repeat = 24;\r\n\t\t// const aspect = (result.width * repeat) / result.height;\r\n\t\tconst arc = Math.PI / 180 * 360;\r\n\t\tconst width = PANEL_RADIUS * arc;\r\n\t\tconst height = width / 360 * 2.4;\r\n\t\tconst w = result.width * height / result.height;\r\n\t\tconst repeat = width / w;\r\n\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 80, 2, true, 0, arc);\r\n\t\tgeometry.scale(-1, 1, 1);\r\n\t\tconst texture = result.texture;\r\n\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\ttexture.repeat.x = repeat;\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\tconst material = this.material = new THREE.MeshBasicMaterial({\r\n\t\t\tmap: texture,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst banner = this.banner = new THREE.Mesh(geometry, material);\r\n\t\tmesh.userData = {\r\n\t\t\trender: () => {\r\n\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.02;\r\n\t\t\t\t// texture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t// material.needsUpdate = true;\r\n\t\t\t}\r\n\t\t};\r\n\t\treturn mesh;\r\n\t}\r\n\r\n\tupdateProgress() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\t// console.log('ModelProgressComponent.updateProgress', result);\r\n\t\t\tconst arc = Math.PI / 180 * 360;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / 360 * 2.4;\r\n\t\t\tconst w = result.width * height / result.height;\r\n\t\t\tconst repeat = width / w;\r\n\t\t\tthis.texture.repeat.x = repeat;\r\n\t\t});\r\n\t}\r\n\r\n\tgetCanvasTexture() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst MIN_W = 512;\r\n\t\t\tlet W = MIN_W;\r\n\t\t\tlet H = 64;\r\n\t\t\tconst F = Math.floor(H * 0.75);\r\n\t\t\tconst L = Math.floor(H * 0.05);\r\n\t\t\tlet canvas;\r\n\t\t\tif (this.canvas) {\r\n\t\t\t\tcanvas = this.canvas;\r\n\t\t\t} else {\r\n\t\t\t\tcanvas = this.canvas = document.createElement('canvas');\r\n\t\t\t\t// canvas.classList.add('canvas--debug');\r\n\t\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\t}\r\n\t\t\tcanvas.width = W;\r\n\t\t\tcanvas.height = H;\r\n\t\t\tconst text = this.title_;\r\n\t\t\t// console.log('ModelProgressComponent.getCanvasTexture', text);\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t// const ctx = text.material.map.image.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `300 ${F}px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tW = metrics.width + 8;\r\n\t\t\tW = Math.max(MIN_W, Math.pow(2, Math.ceil(Math.log(W) / Math.log(2))));\r\n\t\t\t// const x = W / 2;\r\n\t\t\t// const y = 16;\r\n\t\t\tcanvas.width = W;\r\n\t\t\tctx.clearRect(0, 0, W, H);\r\n\t\t\tctx.fillStyle = '#0000005A'; // 35% // '#000000C0'; // 75%\r\n\t\t\tctx.fillRect(0, 0, W, H);\r\n\t\t\tctx.font = `300 ${F}px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.35)';\r\n\t\t\tctx.lineWidth = L;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with \"bevel\" & \"round\" for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, W / 2, H / 2);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, W / 2, H / 2, W);\r\n\t\t\t// text.material.map.needsUpdate = true;\r\n\t\t\tlet texture;\r\n\t\t\tif (this.texture) {\r\n\t\t\t\ttexture = this.texture;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\ttexture = this.texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t}\r\n\t\t\t// console.log(F, L, W, H);\r\n\t\t\tresolve({ texture: texture, width: W, height: H });\r\n\t\t});\r\n\t}\r\n}\r\n\r\nModelProgressComponent.meta = {\r\n\tselector: '[model-progress]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['view'],\r\n};\r\n","import { environment } from '../../environment';\r\nimport MediaMesh from '../media/media-mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst USE_SHADOW = false;\r\n\r\nexport default class ModelRoomComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.progress = 0;\r\n\t\t// console.log('ModelRoomComponent.onInit');\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tthis.loadModel(environment.getPath(this.item.modelFolder), this.item.modelFile, (mesh) => {\r\n\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\tmount(mesh);\r\n\t\t\t}\r\n\t\t\tthis.progress = 0;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n\r\n\tgetLoader(path, file) {\r\n\t\tlet loader;\r\n\t\tif (file.indexOf('.fbx') !== -1) {\r\n\t\t\tloader = new THREE.FBXLoader();\r\n\t\t} else {\r\n\t\t\tloader = new THREE.GLTFLoader();\r\n\t\t}\r\n\t\tloader.setPath(path);\r\n\t\treturn loader;\r\n\t}\r\n\r\n\tloadModel(path, file, callback) {\r\n\t\t// const renderer = this.host.renderer;\r\n\t\t// const roughnessMipmapper = new RoughnessMipmapper(renderer); // optional\r\n\t\tconst loader = this.getLoader(path, file);\r\n\t\tloader.load(file, (model) => {\r\n\t\t\tlet mesh;\r\n\t\t\tconst scene = model.scene;\r\n\t\t\tif (scene) {\r\n\t\t\t\tmesh = scene;\r\n\t\t\t} else {\r\n\t\t\t\tmesh = model;\r\n\t\t\t}\r\n\t\t\tconst items = this.item.items;\r\n\t\t\tmesh.scale.set(0.05, 0.05, 0.05);\r\n\t\t\t// mesh.scale.set(10, 10, 10);\r\n\t\t\tmesh.traverse((child) => {\r\n\t\t\t\tif (child.isMesh) {\r\n\t\t\t\t\t// roughnessMipmapper.generateMipmaps(child.material);\r\n\t\t\t\t\tconst item = items.find(x => x.id === child.name);\r\n\t\t\t\t\tif (item) {\r\n\t\t\t\t\t\titem.mesh = child;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tif (USE_SHADOW) {\r\n\t\t\t\t\t\t\tchild.castShadow = true;\r\n\t\t\t\t\t\t\tchild.receiveShadow = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tchild.material.dispose();\r\n\t\t\t\t\t\t// child.renderOrder = environment.renderOrder.model;\r\n\t\t\t\t\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\t\t\t\t\tcolor: 0x111111,\r\n\t\t\t\t\t\t\troughness: 0.6,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tchild.material = material;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tmesh.position.y = -1.66 * 3;\r\n\t\t\titems.forEach(item => {\r\n\t\t\t\tconst previous = item.mesh;\r\n\t\t\t\tif (previous) {\r\n\t\t\t\t\tif (previous.material) {\r\n\t\t\t\t\t\tprevious.material.color.setHex(0x000000);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst parent = previous.parent;\r\n\t\t\t\t\tconst mesh = item.mesh = new MediaMesh(item, items, previous.geometry);\r\n\t\t\t\t\tmesh.depthTest = false;\r\n\t\t\t\t\tmesh.renderOrder = 0;\r\n\t\t\t\t\tmesh.name = previous.name;\r\n\t\t\t\t\tmesh.position.copy(previous.position);\r\n\t\t\t\t\tmesh.rotation.copy(previous.rotation);\r\n\t\t\t\t\tmesh.scale.copy(previous.scale);\r\n\t\t\t\t\tmesh.load(() => {\r\n\t\t\t\t\t\t// mesh.material = new THREE.MeshStandardMaterial({ color: 0xff0000 });\r\n\t\t\t\t\t\tparent.add(mesh);\r\n\t\t\t\t\t\tparent.remove(previous);\r\n\t\t\t\t\t\tif (previous.material) {\r\n\t\t\t\t\t\t\tprevious.material.dispose();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('down', () => {\r\n\t\t\t\t\t\tconsole.log('ModelRoomComponent.down');\r\n\t\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('playing', (playing) => {\r\n\t\t\t\t\t\tconsole.log('ModelRoomComponent.playing', playing);\r\n\t\t\t\t\t\tthis.play.next({ itemId: item.id, playing });\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tconst lights = new Array(3).fill(0).map((x, i) => {\r\n\t\t\t\tconst light = new THREE.PointLight(0xffffff, 0.1, 1000, 2);\r\n\t\t\t\tif (USE_SHADOW) {\r\n\t\t\t\t\tlight.castShadow = true;\r\n\t\t\t\t\tlight.shadow.mapSize.width = 1024;\r\n\t\t\t\t\tlight.shadow.mapSize.height = 1024;\r\n\t\t\t\t\tlight.shadow.camera.near = 0.1;\r\n\t\t\t\t\tlight.shadow.camera.far = 500;\r\n\t\t\t\t}\r\n\t\t\t\tconst radians = Math.PI / 180 * 45 + Math.PI / 180 * 120 * i;\r\n\t\t\t\tlight.position.set(Math.cos(radians) * 5, 1, Math.sin(radians) * 5);\r\n\t\t\t\t/*\r\n\t\t\t\tconst helper = new THREE.PointLightHelper(light, 0.1);\r\n\t\t\t\tthis.group.add(helper);\r\n\t\t\t\t*/\r\n\t\t\t\tthis.group.add(light);\r\n\t\t\t\treturn light;\r\n\t\t\t});\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(mesh);\r\n\t\t\t}\r\n\t\t\tthis.progress = 0;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// roughnessMipmapper.dispose();\r\n\t\t}, (progressEvent) => {\r\n\t\t\tif (progressEvent.lengthComputable) {\r\n\t\t\t\tthis.progress = Math.round(progressEvent.loaded / progressEvent.total * 100);\r\n\t\t\t} else {\r\n\t\t\t\tthis.progress = this.progress || 0;\r\n\t\t\t\tthis.progress = Math.min(100, this.progress + 1);\r\n\t\t\t}\r\n\t\t\t// console.log('progressEvent', progressEvent.loaded, progressEvent.total);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tconst item = this.item;\r\n\t\tif (item) {\r\n\t\t\tconst items = item.items;\r\n\t\t\tif (items) {\r\n\t\t\t\titems.forEach(item => {\r\n\t\t\t\t\tif (item.mesh) {\r\n\t\t\t\t\t\titem.mesh.dispose();\r\n\t\t\t\t\t\tdelete item.mesh;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nModelRoomComponent.textures = {};\r\n\r\nModelRoomComponent.meta = {\r\n\tselector: '[model-room]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play'],\r\n\tinputs: ['item'],\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelTextComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelTextComponent.onInit');\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n}\r\n\r\nModelTextComponent.meta = {\r\n\tselector: '[model-text]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { CoreModule, Module } from 'rxcomp';\r\nimport { FormModule } from 'rxcomp-form';\r\nimport AccessCodeComponent from './access/access-code.component';\r\nimport AccessComponent from './access/access.component';\r\nimport AgoraChatComponent from './agora/agora-chat.component';\r\nimport AgoraCheckComponent from './agora/agora-check.component';\r\nimport AgoraChecklistComponent from './agora/agora-checklist.component';\r\nimport AgoraDevicePreviewComponent from './agora/agora-device-preview.component';\r\nimport AgoraDeviceComponent from './agora/agora-device.component';\r\nimport AgoraLinkComponent from './agora/agora-link.component';\r\nimport AgoraLoginComponent from './agora/agora-login.component';\r\nimport AgoraNameComponent from './agora/agora-name.component';\r\nimport AgoraStreamComponent from './agora/agora-stream.component';\r\nimport AgoraComponent from './agora/agora.component';\r\nimport AppComponent from './app.component';\r\nimport AssetPipe from './asset/asset.pipe';\r\nimport ControlRequestModalComponent from './control-request/control-request-modal.component';\r\nimport DropDirective from './drop/drop.directive';\r\nimport DropdownItemDirective from './dropdown/dropdown-item.directive';\r\nimport DropdownDirective from './dropdown/dropdown.directive';\r\nimport { EditorModule } from './editor/editor.module';\r\nimport FlagPipe from './flag/flag.pipe';\r\nimport ControlAssetComponent from './forms/control-asset.component';\r\nimport ControlAssetsComponent from './forms/control-assets.component';\r\nimport ControlCheckboxComponent from './forms/control-checkbox.component';\r\nimport ControlCustomSelectComponent from './forms/control-custom-select.component';\r\nimport ControlLinkComponent from './forms/control-link.component';\r\nimport ControlLocalizedAssetComponent from './forms/control-localized-asset.component';\r\nimport ControlMenuComponent from './forms/control-menu.component';\r\nimport ControlModelComponent from './forms/control-model.component';\r\nimport ControlNumberComponent from './forms/control-number.component';\r\nimport ControlPasswordComponent from './forms/control-password.component';\r\nimport ControlSelectComponent from './forms/control-select.component';\r\nimport ControlTextComponent from './forms/control-text.component';\r\nimport ControlTextareaComponent from './forms/control-textarea.component';\r\nimport ControlVectorComponent from './forms/control-vector.component';\r\nimport ControlsComponent from './forms/controls.component';\r\nimport DisabledDirective from './forms/disabled.directive';\r\nimport ErrorsComponent from './forms/errors.component';\r\nimport InputValueComponent from './forms/input-value.component';\r\nimport TestComponent from './forms/test.component';\r\nimport ValueDirective from './forms/value.directive';\r\nimport HtmlPipe from './html/html.pipe';\r\nimport IdDirective from './id/id.directive';\r\nimport LabelPipe from './label/label.pipe';\r\nimport LayoutComponent from './layout/layout.component';\r\nimport LazyDirective from './lazy/lazy.directive';\r\nimport ModalOutletComponent from './modal/modal-outlet.component';\r\nimport ModalComponent from './modal/modal.component';\r\nimport SlugPipe from './slug/slug.pipe';\r\nimport SvgIconStructure from './svg/svg-icon.structure';\r\nimport TryInARModalComponent from './try-in-ar/try-in-ar-modal.component';\r\nimport TryInARComponent from './try-in-ar/try-in-ar.component';\r\nimport UploadItemComponent from './upload/upload-item.component';\r\nimport HlsDirective from './video/hls.directive';\r\nimport VirtualStructure from './virtual/virtual.structure';\r\nimport ModelBannerComponent from './world/model/model-banner.component';\r\nimport ModelCurvedPlaneComponent from './world/model/model-curved-plane.component';\r\nimport ModelDebugComponent from './world/model/model-debug.component';\r\nimport ModelGridComponent from './world/model/model-grid.component';\r\nimport ModelMenuComponent from './world/model/model-menu.component';\r\nimport ModelModelComponent from './world/model/model-model.component';\r\nimport ModelNavComponent from './world/model/model-nav.component';\r\nimport ModelPanelComponent from './world/model/model-panel.component';\r\nimport ModelPictureComponent from './world/model/model-picture.component';\r\nimport ModelPlaneComponent from './world/model/model-plane.component';\r\nimport ModelProgressComponent from './world/model/model-progress.component';\r\nimport ModelRoomComponent from './world/model/model-room.component';\r\nimport ModelTextComponent from './world/model/model-text.component';\r\nimport ModelComponent from './world/model/model.component';\r\nimport WorldComponent from './world/world.component';\r\n\r\nexport class AppModule extends Module { }\r\n\r\nAppModule.meta = {\r\n\timports: [\r\n\t\tCoreModule,\r\n\t\tFormModule,\r\n\t\tEditorModule,\r\n\t],\r\n\tdeclarations: [\r\n\t\tAccessCodeComponent,\r\n\t\tAccessComponent,\r\n\t\tAgoraChatComponent,\r\n\t\tAgoraCheckComponent,\r\n\t\tAgoraChecklistComponent,\r\n\t\tAgoraComponent,\r\n\t\tAgoraDeviceComponent,\r\n\t\tAgoraDevicePreviewComponent,\r\n\t\tAgoraLinkComponent,\r\n\t\tAgoraLoginComponent,\r\n\t\tAgoraNameComponent,\r\n\t\tAgoraStreamComponent,\r\n\t\tAssetPipe,\r\n\t\tControlAssetComponent,\r\n\t\tControlAssetsComponent,\r\n\t\tControlCheckboxComponent,\r\n\t\tControlCustomSelectComponent,\r\n\t\tControlLinkComponent,\r\n\t\tControlLocalizedAssetComponent,\r\n\t\tControlMenuComponent,\r\n\t\tControlModelComponent,\r\n\t\tControlNumberComponent,\r\n\t\tControlPasswordComponent,\r\n\t\tControlRequestModalComponent,\r\n\t\tControlsComponent,\r\n\t\tControlSelectComponent,\r\n\t\tControlTextareaComponent,\r\n\t\tControlTextComponent,\r\n\t\tControlVectorComponent,\r\n\t\tDisabledDirective,\r\n\t\tDropDirective,\r\n\t\tDropdownDirective,\r\n\t\tDropdownItemDirective,\r\n\t\tErrorsComponent,\r\n\t\tFlagPipe,\r\n\t\tHlsDirective,\r\n\t\tHtmlPipe,\r\n\t\tIdDirective,\r\n\t\tInputValueComponent,\r\n\t\tLabelPipe,\r\n\t\tLayoutComponent,\r\n\t\tLazyDirective,\r\n\t\tModalComponent,\r\n\t\tModalOutletComponent,\r\n\t\tModelBannerComponent,\r\n\t\tModelComponent,\r\n\t\tModelCurvedPlaneComponent,\r\n\t\tModelDebugComponent,\r\n\t\tModelGridComponent,\r\n\t\tModelMenuComponent,\r\n\t\tModelModelComponent,\r\n\t\tModelNavComponent,\r\n\t\tModelPanelComponent,\r\n\t\tModelPictureComponent,\r\n\t\tModelPlaneComponent,\r\n\t\tModelProgressComponent,\r\n\t\tModelRoomComponent,\r\n\t\tModelTextComponent,\r\n\t\tSlugPipe,\r\n\t\tSvgIconStructure,\r\n\t\tTestComponent,\r\n\t\tTryInARComponent,\r\n\t\tTryInARModalComponent,\r\n\t\tUploadItemComponent,\r\n\t\tValueDirective,\r\n\t\tVirtualStructure,\r\n\t\tWorldComponent\r\n\t],\r\n\tbootstrap: AppComponent,\r\n};\r\n","import { Browser } from 'rxcomp';\r\nimport { AppModule } from './app.module';\r\n\r\nBrowser.bootstrap(AppModule);\r\n"]}