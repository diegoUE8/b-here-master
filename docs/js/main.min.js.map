{"version":3,"sources":["src/js/main.js","../../src/js/environment.served.js","../../src/js/utils/utils.js","../../src/js/environment.js","../../src/js/environment.static.js","../../src/js/access/access-code.component.js","../../src/js/location/location.service.js","../../src/js/label/label.pipe.js","../../src/js/forms/controls.component.js","../../src/js/http/http.service.js","../../src/js/user/user.js","../../src/js/user/user.service.js","../../src/js/access/access.component.js","../../src/js/message/message.service.js","../../src/js/state/state.service.js","../../src/js/emittable/emittable.js","../../src/js/local-storage/session-storage.service.js","../../src/js/stream/stream.service.js","../../src/js/agora/agora.types.js","../../src/js/agora/agora.service.js","../../src/js/agora/agora-chat.component.js","../../src/js/agora/agora-check.component.js","../../src/js/device/device.service.js","../../src/js/local-storage/local-storage.service.js","../../src/js/agora/agora-checklist.component.js","../../src/js/audio/audio-stream.service.js","../../src/js/agora/agora-device-preview.component.js","../../src/js/agora/agora-device.component.js","../../src/js/agora/agora-link.component.js","../../src/js/agora/agora-login.component.js","../../src/js/agora/agora-name.component.js","../../src/js/agora/agora-stream.component.js","../../src/js/gtm/gtm.service.js","../../src/js/modal/modal.service.js","../../src/js/modal/modal-outlet.component.js","../../src/js/try-in-ar/try-in-ar-modal.component.js","../../src/js/view/view.js","../../src/js/view/view.service.js","../../src/js/world/vr.service.js","../../src/js/agora/agora.component.js","../../src/js/app.component.js","../../src/js/asset/asset.js","../../src/js/asset/asset.pipe.js","../../src/js/control-request/control-request-modal.component.js","../../src/js/drop/drop.directive.js","../../src/js/dropdown/dropdown.directive.js","../../src/js/dropdown/dropdown-item.directive.js","../../src/js/toast/toast.service.js","../../src/js/toast/toast-outlet.component.js","../../src/js/editor/aside/aside.component.js","../../src/js/asset/asset.service.js","../../src/js/editor/editor.service.js","../../src/js/editor/editor.component.js","../../src/js/editor/menu/menu.service.js","../../src/js/drop/drop.service.js","../../src/js/forms/control.component.js","../../src/js/forms/control-asset.component.js","../../src/js/forms/control-menu.component.js","../../src/js/editor/menu/menu-builder.component.js","../../src/js/editor/modals/curved-plane-modal.component.js","../../src/js/editor/modals/item-model-modal.component.js","../../src/js/editor/modals/model-modal.component.js","../../src/js/editor/modals/nav-modal.component.js","../../src/js/editor/modals/panorama-grid-modal.component.js","../../src/js/editor/modals/panorama-modal.component.js","../../src/js/editor/modals/plane-modal.component.js","../../src/js/editor/modals/remove-modal.component.js","../../src/js/editor/update/update-view-item.component.js","../../src/js/editor/update/update-view-tile.component.js","../../src/js/editor/update/update-view.component.js","../../src/js/editor/editor.module.js","../../src/js/flag/flag.pipe.js","../../src/js/upload/upload.service.js","../../src/js/forms/control-assets.component.js","../../src/js/forms/control-checkbox.component.js","../../src/js/keyboard/keyboard.service.js","../../src/js/forms/control-custom-select.component.js","../../src/js/forms/control-link.component.js","../../src/js/forms/control-localized-asset.component.js","../../src/js/forms/control-model.component.js","../../src/js/forms/control-number.component.js","../../src/js/forms/control-password.component.js","../../src/js/forms/control-select.component.js","../../src/js/forms/control-text.component.js","../../src/js/forms/control-textarea.component.js","../../src/js/forms/control-vector.component.js","../../src/js/forms/disabled.directive.js","../../src/js/forms/errors.component.js","../../src/js/forms/input-value.component.js","../../src/js/forms/test.component.js","../../src/js/forms/value.directive.js","../../src/js/html/html.pipe.js","../../src/js/id/id.directive.js","../../src/js/layout/layout.component.js","../../src/js/image/image.service.js","../../src/js/intersection/intersection.service.js","../../src/js/lazy/lazy.cache.js","../../src/js/lazy/lazy.directive.js","../../src/js/modal/modal.component.js","../../src/js/slug/slug.pipe.js","../../src/js/svg/svg-icon.structure.js","../../src/js/try-in-ar/try-in-ar.component.js","../../src/js/upload/upload-item.component.js","../../src/js/video/hls.directive.js","../../src/js/virtual/virtual.item.js","../../src/js/virtual/virtual.structure.js","../../src/js/loader/loader.service.js","../../src/js/world/envmap/envmap.loader.js","../../src/js/world/interactive/freezable.mesh.js","../../src/js/world/interactive/emittable.mesh.js","../../src/js/world/interactive/interactive.js","../../src/js/world/interactive/interactive.mesh.js","../../src/js/world/video-texture.js","../../src/js/world/panorama/panorama.js","../../src/js/rect/rect.js","../../src/js/world/avatar/avatar-element.js","../../src/js/world/camera/camera.js","../../src/js/world/media/media-loader.js","../../src/js/world/media/media-mesh.js","../../src/js/drag/drag.service.js","../../src/js/world/orbit/orbit.js","../../src/js/world/phone/phone.element.js","../../src/js/world/pointer/pointer.element.js","../../src/js/world/webxr/gamepad.js","../../src/js/world/interactive/emittable.js","../../src/js/world/webxr/motion-controllers.module.js","../../src/js/world/webxr/xr-controller-model-factory.js","../../src/js/world/world.component.js","../../src/js/world/model/model.component.js","../../src/js/world/model/model-banner.component.js","../../src/js/world/model/model-editable.component.js","../../src/js/world/model/model-curved-plane.component.js","../../src/js/world/debug.service.js","../../src/js/world/model/model-debug.component.js","../../src/js/world/model/model-grid.component.js","../../src/js/world/model/model-menu.component.js","../../src/js/world/model/model-model.component.js","../../src/js/world/model/model-nav.component.js","../../src/js/world/interactive/interactive.sprite.js","../../src/js/world/interactive/emittable.sprite.js","../../src/js/world/interactive/freezable.sprite.js","../../src/js/world/model/model-panel.component.js","../../src/js/world/model/model-picture.component.js","../../src/js/world/model/model-plane.component.js","../../src/js/world/model/model-progress.component.js","../../src/js/world/model/model-room.component.js","../../src/js/world/model/model-text.component.js","../../src/js/app.module.js","../../src/js/main.js"],"names":["g","f","exports","module","require","define","amd","globalThis","self","rxcomp","form","rxjs","operators","THREE","html2canvas","this","rxcompForm","three","asyncGeneratorStep","gen","resolve","reject","_next","_throw","key","arg","info","value","error","done","Promise","then","_asyncToGenerator","fn","args","arguments","apply","err","undefined","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","_createClass","Constructor","protoProps","staticProps","prototype","_defineProperty","obj","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","getOwnPropertyDescriptor","push","_inheritsLoose","subClass","superClass","create","constructor","__proto__","_assertThisInitialized","ReferenceError","hasOwnProperty","call","Utils","merge","source","_this","forEach","Array","isArray","NODE","DEBUG","get","URLSearchParams","window","location","search","BASE_HREF","document","querySelector","getAttribute","HEROKU","host","indexOf","STATIC","port","DEVELOPMENT","split","ENV","PRODUCTION","Environment","_proto","options","url","language","market","assign","getAbsoluteUrl","path","params","origin","replace","getPath","isLocal","href","set","console","log","githubDocs","defaultAppOptions","channelName","flags","production","useProxy","useToken","selfService","guidedTourRequest","editor","ar","menu","attendee","streamer","viewer","smartDevice","maxQuality","heroku","environmentOptions","appKey","editorAssetScreen","chat","logo","background","image","video","colors","menuBackground","menuForeground","menuOverBackground","menuOverForeground","menuBackBackground","menuBackForeground","menuBackOverBackground","menuBackOverForeground","disabledViewTypes","disabledViewItemTypes","assets","worker","index","access","selfServiceTour","guidedTour","accessCode","template","tryInAr","modal","controlRequest","view","panorama","panorama-grid","room-3d","model","viewItem","nav","plane","curved-plane","texture","remove","languages","defaultLanguage","fontFamily","renderOrder","tile","banner","panel","debug","pointer","environment","bhere","_Utils$merge","LocationService","has","keyOrValue","history","pushState","title","toString","deserialize","encoded","decode","serialize","encode","decoded","json","atob","JSON","parse","stringify","btoa","AccessCodeComponent","_Component","onInit","env","link","node","getContext","QRious","element","size","Component","meta","selector","LABELS","browse","cancel","drag_and_drop_images","error_email","error_match","error_required","loading","required","select","select_file","update","upload","waiting_host","editor_image","editor_video","editor_model","editor_publisher_stream","editor_next_attendee_stream","editor_waiting_room","editor_panorama","editor_panorama_grid","editor_room_3d","editor_nav","editor_gltf","editor_plane","editor_curved_plane","editor_texture","labels","LabelPipe","_Pipe","transform","getKeys","_len","_key","map","x","join","Pipe","name","ControlsComponent","getControl","group","formGroup","control","fieldsToFormGroup","fields","FormGroup","reduce","p","c","validators","type","Validators","RequiredTrueValidator","RequiredValidator","EmailValidator","PatternValidator","pattern","FormControl","slice","unshift","id","fieldsToFormControls","inputs","hosts","FormAbstractCollectionDirective","HttpService","http$","method","data","format","response_","from","fetch","headers","Accept","Content-Type","body","response","typedResponse","contentType","text","ok","warn","pipe","catchError","throwError","getError","get$","query","delete$","post$","put$","patch$","status","statusCode","statusMessage","statusText","RoleType","Publisher","Attendee","Streamer","Viewer","SmartDevice","SelfService","User","UserService","setUser","user","user$","next","me$","mapUser","of","switchMap","login$","payload","_this2","tap","logout$","_this3","guidedTour$","_this4","selfServiceTour$","_this5","resolve$","log$","BehaviorSubject","AccessComponent","state","onSelfServiceTourRequest","initRequestForm","pushChanges","navigator","userAgent","test","onSubmit","onGuidedTourRequest","onGuidedTourAccess","first","subscribe","onLogin","initLoginForm","formSubscription","unsubscribe","roles","label","antiforgery","controls","changes$","takeUntil","unsubscribe$","changes","username","password","checkRequest","checkField","testValues","patch","reset","onBack","valid","submitted","touched","isValid","MessageService","message","message$","in","in$","sendBack","remoteId","clientId","out","out$","ReplaySubject","StateService","patchState","state$","getValue","Emittable","events","on","callback","event","off","once","emit","broadcast","callbacks","SessionStorageService","delete","isSessionStorageSupported","sessionStorage","removeItem","exist","e","cache","setItem","supported","StreamServiceMode","StreamService","orderedRemotes$","combineLatest","remotes$","interval","datas","orderedRemotes","remote","clientInfo","audioLevel","getAudioLevel","peekAudioLevel","Math","max","sort","a","b","role","order","min","distinctUntilChanged","uid","getEditorStreams$","mediaDevices","getUserMedia","mode","media","createElement","setAttribute","appendChild","width","height","stream","srcObject","src","URL","createObjectURL","oncanplay","fakePublisherStream","getId","fakeAttendeeStream","fakeSmartDeviceStream","editorStreams$","play","catch","shareReplay","getEditorScreens$","getDisplayMedia","screen","fakePublisherScreen","fakeAttendeeScreen","editorScreens$","getPublisherStreamId$","publisherStreamId","streams$","getRemoteById","streamId","remotes","find","remoteAdd","remoteRemove","isPlaying","stop","splice","remoteSetClientInfo","editorStreams","editorScreens","local","local$","screen$","peers","peers$","streams","publisherStream","_streams","_streams2","StreamQualities","profile","resolution","frameRate","bitrate","getStreamQuality","lowestQuality","highestQuality","AgoraStatus","MessageType","AgoraEvent","AgoraPeerEvent","_AgoraEvent","AgoraRemoteEvent","_AgoraEvent2","AgoraMuteVideoEvent","_AgoraEvent3","AgoraUnmuteVideoEvent","_AgoraEvent4","AgoraMuteAudioEvent","_AgoraEvent5","AgoraUnmuteAudioEvent","_AgoraEvent6","AgoraVolumeLevelsEvent","_AgoraEvent7","AgoraService","defaultDevices","AGORA","_Emittable","onStreamPublished","bind","onStreamUnpublished","onStreamAdded","onStreamRemoved","onStreamSubscribed","onMuteVideo","onUnmuteVideo","onMuteAudio","onUnmuteAudio","onVolumeIndicator","onPeerConnect","onPeerLeaved","onConnectionStateChange","onTokenPrivilegeWillExpire","onTokenPrivilegeDidExpire","onMessage","devices","videos","audios","quality","membersCount","getSingleton","addStreamDevice","removeStreamDevice","deviceId","kind","audio","devices$","defaultVideos","defaultAudios","getDevices","tempStream","close","device","AgoraRTC","createStream","init","connect$","preferences","connecting","setTimeout","createClient","channelNameLink","getChannelNameLink","rtcToken$","token","membersCount$","channelId","messageClient","getChannelMemberCount","counters","observeMemberCount","unobserveMemberCount","membersCountSubscription","client","Logger","setLogLevel","NONE","codec","clientInit","startProxyServer","setClientRole","onError","AgoraRTM","createInstance","logFilter","LOG_FILTER_OFF","setParameters","match","getUniqueUserId","floor","random","Date","now","channel","connected","rtmToken$","joinMessageChannel","success","autoDetectDevice","createMediaStream","login","createChannel","detectDevices","getVideoOptions","crossOrigin","hls","Hls","attachMedia","Events","MEDIA_ATTACHED","loadSource","MANIFEST_PARSED","captureStream","videoSource","getVideoTracks","cameraId","getAudioOptions","loadLevel","levels","audioSource","getAudioTracks","microphoneId","inputDevices","_this6","streamID","Boolean","all","createLocalStreamWithOptions","_this7","setVideoProfile","setVideoEncoderConfiguration","publishLocalStream","initLocalStream","_this8","publish","screenUid","unpublishLocalStream","unpublish","leaveChannel","_this9","unpublishScreenStream","leaveMessageChannel","leaveClient","leaveScreenClient","_this10","leave","stopProxyServer","_this11","logout","toggleCamera","userMuteVideo","unmuteVideo","cameraMuted","broadcastEvent","muteVideo","toggleAudio","userMuteAudio","unmuteAudio","audioMuted","muteAudio","toggleControl","_this12","sendRemoteControlDismiss","spying","sendRemoteInfoDismiss","sendRemoteControlRequest","toggleSpy","_this13","sendSpyRemoteRequestInfo","newMessageId","_this14","sendMessage","messageId","_this15","sendRemoteRequestPeerInfo","_this16","hosted","locked","sendControlRemoteRequestInfo","_this17","_this18","_this19","navToView","viewId","spyed","getSessionStats","stats","Duration","UserCount","SendBytes","RecvBytes","SendBitrate","RecvBitrate","getSystemStats","BatteryLevel","_this20","send","addOrUpdateChannelAttributes","messages","attributes","date","promise","enableNotificationToChannelMembers","getChannelAttributes","lastUpdateTs","attribute","checkBroadcastMessage","broadcastMessage","container","classList","add","peerAdd","peerRemove","peer","peerId","attr","level","renewToken","toggleScreen","_this21","screenClient","createScreenStream","createScreenClient","screenJoin","_this22","onScreenError","onScreenStreamPublished","onScreenStreamUnpublished","_this23","screenClientId","_this24","setScreenProfile","publishScreenStream","_this25","checkRtcConnection","checkRtcTryJoin","finally","checkRtmConnection","devices_","enumerateDevices","getTracks","track","ChatMessage","clientId_","names","shortName","substr","toUpperCase","getPayload","getCopy","AgoraChatComponent","_proto2","checkTypings","pushMessage","typingBegin","typingEnd","groupedMessages","demo","getFakeList","updateMessages","agora","onView","onChanges","createMessage","randomMessage","onClose","scrollToBottom","scrollView","scrollTop","scrollHeight","removeTyping","recursive","typings","typings_","lastMessage","typing","createRandomMessage","outputs","concat","AgoraCheckComponent","DevicePlatform","DeviceService","getDevicePlatform","vendor","opera","isIOS","isVRHeadset","platform_","platform","LocalStorageService","isLocalStorageSupported","localStorage","TIMEOUT","AgoraChecklistComponent","checklist","errors","busy","shouldCheckDevices","checkBrowser","browser","checkSystemRequirements","checkHttps","checkAudio","checkVideo","checkRtc","checkRtm","skip","https","protocol","audioinput","videoinput","rtc","rtm","onComplete","_","onNext","checked","openHttps","AudioStreamService","addSource","streamOrElement","MediaStream","sources_","context","createMediaStreamSource","clone","createMediaElementSource","removeSource","removeSourceKey","analyser","disconnect","frequency$","fftSize","Uint8Array","connect","frame$","withLatestFrom","_ref","getByteFrequencyData","finalize","volume$","volume","clipped","meter","audioMeterCreate","_ref2","checkClipping","clipLevel","averaging","clipLag","processor","createScriptProcessor","onaudioprocess","audioMeterProcess","audioMeterClip","dispose","audioMeterDispose","clipping","lastClip","destination","buffer","inputBuffer","getChannelData","bufferLength","sum","abs","performance","rms","sqrt","step$","previous","Observable","observer","requestAnimationFrame","startTime","deltaTime","frame","context_","AudioContext","analyser_","createAnalyser","expand","share","AgoraDevicePreviewComponent","initialized_","onLoadedMetadata","preview","addEventListener","hasPreview","bars","fill","bar","onDestroy","removeEventListener","initStream","video_","audio_","ideal","analyzeData","loadingStream_","frequencySubscription","frequency","pow","style","left","opacity","change","AgoraDeviceComponent","isHttps","initForm","videoOptions","audioOptions","onStreamDidChange","onStream","onEnter","enter","AgoraLinkComponent","linkAttendee","linkStreamer","linkViewer","linkSmartDevice","onGenerateMeetingId","$event","timestamp","valueOf","getRoleMeetingId","replaceRoleMeetingId","meetingId","components","padded","getRoleIndex","onInputDidChange","setRoleMeetingId","meetingIdSegments","onCopyToClipBoard","asAccessCode","input","position","top","getAccessCodeUrl","getUrl","focus","setSelectionRange","execCommand","parentNode","removeChild","alert","replaceUrl","shareable","pathname","replaceState","pageTitle","num","s","AgoraLoginComponent","friendlyMessage","firstName","lastName","AgoraNameComponent","AgoraStreamComponent","videoMuted","shouldUseResumeGesture","vrContainer","setMediaStream","mediaStream","videoNode","onToggleSpy","videoMuted_","audioMuted_","streamId_","stream_","player","childElementCount","firstElementChild","div","fit","removeAttribute","vrContainer_","videoNode_","GtmService","dataLayer","push_","ModalEvent","ModalResolveEvent","_ModalEvent","ModalRejectEvent","_ModalEvent2","ModalService","open$","getTemplate$","getNode","modal$","events$","load$","innerHTML","Subject","ModalOutletComponent","modalNode","modal_","compile","TryInARModalComponent","_getContext","parentInstance","openInAR","open","ViewType","WaitingRoom","Panorama","PanoramaGrid","Room3d","Model","ViewItemType","Nav","Plane","CurvedPlane","Texture","View","updateIndices","items","item","mapViewItem","tiles","mapViewTile","originalItems","publisherStreamIndex","attendeeStreamIndex","smartDeviceStream","publisherScreenIndex","attendeeScreenIndex","asset","file","allowedProps","substring","PanoramaView","_View","PanoramaGridView","_View2","mapTiles","flipAxes","invertAxes","folder","index_","index$","selected","navs","axes","indices","Vector2","y","parseInt","updateCurrentItems","getTileIndex","hasTile","getTile","ModelView","_View3","ViewItem","abstract","NavViewItem","_ViewItem","ViewTile","mapView","ViewService","data$","data$_","dataUrl","views","view$","initialViewId","action$_","action","keepOrientation","getWaitingRoom","hostedView$","waitingRoom","hosted$","editorView$","viewById$","viewLike$","liked","likes","setViewLike$","orientation","latitude","longitude","XRStatus","VRService","service_","state_","camera","Vector3","quaternion","Quaternion","scale","array","onSessionStarted","onSessionEnded","status$","session$","currentSession","xr","isSessionSupported","isSecureContext","getService","session","toggleVR","requestSession","optionalFeatures","end","isDisabled","getLabel","updateState","world","renderer","scene","matrixWorld","decompose","z","w","AgoraComponent","vrService","resolveUser","getLinkRole","linkRole","initWithUser","userGuard","userGuardRedirect","setNextStatus","has3D","live","initAgora","viewObserver$","onRemoteNavTo","showLove","chatDirty","onChecked","onLink","onName","sharedMeetingId","fullName","userType","onNavTo","navItem","gridIndex","toggleVolume","volumeMuted","toggleFullScreen","fullScreen","requestFullscreen","webkitRequestFullscreen","msRequestFullscreen","exitFullscreen","webkitExitFullscreen","msExitFullscreen","toggleChat","dispatchEvent","Event","onChatClose","onToggleControl","addLike","skipTimeout","uiClass","AppComponent","EXT_IMAGE","EXT_VIDEO","EXT_MODEL","AssetType","Image","Video","PublisherStream","AttendeeStream","PublisherScreen","AttendeeScreen","SmartDeviceStream","AssetGroupType","ImageOrVideo","ids","STREAM_TYPES","assetIsStream","assetGroupTypeFromItem","assetPayloadFromGroupTypeId","groupTypeId","assetTypeById","Asset","assetTypeFromPath","extension","pop","toLowerCase","fromUrl","segments","mapAsset","MIME_IMAGE","MIME_VIDEO","MIME_MODEL","MIME_STREAM","AssetPipe","RegExp","isVideo","isModel","isStream","ControlRequestModalComponent","onAccept","onReject","DropDirective","_Directive","event$","fromEvent","expression","outputFunction","makeFunction","preventDefault","Directive","DROPDOWN_ID","DropdownDirective","trigger","opened","onClick","onDocumentClick","openDropdown","closeDropdown","addListeners","dropdown$","contains","addDocumentListeners","dropped","removeDocumentListeners","removeListeners","nextId","dropdown","id_","DropdownItemDirective","ToastResolveEvent","_ToastEvent","toast","ToastService","getTime","toast$","duration","ToastOutletComponent","AsideComponent","viewTypes","disabled","viewItemTypes","setSupportedViewTypes","setSupportedViewItemTypes","supportedViewTypes","supportedViewType","supportedViewItemTypes","supportedViewItemType","setMode","viewTypeName","viewItemTypeName","onSelect","onUpdate","onDelete","AssetService","assetCreate$","assetUpdate$","assetDelete$","localizedAssetCreate$","lg","localizedAssetUpdate$","upload$","files","formData","FormData","append","xhr","XMLHttpRequest","readyState","responseText","createOrUpdateAsset$","uploads","createOrUpdateLocalizedAsset$","assetDidChange","current","previousId","previousFile","currentId","currentFile","EditorService","viewIdOptions$","viewCreate$","viewUpdate$","viewDelete$","inferItemCreate$","tileItemCreate$","itemCreate$","inferItemUpdate$","tileItemUpdate$","itemUpdate$","inferItemDelete$","tileItemDelete$","itemDelete$","inferItemUpdateResult$","currentItem","inferItemDeleteResult$","EditorComponent","aside","settings","viewHit","initState","delay","onRemoteControlRequest","onToggleAside","onToggleSettings","onViewHit","onViewHitted","viewHitSubscription","onDragEnd","onResizeEnd","onWorldSelect","selectedItem","showPanel","onOpenModal","onAsideSelect","currentTile","onAsideUpdate","onUpdateAsset","onAsideDelete","MENU_UID","MenuService","menu$","getMenu$","menu$_","updateMenu$","createMenuItem$","parentId","updateMenuItem$","deleteMenuItem$","getModelMenu$","mapMenuItems","hidden","typeName","mapMenuItem","active","active$","DropService","drop$","isPlatformBrowser","dataTransfer","EMPTY","change$","asset$","previews","uploads$","read$","reader","FileReader","reader$","blob","result","resize$","resized","readAsDataURL","resize_","img","onload","canvas","ctx","drawImage","toDataURL","onerror","ControlComponent","ControlAssetComponent","_ControlComponent","accept","ControlMenuComponent","_ControlAssetComponen","itemToFormGroup","FormArray","dropdownId","onAddItem","onRemoveItem","onRemoveControl","onLinkItem","onLinkControl","onItemUp","up","onItemDown","down","onUpControl","insert","onDownControl","setView","switchSubjects_","onTextDidChange","hasOption","onDropped","MenuBuilderComponent","menuToControls","controlsToMenu","subitems","pushItem","menuItem","CurvedPlaneModalComponent","Object3D","copy","lookAt","ORIGIN","multiplyScalar","toArray","rotation","radius","arc","ItemModelModalComponent","ModelModalComponent","values","zoom","NavModalComponent","PanoramaGridModalComponent","PanoramaModalComponent","PlaneModalComponent","RemoveModalComponent","onRemove","onCancel","UpdateViewItemComponent","originalItem","hasChromaKeyColor","chromaKeyColor","assetType","doUpdateForm","doUpdateItem","getAssetDidChange","itemHasChromaKeyColor","changesHasChromaKeyColor","removeKey","optional","onAssetTypeDidChange","currentType","getTitle","UpdateViewTileComponent","UpdateViewComponent","doUpdateView","orbit$","auditTime","didChange","usdzDidChange","usdz","gltfDidChange","gltf","factories","pipes","EditorModule","_Module","Module","imports","declarations","FlagPipe","UploadItem","progress","uploading","paused","complete","UploadEvent","UploadStartEvent","_UploadEvent","UploadCompleteEvent","_UploadEvent2","UploadAssetEvent","_UploadEvent3","UploadService","concurrent$","items$","uploadItems","uploadItem$","delayWhen","addItems","newItems","removeAll","dropArea","files$","file$","uploadFile$","resize","ControlAssetsComponent","multiple","hasFiles","service","onUpload","onItemPause","onItemResume","onItemCancel","onItemRemove","items_","uploadCount","completed","ControlCheckboxComponent","KeyboardService","keydown$","keydown$_","keyup$","keyup$_","keys$","keys$_","startWith","key$","key$_","regexp","typing$","typing$_","to","clearTimeout","ControlCustomSelectComponent","word","scrollToWord","children","scrollTo","offsetTop","setOption","isMultiple","Error","_readOnlyError","v","ControlLinkComponent","onInputDidBlur","ControlLocalizedAssetComponent","currentLanguage","setLanguage","locale","localizedAsset","ControlModelComponent","ControlNumberComponent","precision","increment","updateValue","ControlPasswordComponent","ControlSelectComponent","ControlTextComponent","ControlTextareaComponent","ControlVectorComponent","DisabledDirective","ErrorsComponent","InputValueComponent","increment$","parseFloat","NaN","sign","m","race","toFixed","setValue","TestComponent","onTest","onReset","ValueDirective","HtmlPipe","n","String","fromCharCode","unescapes","rx","IdDirective","LayoutComponent","UID","ImageServiceEvent","ImageService","worker_","Worker","isBlob","isCors","postMessage","Blob","takeWhile","IntersectionService","observer_","readySubject_","observerSubject_","IntersectionObserver","entries","intersection$","observe","entry","isIntersecting","unobserve","LazyCache","cache_","LazyDirective","input$","lazy$","lazy","ModalComponent","SlugPipe","SvgIconStructure","_Structure","name_","_element$classList","createElementNS","h","setAttributeNS","rxcompId","replaceChild","Structure","TryInARComponent","missingAr","missingUsdz","missingGltf","getViewId","usdzSrc","getUsdzSrc","getGltfSrc","modelViewerNode","getModelViewerNode","gltfSrc","UploadItemComponent","onPause","pause","onResume","resume","HlsDirective","isSupported","hls_","VirtualItem","$key","$value","count","_Context","even","Context","VirtualMode","VirtualStructure","tokens","getExpressionTokens","virtualFunction","iterable","gutter","reverse","containerWidth","containerHeight","cols","cachedRects","cachedInstances","cacheNodes","update$","visibleItems","updateView","scroll$","updateForward","total","highestHeight","getWidth","getGutter","len","col","bottom","rect","getCol","getHeight","intersect","getLeft","cachedNode","offsetHeight","removeNode","removeIndex","parentContainer","diff","getCols","updateNode","createNode","clonedNode","cloneNode","instance","makeInstance","forItemContext","top1","bottom1","top2","bottom2","getComputedStyle","overflowY","getBoundingClientRect","trim","expressions","virtualExpressions","keyValueMatches","indexExpressions","LOADER_UID","LoaderService","switchLoaders","progress$","getRef","ref","loaded","setProgress","switchAll","subject","round","EnvMapLoader","load","loadPublisherStreamBackground","loadVideoBackground","loadHlslVideoBackground","loadRgbeBackground","loadBackgroundImageService","loadBackground","pmremGenerator","PMREMGenerator","compileEquirectangularShader","progressRef","loader","TextureLoader","setPath","envMap","fromEquirectangular","request","revokeObjectURL","RGBELoader","setDataType","UnsignedByteType","VideoTexture","minFilter","LinearFilter","magFilter","mapping","UVMapping","RGBFormat","needsUpdate","cubeRenderTarget","WebGLCubeRenderTarget","generateMipmaps","fromEquirectangularTexture","onPlaying","HAVE_FUTURE_DATA","onPublisherStreamId","muted","loop","playsInline","muted_","cubeRenderTarget_","texture_","FreezableMesh","geometry","material","BoxBufferGeometry","MeshBasicMaterial","color","_THREE$Mesh","freezed","freezed_","__lookupGetter__","freeze","unfreeze","Mesh","EmittableMesh","_FreezableMesh","Interactive","hittest","raycaster","dirty","lock","hit","intersections","intersectObjects","hash","intersection","uuid","lastIntersectedObject","point","over","depthTest","InteractiveMesh","_EmittableMesh","over_","down_","wrapS","wrapT","anisotropy","isVideoTexture","HAVE_CURRENT_DATA","subscription","tween","SphereBufferGeometry","rotateY","PI","ShaderMaterial","depthWrite","vertexShader","fragmentShader","uniforms","rgbe","mesh","onexit","crossfade","currentAsset","loadVideo","setVideo","Rect","right","intersectRect","r1","r2","fromNode","rect_","getClientRects","boundingRect","setCenter","setSize","center","intersection_","offset","scroll","COLORS","AvatarElement","WebGLRenderer","antialias","alpha","premultipliedAlpha","setClearColor","setPixelRatio","devicePixelRatio","toneMapping","ACESFilmicToneMapping","toneMappingExposure","outputEncoding","sRGBEncoding","domElement","PerspectiveCamera","Scene","light","PointLight","head","addHead","headGeometry_","headGeometry","CanvasTexture","MeshStandardMaterial","chalk","render","tick_","vol","sin","smile","cos","fillStyle","fillRect","beginPath","closePath","moveTo","bezierCurveTo","Camera","fov","aspect","near","far","dolly","_THREE$PerspectiveCam","box","Group","MediaLoaderEvent","MediaLoaderPlayEvent","_MediaLoaderEvent","MediaLoaderPauseEvent","_MediaLoaderEvent2","MediaLoader","toggle","getLoader","loadTexture","isPublisherStream","isAttendeeStream","isSmartDeviceStream","isPublisherScreen","isAttendeeScreen","autoplay","onCanPlay","preload","RepeatWrapping","silent","upEvent","VERTEX_SHADER","FRAGMENT_CHROMA_KEY_SHADER","MediaMesh","getMaterialByItem","_InteractiveMesh","getUniformsByItem","mediaLoader","getMaterial","useChromaKey","transparent","textureA","textureB","resolutionA","resolutionB","overlayColor","Color","overlay","getChromaKeyMaterial","side","DoubleSide","getTypeMatcher","matcher","getStreamId$","matchType","onAppear","videoWidth","videoHeight","isPlayableVideo","createTextureB","onOver","onOut","onToggle","aw","ah","imageSmoothingEnabled","imageSmoothingQuality","br","linkedPlayId","gsap","ease","Power2","easeInOut","onDisappear","playing","overwrite","setPlayingState","updateByItem","disposeMaterial","disposeMediaLoader","disposable","DragPoint","DragEvent","DragDownEvent","_DragEvent","distance","strength","speed","DragMoveEvent","_DragEvent2","DragUpEvent","_DragEvent3","DragService","getPosition","MouseEvent","clientX","clientY","TouchEvent","touches","pageX","pageY","down$","downEvent","button","originalEvent","move$","dismiss$","moveEvent","innerWidth","innerHeight","dismissEvent","stopImmediatePropagation","up$","observe$","OrbitMode","OrbitEvent","OrbitDragEvent","_OrbitEvent","OrbitResizeEvent","_OrbitEvent2","OrbitMoveEvent","_OrbitEvent3","orbitMoveEvent","orbitDragEvent","orbitResizeEvent","OrbitService","mode_","dolly_","zoom_","direction","inertia","Euler","updatePosition","updateTarget","setLongitudeLatitude","getDollyValue","getZoomValue","clampedDolly","clamp","setOrientation","getOrientation","phi","degToRad","theta","Shift","Control","flip","MathUtils","updateProjectionMatrix","walk","heading","normalize","headingTheta","atan2","headingLongitude","radToDeg","differenceLongitude","differenceLatitude","walkComplete","headingLatitude","object3d","acos","setVRCamera","applyQuaternion","R","PhoneStreamElement","setRemote","r","sx","sy","ceil","addStreamTexture","PlaneBufferGeometry","PhoneElement","phone","PointerElement","setPosition","Gamepad","gamepad","buttons","updateButtons","updateAxes","pressed","GamepadButton","axis","GamepadAxis","feedback","actuators","hapticActuators","pulse","_THREE$Vector","Constants","Handedness","LEFT","RIGHT","ComponentState","DEFAULT","TOUCHED","PRESSED","ComponentProperty","BUTTON","X_AXIS","Y_AXIS","STATE","ComponentType","TRIGGER","SQUEEZE","TOUCHPAD","THUMBSTICK","ButtonTouchThreshold","AxisTouchThreshold","VisualResponseProperty","TRANSFORM","VISIBILITY","fetchJsonFile","_fetchJsonFile","regeneratorRuntime","mark","_callee","wrap","_context","prev","sent","abrupt","fetchProfilesList","_fetchProfilesList","_callee2","basePath","profilesList","_context2","_fetchProfile","_callee3","xrInputSource","defaultProfile","getAssetPath","supportedProfilesList","supportedProfile","assetPath","layout","_context3","profiles","some","profileId","profilePath","deprecated","handedness","layouts","defaultComponentValues","xAxis","yAxis","VisualResponse","visualResponseDescription","componentProperty","states","valueNodeName","valueNodeProperty","minNodeName","maxNodeName","updateFromComponent","_normalizeAxes","normalizedXAxis","normalizedYAxis","normalizeAxes","includes","componentId","componentDescription","visualResponses","gamepadIndices","rootNodeName","touchPointNodeName","responseName","visualResponse","updateFromGamepad","gamepadButton","getOwnPropertyDescriptors","defineProperties","_objectSpread2","MotionController","assetUrl","layoutDescription","component","gripSpace","targetRaySpace","XRControllerModel","motionController","addAssetSceneToControllerModel","controllerModel","MotionControllerConstants","touchPointNode","getObjectByName","sphereGeometry","sphere","minNode","maxNode","valueNode","findNodes","traverse","child","isMesh","setEnvironmentMap","updateMatrixWorld","force","visible","slerp","lerpVectors","XRControllerModelFactory","gltfLoader","_assetCache","GLTFLoader","createControllerModel","controller","targetRayMode","fetchProfile","cachedAsset","WorldComponent","error_","waiting","avatars","createScene","animate","orbit","setAnimationLoop","mouse","controllerMatrix_","Matrix4","controllerWorldPosition_","controllerWorldDirection_","cameraGroup","worldRect","cameraRect","offsetWidth","logarithmicDepthBuffer","enabled","insertBefore","Raycaster","setFromCamera","objects","indicator","mainLight","light2","DirectionalLight","light3","AmbientLight","addControllers","addOffCanvasScene","avatar","removeOffCanvasScene","updateOffCanvasScene","view_","requestInfoResult","ready","onViewAssetDidChange","setViewOrientation","isPresenting","controllerGroup","controllers","controllerModelFactory","addController","showPhone","getController","onPress","onRelease","onModelUp","onLeft","onRight","onAxis","onModelDistance","userData","isSelecting","setController","buildController","controllerGrip","getControllerGrip","BufferGeometry","Float32BufferAttribute","LineBasicMaterial","vertexColors","blending","AdditiveBlending","Line","RingBufferGeometry","translate","onModelDown","tempTarget","tempParent","parent","localToWorld","worldToLocal","distanceTo","onTween","updateRaycasterXR","identity","extractRotation","ray","setFromMatrixPosition","applyMatrix4","raycasterHitTest","dragItem","resizeItem","repos","tx","ty","delta","time","tick","raycasterXRHitTest","ticker","angle","tan","updateRaycasterMouse","w2","h2","onMouseDown","raycasterDesktopHitTest","lockedOrXR","onDragMove","onResizeMove","controlEvent$","onMouseMove","onMouseUp","dragEnd","resizeEnd","onMouseWheel","deltaY","wheelDeltaY","Power4","easeOut","onOrientationDidChange","onVRStarted","onVREnded","onVRStateDidChange","onMenuNav","navTo","onMenuToggle","onNavOver","shouldShowPanel","itemId","onNavOut","onNavDown","onObjectDown","onPlayMedia","onPanelDown","onGridMove","onGridNav","control$","setSession","removeMenu","showPointer","GEOMETRY","ModelComponent","getName","getContainer","onCreate","onMount","onDismount","disposeObject","mounth","dismount","roughness","metalness","flatShading","isInteractiveMesh","isInteractiveSprite","isSprite","calculateScaleAndPosition","getScroll","getTween","PANEL_RADIUS","PANORAMA_RADIUS","ModelBannerComponent","_ModelComponent","createBanner","getCanvasTexture","wrapY","repeat","encoding","CylinderBufferGeometry","banners","updateBanner","mount","W","H","F","L","font","measureText","clearRect","textAlign","textBaseline","strokeStyle","lineWidth","lineJoin","miterLimit","strokeText","fillText","title_","ModelEditableComponent","RADIUS","editing","setHelper","showHelper","helper","BoxHelper","updateHelper","setFromObject","editing_","ModelCurvedPlaneComponent","_ModelEditableCompone","getCurvedPanelGeometry","fromArray","radius_","height_","arc_","take","textures","DebugService","setMessage","ModelDebugComponent","FontLoader","getFontLoader","fontLoader","textGroup","debugService","createText","loadFont","message_","setText","getCamera","getWorldDirection","ModelGridComponent","getTexture","getOverTexture","textureOver","getCoords","outerTileSize","row","dx","COLS","dy","ROWS","ci","ri","moveToIndex","addTiles","innerTileSize","rotateX","mapOver","tileMap","showTiles","ix","iy","addHitArea","onGroundOver","onGroundMove","onGroundDown","onGroundOut","ground","coords","move","coords_","previousTile","previousUniforms","currentUniforms","MenuButton","getTextureA","getTextureB","getX","getY","getGrid","G","rows","geometry_","ModelMenuComponent","FRAGMENT_SHADER","BackButton","_MenuButton","_proto3","onDown","buildMenu","groups","menuGroup","addMenu","back","backItem","stagger","grid","amount","removeButtons","removeToggler","addToggler","toggler","loading_","ModelModelComponent","loadGlb","animations","onGlbLoaded","decoderPath","dracoLoader","DRACOLoader","setDecoderPath","setDRACOLoader","glb","progressEvent","parseAnimations","actionIndex","actions","clock","Clock","mixer","AnimationMixer","timeScale","animation","clipAction","setEffectiveTimeScale","setEffectiveWeight","setLoop","LoopRepeat","onClipToggle","halt","dummy","Box3","sub","getCenter","endY","makeInteractive","getDelta","getInteractiveDescriptors","descriptors","interactiveDescriptors","freezableDescriptors","emittableDescriptors","NavModeType","ModelNavComponent","getNavGeometry","navGeometry","getTexturePoint","texturePoint","getTextureMove","textureMove","getTextureInfo","textureInfo","getTitleTexture","getNavMode","isValidText","onCreateSprites","icon","materials","onRemoveSprite","titleMaterial","SpriteMaterial","sizeAttenuation","Sprite","titleTexture","sprite","_THREE$Vector2","InteractiveSprite","_EmittableSprite","EmittableSprite","_FreezableSprite","FreezableSprite","_THREE$Sprite","ModelPanelComponent","viewed","xy","uv","querySelectorAll","offsetLeft","movementX","movementY","relatedTarget","screenX","screenY","imagesLoaded","promises","cors","onLoad","panelTexture","results","useCORS","backgroundColor","ModelPictureComponent","ModelPlaneComponent","LOADING_BANNER","WAITING_BANNER","ModelProgressComponent","visible_","createMesh","show","hide","updateProgress","ModelRoomComponent","loadModel","modelFolder","modelFile","FBXLoader","setHex","radians","lengthComputable","ModelTextComponent","AppModule","CoreModule","FormModule","bootstrap","Browser"],"mappings":"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rBA0F,EkJn0rBDspE,SAAA,SAAS2B,EAAOtB,GACf,IAAMlgB,EAAO,IAAIrvD,MAAMwzD,MACF,mBAAVqd,GACVA,EAAMxhB,IlJ00rBAmvB,EkJp1rBYA,CAA2BzP,IAmBhDyP,GAAmBtxE,KAAO,CACzBC,SAAU,eACVkE,MAAO,CAAElM,KAAMqhE,IACfp1D,OAAQ,CAAC,SAHV,ICkDaqtE,GAAb,SAAApkC,GAAA,SAAAokC,IAAA,OAAApkC,EAAA94C,MAAArB,KAAAoB,YAAApB,KAAA,OAAAoD,EAAAm7E,EAAApkC,GAAAokC,EAAA,CAA+BnkC,EAAAA,QAE/BmkC,GAAUvxE,KAAO,CAChBqtC,QAAS,CACRmkC,EAAAA,WACAC,EAAAA,WACAvkC,IAEDI,aAAc,CACbjuC,EACA8I,EACA0Z,GACA6B,GACAc,GACAsU,GACApN,GACAxB,GACAiC,GACAsC,GACAI,GACAC,GACA4O,GACAyK,GACA+G,GACAY,GACAgB,GACAW,GACAE,GACArJ,GACA0J,GACAC,GACAI,GACAtU,GACAr7B,EACA4vC,GACAE,GACAD,GACAE,GACAC,GACAxU,GACAU,GACAiB,GACA8S,GACApF,GACAiK,GACA/D,GACAM,GACAnB,GACA7wC,EACAiyC,GACAwB,GACAI,GACAzkB,GACA8xC,GACApB,GACAyD,GACAW,GACAY,GACA2C,GACAoB,GACAwC,GACA6B,GACAmB,GACAC,GACAG,GACAM,GACAQ,GACAz7B,GACAC,GACAzC,GACAmD,GACAjlB,GACA4lB,GACA3D,GACA2E,GACAmhB,IAEDoY,UAAWj2C,IClJZk2C,EAAAA,QAAQD,UAAUH","file":"docs\\js\\main.min.js","sourcesContent":[null,"\r\nexport const environmentServed = {\r\n\tappKey: '865af1430a854af5b01733ff9b725a2b',\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\tproduction: true,\r\n\t\tuseProxy: false,\r\n\t\tuseToken: false,\r\n\t\tselfService: true,\r\n\t\tguidedTourRequest: true,\r\n\t\teditor: false,\r\n\t\teditorAssetScreen: false,\r\n\t\tar: true,\r\n\t\tmenu: true,\r\n\t\tchat: false,\r\n\t\tattendee: true,\r\n\t\tstreamer: true,\r\n\t\tviewer: true,\r\n\t\tsmartDevice: true,\r\n\t\tmaxQuality: false,\r\n\t},\r\n\tlogo: null, //'/Modules/B-Here/Client/docs/img/logo.png'\r\n\tbackground: {\r\n\t\timage: '/Modules/B-Here/Client/docs/img/background.jpg',\r\n\t\tvideo: '/Modules/B-Here/Client/docs/img/background.mp4',\r\n\t},\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room', 'room-3d'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\tassets: '/Modules/B-Here/Client/docs/',\r\n\tworker: '/Modules/B-Here/Client/docs/js/workers/image.service.worker.js',\r\n\tgithubDocs: 'https://raw.githubusercontent.com/diegoUE8/b-here-master/more/docs/',\r\n\tlanguage: '/it',\r\n\tmarket: '/it',\r\n\turl: {\r\n\t\tindex: '/',\r\n\t\taccess: '/',\r\n\t\teditor: '/editor',\r\n\t\tselfServiceTour: '/self-service-tour',\r\n\t\tguidedTour: '/guided-tour',\r\n\t\taccessCode: '/access-code',\r\n\t},\r\n\ttemplate: {\r\n\t\ttryInAr: '/template/modules/b-here/try-in-ar.cshtml?viewId=$viewId',\r\n\t\tmodal: {\r\n\t\t\tcontrolRequest: '/template/modules/b-here/control-request-modal.cshtml',\r\n\t\t\ttryInAr: '/template/modules/b-here/try-in-ar-modal.cshtml',\r\n\t\t\tview: {\r\n\t\t\t\t'panorama': '/template/modules/b-here/panorama-modal.cshtml',\r\n\t\t\t\t'panorama-grid': '/template/modules/b-here/panorama-grid-modal.cshtml',\r\n\t\t\t\t'room-3d': '/template/modules/b-here/room-3d-modal.cshtml',\r\n\t\t\t\t'model': '/template/modules/b-here/model-modal.cshtml',\r\n\t\t\t},\r\n\t\t\tviewItem: {\r\n\t\t\t\t'nav': '/template/modules/b-here/nav-modal.cshtml',\r\n\t\t\t\t'plane': '/template/modules/b-here/plane-modal.cshtml',\r\n\t\t\t\t'curved-plane': '/template/modules/b-here/curved-plane-modal.cshtml',\r\n\t\t\t\t'texture': '/template/modules/b-here/texture-modal.cshtml',\r\n\t\t\t\t'model': '/template/modules/b-here/item-model-modal.cshtml',\r\n\t\t\t},\r\n\t\t\tremove: '/template/modules/b-here/remove-modal.cshtml',\r\n\t\t}\r\n\t},\r\n\tlanguages: ['en'],\r\n\tdefaultLanguage: 'en',\r\n};\r\n","\r\nexport class Utils {\r\n\r\n\tstatic merge(target, source) {\r\n\t\tif (typeof source === 'object') {\r\n\t\t\tObject.keys(source).forEach(key => {\r\n\t\t\t\tconst value = source[key];\r\n\t\t\t\tif (typeof value === 'object' && !Array.isArray(value)) {\r\n\t\t\t\t\ttarget[key] = this.merge(target[key], value);\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttarget[key] = value;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn target;\r\n\t}\r\n\r\n}\r\n","import { environmentServed } from './environment.served';\r\nimport { environmentStatic } from './environment.static';\r\nimport { Utils } from './utils/utils';\r\n\r\nexport const NODE = (typeof module !== 'undefined' && module.exports);\r\nexport const PARAMS = NODE ? { get: () => { } } : new URLSearchParams(window.location.search);\r\nexport const DEBUG = false || (PARAMS.get('debug') != null);\r\nexport const BASE_HREF = NODE ? null : document.querySelector('base').getAttribute('href');\r\nexport const HEROKU = NODE ? false : (window && window.location.host.indexOf('herokuapp') !== -1);\r\nexport const STATIC = NODE ? false : (HEROKU || (window && (window.location.port === '41789' || window.location.port === '5000' || window.location.port === '6443' || window.location.host === 'diegoUE8.github.io')));\r\nexport const DEVELOPMENT = NODE ? false : (window && ['localhost', '127.0.0.1', '0.0.0.0'].indexOf(window.location.host.split(':')[0]) !== -1);\r\nexport const PRODUCTION = !DEVELOPMENT;\r\nexport const ENV = {\r\n\tSTATIC,\r\n\tDEVELOPMENT,\r\n\tPRODUCTION\r\n};\r\n\r\nexport class Environment {\r\n\r\n\tget STATIC() {\r\n\t\treturn ENV.STATIC;\r\n\t}\r\n\tset STATIC(STATIC) {\r\n\t\tENV.STATIC = (STATIC === true || STATIC === 'true');\r\n\t\tconsole.log('Environment.STATIC.set', ENV.STATIC);\r\n\t}\r\n\r\n\tget href() {\r\n\t\tif (HEROKU) {\r\n\t\t\treturn this.githubDocs;\r\n\t\t} else {\r\n\t\t\treturn BASE_HREF;\r\n\t\t}\r\n\t}\r\n\r\n\tgetAbsoluteUrl(path, params) {\r\n\t\tlet url = `${window.location.origin}${path}`;\r\n\t\t// let url = `${window.location.protocol}//${window.location.host}${path}`;\r\n\t\tObject.keys(params).forEach(key => {\r\n\t\t\turl = url.replace(`$${key}`, params[key]);\r\n\t\t});\r\n\t\treturn url;\r\n\t}\r\n\r\n\tgetPath(path) {\r\n\t\treturn this.isLocal(path) ? (this.href + path) : path;\r\n\t}\r\n\r\n\tisLocal(path) {\r\n\t\treturn path.indexOf('://') === -1;\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tif (typeof options.url === 'object') {\r\n\t\t\t\tconst language = options.language || '';\r\n\t\t\t\tconst market = options.market || '';\r\n\t\t\t\tObject.keys(options.url).forEach(key => {\r\n\t\t\t\t\toptions.url[key] = language + market + options.url[key];\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nconst defaultOptions = {\r\n\tport: 5000,\r\n\tfontFamily: 'GT Walsheim, sans-serif',\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room', 'room-3d'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\trenderOrder: {\r\n\t\tpanorama: 0,\r\n\t\tmodel: 10,\r\n\t\tplane: 20,\r\n\t\ttile: 30,\r\n\t\tbanner: 40,\r\n\t\tnav: 50,\r\n\t\tpanel: 60,\r\n\t\tmenu: 70,\r\n\t\tdebug: 80,\r\n\t\tpointer: 90,\r\n\t}\r\n};\r\n\r\nconst defaultAppOptions = {\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\tproduction: false,\r\n\t\tuseProxy: false,\r\n\t\tuseToken: false,\r\n\t\tselfService: true,\r\n\t\tguidedTourRequest: true,\r\n\t\teditor: true,\r\n\t\tar: true,\r\n\t\tmenu: true,\r\n\t\tattendee: true,\r\n\t\tstreamer: true,\r\n\t\tviewer: true,\r\n\t\tsmartDevice: true,\r\n\t\tmaxQuality: false,\r\n\t\theroku: HEROKU,\r\n\t},\r\n};\r\n\r\nconst environmentOptions = window.STATIC ? environmentStatic : environmentServed;\r\n\r\nlet options = Object.assign(defaultOptions, defaultAppOptions, environmentOptions);\r\noptions = Utils.merge(options, window.bhere);\r\n\r\nexport const environment = new Environment(options);\r\n\r\nconsole.log('environment', environment);\r\n","\r\nexport const environmentStatic = {\r\n\tappKey: '865af1430a854af5b01733ff9b725a2b',\r\n\tchannelName: 'BHere',\r\n\tflags: {\r\n\t\tproduction: false,\r\n\t\tuseProxy: false,\r\n\t\tuseToken: false,\r\n\t\tselfService: true,\r\n\t\tguidedTourRequest: true,\r\n\t\teditor: true,\r\n\t\teditorAssetScreen: true,\r\n\t\tar: true,\r\n\t\tmenu: true,\r\n\t\tchat: true,\r\n\t\tattendee: true,\r\n\t\tstreamer: true,\r\n\t\tviewer: true,\r\n\t\tsmartDevice: true,\r\n\t\tmaxQuality: false,\r\n\t},\r\n\tlogo: null, //'/b-here/img/logo.png'\r\n\tbackground: {\r\n\t\timage: '/b-here/img/background.jpg',\r\n\t\tvideo: '/b-here/img/background.mp4',\r\n\t},\r\n\tcolors: {\r\n\t\tmenuBackground: '#000000',\r\n\t\tmenuForeground: '#ffffff',\r\n\t\tmenuOverBackground: '#0099ff',\r\n\t\tmenuOverForeground: '#ffffff',\r\n\t\tmenuBackBackground: '#0099ff',\r\n\t\tmenuBackForeground: '#000000',\r\n\t\tmenuBackOverBackground: '#0099ff',\r\n\t\tmenuBackOverForeground: '#ffffff',\r\n\t},\r\n\teditor: {\r\n\t\tdisabledViewTypes: ['waiting-room', 'room-3d'],\r\n\t\tdisabledViewItemTypes: ['texture'],\r\n\t},\r\n\tassets: '/b-here/',\r\n\tworker: './js/workers/image.service.worker.js',\r\n\tgithubDocs: 'https://raw.githubusercontent.com/diegoUE8/b-here-master/more/docs/',\r\n\tlanguage: '',\r\n\tmarket: '',\r\n\turl: {\r\n\t\tindex: '/',\r\n\t\taccess: '/',\r\n\t\teditor: '/editor',\r\n\t\tselfServiceTour: '/self-service-tour',\r\n\t\tguidedTour: '/guided-tour',\r\n\t\taccessCode: '/access-code',\r\n\t},\r\n\ttemplate: {\r\n\t\ttryInAr: '/try-in-ar.html?viewId=$viewId',\r\n\t\tmodal: {\r\n\t\t\tcontrolRequest: '/control-request-modal.html',\r\n\t\t\ttryInAr: '/try-in-ar-modal.html',\r\n\t\t\tview: {\r\n\t\t\t\t'panorama': '/panorama-modal.html',\r\n\t\t\t\t'panorama-grid': '/panorama-grid-modal.html',\r\n\t\t\t\t'room-3d': '/room-3d-modal.html',\r\n\t\t\t\t'model': '/model-modal.html',\r\n\t\t\t},\r\n\t\t\tviewItem: {\r\n\t\t\t\t'nav': '/nav-modal.html',\r\n\t\t\t\t'plane': '/plane-modal.html',\r\n\t\t\t\t'curved-plane': '/curved-plane-modal.html',\r\n\t\t\t\t'texture': '/texture-modal.html',\r\n\t\t\t\t'model': '/item-model-modal.html',\r\n\t\t\t},\r\n\t\t\tremove: '/remove-modal.html',\r\n\t\t}\r\n\t},\r\n\tlanguages: ['en'],\r\n\tdefaultLanguage: 'en',\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\n\r\nexport default class AccessCodeComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.env = environment;\r\n\t\tconst link = LocationService.get('link');\r\n\t\tif (!link) {\r\n\t\t\twindow.location.href = `${window.location.origin}${environment.url.guidedTour}`;\r\n\t\t}\r\n\t\tconst url = `${window.location.origin}${environment.url.guidedTour}?link=${link}`;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst qrcode = new QRious({\r\n\t\t\telement: node.querySelector('.qrcode'),\r\n\t\t\tvalue: url,\r\n\t\t\tsize: 256\r\n\t\t});\r\n\t}\r\n}\r\n\r\nAccessCodeComponent.meta = {\r\n\tselector: '[access-code-component]',\r\n};\r\n","export default class LocationService {\r\n\r\n\tstatic has(key) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t// console.log('LocationService.has', params);\r\n\t\treturn params.has(key);\r\n\t}\r\n\r\n\tstatic get(key) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t// console.log('LocationService.get', params);\r\n\t\treturn params.get(key);\r\n\t}\r\n\r\n\tstatic set(keyOrValue, value) {\r\n\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\tif (typeof keyOrValue === 'string') {\r\n\t\t\tparams.set(keyOrValue, value);\r\n\t\t} else {\r\n\t\t\tparams.set(keyOrValue, '');\r\n\t\t}\r\n\t\tthis.replace(params);\r\n\t\t// console.log('LocationService.set', params, keyOrValue, value);\r\n\t}\r\n\r\n\tstatic replace(params) {\r\n\t\tif (window.history && window.history.pushState) {\r\n\t\t\tconst title = document.title;\r\n\t\t\tconst url = `${window.location.href.split('?')[0]}?${params.toString()}`;\r\n\t\t\twindow.history.pushState(params.toString(), title, url);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic deserialize(key) {\r\n\t\tconst encoded = this.get('params');\r\n\t\treturn this.decode(key, encoded);\r\n\t}\r\n\r\n\tstatic serialize(keyOrValue, value) {\r\n\t\tconst params = this.deserialize();\r\n\t\tconst encoded = this.encode(keyOrValue, value, params);\r\n\t\tthis.set('params', encoded);\r\n\t}\r\n\r\n\tstatic decode(key, encoded) {\r\n\t\tlet decoded = null;\r\n\t\tif (encoded) {\r\n\t\t\tconst json = window.atob(encoded);\r\n\t\t\tdecoded = JSON.parse(json);\r\n\t\t}\r\n\t\tif (key && decoded) {\r\n\t\t\tdecoded = decoded[key];\r\n\t\t}\r\n\t\treturn decoded || null;\r\n\t}\r\n\r\n\tstatic encode(keyOrValue, value, params) {\r\n\t\tparams = params || {};\r\n\t\tlet encoded = null;\r\n\t\tif (typeof keyOrValue === 'string') {\r\n\t\t\tparams[keyOrValue] = value;\r\n\t\t} else {\r\n\t\t\tparams = keyOrValue;\r\n\t\t}\r\n\t\tconst json = JSON.stringify(params);\r\n\t\tencoded = window.btoa(json);\r\n\t\treturn encoded;\r\n\t}\r\n\r\n}\r\n","import { Pipe } from \"rxcomp\";\r\nimport { Utils } from \"../utils/utils\";\r\n\r\nexport const LABELS = Utils.merge({\r\n\tbrowse: 'Browse',\r\n\tcancel: 'Cancel',\r\n\tdrag_and_drop_images: 'Drag And Drop your images here',\r\n\terror_email: 'Invalid email',\r\n\terror_match: 'Fields do not match',\r\n\terror_required: 'Field is required',\r\n\tloading: 'loading',\r\n\tremove: 'Remove',\r\n\trequired: 'Required',\r\n\tselect: 'Select',\r\n\tselect_file: 'Select a file...',\r\n\tupdate: 'Update',\r\n\tupload: 'Upload',\r\n\twaiting_host: 'waiting host',\r\n\t// editor\r\n\teditor_image: 'Image',\r\n\teditor_video: 'Video',\r\n\teditor_model: 'Model',\r\n\teditor_publisher_stream: 'Publisher Stream',\r\n\teditor_next_attendee_stream: 'Next Attendee Stream',\r\n\teditor_waiting_room: 'Waiting Room',\r\n\teditor_panorama: 'Panorama',\r\n\teditor_panorama_grid: 'Panorama Grid',\r\n\teditor_room_3d: 'Room 3D',\r\n\teditor_model: 'Model',\r\n\teditor_nav: 'Nav Tooltip',\r\n\teditor_gltf: 'Gltf Model',\r\n\teditor_plane: 'Plane',\r\n\teditor_curved_plane: 'Curved Plane',\r\n\teditor_texture: 'Texture',\r\n}, window.labels);\r\n\r\nexport default class LabelPipe extends Pipe {\r\n\r\n\tstatic transform(key) {\r\n\t\tconst labels = LABELS;\r\n\t\treturn labels[key] || `#${key}#`;\r\n\t}\r\n\r\n\tstatic getKeys(...keys) {\r\n\t\treturn this.transform(keys.map(x => x.replace('-','_')).join('_'));\r\n\t}\r\n}\r\n\r\nLabelPipe.meta = {\r\n\tname: 'label',\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormAbstractCollectionDirective, FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport LabelPipe from '../label/label.pipe';\r\n\r\nexport default class ControlsComponent extends Component {\r\n\r\n\tget group() {\r\n\t\tif (this.formGroup) {\r\n\t\t\treturn this.formGroup;\r\n\t\t} else {\r\n\t\t\tif (!this.host) {\r\n\t\t\t\tthrow ('missing form collection');\r\n\t\t\t}\r\n\t\t\treturn this.host.control;\r\n\t\t}\r\n\t}\r\n\r\n\tgetControl(name) {\r\n\t\treturn this.group.get(name);\r\n\t}\r\n}\r\n\r\nControlsComponent.meta = {\r\n\tselector: '[controls]',\r\n\tinputs: ['formGroup', 'fields'],\r\n\thosts: { host: FormAbstractCollectionDirective },\r\n\ttemplate: /* html */`\r\n\t\t<div *for=\"let field of fields\">\r\n\t\t\t<div *if=\"['text', 'email', 'url'].indexOf(field.type) !== -1\" control-text [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'select'\" control-select [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'custom-select'\" control-custom-select [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'textarea'\" control-textarea [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<div *if=\"field.type == 'checkbox'\" control-checkbox [control]=\"getControl(field.name)\" [label]=\"field.label | label\"></div>\r\n\t\t\t<input *if=\"field.type == 'hidden'\" [name]=\"field.name\" [formControl]=\"getControl(field.name)\" value=\"\" type=\"text\" style=\"display:none !important;\" />\r\n\t\t</div>\r\n\t`,\r\n};\r\n\r\nexport function fieldsToFormControls(fields) {\r\n\tconst controls = fields.reduce((p, c, i) => {\r\n\t\tconst validators = [];\r\n\t\tif (c.required) {\r\n\t\t\tvalidators.push(c.type === 'checkbox' ? Validators.RequiredTrueValidator() : Validators.RequiredValidator());\r\n\t\t}\r\n\t\tif (c.type === 'email') {\r\n\t\t\tvalidators.push(Validators.EmailValidator());\r\n\t\t}\r\n\t\tif (c.type === 'url') {\r\n\t\t\tvalidators.push(Validators.PatternValidator('(https?:\\/\\/(?:www\\.|(?!www))[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|www\\.[a-zA-Z0-9][a-zA-Z0-9-]+[a-zA-Z0-9]\\.[^\\s]{2,}|https?:\\/\\/(?:www\\.|(?!www))[a-zA-Z0-9]+\\.[^\\s]{2,}|www\\.[a-zA-Z0-9]+\\.[^\\s]{2,})'));\r\n\t\t}\r\n\t\tif (c.pattern != null) {\r\n\t\t\tvalidators.push(Validators.PatternValidator(c.pattern));\r\n\t\t}\r\n\t\tp[c.name] = new FormControl((c.value != null ? c.value : null), validators);\r\n\t\tif (c.type === 'select' || c.type === 'custom-select') {\r\n\t\t\tconst options = (c.options || []).slice();\r\n\t\t\toptions.unshift({ id: null, name: LabelPipe.transform('select') });\r\n\t\t\tp[c.name].options = options;\r\n\t\t}\r\n\t\treturn p;\r\n\t}, {});\r\n\treturn controls;\r\n}\r\n\r\nexport function fieldsToFormGroup(fields) {\r\n\treturn new FormGroup(fieldsToFormControls(fields));\r\n}\r\n\r\nexport function patchFields(fields, form) {\r\n\tconst testValues = fields.reduce((p, c, i) => {\r\n\t\tif (c.test) {\r\n\t\t\tp[c.name] = c.test;\r\n\t\t}\r\n\t\treturn p;\r\n\t}, {});\r\n\tform.patch(testValues);\r\n}\r\n","import { from, throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nexport class HttpResponse {\r\n\r\n\tget static() {\r\n\t\treturn this.url.indexOf('.json') === this.url.length - 5;\r\n\t}\r\n\r\n\tconstructor(response) {\r\n\t\tthis.data = null;\r\n\t\tif (response) {\r\n\t\t\tthis.url = response.url;\r\n\t\t\tthis.status = response.status;\r\n\t\t\tthis.statusText = response.statusText;\r\n\t\t\tthis.ok = response.ok;\r\n\t\t\tthis.redirected = response.redirected;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport default class HttpService {\r\n\r\n\tstatic http$(method, url, data, format = 'json') {\r\n\t\tconst methods = ['POST', 'PUT', 'PATCH'];\r\n\t\tlet response_ = null;\r\n\t\t// url = this.getUrl(url, format);\r\n\t\treturn from(fetch(url, {\r\n\t\t\tmethod: method,\r\n\t\t\theaders: {\r\n\t\t\t\t'Accept': 'application/json',\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t},\r\n\t\t\tbody: methods.indexOf(method) !== -1 ? JSON.stringify(data) : undefined\r\n\t\t}).then((response) => {\r\n\t\t\tresponse_ = response;\r\n\t\t\t// console.log(response);\r\n\t\t\ttry {\r\n\t\t\t\tconst contentType = response.headers.get('content-type');\r\n\t\t\t\tlet typedResponse;\r\n\t\t\t\tif (contentType && contentType.indexOf('application/json') !== -1) {\r\n\t\t\t\t\ttypedResponse = response.json();\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttypedResponse = response.text();\r\n\t\t\t\t}\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\treturn typedResponse;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn typedResponse.then(data => {\r\n\t\t\t\t\t\treturn Promise.reject(data);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} catch(error) {\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\tconsole.warn('HttpService.http$', 'Cannot parse response');\r\n\t\t\t\t\treturn Promise.resolve();\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn Promise.reject(error);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})).pipe(\r\n\t\t\tcatchError(error => {\r\n\t\t\t\treturn throwError(this.getError(error, response_));\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\t/*\r\n\t// !!! todo mapping response.data\r\n\tstatic http$(method, url, data, format = 'json') {\r\n\t\tconst methods = ['POST', 'PUT', 'PATCH'];\r\n\t\tconst body = (data && methods.indexOf(method) !== -1) ? JSON.stringify(data) : undefined;\r\n\t\tconst queryString = (data && methods.indexOf(method) !== -1) ? Object.keys(data).map(function(key) {\r\n\t\t    return key + '=' + encodeURI(data[key]);\r\n\t\t}).join('&') : undefined;\r\n\t\tif (queryString) {\r\n\t\t\turl = `${url}?${queryString}`;\r\n\t\t}\r\n\t\tlet response_ = null;\r\n\t\treturn from(fetch(url, {\r\n\t\t\tmethod: method,\r\n\t\t\theaders: {\r\n\t\t\t\t'Accept': 'application/json',\r\n\t\t\t\t'Content-Type': 'application/json',\r\n\t\t\t},\r\n\t\t\tbody: body,\r\n\t\t}).then((response) => {\r\n\t\t\tresponse_ = new HttpResponse(response);\r\n\t\t\ttry {\r\n\t\t\t\tconst contentType = response.headers.get('content-type');\r\n\t\t\t\tlet typedResponse;\r\n\t\t\t\tif (contentType && format === 'json' && contentType.indexOf('application/json') !== -1) {\r\n\t\t\t\t\ttypedResponse = response.json();\r\n\t\t\t\t} else if (format === 'blob') {\r\n\t\t\t\t\ttypedResponse = response.blob();\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttypedResponse = response.text();\r\n\t\t\t\t}\r\n\t\t\t\treturn typedResponse.then(data => {\r\n\t\t\t\t\tresponse_.data = data;\r\n\t\t\t\t\tif (response.ok) {\r\n\t\t\t\t\t\treturn Promise.resolve(response_);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn Promise.reject(response_);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t} catch(error) {\r\n\t\t\t\tif (response.ok) {\r\n\t\t\t\t\tconsole.warn('HttpService.http$', 'Cannot parse response');\r\n\t\t\t\t\treturn Promise.resolve(response_);\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn Promise.reject(this.getError(error, response_));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t})).pipe(\r\n\t\t\tcatchError(error => {\r\n\t\t\t\treturn throwError(this.getError(error, response_));\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\t*/\r\n\r\n\tstatic get$(url, data, format) {\r\n\t\tconst query = this.query(data);\r\n\t\treturn this.http$('GET', `${url}${query}`, undefined, format);\r\n\t}\r\n\r\n\tstatic delete$(url) {\r\n\t\treturn this.http$('DELETE', url);\r\n\t}\r\n\r\n\tstatic post$(url, data) {\r\n\t\treturn this.http$('POST', url, data);\r\n\t}\r\n\r\n\tstatic put$(url, data) {\r\n\t\treturn this.http$('PUT', url, data);\r\n\t}\r\n\r\n\tstatic patch$(url, data) {\r\n\t\treturn this.http$('PATCH', url, data);\r\n\t}\r\n\r\n\tstatic query(data) {\r\n\t\treturn ''; // todo\r\n\t}\r\n\r\n\tstatic getError(object, response) {\r\n\t\tlet error = typeof object === 'object' ? object : {};\r\n\t\tif (!error.status) {\r\n\t\t\terror.status = response ? response.status : 0;\r\n\t\t}\r\n\t\tif (!error.statusCode) {\r\n\t\t\terror.statusCode = response ? response.status : 0;\r\n\t\t}\r\n\t\tif (!error.statusMessage) {\r\n\t\t\terror.statusMessage = response ? response.statusText : object;\r\n\t\t}\r\n\t\t// console.log('HttpService.getError', error, object);\r\n\t\treturn error;\r\n\t}\r\n\r\n}\r\n","\r\nexport const RoleType = {\r\n\tPublisher: 'publisher',\r\n\tAttendee: 'attendee',\r\n\tStreamer: 'streamer',\r\n\tViewer: 'viewer',\r\n\tSmartDevice: 'smart-device',\r\n\tSelfService: 'self-service',\r\n};\r\n\r\nexport class User {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n","import { BehaviorSubject, of } from 'rxjs';\r\nimport { catchError, map, switchMap, tap } from 'rxjs/operators';\r\nimport HttpService from '../http/http.service';\r\nimport { User } from './user';\r\n\r\nexport class UserService {\r\n\r\n\tstatic setUser(user) {\r\n\t\tthis.user$.next(user);\r\n\t}\r\n\r\n\tstatic me$() {\r\n\t\treturn HttpService.get$('/api/user/me').pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\tcatchError(error => {\r\n\t\t\t\t// console.log('UserService.me$.error', error);\r\n\t\t\t\tif (error.status === 404 || error.statusCode === 404) {\r\n\t\t\t\t\treturn of(null);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow (error);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tswitchMap(user => {\r\n\t\t\t\tthis.setUser(user);\r\n\t\t\t\treturn this.user$;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic login$(payload) {\r\n\t\treturn HttpService.post$('/api/user/login', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic logout$() {\r\n\t\treturn HttpService.get$('/api/user/logout').pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(null)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic guidedTour$(payload) {\r\n\t\treturn HttpService.post$('/api/user/guided-tour', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic selfServiceTour$(payload) {\r\n\t\treturn HttpService.post$('/api/user/self-service-tour', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t\ttap((user) => this.setUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic resolve$(payload, status) {\r\n\t\tif (status === 'login') {\r\n\t\t\treturn this.login$(payload);\r\n\t\t}\r\n\t\tif (status === 'guided-tour') {\r\n\t\t\treturn this.guidedTour$(payload);\r\n\t\t}\r\n\t\tif (status === 'self-service-tour') {\r\n\t\t\treturn this.selfServiceTour$(payload);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic log$(payload) {\r\n\t\treturn HttpService.post$('/api/user/log', payload);\r\n\t}\r\n\r\n\t/*\r\n\tstatic retrieve$(payload) {\r\n\t\treturn HttpService.post$('/api/user/retrievepassword', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic register$(payload) {\r\n\t\treturn HttpService.post$('/api/user/register', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic update(payload) {\r\n\t\treturn HttpService.post$('/api/user/updateprofile', payload).pipe(\r\n\t\t\tmap((user) => this.mapUser(user)),\r\n\t\t);\r\n\t}\r\n\t*/\r\n\r\n\tstatic mapUser(user) {\r\n\t\treturn new User(user);\r\n\t}\r\n\r\n}\r\n\r\nUserService.user$ = new BehaviorSubject(null);\r\n","import { Component } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { environment, STATIC } from '../environment';\r\nimport { fieldsToFormGroup, patchFields } from '../forms/controls.component';\r\nimport { UserService } from '../user/user.service';\r\n\r\nexport default class AccessComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.env = environment;\r\n\t\tthis.state = {\r\n\t\t\tstatus: 'access',\r\n\t\t};\r\n\t\t/*\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tconsole.log('AccessComponent.state', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tonSelfServiceTourRequest() {\r\n\t\tthis.initRequestForm();\r\n\t\tthis.state.status = 'self-service-tour';\r\n\t\tthis.pushChanges();\r\n\t\tif (STATIC && window.navigator.userAgent.indexOf('OculusBrowser') !== -1) {\r\n\t\t\tthis.test();\r\n\t\t\tthis.onSubmit();\r\n\t\t}\r\n\t}\r\n\r\n\tonGuidedTourRequest() {\r\n\t\tthis.initRequestForm();\r\n\t\tthis.state.status = 'guided-tour';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonGuidedTourAccess() {\r\n\t\tUserService.logout$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\twindow.location.href = environment.url.guidedTour;\r\n\t\t});\r\n\t}\r\n\r\n\tonLogin() {\r\n\t\tthis.initLoginForm();\r\n\t\tthis.state.status = 'login';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tinitRequestForm() {\r\n\t\tif (this.formSubscription) {\r\n\t\t\tthis.formSubscription.unsubscribe();\r\n\t\t}\r\n\r\n\t\tconst data = this.data = window.data || {\r\n\t\t\troles: [\r\n\t\t\t\t{ id: 1, name: 'Show room' },\r\n\t\t\t\t{ id: 2, name: 'Architetto' },\r\n\t\t\t\t{ id: 3, name: 'Interior designer' },\r\n\t\t\t\t{ id: 4, name: 'Privato' },\r\n\t\t\t\t{ id: 5, name: 'Altro' }\r\n\t\t\t],\r\n\t\t};\r\n\r\n\t\tconst fields = this.fields = window.fields || [\r\n\t\t\t{ type: 'text', name: 'firstName', label: 'access_first_name', required: true, test: 'Jhon' },\r\n\t\t\t{ type: 'text', name: 'lastName', label: 'access_last_name', required: true, test: 'Appleseed' },\r\n\t\t\t{ type: 'email', name: 'email', label: 'access_email', required: true, test: 'jhonappleseed@gmail.com' },\r\n\t\t\t{ type: 'custom-select', name: 'role', label: 'access_role', required: true, options: window.data.roles, test: window.data.roles[0].id },\r\n\t\t\t{ type: 'checkbox', name: 'privacy', label: 'access_privacy_disclaimer', required: true, test: true },\r\n\t\t];\r\n\r\n\t\tfields.push(\r\n\t\t\t{ type: 'hidden', name: 'checkField', value: '', test: '' },\r\n\t\t\t{ type: 'none', name: 'checkRequest', value: window.antiforgery || '', test: window.antiforgery || '' }\r\n\t\t);\r\n\r\n\t\tconst form = this.form = fieldsToFormGroup(fields);\r\n\t\t/*\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tfirstName: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tlastName: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\temail: new FormControl(null, [Validators.RequiredValidator(), Validators.EmailValidator()]),\r\n\t\t\trole: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tprivacy: new FormControl(null, Validators.RequiredTrueValidator()),\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: '',\r\n\t\t});\r\n\t\t*/\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\t/*\r\n\t\tconst options = data.roles.slice();\r\n\t\toptions.unshift({ id: null, name: LabelPipe.transform('select') });\r\n\t\tcontrols.role.options = options;\r\n\t\t*/\r\n\r\n\t\tthis.formSubscription = form.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\tinitLoginForm() {\r\n\t\tif (this.formSubscription) {\r\n\t\t\tthis.formSubscription.unsubscribe();\r\n\t\t}\r\n\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tusername: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tpassword: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: '',\r\n\t\t});\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\r\n\t\tthis.formSubscription = form.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\ttest() {\r\n\t\tif (this.state.status === 'login') {\r\n\t\t\tthis.form.patch({\r\n\t\t\t\tusername: 'publisher',\r\n\t\t\t\tpassword: 'publisher',\r\n\t\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\t\tcheckField: ''\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tpatchFields(this.fields, this.form);\r\n\t\t\t/*\r\n\t\t\tthis.form.patch({\r\n\t\t\t\tfirstName: 'Jhon',\r\n\t\t\t\tlastName: 'Appleseed',\r\n\t\t\t\temail: 'jhonappleseed@gmail.com',\r\n\t\t\t\trole: this.controls.role.options.find(x => x.id !== null).id,\r\n\t\t\t\tprivacy: true,\r\n\t\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\t\tcheckField: ''\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\treset() {\r\n\t\tthis.form.reset();\r\n\t}\r\n\r\n\tonBack() {\r\n\t\tthis.state.status = 'access';\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst payload = this.form.value;\r\n\t\t\tconst status = this.state.status;\r\n\t\t\tUserService.resolve$(payload, status).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('AccessComponent.onSubmit', response);\r\n\t\t\t\tswitch (status) {\r\n\t\t\t\t\tcase 'guided-tour':\r\n\t\t\t\t\t\tthis.state.status = 'guided-tour-success';\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'self-service-tour':\r\n\t\t\t\t\t\twindow.location.href = environment.url.selfServiceTour;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'login':\r\n\t\t\t\t\t\twindow.location.href = environment.url.guidedTour;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('AccessComponent.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n}\r\n\r\nAccessComponent.meta = {\r\n\tselector: '[access-component]',\r\n};\r\n","import { ReplaySubject } from \"rxjs\";\r\n\r\nexport default class MessageService {\r\n\tstatic message$ = new ReplaySubject(1);\r\n\tstatic message(message) {\r\n\t\tthis.message$.next(message);\r\n\t}\r\n\r\n\tstatic in$ = new ReplaySubject(1);\r\n\tstatic in(message) {\r\n\t\tthis.in$.next(message);\r\n\t}\r\n\tstatic send = MessageService.in;\r\n\tstatic sendBack(message) {\r\n\t\tmessage = Object.assign({}, message, { remoteId: message.clientId });\r\n\t\t// console.log('MessageService.sendBack', message);\r\n\t\tthis.in$.next(message);\r\n\t}\r\n\r\n\tstatic out$ = new ReplaySubject(1);\r\n\tstatic out(message) {\r\n\t\tthis.out$.next(message);\r\n\t}\r\n}\r\n","import { BehaviorSubject } from \"rxjs\";\r\n\r\nexport default class StateService {\r\n\tstatic state$ = new BehaviorSubject({});\r\n\tstatic set state(state) {\r\n\t\tthis.state$.next(state);\r\n\t}\r\n\tstatic get state() {\r\n\t\treturn this.state$.getValue();\r\n\t}\r\n\tstatic patchState(state) {\r\n\t\tstate = Object.assign({}, this.state, state);\r\n\t\tthis.state = state;\r\n\t}\r\n}\r\n","export default class Emittable {\r\n\r\n\tconstructor() {\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\tonce(type, callback) {\r\n\t\tconst once = (data) => {\r\n\t\t\tcallback(data);\r\n\t\t\tthis.off(type, once);\r\n\t\t};\r\n\t\tthis.on(type, once);\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\thas(type) {\r\n\t\tconst callbacks = this.events[type];\r\n\t\treturn callbacks && callbacks.length;\r\n\t}\r\n\r\n}\r\n","export default class SessionStorageService {\r\n\r\n\tstatic delete(name) {\r\n\t\tif (this.isSessionStorageSupported()) {\r\n\t\t\twindow.sessionStorage.removeItem(name);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic exist(name) {\r\n\t\tif (this.isSessionStorageSupported()) {\r\n\t\t\treturn window.sessionStorage[name] !== undefined;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get(name) {\r\n\t\tlet value = null;\r\n\t\tif (this.isSessionStorageSupported() && window.sessionStorage[name] !== undefined) {\r\n\t\t\ttry {\r\n\t\t\t\tvalue = JSON.parse(window.sessionStorage[name]);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('SessionStorageService.get.error parsing', name, e);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn value;\r\n\t}\r\n\r\n\tstatic set(name, value) {\r\n\t\tif (this.isSessionStorageSupported()) {\r\n\t\t\ttry {\r\n\t\t\t\tconst cache = [];\r\n\t\t\t\tconst json = JSON.stringify(value, function(key, value) {\r\n\t\t\t\t\tif (typeof value === 'object' && value !== null) {\r\n\t\t\t\t\t\tif (cache.indexOf(value) !== -1) {\r\n\t\t\t\t\t\t\t// Circular reference found, discard key\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcache.push(value);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn value;\r\n\t\t\t\t});\r\n\t\t\t\twindow.sessionStorage.setItem(name, json);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('SessionStorageService.set.error serializing', name, value, e);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic isSessionStorageSupported() {\r\n\t\tif (this.supported) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tlet supported = false;\r\n\t\ttry {\r\n\t\t\tsupported = 'sessionStorage' in window && window.sessionStorage !== null;\r\n\t\t\tif (supported) {\r\n\t\t\t\twindow.sessionStorage.setItem('test', '1');\r\n\t\t\t\twindow.sessionStorage.removeItem('test');\r\n\t\t\t} else {\r\n\t\t\t\tsupported = false;\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tsupported = false;\r\n\t\t}\r\n\t\tthis.supported = supported;\r\n\t\treturn supported;\r\n\t}\r\n}\r\n","import { BehaviorSubject, combineLatest, interval, of } from 'rxjs';\r\nimport { distinctUntilChanged, filter, map, shareReplay, switchMap } from 'rxjs/operators';\r\nimport { RoleType } from '../user/user';\r\n\r\nconst MAX_VISIBLE_STREAMS = 8;\r\n\r\nexport const StreamServiceMode = {\r\n\tClient: 'client',\r\n\tEditor: 'editor',\r\n};\r\n\r\nexport default class StreamService {\r\n\r\n\tstatic mode = StreamServiceMode.Client;\r\n\r\n\tstatic editorStreams$ = new BehaviorSubject(null);\r\n\tstatic set editorStreams(editorStreams) {\r\n\t\tthis.editorStreams$.next(editorStreams);\r\n\t}\r\n\tstatic get editorStreams() {\r\n\t\treturn this.editorStreams$.getValue();\r\n\t}\r\n\r\n\tstatic editorScreens$ = new BehaviorSubject(null);\r\n\tstatic set editorScreens(editorScreens) {\r\n\t\tthis.editorScreens$.next(editorScreens);\r\n\t}\r\n\tstatic get editorScreens() {\r\n\t\treturn this.editorScreens$.getValue();\r\n\t}\r\n\r\n\tstatic local$ = new BehaviorSubject(null);\r\n\tstatic set local(local) {\r\n\t\tthis.local$.next(local);\r\n\t}\r\n\tstatic get local() {\r\n\t\treturn this.local$.getValue();\r\n\t}\r\n\r\n\tstatic screen$ = new BehaviorSubject(null);\r\n\tstatic set screen(screen) {\r\n\t\tthis.screen$.next(screen);\r\n\t}\r\n\tstatic get screen() {\r\n\t\treturn this.screen$.getValue();\r\n\t}\r\n\r\n\tstatic remotes$ = new BehaviorSubject([]);\r\n\tstatic set remotes(remotes) {\r\n\t\tthis.remotes$.next(remotes);\r\n\t}\r\n\tstatic get remotes() {\r\n\t\treturn this.remotes$.getValue();\r\n\t}\r\n\r\n\tstatic peers$ = new BehaviorSubject([]);\r\n\tstatic set peers(peers) {\r\n\t\tthis.peers$.next(peers);\r\n\t}\r\n\tstatic get peers() {\r\n\t\treturn this.peers$.getValue();\r\n\t}\r\n\r\n\tstatic orderedRemotes$() {\r\n\t\treturn combineLatest([StreamService.remotes$, interval(1000)]).pipe(\r\n\t\t\tmap(datas => {\r\n\t\t\t\tconst orderedRemotes = [];\r\n\t\t\t\tconst remotes = datas[0];\r\n\t\t\t\tremotes.forEach(remote => {\r\n\t\t\t\t\t// const audioLevel = remote.getAudioLevel();\r\n\t\t\t\t\t// console.log('audioLevel', audioLevel, remote);\r\n\t\t\t\t\tif (remote.clientInfo) {\r\n\t\t\t\t\t\tremote.clientInfo.audioLevel = remote.getAudioLevel();\r\n\t\t\t\t\t\tremote.clientInfo.peekAudioLevel = Math.max(remote.clientInfo.audioLevel, 0.2);\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tif (remote.clientInfo.screenUid !== remote.getId()) {\r\n\t\t\t\t\t\t\torderedRemotes.push(remote);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t}\r\n\t\t\t\t\torderedRemotes.push(remote);\r\n\t\t\t\t});\r\n\t\t\t\torderedRemotes.sort((a, b) => {\r\n\t\t\t\t\tif (a.clientInfo && b.clientInfo) {\r\n\t\t\t\t\t\tif (a.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\t\t\treturn -1;\r\n\t\t\t\t\t\t} else if (b.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\t\t\treturn 1;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t// sort on audioLevel or lastOrder\r\n\t\t\t\t\t\t\treturn b.clientInfo.peekAudioLevel - a.clientInfo.peekAudioLevel ||\r\n\t\t\t\t\t\t\t(a.clientInfo.order || 0) - (b.clientInfo.order || 0);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\torderedRemotes.forEach((remote, i) => {\r\n\t\t\t\t\tif (remote.clientInfo) {\r\n\t\t\t\t\t\tremote.clientInfo.order = i;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// !!! hard limit max visible stream\r\n\t\t\t\torderedRemotes.length = Math.min(orderedRemotes.length, MAX_VISIBLE_STREAMS);\r\n\t\t\t\treturn orderedRemotes;\r\n\t\t\t}),\r\n\t\t\tdistinctUntilChanged((a, b) => {\r\n\t\t\t\treturn a.map(remote => remote.clientInfo ? remote.clientInfo.uid : '').join('|') ===\r\n\t\t\t\tb.map(remote => remote.clientInfo ? remote.clientInfo.uid : '').join('|');\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic streams$ = combineLatest([StreamService.local$, StreamService.screen$, StreamService.remotes$, StreamService.getEditorStreams$(), StreamService.getEditorScreens$()]).pipe(\r\n\t\tmap(data => {\r\n\t\t\tconst local = data[0];\r\n\t\t\tconst screen = data[1];\r\n\t\t\tconst remotes = data[2];\r\n\t\t\tconst editorStreams = data[3];\r\n\t\t\tconst editorScreens = data[4];\r\n\t\t\tlet streams = remotes;\r\n\t\t\tif (local) { // my stream\r\n\t\t\t\tstreams = streams.slice();\r\n\t\t\t\tstreams.push(local);\r\n\t\t\t}\r\n\t\t\tif (screen) { // my screen\r\n\t\t\t\tstreams = streams.slice();\r\n\t\t\t\tstreams.push(screen);\r\n\t\t\t}\r\n\t\t\tif (editorStreams) { // editor streams\r\n\t\t\t\tstreams.push(...editorStreams);\r\n\t\t\t}\r\n\t\t\tif (editorScreens) { // editor screens\r\n\t\t\t\tstreams.push(...editorScreens);\r\n\t\t\t}\r\n\t\t\t// console.log('StreamService.streams$', streams, local, screen, remotes);\r\n\t\t\treturn streams;\r\n\t\t}),\r\n\t\tshareReplay(1),\r\n\t);\r\n\r\n\tstatic getEditorStreams$() {\r\n\t\treturn of(null).pipe(\r\n\t\t\tswitchMap(() => {\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia && this.mode === StreamServiceMode.Editor) {\r\n\t\t\t\t\tconst body = document.querySelector('body');\r\n\t\t\t\t\tconst media = document.createElement('div');\r\n\t\t\t\t\tconst video = document.createElement('video');\r\n\t\t\t\t\tmedia.setAttribute('id', 'stream-editor');\r\n\t\t\t\t\tmedia.setAttribute('style', 'position:absolute; top: 5000px; line-height: 0;');\r\n\t\t\t\t\tmedia.appendChild(video);\r\n\t\t\t\t\tbody.appendChild(media);\r\n\t\t\t\t\tnavigator.mediaDevices.getUserMedia({\r\n\t\t\t\t\t\tvideo: { width: 800, height: 450 },\r\n\t\t\t\t\t}).then((stream) => {\r\n\t\t\t\t\t\t// console.log(stream);\r\n\t\t\t\t\t\tif ('srcObject' in video) {\r\n\t\t\t\t\t\t\tvideo.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvideo.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\t\t\tconst fakePublisherStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Publisher,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeAttendeeStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Attendee,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeSmartDeviceStream = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.SmartDevice,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tthis.editorStreams$.next([fakePublisherStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeSmartDeviceStream]);\r\n\t\t\t\t\t\t\t// StreamService.editorStreams = [fakePublisherStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream, fakeAttendeeStream];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.play();\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\tconsole.log('EditorComponent.getUserMedia.error', error.name, error.message);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn this.editorStreams$;\r\n\t\t\t}),\r\n\t\t\tshareReplay(1),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getEditorScreens$() {\r\n\t\treturn of(null).pipe(\r\n\t\t\tswitchMap(() => {\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia && this.mode === StreamServiceMode.Editor) {\r\n\t\t\t\t\tconst body = document.querySelector('body');\r\n\t\t\t\t\tconst media = document.createElement('div');\r\n\t\t\t\t\tconst video = document.createElement('video');\r\n\t\t\t\t\tmedia.setAttribute('id', 'stream-editor-screen');\r\n\t\t\t\t\tmedia.setAttribute('style', 'position:absolute; top: 5000px; line-height: 0;');\r\n\t\t\t\t\tmedia.appendChild(video);\r\n\t\t\t\t\tbody.appendChild(media);\r\n\t\t\t\t\tnavigator.mediaDevices.getDisplayMedia({\r\n\t\t\t\t\t\tscreen: { width: 800, height: 450 },\r\n\t\t\t\t\t}).then((stream) => {\r\n\t\t\t\t\t\t// console.log(stream);\r\n\t\t\t\t\t\tif ('srcObject' in video) {\r\n\t\t\t\t\t\t\tvideo.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tvideo.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\t\t\tconst fakePublisherScreen = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor-screen',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Publisher,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor-screen_',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tconst fakeAttendeeScreen = {\r\n\t\t\t\t\t\t\t\tgetId: () => 'editor-screen',\r\n\t\t\t\t\t\t\t\tclientInfo: {\r\n\t\t\t\t\t\t\t\t\trole: RoleType.Attendee,\r\n\t\t\t\t\t\t\t\t\tuid: 'editor-screen_',\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tthis.editorScreens$.next([fakePublisherScreen, fakeAttendeeScreen]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvideo.play();\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\tconsole.log('EditorComponent.getUserMedia.error', error.name, error.message);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn this.editorScreens$;\r\n\t\t\t}),\r\n\t\t\tshareReplay(1),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic get publisherStreamId() {\r\n\t\tconst streams = this.remotes.slice();\r\n\t\tconst local = this.local;\r\n\t\tif (local) {\r\n\t\t\tstreams.unshift(local);\r\n\t\t}\r\n\t\tconst publisherStream = streams.find(x => x.clientInfo && x.clientInfo.role === RoleType.Publisher);\r\n\t\tif (publisherStream) {\r\n\t\t\treturn publisherStream.getId();\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\tstatic getPublisherStreamId$() {\r\n\t\tconst publisherStreamId = this.publisherStreamId;\r\n\t\tif (publisherStreamId) {\r\n\t\t\treturn of(publisherStreamId);\r\n\t\t} else {\r\n\t\t\treturn this.streams$.pipe(\r\n\t\t\t\tmap(() => this.publisherStreamId),\r\n\t\t\t\tfilter(x => x),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getRemoteById(streamId) {\r\n\t\t// console.log('StreamService.getRemoteById', streamId);\r\n\t\tconst remotes = StreamService.remotes;\r\n\t\tconst remote = remotes.find(x => x.getId() === streamId);\r\n\t\tif (remote) {\r\n\t\t\treturn remote;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic remoteAdd(stream) {\r\n\t\tconst remotes = this.remotes.slice();\r\n\t\tremotes.push(stream);\r\n\t\tthis.remotes = remotes;\r\n\t}\r\n\r\n\tstatic remoteRemove(streamId) {\r\n\t\tconst remotes = this.remotes.slice();\r\n\t\tconst remote = remotes.find(x => x.getId() === streamId);\r\n\t\t// console.log('StreamService.remoteRemove', streamId, remote);\r\n\t\tif (remote) {\r\n\t\t\tif (remote.isPlaying()) {\r\n\t\t\t\tremote.stop();\r\n\t\t\t}\r\n\t\t\tremotes.splice(remotes.indexOf(remote), 1);\r\n\t\t\tthis.remotes = remotes;\r\n\t\t}\r\n\t\treturn remote;\r\n\t}\r\n\r\n\tstatic remoteSetClientInfo(remoteId, clientInfo) {\r\n\t\tconst remotes = this.remotes;\r\n\t\tconst remote = remotes.find(x => x.getId() === remoteId);\r\n\t\tif (remote) {\r\n\t\t\tremote.clientInfo = clientInfo;\r\n\t\t}\r\n\t\tthis.remotes = remotes;\r\n\t}\r\n}\r\n","import { environment } from '../environment';\r\nimport { RoleType } from '../user/user';\r\n\r\nexport const USE_AUTODETECT = false;\r\nexport const USE_VOLUME_INDICATOR = false;\r\nexport const USE_RTM = true;\r\n\r\nexport const StreamQualities = [{\r\n\t// id: 1,\r\n\t// name: '4K 2160p 3840x2160',\r\n\tprofile: '4K',\r\n\tresolution: {\r\n\t\twidth: 3840,\r\n\t\theight: 2160\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 8910,\r\n\t\tmax: 13500\r\n\t}\r\n}, {\r\n\t// id: 2,\r\n\t// name: 'HD 1440p 2560×1440',\r\n\tprofile: '1440p',\r\n\tresolution: {\r\n\t\twidth: 2560,\r\n\t\theight: 1440\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 4850,\r\n\t\tmax: 7350\r\n\t}\r\n}, {\r\n\t// id: 3,\r\n\t// name: 'HD 1080p 1920x1080',\r\n\tprofile: '1080p',\r\n\tresolution: {\r\n\t\twidth: 1920,\r\n\t\theight: 1080\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 2080,\r\n\t\tmax: 4780\r\n\t}\r\n}, {\r\n\t// id: 4,\r\n\t// name: 'LOW 720p 1280x720',\r\n\tprofile: '720p_3',\r\n\tresolution: {\r\n\t\twidth: 1280,\r\n\t\theight: 720\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 30\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 1130,\r\n\t\tmax: 1710\r\n\t}\r\n}, {\r\n\t// id: 5,\r\n\t// name: 'LOWEST 240p 320x240',\r\n\tprofile: '240p_1',\r\n\tresolution: {\r\n\t\twidth: 320,\r\n\t\theight: 240\r\n\t},\r\n\tframeRate: {\r\n\t\tmin: 15,\r\n\t\tmax: 15\r\n\t},\r\n\tbitrate: {\r\n\t\tmin: 140,\r\n\t\tmax: 200\r\n\t}\r\n}];\r\n\r\nexport function getStreamQuality(state) {\r\n\tconst lowestQuality = StreamQualities[StreamQualities.length - 1];\r\n\tconst highestQuality = environment.flags.maxQuality ? StreamQualities[0] : StreamQualities[StreamQualities.length - 2];\r\n\treturn (state.role === RoleType.Publisher || state.role === RoleType.SmartDevice) ? highestQuality : lowestQuality;\r\n}\r\n\r\nexport const AgoraStatus = {\r\n\tIdle: 'idle',\r\n\tChecklist: 'checklist',\r\n\tLink: 'link',\r\n\tLogin: 'login',\r\n\tName: 'name',\r\n\tDevice: 'device',\r\n\tShouldConnect: 'should-connect',\r\n\tConnecting: 'connecting',\r\n\tConnected: 'connected',\r\n\tDisconnected: 'disconnected',\r\n};\r\n\r\nexport const MessageType = {\r\n\tAgoraEvent: 'agoraEvent',\r\n\tPing: 'ping',\r\n\tRequestControl: 'requestControl',\r\n\tRequestControlAccepted: 'requestControlAccepted',\r\n\tRequestControlRejected: 'requestControlRejected',\r\n\tRequestControlDismiss: 'requestControlDismiss',\r\n\tRequestControlDismissed: 'requestControlDismissed',\r\n\tRequestPeerInfo: 'requestPeerInfo',\r\n\tRequestPeerInfoResult: 'requestPeerInfoResult',\r\n\tRequestInfo: 'requestInfo',\r\n\tRequestInfoResult: 'requestInfoResult',\r\n\tRequestInfoDismiss: 'requestInfoDismiss',\r\n\tRequestInfoDismissed: 'requestInfoDismissed',\r\n\tRequestInfoRejected: 'requestInfoRejected',\r\n\tSlideChange: 'slideChange',\r\n\tControlInfo: 'controlInfo',\r\n\tAddLike: 'addLike',\r\n\tShowPanel: 'showPanel',\r\n\tPlayMedia: 'playMedia',\r\n\tNavToView: 'navToView',\r\n\tNavToGrid: 'navToGrid',\r\n\tVRStarted: 'vrStarted',\r\n\tVREnded: 'vrEnded',\r\n\tVRState: 'vrState',\r\n\tMenuToggle: 'menuToggle',\r\n\tChatMessage: 'chatMessage',\r\n\tChatTypingBegin: 'chatTypingBegin',\r\n\tChatTypingEnd: 'chatTypingEnd',\r\n};\r\nexport class AgoraEvent {\r\n\tconstructor(options) {\r\n\t\tObject.assign(this, options);\r\n\t}\r\n}\r\nexport class AgoraPeerEvent extends AgoraEvent { }\r\nexport class AgoraRemoteEvent extends AgoraEvent { }\r\nexport class AgoraMuteVideoEvent extends AgoraEvent { }\r\nexport class AgoraUnmuteVideoEvent extends AgoraEvent { }\r\nexport class AgoraMuteAudioEvent extends AgoraEvent { }\r\nexport class AgoraUnmuteAudioEvent extends AgoraEvent { }\r\nexport class AgoraVolumeLevelsEvent extends AgoraEvent { }\r\n","/* global AgoraRTM */\r\n// import AgoraRTM from 'agora-rtm-sdk';\r\nimport { from, interval, of } from 'rxjs';\r\nimport { distinctUntilChanged, map, switchMap } from 'rxjs/operators';\r\nimport Emittable from '../emittable/emittable';\r\nimport { DEBUG, environment } from '../environment';\r\nimport HttpService from '../http/http.service';\r\nimport SessionStorageService from '../local-storage/session-storage.service';\r\n// import LocationService from '../location/location.service';\r\nimport MessageService from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport StreamService from '../stream/stream.service';\r\nimport { RoleType } from '../user/user';\r\nimport { AgoraMuteAudioEvent, AgoraMuteVideoEvent, AgoraPeerEvent, AgoraRemoteEvent, AgoraStatus, AgoraUnmuteAudioEvent, AgoraUnmuteVideoEvent, AgoraVolumeLevelsEvent, getStreamQuality, MessageType, USE_AUTODETECT, USE_RTM, USE_VOLUME_INDICATOR } from './agora.types';\r\n\r\nexport default class AgoraService extends Emittable {\r\n\r\n\tstatic getSingleton(defaultDevices) {\r\n\t\tif (DEBUG) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (!this.AGORA) {\r\n\t\t\tthis.AGORA = new AgoraService(defaultDevices);\r\n\t\t}\r\n\t\treturn this.AGORA;\r\n\t}\r\n\r\n\tconstructor(defaultDevices) {\r\n\t\tif (AgoraService.AGORA) {\r\n\t\t\tthrow ('AgoraService is a singleton');\r\n\t\t}\r\n\t\tsuper();\r\n\t\tthis.onStreamPublished = this.onStreamPublished.bind(this);\r\n\t\tthis.onStreamUnpublished = this.onStreamUnpublished.bind(this);\r\n\t\tthis.onStreamAdded = this.onStreamAdded.bind(this);\r\n\t\tthis.onStreamRemoved = this.onStreamRemoved.bind(this);\r\n\t\tthis.onStreamSubscribed = this.onStreamSubscribed.bind(this);\r\n\t\tthis.onMuteVideo = this.onMuteVideo.bind(this);\r\n\t\tthis.onUnmuteVideo = this.onUnmuteVideo.bind(this);\r\n\t\tthis.onMuteAudio = this.onMuteAudio.bind(this);\r\n\t\tthis.onUnmuteAudio = this.onUnmuteAudio.bind(this);\r\n\t\tthis.onVolumeIndicator = this.onVolumeIndicator.bind(this);\r\n\t\tthis.onPeerConnect = this.onPeerConnect.bind(this);\r\n\t\tthis.onPeerLeaved = this.onPeerLeaved.bind(this);\r\n\t\tthis.onConnectionStateChange = this.onConnectionStateChange.bind(this);\r\n\t\tthis.onTokenPrivilegeWillExpire = this.onTokenPrivilegeWillExpire.bind(this);\r\n\t\tthis.onTokenPrivilegeDidExpire = this.onTokenPrivilegeDidExpire.bind(this);\r\n\t\tthis.onMessage = this.onMessage.bind(this);\r\n\t\tconst state = StateService.state;\r\n\t\tStateService.patchState({\r\n\t\t\tdevices: (state.role !== RoleType.Attendee && defaultDevices) ? defaultDevices : { videos: [], audios: [] },\r\n\t\t\tquality: getStreamQuality(state),\r\n\t\t\tmembersCount: 0,\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tgetInitialStatus(role, link, name) {\r\n\t\tif (!link) {\r\n\t\t\treturn AgoraStatus.Link;\r\n\t\t}\r\n\t\tif (!name) {\r\n\t\t\treturn AgoraStatus.Name;\r\n\t\t}\r\n\t\tif (role !== RoleType.Viewer && role !== RoleType.SmartDevice) {\r\n\t\t\treturn AgoraStatus.Device;\r\n\t\t}\r\n\t\treturn AgoraStatus.ShouldConnect;\r\n\t}\r\n\t*/\r\n\r\n\taddStreamDevice(src) {\r\n\t\tthis.removeStreamDevice();\r\n\t\tconst video = {\r\n\t\t\tdeviceId: 'video-stream',\r\n\t\t\tlabel: 'videostream',\r\n\t\t\tkind: 'videostream',\r\n\t\t\tsrc: src,\r\n\t\t};\r\n\t\tconst audio = {\r\n\t\t\tdeviceId: 'audio-stream',\r\n\t\t\tlabel: 'videostream',\r\n\t\t\tkind: 'videostream',\r\n\t\t\tsrc: src,\r\n\t\t};\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tdevices.videos.push(video);\r\n\t\tdevices.audios.push(audio);\r\n\t\tStateService.patchState({ devices: devices });\r\n\t}\r\n\r\n\tremoveStreamDevice() {\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tdevices.videos = devices.videos.filter(x => x.kind !== 'videostream');\r\n\t\tdevices.audios = devices.audios.filter(x => x.kind !== 'videostream');\r\n\t\tStateService.patchState({ devices: devices });\r\n\t}\r\n\r\n\tdevices$() {\r\n\t\tconst inputs = StateService.state.devices;\r\n\t\tconst defaultVideos = this.defaultVideos = (this.defaultVideos || inputs.videos.slice());\r\n\t\tconst defaultAudios = this.defaultAudios = (this.defaultAudios || inputs.videos.slice());\r\n\t\tinputs.videos = defaultVideos.slice();\r\n\t\tinputs.audios = defaultAudios.slice();\r\n\t\treturn from(new Promise((resolve, reject) => {\r\n\t\t\tconst getDevices = () => {\r\n\t\t\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\t\t\t// console.log('AgoraRTC.getDevices', devices);\r\n\t\t\t\t\ttempStream.close();\r\n\t\t\t\t\tfor (let i = 0; i < devices.length; i++) {\r\n\t\t\t\t\t\tconst device = devices[i];\r\n\t\t\t\t\t\t// console.log('device', device.deviceId);\r\n\t\t\t\t\t\tif (device.kind === 'videoinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.videos.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'camera-' + inputs.videos.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (device.kind === 'audioinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.audios.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'microphone-' + inputs.audios.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (inputs.videos.length > 0 || inputs.audios.length > 0) {\r\n\t\t\t\t\t\tresolve(inputs);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treject(inputs);\r\n\t\t\t\t\t}\r\n\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t\t/*\r\n\t\t\t\tAgoraRTC.getDevices((devices) => {\r\n\t\t\t\t\t// console.log('AgoraRTC.getDevices', devices);\r\n\t\t\t\t\ttempStream.close();\r\n\t\t\t\t\tfor (let i = 0; i < devices.length; i++) {\r\n\t\t\t\t\t\tconst device = devices[i];\r\n\t\t\t\t\t\t// console.log('device', device.deviceId);\r\n\t\t\t\t\t\tif (device.kind === 'videoinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.videos.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'camera-' + inputs.videos.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (device.kind === 'audioinput' && device.deviceId) {\r\n\t\t\t\t\t\t\tinputs.audios.push({\r\n\t\t\t\t\t\t\t\tlabel: device.label || 'microphone-' + inputs.audios.length,\r\n\t\t\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (inputs.videos.length > 0 || inputs.audios.length > 0) {\r\n\t\t\t\t\t\tresolve(inputs);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treject(inputs);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t*/\r\n\t\t\t};\r\n\t\t\tconst tempStream = AgoraRTC.createStream({ audio: true, video: true });\r\n\t\t\ttempStream.init(() => {\r\n\t\t\t\tgetDevices();\r\n\t\t\t}, () => {\r\n\t\t\t\tgetDevices();\r\n\t\t\t});\r\n\t\t}));\r\n\t}\r\n\r\n\tconnect$(preferences) {\r\n\t\tconst devices = StateService.state.devices;\r\n\t\tif (preferences) {\r\n\t\t\tdevices.video = preferences.video;\r\n\t\t\tdevices.audio = preferences.audio;\r\n\t\t}\r\n\t\t// console.log('AgoraService.connect$', preferences, devices);\r\n\t\tif (!StateService.state.connecting) {\r\n\t\t\tStateService.patchState({ status: AgoraStatus.Connecting, connecting: true, devices });\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.createClient(() => {\r\n\t\t\t\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\t\t// console.log('AgoraService.rtcToken$', token);\r\n\t\t\t\t\t\tthis.join(token.token, channelNameLink);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}, 250);\r\n\t\t}\r\n\t\treturn StateService.state$;\r\n\t}\r\n\r\n\tmembersCount$(channelId) {\r\n\t\tconst messageClient = this.messageClient;\r\n\t\treturn interval(2000).pipe(\r\n\t\t\tswitchMap(() => from(messageClient.getChannelMemberCount([channelId]))),\r\n\t\t\tmap(counters => counters[channelId]),\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t);\r\n\t}\r\n\r\n\tobserveMemberCount() {\r\n\t\tthis.unobserveMemberCount();\r\n\t\tthis.membersCountSubscription = this.membersCount$(StateService.state.channelNameLink).subscribe(\r\n\t\t\tmembersCount => {\r\n\t\t\t\tStateService.patchState({ membersCount: membersCount });\r\n\t\t\t}\r\n\t\t);\r\n\t}\r\n\r\n\tunobserveMemberCount() {\r\n\t\tif (this.membersCountSubscription) {\r\n\t\t\tthis.membersCountSubscription.unsubscribe();\r\n\t\t\tthis.membersCountSubscription = null;\r\n\t\t\tStateService.patchState({ membersCount: 0 });\r\n\t\t}\r\n\t}\r\n\r\n\tcreateClient(next) {\r\n\t\tif (this.client) {\r\n\t\t\tnext();\r\n\t\t}\r\n\t\t// console.log('agora rtc sdk version: ' + AgoraRTC.VERSION + ' compatible: ' + AgoraRTC.checkSystemRequirements());\r\n\t\t// AgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.ERROR);\r\n\t\tAgoraRTC.Logger.setLogLevel(AgoraRTC.Logger.NONE);\r\n\t\tconst client = this.client = AgoraRTC.createClient({ mode: 'live', codec: 'h264' }); // rtc\r\n\t\tconst clientInit = () => {\r\n\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\tclient.startProxyServer(3);\r\n\t\t\t\tconsole.log('AgoraService.client.startProxyServer');\r\n\t\t\t}\r\n\t\t\tclient.init(environment.appKey, () => {\r\n\t\t\t\t// console.log('AgoraRTC client initialized');\r\n\t\t\t\tnext();\r\n\t\t\t}, (error) => {\r\n\t\t\t\t// console.log('AgoraRTC client init failed', error);\r\n\t\t\t\tthis.client = null;\r\n\t\t\t});\r\n\t\t}\r\n\t\tif (StateService.state.role === RoleType.Viewer) {\r\n\t\t\tclient.setClientRole('audience', function(error) {\r\n\t\t\t\tif (!error) {\r\n\t\t\t\t\tclientInit();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tclientInit();\r\n\t\t}\r\n\t\tclient.on('error', this.onError);\r\n\t\tclient.on('stream-published', this.onStreamPublished);\r\n\t\tclient.on('stream-unpublished', this.onStreamUnpublished);\r\n\t\t//subscribe remote stream\r\n\t\tclient.on('stream-added', this.onStreamAdded);\r\n\t\tclient.on('stream-removed', this.onStreamRemoved);\r\n\t\tclient.on('stream-subscribed', this.onStreamSubscribed);\r\n\t\tclient.on('mute-video', this.onMuteVideo);\r\n\t\tclient.on('unmute-video', this.onUnmuteVideo);\r\n\t\tclient.on('mute-audio', this.onMuteAudio);\r\n\t\tclient.on('unmute-audio', this.onUnmuteAudio);\r\n\t\tif (USE_VOLUME_INDICATOR) {\r\n\t\t\tclient.enableAudioVolumeIndicator(); // Triggers the \"volume-indicator\" callback event every two seconds.\r\n\t\t\tclient.on(\"volume-indicator\", this.onVolumeIndicator);\r\n\t\t}\r\n\t\tclient.on('peer-online', this.onPeerConnect);\r\n\t\t// Occurs when the peer user leaves the channel; for example, the peer user calls Client.leave.\r\n\t\tclient.on('peer-leave', this.onPeerLeaved);\r\n\t\t// client.on('connection-state-change', this.onConnectionStateChange);\r\n\t\tclient.on('onTokenPrivilegeWillExpire', this.onTokenPrivilegeWillExpire);\r\n\t\tclient.on('onTokenPrivilegeDidExpire', this.onTokenPrivilegeDidExpire);\r\n\t\t// console.log('agora rtm sdk version: ' + AgoraRTM.VERSION + ' compatible');\r\n\t\tif (USE_RTM) {\r\n\t\t\t/*\r\n\t\t\tAgoraRTM.LOG_FILTER_OFF\r\n\t\t\tAgoraRTM.LOG_FILTER_ERROR\r\n\t\t\tAgoraRTM.LOG_FILTER_INFO (Default)\r\n\t\t\tAgoraRTM.LOG_FILTER_WARNING\r\n\t\t\t*/\r\n\t\t\tconst messageClient = this.messageClient = AgoraRTM.createInstance(environment.appKey, { logFilter: AgoraRTM.LOG_FILTER_OFF }); // LOG_FILTER_DEBUG\r\n\t\t\tmessageClient.setParameters({ logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\t// messageClient.on('ConnectionStateChanged', console.warn);\r\n\t\t\t// messageClient.on('MessageFromPeer', console.log);\r\n\t\t}\r\n\t}\r\n\r\n\tgetChannelNameLink() {\r\n\t\tlet link = StateService.state.link || '';\r\n\t\tconst match = link.match(/(\\d{9})-(\\d{4})-(\\d{13})/);\r\n\t\tif (match) {\r\n\t\t\tlink = `${match[1]}-${match[3]}`;\r\n\t\t}\r\n\t\tconst channelName = StateService.state.channelName;\r\n\t\tconst channelNameLink = `${channelName}-${link}`;\r\n\t\t// console.log('AgoraService.getChannelNameLink', channelNameLink);\r\n\t\treturn channelNameLink;\r\n\t}\r\n\r\n\tstatic getUniqueUserId() {\r\n\t\t// max safe integer 9007199254740991 length 16\r\n\t\t// max allowed integer 4294967296 2^32\r\n\t\tconst m = 9007199254740991;\r\n\t\tconst mult = 10000000000000;\r\n\t\tconst a = (1 + Math.floor(Math.random() * 8)) * 100;\r\n\t\tconst b = (1 + Math.floor(Math.random() * 8)) * 10;\r\n\t\tconst c = (1 + Math.floor(Math.random() * 8)) * 1;\r\n\t\tconst combo = (a + b + c);\r\n\t\tconst date = Date.now();\r\n\t\tconst uid = combo * mult + date;\r\n\t\t// console.log(combo);\r\n\t\t// console.log(date);\r\n\t\t// console.log(m);\r\n\t\t// console.log('AgoraService.getUniqueUserId', uid);\r\n\t\treturn uid.toString();\r\n\t}\r\n\r\n\tjoin(token, channelNameLink) {\r\n\t\tthis.channel = null;\r\n\t\tconst client = this.client;\r\n\t\tconst clientId = SessionStorageService.get('bHereClientId') || AgoraService.getUniqueUserId();\r\n\t\t// console.log('AgoraService.join', { token, channelNameLink, clientId });\r\n\t\tclient.join(token, channelNameLink, clientId, (uid) => {\r\n\t\t\t// console.log('AgoraService.join', uid);\r\n\t\t\tStateService.patchState({ status: AgoraStatus.Connected, channelNameLink, connected: true, uid: uid });\r\n\t\t\tSessionStorageService.set('bHereClientId', uid);\r\n\t\t\tif (USE_RTM) {\r\n\t\t\t\tAgoraService.rtmToken$(uid).subscribe(token => {\r\n\t\t\t\t\t// console.log('AgoraService.rtmToken$', token);\r\n\t\t\t\t\tthis.joinMessageChannel(token.token, uid).then((success) => {\r\n\t\t\t\t\t\t// console.log('joinMessageChannel.success', success);\r\n\t\t\t\t\t\tif (StateService.state.role !== RoleType.Viewer) {\r\n\t\t\t\t\t\t\tthis.autoDetectDevice().then(devices => {\r\n\t\t\t\t\t\t\t\tthis.createMediaStream(uid, devices.video, devices.audio);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.observeMemberCount();\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\tconsole.log('joinMessageChannel.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tif (StateService.state.role !== RoleType.Viewer) {\r\n\t\t\t\t\tthis.autoDetectDevice().then(devices => {\r\n\t\t\t\t\t\tthis.createMediaStream(uid, devices.video, devices.audio);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.join.error', error);\r\n\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\tthis.join(token.token, channelNameLink);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\t// https://console.agora.io/invite?sign=YXBwSWQlM0RhYjQyODlhNDZjZDM0ZGE2YTYxZmQ4ZDY2Nzc0YjY1ZiUyNm5hbWUlM0RaYW1wZXR0aSUyNnRpbWVzdGFtcCUzRDE1ODY5NjM0NDU=// join link expire in 30 minutes\r\n\t}\r\n\r\n\tjoinMessageChannel(token, uid) {\r\n\t\tlet channel;\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst messageClient = this.messageClient;\r\n\t\t\tmessageClient.login({ token: token, uid: uid.toString() }).then(() => {\r\n\t\t\t\t// console.log('AgoraService.messageClient.login.success');\r\n\t\t\t\tchannel = messageClient.createChannel(StateService.state.channelNameLink);\r\n\t\t\t\treturn channel.join();\r\n\t\t\t}).then(() => {\r\n\t\t\t\tthis.channel = channel;\r\n\t\t\t\tchannel.on('ChannelMessage', this.onMessage);\r\n\t\t\t\tthis.emit('channel', channel);\r\n\t\t\t\t// console.log('AgoraService.joinMessageChannel.success');\r\n\t\t\t\tresolve(uid);\r\n\t\t\t}).catch(reject);\r\n\t\t});\r\n\t}\r\n\r\n\tdetectDevices(next) {\r\n\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\tconst videos = [];\r\n\t\t\tconst audios = [];\r\n\t\t\tfor (let i = 0; i < devices.length; i++) {\r\n\t\t\t\tconst device = devices[i];\r\n\t\t\t\tif ('videoinput' == device.kind) {\r\n\t\t\t\t\tvideos.push({\r\n\t\t\t\t\t\tlabel: device.label || 'camera-' + videos.length,\r\n\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\tif ('audioinput' == device.kind) {\r\n\t\t\t\t\taudios.push({\r\n\t\t\t\t\t\tlabel: device.label || 'microphone-' + videos.length,\r\n\t\t\t\t\t\tdeviceId: device.deviceId,\r\n\t\t\t\t\t\tkind: device.kind\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tnext({ videos: videos, audios: audios });\r\n\t\t}).catch((error) => {\r\n\t\t\tconsole.log('AgoraService.detectDevices', error);\r\n\t\t});\r\n\t}\r\n\r\n\tgetVideoOptions(options, video) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (video) {\r\n\t\t\t\tif (video.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + video.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\tvar hls = new Hls();\r\n\t\t\t\t\thls.attachMedia(element);\r\n\t\t\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\t\t\thls.loadSource(video.src);\r\n\t\t\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t\t\t\t// console.log('AgoraService.getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\tconsole.log('AgoraService.getVideoOptions.error', error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (video.kind === 'videoplayer' || video.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + video.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// element.oncanplay = () => {\r\n\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t// console.log('getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t// };\r\n\t\t\t\t\t/*\r\n\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\toptions.videoSource = stream.getVideoTracks()[0];\r\n\t\t\t\t\t\t// console.log('getVideoOptions', element, stream, stream.getVideoTracks());\r\n\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t// console.log('AgoraService.getVideoOptions.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t*/\r\n\t\t\t\t} else {\r\n\t\t\t\t\toptions.cameraId = video.deviceId;\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tresolve(options);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tgetAudioOptions(options, audio) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (audio) {\r\n\t\t\t\tif (audio.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + audio.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// !!! try hls.service;\r\n\t\t\t\t\tvar hls = new Hls();\r\n\t\t\t\t\thls.attachMedia(element);\r\n\t\t\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\t\t\thls.loadSource(audio.src);\r\n\t\t\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\t\t\thls.loadLevel = data.levels.length - 1;\r\n\t\t\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t\t\t\t// console.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\tconsole.log('AgoraService.getAudioOptions.error', error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (audio.kind === 'videoplayer' || audio.kind === 'videostream') {\r\n\t\t\t\t\tconst element = document.querySelector('#' + audio.deviceId);\r\n\t\t\t\t\telement.crossOrigin = 'anonymous';\r\n\t\t\t\t\t// element.oncanplay = () => {\r\n\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t// console.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t// };\r\n\t\t\t\t\t/*\r\n\t\t\t\t\telement.play().then(success => {\r\n\t\t\t\t\t\tconst stream = element.captureStream();\r\n\t\t\t\t\t\toptions.audioSource = stream.getAudioTracks()[0];\r\n\t\t\t\t\t\t// console.log('AgoraService.getAudioOptions', element, stream, stream.getAudioTracks());\r\n\t\t\t\t\t\tresolve(options);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t// console.log('AgoraService.getAudioOptions.error', error);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t*/\r\n\t\t\t\t} else {\r\n\t\t\t\t\toptions.microphoneId = audio.deviceId;\r\n\t\t\t\t\tresolve(options);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tresolve(options);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tautoDetectDevice() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst state = StateService.state;\r\n\t\t\tif (state.role === RoleType.SmartDevice || USE_AUTODETECT) {\r\n\t\t\t\tAgoraService.getDevices().then(inputDevices => {\r\n\t\t\t\t\tconst devices = { videos: [], audios: [], video: null, audio: null };\r\n\t\t\t\t\tinputDevices.forEach(x => {\r\n\t\t\t\t\t\tif (x.kind === 'videoinput') {\r\n\t\t\t\t\t\t\tdevices.videos.push(x);\r\n\t\t\t\t\t\t} else if (x.kind === 'audioinput') {\r\n\t\t\t\t\t\t\tdevices.audios.push(x);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log(devices);\r\n\t\t\t\t\tdevices.video = devices.videos[0] || null;\r\n\t\t\t\t\tdevices.audio = devices.audios[0] || null;\r\n\t\t\t\t\tStateService.patchState({ devices });\r\n\t\t\t\t\tresolve(devices);\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve(state.devices);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcreateMediaStream(uid, video, audio) {\r\n\t\t// this.releaseStream('_mediaVideoStream')\r\n\t\tconst options = {\r\n\t\t\tstreamID: uid,\r\n\t\t\tvideo: Boolean(video),\r\n\t\t\taudio: Boolean(audio),\r\n\t\t\tscreen: false,\r\n\t\t};\r\n\t\tPromise.all([\r\n\t\t\tthis.getVideoOptions(options, video),\r\n\t\t\tthis.getAudioOptions(options, audio)\r\n\t\t]).then(success => {\r\n\t\t\tconst quality = Object.assign({}, StateService.state.quality);\r\n\t\t\tthis.createLocalStreamWithOptions(options, quality);\r\n\t\t});\r\n\t}\r\n\r\n\tcreateLocalStreamWithOptions(options, quality) {\r\n\t\t/*\r\n\t\tconst getUserMedia = navigator.mediaDevices.getUserMedia;\r\n\t\tnavigator.mediaDevices.getUserMedia = function(options) {\r\n\t\t\tif (options.video) {\r\n\t\t\t\toptions.video.width = { ideal: 4096 };\r\n\t\t\t\toptions.video.height = { ideal: 2160 };\r\n\t\t\t\tconsole.log('getUserMedia', options.video.width.ideal, options.video.height.ideal);\r\n\t\t\t}\r\n\t\t\tconsole.log('getUserMedia', options);\r\n\t\t\treturn getUserMedia.call(navigator.mediaDevices, options);\r\n\t\t}\r\n\t\t*/\r\n\t\tconst local = AgoraRTC.createStream(options);\r\n\t\t/*\r\n\t\t// force video quality\r\n\t\tquality = {\r\n\t\t\tresolution: {\r\n\t\t\t\twidth: 1920,\r\n\t\t\t\theight: 1080\r\n\t\t\t},\r\n\t\t\tframeRate: {\r\n\t\t\t\tmin: 30,\r\n\t\t\t\tmax: 30\r\n\t\t\t},\r\n\t\t\tbitrate: {\r\n\t\t\t\tmin: 2000,\r\n\t\t\t\tmax: 4000\r\n\t\t\t}\r\n\t\t};\r\n\t\t*/\r\n\t\tif (quality) {\r\n\t\t\tlocal.setVideoProfile(quality.profile);\r\n\t\t\tlocal.setVideoEncoderConfiguration(quality);\r\n\t\t}\r\n\t\t// console.log('local', local.attributes);\r\n\t\tlocal.init(() => {\r\n\t\t\tStreamService.local = local;\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.publishLocalStream();\r\n\t\t\t}, 1);\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.initLocalStream.init.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tinitLocalStream() {\r\n\t\tconst local = StreamService.local;\r\n\t\tlocal.init(() => {\r\n\t\t\tthis.publishLocalStream();\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.initLocalStream.init.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tcreateMediaVideoStream(video, callback) {\r\n\t\tconst videoStream = video.captureStream(60);\r\n\t\tconst stream = AgoraRTC.createStream({\r\n\t\t\taudio: true,\r\n\t\t\tvideo: true,\r\n\t\t\tvideoSource: videoStream.getVideoTracks()[0],\r\n\t\t\taudioSource: videoStream.getAudioTracks()[0],\r\n\t\t});\r\n\t\tstream.init(() => {\r\n\t\t\tcallback(stream.getVideoTrack(), stream.getAudioTrack());\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\tpublishLocalStream() {\r\n\t\tconst client = this.client;\r\n\t\tconst local = StreamService.local;\r\n\t\t// publish local stream\r\n\t\tclient.publish(local, (error) => {\r\n\t\t\tconsole.log('AgoraService.publishLocalStream.error', local.getId(), error);\r\n\t\t});\r\n\t\tlocal.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.local = local;\r\n\t}\r\n\r\n\tunpublishLocalStream() {\r\n\t\tconst client = this.client;\r\n\t\tconst local = StreamService.local;\r\n\t\tif (local) {\r\n\t\t\tclient.unpublish(local, (error) => {\r\n\t\t\t\tconsole.log('AgoraService.unpublishLocalStream.error', local.getId(), error);\r\n\t\t\t});\r\n\t\t}\r\n\t\tStreamService.local = null;\r\n\t}\r\n\r\n\tleaveChannel() {\r\n\t\tStateService.patchState({ connecting: false });\r\n\t\tthis.unpublishLocalStream();\r\n\t\tthis.unpublishScreenStream();\r\n\t\tStreamService.remotes = [];\r\n\t\tStreamService.peers = [];\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.leaveMessageChannel().then(() => {\r\n\t\t\t\treturn Promise.all([this.leaveClient(), this.leaveScreenClient()]);\r\n\t\t\t}, reject);\r\n\t\t});\r\n\t}\r\n\r\n\tleaveClient() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst client = this.client;\r\n\t\t\tif (client) {\r\n\t\t\t\tclient.leave(() => {\r\n\t\t\t\t\tthis.client = null;\r\n\t\t\t\t\t// console.log('Leave channel successfully');\r\n\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\tclient.stopProxyServer();\r\n\t\t\t\t\t\tconsole.log('AgoraService.client.stopProxyServer');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tconsole.log('AgoraService.leaveClient.error', error);\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tleaveMessageChannel() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (USE_RTM) {\r\n\t\t\t\tthis.unobserveMemberCount();\r\n\t\t\t\tconst channel = this.channel;\r\n\t\t\t\tconst messageClient = this.messageClient;\r\n\t\t\t\tchannel.leave().then(() => {\r\n\t\t\t\t\tthis.channel = null;\r\n\t\t\t\t\tmessageClient.logout().then(() => {\r\n\t\t\t\t\t\tthis.messageClient = null;\r\n\t\t\t\t\t\tresolve();\r\n\t\t\t\t\t}, reject);\r\n\t\t\t\t}, reject)\r\n\t\t\t} else {\r\n\t\t\t\treturn resolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tconst local = StreamService.local;\r\n\t\t// console.log('toggleCamera', local);\r\n\t\tif (local && local.video) {\r\n\t\t\tif (local.userMuteVideo) {\r\n\t\t\t\tlocal.unmuteVideo();\r\n\t\t\t\tStateService.patchState({ cameraMuted: false });\r\n\t\t\t\tthis.broadcastEvent(new AgoraUnmuteVideoEvent({ streamId: local.getId() }));\r\n\t\t\t} else {\r\n\t\t\t\tlocal.muteVideo();\r\n\t\t\t\tStateService.patchState({ cameraMuted: true });\r\n\t\t\t\tthis.broadcastEvent(new AgoraMuteVideoEvent({ streamId: local.getId() }));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tconst local = StreamService.local;\r\n\t\t// console.log(local);\r\n\t\tif (local && local.audio) {\r\n\t\t\tif (local.userMuteAudio) {\r\n\t\t\t\tlocal.unmuteAudio();\r\n\t\t\t\tStateService.patchState({ audioMuted: false });\r\n\t\t\t\tthis.broadcastEvent(new AgoraUnmuteAudioEvent({ streamId: local.getId() }));\r\n\t\t\t} else {\r\n\t\t\t\tlocal.muteAudio();\r\n\t\t\t\tStateService.patchState({ audioMuted: true });\r\n\t\t\t\tthis.broadcastEvent(new AgoraMuteAudioEvent({ streamId: local.getId() }));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleControl() {\r\n\t\tif (StateService.state.control) {\r\n\t\t\tthis.sendRemoteControlDismiss().then((control) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlDismiss', control);\r\n\t\t\t\tStateService.patchState({ control: !control });\r\n\t\t\t});\r\n\t\t} else if (StateService.state.spying) {\r\n\t\t\tthis.sendRemoteInfoDismiss(StateService.state.spying).then((spying) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteInfoDismiss', spying);\r\n\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\tthis.sendRemoteControlRequest().then((control) => {\r\n\t\t\t\t\t// console.log('AgoraService.sendRemoteControlRequest', control);\r\n\t\t\t\t\tStateService.patchState({ control: control });\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.sendRemoteControlRequest().then((control) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlRequest', control);\r\n\t\t\t\tStateService.patchState({ control: control });\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleSpy(remoteId) {\r\n\t\tif (StateService.state.control) {\r\n\t\t\tthis.sendRemoteControlDismiss().then((control) => {\r\n\t\t\t\tStateService.patchState({ control: false });\r\n\t\t\t\tthis.sendSpyRemoteRequestInfo(remoteId).then((info) => {\r\n\t\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t} else if (StateService.state.spying) {\r\n\t\t\tthis.sendRemoteInfoDismiss(StateService.state.spying).then((spying) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteInfoDismiss', spying);\r\n\t\t\t\t// StateService.patchState({ spying: !spying });\r\n\t\t\t\tif (StateService.state.spying !== remoteId) {\r\n\t\t\t\t\tthis.sendSpyRemoteRequestInfo(remoteId).then((info) => {\r\n\t\t\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.sendSpyRemoteRequestInfo(remoteId).then((info) => {\r\n\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tnewMessageId() {\r\n\t\treturn `${StateService.state.uid}-${Date.now().toString()}`;\r\n\t}\r\n\r\n\tsendRemoteControlDismiss() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestControlDismiss,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlDismiss return', message);\r\n\t\t\t\tif (message.type === MessageType.RequestControlDismissed) {\r\n\t\t\t\t\tresolve(true);\r\n\t\t\t\t} else if (message.type === MessageType.RequestControlRejected) {\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRemoteControlRequest() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestControl,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteControlRequest.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestControlAccepted) {\r\n\t\t\t\t\tresolve(true);\r\n\t\t\t\t} else if (message.type === MessageType.RequestControlRejected) {\r\n\t\t\t\t\t// this.remoteDeviceInfo = undefined\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRemoteRequestPeerInfo(remoteId) {\r\n\t\t// console.log('AgoraService.sendRemoteRequestPeerInfo', remoteId);\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestPeerInfo,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteRequestPeerInfo.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestPeerInfoResult) {\r\n\t\t\t\t\tif (message.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\t\tconst state = { hosted: true };\r\n\t\t\t\t\t\tif (message.clientInfo.control === true) {\r\n\t\t\t\t\t\t\tstate.locked = true;\r\n\t\t\t\t\t\t\tthis.sendControlRemoteRequestInfo(message.clientInfo.uid);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tStateService.patchState(state);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tresolve(message);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendControlRemoteRequestInfo(remoteId) {\r\n\t\t// console.log('AgoraService.sendControlRemoteRequestInfo', remoteId);\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestInfo,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\tif (message.type === MessageType.RequestInfoResult) {\r\n\t\t\t\t\tresolve(message);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendSpyRemoteRequestInfo(remoteId) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestInfo,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendSpyRemoteRequestInfo.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestInfoResult) {\r\n\t\t\t\t\tStateService.patchState({ spying: remoteId });\r\n\t\t\t\t\tresolve(message);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tsendRemoteInfoDismiss(remoteId) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.RequestInfoDismiss,\r\n\t\t\t\tmessageId: this.newMessageId(),\r\n\t\t\t\tremoteId: remoteId,\r\n\t\t\t}).then((message) => {\r\n\t\t\t\t// console.log('AgoraService.sendRemoteInfoDismiss.response', message);\r\n\t\t\t\tif (message.type === MessageType.RequestInfoDismissed) {\r\n\t\t\t\t\tresolve(true);\r\n\t\t\t\t} else if (message.type === MessageType.RequestInfoRejected) {\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tnavToView(viewId) {\r\n\t\tif (StateService.state.control || StateService.state.spyed) {\r\n\t\t\tthis.sendMessage({\r\n\t\t\t\ttype: MessageType.NavToView,\r\n\t\t\t\tviewId: viewId,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tgetSessionStats() {\r\n\t\tconst client = this.client;\r\n\t\tclient.getSessionStats((stats) => {\r\n\t\t\tconsole.log(`Current Session Duration: ${stats.Duration}`);\r\n\t\t\tconsole.log(`Current Session UserCount: ${stats.UserCount}`);\r\n\t\t\tconsole.log(`Current Session SendBytes: ${stats.SendBytes}`);\r\n\t\t\tconsole.log(`Current Session RecvBytes: ${stats.RecvBytes}`);\r\n\t\t\tconsole.log(`Current Session SendBitrate: ${stats.SendBitrate}`);\r\n\t\t\tconsole.log(`Current Session RecvBitrate: ${stats.RecvBitrate}`);\r\n\t\t});\r\n\t}\r\n\r\n\tgetSystemStats() {\r\n\t\tconst client = this.client;\r\n\t\tclient.getSystemStats((stats) => {\r\n\t\t\tconsole.log(`Current battery level: ${stats.BatteryLevel}`);\r\n\t\t});\r\n\t}\r\n\r\n\tsendMessage(message) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (StateService.state.connected) {\r\n\t\t\t\tmessage.clientId = StateService.state.uid;\r\n\t\t\t\tswitch (message.type) {\r\n\t\t\t\t\tcase MessageType.ControlInfo:\r\n\t\t\t\t\tcase MessageType.NavToGrid:\r\n\t\t\t\t\tcase MessageType.ShowPanel:\r\n\t\t\t\t\tcase MessageType.PlayMedia:\r\n\t\t\t\t\t\tif (!StateService.state.control && !StateService.state.spyed) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t\t// message.wrc_version = 'beta';\r\n\t\t\t\t// message.uid = StateService.state.uid;\r\n\t\t\t\tconst send = (message, channel) => {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst text = JSON.stringify(message);\r\n\t\t\t\t\t\tif (message.messageId) {\r\n\t\t\t\t\t\t\tthis.once(`message-${message.messageId}`, (message) => {\r\n\t\t\t\t\t\t\t\tresolve(message);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// console.log('AgoraService.sendMessage.sending', message.type);\r\n\t\t\t\t\t\tchannel.sendMessage({ text: text }).then(() => {\r\n\t\t\t\t\t\t\t// console.log('AgoraService.sendMessage', text);\r\n\t\t\t\t\t\t\tif (!message.messageId) {\r\n\t\t\t\t\t\t\t\tresolve(message);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}).catch(error => {\r\n\t\t\t\t\t\t\tconsole.log('AgoraService.sendMessage.error', error);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} catch (error) {\r\n\t\t\t\t\t\tconsole.log('AgoraService.sendMessage.error', error);\r\n\t\t\t\t\t\t// reject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tconst channel = this.channel;\r\n\t\t\t\tif (channel) {\r\n\t\t\t\t\tsend(message, channel);\r\n\t\t\t\t} else {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tthis.once(`channel`, (channel) => {\r\n\t\t\t\t\t\t\tsend(message, channel);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} catch (error) {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// console.log('StateService.state.connected', StateService.state.connected)\r\n\t\t\t\t// reject();\r\n\t\t\t}\r\n\t\t})\r\n\t}\r\n\r\n\taddOrUpdateChannelAttributes(messages) {\r\n\t\tconst messageClient = this.messageClient;\r\n\t\tif (messageClient) {\r\n\t\t\tconst attributes = {};\r\n\t\t\tmessages.forEach(message => {\r\n\t\t\t\tconst key = message.date.toString();\r\n\t\t\t\tattributes[key] = JSON.stringify(message);\r\n\t\t\t});\r\n\t\t\tif (Object.keys(attributes).length) {\r\n\t\t\t\t// console.log('AgoraService.setChannelAttributes', attributes);\r\n\t\t\t\tconst promise = messageClient.addOrUpdateChannelAttributes(StateService.state.channelNameLink, attributes, { enableNotificationToChannelMembers: false });\r\n\t\t\t\treturn from(promise);\r\n\t\t\t} else {\r\n\t\t\t\treturn of(null);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tgetChannelAttributes() {\r\n\t\tconst messageClient = this.messageClient;\r\n\t\tif (messageClient) {\r\n\t\t\tconst promise = messageClient.getChannelAttributes(StateService.state.channelNameLink);\r\n\t\t\treturn from(promise).pipe(\r\n\t\t\t\tmap(attributes => Object.keys(attributes).map(key => attributes[key])),\r\n\t\t\t\tmap(attributes => {\r\n\t\t\t\t\tattributes.sort((a, b) => {\r\n\t\t\t\t\t\treturn a.lastUpdateTs - b.lastUpdateTs;\r\n\t\t\t\t\t});\r\n\t\t\t\t\tconst messages = attributes.map(attribute => {\r\n\t\t\t\t\t\tconst message = JSON.parse(attribute.value);\r\n\t\t\t\t\t\t// console.log('AgoraService.getChannelAttributes.attribute', attribute, message);\r\n\t\t\t\t\t\treturn message;\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log('AgoraService.getChannelAttributes', messages);\r\n\t\t\t\t\treturn messages;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tcheckBroadcastMessage(message) {\r\n\t\t// filter for broadcast\r\n\t\t// !!! filter events here\r\n\t\tswitch (message.type) {\r\n\t\t\tcase MessageType.RequestControlDismiss:\r\n\t\t\t\tStateService.patchState({ locked: false });\r\n\t\t\t\tthis.sendMessage({\r\n\t\t\t\t\ttype: MessageType.RequestControlDismissed,\r\n\t\t\t\t\tmessageId: message.messageId\r\n\t\t\t\t});\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.RequestInfoDismiss:\r\n\t\t\t\t// console.log('checkBroadcastMessage.RequestInfoDismiss', message);\r\n\t\t\t\tStateService.patchState({ spyed: false });\r\n\t\t\t\tthis.sendMessage({\r\n\t\t\t\t\ttype: MessageType.RequestInfoDismissed,\r\n\t\t\t\t\tmessageId: message.messageId,\r\n\t\t\t\t\tremoteId: message.remoteId,\r\n\t\t\t\t});\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.RequestInfoResult:\r\n\t\t\t\t// console.log('checkBroadcastMessage.RequestInfoResult', message);\r\n\t\t\t\tif (StateService.state.role === RoleType.Publisher) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t} else if (StateService.state.locked) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase MessageType.ControlInfo:\r\n\t\t\tcase MessageType.ShowPanel:\r\n\t\t\tcase MessageType.PlayMedia:\r\n\t\t\tcase MessageType.NavToView:\r\n\t\t\tcase MessageType.NavToGrid:\r\n\t\t\t\tif (StateService.state.locked || (StateService.state.spying && StateService.state.spying === message.clientId)) {\r\n\t\t\t\t\tthis.broadcastMessage(message);\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthis.broadcastMessage(message);\r\n\t\t}\r\n\t}\r\n\r\n\tbroadcastMessage(message) {\r\n\t\tMessageService.out(message);\r\n\t}\r\n\r\n\tbroadcastEvent(event) {\r\n\t\tMessageService.out({\r\n\t\t\ttype: MessageType.AgoraEvent,\r\n\t\t\tevent,\r\n\t\t});\r\n\t}\r\n\r\n\tonMessage(data, uid) {\r\n\t\t// console.log('AgoraService.onMessage', data.text, uid, StateService.state.uid);\r\n\t\t// discard message delivered by current state uid;\r\n\t\tif (uid !== StateService.state.uid) {\r\n\t\t\t// console.log('AgoraService.onMessage', data.text);\r\n\t\t\tconst message = JSON.parse(data.text);\r\n\t\t\tif (message.messageId && this.has(`message-${message.messageId}`)) {\r\n\t\t\t\t// !!! removed return\r\n\t\t\t\tthis.emit(`message-${message.messageId}`, message);\r\n\t\t\t}\r\n\t\t\t// discard message delivered to specific remoteId when differs from current state uid;\r\n\t\t\tif (message.remoteId && message.remoteId !== StateService.state.uid && message.remoteId !== StateService.state.screenUid) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\t// !!! check position !!!\r\n\t\t\tif (message.type === MessageType.VRStarted) {\r\n\t\t\t\tconst container = document.createElement('div');\r\n\t\t\t\tcontainer.classList.add('player__vr');\r\n\t\t\t\tmessage.container = container;\r\n\t\t\t}\r\n\t\t\t/*\r\n\t\t\tif (message.type === MessageType.VRStarted || message.type === MessageType.VREnded) {\r\n\t\t\t\tconsole.log('AgoraService.onMessage', message.type, message);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.checkBroadcastMessage(message);\r\n\t\t}\r\n\t}\r\n\r\n\tonError(error) {\r\n\t\tconsole.log('AgoraService.onError', error);\r\n\t}\r\n\r\n\tonStreamPublished(event) {\r\n\t\t// console.log('AgoraService.onStreamPublished');\r\n\t\tconst local = StreamService.local;\r\n\t\tlocal.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.local = local;\r\n\t}\r\n\r\n\tonStreamUnpublished(event) {\r\n\t\t// console.log('AgoraService.onStreamUnpublished');\r\n\t\tStreamService.local = null;\r\n\t}\r\n\r\n\tonStreamAdded(event) {\r\n\t\tconst client = this.client;\r\n\t\tconst stream = event.stream;\r\n\t\tif (!stream) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst streamId = stream.getId();\r\n\t\t// console.log('AgoraService.onStreamAdded', streamId, StateService.state.uid, StateService.state.screenUid);\r\n\t\tif (streamId !== StateService.state.uid && streamId !== StateService.state.screenUid) {\r\n\t\t\tclient.subscribe(stream, (error) => {\r\n\t\t\t\tconsole.log('AgoraService.onStreamAdded.subscribe.error', error);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonStreamRemoved(event) {\r\n\t\tconst stream = event.stream;\r\n\t\tconst streamId = stream.getId();\r\n\t\tif (streamId !== StateService.state.uid && streamId !== StateService.state.screenUid) {\r\n\t\t\t// !!! this happen on oculus removed timeout\r\n\t\t\t// console.log('AgoraService.onStreamRemoved', streamId);\r\n\t\t\tthis.remoteRemove(streamId);\r\n\t\t}\r\n\t}\r\n\r\n\tonStreamSubscribed(event) {\r\n\t\t// console.log('AgoraService.onStreamSubscribed', event.stream.getId());\r\n\t\tthis.remoteAdd(event.stream);\r\n\t}\r\n\r\n\tonPeerConnect(event) {\r\n\t\t// console.log('AgoraService.onPeerConnect', event);\r\n\t\tthis.peerAdd(event);\r\n\t}\r\n\r\n\tonPeerLeaved(event) {\r\n\t\tconst clientId = event.uid;\r\n\t\tif (clientId !== StateService.state.uid) {\r\n\t\t\t// console.log('AgoraService.onPeerLeaved', event.uid);\r\n\t\t\tconst remote = this.remoteRemove(clientId);\r\n\t\t\tif (remote.clientInfo) {\r\n\t\t\t\t// !!! remove screenRemote?\r\n\t\t\t\tif (remote.clientInfo.role === RoleType.Publisher) {\r\n\t\t\t\t\tStateService.patchState({ hosted: false, locked: false, control: false, spyed: false });\r\n\t\t\t\t} else if (StateService.state.spying === clientId) {\r\n\t\t\t\t\tStateService.patchState({ spying: false });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.peerRemove(clientId);\r\n\t}\r\n\r\n\tpeerAdd(event) {\r\n\t\t// console.log('AgoraService.peerAdd', event);\r\n\t\tconst peer = {\r\n\t\t\tuid: event.uid\r\n\t\t};\r\n\t\tconst peers = StreamService.peers;\r\n\t\tpeers.push(peer);\r\n\t\tStreamService.peers = peers;\r\n\t\tthis.broadcastEvent(new AgoraPeerEvent({ peer }));\r\n\t}\r\n\r\n\tpeerRemove(peerId) {\r\n\t\t// console.log('AgoraService.peerRemove', peerId);\r\n\t\tconst peers = StreamService.peers;\r\n\t\tconst peer = peers.find(x => x.uid === peerId);\r\n\t\tif (peer) {\r\n\t\t\tpeers.splice(peers.indexOf(peer), 1);\r\n\t\t\tStreamService.peers = peers;\r\n\t\t}\r\n\t}\r\n\r\n\tremoteAdd(stream) {\r\n\t\t// console.log('AgoraService.remoteAdd', stream);\r\n\t\tStreamService.remoteAdd(stream);\r\n\t\tthis.broadcastEvent(new AgoraRemoteEvent({ stream }));\r\n\t\tconst remoteId = stream.getId();\r\n\t\tthis.sendRemoteRequestPeerInfo(remoteId).then((message) => {\r\n\t\t\tStreamService.remoteSetClientInfo(remoteId, message.clientInfo);\r\n\t\t});\r\n\t}\r\n\r\n\tremoteRemove(streamId) {\r\n\t\t// console.log('AgoraService.remoteRemove', streamId);\r\n\t\tconst remote = StreamService.remoteRemove(streamId);\r\n\t\tif (remote && remote.clientInfo && remote.clientInfo.role === RoleType.Publisher && remote.clientInfo.screenUid !== streamId) {\r\n\t\t\tStateService.patchState({ hosted: false });\r\n\t\t}\r\n\t\treturn remote;\r\n\t}\r\n\r\n\tonMuteVideo(event) {\r\n\t\t// console.log('AgoraService.onMuteVideo', event);\r\n\t\tthis.broadcastEvent(new AgoraMuteVideoEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonUnmuteVideo(event) {\r\n\t\t// console.log('AgoraService.onUnmuteVideo', event);\r\n\t\tthis.broadcastEvent(new AgoraUnmuteVideoEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonMuteAudio(event) {\r\n\t\t// console.log('AgoraService.onMuteAudio', event);\r\n\t\tthis.broadcastEvent(new AgoraMuteAudioEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonUnmuteAudio(event) {\r\n\t\t// console.log('AgoraService.onUnmuteAudio', event);\r\n\t\tthis.broadcastEvent(new AgoraUnmuteAudioEvent({ streamId: event.uid }));\r\n\t}\r\n\r\n\tonVolumeIndicator(event) {\r\n\t\t// console.log('AgoraService.onVolumeIndicator', event);\r\n\t\tconst streams = event.attr.map(x => {\r\n\t\t\treturn { streamId: x.uid, level: x.level };\r\n\t\t});\r\n\t\tthis.broadcastEvent(new AgoraVolumeLevelsEvent({ streams: streams }));\r\n\t}\r\n\r\n\tonConnectionStateChange(event) {\r\n\t\tconsole.log('AgoraService.onConnectionStateChange', event);\r\n\t}\r\n\r\n\tonTokenPrivilegeWillExpire(event) {\r\n\t\tconsole.log('AgoraService.onTokenPrivilegeWillExpire');\r\n\t\tconst client = this.client;\r\n\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\tif (token.token) {\r\n\t\t\t\tclient.renewToken(token.token);\r\n\t\t\t\tconsole.log('AgoraService.onTokenPrivilegeWillExpire.renewed');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonTokenPrivilegeDidExpire(event) {\r\n\t\tconsole.log('AgoraService.onTokenPrivilegeDidExpire');\r\n\t\tconst client = this.client;\r\n\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\tif (token.token) {\r\n\t\t\t\tclient.renewToken(token.token);\r\n\t\t\t\tconsole.log('AgoraService.onTokenPrivilegeDidExpire.renewed');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t// screen\r\n\r\n\ttoggleScreen() {\r\n\t\tconst screen = StreamService.screen;\r\n\t\tif (screen) {\r\n\t\t\tthis.unpublishScreenStream();\r\n\t\t} else {\r\n\t\t\tif (this.screenClient) {\r\n\t\t\t\tthis.createScreenStream(StateService.state.screenUid);\r\n\t\t\t} else {\r\n\t\t\t\tthis.createScreenClient(() => {\r\n\t\t\t\t\tconst channelNameLink = this.getChannelNameLink();\r\n\t\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\t\t// console.log('AgoraService.rtcToken$', token);\r\n\t\t\t\t\t\tthis.screenJoin(token.token, channelNameLink);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\t// console.log(screen);\r\n\t}\r\n\r\n\tcreateScreenClient(next) {\r\n\t\tif (this.screenClient) {\r\n\t\t\tnext();\r\n\t\t}\r\n\t\tconst screenClient = this.screenClient = AgoraRTC.createClient({ mode: 'live', codec: 'h264' }); // rtc, vp8\r\n\t\tconst clientInit = () => {\r\n\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\tscreenClient.startProxyServer(3);\r\n\t\t\t\tconsole.log('AgoraService.screenClient.startProxyServer');\r\n\t\t\t}\r\n\t\t\tscreenClient.init(environment.appKey, () => {\r\n\t\t\t\t// console.log('AgoraRTC screenClient initialized');\r\n\t\t\t\tnext();\r\n\t\t\t}, (error) => {\r\n\t\t\t\t// console.log('AgoraRTC client init failed', error);\r\n\t\t\t\tthis.screenClient = null;\r\n\t\t\t});\r\n\t\t}\r\n\t\tclientInit();\r\n\t\tscreenClient.on('error', this.onScreenError);\r\n\t\tscreenClient.on('stream-published', this.onScreenStreamPublished);\r\n\t\tscreenClient.on('stream-unpublished', this.onScreenStreamUnpublished);\r\n\t\t// only for remotes\r\n\t\t// screenClient.on('stream-added', this.onScreenStreamAdded);\r\n\t\t// screenClient.on('stream-removed', this.onScreenStreamRemoved);\r\n\t\t// screenClient.on('stream-subscribed', this.onScreenStreamSubscribed);\r\n\t\t// screenClient.on('peer-online', this.onScreenPeerConnect);\r\n\t\t// screenClient.on('peer-leave', this.onScreenPeerLeaved);\r\n\t\t// screenClient.on('onTokenPrivilegeWillExpire', this.onScreenTokenPrivilegeWillExpire);\r\n\t\t// screenClient.on('onTokenPrivilegeDidExpire', this.onScreenTokenPrivilegeDidExpire);\r\n\t}\r\n\r\n\tscreenJoin(token, channelNameLink) {\r\n\t\tconst screenClient = this.screenClient;\r\n\t\tconst screenClientId = AgoraService.getUniqueUserId();\r\n\t\t// const screenClientId = SessionStorageService.get('bHereClientId') || AgoraService.getUniqueUserId();\r\n\t\t// console.log('AgoraService.screenJoin', { token, channelNameLink, screenClientId });\r\n\t\tscreenClient.join(token, channelNameLink, screenClientId, (screenUid) => {\r\n\t\t\t// console.log('AgoraService.join', screenUid);\r\n\t\t\tStateService.patchState({ screenUid });\r\n\t\t\tthis.createScreenStream(screenUid);\r\n\t\t}, (error) => {\r\n\t\t\tconsole.log('AgoraService.screenJoin.error', error);\r\n\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\tAgoraService.rtcToken$(channelNameLink).subscribe(token => {\r\n\t\t\t\t\tthis.screenJoin(token.token, channelNameLink);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcreateScreenStream(screenUid) {\r\n\t\tconst options = {\r\n\t\t\tstreamID: screenUid,\r\n\t\t\taudio: false,\r\n\t\t\tvideo: false,\r\n\t\t\tscreen: true\r\n\t\t}\r\n\t\t/*\r\n\t\t// Set relevant properties according to the browser.\r\n\t\t// Note that you need to implement isFirefox and isCompatibleChrome.\r\n\t\tif (isFirefox()) {\r\n\t\t\toptions.mediaSource = 'window';\r\n\t\t} else if (!isCompatibleChrome()) {\r\n\t\t\toptions.extensionId = 'minllpmhdgpndnkomcoccfekfegnlikg';\r\n\t\t}\r\n\t\t*/\r\n\t\tconst quality = Object.assign({}, StateService.state.quality);\r\n\t\tconst stream = AgoraRTC.createStream(options);\r\n\t\tif (quality) {\r\n\t\t\tstream.setScreenProfile('720p_1');\r\n\t\t\t// stream.setVideoProfile(quality.profile);\r\n\t\t\t// stream.setVideoEncoderConfiguration(quality);\r\n\t\t}\r\n\t\t// Initialize the stream.\r\n\t\tstream.init(() => {\r\n\t\t\tStreamService.screen = stream;\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.publishScreenStream();\r\n\t\t\t}, 1);\r\n\t\t}, function(error) {\r\n\t\t\tconsole.log('AgoraService.createScreenStream.screen.init.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tpublishScreenStream() {\r\n\t\tconst screenClient = this.screenClient;\r\n\t\tconst screen = StreamService.screen;\r\n\t\t// publish screen stream\r\n\t\tscreenClient.publish(screen, (error) => {\r\n\t\t\tconsole.log('AgoraService.publishScreenStream.error', screen.getId(), error);\r\n\t\t});\r\n\t\tscreen.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.screen = screen;\r\n\t}\r\n\r\n\tunpublishScreenStream() {\r\n\t\tconst screenClient = this.screenClient;\r\n\t\tconst screen = StreamService.screen;\r\n\t\t// console.log('AgoraService.unpublishScreenStream', screen, screenClient);\r\n\t\tif (screenClient && screen) {\r\n\t\t\tscreenClient.unpublish(screen, (error) => {\r\n\t\t\t\tconsole.log('AgoraService.unpublishScreenStream.error', screen.getId(), error);\r\n\t\t\t});\r\n\t\t}\r\n\t\tStreamService.screen = null;\r\n\t}\r\n\r\n\tleaveScreenClient() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst screenClient = this.screenClient;\r\n\t\t\tif (screenClient) {\r\n\t\t\t\tscreenClient.leave(() => {\r\n\t\t\t\t\tthis.screenClient = null;\r\n\t\t\t\t\t// console.log('Leave channel successfully');\r\n\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\tscreenClient.stopProxyServer();\r\n\t\t\t\t\t\tconsole.log('AgoraService.screenClient.stopProxyServer');\r\n\t\t\t\t\t}\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tconsole.log('AgoraService.leaveScreenClient.error', error);\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tresolve();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonScreenError(error) {\r\n\t\tconsole.log('AgoraService.onScreenError', error);\r\n\t}\r\n\r\n\tonScreenStreamPublished(event) {\r\n\t\t// console.log('AgoraService.onScreenStreamPublished');\r\n\t\tconst screen = StreamService.screen;\r\n\t\tscreen.clientInfo = {\r\n\t\t\trole: StateService.state.role,\r\n\t\t\tname: StateService.state.name,\r\n\t\t\tuid: StateService.state.uid,\r\n\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t};\r\n\t\tStreamService.screen = screen;\r\n\t}\r\n\r\n\tonScreenStreamUnpublished(event) {\r\n\t\t// console.log('AgoraService.onScreenStreamUnpublished');\r\n\t\tStreamService.screen = null;\r\n\t}\r\n\r\n\t// tokens\r\n\tstatic rtcToken$(channelNameLink) {\r\n\t\tif (environment.flags.useToken) {\r\n\t\t\treturn HttpService.post$('/api/token/rtc', { channelName: channelNameLink, uid: null });\r\n\t\t} else {\r\n\t\t\treturn of({ token: null });\r\n\t\t}\r\n\t}\r\n\r\n\tstatic rtmToken$(uid) {\r\n\t\tif (environment.flags.useToken) {\r\n\t\t\treturn HttpService.post$('/api/token/rtm', { uid: uid });\r\n\t\t} else {\r\n\t\t\treturn of({ token: null });\r\n\t\t}\r\n\t}\r\n\r\n\t// checks\r\n\tstatic checkRtcConnection() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst client = AgoraRTC.createClient({ mode: 'live', codec: 'h264' });\r\n\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\tclient.startProxyServer(3);\r\n\t\t\t}\r\n\t\t\tclient.init(environment.appKey, () => {\r\n\t\t\t\tAgoraService.checkRtcTryJoin(client).then(uid => {\r\n\t\t\t\t\tresolve(uid);\r\n\t\t\t\t}).catch(error => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t// clear\r\n\t\t\t\t\tclient.leave(() => {\r\n\t\t\t\t\t\tif (environment.flags.useProxy) {\r\n\t\t\t\t\t\t\tclient.stopProxyServer();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, () => {});\r\n\t\t\t\t});\r\n\t\t\t}, (error) => {\r\n\t\t\t\treject(error);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tstatic checkRtcTryJoin(client) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst channelName = 'checkRtcConnection';\r\n\t\t\tAgoraService.rtcToken$(channelName).subscribe(token => {\r\n\t\t\t\tclient.join(token.token, channelName, null, (uid) => {\r\n\t\t\t\t\t// this.createMediaStream(uid, StateService.state.devices.video, StateService.state.devices.audio);\r\n\t\t\t\t\tresolve(uid);\r\n\t\t\t\t}, (error) => {\r\n\t\t\t\t\tif (error === 'DYNAMIC_KEY_EXPIRED') {\r\n\t\t\t\t\t\treturn AgoraService.checkRtcTryJoin(client);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.log('AgoraService.checkRtcConnection.error', error);\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tstatic checkRtmConnection(uid) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (!USE_RTM) {\r\n\t\t\t\treturn resolve();\r\n\t\t\t}\r\n\t\t\tlet client = AgoraRTM.createInstance(environment.appKey, { logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\tclient.setParameters({ logFilter: AgoraRTM.LOG_FILTER_OFF });\r\n\t\t\tlet channel;\r\n\t\t\tAgoraService.rtmToken$(uid).subscribe(token => {\r\n\t\t\t\t// console.log('AgoraService.rtmToken$', token);\r\n\t\t\t\tconst channelName = 'checkRtcConnection';\r\n\t\t\t\tclient.login({ token: token.token, uid: uid.toString() }).then(() => {\r\n\t\t\t\t\tchannel = client.createChannel(channelName);\r\n\t\t\t\t\tchannel.join().then(() => {\r\n\t\t\t\t\t\tresolve(uid);\r\n\t\t\t\t\t\tchannel.leave();\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t\t// clear\r\n\t\t\t\t\t\tchannel.leave().then(() => {\r\n\t\t\t\t\t\t\tchannel = null;\r\n\t\t\t\t\t\t\tclient.logout().then(() => {\r\n\t\t\t\t\t\t\t\tclient = null;\r\n\t\t\t\t\t\t\t}).catch(() => {});\r\n\t\t\t\t\t\t}).catch(() => {});\r\n\t\t\t\t\t})\r\n\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\treject(error);\r\n\t\t\t\t}).finally(() => {\r\n\t\t\t\t\t// clear\r\n\t\t\t\t\tif (client) {\r\n\t\t\t\t\t\tclient.logout().then(() => {\r\n\t\t\t\t\t\t\tclient = null;\r\n\t\t\t\t\t\t}).catch(() => {});\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tstatic getDevices() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tlet devices_ = AgoraService.devices_;\r\n\t\t\tif (devices_) {\r\n\t\t\t\tresolve(devices_);\r\n\t\t\t} else {\r\n\t\t\t\tdevices_ = AgoraService.devices_ = [];\r\n\t\t\t\tvar constraints = {\r\n\t\t\t\t\taudio: true,\r\n\t\t\t\t\tvideo: true,\r\n\t\t\t\t};\r\n\t\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\r\n\t\t\t\t\tnavigator.mediaDevices.getUserMedia(constraints).then((stream) => {\r\n\t\t\t\t\t\tnavigator.mediaDevices.enumerateDevices().then((devices) => {\r\n\t\t\t\t\t\t\tstream.getTracks().forEach((track) => {\r\n\t\t\t\t\t\t\t\ttrack.stop();\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tdevices.forEach((device) => {\r\n\t\t\t\t\t\t\t\tdevices_.push(device);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tresolve(devices_);\r\n\t\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\treject('Media device not available');\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormGroup } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport MessageService from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport AgoraService from './agora.service';\r\nimport { MessageType } from './agora.types';\r\n\r\nexport class ChatMessage {\r\n\r\n\tconstructor(message, clientId, name) {\r\n\t\tthis.type = MessageType.ChatMessage;\r\n\t\tthis.clientId_ = clientId;\r\n\t\tif (typeof message === 'string') {\r\n\t\t\tthis.date = Date.now();\r\n\t\t\tthis.clientId = clientId;\r\n\t\t\tthis.name = name;\r\n\t\t\tthis.message = message;\r\n\t\t} else if (typeof message === 'object') {\r\n\t\t\tthis.date = message.date;\r\n\t\t\tthis.clientId = message.clientId;\r\n\t\t\tthis.name = message.name;\r\n\t\t\tthis.message = message.message;\r\n\t\t}\r\n\t\tconst names = this.name.split(' ');\r\n\t\tthis.shortName = names[0].substr(0, 1).toUpperCase() + (names.length > 1 ? names[1] : names[0]).substr(0, 1).toUpperCase();\r\n\t}\r\n\r\n\tget me() {\r\n\t\treturn this.clientId === this.clientId_;\r\n\t}\r\n\r\n\tgetPayload() {\r\n\t\treturn {\r\n\t\t\tdate: this.date,\r\n\t\t\tclientId: this.clientId,\r\n\t\t\tname: this.name,\r\n\t\t\tmessage: this.message,\r\n\t\t};\r\n\t}\r\n\r\n\tgetCopy() {\r\n\t\treturn new ChatMessage({\r\n\t\t\tdate: this.date,\r\n\t\t\tclientId: this.clientId,\r\n\t\t\tname: this.name,\r\n\t\t\tmessage: this.message,\r\n\t\t}, this.clientId_);\r\n\t}\r\n}\r\n\r\nexport default class AgoraChatComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tmessage: null,\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraChatComponent.changes$', form.value);\r\n\t\t\tthis.checkTypings(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraChatComponent.state', state);\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// console.log('AgoraChatComponent.MessageService', message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\tthis.pushMessage(new ChatMessage(message, StateService.state.uid, StateService.state.name));\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatTypingBegin:\r\n\t\t\t\t\tthis.typingBegin(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatTypingEnd:\r\n\t\t\t\t\tthis.typingEnd(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.messages = [];\r\n\t\tthis.groupedMessages = [];\r\n\t\tif (this.demo) {\r\n\t\t\t// !!! only for demo\r\n\t\t\tconst messages = AgoraChatComponent.getFakeList().map(x => new ChatMessage(x, StateService.state.uid, StateService.state.name));\r\n\t\t\tthis.updateMessages(messages);\r\n\t\t\tMessageService.in$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(message => {\r\n\t\t\t\tmessage.clientId = message.clientId || StateService.state.uid;\r\n\t\t\t\t// console.log('AgoraChatComponent.MessageService.in$', message);\r\n\t\t\t\tswitch (message.type) {\r\n\t\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase MessageType.ChatTypingBegin:\r\n\t\t\t\t\t\tMessageService.out(message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase MessageType.ChatTypingEnd:\r\n\t\t\t\t\t\tMessageService.out(message);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t// !!! only for demo\r\n\t\t} else {\r\n\t\t\tconst agora = this.agora = AgoraService.getSingleton();\r\n\t\t\tif (agora) {\r\n\t\t\t\tagora.getChannelAttributes().pipe(\r\n\t\t\t\t\tfirst(),\r\n\t\t\t\t).subscribe(messages => {\r\n\t\t\t\t\tmessages = messages.map(x => new ChatMessage(x, StateService.state.uid, StateService.state.name));\r\n\t\t\t\t\t// console.log('AgoraChatComponent.getChannelAttributes.messages', messages);\r\n\t\t\t\t\tthis.updateMessages(messages);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonView() {\r\n\t\t// this.scrollToBottom();\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\t// this.scrollToBottom();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tconst message = this.createMessage(this.form.value.message);\r\n\t\tthis.sendMessage(message);\r\n\t\tthis.form.get('message').value = null;\r\n\t\tif (this.demo) {\r\n\t\t\tthis.randomMessage();\r\n\t\t}\r\n\t}\r\n\r\n\tcreateMessage(text) {\r\n\t\tconst message = new ChatMessage(text, StateService.state.uid, StateService.state.name);\r\n\t\treturn message;\r\n\t}\r\n\r\n\tsendMessage(message) {\r\n\t\tthis.pushMessage(message);\r\n\t\tconst agora = this.agora;\r\n\t\tif (agora) {\r\n\t\t\tagora.addOrUpdateChannelAttributes([message.getPayload()]).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe();\r\n\t\t}\r\n\t\tMessageService.send(message);\r\n\t}\r\n\r\n\tonClose(event) {\r\n\t\tthis.close.next();\r\n\t}\r\n\r\n\tscrollToBottom() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst scrollView = node.querySelector('.group--scrollview');\r\n\t\tscrollView.scrollTop = scrollView.scrollHeight;\r\n\t}\r\n\r\n\tpushMessage(message) {\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tthis.removeTyping({ type: MessageType.ChatTypingBegin, clientId: message.clientId }, this.messages);\r\n\t\tmessages.push(message);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\ttypingBegin(message) {\r\n\t\t// console.log('AgoraChatComponent.typingBegin', message);\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tmessages.push(message);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\ttypingEnd(message) {\r\n\t\t// console.log('AgoraChatComponent.typingEnd', message);\r\n\t\tconst messages = this.messages ? this.messages.slice() : [];\r\n\t\tthis.removeTyping({ type: MessageType.ChatTypingBegin, clientId: message.clientId }, messages);\r\n\t\tthis.updateMessages(messages);\r\n\t}\r\n\r\n\tremoveTyping(message, messages, recursive = true) {\r\n\t\tconst index = messages.reduce((p,c,i) => {\r\n\t\t\treturn (c.type === message.type && c.clientId === message.clientId) ? i : p;\r\n\t\t}, -1);\r\n\t\tif (index !== -1) {\r\n\t\t\tmessages.splice(index, 1);\r\n\t\t\tif (recursive === true) {\r\n\t\t\t\tthis.removeTyping(message, messages, true);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn index;\r\n\t}\r\n\r\n\tcheckTypings(changes) {\r\n\t\tconst typings = (changes.message && changes.message.length > 0);\r\n\t\t// console.log('AgoraChatComponent.checkTypings', typings);\r\n\t\tif (this.typings_ !== typings) {\r\n\t\t\tthis.typings_ = typings;\r\n\t\t\tif (typings) {\r\n\t\t\t\tMessageService.send({ type: MessageType.ChatTypingBegin });\r\n\t\t\t} else {\r\n\t\t\t\tMessageService.send({ type: MessageType.ChatTypingEnd });\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tupdateMessages(messages) {\r\n\t\tthis.messages = messages;\r\n\t\tif (true) {\r\n\t\t\tthis.groupedMessages = [];\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t\tconst groupedMessages = [];\r\n\t\tmessages.forEach(message => {\r\n\t\t\tif (message.type === MessageType.ChatMessage) {\r\n\t\t\t\t// ChatMessage\r\n\t\t\t\tconst lastMessage = groupedMessages.length ? groupedMessages[groupedMessages.length - 1] : null;\r\n\t\t\t\tif (lastMessage && lastMessage.clientId === message.clientId) {\r\n\t\t\t\t\tlastMessage.message += `<br />${message.message}`;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tgroupedMessages.push(message.getCopy());\r\n\t\t\t\t}\r\n\t\t\t} else if (message.type === MessageType.ChatTypingBegin) {\r\n\t\t\t\t// ChatTypingBegin\r\n\t\t\t\tconst lastMessage = groupedMessages.reduce((p, c, i) => {\r\n\t\t\t\t\treturn (c.clientId === message.clientId) ? c : p;\r\n\t\t\t\t}, null);\r\n\t\t\t\tif (lastMessage) {\r\n\t\t\t\t\tlastMessage.typing = true;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('MessageType.ChatTypingBegin', lastMessage, message);\r\n\t\t\t}\r\n\t\t});\r\n\t\tsetTimeout(() => {\r\n\t\t\tthis.groupedMessages = groupedMessages;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// console.log('AgoraChatComponent.updateMessages', messages, groupedMessages);\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.scrollToBottom();\r\n\t\t\t}, 1);\r\n\t\t}, 1);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid && this.form.value.message && this.form.value.message.length > 0;\r\n\t}\r\n\r\n\t// demo\r\n\r\n\trandomMessage() {\r\n\t\tsetTimeout(() => {\r\n\t\t\tconst message = this.createRandomMessage();\r\n\t\t\tthis.sendMessage(message);\r\n\t\t}, (1 + Math.random() * 5) * 1000);\r\n\t}\r\n\r\n\tcreateRandomMessage(text) {\r\n\t\tconst message = new ChatMessage({\r\n\t\t\tdate: Date.now(),\r\n\t\t\tclientId: '9fe0e1b9-6a6b-418b-b916-4bbff3eeb123',\r\n\t\t\tname: 'Herman frederick',\r\n\t\t\tmessage: 'Lorem ipsum dolor',\r\n\t\t}, StateService.state.uid, StateService.state.name);\r\n\t\treturn message;\r\n\t}\r\n}\r\n\r\nAgoraChatComponent.meta = {\r\n\tselector: '[agora-chat]',\r\n\toutputs: ['close'],\r\n\tinputs: ['demo'],\r\n};\r\n\r\nAgoraChatComponent.getFakeList = () => {\r\n\tlet messages = [\r\n\t\t{\r\n\t\t\t\"date\": 1614592230000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Function-based web-enabled benchmark\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592240000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Customizable exuding superstructure\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592250000,\r\n\t\t\t\"name\": \"Gilles Pitkins\",\r\n\t\t\t\"message\": \"Synergistic interactive archive\",\r\n\t\t\t\"clientId\": \"cfe9ff5b-f7da-449d-bf5a-3184b5eba6ea\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592260000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Digitized client-server initiative\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592270000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Quality-focused tertiary open system\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592280000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Exclusive uniform middleware\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592290000,\r\n\t\t\t\"name\": \"John Pruckner\",\r\n\t\t\t\"message\": \"Decentralized disintermediate extranet\",\r\n\t\t\t\"clientId\": \"ae51e846-d043-41e9-bb5c-3189181e5b43\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592300000,\r\n\t\t\t\"name\": \"Lamont Georgievski\",\r\n\t\t\t\"message\": \"Enhanced static approach\",\r\n\t\t\t\"clientId\": \"1961cd9e-93aa-4bd0-b96a-89fcbd36b257\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592310000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Ergonomic clear-thinking info-mediaries\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592320000,\r\n\t\t\t\"name\": \"Jeri Pedroni\",\r\n\t\t\t\"message\": \"Grass-roots dynamic encryption\",\r\n\t\t\t\"clientId\": \"13d69bba-3656-449b-8fe3-d7a87062b044\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592330000,\r\n\t\t\t\"name\": \"Frederik Dechelle\",\r\n\t\t\t\"message\": \"Compatible disintermediate policy\",\r\n\t\t\t\"clientId\": \"9151ebe0-efa8-40b4-a341-b8fd489e9c88\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592340000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Inverse user-facing adapter\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592350000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Future-proofed even-keeled application\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592360000,\r\n\t\t\t\"name\": \"Cassie Jonathon\",\r\n\t\t\t\"message\": \"Profit-focused content-based budgetary management\",\r\n\t\t\t\"clientId\": \"5b3dc6f3-2a3d-493d-aac5-66ddfce2d709\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592370000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Managed intermediate monitoring\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592380000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Exclusive client-server encoding\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592390000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Cross-group system-worthy matrices\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592400000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Upgradable encompassing benchmark\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592410000,\r\n\t\t\t\"name\": \"Emelen Beevors\",\r\n\t\t\t\"message\": \"Function-based full-range knowledge base\",\r\n\t\t\t\"clientId\": \"c93aea47-ebd8-4e5e-88fd-52053dd35cd1\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"date\": 1614592420000,\r\n\t\t\t\"name\": \"Jhon Appleseed\",\r\n\t\t\t\"message\": \"Synergistic system-worthy capability\",\r\n\t\t\t\"clientId\": \"7341614597544882\"\r\n\t\t}\r\n\t];\r\n\twhile (messages.length < 100) {\r\n\t\tmessages = messages.concat(messages);\r\n\t}\r\n\t// return messages;\r\n\treturn messages.slice(0, 5);\r\n}\r\n","import { Component } from 'rxcomp';\r\n\r\nexport default class AgoraCheckComponent extends Component {}\r\n\r\nAgoraCheckComponent.meta = {\r\n\tselector: '[agora-check]',\r\n\tinputs: ['value'],\r\n\ttemplate: /* html */ `\r\n\t\t<svg *if=\"value == null\" class=\"checkmark idle\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t</svg>\r\n\t\t<svg *if=\"value === true\" class=\"checkmark success\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t\t<path class=\"checkmark__icon\" fill=\"none\" d=\"M14.1 27.2l7.1 7.2 16.7-16.8\" stroke-linecap=\"round\"/>\r\n\t\t</svg>\r\n\t\t<svg *if=\"value === false\" class=\"checkmark error\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 52 52\">\r\n\t\t\t<circle class=\"checkmark__circle\" cx=\"26\" cy=\"26\" r=\"25\" fill=\"none\"/>\r\n\t\t\t<path class=\"checkmark__icon\" stroke-linecap=\"round\" fill=\"none\" d=\"M16 16 36 36 M36 16 16 36\"/>\r\n\t\t</svg>\r\n\t`\r\n};\r\n","\r\nexport const DevicePlatform = {\r\n\tUnknown: 'unknown',\r\n\tIOS: 'ios',\r\n\tAndroid: 'android',\r\n\tWindowsPhone: 'windowsPhone',\r\n\tVRHeadset: 'vrHeadset',\r\n};\r\n\r\nexport class DeviceService {\r\n\r\n\tstatic get platform() {\r\n\t\tif (!this.platform_) {\r\n\t\t\tthis.platform_ = this.getDevicePlatform();\r\n\t\t}\r\n\t\treturn this.platform_;\r\n\t}\r\n\r\n\tstatic get isIOS() {\r\n\t\treturn ['iPad Simulator', 'iPhone Simulator', 'iPod Simulator', 'iPad', 'iPhone', 'iPod'].indexOf(navigator.platform) !== -1\r\n\t\t\t// iPad on iOS 13 detection\r\n\t\t\t|| (navigator.userAgent.indexOf('Mac') !== -1 && 'ontouchend' in document);\r\n\t}\r\n\r\n\tstatic get isVRHeadset() {\r\n\t\treturn navigator.userAgent.indexOf('VR') !== -1 || navigator.userAgent.indexOf('Quest') !== -1 || navigator.userAgent.indexOf('Oculus') !== -1;\r\n\t}\r\n\r\n\tstatic getDevicePlatform() {\r\n\t\tconst userAgent = navigator.userAgent || navigator.vendor || window.opera;\r\n\t\t// Windows Phone must come first because its UA also contains 'Android'\r\n\t\tif (/windows phone/i.test(userAgent)) {\r\n\t\t\treturn DevicePlatform.WindowsPhone;\r\n\t\t}\r\n\t\tif (/android/i.test(userAgent)) {\r\n\t\t\treturn DevicePlatform.Android;\r\n\t\t}\r\n\t\t// iOS detection from: http://stackoverflow.com/a/9039885/177710\r\n\t\t// if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {\r\n\t\tif (this.isIOS) {\r\n\t\t\treturn DevicePlatform.IOS;\r\n\t\t}\r\n\t\tif (this.isVRHeadset) {\r\n\t\t\treturn DevicePlatform.VRHeadset;\r\n\t\t}\r\n\t\treturn DevicePlatform.Unknown;\r\n\t}\r\n\r\n}\r\n","export default class LocalStorageService {\r\n\r\n\tstatic delete(name) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\twindow.localStorage.removeItem(name);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic exist(name) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\treturn window.localStorage[name] !== undefined;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get(name) {\r\n\t\tlet value = null;\r\n\t\tif (this.isLocalStorageSupported() && window.localStorage[name] !== undefined) {\r\n\t\t\ttry {\r\n\t\t\t\tvalue = JSON.parse(window.localStorage[name]);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('LocalStorageService.get.error parsing', name, e);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn value;\r\n\t}\r\n\r\n\tstatic set(name, value) {\r\n\t\tif (this.isLocalStorageSupported()) {\r\n\t\t\ttry {\r\n\t\t\t\tconst cache = [];\r\n\t\t\t\tconst json = JSON.stringify(value, function(key, value) {\r\n\t\t\t\t\tif (typeof value === 'object' && value !== null) {\r\n\t\t\t\t\t\tif (cache.indexOf(value) !== -1) {\r\n\t\t\t\t\t\t\t// Circular reference found, discard key\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcache.push(value);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn value;\r\n\t\t\t\t});\r\n\t\t\t\twindow.localStorage.setItem(name, json);\r\n\t\t\t} catch (e) {\r\n\t\t\t\tconsole.log('LocalStorageService.set.error serializing', name, value, e);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic isLocalStorageSupported() {\r\n\t\tif (this.supported) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tlet supported = false;\r\n\t\ttry {\r\n\t\t\tsupported = 'localStorage' in window && window.localStorage !== null;\r\n\t\t\tif (supported) {\r\n\t\t\t\twindow.localStorage.setItem('test', '1');\r\n\t\t\t\twindow.localStorage.removeItem('test');\r\n\t\t\t} else {\r\n\t\t\t\tsupported = false;\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tsupported = false;\r\n\t\t}\r\n\t\tthis.supported = supported;\r\n\t\treturn supported;\r\n\t}\r\n}\r\n","import { Component } from 'rxcomp';\r\nimport { first } from 'rxjs/operators';\r\nimport { DeviceService } from '../device/device.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport LocalStorageService from '../local-storage/local-storage.service';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\nimport AgoraService from './agora.service';\r\n\r\nconst TIMEOUT = 100;\r\n\r\nexport default class AgoraChecklistComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform; // !!!\r\n\t\tthis.checklist = {};\r\n\t\tthis.errors = {};\r\n\t\tthis.state = {};\r\n\t\tthis.busy = true;\r\n\t\tthis.shouldCheckDevices = true;\r\n\t\tLocalStorageService.set('checklist', false);\r\n\t\tStateService.state$.pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(state => {\r\n\t\t\tconsole.log('AgoraChecklistComponent', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tif (state.role === RoleType.Viewer) {\r\n\t\t\t\tthis.shouldCheckDevices = false;\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.checkBrowser();\r\n\t\t\t}, 1000);\r\n\t\t});\r\n\t}\r\n\r\n\tcheckBrowser() {\r\n\t\tconst browser = AgoraRTC.checkSystemRequirements();\r\n\t\tthis.checklist.browser = browser;\r\n\t\tif (browser) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.checkHttps();\r\n\t\t\t}, TIMEOUT);\r\n\t\t} else {\r\n\t\t\tthis.errors.browser = LabelPipe.transform('bhere_browser_error');\r\n\t\t\tthis.checkHttps(true);\r\n\t\t\tthis.checkAudio(true);\r\n\t\t\tthis.checkVideo(true);\r\n\t\t\tthis.checkRtc(true);\r\n\t\t\tthis.checkRtm(true);\r\n\t\t}\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tcheckHttps(skip) {\r\n\t\tconst https = window.location.protocol === 'https:';\r\n\t\tthis.checklist.https = https;\r\n\t\tif (skip) {\r\n\t\t\tif (!https) {\r\n\t\t\t\tthis.errors.https = LabelPipe.transform('bhere_https_error');\r\n\t\t\t}\r\n\t\t} else if (https) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tif (this.shouldCheckDevices) {\r\n\t\t\t\t\tthis.checkAudio();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}\r\n\t\t\t}, TIMEOUT);\r\n\t\t\tthis.pushChanges();\r\n\t\t} else {\r\n\t\t\tthis.errors.https = LabelPipe.transform('bhere_https_error');\r\n\t\t\tthis.checkAudio(true);\r\n\t\t\tthis.checkVideo(true);\r\n\t\t\tthis.checkRtc(true);\r\n\t\t\tthis.checkRtm(true);\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tcheckAudio(skip) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.audio = false;\r\n\t\t} else {\r\n\t\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\t\t// console.log('checkAudio', devices);\r\n\t\t\t\tconst audioinput = devices.find(x => x.kind === 'audioinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.audio = audioinput != null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.audio = false;\r\n\t\t\t\tthis.errors.audio = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tAgoraRTC.getDevices((devices) => {\r\n\t\t\t\tconsole.log('checkAudio', devices);\r\n\t\t\t\tconst audioinput = devices.find(x => x.kind === 'audioinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.audio = audioinput != null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t}, (error) => {\r\n\t\t\t\tthis.checklist.audio = false;\r\n\t\t\t\tthis.errors.audio = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkVideo();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tcheckVideo(skip) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.video = false;\r\n\t\t} else {\r\n\t\t\tAgoraService.getDevices().then((devices) => {\r\n\t\t\t\t// console.log('checkVideo', devices);\r\n\t\t\t\tconst videoinput = devices.find(x => x.kind === 'videoinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.video = videoinput != null;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.video = false;\r\n\t\t\t\tthis.errors.video = error;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tAgoraRTC.getDevices((devices) => {\r\n\t\t\t\tconsole.log('checkVideo', devices);\r\n\t\t\t\tconst videoinput = devices.find(x => x.kind === 'videoinput' && x.deviceId);\r\n\t\t\t\tthis.checklist.video = videoinput != null;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, (error) => {\r\n\t\t\t\tthis.checklist.video = false;\r\n\t\t\t\tthis.errors.video = error;\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtc();\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tcheckRtc(skip) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.rtc = false;\r\n\t\t} else {\r\n\t\t\tAgoraService.checkRtcConnection().then(uid => {\r\n\t\t\t\tthis.checklist.rtc = true;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.checkRtm(false, uid);\r\n\t\t\t\t}, TIMEOUT);\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.rtc = false;\r\n\t\t\t\tthis.errors.rtc = error;\r\n\t\t\t\tthis.checkRtm(true);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tcheckRtm(skip, uid) {\r\n\t\tif (skip) {\r\n\t\t\tthis.checklist.rtm = false;\r\n\t\t\tthis.onComplete();\r\n\t\t} else {\r\n\t\t\tAgoraService.checkRtmConnection(uid).then(_ => {\r\n\t\t\t\tthis.checklist.rtm = true;\r\n\t\t\t}).catch((error) => {\r\n\t\t\t\tthis.checklist.rtm = false;\r\n\t\t\t\tthis.errors.rtm = error;\r\n\t\t\t}).finally(() => {\r\n\t\t\t\tthis.onComplete();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonComplete() {\r\n\t\tconsole.log('AgoraChecklistComponent.onComplete');\r\n\t\tconst success = Object.keys(this.checklist).reduce((p, c) => {\r\n\t\t\treturn p && this.checklist[c];\r\n\t\t}, true);\r\n\t\tthis.checklist.success = success;\r\n\t\tthis.checklist.error = !success;\r\n\t\tthis.busy = false;\r\n\t\tthis.pushChanges();\r\n\t\tif (state.role === RoleType.SmartDevice) {\r\n\t\t\tthis.onNext();\r\n\t\t}\r\n\t}\r\n\r\n\tonNext() {\r\n\t\tif (this.checklist.success) {\r\n\t\t\tLocalStorageService.set('checklist', true);\r\n\t\t}\r\n\t\tthis.checked.next(this.checklist);\r\n\t}\r\n\r\n\topenHttps() {\r\n\t\twindow.location.href = window.location.href.replace('http://', 'https://').replace(':5000', ':6443');\r\n\t}\r\n}\r\n\r\nAgoraChecklistComponent.meta = {\r\n\tselector: '[agora-checklist]',\r\n\toutputs: ['checked'],\r\n};\r\n","import { BehaviorSubject, Observable, of } from \"rxjs\";\r\nimport { expand, filter, finalize, map, share, tap, withLatestFrom } from \"rxjs/operators\";\r\n\r\nconst BUFF_SIZE = 512;\r\n\r\nexport default class AudioStreamService {\r\n\r\n\tstatic get context() {\r\n\t\tif (!this.context_ && 'AudioContext' in window) {\r\n\t\t\tthis.context_ = new AudioContext();\r\n\t\t}\r\n\t\treturn this.context_;\r\n\t}\r\n\r\n\t/*\r\n\tstatic get processorNode() {\r\n\t\tif (!this.processorNode_) {\r\n\t\t\tthis.processorNode_ = this.context.createScriptProcessor(BUFF_SIZE, 1, 1);\r\n\t\t}\r\n\t\treturn this.processorNode_;\r\n\t}\r\n\t*/\r\n\r\n\t/*\r\n\tstatic get gain() {\r\n\t\tif (!this.gain_) {\r\n\t\t\tthis.gain_ = this.context.createGain();\r\n\t\t}\r\n\t\treturn this.gain_;\r\n\t}\r\n\t*/\r\n\r\n\tstatic get analyser() {\r\n\t\tif (!this.analyser_) {\r\n\t\t\ttry {\r\n\t\t\t\tthis.analyser_ = this.context.createAnalyser();\r\n\t\t\t} catch(error) {\r\n\t\t\t\tconsole.log('AudioStreamService.analyser', error);\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn this.analyser_;\r\n\t}\r\n\r\n\tstatic addSource(streamOrElement) {\r\n\t\tconst key = streamOrElement instanceof MediaStream ? streamOrElement.id : streamOrElement;\r\n\t\tif (!this.sources_[key]) {\r\n\t\t\tif (streamOrElement instanceof MediaStream) {\r\n\t\t\t\tthis.sources_[key] = this.context.createMediaStreamSource(streamOrElement.clone());\r\n\t\t\t} else {\r\n\t\t\t\tthis.sources_[key] = this.context.createMediaElementSource(streamOrElement);\r\n\t\t\t}\r\n\t\t\t// this.sources_[key] = streamOrElement instanceof MediaStream ? this.context.createMediaStreamSource(streamOrElement) : this.context.createMediaElementSource(streamOrElement);\r\n\t\t}\r\n\t\treturn this.sources_[key];\r\n\t}\r\n\r\n\tstatic removeSource(streamOrElement) {\r\n\t\tconst key = streamOrElement instanceof MediaStream ? streamOrElement.id : streamOrElement;\r\n\t\treturn this.removeSourceKey(key);\r\n\t}\r\n\r\n\tstatic removeSourceKey(key) {\r\n\t\t// console.log('AudioStreamService.removeSourceKey', key);\r\n\t\tlet source;\r\n\t\tif (this.sources_[key]) {\r\n\t\t\tsource = this.sources_[key];\r\n\t\t\t/*\r\n\t\t\tif (source.mediaStream) {\r\n\t\t\t\tsource.mediaStream.stop();\r\n\t\t\t}\r\n\t\t\tsource.stop();\r\n\t\t\t*/\r\n\t\t\tif (this.analyser) {\r\n\t\t\t\tsource.disconnect(this.analyser);\r\n\t\t\t}\r\n\t\t\tsource.disconnect();\r\n\t\t\tdelete this.sources_[key];\r\n\t\t}\r\n\t\treturn source;\r\n\t}\r\n\r\n\tstatic frequency$(streamOrElement, fftSize = 64) {\r\n\t\tif (fftSize % 2 === 1) {\r\n\t\t\tthrow ('AudioStreamService.error', 'wrong fftSize', fftSize);\r\n\t\t}\r\n\t\tconst state = new Uint8Array(fftSize / 2);\r\n\t\tconst context = this.context;\r\n\t\tif (context) {\r\n\t\t\tconst analyser = this.analyser;\r\n\t\t\tif (analyser) {\r\n\t\t\t\t// Connect the output of the analyser to the destination\r\n\t\t\t\t// analyser.connect(context.destination); // no audio !\r\n\t\t\t\t// console.log(analyser.fftSize); // 2048 by default\r\n\t\t\t\t// console.log(analyser.frequencyBinCount); // will give us 1024 data points\r\n\t\t\t\tanalyser.fftSize = fftSize; // 64\r\n\t\t\t\t// console.log(analyser.frequencyBinCount); // fftSize/2 = 32 data points\r\n\t\t\t\tconst source = this.addSource(streamOrElement);\r\n\t\t\t\t// source.connect(context.destination); // no audio!\r\n\t\t\t\t// Connect the output of the source to the input of the analyser\r\n\t\t\t\tsource.connect(analyser);\r\n\t\t\t}\r\n\t\t\tconst state$ = new BehaviorSubject(state);\r\n\t\t\treturn AudioStreamService.frame$.pipe(\r\n\t\t\t\twithLatestFrom(state$),\r\n\t\t\t\tmap(([deltaTime, state]) => {\r\n\t\t\t\t\tif (analyser) {\r\n\t\t\t\t\t\t// Get the new frequency data\r\n\t\t\t\t\t\tanalyser.getByteFrequencyData(state);\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tconst max = state.reduce((p, c, i) => {\r\n\t\t\t\t\t\t\treturn Math.max(c, p);\r\n\t\t\t\t\t\t}, 0);\r\n\t\t\t\t\t\tif (max > 0) {\r\n\t\t\t\t\t\t\t// console.log(max);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t// Update the visualisation\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn state;\r\n\t\t\t\t}),\r\n\t\t\t\ttap((state) => state$.next(state)),\r\n\t\t\t\tfinalize(() => {\r\n\t\t\t\t\tthis.removeSource(streamOrElement);\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(state);\r\n\t\t}\r\n\t}\r\n\r\n\t// unused\r\n\tstatic volume$(streamOrElement) {\r\n\t\tconst state = { volume: 0, clipped: false };\r\n\t\tconst context = this.context;\r\n\t\t// console.log('AudioStreamService.volume$', context, state);\r\n\t\tif (context) {\r\n\t\t\tconst source = this.addSource(streamOrElement);\r\n\t\t\tconst meter = AudioStreamService.audioMeterCreate();\r\n\t\t\tsource.connect(meter);\r\n\t\t\tconst state$ = new BehaviorSubject(state);\r\n\t\t\treturn AudioStreamService.frame$.pipe(\r\n\t\t\t\twithLatestFrom(state$),\r\n\t\t\t\tmap(([deltaTime, state]) => {\r\n\t\t\t\t\tstate.clipped = meter.checkClipping();\r\n\t\t\t\t\tstate.volume = meter.volume;\r\n\t\t\t\t\treturn state;\r\n\t\t\t\t}),\r\n\t\t\t\ttap((state) => state$.next(state)),\r\n\t\t\t\tfinalize(() => {\r\n\t\t\t\t\tthis.removeSource(streamOrElement);\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(state);\r\n\t\t}\r\n\t}\r\n\r\n\t// unused\r\n\tstatic audioMeterCreate(clipLevel = 0.98, averaging = 0.95, clipLag = 750) {\r\n\t\tconst context = this.context;\r\n\t\tif (context) {\r\n\t\t\tconst processor = context.createScriptProcessor(512);\r\n\t\t\tprocessor.onaudioprocess = this.audioMeterProcess;\r\n\t\t\tprocessor.checkClipping = this.audioMeterClip;\r\n\t\t\tprocessor.dispose = this.audioMeterDispose;\r\n\t\t\tprocessor.clipping = false;\r\n\t\t\tprocessor.lastClip = 0;\r\n\t\t\tprocessor.volume = 0;\r\n\t\t\tprocessor.clipLevel = clipLevel;\r\n\t\t\tprocessor.averaging = averaging;\r\n\t\t\tprocessor.clipLag = clipLag;\r\n\t\t\t// this will have no effect, since we don't copy the input to the output,\r\n\t\t\t// but works around a current Chrome bug.\r\n\t\t\tprocessor.connect(context.destination);\r\n\t\t\treturn processor;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic audioMeterProcess(event) {\r\n\t\tconst buffer = event.inputBuffer.getChannelData(0);\r\n\t\tconst bufferLength = buffer.length;\r\n\t\tlet sum = 0;\r\n\t\tlet x;\r\n\r\n\t\t// Do a root-mean-square on the samples: sum up the squares...\r\n\t\tfor (let i = 0; i < bufferLength; i++) {\r\n\t\t\tx = buffer[i];\r\n\t\t\tif (Math.abs(x) >= this.clipLevel) {\r\n\t\t\t\tthis.clipping = true;\r\n\t\t\t\tthis.lastClip = window.performance.now();\r\n\t\t\t}\r\n\t\t\tsum += x * x;\r\n\t\t}\r\n\r\n\t\t// ... then take the square root of the sum.\r\n\t\tconst rms = Math.sqrt(sum / bufferLength);\r\n\r\n\t\t// Now smooth this out with the averaging factor applied\r\n\t\t// to the previous sample - take the max here because we\r\n\t\t// want \"fast attack, slow release.\"\r\n\t\tthis.volume = Math.max(rms, this.volume * this.averaging);\r\n\t}\r\n\r\n\tstatic audioMeterClip() {\r\n\t\tif (!this.clipping) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tif ((this.lastClip + this.clipLag) < window.performance.now()) {\r\n\t\t\tthis.clipping = false;\r\n\t\t}\r\n\t\treturn this.clipping;\r\n\t}\r\n\r\n\tstatic audioMeterDispose() {\r\n\t\tthis.disconnect();\r\n\t\tthis.onaudioprocess = null;\r\n\t}\r\n\r\n\tstatic step$(previous) {\r\n\t\t/**\r\n\t\t * This function returns an observable that will emit the next frame once the\r\n\t\t * browser has returned an animation frame step. Given the previous frame it calculates\r\n\t\t * the delta time, and we also clamp it to 30FPS in case we get long frames.\r\n\t\t */\r\n\t\treturn Observable.create((observer) => {\r\n\t\t\trequestAnimationFrame((startTime) => {\r\n\t\t\t\t// Millis to seconds\r\n\t\t\t\tconst deltaTime = previous ? (startTime - previous.startTime) / 1000 : 0;\r\n\t\t\t\tobserver.next({\r\n\t\t\t\t\tstartTime,\r\n\t\t\t\t\tdeltaTime\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}).pipe(\r\n\t\t\tmap(frame => {\r\n\t\t\t\tif (frame.deltaTime > (1 / 30)) {\r\n\t\t\t\t\tframe.deltaTime = 1 / 30;\r\n\t\t\t\t}\r\n\t\t\t\treturn frame;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic dispose() {\r\n\t\tObject.keys(this.sources_).forEach(key => {\r\n\t\t\tthis.removeSourceKey(key);\r\n\t\t});\r\n\t\tconst analyser = this.analyser;\r\n\t\tif (analyser) {\r\n\t\t\tanalyser.disconnect();\r\n\t\t}\r\n\t\tthis.sources_ = {};\r\n\t\t// this.context_.close().then(() => console.log('AudioStreamService.dispose'));\r\n\t\t// this.context_ = null;\r\n\t}\r\n\r\n}\r\n\r\nAudioStreamService.sources_ = {};\r\nAudioStreamService.frame$ = of(undefined).pipe(\r\n\texpand((value) => AudioStreamService.step$(value)),\r\n\t// Expand emits the first value provided to it, and in this\r\n\t//  case we just want to ignore the undefined input frame\r\n\tfilter(frame => frame !== undefined),\r\n\tmap(frame => frame.deltaTime),\r\n\tshare()\r\n);\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport AudioStreamService from '../audio/audio-stream.service';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport StateService from '../state/state.service';\r\nimport { getStreamQuality } from './agora.types';\r\n\r\nexport default class AgoraDevicePreviewComponent extends Component {\r\n\r\n\tget video() {\r\n\t\treturn this.video_;\r\n\t}\r\n\r\n\tset video(video) {\r\n\t\tif (this.video_ !== video) {\r\n\t\t\tthis.video_ = video;\r\n\t\t\tif (this.change) {\r\n\t\t\t\tthis.change.next();\r\n\t\t\t\tthis.init();\r\n\t\t\t\tthis.initStream();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget audio() {\r\n\t\treturn this.audio_;\r\n\t}\r\n\r\n\tset audio(audio) {\r\n\t\tif (this.audio_ !== audio) {\r\n\t\t\tthis.audio_ = audio;\r\n\t\t\tif (this.change) {\r\n\t\t\t\tthis.change.next();\r\n\t\t\t\tthis.init();\r\n\t\t\t\tthis.initStream();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget hasPreview() {\r\n\t\treturn this.platform !== DevicePlatform.IOS && this.platform !== DevicePlatform.VRHeadset;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.init();\r\n\t}\r\n\r\n\tinit() {\r\n\t\tif (this.initialized_) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.initialized_ = true;\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.onLoadedMetadata = this.onLoadedMetadata.bind(this);\r\n\t\tconst preview = this.preview = node.querySelector('video');\r\n\t\tpreview.addEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\tconst audio = node.querySelector('.audio');\r\n\t\tif (this.hasPreview) {\r\n\t\t\tconst bars = this.bars = new Array(32).fill(0).map(x => {\r\n\t\t\t\tconst bar = document.createElement('div');\r\n\t\t\t\tbar.classList.add('bar');\r\n\t\t\t\taudio.appendChild(bar);\r\n\t\t\t\treturn bar;\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tconst preview = this.preview;\r\n\t\tpreview.removeEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\tif (this.hasPreview) {\r\n\t\t\tAudioStreamService.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\tinitStream() {\r\n\t\tconst preview = this.preview;\r\n\t\tif (!this.preview) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// console.log(this.video_, this.audio_);\r\n\t\tif (this.video_ || this.audio_) {\r\n\t\t\t// const { node } = getContext(this);\r\n\t\t\t// node.classList.remove('ready');\r\n\t\t\tif (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {\r\n\t\t\t\tconst state = StateService.state;\r\n\t\t\t\tconst quality = getStreamQuality(state);\r\n\t\t\t\tconst options = {\r\n\t\t\t\t\tvideo: this.video_ ? {\r\n\t\t\t\t\t\tdeviceId: this.video_,\r\n\t\t\t\t\t\twidth: { ideal: quality.resolution.width },\r\n\t\t\t\t\t\theight: { ideal: quality.resolution.height },\r\n\t\t\t\t\t\tframeRate: { ideal: quality.frameRate.min, max: quality.frameRate.max },\r\n\t\t\t\t\t} : false,\r\n\t\t\t\t\taudio: this.audio_ ? { deviceId: this.audio_ } : false,\r\n\t\t\t\t};\r\n\t\t\t\t// console.log('AgoraDevicePreviewComponent.initStream.getUserMedia', options);\r\n\t\t\t\tnavigator.mediaDevices.getUserMedia(options).then((stream) => {\r\n\t\t\t\t\tif (this.hasPreview) {\r\n\t\t\t\t\t\tif ('srcObject' in preview) {\r\n\t\t\t\t\t\t\tpreview.srcObject = stream;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tpreview.src = window.URL.createObjectURL(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this.audio_) {\r\n\t\t\t\t\t\t\tthis.analyzeData(stream);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.loadingStream_ = stream;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.stream.next(stream);\r\n\t\t\t\t\t}\r\n\t\t\t\t}).catch((error) => {\r\n\t\t\t\t\tconsole.log('AgoraDevicePreviewComponent.initStream.error', error.name, error.message);\r\n\t\t\t\t\tthis.stream.next(null);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (this.hasPreview) {\r\n\t\t\t\tif ('srcObject' in preview) {\r\n\t\t\t\t\tpreview.srcObject = null;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tpreview.src = null;\r\n\t\t\t\t}\r\n\t\t\t\tthis.analyzeData(null);\r\n\t\t\t}\r\n\t\t\tthis.stream.next(null);\r\n\t\t}\r\n\t}\r\n\r\n\tonLoadedMetadata(event) {\r\n\t\t// console.log('AgoraDevicePreview.onLoadedMetadata', event);\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('ready');\r\n\t\tthis.preview.play();\r\n\t\tthis.stream.next(this.loadingStream_);\r\n\t}\r\n\r\n\tanalyzeData(stream) {\r\n\t\tif (this.frequencySubscription) {\r\n\t\t\tthis.frequencySubscription.unsubscribe();\r\n\t\t}\r\n\t\t// console.log('AgoraDevicePreviewComponent.analyzeData', stream);\r\n\t\tif (stream) {\r\n\t\t\tthis.frequencySubscription = AudioStreamService.frequency$(stream, 64).pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(frequency => {\r\n\t\t\t\t// 32 data points\r\n\t\t\t\t// console.log(frequency);\r\n\t\t\t\tconst spacing = 100 / 32;\r\n\t\t\t\tconst bars = this.bars;\r\n\t\t\t\tbars.forEach((bar, i) => {\r\n\t\t\t\t\tconst pow = Math.min(100, (5 + frequency[i])) / 100;\r\n\t\t\t\t\tbar.style.left = i * spacing + '%';\r\n\t\t\t\t\tbar.style.transform = `scale(1,${pow})`;\r\n\t\t\t\t\tbar.style.opacity = pow;\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nAgoraDevicePreviewComponent.meta = {\r\n\tselector: '[agora-device-preview]',\r\n\toutputs: ['stream', 'change'],\r\n\tinputs: ['video', 'audio']\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport StateService from '../state/state.service';\r\nimport AgoraService from './agora.service';\r\n\r\nexport default class AgoraDeviceComponent extends Component {\r\n\r\n\tget hasPreview() {\r\n\t\treturn this.platform !== DevicePlatform.IOS && this.platform !== DevicePlatform.VRHeadset; // && this.form && this.form.value.video;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.isHttps = window.location.protocol === 'https:';\r\n\t\tthis.state = {};\r\n\t\tthis.devices = { videos: [], audios: [] };\r\n\t\tthis.stream = null;\r\n\t\tthis.form = null;\r\n\t\tif (this.isHttps) {\r\n\t\t\tconst agora = this.agora = AgoraService.getSingleton();\r\n\t\t\tStateService.state$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(state => {\r\n\t\t\t\t// console.log('AgoraDeviceComponent.state', state);\r\n\t\t\t\tthis.state = state;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t\tif (agora) {\r\n\t\t\t\tagora.devices$().subscribe(devices => {\r\n\t\t\t\t\t// console.log(devices);\r\n\t\t\t\t\tthis.devices = devices;\r\n\t\t\t\t\tthis.initForm(devices);\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\topenHttps(event) {\r\n\t\twindow.location.href = window.location.href.replace('http://', 'https://').replace(':5000', ':6443');\r\n\t}\r\n\r\n\tinitForm(devices) {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tvideo: new FormControl(null, devices.videos.length ? Validators.RequiredValidator() : undefined),\r\n\t\t\taudio: new FormControl(null, devices.audios.length ? Validators.RequiredValidator() : undefined),\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tconst videoOptions = devices.videos.map(x => {\r\n\t\t\treturn {\r\n\t\t\t\tid: x.deviceId,\r\n\t\t\t\tname: x.label,\r\n\t\t\t};\r\n\t\t});\r\n\t\tif (videoOptions.length > 0) {\r\n\t\t\tvideoOptions.unshift({\r\n\t\t\t\tid: null, name: LabelPipe.transform('bhere_select_video')\r\n\t\t\t});\r\n\t\t}\r\n\t\tcontrols.video.options = videoOptions;\r\n\t\tconst audioOptions = devices.audios.map(x => {\r\n\t\t\treturn {\r\n\t\t\t\tid: x.deviceId,\r\n\t\t\t\tname: x.label,\r\n\t\t\t};\r\n\t\t});\r\n\t\tif (audioOptions.length > 0) {\r\n\t\t\taudioOptions.unshift({\r\n\t\t\t\tid: null, name: LabelPipe.transform('bhere_select_audio')\r\n\t\t\t});\r\n\t\t}\r\n\t\tcontrols.audio.options = audioOptions;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraDeviceComponent.changes$', form.value);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonStreamDidChange(event) {\r\n\t\tthis.stream = null;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonStream(stream) {\r\n\t\tthis.stream = stream;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid && (this.stream || !this.hasPreview);\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonEnter(event) {\r\n\t\tconst preferences = this.form.value;\r\n\t\tconst devices = this.devices;\r\n\t\tdevices.video = devices.videos.find(x => x.deviceId === preferences.video);\r\n\t\tdevices.audio = devices.audios.find(x => x.deviceId === preferences.audio);\r\n\t\tthis.enter.next(devices);\r\n\t}\r\n\r\n}\r\n\r\nAgoraDeviceComponent.meta = {\r\n\tselector: '[agora-device]',\r\n\toutputs: ['enter'],\r\n};\r\n","import { Component } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\n\r\nexport default class AgoraLinkComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.state = {};\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tlink: new FormControl(null, [Validators.PatternValidator(/^\\d{9}-\\d{4}-\\d{13}$/), Validators.RequiredValidator()]),\r\n\t\t\tlinkAttendee: null,\r\n\t\t\tlinkStreamer: null,\r\n\t\t\tlinkViewer: null,\r\n\t\t\tlinkSmartDevice: null,\r\n\t\t\t// link: new FormControl(null),\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraLinkComponent.changes$', form.value);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraLinkComponent.state', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonGenerateMeetingId($event) {\r\n\t\t// const timestamp = (performance.now() * 10000000000000).toString();\r\n\t\tconst timestamp = new Date().valueOf().toString();\r\n\t\tthis.form.patch({\r\n\t\t\tlink: this.getRoleMeetingId(timestamp, RoleType.Publisher),\r\n\t\t\tlinkAttendee: this.getRoleMeetingId(timestamp, RoleType.Attendee),\r\n\t\t\tlinkStreamer: this.getRoleMeetingId(timestamp, RoleType.Streamer),\r\n\t\t\tlinkViewer: this.getRoleMeetingId(timestamp, RoleType.Viewer),\r\n\t\t\tlinkSmartDevice: this.getRoleMeetingId(timestamp, RoleType.SmartDevice),\r\n\t\t});\r\n\t}\r\n\r\n\treplaceRoleMeetingId(meetingId, role) {\r\n\t\tconst components = meetingId.split('-');\r\n\t\tcomponents[1] = this.padded(this.getRoleIndex(role), 4);\r\n\t\treturn components.join('-');\r\n\t}\r\n\r\n\tonInputDidChange($event) {\r\n\t\t// console.log('onInputDidChange', this.form.get('link').value, this.form.get('link').valid);\r\n\t\tif (this.state.role !== 'publisher') {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tsetTimeout(() => {\r\n\t\t\tif (this.form.get('link').valid) {\r\n\t\t\t\tconst value = this.form.get('link').value;\r\n\t\t\t\tthis.form.patch({\r\n\t\t\t\t\tlink: this.setRoleMeetingId(value, RoleType.Publisher),\r\n\t\t\t\t\tlinkAttendee: this.setRoleMeetingId(value, RoleType.Attendee),\r\n\t\t\t\t\tlinkStreamer: this.setRoleMeetingId(value, RoleType.Streamer),\r\n\t\t\t\t\tlinkViewer: this.setRoleMeetingId(value, RoleType.Viewer),\r\n\t\t\t\t\tlinkSmartDevice: this.setRoleMeetingId(value, RoleType.SmartDevice),\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tthis.form.get('linkAttendee').reset();\r\n\t\t\t\tthis.form.get('linkStreamer').reset();\r\n\t\t\t\tthis.form.get('linkViewer').reset();\r\n\t\t\t}\r\n\t\t}, 1);\r\n\t}\r\n\r\n\tsetRoleMeetingId(meetingId, role) {\r\n\t\tconst meetingIdSegments = meetingId.split('-');\r\n\t\treturn `${meetingIdSegments[0]}-${this.padded(this.getRoleIndex(role), 4)}-${meetingIdSegments[2]}`;\r\n\t}\r\n\r\n\tgetRoleMeetingId(timestamp, role) {\r\n\t\treturn `${this.padded(this.state.user.id, 9)}-${this.padded(this.getRoleIndex(role), 4)}-${timestamp}`;\r\n\t}\r\n\r\n\tgetRoleIndex(role) {\r\n\t\treturn Object.keys(RoleType).reduce((p, c, i) => {\r\n\t\t\treturn RoleType[c] === role ? i : p;\r\n\t\t}, -1);\r\n\t}\r\n\r\n\tonCopyToClipBoard(meetingId, asAccessCode = false) {\r\n\t\tconst input = document.createElement('input');\r\n\t\tinput.style.position = 'absolute';\r\n\t\tinput.style.top = '1000vh';\r\n\t\t// input.style.visibility = 'hidden';\r\n\t\tdocument.querySelector('body').appendChild(input);\r\n\t\tinput.value = asAccessCode ? this.getAccessCodeUrl(meetingId, true) : this.getUrl(meetingId, true);\r\n\t\tinput.focus();\r\n\t\tinput.select();\r\n\t\tinput.setSelectionRange(0, 99999);\r\n\t\tdocument.execCommand('copy');\r\n\t\tinput.parentNode.removeChild(input);\r\n\t\talert(`link copiato!\\n ${input.value}`);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonNext(event) {\r\n\t\tlet meetingId = this.controls.link.value;\r\n\t\t/*\r\n\t\tif (this.state.role === RoleType.Publisher) {\r\n\t\t\tmeetingId = this.replaceRoleMeetingId(meetingId, RoleType.Publisher);\r\n\t\t}\r\n\t\t*/\r\n\t\tthis.replaceUrl(meetingId);\r\n\t\tthis.link.next(meetingId);\r\n\t}\r\n\r\n\tgetUrl(meetingId, shareable = false) {\r\n\t\tconst role = LocationService.get('role') || null;\r\n\t\tconst name = LocationService.get('name') || null;\r\n\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${meetingId}` + (name ? `&name=${name}` : '') + ((role && !shareable) ? `&role=${role}` : '');\r\n\t\treturn url;\r\n\t}\r\n\r\n\tgetAccessCodeUrl(meetingId, shareable = false) {\r\n\t\tconst role = LocationService.get('role') || null;\r\n\t\tconst name = LocationService.get('name') || null;\r\n\t\tconst url = `${window.location.origin}${environment.url.accessCode}?link=${meetingId}` + (name ? `&name=${name}` : '') + ((role && !shareable) ? `&role=${role}` : '');\r\n\t\treturn url;\r\n\t}\r\n\r\n\treplaceUrl(meetingId) {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst url = this.getUrl(meetingId);\r\n\t\t\t// console.log('AgoraLinkComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n\r\n\tpadded(num, size) {\r\n\t\tconst s = '000000000' + num;\r\n\t\treturn s.substr(s.length - size);\r\n\t}\r\n}\r\n\r\nAgoraLinkComponent.meta = {\r\n\tselector: '[agora-link]',\r\n\toutputs: ['link'],\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { UserService } from '../user/user.service';\r\n\r\nexport default class AgoraLoginComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tusername: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tpassword: new FormControl(null, Validators.RequiredValidator()),\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: '',\r\n\t\t});\r\n\r\n\t\tconst controls = this.controls = form.controls;\r\n\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\r\n\t\tthis.error = null;\r\n\t}\r\n\r\n\ttest() {\r\n\t\tthis.form.patch({\r\n\t\t\tusername: 'publisher',\r\n\t\t\tpassword: 'publisher',\r\n\t\t\tcheckRequest: window.antiforgery || '',\r\n\t\t\tcheckField: ''\r\n\t\t});\r\n\t}\r\n\r\n\treset() {\r\n\t\tthis.form.reset();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst payload = this.form.value;\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tthis.error = null;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tUserService.login$(payload).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(user => {\r\n\t\t\t\tif (StateService.state.role === user.type) {\r\n\t\t\t\t\t// this.login.next(user);\r\n\t\t\t\t\tthis.onNext(user);\r\n\t\t\t\t\tthis.form.reset();\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.error = { friendlyMessage: LabelPipe.transform('error_credentials') };\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('AccessComponent.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonNext(user) {\r\n\t\tthis.replaceUrl(user);\r\n\t\tthis.login.next(user);\r\n\t}\r\n\r\n\treplaceUrl(user) {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst role = LocationService.get('role') || null;\r\n\t\t\tconst link = LocationService.get('link') || null;\r\n\t\t\tconst name = LocationService.get('name') || (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null);\r\n\t\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${link}`\r\n\t\t\t\t+ (name ? `&name=${name}` : '')\r\n\t\t\t\t+ (role ? `&role=${role}` : '');\r\n\t\t\t// console.log('AgoraLoginComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nAgoraLoginComponent.meta = {\r\n\tselector: '[agora-login]',\r\n\toutputs: ['login'],\r\n};\r\n","import { Component } from 'rxcomp';\r\n// import { UserService } from './user/user.service';\r\nimport { FormControl, FormGroup, Validators } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\n\r\nexport default class AgoraNameComponent extends Component {\r\n\tonInit() {\r\n\t\tconst name = LocationService.get('name') || null;\r\n\t\tthis.state = {};\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tname: new FormControl(name, [Validators.PatternValidator(/^\\w{2,}\\s\\w{2,}/), Validators.RequiredValidator()]),\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('AgoraNameComponent.changes$', form.value);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\t// console.log('AgoraNameComponent.state', state);\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonNext(event) {\r\n\t\tthis.replaceUrl();\r\n\t\tthis.name.next(this.controls.name.value);\r\n\t}\r\n\r\n\treplaceUrl() {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst role = LocationService.get('role') || null;\r\n\t\t\tconst link = LocationService.get('link') || null;\r\n\t\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${link}&name=${this.controls.name.value}` + (role ? `&role=${role}` : '');\r\n\t\t\t// console.log('AgoraNameComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nAgoraNameComponent.meta = {\r\n\tselector: '[agora-name]',\r\n\toutputs: ['name'],\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport MessageService from '../message/message.service';\r\nimport StateService from '../state/state.service';\r\nimport { AgoraMuteAudioEvent, AgoraMuteVideoEvent, AgoraUnmuteAudioEvent, AgoraUnmuteVideoEvent, MessageType } from './agora.types';\r\n\r\nexport default class AgoraStreamComponent extends Component {\r\n\r\n\tset videoMuted(videoMuted) {\r\n\t\tif (this.videoMuted_ !== videoMuted) {\r\n\t\t\tthis.videoMuted_ = videoMuted;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tvideoMuted ? node.classList.add('video--muted') : node.classList.remove('video--muted');\r\n\t\t}\r\n\t}\r\n\r\n\tset audioMuted(audioMuted) {\r\n\t\tif (this.audioMuted_ !== audioMuted) {\r\n\t\t\tthis.audioMuted_ = audioMuted;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\taudioMuted ? node.classList.add('audio--muted') : node.classList.remove('audio--muted');\r\n\t\t}\r\n\t}\r\n\r\n\tget streamId() {\r\n\t\treturn this.streamId_;\r\n\t}\r\n\r\n\tset streamId(streamId) {\r\n\t\tthis.streamId_ = streamId;\r\n\t}\r\n\r\n\tget stream() {\r\n\t\treturn this.stream_;\r\n\t}\r\n\r\n\tset stream(stream) {\r\n\t\tif (this.stream_ !== stream) {\r\n\t\t\t// console.log('AgoraStreamComponent set stream', stream);\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst player = this.player = node.querySelector('.agora-stream__player');\r\n\t\t\twhile (player.childElementCount > 0) {\r\n\t\t\t\tplayer.removeChild(player.firstElementChild);\r\n\t\t\t}\r\n\t\t\t// player.textContent = '';\r\n\t\t\tif (this.stream_ && this.stream_.isPlaying() && this.stream_.player.div.parentNode === player) {\r\n\t\t\t\t// console.log('AgoraStreamComponent stopping stream', this.stream_.getId(), 'on', this.stream_.player.div.parentNode);\r\n\t\t\t\tthis.stream_.stop();\r\n\t\t\t}\r\n\t\t\tthis.stream_ = stream;\r\n\t\t\tif (stream) {\r\n\t\t\t\tthis.videoMuted = stream.userMuteVideo;\r\n\t\t\t\tthis.audioMuted = stream.userMuteAudio;\r\n\t\t\t}\r\n\t\t\tconst streamId = stream ? stream.getId() : null;\r\n\t\t\tthis.streamId = streamId;\r\n\t\t\t// console.log('AgoraStreamComponent streamId', streamId);\r\n\t\t\tif (streamId) {\r\n\t\t\t\tconst name = `stream-${streamId}`;\r\n\t\t\t\tplayer.setAttribute('id', name);\r\n\t\t\t\tconst self = this;\r\n\t\t\t\tif (stream.isPlaying()) {\r\n\t\t\t\t\tplayer.appendChild(stream.player.div);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.shouldUseResumeGesture = false;\r\n\t\t\t\t\tstream.play(name, { fit: 'cover' }, (error) => {\r\n\t\t\t\t\t\tif (error && error.status !== 'aborted') {\r\n\t\t\t\t\t\t\t// The playback fails, probably due to browser policy. You can resume the playback by user gesture.\r\n\t\t\t\t\t\t\tself.shouldUseResumeGesture = true;\r\n\t\t\t\t\t\t\tself.pushChanges();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tplayer.removeAttribute('id');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tset vrContainer(vrContainer) {\r\n\t\tif (this.vrContainer_ !== vrContainer) {\r\n\t\t\tthis.vrContainer_ = vrContainer;\r\n\t\t\tif (vrContainer) {\r\n\t\t\t\tthis.stream_.vrContainer = vrContainer;\r\n\t\t\t\tthis.player.appendChild(vrContainer);\r\n\t\t\t} else if (this.stream_.vrContainer && this.stream_.vrContainer.parentNode) {\r\n\t\t\t\tthis.stream_.vrContainer.parentNode.removeChild(this.stream_.vrContainer);\r\n\t\t\t\tthis.stream_.vrContainer = null;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget videoNode() {\r\n\t\tlet videoNode = this.videoNode_;\r\n\t\tif (!videoNode) {\r\n\t\t\tconst player = getContext(this).node.querySelector('.agora-stream__player');\r\n\t\t\tvideoNode = document.createElement('video');\r\n\t\t\tthis.onLoadedMetadata = this.onLoadedMetadata.bind(this);\r\n\t\t\tvideoNode.addEventListener('loadedmetadata', this.onLoadedMetadata);\r\n\t\t\tplayer.appendChild(videoNode);\r\n\t\t\tthis.videoNode_ = videoNode;\r\n\t\t}\r\n\t\treturn videoNode;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.videoMuted = false;\r\n\t\tthis.audioMuted = false;\r\n\t\tthis.shouldUseResumeGesture = false;\r\n\t\tthis.state = {};\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// console.log('AgoraStreamComponent.StateService.state$', this.streamId, state);\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// console.log('AgoraStreamComponent.MessageService.out$', this.streamId, message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.AgoraEvent:\r\n\t\t\t\t\tconst event = message.event;\r\n\t\t\t\t\t// console.log('AgoraStreamComponent.AgoraEvent', message.event);\r\n\t\t\t\t\tif (this.streamId && event.streamId === this.streamId) {\r\n\t\t\t\t\t\tif (event instanceof AgoraMuteVideoEvent) {\r\n\t\t\t\t\t\t\tthis.videoMuted = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (event instanceof AgoraUnmuteVideoEvent) {\r\n\t\t\t\t\t\t\tthis.videoMuted = false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (event instanceof AgoraMuteAudioEvent) {\r\n\t\t\t\t\t\t\tthis.audioMuted = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (event instanceof AgoraUnmuteAudioEvent) {\r\n\t\t\t\t\t\t\tthis.audioMuted = false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VRStarted:\r\n\t\t\t\t\t// console.log('AgoraStreamComponent.VRStarted', this.streamId, message.clientId, message.container);\r\n\t\t\t\t\tif (this.streamId === message.clientId) {\r\n\t\t\t\t\t\tthis.vrContainer = message.container;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VREnded:\r\n\t\t\t\t\t// console.log('AgoraStreamComponent.VREnded', this.streamId, message.clientId);\r\n\t\t\t\t\tif (this.streamId === message.clientId) {\r\n\t\t\t\t\t\tthis.vrContainer = null;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tsetMediaStream(mediaStream) {\r\n\t\tconst videoNode = this.videoNode;\r\n\t\tif ('srcObject' in videoNode) {\r\n\t\t\tvideoNode.srcObject = mediaStream;\r\n\t\t} else {\r\n\t\t\tvideoNode.src = mediaStream ? window.URL.createObjectURL(mediaStream) : null;\r\n\t\t}\r\n\t}\r\n\r\n\tonLoadedMetadata(event) {\r\n\t\t// console.log('AgoraStreamComponent.onLoadedMetadata', event);\r\n\t\tthis.videoNode.play().then(success => {\r\n\t\t\t// console.log('AgoraStreamComponent.play.success', success);\r\n\t\t}, error => {\r\n\t\t\tconsole.log('AgoraStreamComponent.play.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tonToggleSpy($event) {\r\n\t\tthis.toggleSpy.next($event);\r\n\t}\r\n}\r\n\r\nAgoraStreamComponent.meta = {\r\n\tselector: '[agora-stream]',\r\n\toutputs: ['toggleSpy'],\r\n\tinputs: ['stream'],\r\n};\r\n","function push_(event) {\r\n\tconst dataLayer = window.dataLayer || [];\r\n\tdataLayer.push(event);\r\n\tconsole.log('GtmService.dataLayer', event);\r\n}\r\n\r\nexport default class GtmService {\r\n\r\n\tstatic push(event) {\r\n\t\treturn push_(event);\r\n\t}\r\n\r\n}\r\n","import { from, Subject } from 'rxjs';\r\nimport { map, switchMap, tap } from 'rxjs/operators';\r\n\r\nexport class ModalEvent {\r\n\r\n\tconstructor(data) {\r\n\t\tthis.data = data;\r\n\t}\r\n\r\n}\r\n\r\nexport class ModalResolveEvent extends ModalEvent { }\r\nexport class ModalRejectEvent extends ModalEvent { }\r\n\r\nexport default class ModalService {\r\n\r\n\tstatic open$(modal) {\r\n\t\treturn this.getTemplate$(modal.src).pipe(\r\n\t\t\tmap(template => {\r\n\t\t\t\treturn { node: this.getNode(template), data: modal.data, modal: modal };\r\n\t\t\t}),\r\n\t\t\ttap(node => this.modal$.next(node)),\r\n\t\t\tswitchMap(node => this.events$),\r\n\t\t)\r\n\t}\r\n\r\n\tstatic load$(modal) {\r\n\r\n\t}\r\n\r\n\tstatic getTemplate$(url) {\r\n\t\treturn from(fetch(url).then(response => {\r\n\t\t\treturn response.text();\r\n\t\t}));\r\n\t}\r\n\r\n\tstatic getNode(template) {\r\n\t\tconst div = document.createElement('div');\r\n\t\tdiv.innerHTML = template;\r\n\t\tconst node = div.firstElementChild;\r\n\t\treturn node;\r\n\t}\r\n\r\n\tstatic reject(data) {\r\n\t\tthis.modal$.next(null);\r\n\t\tthis.events$.next(new ModalRejectEvent(data));\r\n\t}\r\n\r\n\tstatic resolve(data) {\r\n\t\tthis.modal$.next(null);\r\n\t\tthis.events$.next(new ModalResolveEvent(data));\r\n\t}\r\n\r\n}\r\n\r\nModalService.modal$ = new Subject();\r\nModalService.events$ = new Subject();\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport ModalService from './modal.service';\r\n\r\nexport default class ModalOutletComponent extends Component {\r\n\tget modal() {\r\n\t\treturn this.modal_;\r\n\t}\r\n\r\n\tset modal(modal) {\r\n\t\t// console.log('ModalOutletComponent set modal', modal, this);\r\n\t\tconst { module } = getContext(this);\r\n\t\tif (this.modal_ && this.modal_.node) {\r\n\t\t\tmodule.remove(this.modal_.node, this);\r\n\t\t\tthis.modalNode.removeChild(this.modal_.node);\r\n\t\t}\r\n\t\tif (modal && modal.node) {\r\n\t\t\tthis.modal_ = modal;\r\n\t\t\tthis.modalNode.appendChild(modal.node);\r\n\t\t\tconst instances = module.compile(modal.node);\r\n\t\t}\r\n\t\tthis.modal_ = modal;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.modalNode = node.querySelector('.modal-outlet__modal');\r\n\t\tModalService.modal$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(modal => {\r\n\t\t\tthis.modal = modal;\r\n\t\t});\r\n\t}\r\n\r\n\treject(event) {\r\n\t\tModalService.reject();\r\n\t}\r\n}\r\n\r\nModalOutletComponent.meta = {\r\n\tselector: '[modal-outlet]',\r\n\ttemplate: /* html */ `\r\n\t<div class=\"modal-outlet__container\" [class]=\"{ active: modal }\">\r\n\t\t<div class=\"modal-outlet__background\" (click)=\"reject($event)\"></div>\r\n\t\t<div class=\"modal-outlet__modal\"></div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport ModalOutletComponent from '../modal/modal-outlet.component';\r\nimport ModalService from '../modal/modal.service';\r\n\r\nexport default class TryInARModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tconst { parentInstance, node } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tconst data = this.data = parentInstance.modal.data;\r\n\t\t\t// console.log('data', data);\r\n\t\t\tif (data && data.ar) {\r\n\t\t\t\tconst url = TryInARModalComponent.getUrl(data);\r\n\t\t\t\tconst qrcode = new QRious({\r\n\t\t\t\t\telement: node.querySelector('.qrcode'),\r\n\t\t\t\t\tvalue: url,\r\n\t\t\t\t\tsize: 256\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\tstatic getUrl(data) {\r\n\t\tconst url = environment.getAbsoluteUrl(environment.template.tryInAr, { viewId: data.id });\r\n\t\tconsole.log('TryInARModalComponent.getUrl', url);\r\n\t\treturn url;\r\n\t}\r\n\r\n\tstatic openInAR(data) {\r\n\t\tconst url = this.getUrl(data);\r\n\t\twindow.open(url, '_blank');\r\n\t}\r\n\r\n}\r\n\r\nTryInARModalComponent.meta = {\r\n\tselector: '[try-in-ar-modal]'\r\n};\r\n","/* global THREE */\r\n\r\nimport { Subject } from \"rxjs\";\r\n\r\nexport const ViewType = {\r\n\tWaitingRoom: { id: 1, name: 'waiting-room' },\r\n\tPanorama: { id: 2, name: 'panorama' },\r\n\tPanoramaGrid: { id: 3, name: 'panorama-grid' },\r\n\tRoom3d: { id: 4, name: 'room-3d' },\r\n\tModel: { id: 5, name: 'model' },\r\n};\r\n\r\nexport const ViewItemType = {\r\n\tNav: { id: 1, name: 'nav' },\r\n\tPlane: { id: 2, name: 'plane' },\r\n\tCurvedPlane: { id: 3, name: 'curved-plane' },\r\n\tModel: { id: 4, name: 'model' },\r\n\tTexture: { id: 5, name: 'texture' },\r\n};\r\n\r\nexport class View {\r\n\t// 'liked'\r\n\tstatic allowedProps = ['id', 'type', 'name', 'hidden', 'likes', 'asset', 'items', 'orientation', 'zoom', 'ar', 'tiles', 'invertAxes', 'flipAxes'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t\tthis.updateIndices(options.items);\r\n\t\t}\r\n\t\tthis.items = (this.items || []).map(item => mapViewItem(item));\r\n\t\tif (this.tiles) {\r\n\t\t\tthis.tiles = this.tiles.map(tile => mapViewTile(tile));\r\n\t\t}\r\n\t\tthis.originalItems = this.items.slice();\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (View.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'items':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(item => mapViewItem(item).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'tiles':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(tile => mapViewTile(tile).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tpayload[key] = this[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n\r\n\tget shortType() {\r\n\t\treturn this.type ? this.type.split('-').map(x => x.substring(0, 1).toUpperCase()).join('') : '??';\r\n\t}\r\n\r\n\tupdateIndices(items) {\r\n\t\tif (items) {\r\n\t\t\tlet publisherStreamIndex = 0;\r\n\t\t\tlet attendeeStreamIndex = 0;\r\n\t\t\tlet smartDeviceStream = 0;\r\n\t\t\tlet publisherScreenIndex = 0;\r\n\t\t\tlet attendeeScreenIndex = 0;\r\n\t\t\titems.forEach((item, index) => {\r\n\t\t\t\titem.index = index;\r\n\t\t\t\tif (item.asset) {\r\n\t\t\t\t\tswitch(item.asset.file) {\r\n\t\t\t\t\t\tcase 'publisherStream':\r\n\t\t\t\t\t\t\titem.asset.index = publisherStreamIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'nextAttendeeStream':\r\n\t\t\t\t\t\t\titem.asset.index = attendeeStreamIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'smartDeviceStream':\r\n\t\t\t\t\t\t\titem.asset.index = smartDeviceStream++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'publisherScreen':\r\n\t\t\t\t\t\t\titem.asset.index = publisherScreenIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\tcase 'attendeeScreen':\r\n\t\t\t\t\t\t\titem.asset.index = attendeeScreenIndex++;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t/*\r\n\t\t\t\tif (item.asset && item.asset.file === 'publisherStream') {\r\n\t\t\t\t\titem.asset.index = publisherStreamIndex++;\r\n\t\t\t\t}\r\n\t\t\t\tif (item.asset && item.asset.file === 'nextAttendeeStream') {\r\n\t\t\t\t\titem.asset.index = attendeeStreamIndex++;\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class PanoramaView extends View {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nexport class PanoramaGridView extends View {\r\n\r\n\tstatic mapTiles(tiles = [], flipAxes = false, invertAxes = false, folder = '') {\r\n\t\tconst axes = flipAxes ? -1 : 1;\r\n\t\treturn tiles.map((tile, i) => {\r\n\t\t\tconst indices = new THREE.Vector2();\r\n\t\t\ttile = typeof tile === 'string' ? { id: i + 1, asset: { folder: folder, file: tile }, navs: [] } : tile;\r\n\t\t\ttile.asset.file.replace(/_x([-|\\d]+)_y([-|\\d]+)/g, (a, b, c) => {\r\n\t\t\t\tif (invertAxes) {\r\n\t\t\t\t\tindices.y = parseInt(b);\r\n\t\t\t\t\tindices.x = parseInt(c) * axes;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tindices.x = parseInt(b);\r\n\t\t\t\t\tindices.y = parseInt(c) * axes;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\treturn {\r\n\t\t\t\tid: tile.id,\r\n\t\t\t\tasset: tile.asset,\r\n\t\t\t\tnavs: tile.navs || [],\r\n\t\t\t\tindices,\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\r\n\tset index(index) {\r\n\t\tif (this.index_ !== index) {\r\n\t\t\tthis.index_ = index;\r\n\t\t\tthis.tiles.forEach((tile, i) => tile.selected = i === index);\r\n\t\t\tthis.updateCurrentItems();\r\n\t\t\t// console.log('PanoramaGridView.index.set', index, this.items);\r\n\t\t\tthis.index$.next(index);\r\n\t\t}\r\n\t}\r\n\tget index() {\r\n\t\treturn this.index_;\r\n\t}\r\n\r\n\tconstructor(options) {\r\n\t\toptions.tiles = PanoramaGridView.mapTiles(options.tiles, options.flipAxes, options.invertAxes, options.asset ? options.asset.folder : '');\r\n\t\tsuper(options);\r\n\t\t/*\r\n\t\tif (!this.tiles.length) {\r\n\t\t\tthrow new Error('PanoramaGridView.constructor tile list is empty!');\r\n\t\t}\r\n\t\t*/\r\n\t\tthis.index_ = 0;\r\n\t\tthis.index$ = new Subject();\r\n\t\tthis.tiles.forEach((tile, i) => tile.selected = i === 0);\r\n\t\tif (this.tiles.length) {\r\n\t\t\tthis.items = this.originalItems.concat(this.tiles[0].navs);\r\n\t\t\tthis.asset = this.tiles[0].asset;\r\n\t\t}\r\n\t}\r\n\r\n\tupdateCurrentItems() {\r\n\t\tthis.items = this.originalItems.concat(this.tiles[this.index_].navs);\r\n\t}\r\n\r\n\tgetTileIndex(x, y) {\r\n\t\treturn this.tiles.reduce((p, c, i) => {\r\n\t\t\tif (c.indices.x === x && c.indices.y === y) {\r\n\t\t\t\treturn i;\r\n\t\t\t} else {\r\n\t\t\t\treturn p;\r\n\t\t\t}\r\n\t\t}, -1);\r\n\t}\r\n\thasTile(x, y) {\r\n\t\treturn this.getTileIndex(x, y) !== -1;\r\n\t}\r\n\tgetTile(x, y) {\r\n\t\tconst index = this.getTileIndex(x, y);\r\n\t\tif (index !== -1) {\r\n\t\t\tthis.index = index;\r\n\t\t\treturn this.tiles[index];\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class ModelView extends View {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nexport class ViewItem {\r\n\tstatic allowedProps = ['id', 'type', 'title', 'abstract', 'asset', 'link', 'viewId', 'keepOrientation', 'position', 'rotation', 'scale', 'radius', 'height', 'arc'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (ViewItem.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tpayload[key] = this[key];\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (payload.link && (!payload.link.title || !payload.link.href)) {\r\n\t\t\tdelete payload.link;\r\n\t\t}\r\n\t\treturn payload;\r\n\t}\r\n\tget hasPanel() {\r\n\t\treturn this.type.name === ViewItemType.Nav.name && (\r\n\t\t\t(this.title && this.title !== '') ||\r\n\t\t\t(this.abstract && this.abstract !== '') ||\r\n\t\t\tthis.asset ||\r\n\t\t\tthis.link\r\n\t\t);\r\n\t}\r\n}\r\n\r\nexport class NavViewItem extends ViewItem {\r\n\r\n}\r\n\r\nexport class ViewTile {\r\n\tstatic allowedProps = ['id', 'asset', 'navs'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t\tthis.navs = (this.navs || []).map(nav => mapViewItem(nav));\r\n\t\tthis.originalItems = this.navs.slice();\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (ViewTile.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'navs':\r\n\t\t\t\t\t\tpayload[key] = this[key].map(nav => mapViewItem(nav).payload);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tpayload[key] = this[key];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n}\r\n\r\nexport function mapView(view) {\r\n\tswitch (view.type.name) {\r\n\t\tcase ViewType.Panorama.name:\r\n\t\t\tview = new PanoramaView(view);\r\n\t\t\tbreak;\r\n\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\tview = new PanoramaGridView(view);\r\n\t\t\tbreak;\r\n\t\tcase ViewType.Model.name:\r\n\t\t\tview = new ModelView(view);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tview = new View(view);\r\n\t}\r\n\treturn view;\r\n}\r\n\r\nexport function mapViewItem(item) {\r\n\tswitch (item.type.name) {\r\n\t\tcase ViewItemType.Nav.name:\r\n\t\t\titem = new NavViewItem(item);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\titem = new ViewItem(item);\r\n\t}\r\n\treturn item;\r\n}\r\n\r\nexport function mapViewTile(tile) {\r\n\treturn new ViewTile(tile);\r\n}\r\n","import { BehaviorSubject, combineLatest, of } from 'rxjs';\r\nimport { distinctUntilChanged, map, shareReplay, tap } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\nimport HttpService from '../http/http.service';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { mapView } from '../view/view';\r\n\r\nexport default class ViewService {\r\n\r\n\t// action: { viewId:number, keepOrientation:boolean };\r\n\tstatic action$_ = new BehaviorSubject(null);\r\n\tstatic set action(action) {\r\n\t\tthis.action$_.next(action);\r\n\t}\r\n\tstatic get action() {\r\n\t\treturn this.action$_.getValue();\r\n\t}\r\n\r\n\t// static viewId$_ = new BehaviorSubject(null);\r\n\tstatic set viewId(viewId) {\r\n\t\tthis.action$_.next({ viewId, keepOrientation: false });\r\n\t}\r\n\tstatic get viewId() {\r\n\t\tconst action = this.action$_.getValue();\r\n\t\treturn action ? action.viewId : null;\r\n\t}\r\n\r\n\tstatic data$() {\r\n\t\tif (!this.data$_) {\r\n\t\t\tconst dataUrl = environment.flags.production ? '/api/view' : './api/data.json';\r\n\t\t\tthis.data$_ = HttpService.get$(dataUrl).pipe(\r\n\t\t\t\tmap(data => {\r\n\t\t\t\t\tdata.views = data.views.map(view => mapView(view));\r\n\t\t\t\t\treturn data;\r\n\t\t\t\t}),\r\n\t\t\t\t// tap(data => console.log('ViewService.data$', data)),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.data$_;\r\n\t}\r\n\r\n\tstatic view$(data, editor) {\r\n\t\tconst views = editor ? data.views : data.views.filter(x => x.type.name !== 'waiting-room');\r\n\t\tconst initialViewId = LocationService.has('viewId') ? parseInt(LocationService.get('viewId')) : (views.length ? views[0].id : null);\r\n\t\tthis.action$_.next({ viewId: initialViewId });\r\n\t\treturn this.action$_.pipe(\r\n\t\t\tdistinctUntilChanged((a, b) => a.viewId === b.viewId),\r\n\t\t\tmap(action => {\r\n\t\t\t\tconst view = data.views.find(view => view.id === action.viewId);\r\n\t\t\t\tif (view) {\r\n\t\t\t\t\tview.keepOrientation = action.keepOrientation || false;\r\n\t\t\t\t}\r\n\t\t\t\treturn view || this.getWaitingRoom(data);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic hostedView$(data) {\r\n\t\tconst waitingRoom = this.getWaitingRoom(data);\r\n\t\treturn combineLatest([this.view$(data), this.hosted$()]).pipe(\r\n\t\t\tmap(datas => {\r\n\t\t\t\tconst view = datas[0];\r\n\t\t\t\tconst hosted = datas[1];\r\n\t\t\t\treturn hosted ? view : waitingRoom;\r\n\t\t\t}),\r\n\t\t\ttap(view => {\r\n\t\t\t\tif (view.id !== waitingRoom.id) {\r\n\t\t\t\t\tLocationService.set('viewId', view.id);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic editorView$(data) {\r\n\t\tconst waitingRoom = this.getWaitingRoom(data);\r\n\t\treturn this.view$(data, true).pipe(\r\n\t\t\ttap(view => {\r\n\t\t\t\tif (view.id !== waitingRoom.id) {\r\n\t\t\t\t\tLocationService.set('viewId', view.id);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic hosted$() {\r\n\t\treturn StateService.state$.pipe(\r\n\t\t\tmap(state => state.hosted),\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewById$(viewId) {\r\n\t\treturn this.data$().pipe(\r\n\t\t\tmap(data => data.views.find(x => x.id === viewId))\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewLike$(view) {\r\n\t\tif (!view.liked) {\r\n\t\t\tview.liked = true;\r\n\t\t\tif (environment.flags.production) {\r\n\t\t\t\treturn HttpService.get$(`/api/view/${view.id}/like`);\r\n\t\t\t} else {\r\n\t\t\t\tview.likes = view.likes || 0;\r\n\t\t\t\tview.likes++;\r\n\t\t\t\treturn of(view);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic setViewLike$(message) {\r\n\t\treturn this.viewById$(message.viewId).pipe(\r\n\t\t\ttap(view => {\r\n\t\t\t\tif (view) {\r\n\t\t\t\t\tview.likes = message.likes;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getWaitingRoom(data) {\r\n\t\treturn data && data.views.find(x => x.type.name === 'waiting-room') || {\r\n\t\t\tid: 'waiting-room',\r\n\t\t\ttype: { id: 1, name: 'waiting-room' },\r\n\t\t\tname: 'Waiting Room',\r\n\t\t\tlikes: 0,\r\n\t\t\tliked: false,\r\n\t\t\tasset: {\r\n\t\t\t\ttype: { id: 1, name: 'image' },\r\n\t\t\t\tfolder: '/textures/waiting-room/',\r\n\t\t\t\tfile: 'waiting-room.jpg',\r\n\t\t\t},\r\n\t\t\titems: [],\r\n\t\t\torientation: {\r\n\t\t\t\tlatitude: 0,\r\n\t\t\t\tlongitude: 0\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n}\r\n","import { BehaviorSubject, Subject } from \"rxjs\";\r\n\r\nexport const XRStatus = {\r\n\tWaiting: 'waiting',\r\n\tEnabled: 'enabled',\r\n\tEnded: 'ended',\r\n\tStarted: 'started',\r\n\tDisabled: 'disabled',\r\n\tNeedsHttps: 'needs-https',\r\n\tUnavailable: 'unavailable',\r\n};\r\n\r\nexport default class VRService {\r\n\r\n\tstatic getService() {\r\n\t\tif (!this.service_) {\r\n\t\t\tthis.service_ = new VRService();\r\n\t\t}\r\n\t\treturn this.service_;\r\n\t}\r\n\r\n\tget status() {\r\n\t\treturn this.status$.getValue();\r\n\t}\r\n\r\n\tget state() {\r\n\t\treturn this.state$.getValue();\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tif (VRService.service_) {\r\n\t\t\tthrow ('VRService is a singleton class!');\r\n\t\t}\r\n\t\tconst state = this.state_ = {\r\n\t\t\tcamera: {\r\n\t\t\t\tposition: new THREE.Vector3(),\r\n\t\t\t\tquaternion: new THREE.Quaternion(),\r\n\t\t\t\tscale: new THREE.Vector3(),\r\n\t\t\t\tarray: new Array(3 + 4 + 3).fill(0),\r\n\t\t\t}\r\n\t\t};\r\n\t\tthis.onSessionStarted = this.onSessionStarted.bind(this);\r\n\t\tthis.onSessionEnded = this.onSessionEnded.bind(this);\r\n\t\tthis.status$ = new BehaviorSubject(XRStatus.Waiting);\r\n\t\tthis.session$ = new Subject();\r\n\t\tthis.state$ = new BehaviorSubject(state);\r\n\t\tthis.currentSession = null;\r\n\t\tif ('xr' in navigator) {\r\n\t\t\tnavigator.xr.isSessionSupported('immersive-vr').then((supported) => {\r\n\t\t\t\tif (supported) {\r\n\t\t\t\t\tthis.status$.next(XRStatus.Enabled);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.status$.next(XRStatus.Disabled);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tif (window.isSecureContext === false) {\r\n\t\t\t\tthis.status$.next(XRStatus.NeedsHttps);\r\n\t\t\t} else {\r\n\t\t\t\tthis.status$.next(XRStatus.Unavailable);\r\n\t\t\t\t// 'https://immersiveweb.dev/';\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonSessionStarted(session) {\r\n\t\tsession.addEventListener('end', this.onSessionEnded);\r\n\t\tthis.currentSession = session;\r\n\t\tthis.session$.next(session);\r\n\t\tthis.status$.next(XRStatus.Started);\r\n\t}\r\n\r\n\tonSessionEnded( /*event*/) {\r\n\t\tthis.currentSession.removeEventListener('end', this.onSessionEnded);\r\n\t\tthis.currentSession = null;\r\n\t\tthis.session$.next(null);\r\n\t\tthis.status$.next(XRStatus.Ended);\r\n\t}\r\n\r\n\ttoggleVR(event) {\r\n\t\tif (this.currentSession === null) {\r\n\t\t\t// WebXR's requestReferenceSpace only works if the corresponding feature\r\n\t\t\t// was requested at session creation time. For simplicity, just ask for\r\n\t\t\t// the interesting ones as optional features, but be aware that the\r\n\t\t\t// requestReferenceSpace call will fail if it turns out to be unavailable.\r\n\t\t\t// ('local' is always available for immersive sessions and doesn't need to\r\n\t\t\t// be requested separately.)\r\n\t\t\tconst sessionInit = { optionalFeatures: ['local-floor', 'bounded-floor'] };\r\n\t\t\tnavigator.xr.requestSession('immersive-vr', sessionInit).then(this.onSessionStarted);\r\n\t\t} else {\r\n\t\t\tthis.currentSession.end();\r\n\t\t}\r\n\t}\r\n\r\n\tisDisabled() {\r\n\t\tconst status = this.status$.getValue();\r\n\t\tswitch (status) {\r\n\t\t\tcase XRStatus.Waiting:\r\n\t\t\tcase XRStatus.Disabled:\r\n\t\t\tcase XRStatus.NeedsHttps:\r\n\t\t\tcase XRStatus.Unavailable:\r\n\t\t\t\treturn true;\r\n\t\t\tdefault:\r\n\t\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tgetLabel() {\r\n\t\tlet label;\r\n\t\tconst status = this.status$.getValue();\r\n\t\tswitch (status) {\r\n\t\t\tcase XRStatus.Waiting:\r\n\t\t\t\tlabel = 'Waiting VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Enabled:\r\n\t\t\tcase XRStatus.Ended:\r\n\t\t\t\tlabel = 'Enter VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Started:\r\n\t\t\t\tlabel = 'Exit VR';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Disabled:\r\n\t\t\t\tlabel = 'VR Disabled';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.NeedsHttps:\r\n\t\t\t\tlabel = 'VR Needs Https';\r\n\t\t\t\tbreak;\r\n\t\t\tcase XRStatus.Unavailable:\r\n\t\t\t\tlabel = 'VR Unavailable';\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\treturn label;\r\n\t}\r\n\r\n\tupdateState(world) {\r\n\t\tif (this.status === XRStatus.Started) {\r\n\t\t\tconst renderer = world.renderer,\r\n\t\t\t\tscene = world.scene,\r\n\t\t\t\tcamera = world.camera,\r\n\t\t\t\tstate = this.state_;\r\n\t\t\tcamera.matrixWorld.decompose(state.camera.position, state.camera.quaternion, state.camera.scale);\r\n\t\t\tstate.camera.array[0] = state.camera.position.x;\r\n\t\t\tstate.camera.array[1] = state.camera.position.y;\r\n\t\t\tstate.camera.array[2] = state.camera.position.z;\r\n\t\t\tstate.camera.array[3] = state.camera.quaternion.x;\r\n\t\t\tstate.camera.array[4] = state.camera.quaternion.y;\r\n\t\t\tstate.camera.array[5] = state.camera.quaternion.z;\r\n\t\t\tstate.camera.array[6] = state.camera.quaternion.w;\r\n\t\t\tstate.camera.array[7] = state.camera.scale.x;\r\n\t\t\tstate.camera.array[8] = state.camera.scale.y;\r\n\t\t\tstate.camera.array[9] = state.camera.scale.z;\r\n\t\t\tthis.state$.next(state);\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { first, switchMap, takeUntil, tap } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport { DEBUG, environment } from '../environment';\r\nimport GtmService from '../gtm/gtm.service';\r\nimport LocalStorageService from '../local-storage/local-storage.service';\r\nimport LocationService from '../location/location.service';\r\nimport MessageService from '../message/message.service';\r\nimport ModalService from '../modal/modal.service';\r\nimport StateService from '../state/state.service';\r\nimport StreamService from '../stream/stream.service';\r\nimport TryInARModalComponent from '../try-in-ar/try-in-ar-modal.component';\r\nimport { RoleType } from '../user/user';\r\nimport { UserService } from '../user/user.service';\r\nimport { PanoramaGridView } from '../view/view';\r\nimport ViewService from '../view/view.service';\r\nimport VRService from '../world/vr.service';\r\nimport AgoraService from './agora.service';\r\nimport { AgoraStatus, MessageType } from './agora.types';\r\n\r\nexport default class AgoraComponent extends Component {\r\n\r\n\tget uiClass() {\r\n\t\tconst uiClass = {};\r\n\t\tuiClass[this.state.role] = true;\r\n\t\tuiClass.chat = this.state.chat;\r\n\t\treturn uiClass;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t\tthis.env = environment;\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.state = {};\r\n\t\tthis.hosted = null;\r\n\t\tthis.data = null;\r\n\t\tthis.views = null;\r\n\t\tthis.view = null;\r\n\t\tthis.form = null;\r\n\t\tthis.local = null;\r\n\t\tthis.screen = null;\r\n\t\tthis.remotes = [];\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.status$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(status => this.pushChanges());\r\n\t\tthis.resolveUser();\r\n\t}\r\n\r\n\tgetLinkRole() {\r\n\t\tlet linkRole = null;\r\n\t\tconst match = (LocationService.get('link') || '').match(/\\d{9}-(\\d{4})-\\d{13}/);\r\n\t\tif (match) {\r\n\t\t\tconst index = parseInt(match[1]);\r\n\t\t\tlinkRole = Object.keys(RoleType).reduce((p, c, i) => {\r\n\t\t\t\treturn i === index ? RoleType[c] : p;\r\n\t\t\t}, null)\r\n\t\t}\r\n\t\treturn linkRole;\r\n\t}\r\n\r\n\tresolveUser() {\r\n\t\tUserService.me$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(user => {\r\n\t\t\tthis.initWithUser(user);\r\n\t\t\t// this.userGuard(user);\r\n\t\t});\r\n\t}\r\n\r\n\tuserGuard(user) {\r\n\t\tconst linkRole = this.getLinkRole();\r\n\t\tif (user && (!linkRole || user.type === linkRole)) {\r\n\t\t\tthis.initWithUser(user);\r\n\t\t} else {\r\n\t\t\tthis.initWithUser({ type: linkRole });\r\n\t\t}\r\n\t}\r\n\r\n\tuserGuardRedirect(user) {\r\n\t\tconst linkRole = this.getLinkRole();\r\n\t\tif (user && (!linkRole || linkRole === user.type)) {\r\n\t\t\tthis.initWithUser(user);\r\n\t\t} else if (linkRole === RoleType.Publisher || linkRole === RoleType.Attendee) {\r\n\t\t\twindow.location.href = environment.url.access;\r\n\t\t} else {\r\n\t\t\tthis.initWithUser({ type: linkRole });\r\n\t\t}\r\n\t}\r\n\r\n\tsetNextStatus() {\r\n\t\tlet status = AgoraStatus.Idle;\r\n\t\tconst state = StateService.state;\r\n\t\tif (state.role === RoleType.SmartDevice) {\r\n\t\t\tstate.name = state.name || 'Smart Device';\r\n\t\t}\r\n\t\tif (!state.checklist) {\r\n\t\t\tstatus = AgoraStatus.Checklist;\r\n\t\t} else if (!state.link) {\r\n\t\t\tstatus = AgoraStatus.Link;\r\n\t\t} else if (!state.user.id && (state.role === RoleType.Publisher || state.role === RoleType.Attendee)) {\r\n\t\t\tstatus = AgoraStatus.Login;\r\n\t\t} else if (!state.name) {\r\n\t\t\tstatus = AgoraStatus.Name;\r\n\t\t} else if (state.role !== RoleType.Viewer && state.role !== RoleType.SmartDevice) {\r\n\t\t\tstatus = AgoraStatus.Device;\r\n\t\t} else {\r\n\t\t\tstatus = AgoraStatus.ShouldConnect;\r\n\t\t}\r\n\t\tStateService.patchState({ status });\r\n\t\treturn status;\r\n\t}\r\n\r\n\tinitWithUser(user) {\r\n\t\tconsole.log('initWithUser', user);\r\n\t\tconst link = LocationService.get('link') || null;\r\n\t\tconst role = this.getLinkRole() || (user ? user.type : null);\r\n\t\tuser = user || { type: role };\r\n\t\tif (role !== user.type) {\r\n\t\t\tuser = { type: role };\r\n\t\t}\r\n\t\tconst has3D = role !== RoleType.SmartDevice;\r\n\t\tconst name = LocationService.get('name') || (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null);\r\n\t\tconst checklist = LocalStorageService.get('checklist') || null;\r\n\t\tconst hosted = role === RoleType.Publisher ? true : false;\r\n\t\tconst live = (DEBUG || role === RoleType.SelfService) ? false : true;\r\n\t\tconst state = {\r\n\t\t\tuser: user,\r\n\t\t\trole: role,\r\n\t\t\thas3D: has3D,\r\n\t\t\tname: name,\r\n\t\t\tchecklist: checklist,\r\n\t\t\tlink: link,\r\n\t\t\tchannelName: environment.channelName,\r\n\t\t\tuid: null,\r\n\t\t\tstatus: 'idle',\r\n\t\t\tconnecting: false,\r\n\t\t\tconnected: false,\r\n\t\t\tlocked: false,\r\n\t\t\tcontrol: false,\r\n\t\t\tspyed: false,\r\n\t\t\thosted: hosted,\r\n\t\t\tlive: live,\r\n\t\t\tcameraMuted: false,\r\n\t\t\taudioMuted: false,\r\n\t\t};\r\n\t\tStateService.state = state;\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.hosted = state.hosted;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// console.log(state);\r\n\t\t});\r\n\t\tthis.initAgora();\r\n\t\tthis.viewObserver$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(view => {\r\n\t\t\t// console.log('AgoraComponent.viewObserver$', view);\r\n\t\t});\r\n\t}\r\n\r\n\tviewObserver$() {\r\n\t\treturn ViewService.data$().pipe(\r\n\t\t\tswitchMap(data => {\r\n\t\t\t\tthis.data = data;\r\n\t\t\t\tthis.views = data.views.filter(x => x.type.name !== 'waiting-room');\r\n\t\t\t\treturn ViewService.hostedView$(data);\r\n\t\t\t}),\r\n\t\t\t/*\r\n\t\t\ttap(view => {\r\n\t\t\t\tthis.view = null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t\tdelay(1),\r\n\t\t\t*/\r\n\t\t\ttap(view => {\r\n\t\t\t\t// !!! move navToView to user action?\r\n\t\t\t\tif (this.agora) {\r\n\t\t\t\t\tthis.agora.navToView(view.id);\r\n\t\t\t\t}\r\n\t\t\t\tthis.view = view;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tinitAgora() {\r\n\t\tlet agora = null;\r\n\t\tif (DEBUG || this.state.role === RoleType.SelfService) {\r\n\t\t\tStateService.patchState({ status: AgoraStatus.Connected, hosted: true });\r\n\t\t} else {\r\n\t\t\tagora = this.agora = AgoraService.getSingleton();\r\n\t\t\tconst role = this.getLinkRole();\r\n\t\t\tconst status = this.setNextStatus();\r\n\t\t\t// console.log('initAgora', status, role);\r\n\t\t}\r\n\t\tStreamService.local$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(local => {\r\n\t\t\t// console.log('AgoraComponent.local', local);\r\n\t\t\tthis.local = local;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStreamService.screen$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(screen => {\r\n\t\t\t// console.log('AgoraComponent.screen', screen);\r\n\t\t\tthis.screen = screen;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tStreamService.orderedRemotes$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(remotes => {\r\n\t\t\t// console.log('AgoraComponent.remotes', remotes);\r\n\t\t\tthis.remotes = remotes;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// console.log('AgoraComponent.message', message);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.RequestPeerInfo:\r\n\t\t\t\t\tmessage.type = MessageType.RequestPeerInfoResult;\r\n\t\t\t\t\tmessage.clientInfo = {\r\n\t\t\t\t\t\trole: StateService.state.role,\r\n\t\t\t\t\t\tname: StateService.state.name,\r\n\t\t\t\t\t\tuid: StateService.state.uid,\r\n\t\t\t\t\t\tscreenUid: StateService.state.screenUid,\r\n\t\t\t\t\t\tcontrol: StateService.state.control,\r\n\t\t\t\t\t};\r\n\t\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.RequestControl:\r\n\t\t\t\t\t// console.log('AgoraComponent', 'MessageType.RequestControlAccepted');\r\n\t\t\t\t\tmessage.type = MessageType.RequestControlAccepted;\r\n\t\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\t\tStateService.patchState({ locked: true });\r\n\t\t\t\t\tif (this.agora) {\r\n\t\t\t\t\t\tthis.agora.sendControlRemoteRequestInfo(message.clientId);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// !!! control request permission not required\r\n\t\t\t\t\t// this.onRemoteControlRequest(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t// !!! moved to WorldComponent\r\n\t\t\t\t/*\r\n\t\t\t\tcase MessageType.RequestInfo:\r\n\t\t\t\t\tif (StateService.state.role !== RoleType.Publisher) {\r\n\t\t\t\t\t\tStateService.patchState({ spyed: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.RequestInfoResult:\r\n\t\t\t\t\tconsole.log('AgoraComponent.RequestInfoResult', ViewService.viewId, message.viewId);\r\n\t\t\t\t\tViewService.viewId = message.viewId;\r\n\t\t\t\t\t// console.log('AgoraComponent.RequestInfoResult', message.viewId);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t*/\r\n\t\t\t\tcase MessageType.NavToView:\r\n\t\t\t\t\tthis.onRemoteNavTo(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.AddLike:\r\n\t\t\t\t\tViewService.setViewLike$(message).pipe(\r\n\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t).subscribe(view => this.showLove(view));\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ChatMessage:\r\n\t\t\t\t\tif (!StateService.state.chat) {\r\n\t\t\t\t\t\tStateService.patchState({ chatDirty: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tMessageService.in$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\tif (agora) {\r\n\t\t\t\tagora.sendMessage(message);\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (agora && StateService.state.status === AgoraStatus.ShouldConnect) {\r\n\t\t\tthis.connect();\r\n\t\t}\r\n\t}\r\n\r\n\tonChecked(checklist) {\r\n\t\t// console.log('AgoraComponent.onChecked', checklist);\r\n\t\tStateService.patchState({ checklist: true });\r\n\t\tthis.setNextStatus();\r\n\t}\r\n\r\n\tonLink(link) {\r\n\t\tconst role = this.getLinkRole();\r\n\t\tconst has3D = role !== RoleType.SmartDevice;\r\n\t\tconst user = StateService.state.user;\r\n\t\tif ((role === RoleType.Publisher || role === RoleType.Attendee) && (!user.id || user.type !== role)) {\r\n\t\t\tStateService.patchState({ link, role, has3D, status: AgoraStatus.Login });\r\n\t\t} else if (StateService.state.name) {\r\n\t\t\tif (role === RoleType.Viewer || role === RoleType.SmartDevice) {\r\n\t\t\t\tStateService.patchState({ link, role, has3D });\r\n\t\t\t\tthis.connect();\r\n\t\t\t} else {\r\n\t\t\t\tStateService.patchState({ link, role, has3D, status: AgoraStatus.Device });\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ link, role, has3D, status: AgoraStatus.Name });\r\n\t\t}\r\n\t}\r\n\r\n\tonLogin(user) {\r\n\t\tconst name = StateService.state.name || (user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null);\r\n\t\tif (name) {\r\n\t\t\tStateService.patchState({ user, name, status: AgoraStatus.Device });\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ user, status: AgoraStatus.Name });\r\n\t\t}\r\n\t}\r\n\r\n\tonName(name) {\r\n\t\tif (StateService.state.role === RoleType.Viewer || StateService.state.role === RoleType.SmartDevice) {\r\n\t\t\tStateService.patchState({ name });\r\n\t\t\tthis.connect();\r\n\t\t} else {\r\n\t\t\tStateService.patchState({ name, status: AgoraStatus.Device });\r\n\t\t}\r\n\t}\r\n\r\n\tonEnter(preferences) {\r\n\t\tthis.connect(preferences);\r\n\t}\r\n\r\n\tconnect(preferences) {\r\n\t\tthis.agora.connect$(preferences).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\t// console.log('AgoraComponent.connect', this.state.role);\r\n\t\tif (this.state.role !== RoleType.SelfService) {\r\n\t\t\tconst sharedMeetingId = this.state.link.replace(/-\\d+-/, '-');\r\n\t\t\tconst log = {\r\n\t\t\t\tmeetingId: this.state.link,\r\n\t\t\t\tsharedMeetingId: sharedMeetingId,\r\n\t\t\t\tfullName: this.state.name,\r\n\t\t\t\tuserType: this.state.role\r\n\t\t\t};\r\n\t\t\t// console.log('AgoraComponent.connect', log);\r\n\t\t\tUserService.log$(log).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe();\r\n\t\t\tGtmService.push({\r\n\t\t\t\taction: 'b-here-meeting',\r\n\t\t\t\tmeetingId: this.state.link,\r\n\t\t\t\tsharedMeetingId: sharedMeetingId,\r\n\t\t\t\tuserType: this.state.role\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tdisconnect() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.leaveChannel().then(() => {\r\n\t\t\t\t// StateService.patchState({ status: AgoraStatus.Disconnected, connected: false });\r\n\t\t\t\twindow.location.href = window.location.href;\r\n\t\t\t}, console.log);\r\n\t\t} else {\r\n\t\t\tthis.patchState({ connecting: false, connected: false });\r\n\t\t}\r\n\t}\r\n\r\n\tonNavTo(navItem) {\r\n\t\tconst viewId = navItem.viewId;\r\n\t\tconst view = this.data.views.find(x => x.id === viewId);\r\n\t\tif (view) {\r\n\t\t\tViewService.action = { viewId, keepOrientation: navItem.keepOrientation };\r\n\t\t}\r\n\t}\r\n\r\n\tonRemoteNavTo(message) {\r\n\t\tconst viewId = message.viewId;\r\n\t\tconst gridIndex = message.gridIndex;\r\n\t\tif (viewId && ViewService.viewId !== viewId) {\r\n\t\t\tconst view = this.data.views.find(x => x.id === viewId);\r\n\t\t\tif (view) {\r\n\t\t\t\tViewService.action = { viewId, keepOrientation: message.keepOrientation };\r\n\t\t\t\tif (gridIndex != null && view instanceof PanoramaGridView) {\r\n\t\t\t\t\tview.index = gridIndex;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// console.log('AgoraComponent.onRemoteNavTo', viewId, gridIndex);\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\tonRemoteControlRequest(message) {\r\n\t\tModalService.open$({ src: environment.template.modal.controlRequest, data: null }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (!DEBUG) {\r\n\t\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\t\tmessage.type = MessageType.RequestControlAccepted;\r\n\t\t\t\t\tthis.state.locked = true;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmessage.type = MessageType.RequestControlRejected;\r\n\t\t\t\t\tthis.state.locked = false;\r\n\t\t\t\t}\r\n\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t} else {\r\n\t\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\t\tthis.patchState({ control: true, spying: false });\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.patchState({ control: false, spying: false });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\t// !!! why locally?\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.pushChanges();\r\n\t\t// console.log(this.state);\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleCamera();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ cameraMuted: !this.state.cameraMuted });\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleAudio();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ audioMuted: !this.state.audioMuted });\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleScreen() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleScreen();\r\n\t\t} else {\r\n\t\t\tthis.patchState({ screen: !this.state.screen });\r\n\t\t}\r\n\t}\r\n\r\n\ttoggleVolume() {\r\n\t\tconst volumeMuted = !this.state.volumeMuted;\r\n\t\tStateService.patchState({ volumeMuted })\r\n\t}\r\n\r\n\ttoggleFullScreen() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst fullScreen = !this.state.fullScreen;\r\n\t\tif (fullScreen) {\r\n\t\t\tif (node.requestFullscreen) {\r\n\t\t\t\tnode.requestFullscreen();\r\n\t\t\t} else if (node.webkitRequestFullscreen) {\r\n\t\t\t\tnode.webkitRequestFullscreen();\r\n\t\t\t} else if (node.msRequestFullscreen) {\r\n\t\t\t\tnode.msRequestFullscreen();\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (document.exitFullscreen) {\r\n\t\t\t\tdocument.exitFullscreen();\r\n\t\t\t} else if (document.webkitExitFullscreen) {\r\n\t\t\t\tdocument.webkitExitFullscreen();\r\n\t\t\t} else if (document.msExitFullscreen) {\r\n\t\t\t\tdocument.msExitFullscreen();\r\n\t\t\t}\r\n\t\t}\r\n\t\tStateService.patchState({ fullScreen });\r\n\t}\r\n\r\n\ttoggleChat() {\r\n\t\tStateService.patchState({ chat: !this.state.chat, chatDirty: false });\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\tonChatClose() {\r\n\t\tthis.patchState({ chat: false });\r\n\t}\r\n\r\n\tonToggleControl() {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleControl();\r\n\t\t} else if (this.state.control) {\r\n\t\t\tthis.patchState({ control: false });\r\n\t\t}/* else {\r\n\t\t\tthis.onRemoteControlRequest({});\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tonToggleSpy(remoteId) {\r\n\t\tif (this.agora) {\r\n\t\t\tthis.agora.toggleSpy(remoteId);\r\n\t\t} else {\r\n\t\t\tthis.patchState({ spying: !this.state.spying, control: false });\r\n\t\t}\r\n\t}\r\n\r\n\taddLike() {\r\n\t\tViewService.viewLike$(this.view).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe((view) => {\r\n\t\t\tif (view) {\r\n\t\t\t\tthis.view.liked = true; // view.liked;\r\n\t\t\t\tthis.showLove(view);\r\n\t\t\t\t// this.view.likes = view.likes;\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t\tMessageService.send({\r\n\t\t\t\t\ttype: MessageType.AddLike,\r\n\t\t\t\t\tviewId: this.view.id,\r\n\t\t\t\t\tlikes: this.view.likes,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tshowLove(view) {\r\n\t\tif (view && this.view.id === view.id) {\r\n\t\t\tconst skipTimeout = this.view.showLove;\r\n\t\t\tthis.view.likes = view.likes;\r\n\t\t\tthis.view.showLove = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (!skipTimeout) {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.view.showLove = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 3100);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttryInAr() {\r\n\t\tif (this.platform === DevicePlatform.IOS || this.platform === DevicePlatform.Android) {\r\n\t\t\tTryInARModalComponent.openInAR(this.view);\r\n\t\t} else {\r\n\t\t\tModalService.open$({ src: environment.template.modal.tryInAr, data: this.view }).pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(event => {\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\tonPrevent(event) {\r\n\t\tevent.preventDefault();\r\n\t\tevent.stopImmediatePropagation();\r\n\t}\r\n\t*/\r\n}\r\n\r\nAgoraComponent.meta = {\r\n\tselector: '[agora-component]',\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\n\r\nexport default class AppComponent extends Component {\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t}\r\n}\r\n\r\nAppComponent.meta = {\r\n\tselector: '[app-component]',\r\n};\r\n","import { environment } from \"../environment\";\r\n\r\nexport const EXT_IMAGE = [\r\n\t'jpeg', 'jpg', 'png',\r\n];\r\nexport const EXT_VIDEO = [\r\n\t'mp4', 'webm',\r\n];\r\nexport const EXT_MODEL = [\r\n\t'fbx', 'gltf', 'glb', 'usdz'\r\n];\r\n\r\nexport const AssetType = {\r\n\tImage: { id: 1, name: 'image' }, // jpg, png, ...\r\n\tVideo: { id: 2, name: 'video' }, // mp4, webm, ...\r\n\tModel: { id: 3, name: 'model' }, // fbx, gltf, glb, usdz ...\r\n\tPublisherStream: { id: 4, name: 'publisher-stream', file: 'publisherStream' }, // valore fisso di file a ‘publisherStream’ e folder string.empty\r\n\tAttendeeStream: { id: 5, name: 'next-attendee-stream', file: 'nextAttendeeStream' }, // valore fisso di file a ‘nextAttendeeStream’ e folder string.empty\r\n\tPublisherScreen: { id: 6, name: 'publisher-screen', file: 'publisherScreen' }, // valore fisso di file a ‘publisherScreen’ e folder string.empty\r\n\tAttendeeScreen: { id: 7, name: 'attendee-screen', file: 'attendeeScreen' }, // valore fisso di file a ‘attendeeScreen’ e folder string.empty\r\n\tSmartDeviceStream: { id: 8, name: 'smart-device-stream', file: 'smartDeviceStream' }, // valore fisso di file a smartDeviceStream e folder string.empty\r\n};\r\n\r\nexport const AssetGroupType = {\r\n\tImageOrVideo: { id: 1, name: 'Image or Video', ids: [1, 2] },\r\n\t// Model: { id: 2, name: 'Model 3D', ids: [3] },\r\n\tPublisher: { id: 3, name: 'Publisher', ids: [4] },\r\n\tAttendee: { id: 4, name: 'Attendee', ids: [5] },\r\n\t// PublisherScreen: { id: 5, name: 'PublisherScreen', ids: [6] },\r\n\t// AttendeeScreen: { id: 6, name: 'AttendeeScreen', ids: [7] },\r\n};\r\n\r\nif (environment.flags.editorAssetScreen) {\r\n\tAssetGroupType.PublisherScreen = { id: 5, name: 'PublisherScreen', ids: [6] };\r\n\tAssetGroupType.AttendeeScreen = { id: 6, name: 'AttendeeScreen', ids: [7] };\r\n}\r\n\r\nAssetGroupType.SmartDevice = { id: 7, name: 'Smart Device', ids: [8] };\r\n\r\nexport const STREAM_TYPES = [\r\n\tAssetType.PublisherStream.name,\r\n\tAssetType.AttendeeStream.name,\r\n\tAssetType.PublisherScreen.name,\r\n\tAssetType.AttendeeScreen.name,\r\n\tAssetType.SmartDeviceStream.name,\r\n];\r\n\r\nexport function assetIsStream(asset) {\r\n\treturn asset && STREAM_TYPES.indexOf(asset.type.name) !== -1;\r\n}\r\n\r\nexport function assetTypeById(id) {\r\n\tconst type = Object.keys(AssetType).reduce((p, key) => {\r\n\t\tconst type = AssetType[key];\r\n\t\treturn type.id === id ? type : p;\r\n\t}, null);\r\n\treturn type;\r\n\t// return Object.keys(AssetType).map(x => AssetType[x]).find(x => x.id === id);\r\n}\r\n\r\nexport function assetGroupTypeById(id) {\r\n\tconst type = Object.keys(AssetGroupType).reduce((p, key) => {\r\n\t\tconst type = AssetGroupType[key];\r\n\t\treturn type.id === id ? type : p;\r\n\t}, null);\r\n\treturn type;\r\n\t// return Object.keys(AssetGroupType).map(x => AssetGroupType[x]).find(x => x.id === id);\r\n}\r\n\r\nexport function assetGroupTypeFromItem(item) {\r\n\tlet key;\r\n\tif (item && item.asset) {\r\n\t\tkey = Object.keys(AssetGroupType).find(key => {\r\n\t\t\t// console.log(key, AssetGroupType[key].ids, item.asset.type.id);\r\n\t\t\treturn AssetGroupType[key].ids.indexOf(item.asset.type.id) !== -1;\r\n\t\t});\r\n\t}\r\n\treturn AssetGroupType[key || 'ImageOrVideo'];\r\n}\r\n\r\nexport function assetPayloadFromGroupTypeId(groupTypeId) {\r\n\tconst groupType = assetGroupTypeById(groupTypeId);\r\n\tconst type = assetTypeById(groupType.ids[0]);\r\n\tconst file = type.file;\r\n\tconst asset = {\r\n\t\ttype: type,\r\n\t\tfolder: '',\r\n\t\tfile: file,\r\n\t}\r\n\tconsole.log('assetPayloadFromGroupTypeId', asset);\r\n\treturn new Asset(asset);\r\n}\r\n\r\nexport function assetTypeFromPath(path) {\r\n\tconst extension = path.split('.').pop().toLowerCase();\r\n\tif (EXT_IMAGE.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Image;\r\n\t} else if (EXT_VIDEO.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Video;\r\n\t} else if (EXT_MODEL.indexOf(extension) !== -1) {\r\n\t\treturn AssetType.Model;\r\n\t}\r\n}\r\n\r\nexport function isAssetType(path, type) {\r\n\tconst assetType = assetTypeFromPath(path);\r\n\treturn assetType === type;\r\n}\r\n\r\nexport class Asset {\r\n\tstatic allowedProps = ['id', 'type', 'folder', 'file', 'linkedPlayId', 'chromaKeyColor'];\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n\tget payload() {\r\n\t\tconst payload = {};\r\n\t\tObject.keys(this).forEach(key => {\r\n\t\t\tif (Asset.allowedProps.indexOf(key) !== -1) {\r\n\t\t\t\tpayload[key] = this[key];\r\n\t\t\t}\r\n\t\t});\r\n\t\treturn payload;\r\n\t}\r\n\tstatic fromUrl(url) {\r\n\t\tconst segments = url.split('/');\r\n\t\tconst file = segments.pop();\r\n\t\tconst folder = segments.join('/') + '/';\r\n\t\tconst type = assetTypeFromPath(file);\r\n\t\treturn new Asset({\r\n\t\t\ttype: type,\r\n\t\t\tfolder: folder,\r\n\t\t\tfile: file,\r\n\t\t});\r\n\t}\r\n}\r\n\r\nexport function mapAsset(asset) {\r\n\tswitch (asset.type) {\r\n\t\tdefault:\r\n\t\t\tasset = new Asset(asset);\r\n\t}\r\n\treturn asset;\r\n}\r\n","import { Pipe } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport { AssetType } from './asset';\r\n\r\nexport const MIME_IMAGE = [\r\n\t'bmp', 'gif', 'ico', 'jpeg', 'jpg', 'png', 'svg', 'tif', 'tiff', 'webp',\r\n];\r\nexport const MIME_AUDIO = [\r\n\t'aac', 'mid', 'midi', 'mp3', 'oga', 'opus', 'wav', 'weba',\r\n];\r\nexport const MIME_VIDEO = [\r\n\t'mp4', 'avi', 'mpeg', 'ogv', 'ts', 'webm', '3gp', '3g2',\r\n];\r\nexport const MIME_MODEL = [\r\n\t'fbx', 'gltf', 'glb', 'obj', 'usdz',\r\n];\r\nexport const MIME_STREAM = [\r\n\t'publisherStream', 'nextAttendeeStream', 'publisherScreen', 'attendeeScreen',\r\n];\r\nexport function isImage(path) {\r\n\treturn new RegExp(`/\\.(${MIME_IMAGE.join('|')})$/i`).test(path);\r\n}\r\nexport function isVideo(path) {\r\n\treturn new RegExp(`/\\.(${MIME_VIDEO.join('|')})$/i`).test(path);\r\n}\r\nexport function isModel(path) {\r\n\treturn new RegExp(`/\\.(${MIME_MODEL.join('|')})$/i`).test(path);\r\n}\r\nexport function isStream(path) {\r\n\treturn MIME_STREAM.indexOf(path) !== -1;\r\n}\r\nexport default class AssetPipe extends Pipe {\r\n\tstatic transform(asset, type = null) {\r\n\t\tif (type != null) { // keep loose equality\r\n\t\t\tasset = asset.type.name === type ? asset : null;\r\n\t\t}\r\n\t\tif (asset) {\r\n\t\t\t// console.log(asset.type.name, AssetType.Image.name);\r\n\t\t\tswitch (asset.type.name) {\r\n\t\t\t\tcase AssetType.Image.name:\r\n\t\t\t\tcase AssetType.Video.name:\r\n\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase AssetType.Model.name:\r\n\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase AssetType.PublisherStream.name:\r\n\t\t\t\tcase AssetType.AttendeeStream.name:\r\n\t\t\t\tcase AssetType.PublisherScreen.name:\r\n\t\t\t\tcase AssetType.AttendeeScreen.name:\r\n\t\t\t\tcase AssetType.SmartDeviceStream.name:\r\n\t\t\t\t\tasset = environment.getPath(asset.file);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tif (isImage(asset.file) || isVideo(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\t} else if (isModel(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.folder + asset.file;\r\n\t\t\t\t\t\tasset = environment.getPath(asset);\r\n\t\t\t\t\t} else if (isStream(asset.file)) {\r\n\t\t\t\t\t\tasset = asset.file;\r\n\t\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tasset = asset;\r\n\t\t} else {\r\n\t\t\tasset = null;\r\n\t\t}\r\n\t\t// console.log('AssetPipe.transform', asset);\r\n\t\treturn asset;\r\n\t}\r\n}\r\nAssetPipe.meta = {\r\n\tname: 'asset',\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from '../modal/modal-outlet.component';\r\nimport ModalService from '../modal/modal.service';\r\n\r\nexport default class ControlRequestModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tthis.data = parentInstance.modal.data;\r\n\t\t}\r\n\t}\r\n\r\n\tonAccept(user) {\r\n\t\tModalService.resolve();\r\n\t}\r\n\r\n\tonReject(user) {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\t/*\r\n\tonDestroy() {\r\n\t\t// console.log('ControlRequestModalComponent.onDestroy');\r\n\t}\r\n\t*/\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nControlRequestModalComponent.meta = {\r\n\tselector: '[control-request-modal]'\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\nimport { fromEvent } from 'rxjs';\r\nimport { shareReplay, takeUntil } from 'rxjs/operators';\r\n\r\nexport default class DropDirective extends Directive {\r\n\r\n\tonInit() {\r\n\t\tconst { module, node, parentInstance, selector } = getContext(this);\r\n\t\tconst event = 'drop';\r\n\t\tconst event$ = fromEvent(node, event).pipe(shareReplay(1));\r\n\t\tconst expression = node.getAttribute(`(${event})`);\r\n\t\tif (expression) {\r\n\t\t\tconst outputFunction = module.makeFunction(expression, ['$event']);\r\n\t\t\tevent$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(event => {\r\n\t\t\t\tmodule.resolve(outputFunction, parentInstance, event);\r\n\t\t\t});\r\n\t\t\tfromEvent(node, 'dragover').pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(event => event.preventDefault());\r\n\t\t} else {\r\n\t\t\tparentInstance[`${event}$`] = event$;\r\n\t\t}\r\n\t\t// console.log('DropDirective.onInit', 'selector', selector, 'event', event);\r\n\t}\r\n\r\n}\r\n\r\nDropDirective.meta = {\r\n\tselector: `[(drop)]`,\r\n};\r\n","import { Directive, getContext } from \"rxcomp\";\r\nimport { BehaviorSubject } from \"rxjs\";\r\nimport { takeUntil } from \"rxjs/operators\";\r\n\r\nlet DROPDOWN_ID = 1000000;\r\n\r\nexport default class DropdownDirective extends Directive {\r\n\r\n\tget id() {\r\n\t\treturn this.dropdown || this.id_ || (this.id_ = DropdownDirective.nextId());\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst trigger = node.getAttribute('dropdown-trigger');\r\n\t\tthis.trigger = trigger ? node.querySelector(trigger) : node;\r\n\t\tthis.opened = null;\r\n\t\tthis.onClick = this.onClick.bind(this);\r\n\t\tthis.onDocumentClick = this.onDocumentClick.bind(this);\r\n\t\tthis.openDropdown = this.openDropdown.bind(this);\r\n\t\tthis.closeDropdown = this.closeDropdown.bind(this);\r\n\t\tthis.addListeners();\r\n\t\tDropdownDirective.dropdown$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(id => {\r\n\t\t\t// console.log('DropdownDirective', id, this['dropdown-item']);\r\n\t\t\tif (this.id === id) {\r\n\t\t\t\tnode.classList.add('dropped');\r\n\t\t\t} else {\r\n\t\t\t\tnode.classList.remove('dropped');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonClick(event) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (this.opened === null) {\r\n\t\t\tthis.openDropdown();\r\n\t\t} else {\r\n\t\t\tconst dropdownItemNode = node.querySelector('[dropdown-item]');\r\n\t\t\t// console.log('dropdownItemNode', dropdownItemNode);\r\n\t\t\tif (!dropdownItemNode) { // if (this.trigger !== node) {\r\n\t\t\t\tthis.closeDropdown();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDocumentClick(event) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst clickedInside = node === event.target || node.contains(event.target);\r\n\t\tif (!clickedInside) {\r\n\t\t\tthis.closeDropdown();\r\n\t\t}\r\n\t}\r\n\r\n\topenDropdown() {\r\n\t\tif (this.opened === null) {\r\n\t\t\tthis.opened = true;\r\n\t\t\tthis.addDocumentListeners();\r\n\t\t\tDropdownDirective.dropdown$.next(this.id);\r\n\t\t\tthis.dropped.next(this.id);\r\n\t\t}\r\n\t}\r\n\r\n\tcloseDropdown() {\r\n\t\tif (this.opened !== null) {\r\n\t\t\tthis.removeDocumentListeners();\r\n\t\t\tthis.opened = null;\r\n\t\t\tif (DropdownDirective.dropdown$.getValue() === this.id) {\r\n\t\t\t\tDropdownDirective.dropdown$.next(null);\r\n\t\t\t\tthis.dropped.next(null);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddListeners() {\r\n\t\tthis.trigger.addEventListener('click', this.onClick);\r\n\t}\r\n\r\n\taddDocumentListeners() {\r\n\t\tdocument.addEventListener('click', this.onDocumentClick);\r\n\t}\r\n\r\n\tremoveListeners() {\r\n\t\tthis.trigger.removeEventListener('click', this.onClick);\r\n\t}\r\n\r\n\tremoveDocumentListeners() {\r\n\t\tdocument.removeEventListener('click', this.onDocumentClick);\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.removeListeners();\r\n\t\tthis.removeDocumentListeners();\r\n\t}\r\n\r\n\tstatic nextId() {\r\n\t\treturn DROPDOWN_ID++;\r\n\t}\r\n\r\n}\r\n\r\nDropdownDirective.meta = {\r\n\tselector: '[dropdown]',\r\n\tinputs: ['dropdown', 'dropdown-trigger'],\r\n\toutputs: ['dropped']\r\n};\r\n\r\nDropdownDirective.dropdown$ = new BehaviorSubject(null);\r\n","import { Directive, getContext } from \"rxcomp\";\r\nimport { takeUntil } from \"rxjs/operators\";\r\nimport DropdownDirective from \"./dropdown.directive\";\r\n\r\nexport default class DropdownItemDirective extends Directive {\r\n\r\n\tget id() {\r\n\t\treturn this['dropdown-item'];\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('dropdown-item');\r\n\t\tDropdownDirective.dropdown$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(id => {\r\n\t\t\t// console.log('DropdownItemDirective', id, this['dropdown-item']);\r\n\t\t\tif (this.id === id) {\r\n\t\t\t\tnode.classList.add('dropped');\r\n\t\t\t} else {\r\n\t\t\t\tnode.classList.remove('dropped');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n}\r\n\r\nDropdownItemDirective.meta = {\r\n\tselector: '[dropdown-item], [[dropdown-item]]',\r\n\tinputs: ['dropdown-item']\r\n};\r\n","import { Subject } from 'rxjs';\r\n\r\nexport class ToastEvent {\r\n\tconstructor(toast) {\r\n\t\tthis.toast = toast;\r\n\t}\r\n}\r\n\r\nexport class ToastResolveEvent extends ToastEvent { }\r\n\r\nexport default class ToastService {\r\n\tstatic open$(toast) {\r\n\t\ttoast.id = new Date().getTime();\r\n\t\tthis.toast$.next(toast);\r\n\t\tsetTimeout(() => {\r\n\t\t\tthis.resolve(toast);\r\n\t\t}, toast.duration || 3000);\r\n\t\treturn this.events$;\r\n\t\t/*\r\n\t\treturn of(toast).pipe(\r\n\t\t\ttap(toast => this.toast$.next(toast)),\r\n\t\t\tswitchMap(toast => this.events$),\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\tstatic resolve(toast) {\r\n\t\tthis.toast$.next(null);\r\n\t\tthis.events$.next(new ToastResolveEvent(toast));\r\n\t}\r\n}\r\n\r\nToastService.toast$ = new Subject();\r\nToastService.events$ = new Subject();\r\n","import { Component } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport ToastService from './toast.service';\r\n\r\nexport default class ToastOutletComponent extends Component {\r\n\tonInit() {\r\n\t\tthis.toast = null;\r\n\t\tthis.lastMessage = '';\r\n\t\tToastService.toast$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(toast => {\r\n\t\t\tif (toast) {\r\n\t\t\t\tthis.lastMessage = toast.message;\r\n\t\t\t}\r\n\t\t\tthis.toast = toast;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\t// console.log('ToastOutletComponent.onInit');\r\n\t}\r\n}\r\n\r\nToastOutletComponent.meta = {\r\n\tselector: '[toast-outlet]',\r\n\ttemplate: /* html */ `\r\n\t<div class=\"toast-outlet__container\" [class]=\"{ active: toast }\">\r\n\t\t<div class=\"toast-outlet__toast\" [innerHTML]=\"lastMessage\"></div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport { ViewItemType, ViewType } from '../../view/view';\r\n\r\nexport default class AsideComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.mode = 1;\r\n\t\tthis.viewTypes = Object.keys(ViewType).map(key => {\r\n\t\t\tconst type = ViewType[key];\r\n\t\t\treturn {\r\n\t\t\t\ttype: type,\r\n\t\t\t\tname: LabelPipe.getKeys('editor', type.name),\r\n\t\t\t\tdisabled: environment.editor.disabledViewTypes.indexOf(type.name) !== -1,\r\n\t\t\t};\r\n\t\t});\r\n\t\tthis.viewItemTypes = Object.keys(ViewItemType).map(key => {\r\n\t\t\tconst type = ViewItemType[key];\r\n\t\t\treturn {\r\n\t\t\t\ttype: type,\r\n\t\t\t\tname: LabelPipe.getKeys('editor', type.name),\r\n\t\t\t\tdisabled: environment.editor.disabledViewItemTypes.indexOf(type.name) !== -1,\r\n\t\t\t};\r\n\t\t});\r\n\t\tthis.setSupportedViewTypes();\r\n\t\tthis.setSupportedViewItemTypes();\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.setSupportedViewTypes();\r\n\t\tthis.setSupportedViewItemTypes();\r\n\t}\r\n\r\n\tsetSupportedViewTypes() {\r\n\t\tthis.supportedViewTypes = this.viewTypes.filter(x => this.supportedViewType(x.type.name)).sort((a, b) => {\r\n\t\t\tif (a.disabled === b.disabled) {\r\n\t\t\t\treturn 0; // (a.type.name < b.type.name) ? -1 : (a.type.name > b.type.name) ? 1 : 0;\r\n\t\t\t} else {\r\n\t\t\t\treturn a.disabled ? 1 : -1;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tsetSupportedViewItemTypes() {\r\n\t\tif (this.view) {\r\n\t\t\tthis.supportedViewItemTypes = this.viewItemTypes.filter(x => this.supportedViewItemType(this.view.type.name, x.type.name)).sort((a, b) => {\r\n\t\t\t\tif (a.disabled === b.disabled) {\r\n\t\t\t\t\treturn 0; // (a.type.name < b.type.name) ? -1 : (a.type.name > b.type.name) ? 1 : 0;\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn a.disabled ? 1 : -1;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.supportedViewItemTypes = [];\r\n\t\t}\r\n\t}\r\n\r\n\tsetMode(mode) {\r\n\t\tif (this.mode !== mode) {\r\n\t\t\tthis.mode = mode;\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tsupportedViewType(viewTypeName) {\r\n\t\tlet supported = [ViewType.Panorama.name, ViewType.PanoramaGrid.name, ViewType.Room3d.name, ViewType.Model.name].indexOf(viewTypeName) !== -1; // ViewType.WaitingRoom,\r\n\t\t// console.log('supportedViewType', viewType, supported);\r\n\t\treturn supported;\r\n\t}\r\n\r\n\tsupportedViewItemType(viewTypeName, viewItemTypeName) {\r\n\t\tlet supported;\r\n\t\tswitch (viewTypeName) {\r\n\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\tsupported = false;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Texture.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t\tcase ViewType.Model.name:\r\n\t\t\t\tsupported = [ViewItemType.Nav.name, ViewItemType.Model.name, ViewItemType.Plane.name, ViewItemType.CurvedPlane.name].indexOf(viewItemTypeName) !== -1;\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\t// console.log('supportedViewItemType', viewTypeName, viewItemTypeName, supported);\r\n\t\treturn supported;\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next(event);\r\n\t}\r\n\r\n\tonUpdate(event) {\r\n\t\tthis.update.next(event);\r\n\t}\r\n\r\n\tonDelete(event) {\r\n\t\tthis.delete.next(event);\r\n\t}\r\n}\r\n\r\nAsideComponent.meta = {\r\n\tselector: '[aside]',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view'],\r\n};\r\n","import { fromEvent, merge, of } from \"rxjs\";\r\nimport { filter, map } from \"rxjs/operators\";\r\nimport HttpService from \"../http/http.service\";\r\nimport { Asset, mapAsset } from './asset';\r\n\r\nexport class AssetService {\r\n\r\n\tstatic assetCreate$(asset) {\r\n\t\treturn HttpService.post$(`/api/asset`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic assetUpdate$(asset) {\r\n\t\treturn HttpService.put$(`/api/asset/${asset.id}`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic assetDelete$(asset) {\r\n\t\tif (asset && asset.id) {\r\n\t\t\treturn HttpService.delete$(`/api/asset/${asset.id}`).pipe(\r\n\t\t\t\tmap(() => null),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic localizedAssetCreate$(lg, asset) {\r\n\t\treturn HttpService.post$(`/api/${lg}/asset`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic localizedAssetUpdate$(lg, asset) {\r\n\t\treturn HttpService.put$(`/api/${lg}/asset/${asset.id}`, asset).pipe(\r\n\t\t\tmap(asset => mapAsset(asset)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic upload$(files) {\r\n\t\tconst formData = new FormData();\r\n\t\tfiles.forEach(file => formData.append('file', file, file.name));\r\n\t\tconst xhr = new XMLHttpRequest();\r\n\t\tconst events$ = merge(\r\n\t\t\tfromEvent(xhr.upload, 'loadstart'),\r\n\t\t\tfromEvent(xhr.upload, 'progress'),\r\n\t\t\tfromEvent(xhr.upload, 'load'),\r\n\t\t\tfromEvent(xhr, 'readystatechange'),\r\n\t\t).pipe(\r\n\t\t\tmap(event => {\r\n\t\t\t\tswitch (event.type) {\r\n\t\t\t\t\tcase 'readystatechange':\r\n\t\t\t\t\t\tif (xhr.readyState === 4) {\r\n\t\t\t\t\t\t\treturn JSON.parse(xhr.responseText);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\treturn null;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event !== null)\r\n\t\t);\r\n\t\txhr.open('POST', `/api/upload/`, true);\r\n\t\txhr.send(formData);\r\n\t\treturn events$;\r\n\t}\r\n\r\n\tstatic createOrUpdateAsset$(uploads, control) {\r\n\t\tconst upload = uploads[0];\r\n\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\tif (control.value && control.value.id) { // !!! must check for id\r\n\t\t\tasset.id = control.value.id;\r\n\t\t\treturn AssetService.assetUpdate$(asset);\r\n\t\t} else {\r\n\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic createOrUpdateLocalizedAsset$(uploads, control, lg) {\r\n\t\tconst upload = uploads[0];\r\n\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\tif (control.value && control.value.id) { // !!! must check for id\r\n\t\t\tasset.id = control.value.id;\r\n\t\t\treturn AssetService.localizedAssetUpdate$(lg, asset);\r\n\t\t} else {\r\n\t\t\treturn AssetService.localizedAssetCreate$(lg, asset);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic assetDidChange(previous, current) {\r\n\t\tlet previousId = null;\r\n\t\tlet previousFile = null;\r\n\t\tlet currentId = null;\r\n\t\tlet currentFile = null;\r\n\t\tif (previous) {\r\n\t\t\tpreviousId = previous.id;\r\n\t\t\tpreviousFile = previous.file;\r\n\t\t}\r\n\t\tif (current) {\r\n\t\t\tcurrentId = current.id;\r\n\t\t\tcurrentFile = current.file;\r\n\t\t}\r\n\t\treturn (previousId !== currentId || previousFile !== currentFile);\r\n\t}\r\n\r\n}\r\n","import { map, shareReplay } from 'rxjs/operators';\r\nimport HttpService from '../http/http.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport { mapView, mapViewItem, ViewType } from '../view/view';\r\n\r\nexport default class EditorService {\r\n\r\n\tstatic data$() {\r\n\t\tif (!this.data$_) {\r\n\t\t\tthis.data$_ = HttpService.get$(`/api/view`).pipe(\r\n\t\t\t\tmap(data => {\r\n\t\t\t\t\tdata.views = data.views.map(view => mapView(view));\r\n\t\t\t\t\treturn data;\r\n\t\t\t\t}),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.data$_;\r\n\t}\r\n\r\n\tstatic viewIdOptions$() {\r\n\t\treturn this.data$().pipe(\r\n\t\t\tmap(data => {\r\n\t\t\t\tconst options = data.views.map(view => ({ id: view.id, name: view.name }));\r\n\t\t\t\toptions.unshift({ id: null, name: LabelPipe.transform('select') });\r\n\t\t\t\treturn options;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic viewCreate$(view) {\r\n\t\treturn HttpService.post$(`/api/view`, view).pipe(\r\n\t\t\tmap(view => mapView(view)),\r\n\t\t);\r\n\t}\r\n\tstatic viewUpdate$(view) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}`, view.payload).pipe(\r\n\t\t\tmap(view => mapView(view)),\r\n\t\t);\r\n\t}\r\n\tstatic viewDelete$(view) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}`);\r\n\t}\r\n\r\n\tstatic getTile(view) {\r\n\t\tlet tile;\r\n\t\tif (view.type.name === ViewType.PanoramaGrid.name) {\r\n\t\t\ttile = view.tiles[view.index];\r\n\t\t}\r\n\t\treturn tile;\r\n\t}\r\n\r\n\tstatic inferItemCreate$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemCreate$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemCreate$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemUpdate$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemUpdate$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemUpdate$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemDelete$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tif (tile) {\r\n\t\t\treturn this.tileItemDelete$(view, tile, item);\r\n\t\t} else {\r\n\t\t\treturn this.itemDelete$(view, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemUpdateResult$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tlet currentItem;\r\n\t\tif (tile) {\r\n\t\t\tcurrentItem = tile.navs.find(i => i.id === item.id);\r\n\t\t} else {\r\n\t\t\tcurrentItem = view.items.find(i => i.id === item.id);\r\n\t\t}\r\n\t\tif (currentItem) {\r\n\t\t\tObject.assign(currentItem, item);\r\n\t\t}\r\n\t}\r\n\tstatic inferItemDeleteResult$(view, item) {\r\n\t\tconst tile = this.getTile(view);\r\n\t\tlet items;\r\n\t\tif (tile) {\r\n\t\t\titems = tile.navs;\r\n\t\t} else {\r\n\t\t\titems = view.items;\r\n\t\t}\r\n\t\tif (items) {\r\n\t\t\tconst index = items.indexOf(item);\r\n\t\t\tif (index !== -1) {\r\n\t\t\t\titems.splice(index, 1);\r\n\t\t\t}\r\n\t\t\tif (tile) {\r\n\t\t\t\tview.updateCurrentItems();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic itemCreate$(view, item) {\r\n\t\treturn HttpService.post$(`/api/view/${view.id}/item`, item).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic itemUpdate$(view, item) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}/item/${item.id}`, item.payload).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic itemDelete$(view, item) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}/item/${item.id}`);\r\n\t}\r\n\r\n\tstatic tileItemCreate$(view, tile, item) {\r\n\t\treturn HttpService.post$(`/api/view/${view.id}/tile/${tile.id}/item`, item).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic tileItemUpdate$(view, tile, item) {\r\n\t\treturn HttpService.put$(`/api/view/${view.id}/tile/${tile.id}/item/${item.id}`, item.payload).pipe(\r\n\t\t\tmap(item => mapViewItem(item)),\r\n\t\t);\r\n\t}\r\n\tstatic tileItemDelete$(view, tile, item) {\r\n\t\treturn HttpService.delete$(`/api/view/${view.id}/tile/${tile.id}/item/${item.id}`);\r\n\t}\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { Subject } from 'rxjs';\r\nimport { delay, first, switchMap, takeUntil, tap } from 'rxjs/operators';\r\nimport { AgoraStatus } from '../agora/agora.types';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { environment } from '../environment';\r\nimport ModalService, { ModalResolveEvent } from '../modal/modal.service';\r\nimport StateService from '../state/state.service';\r\nimport StreamService, { StreamServiceMode } from '../stream/stream.service';\r\nimport ToastService from '../toast/toast.service';\r\nimport { RoleType } from '../user/user';\r\nimport { UserService } from '../user/user.service';\r\nimport { ViewItemType, ViewType } from '../view/view';\r\nimport ViewService from '../view/view.service';\r\nimport VRService from '../world/vr.service';\r\nimport EditorService from './editor.service';\r\n\r\nexport default class EditorComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.remove('hidden');\r\n\t\tthis.aside = false;\r\n\t\tthis.settings = false;\r\n\t\tthis.state = {};\r\n\t\tthis.data = null;\r\n\t\tthis.views = null;\r\n\t\tthis.view = null;\r\n\t\tthis.form = null;\r\n\t\tthis.local = null;\r\n\t\tthis.remotes = [];\r\n\t\tthis.viewHit = new Subject();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.status$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(status => this.pushChanges());\r\n\t\tthis.resolveUser();\r\n\t}\r\n\r\n\tresolveUser() {\r\n\t\tUserService.me$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(user => {\r\n\t\t\tif (user && user.type === RoleType.Publisher) {\r\n\t\t\t\tthis.user = user;\r\n\t\t\t\tthis.initState();\r\n\t\t\t} else {\r\n\t\t\t\twindow.location.href = environment.url.access;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tinitState() {\r\n\t\tconst user = this.user;\r\n\t\tconst role = user.type;\r\n\t\tconst name = user.firstName && user.lastName ? `${user.firstName} ${user.lastName}` : null;\r\n\t\tconst state = {\r\n\t\t\tuser: user,\r\n\t\t\trole: role,\r\n\t\t\tname: name,\r\n\t\t\tlink: null,\r\n\t\t\tchannelName: environment.channelName,\r\n\t\t\tuid: null,\r\n\t\t\tstatus: AgoraStatus.Connected,\r\n\t\t\tconnecting: false,\r\n\t\t\tconnected: true,\r\n\t\t\tlocked: false,\r\n\t\t\tcontrol: false,\r\n\t\t\tspyed: false,\r\n\t\t\thosted: true,\r\n\t\t\tlive: false,\r\n\t\t\tcameraMuted: false,\r\n\t\t\taudioMuted: false,\r\n\t\t};\r\n\t\tStateService.state = state;\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.hosted = state.hosted;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tthis.viewObserver$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(view => {\r\n\t\t\t// console.log('EditorComponent.viewObserver$', view);\r\n\t\t});\r\n\t\tStreamService.mode = StreamServiceMode.Editor;\r\n\t\t// this.getUserMedia();\r\n\t}\r\n\r\n\tviewObserver$() {\r\n\t\treturn EditorService.data$().pipe(\r\n\t\t\tswitchMap(data => {\r\n\t\t\t\tthis.data = data;\r\n\t\t\t\tthis.views = data.views.filter(x => x.type.name !== 'waiting-room');\r\n\t\t\t\treturn ViewService.editorView$(data);\r\n\t\t\t}),\r\n\t\t\ttap(view => {\r\n\t\t\t\tthis.view = null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t\tdelay(1),\r\n\t\t\ttap(view => {\r\n\t\t\t\tthis.view = view;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tonNavTo(navItem) {\r\n\t\t// console.log('EditorComponent.onNavTo', navItem);\r\n\t\tconst viewId = navItem.viewId;\r\n\t\tconst view = this.data.views.find(x => x.id === viewId);\r\n\t\tif (view) {\r\n\t\t\tViewService.action = { viewId, keepOrientation: navItem.keepOrientation };\r\n\t\t}\r\n\t}\r\n\r\n\tonRemoteControlRequest(message) {\r\n\t\tModalService.open$({ src: environment.template.modal.controlRequest, data: null }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.patchState({ control: true, spying: false });\r\n\t\t\t} else {\r\n\t\t\t\tthis.patchState({ control: false, spying: false });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.pushChanges();\r\n\t\t// console.log(this.state);\r\n\t}\r\n\r\n\ttryInAr() {\r\n\t\tModalService.open$({ src: environment.template.modal.tryInAr, data: this.view }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\t// this.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tonPrevent(event) {\r\n\t\tevent.preventDefault();\r\n\t\tevent.stopImmediatePropagation();\r\n\t}\r\n\t*/\r\n\r\n\treplaceUrl() {\r\n\t\tif ('history' in window) {\r\n\t\t\tconst params = new URLSearchParams(window.location.search);\r\n\t\t\tconst debug = params.get('debug') || null;\r\n\t\t\tconst editor = params.get('editor') || null;\r\n\t\t\tconst role = params.get('role') || null;\r\n\t\t\tconst link = params.get('link') || null;\r\n\t\t\tconst name = params.get('name') || null;\r\n\t\t\tconst url = `${window.location.origin}${window.location.pathname}?link=${link}${name ? `&name=${name}` : ''}${role ? `&role=${role}` : ''}${debug ? `&debug` : ''}${editor ? `&editor` : ''}`;\r\n\t\t\t// console.log('AgoraNameComponent.url', url);\r\n\t\t\twindow.history.replaceState({ 'pageTitle': window.pageTitle }, '', url);\r\n\t\t}\r\n\t}\r\n\r\n\tonToggleAside() {\r\n\t\tthis.aside = !this.aside;\r\n\t\tthis.pushChanges();\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\tonToggleSettings() {\r\n\t\tthis.settings = !this.settings;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\t// editor\r\n\r\n\tonViewHit(event) {\r\n\t\t// console.log('onViewHit');\r\n\t\tthis.viewHit.next(event);\r\n\t}\r\n\r\n\tonViewHitted(callback) {\r\n\t\tif (this.viewHitSubscription) {\r\n\t\t\tthis.viewHitSubscription.unsubscribe();\r\n\t\t\tthis.viewHitSubscription = null;\r\n\t\t}\r\n\t\tif (typeof callback === 'function') {\r\n\t\t\tthis.viewHitSubscription = this.viewHit.pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(position => callback(position))\r\n\t\t}\r\n\t}\r\n\r\n\tonDragEnd(event) {\r\n\t\tEditorService.inferItemUpdate$(this.view, event.item).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(response => {\r\n\t\t\t// console.log('EditorComponent.onDragEnd.inferItemUpdate$.success', response);\r\n\t\t\tthis.pushChanges();\r\n\t\t}, error => console.log('EditorComponent.onDragEnd.inferItemUpdate$.error', error));\r\n\t}\r\n\r\n\tonResizeEnd(event) {\r\n\t\tconsole.log('EditorComponent.onResizeEnd');\r\n\t\t/*\r\n\t\tEditorService.inferItemUpdate$(this.view, event.item).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(response => {\r\n\t\t\t// console.log('EditorComponent.onResizeEnd.inferItemUpdate$.success', response);\r\n\t\t\tthis.pushChanges();\r\n\t\t}, error => console.log('EditorComponent.onResizeEnd.inferItemUpdate$.error', error));\r\n\t\t*/\r\n\t}\r\n\r\n\tonWorldSelect(event) {\r\n\t\t// console.log('EditorComponent.onWorldSelect', this.view);\r\n\t\tif (this.view) {\r\n\t\t\tlet selectedItem;\r\n\t\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\t\tthis.view.items.forEach(item => {\r\n\t\t\t\titem.selected = item === event.item;\r\n\t\t\t\tselectedItem = item.selected ? item : selectedItem;\r\n\t\t\t});\r\n\t\t\tthis.view.selected = !selectedItem;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (selectedItem) {\r\n\t\t\t\tthis.aside = true;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\twindow.dispatchEvent(new Event('resize'));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonOpenModal(modal, data) {\r\n\t\tModalService.open$({ src: environment.template.modal[modal.type][modal.value], data }).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tconsole.log('EditorComponent.onOpenModal.resolve', event);\r\n\t\t\t\tswitch(modal.type) {\r\n\t\t\t\t\tcase 'view':\r\n\t\t\t\t\t\tswitch (modal.value) {\r\n\t\t\t\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\t\t\t\tthis.data.views.push(event.data);\r\n\t\t\t\t\t\t\t\tViewService.viewId = event.data.id;\r\n\t\t\t\t\t\t\t\tthis.pushChanges(); // !!!\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'viewItem':\r\n\t\t\t\t\t\tswitch (modal.value) {\r\n\t\t\t\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\t\t\t\tconst tile = EditorService.getTile(this.view);\r\n\t\t\t\t\t\t\t\tif (tile) {\r\n\t\t\t\t\t\t\t\t\tconst navs = tile.navs || [];\r\n\t\t\t\t\t\t\t\t\tnavs.push(event.data);\r\n\t\t\t\t\t\t\t\t\tObject.assign(tile, { navs });\r\n\t\t\t\t\t\t\t\t\tthis.view.updateCurrentItems();\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tconst items = this.view.items || [];\r\n\t\t\t\t\t\t\t\t\titems.push(event.data);\r\n\t\t\t\t\t\t\t\t\tObject.assign(this.view, { items });\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonAsideSelect(event) {\r\n\t\t// console.log('onAsideSelect', event);\r\n\t\tif (event.value) {\r\n\t\t\tswitch (event.value) {\r\n\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\tthis.onViewHitted((position) => {\r\n\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view, position });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tToastService.open$({ message: 'Click a point on the view' });\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\tif (event.type === 'viewItem') {\r\n\t\t\t\t\t\tif (this.view.type.name === ViewType.Model.name) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.onViewHitted((position) => {\r\n\t\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view, position });\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tToastService.open$({ message: 'Click a point on the view' });\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.onOpenModal(event, { view: this.view });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tthis.onOpenModal(event, { view: this.view });\r\n\t\t\t}\r\n\t\t} else if (event.view && (event.item || event.item === null)) {\r\n\t\t\tevent.view.selected = false;\r\n\t\t\tevent.view.items.forEach(item => item.selected = item === event.item);\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.view && (event.tile || event.tile === null)) {\r\n\t\t\tevent.view.selected = false;\r\n\t\t\tevent.view.tiles.forEach(tile => tile.selected = tile === event.tile);\r\n\t\t\t/*\r\n\t\t\t// if tile selected\r\n\t\t\t// send ChangeTile message to world component\r\n\t\t\tthis.orbit.walk(event.position, (headingLongitude, headingLatitude) => {\r\n\t\t\t\tconst item = this.view.getTile(event.indices.x, event.indices.y);\r\n\t\t\t\tif (item) {\r\n\t\t\t\t\tthis.panorama.crossfade(item, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t\t\t// this.scene.background = envMap;\r\n\t\t\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t\t\t\tthis.orbit.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\t\t\t// this.render();\r\n\t\t\t\t\t\t// this.pushChanges();\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.view || event.view === null) {\r\n\t\t\tthis.view.selected = (this.view === event.view);\r\n\t\t\tthis.view.items.forEach(item => item.selected = false);\r\n\t\t\tconst currentTile = EditorService.getTile(this.view);\r\n\t\t\tif (currentTile) {\r\n\t\t\t\tthis.view.tiles.forEach(tile => tile.selected = tile === currentTile);\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\r\n\tonAsideUpdate(event) {\r\n\t\t// console.log('onAsideUpdate', event);\r\n\t\tif (event.item && event.view) {\r\n\t\t\tthis.pushChanges();\r\n\t\t} else if (event.tile && event.view) {\r\n\t\t\t/*\r\n\t\t\tEditorService.tileUpdate$...\r\n\t\t\t*/\r\n\t\t} else if (event.view) {\r\n\t\t\tif (ViewService.viewId !== event.view.id) {\r\n\t\t\t\tViewService.viewId = event.view.id;\r\n\t\t\t} else {\r\n\t\t\t\tconst assetDidChange = AssetService.assetDidChange(this.view.asset, event.view.asset);\r\n\t\t\t\tObject.assign(this.view, event.view);\r\n\t\t\t\tif (assetDidChange) {\r\n\t\t\t\t\tif (typeof this.view.onUpdateAsset === 'function') {\r\n\t\t\t\t\t\tthis.view.onUpdateAsset();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonAsideDelete(event) {\r\n\t\tconsole.log('onAsideDelete', event);\r\n\t\tif (event.item && event.view) {\r\n\t\t\tEditorService.inferItemDelete$(event.view, event.item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('EditorComponent.onAsideDelete.inferItemDelete$.success', response);\r\n\t\t\t\tEditorService.inferItemDeleteResult$(event.view, event.item);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, error => console.log('EditorComponent.onAsideDelete.inferItemDelete$.error', error));\r\n\t\t} else if (event.view) {\r\n\t\t\tEditorService.viewDelete$(event.view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('EditorComponent.onAsideDelete.viewDelete$.success', response);\r\n\t\t\t\tconst index = this.data.views.indexOf(event.view);\r\n\t\t\t\tif (index !== -1) {\r\n\t\t\t\t\tthis.data.views.splice(index, 1);\r\n\t\t\t\t}\r\n\t\t\t\tthis.views = this.data.views.slice();\r\n\t\t\t\tViewService.viewId = this.views[0].id;\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t}, error => console.log('EditorComponent.onAsideDelete.viewDelete$.error', error));\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nEditorComponent.meta = {\r\n\tselector: '[editor-component]',\r\n};\r\n","import { BehaviorSubject } from 'rxjs';\r\nimport { map, switchMap } from 'rxjs/operators';\r\nimport HttpService from '../../http/http.service';\r\nimport { ViewType } from '../../view/view';\r\n\r\nlet MENU_UID = 0;\r\n\r\nexport default class MenuService {\r\n\r\n\tstatic active$ = new BehaviorSubject(false);\r\n\tstatic set active(active) {\r\n\t\tthis.active$.next(active);\r\n\t}\r\n\tstatic get active() {\r\n\t\treturn this.active$.getValue();\r\n\t}\r\n\r\n\tstatic menu$_ = new BehaviorSubject([]);\r\n\r\n\tstatic menu$() {\r\n\t\treturn this.getMenu$().pipe(\r\n\t\t\tswitchMap(menu => {\r\n\t\t\t\tthis.menu$_.next(menu);\r\n\t\t\t\treturn this.menu$_;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic getMenu$() {\r\n\t\treturn HttpService.get$(`/api/menu`).pipe(\r\n\t\t\tmap(data => {\r\n\t\t\t\tdata.menu.sort((a, b) => {\r\n\t\t\t\t\treturn a.order - b.order;\r\n\t\t\t\t});\r\n\t\t\t\treturn data.menu;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic updateMenu$(menu) {\r\n\t\treturn HttpService.put$(`/api/menu`, menu);\r\n\t}\r\n\r\n\tstatic createMenuItem$(parentId = null, order = 0) {\r\n\t\tconst payload = {\r\n\t\t\tparentId: parentId,\r\n\t\t\tviewId: null,\r\n\t\t\torder: order * 10,\r\n\t\t\tname: 'Folder ' + (++MENU_UID),\r\n\t\t}\r\n\t\treturn HttpService.post$(`/api/menu`, payload);\r\n\t}\r\n\r\n\tstatic updateMenuItem$(item) {\r\n\t\treturn HttpService.put$(`/api/menu/${item.id}`, item);\r\n\t}\r\n\r\n\tstatic deleteMenuItem$(item) {\r\n\t\treturn HttpService.delete$(`/api/menu/${item.id}`);\r\n\t}\r\n\r\n\tstatic getModelMenu$(views, editor = false) {\r\n\t\treturn this.menu$().pipe(\r\n\t\t\tmap(menu => {\r\n\t\t\t\tif (menu && menu.length) {\r\n\t\t\t\t\treturn this.mapMenuItems(menu);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst keys = {};\r\n\t\t\t\t\tviews.forEach(item => {\r\n\t\t\t\t\t\tif (item.type.name !== ViewType.WaitingRoom.name && (!item.hidden || editor)) {\r\n\t\t\t\t\t\t\tlet group = keys[item.type.name];\r\n\t\t\t\t\t\t\tif (!group) {\r\n\t\t\t\t\t\t\t\tgroup = keys[item.type.name] = [];\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tgroup.push(item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tconst menu = Object.keys(keys).map(typeName => {\r\n\t\t\t\t\t\tlet name = 'Button';\r\n\t\t\t\t\t\tswitch (typeName) {\r\n\t\t\t\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\t\t\t\t\tname = 'Waiting Room';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\t\t\t\tname = 'Experience';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\t\t\t\tname = 'Virtual Tour';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\t\t\t\t\tname = 'Stanze 3D';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\t\t\t\tname = 'Modelli 3D';\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\treturn { name, type: { name: 'menu-group' }, items: views.filter(x => x.type.name === typeName && (!x.hidden || editor)) };\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn menu;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic mapMenuItem(item, items) {\r\n\t\tif (item.viewId) {\r\n\t\t\treturn { id: item.viewId, name: item.name, type: { name: 'panorama' } };\r\n\t\t} else {\r\n\t\t\treturn { name: item.name, type: { name: 'menu-group' }, items: this.mapMenuItems(items, item.id) };\r\n\t\t}\r\n\t}\r\n\r\n\tstatic mapMenuItems(items, parentId = null) {\r\n\t\treturn items.filter(item => (item.parentId || null) === parentId ).map(item => this.mapMenuItem(item, items))\r\n\t}\r\n\r\n}\r\n","import { isPlatformBrowser } from 'rxcomp';\r\nimport { combineLatest, EMPTY, from, fromEvent, merge } from 'rxjs';\r\nimport { filter, map, switchMap, tap } from 'rxjs/operators';\r\nimport { Asset } from '../asset/asset';\r\nimport { AssetService } from '../asset/asset.service';\r\n\r\nexport class DropService {\r\n\r\n\tstatic drop$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\tconst body = document.querySelector('body');\r\n\t\t\treturn merge(fromEvent(body, 'drop'), fromEvent(body, 'dragover')).pipe(\r\n\t\t\t\tmap((event) => {\r\n\t\t\t\t\tconsole.log('DropService.drop$', event);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\tif (event.target === input) {\r\n\t\t\t\t\t\tinput.files = event.dataTransfer.files;\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic change$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'change').pipe(\r\n\t\t\t\tfilter((event) => input.files && input.files.length),\r\n\t\t\t\tmap((event) => Array.from(input.files)),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic asset$(input, previews = []) {\r\n\t\treturn this.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tpreviews.length = files.length;\r\n\t\t\t\tpreviews.fill(null);\r\n\t\t\t\t// output.previews = files.map(() => null);\r\n\t\t\t\tconst uploads$ = files.map((file, i) => this.read$(file, i, previews).pipe(\r\n\t\t\t\t\tmap(() => file),\r\n\t\t\t\t\tswitchMap((file) => AssetService.upload$([file])),\r\n\t\t\t\t\tswitchMap((uploads) => {\r\n\t\t\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t\t\t}),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic read$(file, i, previews = []) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\treturn this.resize$(blob);\r\n\t\t\t}),\r\n\t\t\ttap(resized => {\r\n\t\t\t\tpreviews[i] = resized;\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tstatic resize$(blob) {\r\n\t\treturn from(this.resize_(blob));\r\n\t}\r\n\r\n\tstatic resize_(blob) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tresolve(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.onerror = function() {\r\n\t\t\t\treject(blob);\r\n\t\t\t}\r\n\t\t\timg.src = blob;\r\n\t\t});\r\n\t}\r\n}\r\n","import { Component, getContext } from 'rxcomp';\r\n\r\nexport default class ControlComponent extends Component {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log(this, node, this.control);\r\n\t\tconst control = this.control;\r\n\t\tconst flags = control.flags;\r\n\t\tObject.keys(flags).forEach((key) => {\r\n\t\t\tflags[key] ? node.classList.add(key) : node.classList.remove(key);\r\n\t\t});\r\n\t}\r\n}\r\n\r\nControlComponent.meta = {\r\n\tselector: '[control]',\r\n\tinputs: ['control']\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest } from 'rxjs';\r\nimport { switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlAssetComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tDropService.drop$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => AssetService.createOrUpdateAsset$(uploads, this.control)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(assets => {\r\n\t\t\t// console.log('ControlAssetComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n}\r\n\r\nControlAssetComponent.meta = {\r\n\tselector: '[control-asset]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--picture\">\r\n\t\t\t\t<div class=\"group--picture__info\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<img [lazy]=\"control.value | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"control.value && control.value.type.name === 'image'\" />\r\n\t\t\t\t<video [src]=\"control.value | asset\" *if=\"control.value && control.value.type.name === 'video'\"></video>\r\n\t\t\t\t<input type=\"file\">\r\n\t\t\t</div>\r\n\t\t\t<div class=\"file-name\" *if=\"control.value\" [innerHTML]=\"control.value.file\"></div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { FormArray, FormGroup } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport DropdownDirective from '../dropdown/dropdown.directive';\r\nimport EditorService from '../editor/editor.service';\r\nimport MenuService from '../editor/menu/menu.service';\r\nimport ControlAssetComponent from './control-asset.component';\r\n\r\nlet MENU_UID = 0;\r\n\r\nexport default class ControlMenuComponent extends ControlAssetComponent {\r\n\r\n\tstatic itemToFormGroup(item) {\r\n\t\treturn new FormGroup({\r\n\t\t\tid: item.id,\r\n\t\t\tparentId: item.parentId,\r\n\t\t\tviewId: item.viewId,\r\n\t\t\tname: item.name,\r\n\t\t\titems: new FormArray(),\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tstatic newFormGroup(parentId = null) {\r\n\t\treturn new FormGroup({\r\n\t\t\tid: null,\r\n\t\t\tparentId: parentId,\r\n\t\t\tviewId: null,\r\n\t\t\tname: 'Folder ' + (++MENU_UID),\r\n\t\t\titems: new FormArray(),\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\tonInit() {\r\n\t\tthis.dropdownId = DropdownDirective.nextId();\r\n\t\tthis.controls = this.control.controls;\r\n\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(options => {\r\n\t\t\tthis.controls.viewId.options = options;\r\n\t\t});\r\n\t}\r\n\r\n\tonAddItem() {\r\n\t\tMenuService.createMenuItem$(this.controls.id.value, this.controls.items.length).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(item => {\r\n\t\t\tthis.controls.items.push(ControlMenuComponent.itemToFormGroup(item));\r\n\t\t});\r\n\t\t// this.controls.items.push(ControlMenuComponent.newFormGroup(this.controls.id.value));\r\n\t}\r\n\r\n\tonRemoveItem() {\r\n\t\tthis.remove.next(this.control);\r\n\t}\r\n\r\n\tonRemoveControl(control) {\r\n\t\tMenuService.deleteMenuItem$(control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.items.remove(control);\r\n\t\t});\r\n\t\t// this.controls.items.remove(control);\r\n\t}\r\n\r\n\tonLinkItem() {\r\n\t\tthis.link.next(this.control);\r\n\t}\r\n\r\n\tonLinkControl(control) {\r\n\t\tthis.link.next(control);\r\n\t}\r\n\r\n\tonItemUp() {\r\n\t\tthis.up.next(this.control);\r\n\t}\r\n\r\n\tonItemDown() {\r\n\t\tthis.down.next(this.control);\r\n\t}\r\n\r\n\tonUpControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index > 0) {\r\n\t\t\tindex --;\r\n\t\t} else {\r\n\t\t\tindex = length - 1;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonDownControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index < length - 1) {\r\n\t\t\tindex ++;\r\n\t\t} else {\r\n\t\t\tindex = 0;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tsetView(view) {\r\n\t\tconsole.log('ControlMenuComponent.setView', view.id);\r\n\t\tconst payload = Object.assign({}, this.control.value);\r\n\t\tpayload.viewId = view.id;\r\n\t\tif (view.id) {\r\n\t\t\tpayload.name = view.name;\r\n\t\t}\r\n\t\tMenuService.updateMenuItem$(payload).pipe(\r\n\t\t\tfirst()\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.viewId.value = view.id;\r\n\t\t\tif (view.id) {\r\n\t\t\t\tthis.controls.name.value = view.name;\r\n\t\t\t\t// clear sub items\r\n\t\t\t\tthis.controls.items.controls = [];\r\n\t\t\t\tthis.controls.items.switchSubjects_();\r\n\t\t\t}\r\n\t\t\t// this.change.next(value);\r\n\t\t});\r\n\t}\r\n\r\n\tonTextDidChange(event) {\r\n\t\tconsole.log('ControlMenuComponent.onTextDidChange', this.controls.name.value);\r\n\t\tMenuService.updateMenuItem$(this.control.value).pipe(\r\n\t\t\tfirst()\r\n\t\t).subscribe();\r\n\t}\r\n\r\n\thasOption(item) {\r\n\t\treturn this.controls.viewId.value === item.id;\r\n\t}\r\n\r\n\tonDropped(id) {\r\n\t\t// console.log('ControlMenuComponent.onDropped', id);\r\n\t}\r\n\r\n}\r\n\r\nControlMenuComponent.meta = {\r\n\tselector: '[control-menu]',\r\n\toutputs: ['remove', 'link', 'up', 'down'],\r\n\tinputs: ['control'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\">\r\n\t\t\t<button type=\"button\" class=\"control-menu__link\" [class]=\"{ active: control.controls.viewId.value }\" (click)=\"onLinkItem($event)\" [dropdown]=\"dropdownId\" (dropped)=\"onDropped($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#link\"></use></svg>\r\n\t\t\t\t<div class=\"dropdown\" [dropdown-item]=\"dropdownId\">\r\n\t\t\t\t\t<div class=\"category\">View</div>\r\n\t\t\t\t\t<ul class=\"nav--dropdown\">\r\n\t\t\t\t\t\t<li (click)=\"setView(item)\" [class]=\"{ empty: item.id == null }\" *for=\"let item of control.controls.viewId.options\">\r\n\t\t\t\t\t\t\t<span [class]=\"{ active: hasOption(item) }\" [innerHTML]=\"item.name\"></span>\r\n\t\t\t\t\t\t</li>\r\n\t\t\t\t\t</ul>\r\n\t\t\t\t</div>\r\n\t\t\t</button>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control.controls.name\" placeholder=\"Name\" (change)=\"onTextDidChange($event)\" />\r\n\t\t\t<!--\r\n\t\t\t<button type=\"button\" class=\"control-menu__add\" (click)=\"onAddItem($event)\">\r\n\t\t\t\t<span [innerHTML]=\"control.controls.viewId.value\"></span>\r\n\t\t\t</button>\r\n\t\t\t-->\r\n\t\t\t<!--\r\n\t\t\t<select class=\"control--select\" [formControl]=\"control.controls.viewId\">\r\n\t\t\t\t<option [value]=\"item.id\" *for=\"let item of control.controls.viewId.options\" [innerHTML]=\"item.name\"></option>\r\n\t\t\t</select>\r\n\t\t\t-->\r\n\t\t\t<button type=\"button\" class=\"control-menu__up\" (click)=\"onItemUp($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#up\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__down\" (click)=\"onItemDown($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#down\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__add\" (click)=\"onAddItem($event)\" *if=\"!control.controls.viewId.value\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#add\"></use></svg>\r\n\t\t\t</button>\r\n\t\t\t<button type=\"button\" class=\"control-menu__remove\" (click)=\"onRemoveItem($event)\">\r\n\t\t\t\t<svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#remove\"></use></svg>\r\n\t\t\t</button>\r\n\t\t</div>\r\n\t\t<div class=\"group--items\">\r\n\t\t\t<div control-menu *for=\"let sub of control.controls.items.controls\" [control]=\"sub\" (remove)=\"onRemoveControl($event)\" (link)=\"onLinkControl($event)\" (up)=\"onUpControl($event)\" (down)=\"onDownControl($event)\"></div>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormArray, FormGroup } from 'rxcomp-form';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport ControlMenuComponent from '../../forms/control-menu.component';\r\nimport MenuService from './menu.service';\r\n\r\nexport default class MenuBuilderComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.changes = 0;\r\n\t\tthis.form = null;\r\n\t\tMenuService.getMenu$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(menu => this.initForm(menu));\r\n\t}\r\n\r\n\tinitForm(menu = []) {\r\n\t\tconst items = this.menuToControls(menu);\r\n\t\t// console.log('MenuBuilderComponent', items);\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\titems: items,\r\n\t\t});\r\n\t\tconst controls = this.controls = form.controls;\r\n\t\tform.changes$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((changes) => {\r\n\t\t\t// console.log('MenuBuilderComponent', changes);\r\n\t\t\tthis.changes ++;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonLinkControl(control) {\r\n\r\n\t}\r\n\r\n\tonUpControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index > 0) {\r\n\t\t\tindex --;\r\n\t\t} else {\r\n\t\t\tindex = length - 1;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonDownControl(control) {\r\n\t\tconst items = this.controls.items;\r\n\t\tconst length = items.controls.length;\r\n\t\tlet index = items.controls.indexOf(control);\r\n\t\titems.controls.splice(index, 1);\r\n\t\tif (index < length - 1) {\r\n\t\t\tindex ++;\r\n\t\t} else {\r\n\t\t\tindex = 0;\r\n\t\t}\r\n\t\titems.insert(control, index);\r\n\t}\r\n\r\n\tonAddItem() {\r\n\t\tMenuService.createMenuItem$(null, this.controls.items.length).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(item => {\r\n\t\t\tthis.controls.items.push(ControlMenuComponent.itemToFormGroup(item));\r\n\t\t});\r\n\t\t// this.controls.items.push(ControlMenuComponent.newFormGroup());\r\n\t}\r\n\r\n\tonRemoveControl(control) {\r\n\t\tMenuService.deleteMenuItem$(control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.controls.items.remove(control);\r\n\t\t});\r\n\t\t// this.controls.items.remove(control);\r\n\t}\r\n\r\n\tisValid() {\r\n\t\tconst isValid = this.form.valid;\r\n\t\treturn isValid;\r\n\t}\r\n\r\n\tonSubmit(event) {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst changes = this.form.value;\r\n\t\t\tconst menu = this.controlsToMenu(changes);\r\n\t\t\tMenuService.updateMenu$(menu);\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tmenuToControls(menu, parentId = null) {\r\n\t\tconst items = new FormArray(menu.filter(x => {\r\n\t\t\treturn (x.parentId || null) === parentId;\r\n\t\t}).map(x => {\r\n\t\t\tconst subitems = this.menuToControls(menu, x.id);\r\n\t\t\treturn new FormGroup({\r\n\t\t\t\tid: x.id,\r\n\t\t\t\tparentId: x.parentId,\r\n\t\t\t\tviewId: x.viewId,\r\n\t\t\t\tname: x.name,\r\n\t\t\t\titems: subitems,\r\n\t\t\t});\r\n\t\t}))\r\n\t\treturn items;\r\n\t}\r\n\r\n\tcontrolsToMenu(changes) {\r\n\t\tconst menu = [];\r\n\t\tconst pushItem = (items) => {\r\n\t\t\tif (items) {\r\n\t\t\t\titems.forEach((item, i) => {\r\n\t\t\t\t\tconst menuItem = Object.assign({}, item);\r\n\t\t\t\t\tmenuItem.order = i * 10;\r\n\t\t\t\t\tdelete menuItem.items;\r\n\t\t\t\t\tmenu.push(menuItem);\r\n\t\t\t\t\tpushItem(item.items);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t\tpushItem(changes.items);\r\n\t\treturn menu;\r\n\t}\r\n\r\n}\r\n\r\nMenuBuilderComponent.meta = {\r\n\tselector: '[menu-builder]',\r\n\tinputs: ['views'],\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class CurvedPlaneModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tobject.position.copy(this.position);\r\n\t\tobject.lookAt(CurvedPlaneModalComponent.ORIGIN);\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.CurvedPlane,\r\n\t\t\tposition: new FormControl(this.position.multiplyScalar(20).toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([1, 1, 1], RequiredValidator()),\r\n\t\t\tradius: new FormControl(35, RequiredValidator()),\r\n\t\t\theight: new FormControl(20, RequiredValidator()),\r\n\t\t\tarc: new FormControl(90, RequiredValidator()),\r\n\t\t\tasset: null,\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('CurvedPlaneModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\tconsole.log('CurvedPlaneModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('CurvedPlaneModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('CurvedPlaneModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nCurvedPlaneModalComponent.ORIGIN = new THREE.Vector3();\r\n\r\nCurvedPlaneModalComponent.meta = {\r\n\tselector: '[curved-plane-modal]'\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class ItemModelModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t/*\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tobject.position.copy(this.position);\r\n\t\tobject.lookAt(ItemModelModalComponent.ORIGIN);\r\n\t\t*/\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Model,\r\n\t\t\tposition: new FormControl(this.position.multiplyScalar(4).toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl([0, 0, 0], RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\t// rotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([1, 1, 1], RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('ItemModelModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\tconsole.log('ItemModelModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('ItemModelModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('ItemModelModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nItemModelModalComponent.ORIGIN = new THREE.Vector3();\r\n\r\nItemModelModalComponent.meta = {\r\n\tselector: '[item-model-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first, map, switchMap } from 'rxjs/operators';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class ModelModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.Model,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t\tmodel: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('ModelModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: values.type,\r\n\t\t\t\tname: values.name,\r\n\t\t\t\tasset: values.asset,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\tconsole.log('ModelModalComponent.onSubmit.view', view);\r\n\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\tswitchMap(view => {\r\n\t\t\t\t\tconst item = {\r\n\t\t\t\t\t\ttype: ViewItemType.Model,\r\n\t\t\t\t\t\tasset: values.model,\r\n\t\t\t\t\t};\r\n\t\t\t\t\treturn EditorService.itemCreate$(view, item).pipe(\r\n\t\t\t\t\t\tmap(item => {\r\n\t\t\t\t\t\t\tview.items = [item];\r\n\t\t\t\t\t\t\treturn view;\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t);\r\n\t\t\t\t}),\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('ModelModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('ModelModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nModelModalComponent.meta = {\r\n\tselector: '[model-modal]'\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class NavModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Nav,\r\n\t\t\ttitle: null,\r\n\t\t\tabstract: null,\r\n\t\t\tviewId: new FormControl(null, RequiredValidator()),\r\n\t\t\tkeepOrientation: false,\r\n\t\t\tposition: this.position.toArray(),\r\n\t\t\tasset: null,\r\n\t\t\tlink: new FormGroup({\r\n\t\t\t\ttitle: new FormControl(null),\r\n\t\t\t\thref: new FormControl(null),\r\n\t\t\t\ttarget: '_blank',\r\n\t\t\t}),\r\n\t\t\t// upload: new FormControl(null, RequiredValidator()),\r\n\t\t\t// items: new FormArray([null, null, null], RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\t/*\r\n\t\tthis.controls.viewId.options = [{\r\n\t\t\tname: \"Name\",\r\n\t\t\tid: 2,\r\n\t\t}];\r\n\t\t*/\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('NavModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(options => {\r\n\t\t\tthis.controls.viewId.options = options;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\titem.viewId = parseInt(item.viewId);\r\n\t\t\tif (item.link && (!item.link.title || !item.link.href)) {\r\n\t\t\t\titem.link = null;\r\n\t\t\t}\r\n\t\t\t// console.log('NavModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('NavModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('NavModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.submitted = false;\r\n\t\t\t\t// this.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nNavModalComponent.meta = {\r\n\tselector: '[nav-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { PanoramaGridView, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class PanoramaGridModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.PanoramaGrid,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tassets: new FormControl(null, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PanoramaGridModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit', this.form.value);\r\n\t\t\tconst assets = this.form.value.assets;\r\n\t\t\tconst tiles = PanoramaGridView.mapTiles(assets.map(asset => ({\r\n\t\t\t\tasset,\r\n\t\t\t\tnavs: [],\r\n\t\t\t})), false, true);\r\n\t\t\ttiles.sort((a, b) => {\r\n\t\t\t\tconst ai = a.indices.x * 10000 + a.indices.y;\r\n\t\t\t\tconst bi = b.indices.x * 10000 + b.indices.y;\r\n\t\t\t\treturn ai - bi;\r\n\t\t\t});\r\n\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit', tiles);\r\n\t\t\tconst asset = tiles[0].asset;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: this.form.value.type,\r\n\t\t\t\tname: this.form.value.name,\r\n\t\t\t\tasset,\r\n\t\t\t\ttiles: tiles,\r\n\t\t\t\tinvertAxes: true,\r\n\t\t\t\tflipAxes: false,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\tEditorService.viewCreate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaGridModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nPanoramaGridModalComponent.meta = {\r\n\tselector: '[panorama-grid-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class PanoramaModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.error = null;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewType.Panorama,\r\n\t\t\tname: new FormControl(null, RequiredValidator()),\r\n\t\t\tasset: new FormControl(null, RequiredValidator()),\r\n\t\t\t// upload: new FormControl(null, RequiredValidator()),\r\n\t\t\t// items: new FormArray([null, null, null], RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PanoramaModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tthis.form.submitted = true;\r\n\t\t\tconst values = this.form.value;\r\n\t\t\tconst view = {\r\n\t\t\t\ttype: values.type,\r\n\t\t\t\tname: values.name,\r\n\t\t\t\tasset: values.asset,\r\n\t\t\t\torientation: {\r\n\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\tlongitude: 0\r\n\t\t\t\t},\r\n\t\t\t\tzoom: 75\r\n\t\t\t};\r\n\t\t\tconsole.log('PanoramaModalComponent.onSubmit.view', view);\r\n\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tconst asset = Asset.fromUrl(this.form.value.upload);\r\n\t\t\tconsole.log('PanoramaModalComponent.onSubmit.asset', asset);\r\n\t\t\tAssetService.assetCreate$(asset).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t\tswitchMap(response => {\r\n\t\t\t\t\tconst view = {\r\n\t\t\t\t\t\ttype: this.form.value.type,\r\n\t\t\t\t\t\tname: this.form.value.name,\r\n\t\t\t\t\t\tasset: response,\r\n\t\t\t\t\t\torientation: {\r\n\t\t\t\t\t\t\tlatitude: 0,\r\n\t\t\t\t\t\t\tlongitude: 0\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tzoom: 75\r\n\t\t\t\t\t};\r\n\t\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.view', view);\r\n\t\t\t\t\treturn EditorService.viewCreate$(view).pipe(\r\n\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t);\r\n\t\t\t\t})\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('PanoramaModalComponent.onSubmit.error', error);\r\n\t\t\t\tthis.error = error;\r\n\t\t\t\tthis.form.reset();\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\tEditorService.viewCreate$({\r\n\t\t\t\"id\": 1,\r\n\t\t\t\"type\": \"panorama\",\r\n\t\t\t\"name\": \"Welcome Room\",\r\n\t\t\t\"likes\": 134,\r\n\t\t\t\"liked\": false,\r\n\t\t\t\"asset\": {\r\n\t\t\t\t\"type\": \"image\",\r\n\t\t\t\t\"folder\": \"waiting-room/\",\r\n\t\t\t\t\"file\": \"mod2.jpg\"\r\n\t\t\t},\r\n\t\t\t\"items\": [\r\n\t\t\t\t{\r\n\t\t\t\t\t\"id\": 110,\r\n\t\t\t\t\t\"type\": \"nav\",\r\n\t\t\t\t\t\"title\": \"Barilla Experience\",\r\n\t\t\t\t\t\"abstract\": \"Abstract\",\r\n\t\t\t\t\t\"asset\": {\r\n\t\t\t\t\t\t\"type\": \"image\",\r\n\t\t\t\t\t\t\"folder\": \"barilla/\",\r\n\t\t\t\t\t\t\"file\": \"logo-barilla.jpg\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"link\": {\r\n\t\t\t\t\t\t\"title\": \"Scopri di più...\",\r\n\t\t\t\t\t\t\"href\": \"https://www.barilla.com/it-it/\",\r\n\t\t\t\t\t\t\"target\": \"_blank\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"position\": [\r\n\t\t\t\t\t\t0.9491595148619703,\r\n\t\t\t\t\t\t-0.3147945860255039,\r\n\t\t\t\t\t\t0\r\n\t\t\t\t\t],\r\n\t\t\t\t\t\"viewId\": 23\r\n\t\t\t\t}\r\n\t\t\t],\r\n\t\t\t\"orientation\": {\r\n\t\t\t\t\"latitude\": -10,\r\n\t\t\t\t\"longitude\": 360\r\n\t\t\t},\r\n\t\t\t\"zoom\": 75\r\n\t\t}).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(data => {\r\n\t\t\tconsole.log('EditorService.viewCreate$', data);\r\n\t\t});\r\n\t\t\t*/\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nPanoramaModalComponent.meta = {\r\n\tselector: '[panorama-modal]'\r\n};\r\n\r\n/*\r\n{\r\n\t\"id\": 1,\r\n\t\"type\": \"panorama\",\r\n\t\"name\": \"Welcome Room\",\r\n\t\"likes\": 134,\r\n\t\"liked\": false,\r\n\t\"asset\": {\r\n\t\t\"type\": \"image\",\r\n\t\t\"folder\": \"waiting-room/\",\r\n\t\t\"file\": \"mod2.jpg\"\r\n\t},\r\n\t\"items\": [{\r\n\t\t\"id\": 110,\r\n\t\t\"type\": \"nav\",\r\n\t\t\"title\": \"Barilla Experience\",\r\n\t\t\"abstract\": \"Abstract\",\r\n\t\t\"asset\": {\r\n\t\t\t\"type\": \"image\",\r\n\t\t\t\"folder\": \"barilla/\",\r\n\t\t\t\"file\": \"logo-barilla.jpg\"\r\n\t\t},\r\n\t\t\"link\": {\r\n\t\t\t\"title\": \"Scopri di più...\",\r\n\t\t\t\"href\": \"https://www.barilla.com/it-it/\",\r\n\t\t\t\"target\": \"_blank\"\r\n\t\t},\r\n\t\t\"position\": [0.9491595148619703,-0.3147945860255039,0],\r\n\t\t\"viewId\": 23\r\n\t}],\r\n\t\"orientation\": {\r\n\t\t\"latitude\": -10,\r\n\t\t\"longitude\": 360\r\n\t},\r\n\t\"zoom\": 75\r\n}\r\n*/\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { first } from 'rxjs/operators';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\nimport { ViewItemType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class PlaneModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget view() {\r\n\t\tlet view = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tview = data.view;\r\n\t\t}\r\n\t\treturn view;\r\n\t}\r\n\r\n\tget position() {\r\n\t\tlet position = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\tposition = data.position;\r\n\t\t}\r\n\t\treturn position;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tconst object = new THREE.Object3D();\r\n\t\tobject.position.copy(this.position);\r\n\t\tobject.lookAt(PlaneModalComponent.ORIGIN);\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\ttype: ViewItemType.Plane,\r\n\t\t\tposition: new FormControl(this.position.multiplyScalar(20).toArray(), RequiredValidator()),\r\n\t\t\trotation: new FormControl(object.rotation.toArray(), RequiredValidator()), // [0, -Math.PI / 2, 0],\r\n\t\t\tscale: new FormControl([12, 6.75, 1], RequiredValidator()),\r\n\t\t\tasset: null,\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('PlaneModalComponent.form.changes$', changes, form.valid, form);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (this.form.valid) {\r\n\t\t\tconst item = Object.assign({}, this.form.value);\r\n\t\t\t// item.viewId = parseInt(item.viewId);\r\n\t\t\tconsole.log('PlaneModalComponent.onSubmit', this.view, item);\r\n\t\t\tEditorService.inferItemCreate$(this.view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\tconsole.log('PlaneModalComponent.onSubmit.success', response);\r\n\t\t\t\tModalService.resolve(response);\r\n\t\t\t}, error => console.log('PlaneModalComponent.onSubmit.error', error));\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nPlaneModalComponent.ORIGIN = new THREE.Vector3();\r\n\r\nPlaneModalComponent.meta = {\r\n\tselector: '[plane-modal]'\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from '../../modal/modal-outlet.component';\r\nimport ModalService from '../../modal/modal.service';\r\n\r\nexport default class RemoveModalComponent extends Component {\r\n\r\n\tget data() {\r\n\t\tlet data = null;\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tdata = parentInstance.modal.data;\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\r\n\tget item() {\r\n\t\tlet item = null;\r\n\t\tconst data = this.data;\r\n\t\tif (data) {\r\n\t\t\titem = data.item;\r\n\t\t}\r\n\t\treturn item;\r\n\t}\r\n\r\n\tonRemove() {\r\n\t\tModalService.resolve();\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nRemoveModalComponent.meta = {\r\n\tselector: '[remove-modal]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { of } from 'rxjs';\r\nimport { first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetGroupType, assetGroupTypeFromItem, assetPayloadFromGroupTypeId } from '../../asset/asset';\r\nimport { AssetService } from '../../asset/asset.service';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport ModalService, { ModalResolveEvent } from '../../modal/modal.service';\r\nimport { ViewItem, ViewItemType, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class UpdateViewItemComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tthis.active = false;\r\n\t\tconst form = this.form = new FormGroup();\r\n\t\tthis.controls = form.controls;\r\n\t\tconst item = this.item;\r\n\t\tthis.originalItem = Object.assign({}, item);\r\n\t\titem.hasChromaKeyColor = (item.asset && item.asset.chromaKeyColor) ? true : false;\r\n\t\titem.assetType = assetGroupTypeFromItem(item).id;\r\n\t\tthis.doUpdateForm();\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewItemComponent.form.changes$', changes);\r\n\t\t\tthis.doUpdateItem(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tgetAssetDidChange(changes) {\r\n\t\tconst item = this.item;\r\n\t\t// console.log('UpdateViewItemComponent.getAssetDidChange', item, changes);\r\n\t\tconst itemHasChromaKeyColor = item.hasChromaKeyColor === true;\r\n\t\tconst changesHasChromaKeyColor = changes.hasChromaKeyColor === true;\r\n\t\tif (AssetService.assetDidChange(item.asset, changes.asset) ||\r\n\t\t\titemHasChromaKeyColor !== changesHasChromaKeyColor) {\r\n\t\t\treturn true;\r\n\t\t} else {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateItem(changes) {\r\n\t\tconst item = this.item;\r\n\t\tconst assetDidChange = this.getAssetDidChange(changes);\r\n\t\t// console.log('doUpdateItem.assetDidChange', assetDidChange);\r\n\t\tObject.assign(item, changes);\r\n\t\tif (item.asset) {\r\n\t\t\titem.asset.chromaKeyColor = item.hasChromaKeyColor ? [0.0, 1.0, 0.0] : null;\r\n\t\t}\r\n\t\tif (assetDidChange) {\r\n\t\t\tconst asset$ = item.asset ? AssetService.assetUpdate$(item.asset) : of(null);\r\n\t\t\tasset$.pipe(\r\n\t\t\t\tswitchMap(() => EditorService.inferItemUpdate$(this.view, item)),\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe();\r\n\t\t\t// !!! create indices for nextAttendeeStream\r\n\t\t\tthis.view.updateIndices(this.view.items);\r\n\t\t\tif (typeof item.onUpdateAsset === 'function') {\r\n\t\t\t\titem.onUpdateAsset();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (typeof item.onUpdate === 'function') {\r\n\t\t\titem.onUpdate();\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateForm() {\r\n\t\tconst item = this.item;\r\n\t\tconst form = this.form;\r\n\t\tif (!this.type || this.type.name !== item.type.name) {\r\n\t\t\tthis.type = item.type;\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tform.removeKey(key);\r\n\t\t\t});\r\n\t\t\tlet keys;\r\n\t\t\tswitch (item.type.name) {\r\n\t\t\t\tcase ViewItemType.Nav.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'title?', 'abstract?', 'viewId', 'keepOrientation?', 'position', 'asset?', 'link?'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Plane.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'scale', 'assetType?', 'asset?', 'hasChromaKeyColor?'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.CurvedPlane.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'scale', 'radius', 'height', 'arc', 'assetType?', 'asset?', 'hasChromaKeyColor?'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Texture.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'assetType?', 'asset?', 'hasChromaKeyColor?']; // asset, key no id!!\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewItemType.Model.name:\r\n\t\t\t\t\tif (this.view.type.name === ViewType.Model) {\r\n\t\t\t\t\t\tkeys = ['id', 'type', 'asset?'];\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tkeys = ['id', 'type', 'position', 'rotation', 'asset?'];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tkeys = ['id', 'type'];\r\n\t\t\t}\r\n\t\t\tkeys.forEach(key => {\r\n\t\t\t\tconst optional = key.indexOf('?') !== -1;\r\n\t\t\t\tkey = key.replace('?', '');\r\n\t\t\t\tconst value = (item[key] != null ? item[key] : null);\r\n\t\t\t\tlet control;\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'viewId':\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t\t\tEditorService.viewIdOptions$().pipe(\r\n\t\t\t\t\t\t\tfirst(),\r\n\t\t\t\t\t\t).subscribe(options => {\r\n\t\t\t\t\t\t\tcontrol.options = options;\r\n\t\t\t\t\t\t\tcontrol.value = control.value || null;\r\n\t\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'assetType':\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t\t\tcontrol.options = Object.keys(AssetGroupType).map(x => AssetGroupType[x]);\r\n\t\t\t\t\t\t// console.log(control.options);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'link':\r\n\t\t\t\t\t\tconst title = item.link ? item.link.title : null;\r\n\t\t\t\t\t\tconst href = item.link ? item.link.href : null;\r\n\t\t\t\t\t\tconst target = '_blank';\r\n\t\t\t\t\t\tcontrol = new FormGroup({\r\n\t\t\t\t\t\t\ttitle: new FormControl(title),\r\n\t\t\t\t\t\t\thref: new FormControl(href),\r\n\t\t\t\t\t\t\ttarget\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tcontrol = new FormControl(value, optional ? undefined : RequiredValidator());\r\n\t\t\t\t}\r\n\t\t\t\tform.add(control, key);\r\n\t\t\t});\r\n\t\t\tthis.controls = form.controls;\r\n\t\t} else {\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'link':\r\n\t\t\t\t\t\tconst title = item.link ? item.link.title : null;\r\n\t\t\t\t\t\tconst href = item.link ? item.link.href : null;\r\n\t\t\t\t\t\tconst target = '_blank';\r\n\t\t\t\t\t\tthis.controls[key].value = { title, href, target };\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'hasChromaKeyColor':\r\n\t\t\t\t\t\tthis.controls[key].value = (item.asset && item.asset.chromaKeyColor) ? true : false;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'assetType':\r\n\t\t\t\t\t\tthis.controls[key].value = assetGroupTypeFromItem(item).id;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tthis.controls[key].value = (item[key] != null ? item[key] : null);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonAssetTypeDidChange(assetType) {\r\n\t\tconst item = this.item;\r\n\t\tconst currentType = assetGroupTypeFromItem(item).id;\r\n\t\t// console.log('UpdateViewItemComponent.onAssetTypeDidChange', assetType, currentType);\r\n\t\tif (assetType !== currentType) {\r\n\t\t\titem.assetType = assetType;\r\n\t\t\tlet asset$ = of(null); // AssetService.assetDelete$(item.asset);\r\n\t\t\tif (assetType !== AssetGroupType.ImageOrVideo.id) {\r\n\t\t\t\tasset$ = asset$.pipe(\r\n\t\t\t\t\tswitchMap(() => {\r\n\t\t\t\t\t\tconst asset = assetPayloadFromGroupTypeId(assetType);\r\n\t\t\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t\t\t}),\r\n\t\t\t\t)\r\n\t\t\t}\r\n\t\t\tasset$.pipe(\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe(asset => {\r\n\t\t\t\t// console.log('UpdateViewItemComponent.asset$', asset);\r\n\t\t\t\tthis.controls.asset.value = asset;\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tasset$.pipe(\r\n\t\t\t\ttap(asset => {\r\n\t\t\t\t\titem.asset = asset;\r\n\t\t\t\t\tif (typeof item.onUpdateAsset === 'function') {\r\n\t\t\t\t\t\titem.onUpdateAsset();\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t\tswitchMap(() => EditorService.inferItemUpdate$(this.view, item)),\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe();\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\t// console.log('UpdateViewItemComponent.onChanges', changes);\r\n\t\tthis.doUpdateForm();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst changes = this.form.value;\r\n\t\t\tconst payload = Object.assign({}, changes);\r\n\t\t\tconst view = this.view;\r\n\t\t\tconst item = new ViewItem(payload);\r\n\t\t\tEditorService.inferItemUpdate$(view, item).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('UpdateViewItemComponent.onSubmit.inferItemUpdate$.success', response);\r\n\t\t\t\tEditorService.inferItemUpdateResult$(view, item);\r\n\t\t\t\tthis.update.next({ view, item });\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.busy = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 300);\r\n\t\t\t}, error => console.log('UpdateViewItemComponent.onSubmit.inferItemUpdate$.error', error));\r\n\t\t\t// this.update.next({ view: this.view, item: new ViewItem(payload) });\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ src: environment.template.modal.remove, data: { item: this.item } }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view, item: this.item });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view, item: this.item.selected ? null : this.item });\r\n\t\t/*\r\n\t\tthis.item.active = !this.item.active;\r\n\t\tthis.pushChanges();\r\n\t\t*/\r\n\t}\r\n\r\n\tgetTitle(item) {\r\n\t\treturn LabelPipe.getKeys('editor', item.type.name);\r\n\t}\r\n}\r\n\r\nUpdateViewItemComponent.meta = {\r\n\tselector: 'update-view-item',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view', 'item'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: item.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<!-- <div class=\"id\" [innerHTML]=\"item.id\"></div> -->\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon [name]=\"item.type.name\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\" [innerHTML]=\"getTitle(item)\"></div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"item.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<!-- <div control-text [control]=\"controls.type\" label=\"Type\" [disabled]=\"true\"></div> -->\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'nav'\">\r\n\t\t\t\t<div control-text [control]=\"controls.title\" label=\"Title\"></div>\r\n\t\t\t\t<div control-textarea [control]=\"controls.abstract\" label=\"Abstract\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.viewId\" label=\"NavToView\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.keepOrientation\" label=\"Keep Orientation\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"3\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg, image/png\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.link.controls.title\" label=\"Link Title\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.link.controls.href\" label=\"Link Url\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'plane'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"1\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Localized Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'curved-plane'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"1\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\"></div>\r\n\t\t\t\t<!-- <div control-vector [control]=\"controls.scale\" label=\"Scale\" [precision]=\"2\" [disabled]=\"true\"></div> -->\r\n\t\t\t\t<div control-number [control]=\"controls.radius\" label=\"Radius\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-number [control]=\"controls.height\" label=\"Height\" [precision]=\"2\"></div>\r\n\t\t\t\t<div control-number [control]=\"controls.arc\" label=\"Arc\" [precision]=\"0\"></div>\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'model'\">\r\n\t\t\t\t<div control-vector [control]=\"controls.position\" label=\"Position\" [precision]=\"1\" *if=\"view.type.name !== 'model'\"></div>\r\n\t\t\t\t<div control-vector [control]=\"controls.rotation\" label=\"Rotation\" [precision]=\"3\" [increment]=\"Math.PI / 360\" *if=\"view.type.name !== 'model'\"></div>\r\n\t\t\t\t<div control-model [control]=\"controls.asset\" label=\"Model (.glb)\" accept=\".glb\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"item.type.name == 'texture'\">\r\n\t\t\t\t<div control-custom-select [control]=\"controls.assetType\" label=\"Asset\" (change)=\"onAssetTypeDidChange($event)\"></div>\r\n\t\t\t\t<div control-localized-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\" *if=\"controls.assetType.value == 1\"></div>\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hasChromaKeyColor\" label=\"Use Green Screen\" *if=\"item.asset\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport ModalService, { ModalResolveEvent } from '../../modal/modal.service';\r\n\r\nexport default class UpdateViewTileComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tthis.active = false;\r\n\t\tconst form = this.form = new FormGroup({\r\n\t\t\tid: new FormControl(this.tile.id, RequiredValidator()),\r\n\t\t\tasset: new FormControl(this.tile.asset, RequiredValidator()),\r\n\t\t\tnavs: new FormControl(this.tile.navs, RequiredValidator()),\r\n\t\t});\r\n\t\tthis.controls = form.controls;\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewTileComponent.form.changes$', changes);\r\n\t\t\tconst tile = this.tile;\r\n\t\t\tObject.assign(tile, changes);\r\n\t\t\tif (typeof tile.onUpdate === 'function') {\r\n\t\t\t\ttile.onUpdate();\r\n\t\t\t}\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tconsole.log('UpdateViewTileComponent.onInit', this.view, this.tile);\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst payload = Object.assign({}, this.form.value);\r\n\t\t\tconst view = this.view;\r\n\t\t\tconst tile = payload;\r\n\t\t\t/*\r\n\t\t\tEditorService.tileUpdate$...\r\n\t\t\t*/\r\n\t\t\tthis.update.next({ view, tile });\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.busy = false;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t}, 300);\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ src: environment.template.modal.remove, data: { tile: this.tile } }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view, tile: this.tile });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view, tile: this.tile.selected ? null : this.tile });\r\n\t}\r\n}\r\n\r\nUpdateViewTileComponent.meta = {\r\n\tselector: 'update-view-tile',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view', 'tile'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: tile.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon name=\"tile\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\">Tile {{tile.id}}</div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"tile.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg, image/png\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<!--\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t-->\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { FormControl, FormGroup, RequiredValidator } from 'rxcomp-form';\r\nimport { auditTime, distinctUntilChanged, filter, first, takeUntil } from 'rxjs/operators';\r\nimport { MessageType } from '../../agora/agora.types';\r\nimport { AssetService } from '../../asset/asset.service';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport MessageService from '../../message/message.service';\r\nimport ModalService, { ModalResolveEvent } from '../../modal/modal.service';\r\nimport { View, ViewType } from '../../view/view';\r\nimport EditorService from '../editor.service';\r\n\r\nexport default class UpdateViewComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.busy = false;\r\n\t\tconst form = this.form = new FormGroup();\r\n\t\tthis.controls = form.controls;\r\n\t\tthis.doUpdateForm();\r\n\t\tform.changes$.subscribe((changes) => {\r\n\t\t\t// console.log('UpdateViewComponent.form.changes$', changes);\r\n\t\t\tthis.doUpdateView(changes);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tthis.orbit$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\tswitch (this.view.type.name) {\r\n\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\tthis.form.patch({\r\n\t\t\t\t\t\tlatitude: message.orientation.latitude,\r\n\t\t\t\t\t\tlongitude: message.orientation.longitude,\r\n\t\t\t\t\t\tzoom: message.zoom,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\torbit$() {\r\n\t\tlet latitude, longitude, zoom = null;\r\n\t\treturn MessageService.in$.pipe(\r\n\t\t\tfilter(message => message.type === MessageType.ControlInfo),\r\n\t\t\tauditTime(65),\r\n\t\t\tdistinctUntilChanged((previous, current) => {\r\n\t\t\t\tconst didChange = (latitude !== current.orientation.latitude ||\r\n\t\t\t\t\tlongitude !== current.orientation.longitude ||\r\n\t\t\t\t\tzoom !== current.zoom);\r\n\t\t\t\tlatitude = current.orientation.latitude;\r\n\t\t\t\tlongitude = current.orientation.longitude;\r\n\t\t\t\tzoom = current.zoom;\r\n\t\t\t\treturn !didChange;\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tgetAssetDidChange(changes) {\r\n\t\tconst view = this.view;\r\n\t\tconst assetDidChange = AssetService.assetDidChange(view.asset, changes.asset);\r\n\t\tconst usdzDidChange = AssetService.assetDidChange(view.ar ? view.ar.usdz : null, changes.usdz);\r\n\t\tconst gltfDidChange = AssetService.assetDidChange(view.ar ? view.ar.gltf : null, changes.gltf);\r\n\t\tif (assetDidChange || usdzDidChange || gltfDidChange) {\r\n\t\t\t// console.log('UpdateViewComponent.getAssetDidChange', assetDidChange, usdzDidChange, gltfDidChange);\r\n\t\t\treturn true;\r\n\t\t} else {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateView(changes) {\r\n\t\tconst assetDidChange = this.getAssetDidChange(changes);\r\n\t\t// console.log('doUpdateItem.assetDidChange', assetDidChange);\r\n\t\tif (assetDidChange) {\r\n\t\t\tthis.onSubmit();\r\n\t\t}\r\n\t}\r\n\r\n\tdoUpdateForm() {\r\n\t\tconst view = this.view;\r\n\t\tif (!this.type || this.type.name !== view.type.name) {\r\n\t\t\tthis.type = view.type;\r\n\t\t\tconst form = this.form;\r\n\t\t\tObject.keys(this.controls).forEach(key => {\r\n\t\t\t\tform.removeKey(key);\r\n\t\t\t});\r\n\t\t\tlet keys;\r\n\t\t\tswitch (view.type.name) {\r\n\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name', 'hidden?', 'latitude', 'longitude', 'zoom', 'asset'];\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tkeys = ['id', 'type', 'name'];\r\n\t\t\t}\r\n\t\t\tif (view.type.name !== ViewType.WaitingRoom.name && environment.flags.ar) {\r\n\t\t\t\tkeys.push('usdz?');\r\n\t\t\t\tkeys.push('gltf?');\r\n\t\t\t}\r\n\t\t\tkeys.forEach(key => {\r\n\t\t\t\tconst optional = key.indexOf('?') !== -1;\r\n\t\t\t\tkey = key.replace('?', '');\r\n\t\t\t\tswitch (key) {\r\n\t\t\t\t\tcase 'latitude':\r\n\t\t\t\t\tcase 'longitude':\r\n\t\t\t\t\t\tconst orientation = view.orientation || { latitude: 0, longitude: 0 };\r\n\t\t\t\t\t\tform.add(new FormControl(orientation[key], RequiredValidator()), key);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'usdz':\r\n\t\t\t\t\tcase 'gltf':\r\n\t\t\t\t\t\tform.add(new FormControl((view.ar ? (view.ar[key] || null) : null), optional ? undefined : RequiredValidator()), key);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\tform.add(new FormControl((view[key] != null ? view[key] : null), optional ? undefined : RequiredValidator()), key);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.controls = form.controls;\r\n\t\t}\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\tthis.doUpdateForm();\r\n\t}\r\n\r\n\tonSubmit() {\r\n\t\tif (!this.busy && this.form.valid) {\r\n\t\t\tthis.busy = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tconst payload = Object.assign({}, this.view, this.form.value);\r\n\t\t\tif (payload.latitude != null) { // !!! keep loose inequality\r\n\t\t\t\tpayload.orientation = {\r\n\t\t\t\t\tlatitude: payload.latitude,\r\n\t\t\t\t\tlongitude: payload.longitude,\r\n\t\t\t\t};\r\n\t\t\t\tdelete payload.latitude;\r\n\t\t\t\tdelete payload.longitude;\r\n\t\t\t}\r\n\t\t\tconst usdz = payload.usdz || null;\r\n\t\t\tconst gltf = payload.gltf || null;\r\n\t\t\tdelete payload.usdz;\r\n\t\t\tdelete payload.gltf;\r\n\t\t\tpayload.ar = (usdz || gltf) ? { usdz, gltf } : null;\r\n\t\t\tconst view = new View(payload);\r\n\t\t\tEditorService.viewUpdate$(view).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t).subscribe(response => {\r\n\t\t\t\t// console.log('UpdateViewComponent.onSubmit.viewUpdate$.success', response);\r\n\t\t\t\tthis.update.next({ view });\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.busy = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 300);\r\n\t\t\t}, error => console.log('UpdateViewComponent.onSubmit.viewUpdate$.error', error));\r\n\t\t\t// this.update.next({ view: new View(payload) });\r\n\t\t} else {\r\n\t\t\tthis.form.touched = true;\r\n\t\t}\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tModalService.open$({ src: environment.template.modal.remove, data: { item: this.item } }).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(event => {\r\n\t\t\tif (event instanceof ModalResolveEvent) {\r\n\t\t\t\tthis.delete.next({ view: this.view });\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonSelect(event) {\r\n\t\tthis.select.next({ view: this.view.selected ? null : this.view });\r\n\t}\r\n\r\n\tgetTitle(view) {\r\n\t\treturn LabelPipe.getKeys('editor', view.type.name);\r\n\t}\r\n}\r\n\r\nUpdateViewComponent.meta = {\r\n\tselector: 'update-view',\r\n\toutputs: ['select', 'update', 'delete'],\r\n\tinputs: ['view'],\r\n\ttemplate: /* html */`\r\n\t\t<div class=\"group--headline\" [class]=\"{ active: view.selected }\" (click)=\"onSelect($event)\">\r\n\t\t\t<!-- <div class=\"id\" [innerHTML]=\"view.id\"></div> -->\r\n\t\t\t<div class=\"icon\">\r\n\t\t\t\t<svg-icon [name]=\"view.type.name\"></svg-icon>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"title\" [innerHTML]=\"getTitle(view)\"></div>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<form [formGroup]=\"form\" (submit)=\"onSubmit()\" name=\"form\" role=\"form\" novalidate autocomplete=\"off\" *if=\"view.selected\">\r\n\t\t\t<div class=\"form-controls\">\r\n\t\t\t\t<div control-text [control]=\"controls.id\" label=\"Id\" [disabled]=\"true\"></div>\r\n\t\t\t\t<!-- <div control-text [control]=\"controls.type\" label=\"Type\" [disabled]=\"true\"></div> -->\r\n\t\t\t\t<div control-text [control]=\"controls.name\" label=\"Name\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'waiting-room'\">\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'panorama'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image or Video\" accept=\"image/jpeg, video/mp4\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'panorama-grid'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name == 'model'\">\r\n\t\t\t\t<div control-checkbox [control]=\"controls.hidden\" label=\"Hide from menu\"></div>\r\n\t\t\t\t<div control-asset [control]=\"controls.asset\" label=\"Image\" accept=\"image/jpeg\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.latitude\" label=\"Latitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.longitude\" label=\"Longitude\" [disabled]=\"true\"></div>\r\n\t\t\t\t<div control-text [control]=\"controls.zoom\" label=\"Zoom\" [disabled]=\"true\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"form-controls\" *if=\"view.type.name != 'waiting-room' && ('ar' | flag)\">\r\n\t\t\t\t<div control-model [control]=\"controls.usdz\" label=\"AR IOS (.usdz)\" accept=\".usdz\"></div>\r\n\t\t\t\t<div control-model [control]=\"controls.gltf\" label=\"AR Android (.glb)\" accept=\".glb\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<button type=\"submit\" class=\"btn--update\" [class]=\"{ busy: busy }\">\r\n\t\t\t\t\t<span [innerHTML]=\"'update' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t\t<button type=\"button\" class=\"btn--remove\" *if=\"view.type.name != 'waiting-room'\" (click)=\"onRemove($event)\">\r\n\t\t\t\t\t<span [innerHTML]=\"'remove' | label\"></span>\r\n\t\t\t\t</button>\r\n\t\t\t</div>\r\n\t\t</form>\r\n\t`,\r\n};\r\n","import { Module } from 'rxcomp';\r\nimport ToastOutletComponent from '../toast/toast-outlet.component';\r\nimport AsideComponent from './aside/aside.component';\r\nimport EditorComponent from './editor.component';\r\nimport MenuBuilderComponent from './menu/menu-builder.component';\r\nimport CurvedPlaneModalComponent from './modals/curved-plane-modal.component';\r\nimport ItemModelModalComponent from './modals/item-model-modal.component';\r\nimport ModelModalComponent from './modals/model-modal.component';\r\nimport NavModalComponent from './modals/nav-modal.component';\r\nimport PanoramaGridModalComponent from './modals/panorama-grid-modal.component';\r\nimport PanoramaModalComponent from './modals/panorama-modal.component';\r\nimport PlaneModalComponent from './modals/plane-modal.component';\r\nimport RemoveModalComponent from './modals/remove-modal.component';\r\nimport UpdateViewItemComponent from './update/update-view-item.component';\r\nimport UpdateViewTileComponent from './update/update-view-tile.component';\r\nimport UpdateViewComponent from './update/update-view.component';\r\n\r\nconst factories = [\r\n\tAsideComponent,\r\n\tCurvedPlaneModalComponent,\r\n\tEditorComponent,\r\n\tItemModelModalComponent,\r\n\tMenuBuilderComponent,\r\n\tModelModalComponent,\r\n\tNavModalComponent,\r\n\tPanoramaModalComponent,\r\n\tPanoramaGridModalComponent,\r\n\tPlaneModalComponent,\r\n\tRemoveModalComponent,\r\n\tToastOutletComponent,\r\n\tUpdateViewItemComponent,\r\n\tUpdateViewTileComponent,\r\n\tUpdateViewComponent,\r\n];\r\n\r\nconst pipes = [];\r\n\r\nexport class EditorModule extends Module { }\r\n\r\nEditorModule.meta = {\r\n\timports: [],\r\n\tdeclarations: [\r\n\t\t...factories,\r\n\t\t...pipes,\r\n\t],\r\n\texports: [\r\n\t\t...factories,\r\n\t\t...pipes,\r\n\t]\r\n};\r\n","import { Pipe } from \"rxcomp\";\r\nimport { environment } from \"../environment\";\r\n\r\nexport default class FlagPipe extends Pipe {\r\n\r\n\tstatic transform(key) {\r\n\t\tconst flags = environment.flags;\r\n\t\treturn flags[key] || false;\r\n\t}\r\n\r\n}\r\n\r\nFlagPipe.meta = {\r\n\tname: 'flag',\r\n};\r\n","import { isPlatformBrowser } from 'rxcomp';\r\nimport { BehaviorSubject, combineLatest, EMPTY, fromEvent, merge, of, ReplaySubject } from \"rxjs\";\r\nimport { delayWhen, filter, first, map, switchMap, tap } from \"rxjs/operators\";\r\nimport { Asset, assetTypeFromPath } from '../asset/asset';\r\nimport { AssetService } from '../asset/asset.service';\r\n\r\nexport class UploadItem {\r\n\r\n\tconstructor(file) {\r\n\t\tthis.file = file;\r\n\t\tthis.name = file.name;\r\n\t\tthis.type = assetTypeFromPath(file.name);\r\n\t\tthis.progress = 0;\r\n\t\tthis.size = file.size;\r\n\t\tthis.uploading = false;\r\n\t\tthis.paused = false;\r\n\t\tthis.success = false;\r\n\t\tthis.complete = false;\r\n\t\tthis.error = null;\r\n\t\tthis.preview = null;\r\n\t}\r\n\r\n}\r\n\r\nexport class UploadEvent {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class UploadStartEvent extends UploadEvent { }\r\n\r\nexport class UploadCompleteEvent extends UploadEvent { }\r\n\r\nexport class UploadAssetEvent extends UploadEvent { }\r\n\r\nexport class UploadService {\r\n\r\n\tconstructor() {\r\n\t\tthis.concurrent$ = new BehaviorSubject(0);\r\n\t\tthis.items$ = new BehaviorSubject([]);\r\n\t\tthis.events$ = new ReplaySubject(1);\r\n\t}\r\n\r\n\tupload$() {\r\n\t\tconst items = this.items$.getValue();\r\n\t\tconst uploadItems = items.filter(item => !item.uploading);\r\n\t\treturn combineLatest(uploadItems.map(item => this.uploadItem$(item)));\r\n\t}\r\n\r\n\tuploadItem$(item) {\r\n\t\t// max 4 concurrent upload\r\n\t\titem.uploading = true;\r\n\t\tthis.events$.next(new UploadStartEvent({ item }));\r\n\t\tconst files = [item.file];\r\n\t\treturn of(files).pipe(\r\n\t\t\tdelayWhen(() => this.concurrent$.pipe(\r\n\t\t\t\tfilter(x => x < 4)\r\n\t\t\t)),\r\n\t\t\ttap(() => this.concurrent$.next(this.concurrent$.getValue() + 1)),\r\n\t\t\tfirst(),\r\n\t\t\tswitchMap(files => AssetService.upload$(files)),\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\titem.uploading = false;\r\n\t\t\t\titem.complete = true;\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\tthis.events$.next(new UploadCompleteEvent({ item, asset }));\r\n\t\t\t\treturn AssetService.assetCreate$(asset).pipe(\r\n\t\t\t\t\ttap(asset => {\r\n\t\t\t\t\t\tthis.remove(item);\r\n\t\t\t\t\t\tthis.events$.next(new UploadAssetEvent({ item, asset }));\r\n\t\t\t\t\t\tthis.concurrent$.next(this.concurrent$.getValue() - 1);\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t);\r\n\t\t/*\r\n\t\t// concurrent upload\r\n\t\treturn AssetService.upload$([item.file]).pipe(\r\n\t\t\t// tap(upload => console.log('upload', upload)),\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\titem.uploading = false;\r\n\t\t\t\titem.complete = true;\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\tthis.events$.next(new UploadCompleteEvent({ item, asset }));\r\n\t\t\t\treturn AssetService.assetCreate$(asset).pipe(\r\n\t\t\t\t\ttap(asset => {\r\n\t\t\t\t\t\tthis.remove(item);\r\n\t\t\t\t\t\tthis.events$.next(new UploadAssetEvent({ item, asset }));\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\taddItems(files) {\r\n\t\tif (files && files.length) {\r\n\t\t\t// console.log('addItems', files);\r\n\t\t\tconst items = this.items$.getValue();\r\n\t\t\tconst newItems = Array.from(files).map(file => new UploadItem(file));\r\n\t\t\titems.push(...newItems);\r\n\t\t\tthis.items$.next(items);\r\n\t\t}\r\n\t}\r\n\r\n\tremove(item) {\r\n\t\tconst items = this.items$.getValue();\r\n\t\tconst index = items.indexOf(item);\r\n\t\tif (index !== -1) {\r\n\t\t\titems.splice(index, 1);\r\n\t\t}\r\n\t\tthis.items$.next(items);\r\n\t}\r\n\r\n\tremoveAll() {\r\n\t\t// !!!\r\n\t\tthis.items$.next([]);\r\n\t}\r\n\r\n\tdrop$(input, dropArea) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\tdropArea = dropArea || input;\r\n\t\t\tconst body = document.querySelector('body');\r\n\t\t\treturn merge(fromEvent(body, 'drop'), fromEvent(body, 'dragover')).pipe(\r\n\t\t\t\tmap((event) => {\r\n\t\t\t\t\t// console.log('UploadService.drop$', event);\r\n\t\t\t\t\tevent.preventDefault();\r\n\t\t\t\t\tif (event.target === dropArea) {\r\n\t\t\t\t\t\tthis.addItems(event.dataTransfer.files);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.items$;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tchange$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'change').pipe(\r\n\t\t\t\tswitchMap((event) => {\r\n\t\t\t\t\tif (input.files.length) {\r\n\t\t\t\t\t\tthis.addItems(input.files);\r\n\t\t\t\t\t\tinput.value = '';\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.items$;\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\r\n\tfiles$(files) {\r\n\t\treturn combineLatest(Array.from(files).map((file, i) => this.file$(file, i)));\r\n\t}\r\n\r\n\tfile$(file, i) {\r\n\t\treturn this.read$(file, i).pipe(\r\n\t\t\tswitchMap(() => this.uploadFile$(file)),\r\n\t\t);\r\n\t}\r\n\r\n\t/*\r\n\tstatic files$(files) {\r\n\t\tconst fileArray = Array.from(files);\r\n\t\tthis.previews = fileArray.map(() => null);\r\n\t\tconst uploads$ = fileArray.map((file, i) => this.read$(file, i).pipe(\r\n\t\t\tswitchMap(() => this.uploadFile$(file)),\r\n\t\t));\r\n\t\treturn combineLatest(uploads$);\r\n\t}\r\n\t*/\r\n\r\n\tread$(file, i) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\ttap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\tthis.resize(blob, (resized) => {\r\n\t\t\t\t\tthis.previews[i] = resized;\r\n\t\t\t\t\t// console.log('resized', resized);\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tuploadFile$(file) {\r\n\t\treturn AssetService.upload$([file]).pipe(\r\n\t\t\t// tap(upload => console.log('upload', upload)),\r\n\t\t\tswitchMap((uploads) => {\r\n\t\t\t\tconst upload = uploads[0];\r\n\t\t\t\t/*\r\n\t\t\t\tid: 1601303293569\r\n\t\t\t\ttype: \"image/jpeg\"\r\n\t\t\t\tfile: \"1601303293569_ambiente1_x0_y2.jpg\"\r\n\t\t\t\toriginalFileName: \"ambiente1_x0_y2.jpg\"\r\n\t\t\t\turl: \"/uploads/1601303293569_ambiente1_x0_y2.jpg\"\r\n\t\t\t\t*/\r\n\t\t\t\tconst asset = Asset.fromUrl(upload.url);\r\n\t\t\t\treturn AssetService.assetCreate$(asset);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tresize(blob, callback) {\r\n\t\tif (typeof callback === 'function') {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tcallback(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.src = blob;\r\n\t\t}\r\n\t}\r\n\r\n\tsupported() {\r\n\t\treturn supportFileAPI() && supportAjaxUploadProgressEvents() && supportFormData();\r\n\t\tfunction supportFileAPI() {\r\n\t\t\tvar input = document.createElement('input');\r\n\t\t\tinput.type = 'file';\r\n\t\t\treturn 'files' in input;\r\n\t\t}\r\n\t\tfunction supportAjaxUploadProgressEvents() {\r\n\t\t\tvar xhr = new XMLHttpRequest();\r\n\t\t\treturn !!(xhr && ('upload' in xhr) && ('onprogress' in xhr.upload));\r\n\t\t}\r\n\t\tfunction supportFormData() {\r\n\t\t\treturn !!window.FormData;\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import { getContext } from 'rxcomp';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { UploadAssetEvent, UploadService } from '../upload/upload.service';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlAssetsComponent extends ControlComponent {\r\n\r\n\tget items() {\r\n\t\treturn this.items_;\r\n\t}\r\n\tset items(items) {\r\n\t\tthis.items_ = items;\r\n\t\tthis.uploadCount = items.reduce((p, c) => {\r\n\t\t\treturn p + (c.uploading || c.completed ? 0 : 1);\r\n\t\t}, 0);\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tthis.multiple = (this.multiple !== false);\r\n\t\tthis.items = [];\r\n\t\tthis.assets = this.control.value || [];\r\n\t\tthis.hasFiles = false;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tconst dropArea = node.querySelector('.upload-drop');\r\n\t\tconst service = this.service = new UploadService();\r\n\t\tservice.drop$(input, dropArea).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(items => {\r\n\t\t\t// console.log('ControlAssetComponent.drop$', items);\r\n\t\t\tthis.items = items;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tservice.change$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(items => {\r\n\t\t\t// console.log('ControlAssetComponent.change$', items);\r\n\t\t\tthis.items = items;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t\tservice.events$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\t// console.log('ControlAssetComponent.events$', event);\r\n\t\t\tif (event instanceof UploadAssetEvent) {\r\n\t\t\t\tthis.assets.push(event.asset);\r\n\t\t\t\tthis.control.value = this.assets;\r\n\t\t\t}\r\n\t\t\tthis.items = this.items;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// this.control.value = assets;\r\n\t\t});\r\n\t}\r\n\r\n\tonUpload() {\r\n\t\t// console.log('ControlAssetsComponent.onUpload');\r\n\t\tthis.service.upload$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe();\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\t// console.log('ControlAssetsComponent.onCancel');\r\n\t\tthis.service.removeAll();\r\n\t}\r\n\r\n\tonItemPause(item) {\r\n\t\t// console.log('ControlAssetsComponent.onPause', item);\r\n\t}\r\n\r\n\tonItemResume(item) {\r\n\t\t// console.log('ControlAssetsComponent.onResume', item);\r\n\t}\r\n\r\n\tonItemCancel(item) {\r\n\t\t// console.log('ControlAssetsComponent.onCancel', item);\r\n\t}\r\n\r\n\tonItemRemove(item) {\r\n\t\t// console.log('ControlAssetsComponent.onRemove', item);\r\n\t\tthis.service.remove(item);\r\n\t}\r\n}\r\n\r\nControlAssetsComponent.meta = {\r\n\tselector: '[control-assets]',\r\n\tinputs: ['control', 'label', 'multiple'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"listing--assets\">\r\n\t\t\t\t<div class=\"listing__item\" *for=\"let item of assets\">\r\n\t\t\t\t\t<div class=\"upload-item\">\r\n\t\t\t\t\t\t<div class=\"picture\">\r\n\t\t\t\t\t\t\t<img [lazy]=\"item | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"item.type.name === 'image'\" />\r\n\t\t\t\t\t\t\t<video [src]=\"item | asset\" *if=\"item.type.name === 'video'\"></video>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<div class=\"name\" [innerHTML]=\"item.file\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"listing__item\" *for=\"let item of items\">\r\n\t\t\t\t\t<div upload-item [item]=\"item\" (pause)=\"onItemPause($event)\" (resume)=\"onItemResume($event)\" (cancel)=\"onItemCancel($event)\" (remove)=\"onItemRemove($event)\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--cta\">\r\n\t\t\t\t<div class=\"btn--browse\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t\t<input type=\"file\" accept=\"image/jpeg\" multiple />\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"btn--upload\" (click)=\"onUpload()\" *if=\"uploadCount > 0\" [innerHTML]=\"'upload' | label\"></div>\r\n\t\t\t\t<div class=\"btn--cancel\" (click)=\"onCancel()\" *if=\"uploadCount > 0\" [innerHTML]=\"'cancel' | label\"></div>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"upload-drop\">\r\n    \t\t\t<span [innerHTML]=\"'drag_and_drop_images' | label\"></span>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlCheckboxComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t}\r\n\r\n}\r\n\r\nControlCheckboxComponent.meta = {\r\n\tselector: '[control-checkbox]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--checkbox\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label>\r\n\t\t\t\t<input type=\"checkbox\" class=\"control--checkbox\" [formControl]=\"control\" [value]=\"true\" />\r\n\t\t\t\t<span [innerHTML]=\"label | html\"></span>\r\n\t\t\t</label>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { fromEvent, merge } from 'rxjs';\r\nimport { filter, map, shareReplay, startWith } from 'rxjs/operators';\r\n\r\nexport default class KeyboardService {\r\n\r\n\tstatic keys = {};\r\n\r\n\tstatic keydown$() {\r\n\t\tif (!this.keydown$_) {\r\n\t\t\tthis.keydown$_ = fromEvent(window, 'keydown').pipe(\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.keydown$_;\r\n\t}\r\n\r\n\tstatic keyup$() {\r\n\t\tif (!this.keyup$_) {\r\n\t\t\tthis.keyup$_ = fromEvent(window, 'keyup').pipe(\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t);\r\n\t\t}\r\n\t\treturn this.keyup$_;\r\n\t}\r\n\r\n\tstatic keys$() {\r\n\t\tif (!this.keys$_) {\r\n\t\t\tthis.keys$_ = merge(this.keydown$(), this.keyup$()).pipe(\r\n\t\t\t\tmap(event => {\r\n\t\t\t\t\tconst keys = this.keys;\r\n\t\t\t\t\tif (event.type === 'keydown') {\r\n\t\t\t\t\t\tkeys[event.key] = true;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdelete keys[event.key];\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn this.keys;\r\n\t\t\t\t}),\r\n\t\t\t\tstartWith(this.keys),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.keys$_;\r\n\t}\r\n\r\n\tstatic key$() {\r\n\t\tif (!this.key$_) {\r\n\t\t\tconst regexp = /\\w/;\r\n\t\t\tthis.key$_ = this.keydown$().pipe(\r\n\t\t\t\tfilter(event => event.key && event.key.match(regexp)),\r\n\t\t\t\tmap(event => event.key),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.key$_;\r\n\t}\r\n\r\n\tstatic typing$() {\r\n\t\tif (!this.typing$_) {\r\n\t\t\tlet typing = '',\r\n\t\t\t\tto;\r\n\t\t\tthis.typing$_ = this.key$().pipe(\r\n\t\t\t\tmap(key => {\r\n\t\t\t\t\tif (to) {\r\n\t\t\t\t\t\tclearTimeout(to);\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttyping += key;\r\n\t\t\t\t\tto = setTimeout(() => {\r\n\t\t\t\t\t\ttyping = '';\r\n\t\t\t\t\t}, 1500);\r\n\t\t\t\t\treturn typing;\r\n\t\t\t\t}),\r\n\t\t\t\tshareReplay(1),\r\n\t\t\t)\r\n\t\t}\r\n\t\treturn this.typing$_;\r\n\t}\r\n\r\n}\r\n","import { getContext } from 'rxcomp';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport DropdownDirective from '../dropdown/dropdown.directive';\r\nimport KeyboardService from '../keyboard/keyboard.service';\r\nimport LabelPipe from '../label/label.pipe';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlCustomSelectComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.dropped = false;\r\n\t\tthis.dropdownId = DropdownDirective.nextId();\r\n\t\tKeyboardService.typing$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(word => {\r\n\t\t\tthis.scrollToWord(word);\r\n\t\t});\r\n\t\t/*\r\n\t\tKeyboardService.key$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(key => {\r\n\t\t\tthis.scrollToKey(key);\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tscrollToWord(word) {\r\n\t\t// console.log('ControlCustomSelectComponent.scrollToWord', word);\r\n\t\tconst items = this.control.options || [];\r\n\t\tlet index = -1;\r\n\t\tfor (let i = 0; i < items.length; i++) {\r\n\t\t\tconst x = items[i];\r\n\t\t\tif (x.name.toLowerCase().indexOf(word.toLowerCase()) === 0) {\r\n\t\t\t\t// console.log(word, x.name);\r\n\t\t\t\tindex = i;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (index !== -1) {\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst dropdown = node.querySelector('.dropdown');\r\n\t\t\tconst navDropdown = node.querySelector('.nav--dropdown');\r\n\t\t\tconst item = navDropdown.children[index];\r\n\t\t\tdropdown.scrollTo(0, item.offsetTop);\r\n\t\t}\r\n\t}\r\n\r\n\tsetOption(item) {\r\n\t\t// console.log('setOption', item, this.isMultiple);\r\n\t\tlet value;\r\n\t\tif (this.isMultiple) {\r\n\t\t\tconst value = this.control.value || [];\r\n\t\t\tconst index = value.indexOf(item.id);\r\n\t\t\tif (index !== -1) {\r\n\t\t\t\t// if (value.length > 1) {\r\n\t\t\t\tvalue.splice(index, 1);\r\n\t\t\t\t// }\r\n\t\t\t} else {\r\n\t\t\t\tvalue.push(item.id);\r\n\t\t\t}\r\n\t\t\tvalue = value.length ? value.slice() : null;\r\n\t\t} else {\r\n\t\t\tvalue = item.id;\r\n\t\t\t// DropdownDirective.dropdown$.next(null);\r\n\t\t}\r\n\t\tthis.control.value = value;\r\n\t\tthis.change.next(value);\r\n\t}\r\n\r\n\thasOption(item) {\r\n\t\tif (this.isMultiple) {\r\n\t\t\tconst values = this.control.value || [];\r\n\t\t\treturn values.indexOf(item.id) !== -1;\r\n\t\t} else {\r\n\t\t\treturn this.control.value === item.id;\r\n\t\t}\r\n\t}\r\n\r\n\tgetLabel() {\r\n\t\tlet value = this.control.value;\r\n\t\tconst items = this.control.options || [];\r\n\t\tif (this.isMultiple) {\r\n\t\t\tvalue = value || [];\r\n\t\t\tif (value.length) {\r\n\t\t\t\treturn value.map(v => {\r\n\t\t\t\t\tconst item = items.find(x => x.id === v || x.name === v);\r\n\t\t\t\t\treturn item ? item.name : '';\r\n\t\t\t\t}).join(', ');\r\n\t\t\t} else {\r\n\t\t\t\treturn LabelPipe.transform('select');\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconst item = items.find(x => x.id === value || x.name === value);\r\n\t\t\tif (item) {\r\n\t\t\t\treturn item.name;\r\n\t\t\t} else {\r\n\t\t\t\treturn LabelPipe.transform('select');\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDropped($event) {\r\n\t\t// console.log('ControlCustomSelectComponent.onDropped', id);\r\n\t\tif (this.dropped && $event === null) {\r\n\t\t\tthis.control.touched = true;\r\n\t\t}\r\n\t\tthis.dropped = $event === this.dropdownId;\r\n\t}\r\n\r\n\tget isMultiple() {\r\n\t\treturn this.multiple && this.multiple !== false && this.multiple !== 'false';\r\n\t}\r\n}\r\n\r\nControlCustomSelectComponent.meta = {\r\n\tselector: '[control-custom-select]',\r\n\toutputs: ['change'],\r\n\tinputs: ['control', 'label', 'multiple'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--select\" [class]=\"{ required: control.validators.length, multiple: isMultiple }\" [dropdown]=\"dropdownId\" (dropped)=\"onDropped($event)\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<span class=\"control--custom-select\" [innerHTML]=\"getLabel()\"></span>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t\t<div class=\"dropdown\" [dropdown-item]=\"dropdownId\">\r\n\t\t\t<div class=\"category\" [innerHTML]=\"label\"></div>\r\n\t\t\t<ul class=\"nav--dropdown\" [class]=\"{ multiple: isMultiple }\">\r\n\t\t\t\t<li (click)=\"setOption(item)\" [class]=\"{ empty: item.id == null }\" *for=\"let item of control.options\">\r\n\t\t\t\t\t<span [class]=\"{ active: hasOption(item) }\" [innerHTML]=\"item.name\"></span>\r\n\t\t\t\t</li>\r\n\t\t\t</ul>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlLinkComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\tmerge(fromEvent(input, 'input')).pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidChange(event));\r\n\t\tfromEvent(input, 'blur').pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidBlur(event));\r\n\t}\r\n\r\n\tonInputDidChange(event) {\r\n\t\tconsole.log('ControlLinkComponent.onInputDidChange', event.target.value);\r\n\t\t// event.target.value = event.target.value.replace(/[^\\d|\\.]/g, '');\r\n\t\t/*\r\n\t\tconst value = parseFloat(event.target.value);\r\n\t\tif (this.value !== value) {\r\n\t\t\tif (value !== NaN) {\r\n\t\t\t\tthis.value = value;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t}\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tonInputDidBlur(event) {\r\n\t\tconsole.log('ControlLinkComponent.onInputDidBlur', event.target.value);\r\n\t\tthis.control.touched = true;\r\n\t\tthis.value = this.input.value;\r\n\t}\r\n\r\n}\r\n\r\nControlLinkComponent.meta = {\r\n\tselector: '[control-link]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [disabled]=\"disabled\" />\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest } from 'rxjs';\r\nimport { switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport { environment } from '../environment';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ControlLocalizedAssetComponent extends ControlComponent {\r\n\r\n\tget localizedValue() {\r\n\t\tlet asset = this.control.value;\r\n\t\tif (asset && asset.locale) {\r\n\t\t\tconst localizedAsset = asset.locale[this.currentLanguage];\r\n\t\t\tif (localizedAsset) {\r\n\t\t\t\tasset = localizedAsset;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn asset;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || 'image/png, image/jpeg';\r\n\t\tthis.languages = environment.languages;\r\n\t\tthis.currentLanguage = environment.defaultLanguage;\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\tDropService.drop$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => (this.languages.length > 1 ? AssetService.createOrUpdateLocalizedAsset$ : AssetService.createOrUpdateAsset$)(uploads, this.control, this.currentLanguage)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(assets => {\r\n\t\t\t// console.log('ControlLocalizedAssetComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n\r\n\tsetLanguage(language) {\r\n\t\tthis.currentLanguage = language;\r\n\t\tthis.pushChanges();\r\n\t}\r\n}\r\n\r\nControlLocalizedAssetComponent.meta = {\r\n\tselector: '[control-localized-asset]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--picture\">\r\n\t\t\t\t<div class=\"group--picture__info\">\r\n\t\t\t\t\t<span [innerHTML]=\"'browse' | label\"></span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<img [lazy]=\"localizedValue | asset\" [size]=\"{ width: 320, height: 240 }\" *if=\"localizedValue && localizedValue.type.name === 'image'\" />\r\n\t\t\t\t<video [src]=\"localizedValue | asset\" *if=\"localizedValue && localizedValue.type.name === 'video'\"></video>\r\n\t\t\t\t<input type=\"file\">\r\n\t\t\t</div>\r\n\t\t\t<div class=\"file-name\" *if=\"localizedValue\" [innerHTML]=\"localizedValue.file\"></div>\r\n\t\t\t<ul class=\"nav--languages\" *if=\"languages.length > 1\">\r\n\t\t\t\t<li class=\"nav__item\" [class]=\"{ active: lang == currentLanguage }\" (click)=\"setLanguage(lang)\" [innerHTML]=\"lang\" *for=\"let lang of languages\"></li>\r\n\t\t\t</ul>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { combineLatest, of } from 'rxjs';\r\nimport { first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetService } from '../asset/asset.service';\r\nimport { DropService } from '../drop/drop.service';\r\nimport ControlAssetComponent from './control-asset.component';\r\n\r\nexport default class ControlModelComponent extends ControlAssetComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.accept = this.accept || '.glb';\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\tinput.setAttribute('accept', this.accept);\r\n\t\t/*\r\n\t\tthis.click$(input).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\t*/\r\n\t\tDropService.change$(input).pipe(\r\n\t\t\tswitchMap((files) => {\r\n\t\t\t\tconst uploads$ = files.map((file, i) => AssetService.upload$([file]).pipe(\r\n\t\t\t\t\tswitchMap((uploads) => AssetService.createOrUpdateAsset$(uploads, this.control)),\r\n\t\t\t\t));\r\n\t\t\t\treturn combineLatest(uploads$);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(assets => {\r\n\t\t\tconsole.log('ControlModelComponent.change$', assets);\r\n\t\t\tthis.control.value = assets[0];\r\n\t\t});\r\n\t}\r\n\r\n\tonRemove(event) {\r\n\t\tAssetService.assetDelete$(this.control.value).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(() => {\r\n\t\t\tthis.control.value = null;\r\n\t\t\tthis.input.value = null;\r\n\t\t\tthis.control.touched = true; // !!!\r\n\t\t});\r\n\t\t// !!! delete upload\r\n\t\t// !!! delete asset\r\n\t}\r\n\r\n\t/*\r\n\tclick$(input) {\r\n\t\tif (isPlatformBrowser && input) {\r\n\t\t\treturn fromEvent(input, 'click').pipe(\r\n\t\t\t\ttap(() => input.value = null),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn EMPTY;\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\tread$(file, i) {\r\n\t\treturn of(file);\r\n\t}\r\n}\r\n\r\nControlModelComponent.meta = {\r\n\tselector: '[control-model]',\r\n\tinputs: ['control', 'label', 'disabled', 'accept'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"group--model\">\r\n\t\t\t\t<div class=\"file-name\" *if=\"!control.value\" [innerHTML]=\"'select_file' | label\"></div>\r\n\t\t\t\t<div class=\"file-name\" *if=\"control.value\" [innerHTML]=\"control.value.file\"></div>\r\n\t\t\t\t<div class=\"btn--upload\"><input type=\"file\"><span [innerHTML]=\"'browse' | label\"></span></div>\r\n\t\t\t\t<div class=\"btn--remove\" *if=\"control.value\" (click)=\"onRemove($event)\"><span [innerHTML]=\"'remove' | label\"></span></div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlNumberComponent extends ControlComponent {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\tupdateValue(value) {\r\n\t\tthis.control.value = value;\r\n\t}\r\n}\r\n\r\nControlNumberComponent.meta = {\r\n\tselector: '[control-number]',\r\n\tinputs: ['control', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"control--content control--number\">\r\n\t\t\t\t<input-value label=\"\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value\" (update)=\"updateValue($event)\"></input-value>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlPasswordComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t}\r\n\r\n}\r\n\r\nControlPasswordComponent.meta = {\r\n\tselector: '[control-password]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<input type=\"password\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" />\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlSelectComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t}\r\n\r\n}\r\n\r\nControlSelectComponent.meta = {\r\n\tselector: '[control-select]',\r\n\tinputs: ['control', 'label'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--select\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<select class=\"control--select\" [formControl]=\"control\" required>\r\n\t\t\t\t<option [value]=\"null\" [innerHTML]=\"'select' | label\"></option>\r\n\t\t\t\t<option [value]=\"item.id\" *for=\"let item of control.options\" [innerHTML]=\"item.name\"></option>\r\n\t\t\t</select>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t<svg class=\"icon--caret-down\"><use xlink:href=\"#caret-down\"></use></svg>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlTextComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\r\n}\r\n\r\nControlTextComponent.meta = {\r\n\tselector: '[control-text]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t<input type=\"text\" class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [disabled]=\"disabled\" />\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlTextareaComponent extends ControlComponent {\r\n\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\r\n}\r\n\r\nControlTextareaComponent.meta = {\r\n\tselector: '[control-textarea]',\r\n\tinputs: ['control', 'label', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form--textarea\" [class]=\"{ required: control.validators.length, disabled: disabled }\">\r\n\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t<textarea class=\"control--text\" [formControl]=\"control\" [placeholder]=\"label\" [innerHTML]=\"label\" rows=\"6\" [disabled]=\"disabled\"></textarea>\r\n\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import ControlComponent from './control.component';\r\n\r\nexport default class ControlVectorComponent extends ControlComponent {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t}\r\n\tupdateValue(index, value) {\r\n\t\tconst values = this.control.value;\r\n\t\tvalues[index] = value;\r\n\t\tthis.control.value = values.slice();\r\n\t}\r\n}\r\n\r\nControlVectorComponent.meta = {\r\n\tselector: '[control-vector]',\r\n\tinputs: ['control', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--form\" [class]=\"{ required: control.validators.length }\">\r\n\t\t\t<div class=\"control--head\">\r\n\t\t\t\t<label [innerHTML]=\"label\"></label>\r\n\t\t\t\t<span class=\"required__badge\" [innerHTML]=\"'required' | label\"></span>\r\n\t\t\t</div>\r\n\t\t\t<div class=\"control--content control--vector\">\r\n\t\t\t\t<input-value label=\"x\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[0]\" (update)=\"updateValue(0, $event)\"></input-value>\r\n\t\t\t\t<input-value label=\"y\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[1]\" (update)=\"updateValue(1, $event)\"></input-value>\r\n\t\t\t\t<input-value label=\"z\" [precision]=\"precision\" [increment]=\"increment\" [disabled]=\"disabled\" [value]=\"control.value[2]\" (update)=\"updateValue(2, $event)\"></input-value>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t\t<errors-component [control]=\"control\"></errors-component>\r\n\t`\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class DisabledDirective extends Directive {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log('DisabledDirective.onChanges', this.disabled);\r\n\t\tif (this.disabled === true) {\r\n\t\t\tnode.disabled = this.disabled;\r\n\t\t\tnode.setAttribute('disabled', this.disabled);\r\n\t\t} else {\r\n\t\t\tdelete node.disabled;\r\n\t\t\tnode.removeAttribute('disabled');\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nDisabledDirective.meta = {\r\n\tselector: 'input[disabled],textarea[disabled]',\r\n\tinputs: ['disabled'],\r\n};\r\n","import LabelPipe from '../label/label.pipe';\r\nimport ControlComponent from './control.component';\r\n\r\nexport default class ErrorsComponent extends ControlComponent {\r\n\tgetLabel(key, value) {\r\n\t\tconst label = LabelPipe.transform(`error_${key}`);\r\n\t\treturn label;\r\n\t}\r\n}\r\n\r\nErrorsComponent.meta = {\r\n\tselector: 'errors-component',\r\n\tinputs: ['control'],\r\n\ttemplate: /* html */ `\r\n\t<div class=\"inner\" [style]=\"{ display: control.invalid && control.touched ? 'block' : 'none' }\">\r\n\t\t<div class=\"error\" *for=\"let [key, value] of control.errors\">\r\n\t\t\t<span [innerHTML]=\"getLabel(key, value)\"></span>\r\n\t\t\t<!-- <span class=\"key\" [innerHTML]=\"key\"></span> <span class=\"value\" [innerHTML]=\"value | json\"></span> -->\r\n\t\t</div>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { fromEvent, interval, merge, race } from 'rxjs';\r\nimport { filter, map, switchMap, takeUntil, tap } from 'rxjs/operators';\r\n\r\nexport default class InputValueComponent extends Component {\r\n\tonInit() {\r\n\t\tthis.label = this.label || 'label';\r\n\t\tthis.value = this.value || 0;\r\n\t\tthis.precision = this.precision || 3;\r\n\t\tthis.increment = this.increment || 1 / Math.pow(10, this.precision);\r\n\t\tthis.disabled = this.disabled || false;\r\n\t\tthis.increment$('.btn--more', 1)\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe((event) => {\r\n\t\t\t\t// console.log('InputValueComponent.increment$', event);\r\n\t\t\t\tthis.value += event;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\tthis.increment$('.btn--less', -1)\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe((event) => {\r\n\t\t\t\t// console.log('InputValueComponent.increment$', event);\r\n\t\t\t\tthis.value += event;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst input = this.input = node.querySelector('input');\r\n\t\t// fromEvent(input, 'change')\r\n\t\tmerge(fromEvent(input, 'input')).pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidChange(event));\r\n\t\tfromEvent(input, 'blur').pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onInputDidBlur(event));\r\n\t\t// fromEvent(node, 'focus').pipe(takeUntil(this.unsubscribe$)).subscribe(event => this.onFocus(event));\r\n\t}\r\n\r\n\tonInputDidChange(event) {\r\n\t\t// const node = getContext(this).node;\r\n\t\t// const value = node.value === '' ? null : node.value;\r\n\t\tevent.target.value = event.target.value.replace(/[^\\d|\\.]/g, '');\r\n\t\t// console.log('InputValueComponent.onInputDidChange', event.target.value);\r\n\t\t/*\r\n\t\tconst value = parseFloat(event.target.value);\r\n\t\tif (this.value !== value) {\r\n\t\t\tif (value !== NaN) {\r\n\t\t\t\tthis.value = value;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t}\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tonInputDidBlur(event) {\r\n\t\t// this.control.touched = true;\r\n\t\t// console.log('InputValueComponent.onInputDidBlur', event.target.value);\r\n\t\tconst value = parseFloat(this.input.value);\r\n\t\tif (this.value !== value) {\r\n\t\t\tif (value !== NaN) {\r\n\t\t\t\tthis.value = value;\r\n\t\t\t\tthis.update.next(this.value);\r\n\t\t\t} else {\r\n\t\t\t\tthis.input.value = this.getValue();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tincrement$(selector, sign) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst element = node.querySelector(selector);\r\n\t\tlet m, increment;\r\n\t\treturn race(fromEvent(element, 'mousedown'), fromEvent(element, 'touchstart')).pipe(\r\n\t\t\ttap(() => {\r\n\t\t\t\tincrement = this.increment;\r\n\t\t\t\tm = 32;\r\n\t\t\t}),\r\n\t\t\tswitchMap((e) => {\r\n\t\t\t\treturn interval(30).pipe(\r\n\t\t\t\t\tfilter((i) => {\r\n\t\t\t\t\t\treturn i % m === 0;\r\n\t\t\t\t\t}),\r\n\t\t\t\t\tmap(() => {\r\n\t\t\t\t\t\tconst i = increment * sign;\r\n\t\t\t\t\t\t// increment = Math.min(this.increment * 100, increment * 2);\r\n\t\t\t\t\t\tm = Math.max(1, Math.floor(m * 0.85));\r\n\t\t\t\t\t\treturn i;\r\n\t\t\t\t\t}),\r\n\t\t\t\t\t// startWith(increment * sign),\r\n\t\t\t\t\ttakeUntil(race(fromEvent(element, 'mouseup'), fromEvent(element, 'touchend')))\r\n\t\t\t\t);\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\tgetValue() {\r\n\t\treturn this.value.toFixed(this.precision);\r\n\t}\r\n\tsetValue(sign) {\r\n\t\tthis.value += this.increment * sign;\r\n\t\tthis.update.next(this.value);\r\n\t\tthis.pushChanges();\r\n\t}\r\n}\r\n\r\nInputValueComponent.meta = {\r\n\tselector: 'input-value',\r\n\toutputs: ['update'],\r\n\tinputs: ['value', 'label', 'precision', 'increment', 'disabled'],\r\n\ttemplate: /* html */ `\r\n\t\t<div class=\"group--control\" [class]=\"{ disabled: disabled }\">\r\n\t\t\t<input type=\"text\" class=\"control--text\" [placeholder]=\"label\" [value]=\"getValue()\" [disabled]=\"disabled\" />\r\n\t\t\t<div class=\"control--trigger\">\r\n\t\t\t\t<div class=\"btn--more\" (click)=\"setValue(1)\">+</div>\r\n\t\t\t\t<div class=\"btn--less\" (click)=\"setValue(-1)\">-</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t`\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { ENV } from '../environment';\r\n\r\nexport default class TestComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.env = ENV;\r\n\t}\r\n\r\n\tonTest(event) {\r\n\t\tthis.test.next(event);\r\n\t}\r\n\r\n\tonReset(event) {\r\n\t\tthis.reset.next(event);\r\n\t}\r\n\r\n}\r\n\r\nTestComponent.meta = {\r\n\tselector: 'test-component',\r\n\tinputs: ['form'],\r\n\toutputs: ['test', 'reset'],\r\n\ttemplate: /* html */ `\r\n\t<div class=\"group--form--results\" *if=\"env.DEVELOPMENT\">\r\n\t\t<code [innerHTML]=\"form.value | json\"></code>\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onTest($event)\"><span>test</span></button>\r\n\t\t<button type=\"button\" class=\"btn--mode\" (click)=\"onReset($event)\"><span>reset</span></button>\r\n\t</div>\r\n\t`\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class ValueDirective extends Directive {\r\n\r\n\tonChanges(changes) {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log('ValueDirective.onChanges', this.value);\r\n\t\tnode.value = this.value;\r\n\t\tnode.setAttribute('value', this.value);\r\n\t}\r\n\r\n}\r\n\r\nValueDirective.meta = {\r\n\tselector: '[value]',\r\n\tinputs: ['value'],\r\n};\r\n","import { Pipe } from \"rxcomp\";\r\n\r\n/*\r\n['quot', 'amp', 'apos', 'lt', 'gt', 'nbsp', 'iexcl', 'cent', 'pound', 'curren', 'yen', 'brvbar', 'sect', 'uml', 'copy', 'ordf', 'laquo', 'not', 'shy', 'reg', 'macr', 'deg', 'plusmn', 'sup2', 'sup3', 'acute', 'micro', 'para', 'middot', 'cedil', 'sup1', 'ordm', 'raquo', 'frac14', 'frac12', 'frac34', 'iquest', 'Agrave', 'Aacute', 'Acirc', 'Atilde', 'Auml', 'Aring', 'AElig', 'Ccedil', 'Egrave', 'Eacute', 'Ecirc', 'Euml', 'Igrave', 'Iacute', 'Icirc', 'Iuml', 'ETH', 'Ntilde', 'Ograve', 'Oacute', 'Ocirc', 'Otilde', 'Ouml', 'times', 'Oslash', 'Ugrave', 'Uacute', 'Ucirc', 'Uuml', 'Yacute', 'THORN', 'szlig', 'agrave', 'aacute', 'atilde', 'auml', 'aring', 'aelig', 'ccedil', 'egrave', 'eacute', 'ecirc', 'euml', 'igrave', 'iacute', 'icirc', 'iuml', 'eth', 'ntilde', 'ograve', 'oacute', 'ocirc', 'otilde', 'ouml', 'divide', 'oslash', 'ugrave', 'uacute', 'ucirc', 'uuml', 'yacute', 'thorn', 'yuml', 'amp', 'bull', 'deg', 'infin', 'permil', 'sdot', 'plusmn', 'dagger', 'mdash', 'not', 'micro', 'perp', 'par', 'euro', 'pound', 'yen', 'cent', 'copy', 'reg', 'trade', 'alpha', 'beta', 'gamma', 'delta', 'epsilon', 'zeta', 'eta', 'theta', 'iota', 'kappa', 'lambda', 'mu', 'nu', 'xi', 'omicron', 'pi', 'rho', 'sigma', 'tau', 'upsilon', 'phi', 'chi', 'psi', 'omega', 'Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta', 'Iota', 'Kappa', 'Lambda', 'Mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho', 'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'];\r\n['\"', '&', ''', '<', '>', ' ', '¡', '¢', '£', '¤', '¥', '¦', '§', '¨', '©', 'ª', '«', '¬', '­', '®', '¯', '°', '±', '²', '³', '´', 'µ', '¶', '·', '¸', '¹', 'º', '»', '¼', '½', '¾', '¿', 'À', 'Á', 'Â', 'Ã', 'Ä', 'Å', 'Æ', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ð', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', '×', 'Ø', 'Ù', 'Ú', 'Û', 'Ü', 'Ý', 'Þ', 'ß', 'à', 'á', 'ã', 'ä', 'å', 'æ', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ð', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', '÷', 'ø', 'ù', 'ú', 'û', 'ü', 'ý', 'þ', 'ÿ', '&', '•', '°', '∞', '‰', '⋅', '±', '†', '—', '¬', 'µ', '⊥', '∥', '€', '£', '¥', '¢', '©', '®', '™', 'α', 'β', 'γ', 'δ', 'ε', 'ζ', 'η', 'θ', 'ι', 'κ', 'λ', 'μ', 'ν', 'ξ', 'ο', 'π', 'ρ', 'σ', 'τ', 'υ', 'φ', 'χ', 'ψ', 'ω', 'Α', 'Β', 'Γ', 'Δ', 'Ε', 'Ζ', 'Η', 'Θ', 'Ι', 'Κ', 'Λ', 'Μ', 'Ν', 'Ξ', 'Ο', 'Π', 'Ρ', 'Σ', 'Τ', 'Υ', 'Φ', 'Χ', 'Ψ', 'Ω'];\r\n*/\r\n\r\nexport default class HtmlPipe extends Pipe {\r\n\r\n\tstatic transform(value) {\r\n\t\tif (value) {\r\n\t\t\tvalue = value.replace(/&#(\\d+);/g, function(m, n) {\r\n\t\t\t\treturn String.fromCharCode(parseInt(n));\r\n\t\t\t});\r\n\t\t\tconst escapes = ['quot', 'amp', 'apos', 'lt', 'gt', 'nbsp', 'iexcl', 'cent', 'pound', 'curren', 'yen', 'brvbar', 'sect', 'uml', 'copy', 'ordf', 'laquo', 'not', 'shy', 'reg', 'macr', 'deg', 'plusmn', 'sup2', 'sup3', 'acute', 'micro', 'para', 'middot', 'cedil', 'sup1', 'ordm', 'raquo', 'frac14', 'frac12', 'frac34', 'iquest', 'Agrave', 'Aacute', 'Acirc', 'Atilde', 'Auml', 'Aring', 'AElig', 'Ccedil', 'Egrave', 'Eacute', 'Ecirc', 'Euml', 'Igrave', 'Iacute', 'Icirc', 'Iuml', 'ETH', 'Ntilde', 'Ograve', 'Oacute', 'Ocirc', 'Otilde', 'Ouml', 'times', 'Oslash', 'Ugrave', 'Uacute', 'Ucirc', 'Uuml', 'Yacute', 'THORN', 'szlig', 'agrave', 'aacute', 'atilde', 'auml', 'aring', 'aelig', 'ccedil', 'egrave', 'eacute', 'ecirc', 'euml', 'igrave', 'iacute', 'icirc', 'iuml', 'eth', 'ntilde', 'ograve', 'oacute', 'ocirc', 'otilde', 'ouml', 'divide', 'oslash', 'ugrave', 'uacute', 'ucirc', 'uuml', 'yacute', 'thorn', 'yuml', 'amp', 'bull', 'deg', 'infin', 'permil', 'sdot', 'plusmn', 'dagger', 'mdash', 'not', 'micro', 'perp', 'par', 'euro', 'pound', 'yen', 'cent', 'copy', 'reg', 'trade', 'alpha', 'beta', 'gamma', 'delta', 'epsilon', 'zeta', 'eta', 'theta', 'iota', 'kappa', 'lambda', 'mu', 'nu', 'xi', 'omicron', 'pi', 'rho', 'sigma', 'tau', 'upsilon', 'phi', 'chi', 'psi', 'omega', 'Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta', 'Iota', 'Kappa', 'Lambda', 'Mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho', 'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'];\r\n\t\t\tconst unescapes = ['\"', '&', '\\'', '<', '>', ' ', '¡', '¢', '£', '¤', '¥', '¦', '§', '¨', '©', 'ª', '«', '¬', '­', '®', '¯', '°', '±', '²', '³', '´', 'µ', '¶', '·', '¸', '¹', 'º', '»', '¼', '½', '¾', '¿', 'À', 'Á', 'Â', 'Ã', 'Ä', 'Å', 'Æ', 'Ç', 'È', 'É', 'Ê', 'Ë', 'Ì', 'Í', 'Î', 'Ï', 'Ð', 'Ñ', 'Ò', 'Ó', 'Ô', 'Õ', 'Ö', '×', 'Ø', 'Ù', 'Ú', 'Û', 'Ü', 'Ý', 'Þ', 'ß', 'à', 'á', 'ã', 'ä', 'å', 'æ', 'ç', 'è', 'é', 'ê', 'ë', 'ì', 'í', 'î', 'ï', 'ð', 'ñ', 'ò', 'ó', 'ô', 'õ', 'ö', '÷', 'ø', 'ù', 'ú', 'û', 'ü', 'ý', 'þ', 'ÿ', '&', '•', '°', '∞', '‰', '⋅', '±', '†', '—', '¬', 'µ', '⊥', '∥', '€', '£', '¥', '¢', '©', '®', '™', 'α', 'β', 'γ', 'δ', 'ε', 'ζ', 'η', 'θ', 'ι', 'κ', 'λ', 'μ', 'ν', 'ξ', 'ο', 'π', 'ρ', 'σ', 'τ', 'υ', 'φ', 'χ', 'ψ', 'ω', 'Α', 'Β', 'Γ', 'Δ', 'Ε', 'Ζ', 'Η', 'Θ', 'Ι', 'Κ', 'Λ', 'Μ', 'Ν', 'Ξ', 'Ο', 'Π', 'Ρ', 'Σ', 'Τ', 'Υ', 'Φ', 'Χ', 'Ψ', 'Ω'];\r\n\t\t\tconst rx = new RegExp(`(&${escapes.join(';)|(&')};)`, 'g');\r\n\t\t\tvalue = value.replace(rx, function() {\r\n\t\t\t\tfor (let i = 1; i < arguments.length; i++) {\r\n\t\t\t\t\tif (arguments[i]) {\r\n\t\t\t\t\t\t// console.log(arguments[i], unescapes[i - 1]);\r\n\t\t\t\t\t\treturn unescapes[i - 1];\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t// console.log(value);\r\n\t\t\treturn value;\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nHtmlPipe.meta = {\r\n\tname: 'html',\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class IdDirective extends Directive {\r\n\r\n\tonChanges() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.setAttribute('id', this.id);\r\n\t}\r\n\r\n}\r\n\r\nIdDirective.meta = {\r\n\tselector: '[id]',\r\n\tinputs: ['id']\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\n\r\nexport default class LayoutComponent extends Component {\r\n\r\n\tget uiClass() {\r\n\t\tconst uiClass = {};\r\n\t\tuiClass[this.state.role] = true;\r\n\t\tuiClass.chat = this.state.chat;\r\n\t\treturn uiClass;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.env = environment;\r\n\t\tthis.state = {\r\n\t\t\tstatus: LocationService.get('status') || 'connected',\r\n\t\t\trole: LocationService.get('role') || 'publisher',\r\n\t\t\tmembersCount: 1,\r\n\t\t\tlive: true,\r\n\t\t\tchat: false,\r\n\t\t\tchatDirty: true,\r\n\t\t\tname: \"Jhon Appleseed\",\r\n\t\t\tuid: \"7341614597544882\"\r\n\t\t};\r\n\t\tthis.state.has3D = this.state.role !== RoleType.SmartDevice;\r\n\t\tthis.view = {\r\n\t\t\tlikes: 41,\r\n\t\t};\r\n\t\tthis.local = {};\r\n\t\tthis.screen = null;\r\n\t\tthis.remotes = new Array(8).fill(0).map((x, i) => ({ id: i + 1, }));\r\n\t\tStateService.patchState(this.state);\r\n\t\tconsole.log('LayoutComponent', this);\r\n\t\t// console.log(AgoraService.getUniqueUserId());\r\n\t}\r\n\r\n\tpatchState(state) {\r\n\t\tthis.state = Object.assign({}, this.state, state);\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\ttoggleCamera() {\r\n\t\tthis.patchState({ cameraMuted: !this.state.cameraMuted });\r\n\t}\r\n\r\n\ttoggleAudio() {\r\n\t\tthis.patchState({ audioMuted: !this.state.audioMuted });\r\n\t}\r\n\r\n\ttoggleScreen() {\r\n\t\tthis.patchState({ screen: !this.state.screen });\r\n\t}\r\n\r\n\ttoggleVolume() {\r\n\t\tthis.patchState({ volumeMuted: !this.state.volumeMuted });\r\n\t}\r\n\r\n\ttoggleFullScreen() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tconst fullScreen = !this.state.fullScreen;\r\n\t\tif (fullScreen) {\r\n\t\t\tif (node.requestFullscreen) {\r\n\t\t\t\tnode.requestFullscreen();\r\n\t\t\t} else if (node.webkitRequestFullscreen) {\r\n\t\t\t\tnode.webkitRequestFullscreen();\r\n\t\t\t} else if (node.msRequestFullscreen) {\r\n\t\t\t\tnode.msRequestFullscreen();\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (document.exitFullscreen) {\r\n\t\t\t\tdocument.exitFullscreen();\r\n\t\t\t} else if (document.webkitExitFullscreen) {\r\n\t\t\t\tdocument.webkitExitFullscreen();\r\n\t\t\t} else if (document.msExitFullscreen) {\r\n\t\t\t\tdocument.msExitFullscreen();\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.patchState({ fullScreen });\r\n\t}\r\n\r\n\ttoggleChat() {\r\n\t\tthis.patchState({ chat: !this.state.chat, chatDirty: false });\r\n\t\twindow.dispatchEvent(new Event('resize'));\r\n\t}\r\n\r\n\tonChatClose() {\r\n\t\tthis.patchState({ chat: false });\r\n\t}\r\n\r\n\tonToggleControl() {\r\n\t\tthis.patchState({ control: !this.state.control, spying: false });\r\n\t}\r\n\r\n\tonToggleSpy(remoteId) {\r\n\t\tconst spying = this.state.spying === remoteId ? null : remoteId;\r\n\t\tthis.patchState({ spying, control: false });\r\n\t}\r\n\r\n\taddLike() {\r\n\t\tthis.view.liked = true; // view.liked;\r\n\t\tthis.showLove(this.view);\r\n\t}\r\n\r\n\tshowLove(view) {\r\n\t\tif (view && this.view.id === view.id) {\r\n\t\t\tconst skipTimeout = this.view.showLove;\r\n\t\t\tthis.view.likes = view.likes;\r\n\t\t\tthis.view.showLove = true;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tif (!skipTimeout) {\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.view.showLove = false;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}, 3100);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tdisconnect() {\r\n\r\n\t}\r\n}\r\n\r\nLayoutComponent.meta = {\r\n\tselector: '[layout-component]',\r\n};\r\n","import { fromEvent, of } from 'rxjs';\r\nimport { auditTime, filter, finalize, map, takeWhile } from 'rxjs/operators';\r\nimport { environment } from '../environment';\r\n\r\nlet UID = 0;\r\n\r\nexport const ImageServiceEvent = {\r\n\tProgress: 'progress',\r\n\tComplete: 'complete',\r\n};\r\nexport default class ImageService {\r\n\r\n\tstatic worker() {\r\n\t\tif (!this.worker_) {\r\n\t\t\tthis.worker_ = new Worker(environment.worker);\r\n\t\t}\r\n\t\treturn this.worker_;\r\n\t}\r\n\r\n\tstatic events$(src, size) {\r\n\t\tif (!('Worker' in window) || this.isBlob(src) || this.isCors(src)) {\r\n\t\t\treturn of({ type: ImageServiceEvent.Complete, data:src });\r\n\t\t}\r\n\t\tconst id = ++UID;\r\n\t\tconst worker = this.worker();\r\n\t\tworker.postMessage({ src, id, size });\r\n\t\tlet lastEvent;\r\n\t\treturn fromEvent(worker, 'message').pipe(\r\n\t\t\tmap(event => event.data),\r\n\t\t\tfilter(event => event.src === src),\r\n\t\t\tauditTime(100),\r\n\t\t\tmap(event => {\r\n\t\t\t\t// console.log('ImageService', event);\r\n\t\t\t\tif (event.type === ImageServiceEvent.Complete && event.data instanceof Blob) {\r\n\t\t\t\t\tconst url = URL.createObjectURL(event.data);\r\n\t\t\t\t\tevent.data = url;\r\n\t\t\t\t}\r\n\t\t\t\tlastEvent = event;\r\n\t\t\t\treturn event;\r\n\t\t\t}),\r\n\t\t\ttakeWhile(event => event.type !== ImageServiceEvent.Complete, true),\r\n\t\t\tfinalize(() => {\r\n\t\t\t\t// console.log('ImageService.finalize', lastEvent);\r\n\t\t\t\tworker.postMessage({ id });\r\n\t\t\t\t/*\r\n\t\t\t\tif (lastEvent && lastEvent.type === ImageServiceEvent.Complete && lastEvent.data) {\r\n\t\t\t\t\tURL.revokeObjectURL(lastEvent.data);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tstatic load$(src, size) {\r\n\t\treturn this.events$(src, size).pipe(\r\n\t\t\tfilter(event => event.type === ImageServiceEvent.Complete),\r\n\t\t\tmap(event => event.data),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic isCors(src) {\r\n\t\t// !!! handle cors environment flag\r\n\t\treturn false;\r\n\t\treturn src.indexOf('://') !== -1 && src.indexOf(window.location.host) === -1;\r\n\t}\r\n\r\n\tstatic isBlob(src) {\r\n\t\treturn src.indexOf('blob:') === 0;\r\n\t}\r\n\r\n}\r\n","import { BehaviorSubject, of , Subject } from 'rxjs';\r\nimport { filter, finalize, first, map } from 'rxjs/operators';\r\n\r\nexport default class IntersectionService {\r\n\r\n\tstatic observer() {\r\n\t\tif (!this.observer_) {\r\n\t\t\tthis.readySubject_ = new BehaviorSubject(false);\r\n\t\t\tthis.observerSubject_ = new Subject();\r\n\t\t\tthis.observer_ = new IntersectionObserver(entries => {\r\n\t\t\t\tthis.observerSubject_.next(entries);\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn this.observer_;\r\n\t}\r\n\r\n\tstatic intersection$(node) {\r\n\t\tif ('IntersectionObserver' in window) {\r\n\t\t\tconst observer = this.observer();\r\n\t\t\tobserver.observe(node);\r\n\t\t\treturn this.observerSubject_.pipe(\r\n\t\t\t\t// tap(entries => console.log(entries.length)),\r\n\t\t\t\tmap(entries => entries.find(entry => entry.target === node)),\r\n\t\t\t\t// tap(entry => console.log('IntersectionService.intersection$', entry)),\r\n\t\t\t\tfilter(entry => entry !== undefined && entry.isIntersecting), // entry.intersectionRatio > 0\r\n\t\t\t\tfirst(),\r\n\t\t\t\tfinalize(() => observer.unobserve(node)),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of({ target: node });\r\n\t\t}\r\n\r\n\t\t/*\r\n\t\tfunction observer() {\r\n\t\t\tif ('IntersectionObserver' in window) {\r\n\t\t\t\treturn new IntersectionObserver(entries => {\r\n\t\t\t\t\tentries.forEach(function(entry) {\r\n\t\t\t\t\t\tif (entry.isIntersecting) {\r\n\t\t\t\t\t\t\tentry.target.classList.add('appear');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t})\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\treturn { observe: function(node) { node.classList.add('appear')}, unobserve: function() {} };\r\n\t\t\t}\r\n\t\t}\r\n\t\tobserver.observe(node);\r\n\t\tobserver.unobserve(node);\r\n\t\t*/\r\n\r\n\t}\r\n\r\n}\r\n","export default class LazyCache {\r\n\tstatic get cache() {\r\n\t\tif (!this.cache_) {\r\n\t\t\tthis.cache_ = {};\r\n\t\t}\r\n\t\treturn this.cache_;\r\n\t}\r\n\r\n\tstatic get(src) {\r\n\t\treturn this.cache[src];\r\n\t}\r\n\r\n\tstatic set(src, blob) {\r\n\t\tthis.cache[src] = blob;\r\n\t\tconst keys = Object.keys(this.cache);\r\n\t\tif (keys.length > 100) {\r\n\t\t\tthis.remove(keys[0]);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic remove(src) {\r\n\t\tdelete this.cache[src];\r\n\t}\r\n}\r\n","import { Directive, getContext } from 'rxcomp';\r\nimport { of, Subject } from 'rxjs';\r\nimport { distinctUntilChanged, first, switchMap, takeUntil } from 'rxjs/operators';\r\nimport ImageService from '../image/image.service';\r\nimport IntersectionService from '../intersection/intersection.service';\r\nimport LazyCache from './lazy.cache';\r\n\r\nexport default class LazyDirective extends Directive {\r\n\r\n\tonInit() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tnode.classList.add('lazy');\r\n\t\tthis.input$ = new Subject().pipe(\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t\tswitchMap(input => {\r\n\t\t\t\tconst src = LazyCache.get(input);\r\n\t\t\t\tif (src) {\r\n\t\t\t\t\treturn of(src);\r\n\t\t\t\t}\r\n\t\t\t\tnode.classList.remove('lazyed');\r\n\t\t\t\treturn this.lazy$(input);\r\n\t\t\t}),\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t);\r\n\t\tthis.input$.subscribe(src => {\r\n\t\t\tLazyCache.set(this.lazy, src);\r\n\t\t\tnode.setAttribute('src', src);\r\n\t\t\tnode.classList.add('lazyed');\r\n\t\t});\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.input$.next(this.lazy);\r\n\t}\r\n\r\n\tlazy$(input) {\r\n\t\tconst { node } = getContext(this);\r\n\t\treturn IntersectionService.intersection$(node).pipe(\r\n\t\t\t// first(),\r\n\t\t\tswitchMap(() => ImageService.load$(input, this.size)),\r\n\t\t\tfirst(),\r\n\t\t\t// takeUntil(this.unsubscribe$),\r\n\t\t);\r\n\t}\r\n\r\n}\r\n\r\nLazyDirective.meta = {\r\n\tselector: '[lazy],[[lazy]]',\r\n\tinputs: ['lazy', 'size']\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport ModalOutletComponent from './modal-outlet.component';\r\nimport ModalService from './modal.service';\r\n\r\nexport default class ModalComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tconst { parentInstance } = getContext(this);\r\n\t\tif (parentInstance instanceof ModalOutletComponent) {\r\n\t\t\tthis.data = parentInstance.modal.data;\r\n\t\t}\r\n\t}\r\n\r\n\tclose() {\r\n\t\tModalService.reject();\r\n\t}\r\n\r\n}\r\n\r\nModalComponent.meta = {\r\n\tselector: '[modal]'\r\n};\r\n","import { Pipe } from 'rxcomp';\r\nimport { environment } from '../environment';\r\n\r\nexport default class SlugPipe extends Pipe {\r\n\r\n\tstatic transform(key) {\r\n\t\tconst url = environment.url;\r\n\t\treturn url[key] || `#${key}`;\r\n\t}\r\n\r\n}\r\n\r\nSlugPipe.meta = {\r\n\tname: 'slug',\r\n};\r\n","import { getContext, Structure } from 'rxcomp';\r\n\r\nexport default class SvgIconStructure extends Structure {\r\n\tonInit() {\r\n\t\tthis.update();\r\n\t}\r\n\tonChanges() {\r\n\t\tthis.update();\r\n\t}\r\n\tupdate() {\r\n\t\tif (this.name_ !== this.name) {\r\n\t\t\tthis.name_ = this.name;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tif (node.parentNode) {\r\n\t\t\t\tconst xmlns = 'http://www.w3.org/2000/svg';\r\n\t\t\t\tconst element = document.createElementNS(xmlns, `svg`);\r\n\t\t\t\tconst w = this.width || 24;\r\n\t\t\t\tconst h = this.height || 24;\r\n\t\t\t\telement.setAttribute('class', `icon--${this.name}`);\r\n\t\t\t\t// element.setAttributeNS(null, 'width', w);\r\n\t\t\t\t// element.setAttributeNS(null, 'height', h);\r\n\t\t\t\telement.setAttributeNS(null, 'viewBox', `0 0 ${w} ${h}`);\r\n\t\t\t\telement.innerHTML = `<use xlink:href=\"#${this.name}\"></use>`;\r\n\t\t\t\telement.rxcompId = node.rxcompId;\r\n\t\t\t\telement.classList.add(...node.classList);\r\n\t\t\t\tnode.parentNode.replaceChild(element, node);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nSvgIconStructure.meta = {\r\n\tselector: 'svg-icon',\r\n\tinputs: ['name', 'width', 'height']\r\n};\r\n\r\n/*\r\n<svg class=\"copy\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\"><use xlink:href=\"#copy\"></use></svg>\r\n*/\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { first } from 'rxjs/operators';\r\nimport { DevicePlatform, DeviceService } from '../device/device.service';\r\nimport { environment } from '../environment';\r\nimport LocationService from '../location/location.service';\r\nimport ViewService from '../view/view.service';\r\n\r\nexport default class TryInARComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\tthis.platform = DeviceService.platform;\r\n\t\tthis.missingAr = false;\r\n\t\tthis.missingUsdz = false;\r\n\t\tthis.missingGltf = false;\r\n\t\tconst viewId = this.viewId = this.getViewId();\r\n\t\t// console.log('TryInARComponent.viewId', viewId);\r\n\t\tif (viewId) {\r\n\t\t\tViewService.viewById$(viewId).pipe(\r\n\t\t\t\tfirst()\r\n\t\t\t).subscribe(view => {\r\n\t\t\t\tif (!view.ar) {\r\n\t\t\t\t\tthis.missingAr = true;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('TryInARComponent.view', view);\r\n\t\t\t\tif (this.platform === DevicePlatform.IOS) {\r\n\t\t\t\t\tconst usdzSrc = this.getUsdzSrc(view);\r\n\t\t\t\t\tif (usdzSrc) {\r\n\t\t\t\t\t\twindow.location.href = usdzSrc;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.missingUsdz = true;\r\n\t\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (this.getGltfSrc(view) !== null) {\r\n\t\t\t\t\tconst modelViewerNode = this.getModelViewerNode(view);\r\n\t\t\t\t\tconst { node } = getContext(this);\r\n\t\t\t\t\tnode.appendChild(modelViewerNode);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.missingGltf = true;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tgetUsdzSrc(view) {\r\n\t\treturn (view.ar && view.ar.usdz) ? environment.getPath(view.ar.usdz.folder + view.ar.usdz.file) : null;\r\n\t}\r\n\r\n\tgetGltfSrc(view) {\r\n\t\treturn (view.ar && view.ar.gltf) ? environment.getPath(view.ar.gltf.folder + view.ar.gltf.file) : null;\r\n\t}\r\n\r\n\tgetViewId() {\r\n\t\tlet viewId = LocationService.get('viewId') || null;\r\n\t\tif (viewId) {\r\n\t\t\tviewId = parseInt(viewId);\r\n\t\t}\r\n\t\treturn viewId;\r\n\t}\r\n\r\n\tgetModelViewerNode(view) {\r\n\t\tconst panorama = environment.getPath(view.asset.folder + view.asset.file);\r\n\t\tconst usdzSrc = this.getUsdzSrc(view);\r\n\t\tconst gltfSrc = this.getGltfSrc(view);\r\n\t\tconst template = /* html */`\r\n\t\t\t<model-viewer alt=\"${view.name}\" skybox-image=\"${panorama}\" ios-src=\"${usdzSrc}\" src=\"${gltfSrc}\" ar ar-modes=\"webxr scene-viewer quick-look\" ar-scale=\"auto\" camera-controls></model-viewer>\r\n\t\t`;\r\n\t\tconst div = document.createElement(\"div\");\r\n\t\tdiv.innerHTML = template;\r\n\t\tconst node = div.firstElementChild;\r\n\t\treturn node;\r\n\t}\r\n\r\n}\r\n\r\nTryInARComponent.meta = {\r\n\tselector: '[try-in-ar]'\r\n};\r\n","import { Component } from 'rxcomp';\r\nimport { fromEvent, of } from 'rxjs';\r\nimport { switchMap, takeUntil } from 'rxjs/operators';\r\nimport { AssetType } from '../asset/asset';\r\n\r\nexport default class UploadItemComponent extends Component {\r\n\r\n\tonInit() {\r\n\t\t// console.log('UploadItemComponent.onInit', this.item);\r\n\t\tif (this.item.preview === null) {\r\n\t\t\tthis.read$(this.item.file).pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t).subscribe(preview => {\r\n\t\t\t\tthis.item.preview = preview;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tread$(file) {\r\n\t\tconst reader = new FileReader();\r\n\t\tconst reader$ = fromEvent(reader, 'load').pipe(\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst blob = event.target.result;\r\n\t\t\t\tif (this.item.type.name === AssetType.Image.name) {\r\n\t\t\t\t\treturn this.resize$(blob);\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn of(blob);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t\treader.readAsDataURL(file);\r\n\t\treturn reader$;\r\n\t}\r\n\r\n\tresize$(blob) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst img = document.createElement('img');\r\n\t\t\timg.onload = function() {\r\n\t\t\t\tconst MAX_WIDTH = 320;\r\n\t\t\t\tconst MAX_HEIGHT = 240;\r\n\t\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t\tlet width = img.width;\r\n\t\t\t\tlet height = img.height;\r\n\t\t\t\tif (width > height) {\r\n\t\t\t\t\tif (width > MAX_WIDTH) {\r\n\t\t\t\t\t\theight *= MAX_WIDTH / width;\r\n\t\t\t\t\t\twidth = MAX_WIDTH;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif (height > MAX_HEIGHT) {\r\n\t\t\t\t\t\twidth *= MAX_HEIGHT / height;\r\n\t\t\t\t\t\theight = MAX_HEIGHT;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tcanvas.width = width;\r\n\t\t\t\tcanvas.height = height;\r\n\t\t\t\tctx.drawImage(img, 0, 0, width, height);\r\n\t\t\t\tconst dataUrl = canvas.toDataURL('image/jpeg', 0.9);\r\n\t\t\t\tresolve(dataUrl);\r\n\t\t\t};\r\n\t\t\timg.onerror = function(error) {\r\n\t\t\t\treject(error);\r\n\t\t\t};\r\n\t\t\timg.src = blob;\r\n\t\t});\r\n\t}\r\n\r\n\tonPause() {\r\n\t\tthis.pause.next(this.item);\r\n\t}\r\n\r\n\tonResume() {\r\n\t\tthis.resume.next(this.item);\r\n\t}\r\n\r\n\tonCancel() {\r\n\t\tthis.cancel.next(this.item);\r\n\t}\r\n\r\n\tonRemove() {\r\n\t\tthis.remove.next(this.item);\r\n\t}\r\n}\r\n\r\nUploadItemComponent.meta = {\r\n\tselector: '[upload-item]',\r\n\toutputs: ['pause', 'resume', 'cancel', 'remove'],\r\n\tinputs: ['item'],\r\n\ttemplate: /* html */`\r\n\t<div class=\"upload-item\" [class]=\"{ 'error': item.error, 'success': item.success }\">\r\n\t\t<div class=\"picture\">\r\n\t\t\t<img [lazy]=\"item.preview\" [size]=\"{ width: 320, height: 240 }\" *if=\"item.preview && item.type.name === 'image'\" />\r\n\t\t\t<video [src]=\"item.preview\" *if=\"item.preview && item.type.name === 'video'\"></video>\r\n\t\t\t<svg class=\"spinner\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" [class]=\"{ uploading: item.uploading }\" *if=\"item.uploading\"><use xlink:href=\"#spinner\"></use></svg>\r\n\t\t</div>\r\n\t\t<div class=\"name\">{{item.name}}</div>\r\n\t\t<!--\r\n\t\t<div class=\"group--info\">\r\n\t\t\t<div>progress: {{item.progress}}</div>\r\n\t\t\t<div>size: {{item.size}} bytes</div>\r\n\t\t\t<div>current speed: {{item.currentSpeed}} bytes/s</div>\r\n\t\t\t<div>average speed: {{item.averageSpeed}} bytes/s</div>\r\n\t\t\t<div>time ramining: {{item.timeRemaining}}s</div>\r\n\t\t\t<div>paused: {{item.paused}}</div>\r\n\t\t\t<div>success: {{item.success}}</div>\r\n\t\t\t<div>complete: {{item.complete}}</div>\r\n\t\t\t<div>error: {{item.error}}</div>\r\n\t\t</div>\r\n\t\t-->\r\n\t\t<!--\r\n\t\t<div class=\"group--cta\" *if=\"!item.complete && item.uploading\">\r\n\t\t\t<div class=\"btn--pause\" (click)=\"onPause()\">pause</div>\r\n\t\t\t<div class=\"btn--resume\" (click)=\"onResume()\">resume</div>\r\n\t\t\t<div class=\"btn--cancel\" (click)=\"onCancel()\">cancel</div>\r\n\t\t</div>\r\n\t\t-->\r\n\t\t<div class=\"group--cta\">\r\n\t\t\t<div class=\"btn--remove\" (click)=\"onRemove()\" *if=\"!item.complete\">remove</div>\r\n\t\t</div>\r\n\t</div>\r\n\t`,\r\n};\r\n","import { Directive, getContext } from 'rxcomp';\r\n\r\nexport default class HlsDirective extends Directive {\r\n\r\n\tset hls(hls) {\r\n\t\tif (this.hls_ !== hls) {\r\n\t\t\tthis.hls_ = hls;\r\n\t\t\tthis.play(hls);\r\n\t\t}\r\n\t}\r\n\r\n\tget hls() {\r\n\t\treturn this.hls_;\r\n\t}\r\n\r\n\tplay(src) {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (Hls.isSupported()) {\r\n\t\t\tvar hls = new Hls();\r\n\t\t\t// bind them together\r\n\t\t\thls.attachMedia(node);\r\n\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\thls.loadSource(src);\r\n\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\tnode.play();\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nHlsDirective.meta = {\r\n\tselector: '[[hls]]',\r\n\tinputs: ['hls'],\r\n};\r\n","import { Context } from 'rxcomp';\r\n\r\nexport default class VirtualItem extends Context {\r\n\tconstructor(key, $key, value, $value, index, count, parentInstance) {\r\n\t\tsuper(parentInstance);\r\n\t\tthis[key] = $key;\r\n\t\tthis[value] = $value;\r\n\t\tthis.index = index;\r\n\t\tthis.count = count;\r\n\t}\r\n\r\n\tget first() {\r\n\t\treturn this.index === 0;\r\n\t}\r\n\r\n\tget last() {\r\n\t\treturn this.index === this.count - 1;\r\n\t}\r\n\r\n\tget even() {\r\n\t\treturn this.index % 2 === 0;\r\n\t}\r\n\r\n\tget odd() {\r\n\t\treturn !this.even;\r\n\t}\r\n}\r\n","import { getContext, Structure } from 'rxcomp';\r\nimport { BehaviorSubject, fromEvent, merge } from 'rxjs';\r\nimport { auditTime, distinctUntilChanged, map, startWith, takeUntil, tap } from 'rxjs/operators';\r\nimport VirtualItem from './virtual.item';\r\n\r\nexport const VirtualMode = {\r\n\tResponsive: 1,\r\n\tGrid: 2,\r\n\tCentered: 3,\r\n\tList: 4\r\n};\r\n\r\nexport default class VirtualStructure extends Structure {\r\n\r\n\tonInit() {\r\n\t\tconst { module, node } = getContext(this);\r\n\t\tconst template = node.firstElementChild;\r\n\t\tconst expression = node.getAttribute('*virtual');\r\n\t\tnode.removeAttribute('*virtual');\r\n\t\tnode.removeChild(template);\r\n\t\tconst tokens = (this.tokens = this.getExpressionTokens(expression));\r\n\t\tthis.virtualFunction = module.makeFunction(tokens.iterable);\r\n\t\tthis.container = node;\r\n\t\tthis.template = template;\r\n\t\tthis.mode = this.mode || 1;\r\n\t\tthis.width = this.width || 250;\r\n\t\tthis.gutter = (this.gutter !== undefined) ? this.gutter : 20;\r\n\t\tthis.reverse = this.reverse === true ? true : false;\r\n\t\tthis.options = {\r\n\t\t\twidth: this.width,\r\n\t\t\tgutter: this.gutter,\r\n\t\t\treverse: this.reverse,\r\n\t\t\tcontainerWidth: 0,\r\n\t\t\tcontainerHeight: 0,\r\n\t\t\ttop: 0,\r\n\t\t\tcols: [0],\r\n\t\t};\r\n\t\tthis.cachedRects = {};\r\n\t\tthis.cachedInstances = [];\r\n\t\tthis.cacheNodes = [];\r\n\t\tthis.items$ = new BehaviorSubject([]);\r\n\t\tthis.update$()\r\n\t\t\t.pipe(takeUntil(this.unsubscribe$))\r\n\t\t\t.subscribe(visibleItems => {\r\n\t\t\t\t// console.log(visibleItems.length);\r\n\t\t\t});\r\n\t}\r\n\r\n\tonChanges(changes) {\r\n\t\tconst context = getContext(this);\r\n\t\tconst module = context.module;\r\n\t\t// resolve\r\n\t\tconst items = module.resolve(this.virtualFunction, context.parentInstance, this) || [];\r\n\t\tthis.mode = this.mode || 1;\r\n\t\tthis.width = this.width || 250;\r\n\t\tthis.gutter = (this.gutter !== undefined) ? this.gutter : 20;\r\n\t\tthis.options.width = this.width;\r\n\t\tthis.updateView(true);\r\n\t\tthis.items$.next(items);\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t}\r\n\r\n\tupdate$() {\r\n\t\treturn merge(this.scroll$(), this.resize$(), this.items$.pipe(\r\n\t\t\tdistinctUntilChanged(),\r\n\t\t)).pipe(\r\n\t\t\tmap(_ => {\r\n\t\t\t\tconst visibleItems = this.updateForward();\r\n\t\t\t\treturn visibleItems;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tupdateForward() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet highestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = [];\r\n\t\tfor (let i = 0, len = items.length; i < len; i++) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\ttop = options.cols[col];\r\n\t\t\tif (this.intersect(top + options.top, top + height + options.top, options.top, options.top + options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.bottom = bottom;\r\n\t\t\t\t}\r\n\t\t\t\tvisibleItems.push(item);\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t}\r\n\t\t}\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tconst parentContainer = this.container.parentNode;\r\n\t\tif (this.reverse && (highestHeight < parentContainer.offsetHeight - 1)) {\r\n\t\t\tconst diff = parentContainer.offsetHeight - 1 - highestHeight;\r\n\t\t\titems.forEach((item, i) => {\r\n\t\t\t\tif (visibleItems.indexOf(item) !== -1) {\r\n\t\t\t\t\tconst rect = this.cachedRects[i];\r\n\t\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\t\tnode.style.top = (rect.top + diff) + 'px';\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.container.style.height = `${parentContainer.offsetHeight - 1}px`;\r\n\t\t} else {\r\n\t\t\tthis.container.style.height = `${highestHeight}px`;\r\n\t\t}\r\n\t\treturn visibleItems;\r\n\t}\r\n\r\n\t/*\r\n\tupdateForward__() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet highestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = items.filter((item, i) => {\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\ttop = options.cols[col];\r\n\t\t\tif (this.intersect(top + options.top, top + height + options.top, options.top, options.top + options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.bottom = bottom;\r\n\t\t\t\t}\r\n\t\t\t\treturn true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\tbottom = top + height + options.gutter;\r\n\t\t\t\toptions.cols[col] = bottom;\r\n\t\t\t\thighestHeight = Math.max(highestHeight, bottom);\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t});\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tthis.container.style.height = `${highestHeight}px`;\r\n\t\treturn visibleItems;\r\n\t}\r\n\r\n\tupdateBackward__() {\r\n\t\tconst options = this.options;\r\n\t\tconst items = this.items$.getValue();\r\n\t\t// console.log('VirtualStructure', 'items.length', items.length);\r\n\t\tconst total = items.length;\r\n\t\tthis.container.position = 'relative';\r\n\t\tlet lowestHeight = 0;\r\n\t\tconst width = this.getWidth();\r\n\t\tconst gutter = this.getGutter(width);\r\n\t\tconst visibleItems = [];\r\n\t\tfor (let i = items.length - 1; i >= 0; i--) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tlet col, height, top, left, bottom;\r\n\t\t\tlet rect = this.cachedRects[i];\r\n\t\t\tif (rect) {\r\n\t\t\t\tcol = rect.col;\r\n\t\t\t\theight = rect.height;\r\n\t\t\t\tleft = rect.left;\r\n\t\t\t\t// top = rect.top;\r\n\t\t\t\t// bottom = rect.bottom;\r\n\t\t\t} else {\r\n\t\t\t\tcol = this.getCol();\r\n\t\t\t\theight = this.getHeight(width, item);\r\n\t\t\t}\r\n\t\t\tbottom = options.cols[col];\r\n\t\t\tif (this.intersect(bottom - height + options.top, bottom + options.top, options.top, options.top + options.containerHeight)) {\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tleft = this.getLeft(col, width, gutter);\r\n\t\t\t\t}\r\n\t\t\t\tconst node = this.cachedNode(i, i, item, total);\r\n\t\t\t\tnode.style.position = 'absolute';\r\n\t\t\t\tnode.style.top = top + 'px';\r\n\t\t\t\tnode.style.left = left + 'px';\r\n\t\t\t\tnode.style.width = width + 'px';\r\n\t\t\t\tif (height !== node.offsetHeight) {\r\n\t\t\t\t\theight = node.offsetHeight;\r\n\t\t\t\t}\r\n\t\t\t\ttop = bottom - height - options.gutter;\r\n\t\t\t\tlowestHeight = Math.min(lowestHeight, -top);\r\n\t\t\t\toptions.cols[col] = top;\r\n\t\t\t\tif (!rect) {\r\n\t\t\t\t\tthis.cachedRects[i] = { col, width, height, left, top, bottom: bottom };\r\n\t\t\t\t} else {\r\n\t\t\t\t\trect.height = height;\r\n\t\t\t\t\trect.top = top;\r\n\t\t\t\t}\r\n\t\t\t\tvisibleItems.push(item);\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeNode(i);\r\n\t\t\t\ttop = bottom - height - options.gutter;\r\n\t\t\t\toptions.cols[col] = top;\r\n\t\t\t\tlowestHeight = Math.min(lowestHeight, top);\r\n\t\t\t}\r\n\t\t}\r\n\t\tlet removeIndex = items.length;\r\n\t\twhile (removeIndex < this.cacheNodes.length) {\r\n\t\t\tthis.removeNode(removeIndex);\r\n\t\t\tremoveIndex++;\r\n\t\t}\r\n\t\tthis.cacheNodes.length = items.length;\r\n\t\tthis.container.style.height = `${-lowestHeight}px`;\r\n\t\treturn visibleItems;\r\n\t}\r\n\t*/\r\n\r\n\tgetCols() {\r\n\t\tconst options = this.options;\r\n\t\tconst cols = Math.floor((options.containerWidth + options.gutter) / (options.width + options.gutter)) || 1;\r\n\t\treturn new Array(cols).fill(0);\r\n\t}\r\n\r\n\tgetCol() {\r\n\t\tconst options = this.options;\r\n\t\tlet col;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tcol = options.cols.reduce((p, c, i, a) => {\r\n\t\t\t\t\treturn c < a[p] ? i : p;\r\n\t\t\t\t}, 0);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tcol = 0;\r\n\t\t}\r\n\t\treturn col;\r\n\t}\r\n\r\n\tgetWidth() {\r\n\t\tconst options = this.options;\r\n\t\tlet width;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\twidth = options.width;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\twidth = (options.containerWidth - (options.cols.length - 1) * options.gutter) / options.cols.length;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\twidth = options.containerWidth;\r\n\t\t}\r\n\t\treturn width;\r\n\t}\r\n\r\n\tgetHeight(width, item) {\r\n\t\tconst options = this.options;\r\n\t\tlet height;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\theight = options.width;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\theight = 80;\r\n\t\t}\r\n\t\treturn height;\r\n\t}\r\n\r\n\tgetGutter(width) {\r\n\t\tconst options = this.options;\r\n\t\tlet gutter;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\tgutter = options.gutter;\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tgutter = (options.containerWidth - options.cols.length * width) / (options.cols.length - 1);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tgutter = 0;\r\n\t\t}\r\n\t\treturn gutter;\r\n\t}\r\n\r\n\tgetLeft(index, width, gutter) {\r\n\t\tconst options = this.options;\r\n\t\tlet left;\r\n\t\tswitch (this.mode) {\r\n\t\t\tcase VirtualMode.Grid:\r\n\t\t\tcase VirtualMode.Responsive:\r\n\t\t\t\tleft = index * (width + gutter);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.Centered:\r\n\t\t\t\tleft = (options.containerWidth - options.cols.length * (width + gutter) + gutter) / 2 + index * (width + gutter);\r\n\t\t\t\tbreak;\r\n\t\t\tcase VirtualMode.List:\r\n\t\t\tdefault:\r\n\t\t\t\tleft = 0;\r\n\t\t}\r\n\t\treturn left;\r\n\t}\r\n\r\n\tcachedNode(index, i, value, total) {\r\n\t\tif (this.cacheNodes[index]) {\r\n\t\t\treturn this.updateNode(index, i, value);\r\n\t\t} else {\r\n\t\t\treturn this.createNode(index, i, value, total);\r\n\t\t}\r\n\t}\r\n\r\n\tcreateNode(index, i, value, total) {\r\n\t\tconst clonedNode = this.template.cloneNode(true);\r\n\t\tdelete clonedNode.rxcompId;\r\n\t\tthis.container.appendChild(clonedNode);\r\n\t\tthis.cacheNodes[index] = clonedNode;\r\n\t\tconst context = getContext(this);\r\n\t\tconst module = context.module;\r\n\t\tconst tokens = this.tokens;\r\n\t\tconst args = [tokens.key, i, tokens.value, value, i, total, context.parentInstance];\r\n\t\tconst instance = module.makeInstance(clonedNode, VirtualItem, context.selector, context.parentInstance, args);\r\n\t\tconst forItemContext = getContext(instance);\r\n\t\tmodule.compile(clonedNode, forItemContext.instance);\r\n\t\tthis.cachedInstances[index] = instance;\r\n\t\treturn clonedNode;\r\n\t}\r\n\r\n\tupdateNode(index, i, value) {\r\n\t\tconst instance = this.cachedInstances[index];\r\n\t\tconst tokens = this.tokens;\r\n\t\tif (instance[tokens.key] !== i) {\r\n\t\t\tinstance[tokens.key] = i;\r\n\t\t\tinstance[tokens.value] = value;\r\n\t\t\tinstance.pushChanges();\r\n\t\t}\r\n\t\t// console.log(index, i, value);\r\n\t\treturn this.cacheNodes[index];\r\n\t}\r\n\r\n\tremoveNode(index) {\r\n\t\tthis.cachedInstances[index] = undefined;\r\n\t\tconst node = this.cacheNodes[index];\r\n\t\tif (node) {\r\n\t\t\tconst context = getContext(this);\r\n\t\t\tconst module = context.module;\r\n\t\t\tnode.parentNode.removeChild(node);\r\n\t\t\tmodule.remove(node);\r\n\t\t}\r\n\t\tthis.cacheNodes[index] = undefined;\r\n\t\treturn node;\r\n\t}\r\n\r\n\tintersect(top1, bottom1, top2, bottom2) {\r\n\t\treturn top2 < bottom1 && bottom2 > top1;\r\n\t}\r\n\r\n\tresize$() {\r\n\t\treturn fromEvent(window, 'resize').pipe(\r\n\t\t\tauditTime(100),\r\n\t\t\tstartWith(null),\r\n\t\t\ttap(() => this.updateView(true))\r\n\t\t);\r\n\t}\r\n\r\n\tscroll$() {\r\n\t\tconst { node } = getContext(this);\r\n\t\t// console.log(node.parentNode, getComputedStyle(node.parentNode).overflowY, node.parentNode.style.overflowY);\r\n\t\tif (node.parentNode && getComputedStyle(node.parentNode).overflowY === 'auto') {\r\n\t\t\treturn fromEvent(node.parentNode, 'scroll').pipe(tap(() => {\r\n\t\t\t\tthis.updateView();\r\n\t\t\t}));\r\n\t\t} else {\r\n\t\t\treturn fromEvent(window, 'scroll').pipe(tap(() => this.updateView()));\r\n\t\t}\r\n\t}\r\n\r\n\tupdateView(reset) {\r\n\t\tconst rect = this.container.getBoundingClientRect();\r\n\t\tconst options = this.options;\r\n\t\toptions.top = rect.top;\r\n\t\toptions.containerWidth = rect.width;\r\n\t\toptions.containerHeight = rect.height; // window.innerHeight;\r\n\t\toptions.cols = this.getCols();\r\n\t\tif (reset) {\r\n\t\t\tthis.cachedRects = {};\r\n\t\t}\r\n\t}\r\n\r\n\tgetExpressionTokens(expression) {\r\n\t\tif (expression === null) {\r\n\t\t\tthrow new Error('invalid virtual');\r\n\t\t}\r\n\t\tif (expression.trim().indexOf('let ') === -1 || expression.trim().indexOf(' of ') === -1) {\r\n\t\t\tthrow new Error('invalid virtual');\r\n\t\t}\r\n\t\tconst expressions = expression\r\n\t\t\t.split(';')\r\n\t\t\t.map(x => x.trim())\r\n\t\t\t.filter(x => x !== '');\r\n\t\tconst virtualExpressions = expressions[0].split(' of ').map(x => x.trim());\r\n\t\tlet value = virtualExpressions[0].replace(/\\s*let\\s*/, '');\r\n\t\tconst iterable = virtualExpressions[1];\r\n\t\tlet key = 'index';\r\n\t\tconst keyValueMatches = value.match(/\\[(.+)\\s*,\\s*(.+)\\]/);\r\n\t\tif (keyValueMatches) {\r\n\t\t\tkey = keyValueMatches[1];\r\n\t\t\tvalue = keyValueMatches[2];\r\n\t\t}\r\n\t\tif (expressions.length > 1) {\r\n\t\t\tconst indexExpressions = expressions[1].split(/\\s*let\\s*|\\s*=\\s*index/).map(x => x.trim());\r\n\t\t\tif (indexExpressions.length === 3) {\r\n\t\t\t\tkey = indexExpressions[1];\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn { key, value, iterable };\r\n\t}\r\n}\r\n\r\nVirtualStructure.meta = {\r\n\tselector: '[*virtual]',\r\n\tinputs: ['mode', 'width', 'gutter', 'reverse']\r\n};\r\n","import { BehaviorSubject, combineLatest, of, ReplaySubject } from 'rxjs';\r\nimport { map, switchAll } from 'rxjs/operators';\r\n\r\nlet LOADER_UID = 0;\r\n\r\nexport default class LoaderService {\r\n\r\n\tstatic progress = { value: 0, loaded: 0, total: 0, count: 0, title: '' };\r\n\r\n\tstatic items = {};\r\n\r\n\t// merge(this.statusSubject, this.validatorsSubject)\r\n\tstatic progress$ = new ReplaySubject(1).pipe(\r\n\t\tswitchAll(),\r\n\t\tmap(() => {\r\n\t\t\tconst items = Object.keys(this.items).map(key => this.items[key]);\r\n\t\t\tconst progress = items.reduce((progress, subject, i, items) => {\r\n\t\t\t\tconst item = subject.getValue();\r\n\t\t\t\tconst loaded = item.loaded || 0;\r\n\t\t\t\tconst total = item.total || 1;\r\n\t\t\t\tconst value = loaded / total;\r\n\t\t\t\tprogress.value += value;\r\n\t\t\t\tprogress.loaded += loaded;\r\n\t\t\t\tprogress.total += total;\r\n\t\t\t\treturn progress;\r\n\t\t\t}, { value: 0, loaded: 0, total: 0 });\r\n\t\t\tprogress.count = items.length;\r\n\t\t\tif (items.length) {\r\n\t\t\t\tprogress.value /= progress.count;\r\n\t\t\t}\r\n\t\t\tprogress.title = `${Math.round(progress.value * 100)}%`;\r\n\t\t\tthis.progress = progress;\r\n\t\t\treturn progress;\r\n\t\t}),\r\n\t);\r\n\r\n\tstatic switchLoaders() {\r\n\t\tconst items = Object.keys(this.items).map(key => this.items[key]);\r\n\t\tconst items$ = items.length ? combineLatest(items) : of(items);\r\n\t\tthis.progress$.next(items$);\r\n\t}\r\n\r\n\tstatic getRef() {\r\n\t\tconst ref = ++LOADER_UID;\r\n\t\tthis.items[ref] = new BehaviorSubject({ loaded: 0, total: 1 });\r\n\t\tthis.switchLoaders();\r\n\t\treturn ref;\r\n\t}\r\n\r\n\tstatic setProgress(ref, loaded, total = 1) {\r\n\t\tconst item = this.items[ref];\r\n\t\tif (item) {\r\n\t\t\titem.next({ loaded, total });\r\n\t\t}\r\n\t\tif (loaded >= total) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tdelete this.items[ref];\r\n\t\t\t\tthis.switchLoaders();\r\n\t\t\t}, 300);\r\n\t\t}\r\n\t\tthis.switchLoaders();\r\n\t}\r\n\r\n}\r\n","import { fromEvent } from 'rxjs';\r\nimport { filter, first, switchMap, takeWhile, tap } from 'rxjs/operators';\r\nimport { AssetType } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport ImageService, { ImageServiceEvent } from '../../image/image.service';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport StreamService from '../../stream/stream.service';\r\n// import DebugService from '../debug.service';\r\n\r\nexport class EnvMapLoader {\r\n\r\n\tstatic get video() {\r\n\t\treturn this.video_;\r\n\t}\r\n\r\n\tstatic set video(video) {\r\n\t\tif (this.video_) {\r\n\t\t\tthis.video_.muted = true;\r\n\t\t\tthis.video_.pause();\r\n\t\t\tif (this.video_.parentNode) {\r\n\t\t\t\tthis.video_.parentNode.removeChild(this.video_);\r\n\t\t\t}\r\n\t\t\tthis.video_ = null;\r\n\t\t}\r\n\t\tif (video) {\r\n\t\t\tconst video = this.video_ = document.createElement('video');\r\n\t\t\tvideo.loop = true;\r\n\t\t\t// video.muted = true;\r\n\t\t\tvideo.playsInline = true;\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\t// document.querySelector('body').appendChild(video);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic get muted() {\r\n\t\treturn this.muted_;\r\n\t}\r\n\r\n\tstatic set muted(muted) {\r\n\t\tthis.muted_ = muted;\r\n\t\t// console.log('EnvMapLoader.muted', muted, this.video);\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.muted = muted === true;\r\n\t\t}\r\n\t}\r\n\r\n\tstatic set cubeRenderTarget(cubeRenderTarget) {\r\n\t\tif (this.cubeRenderTarget_) {\r\n\t\t\tthis.cubeRenderTarget_.texture.dispose();\r\n\t\t\tthis.cubeRenderTarget_.dispose();\r\n\t\t}\r\n\t\tthis.cubeRenderTarget_ = cubeRenderTarget;\r\n\t}\r\n\r\n\tstatic set texture(texture) {\r\n\t\tif (this.texture_) {\r\n\t\t\tthis.texture_.dispose();\r\n\t\t}\r\n\t\tthis.texture_ = texture;\r\n\t}\r\n\r\n\tstatic load(item, renderer, callback) {\r\n\t\tthis.video = null;\r\n\t\tif (!item.asset) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (item.asset.type.name === AssetType.PublisherStream.name) {\r\n\t\t\treturn this.loadPublisherStreamBackground(renderer, callback);\r\n\t\t} else if (item.asset.file.indexOf('.mp4') !== -1 || item.asset.file.indexOf('.webm') !== -1) {\r\n\t\t\treturn this.loadVideoBackground(environment.getPath(item.asset.folder), item.asset.file, renderer, callback);\r\n\t\t} else if (item.asset.file.indexOf('.m3u8') !== -1) {\r\n\t\t\treturn this.loadHlslVideoBackground(item.asset.file, renderer, callback);\r\n\t\t} else if (item.asset.file.indexOf('.hdr') !== -1) {\r\n\t\t\treturn this.loadRgbeBackground(environment.getPath(item.asset.folder), item.asset.file, renderer, callback);\r\n\t\t} else {\r\n\t\t\treturn this.loadBackgroundImageService(environment.getPath(item.asset.folder), item.asset.file, renderer, callback);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic loadBackground(folder, file, renderer, callback) {\r\n\t\tconst pmremGenerator = new THREE.PMREMGenerator(renderer);\r\n\t\tpmremGenerator.compileEquirectangularShader();\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\t// console.log('loadBackground.progressRef');\r\n\t\tconst loader = new THREE.TextureLoader();\r\n\t\tloader.setPath(folder).load(file, (texture) => {\r\n\t\t\tconst envMap = pmremGenerator.fromEquirectangular(texture).texture;\r\n\t\t\tpmremGenerator.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t}, (request) => {\r\n\t\t\tconsole.log(request.loaded, request.total);\r\n\t\t\tLoaderService.setProgress(progressRef, request.loaded, request.total);\r\n\t\t});\r\n\t\treturn loader;\r\n\t}\r\n\r\n\tstatic loadBackgroundImageService(folder, file, renderer, callback) {\r\n\t\tconst pmremGenerator = new THREE.PMREMGenerator(renderer);\r\n\t\tpmremGenerator.compileEquirectangularShader();\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst image = new Image();\r\n\t\tImageService.events$(folder + file).pipe(\r\n\t\t\ttap(event => {\r\n\t\t\t\tif (event.type === ImageServiceEvent.Progress) {\r\n\t\t\t\t\tLoaderService.setProgress(progressRef, event.data.loaded, event.data.total);\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event.type === ImageServiceEvent.Complete),\r\n\t\t\tswitchMap(event => {\r\n\t\t\t\tconst load = fromEvent(image, 'load');\r\n\t\t\t\timage.crossOrigin = 'anonymous';\r\n\t\t\t\timage.src = event.data;\r\n\t\t\t\treturn load;\r\n\t\t\t}),\r\n\t\t\ttakeWhile(event => event.type !== ImageServiceEvent.Complete, true),\r\n\t\t).subscribe(event => {\r\n\t\t\tURL.revokeObjectURL(event.data);\r\n\t\t\tconst texture = new THREE.Texture(image);\r\n\t\t\tconst envMap = pmremGenerator.fromEquirectangular(texture).texture;\r\n\t\t\tpmremGenerator.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t});\r\n\t}\r\n\r\n\tstatic loadRgbeBackground(folder, file, renderer, callback) {\r\n\t\tconst pmremGenerator = new THREE.PMREMGenerator(renderer);\r\n\t\tpmremGenerator.compileEquirectangularShader();\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst loader = new THREE.RGBELoader();\r\n\t\tloader\r\n\t\t\t.setDataType(THREE.UnsignedByteType)\r\n\t\t\t// .setDataType(THREE.FloatType)\r\n\t\t\t.setPath(folder)\r\n\t\t\t.load(file, (texture) => {\r\n\t\t\t\tconst envMap = pmremGenerator.fromEquirectangular(texture).texture;\r\n\t\t\t\t// texture.dispose();\r\n\t\t\t\tpmremGenerator.dispose();\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(envMap, texture, true);\r\n\t\t\t\t}\r\n\t\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t\t}, (request) => {\r\n\t\t\t\tLoaderService.setProgress(progressRef, request.loaded, request.total);\r\n\t\t\t});\r\n\t\treturn loader;\r\n\t}\r\n\r\n\tstatic loadHlslVideoBackground(src, renderer, callback) {\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\tconst video = document.createElement('video');\r\n\t\tconst onPlaying = () => {\r\n\t\t\tvideo.oncanplay = null;\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\t// const envMap = new THREE.VideoTexture(video);\r\n\t\t\tconst cubeRenderTarget = new THREE.WebGLCubeRenderTarget(1024, {\r\n\t\t\t\tgenerateMipmaps: true,\r\n\t\t\t\t// minFilter: THREE.LinearMipmapLinearFilter,\r\n\t\t\t\tminFilter: THREE.LinearFilter,\r\n\t\t\t\tmagFilter: THREE.LinearFilter,\r\n\t\t\t\tmapping: THREE.UVMapping,\r\n\t\t\t\tformat: THREE.RGBFormat\r\n\t\t\t}).fromEquirectangularTexture(renderer, texture);\r\n\t\t\t// texture.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(cubeRenderTarget.texture, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t};\r\n\t\tvideo.oncanplay = () => {\r\n\t\t\t// console.log('videoReady', videoReady);\r\n\t\t\tonPlaying();\r\n\t\t};\r\n\t\tif (Hls.isSupported()) {\r\n\t\t\tvar hls = new Hls();\r\n\t\t\t// bind them together\r\n\t\t\thls.attachMedia(video);\r\n\t\t\thls.on(Hls.Events.MEDIA_ATTACHED, () => {\r\n\t\t\t\thls.loadSource(src);\r\n\t\t\t\thls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n\t\t\t\t\t// console.log('HlsDirective', data.levels);\r\n\t\t\t\t\tvideo.play();\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tstatic loadVideoBackground(folder, file, renderer, callback) {\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\t// const debugService = DebugService.getService();\r\n\t\tthis.video = true;\r\n\t\tconst video = this.video;\r\n\t\tconst onPlaying = () => {\r\n\t\t\tvideo.oncanplay = null;\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\t// const envMap = new THREE.VideoTexture(video);\r\n\t\t\tconst cubeRenderTarget = this.cubeRenderTarget = new THREE.WebGLCubeRenderTarget(1024, {\r\n\t\t\t\tgenerateMipmaps: true,\r\n\t\t\t\t// minFilter: THREE.LinearMipmapLinearFilter,\r\n\t\t\t\tminFilter: THREE.LinearFilter,\r\n\t\t\t\tmagFilter: THREE.LinearFilter,\r\n\t\t\t\tmapping: THREE.UVMapping,\r\n\t\t\t\tformat: THREE.RGBFormat\r\n\t\t\t}).fromEquirectangularTexture(renderer, texture);\r\n\t\t\t// texture.dispose();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(cubeRenderTarget.texture, texture, false);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t};\r\n\t\t// video.addEventListener('playing', onPlaying);\r\n\t\tvideo.oncanplay = () => {\r\n\t\t\t// console.log('EnvMapLoader.loadVideoBackground.oncanplay');\r\n\t\t\tonPlaying();\r\n\t\t};\r\n\t\tvideo.src = folder + file;\r\n\t\tvideo.load();\r\n\t\tvideo.play().then(() => {\r\n\t\t\t// console.log('EnvMapLoader.loadVideoBackground.play');\r\n\t\t\t// debugService.setMessage(`play ${video.src}`);\r\n\t\t}, error => {\r\n\t\t\tconsole.log('EnvMapLoader.loadVideoBackground.play.error', error);\r\n\t\t\t// debugService.setMessage(`play.error ${video.src}`);\r\n\t\t});\r\n\t}\r\n\r\n\tstatic loadPublisherStreamBackground(renderer, callback) {\r\n\t\tconst onPublisherStreamId = (publisherStreamId) => {\r\n\t\t\t// const target = StateService.state.role === RoleType.Publisher ? '.video--local' : '.video--remote';\r\n\t\t\tconst target = `#stream-${publisherStreamId}`;\r\n\t\t\tconst video = document.querySelector(`${target} video`);\r\n\t\t\tif (!video) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst onPlaying = () => {\r\n\t\t\t\tconst texture = this.texture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tconst cubeRenderTarget = this.cubeRenderTarget = new THREE.WebGLCubeRenderTarget(1024, {\r\n\t\t\t\t\tgenerateMipmaps: true,\r\n\t\t\t\t\t// minFilter: THREE.LinearMipmapLinearFilter,\r\n\t\t\t\t\tminFilter: THREE.LinearFilter,\r\n\t\t\t\t\tmagFilter: THREE.LinearFilter,\r\n\t\t\t\t\tmapping: THREE.UVMapping,\r\n\t\t\t\t\tformat: THREE.RGBFormat\r\n\t\t\t\t}).fromEquirectangularTexture(renderer, texture);\r\n\t\t\t\t// texture.dispose();\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(cubeRenderTarget.texture, texture, false);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\t\tonPlaying();\r\n\t\t\t} else {\r\n\t\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\t\tonPlaying();\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t};\r\n\t\tStreamService.getPublisherStreamId$().pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(publisherStreamId => onPublisherStreamId(publisherStreamId));\r\n\t}\r\n\r\n}\r\n","\r\nexport default class FreezableMesh extends THREE.Mesh {\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\r\n\tset freezed(freezed) {\r\n\t\t// !!! cycle through freezable and not freezable\r\n\t\tthis.freezed_ = freezed;\r\n\t\tthis.children.filter(x => x.__lookupGetter__('freezed')).forEach(x => x.freezed = freezed);\r\n\t}\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tgeometry = geometry || new THREE.BoxBufferGeometry(5, 5, 5);\r\n\t\tmaterial = material || new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(geometry, material);\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n\tfreeze() {\r\n\t\tthis.freezed = true;\r\n\t}\r\n\r\n\tunfreeze() {\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n}\r\n","import FreezableMesh from \"./freezable.mesh\";\r\n\r\nexport default class EmittableMesh extends FreezableMesh {\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tgeometry = geometry || new THREE.BoxBufferGeometry(5, 5, 5);\r\n\t\tmaterial = material || new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(geometry, material);\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","// import DebugService from '../debug.service';\r\n\r\nconst defaultEvent = {};\r\n\r\nexport default class Interactive { }\r\n\r\nInteractive.items = [];\r\nInteractive.hittest = interactiveHittest.bind(Interactive);\r\nInteractive.dispose = interactiveDispose.bind(Interactive);\r\n\r\nexport function interactiveHittest(raycaster, down = false, event = defaultEvent) {\r\n\t// const debugService = DebugService.getService();\r\n\tlet dirty = false;\r\n\tif (this.down !== down) {\r\n\t\tthis.down = down;\r\n\t\tthis.lock = false;\r\n\t\tdirty = true;\r\n\t}\r\n\tconst items = this.items.filter(x => !x.freezed);\r\n\tconst intersections = raycaster.intersectObjects(items);\r\n\tlet key, hit;\r\n\tconst hash = {};\r\n\tintersections.forEach((intersection, i) => {\r\n\t\tconst object = intersection.object;\r\n\t\tkey = object.uuid;\r\n\t\tif (i === 0) {\r\n\t\t\tif (this.lastIntersectedObject !== object || dirty) {\r\n\t\t\t\tthis.lastIntersectedObject = object;\r\n\t\t\t\thit = object;\r\n\t\t\t\t// debugService.setMessage(hit.name || hit.id);\r\n\t\t\t\t// haptic feedback\r\n\t\t\t} else if (\r\n\t\t\t\tobject.intersection && (\r\n\t\t\t\t\tMath.abs(object.intersection.point.x - intersection.point.x) > 0.01 ||\r\n\t\t\t\t\tMath.abs(object.intersection.point.y - intersection.point.y) > 0.01\r\n\t\t\t\t)\r\n\t\t\t) {\r\n\t\t\t\tobject.intersection = intersection;\r\n\t\t\t\tobject.emit('move', object);\r\n\t\t\t}\r\n\t\t}\r\n\t\thash[key] = intersection;\r\n\t});\r\n\tif (intersections.length === 0) {\r\n\t\tthis.lastIntersectedObject = null;\r\n\t}\r\n\titems.forEach(x => {\r\n\t\tx.intersection = hash[x.uuid];\r\n\t\tx.over = (x === this.lastIntersectedObject) || (x.intersection && !x.depthTest && (!this.lastIntersectedObject || this.lastIntersectedObject.depthTest));\r\n\t\tx.down = down && x.over && !this.lock;\r\n\t\tif (x.down) {\r\n\t\t\tthis.lock = true;\r\n\t\t}\r\n\t});\r\n\treturn hit;\r\n}\r\n\r\nexport function interactiveDispose(object) {\r\n\tif (object) {\r\n\t\tconst index = this.items.indexOf(object);\r\n\t\tif (index !== -1) {\r\n\t\t\tthis.items.splice(index, 1);\r\n\t\t}\r\n\t}\r\n}\r\n","import EmittableMesh from './emittable.mesh';\r\nimport Interactive from './interactive';\r\n\r\nexport default class InteractiveMesh extends EmittableMesh {\r\n\r\n\tconstructor(geometry, material) {\r\n\t\tsuper(geometry, material);\r\n\t\tthis.depthTest = true;\r\n\t\tthis.over_ = false;\r\n\t\tthis.down_ = false;\r\n\t\tInteractive.items.push(this);\r\n\t}\r\n\r\n\tget isInteractiveMesh() {\r\n\t\treturn true;\r\n\t}\r\n\r\n\tget over() {\r\n\t\treturn this.over_;\r\n\t}\r\n\tset over(over) {\r\n\t\tif (this.over_ != over) {\r\n\t\t\tthis.over_ = over;\r\n\t\t\t/*\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('hit', this);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('over', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('out', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget down() {\r\n\t\treturn this.down_;\r\n\t}\r\n\tset down(down) {\r\n\t\tdown = down && this.over;\r\n\t\tif (this.down_ != down) {\r\n\t\t\tthis.down_ = down;\r\n\t\t\tif (down) {\r\n\t\t\t\tthis.emit('down', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('up', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","import { Texture } from 'three';\r\n\r\nfunction VideoTexture(video, mapping, wrapS, wrapT, magFilter, minFilter, format, type, anisotropy) {\r\n\tTexture.call(this, video, mapping, wrapS, wrapT, magFilter, minFilter, format, type, anisotropy);\r\n\tthis.format = format !== undefined ? format : THREE.RGBFormat;\r\n\tthis.minFilter = minFilter !== undefined ? minFilter : THREE.LinearFilter;\r\n\tthis.magFilter = magFilter !== undefined ? magFilter : THREE.LinearFilter;\r\n\tthis.mapping = THREE.UVMapping;\r\n\tthis.generateMipmaps = false;\r\n}\r\n\r\nVideoTexture.prototype = Object.assign(Object.create(Texture.prototype), {\r\n\r\n\tconstructor: VideoTexture,\r\n\r\n\tisVideoTexture: true,\r\n\r\n\tupdate: function() {\r\n\t\tvar video = this.image;\r\n\t\tif (video.readyState >= video.HAVE_CURRENT_DATA) {\r\n\t\t\tthis.needsUpdate = true;\r\n\t\t}\r\n\t}\r\n\r\n});\r\n\r\nexport { VideoTexture };\r\n","import StateService from '../../state/state.service';\r\nimport { PanoramaGridView } from '../../view/view';\r\nimport { EnvMapLoader } from '../envmap/envmap.loader';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport { VideoTexture } from '../video-texture';\r\n\r\nexport const PANORAMA_RADIUS = 101;\r\n\r\nconst VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\t// gl_PointSize = 8.0;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\n\r\nconst FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform vec2 resolution;\r\nuniform float tween;\r\nuniform bool rgbe;\r\nuniform sampler2D texture;\r\n\r\nvec3 ACESFilmicToneMapping_( vec3 color ) {\r\n\tcolor *= 1.8;\r\n\treturn saturate( ( color * ( 2.51 * color + 0.03 ) ) / ( color * ( 2.43 * color + 0.59 ) + 0.14 ) );\r\n}\r\n\r\nvec4 getColor(vec2 p) {\r\n\treturn texture2D(texture, p);\r\n}\r\n\r\nvec3 encodeColor(vec4 color) {\r\n\treturn ACESFilmicToneMapping_(RGBEToLinear(color).rgb);\r\n}\r\n\r\nfloat rand(vec2 co){\r\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\r\n}\r\n\r\nvec4 Blur(vec2 st, vec4 color) {\r\n\tconst float directions = 16.0;\r\n\tconst float quality = 3.0;\r\n\tfloat size = 16.0;\r\n\tconst float PI2 = 6.28318530718;\r\n\tconst float qq = 1.0;\r\n\tconst float q = 1.0 / quality;\r\n\tvec2 radius = size / resolution.xy;\r\n\tfor (float d = 0.0; d < PI2; d += PI2 / directions) {\r\n\t\tfor (float i = q; i <= qq; i += q) {\r\n\t\t\tvec2 dUv = vec2(cos(d), sin(d)) * radius * i;\r\n\t\t\tcolor += getColor(st + dUv);\r\n        }\r\n\t}\r\n\treturn color /= quality * directions - 15.0 + rand(st) * 4.0;\r\n}\r\n\r\nvoid main() {\r\n\tvec4 color = texture2D(texture, vUv);\r\n\t// color = Blur(vUv, color);\r\n\tif (rgbe) {\r\n\t\tcolor = vec4(encodeColor(color) * tween + rand(vUv) * 0.01, 1.0);\r\n\t} else {\r\n\t\tcolor = vec4(color.rgb * tween + rand(vUv) * 0.01, 1.0);\r\n\t}\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nexport default class Panorama {\r\n\r\n\tconstructor() {\r\n\t\tthis.muted_ = false;\r\n\t\tthis.subscription = StateService.state$.subscribe(state => EnvMapLoader.muted = state.volumeMuted);\r\n\t\tthis.tween = 0;\r\n\t\tthis.create();\r\n\t}\r\n\r\n\tcreate() {\r\n\t\tconst geometry = new THREE.SphereBufferGeometry(PANORAMA_RADIUS, 60, 40);\r\n\t\tgeometry.scale(-1, 1, 1);\r\n\t\tgeometry.rotateY(Math.PI);\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\tfragmentShader: FRAGMENT_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\ttexture: { type: \"t\", value: null },\r\n\t\t\t\tresolution: { value: new THREE.Vector2() },\r\n\t\t\t\ttween: { value: 0 },\r\n\t\t\t\trgbe: { value: false },\r\n\t\t\t},\r\n\t\t});\r\n\t\t/*\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0,\r\n\t\t});\r\n\t\t*/\r\n\t\tconst mesh = this.mesh = new InteractiveMesh(geometry, material);\r\n\t\t// mesh.renderOrder = environment.renderOrder.panorama;\r\n\t\tmesh.name = '[panorama]';\r\n\t}\r\n\r\n\t/*\r\n\tswap(view, renderer, callback, onexit) {\r\n\t\tconst item = view instanceof PanoramaGridView ? view.tiles[view.index_] : view;\r\n\t\tconst material = this.mesh.material;\r\n\t\tif (this.tween > 0) {\r\n\t\t\tgsap.to(this, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\ttween: 0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\tif (typeof onexit === 'function') {\r\n\t\t\t\t\t\tonexit(view);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t\t\tgsap.to(this, {\r\n\t\t\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\t\t\ttween: 1,\r\n\t\t\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tif (typeof onexit === 'function') {\r\n\t\t\t\tonexit(view);\r\n\t\t\t}\r\n\t\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\tgsap.to(this, {\r\n\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\ttween: 1,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\tchange(view, renderer, callback, onexit) {\r\n\t\tconst item = view instanceof PanoramaGridView ? view.tiles[view.index_] : view;\r\n\t\tconst material = this.mesh.material;\r\n\t\t// setTimeout(() => {\r\n\t\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t// setTimeout(() => {\r\n\t\t\t\t\tif (typeof onexit === 'function') {\r\n\t\t\t\t\t\tonexit(view);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tmaterial.uniforms.tween.value = 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\tsetTimeout(function () {\r\n\t\t\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, 100); // !!! delay\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tgsap.to(this, {\r\n\t\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\t\ttween: 1,\r\n\t\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tonComplete: () => {\r\n\t\t\t\t\t\t\tsetTimeout(function () {\r\n\t\t\t\t\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\t\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}, 100); // !!! delay\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t});\r\n\t\t\t\t\t*/\r\n\t\t\t\t// }, 100); // !!! delay\r\n\t\t\t});\r\n\t\t// }, 300); // !!! delay\r\n\t}\r\n\r\n\tcrossfade(item, renderer, callback) {\r\n\t\tconst material = this.mesh.material;\r\n\t\tthis.load(item, renderer, (envMap, texture, rgbe) => {\r\n\t\t\tmaterial.uniforms.tween.value = 1;\r\n\t\t\tmaterial.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tload(item, renderer, callback) {\r\n\t\tif (!item.asset) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.currentAsset = item.asset.folder + item.asset.file;\r\n\t\tconst material = this.mesh.material;\r\n\t\tEnvMapLoader.load(item, renderer, (envMap, texture, rgbe, video, pmremGenerator) => {\r\n\t\t\tif (item.asset.folder + item.asset.file !== this.currentAsset) {\r\n\t\t\t\ttexture.dispose();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (material.uniforms.texture.value) {\r\n\t\t\t\tmaterial.uniforms.texture.value.dispose();\r\n\t\t\t\tmaterial.uniforms.texture.value = null;\r\n\t\t\t}\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\t// material.map = texture;\r\n\t\t\tmaterial.uniforms.texture.value = texture;\r\n\t\t\tmaterial.uniforms.resolution.value = new THREE.Vector2(texture.width, texture.height);\r\n\t\t\tmaterial.uniforms.tween.value = 0;\r\n\t\t\tmaterial.uniforms.rgbe.value = rgbe;\r\n\t\t\tmaterial.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(envMap, texture, rgbe);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tloadVideo(src) {\r\n\t\tconst video = document.createElement('video');\r\n\t\tvideo.src = src;\r\n\t\tvideo.volume = 0.8;\r\n\t\tvideo.muted = true;\r\n\t\tvideo.playsInline = true;\r\n\t\tvideo.crossOrigin = 'anonymous';\r\n\t\tvideo.play();\r\n\t\tthis.setVideo(video);\r\n\t}\r\n\r\n\tsetVideo(video) {\r\n\t\t// console.log('Panorama.setVideo', video);\r\n\t\tif (video) {\r\n\t\t\tconst onPlaying = () => {\r\n\t\t\t\tconst texture = new VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tconst material = this.mesh.material;\r\n\t\t\t\tmaterial.map = texture;\r\n\t\t\t\tmaterial.uniforms.texture.value = texture;\r\n\t\t\t\tmaterial.uniforms.resolution.value = new THREE.Vector2(texture.width, texture.height);\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t};\r\n\t\t\t// video.addEventListener('canplay', onPlaying);\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\tonPlaying();\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.subscription.unsubscribe();\r\n\t}\r\n\r\n}\r\n","export class Rect {\r\n\r\n\tconstructor(rect) {\r\n\t\tthis.x = 0;\r\n\t\tthis.y = 0;\r\n\t\tthis.top = 0;\r\n\t\tthis.right = 0;\r\n\t\tthis.bottom = 0;\r\n\t\tthis.left = 0;\r\n\t\tthis.width = 0;\r\n\t\tthis.height = 0;\r\n\t\tthis.set(rect);\r\n\t}\r\n\r\n\tstatic contains(rect, left, top) {\r\n\t\treturn rect.top <= top && top <= rect.bottom && rect.left <= left && left <= rect.right;\r\n\t}\r\n\r\n\tstatic intersectRect(r1, r2) {\r\n\t\treturn !(r2.left > r1.right ||\r\n\t\t\tr2.right < r1.left ||\r\n\t\t\tr2.top > r1.bottom ||\r\n\t\t\tr2.bottom < r1.top);\r\n\t}\r\n\r\n\tstatic fromNode(node) {\r\n\t\tif (!node) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst rect = node.rect_ || (node.rect_ = new Rect());\r\n\t\tconst rects = node.getClientRects();\r\n\t\tif (!rects.length) {\r\n\t\t\t// console.log(rects, node);\r\n\t\t\treturn rect;\r\n\t\t}\r\n\t\tconst boundingRect = node.getBoundingClientRect();\r\n\t\t// rect.top: boundingRect.top + defaultView.pageYOffset,\r\n\t\t// rect.left: boundingRect.left + defaultView.pageXOffset,\r\n\t\trect.x = boundingRect.left;\r\n\t\trect.y = boundingRect.top;\r\n\t\trect.top = boundingRect.top;\r\n\t\trect.left = boundingRect.left;\r\n\t\trect.width = boundingRect.width;\r\n\t\trect.height = boundingRect.height;\r\n\t\trect.right = rect.left + rect.width;\r\n\t\trect.bottom = rect.top + rect.height;\r\n\t\trect.setCenter();\r\n\t\treturn rect;\r\n\t}\r\n\r\n\tset(rect) {\r\n\t\tif (rect) {\r\n\t\t\tObject.assign(this, rect);\r\n\t\t\tthis.right = this.left + this.width;\r\n\t\t\tthis.bottom = this.top + this.height;\r\n\t\t}\r\n\t\tthis.setCenter();\r\n\t}\r\n\r\n\tsetSize(w, h) {\r\n\t\tthis.width = w;\r\n\t\tthis.height = h;\r\n\t\tthis.right = this.left + this.width;\r\n\t\tthis.bottom = this.top + this.height;\r\n\t\tthis.setCenter();\r\n\t\t// console.log(w, h);\r\n\t}\r\n\r\n\tsetCenter() {\r\n\t\tconst center = this.center || (this.center = {});\r\n\t\tcenter.top = this.top + this.height / 2;\r\n\t\tcenter.left = this.left + this.width / 2;\r\n\t\tcenter.x = center.left;\r\n\t\tcenter.y = center.top;\r\n\t}\r\n\r\n\tcontains(left, top) {\r\n\t\treturn Rect.contains(this, left, top);\r\n\t}\r\n\r\n\tintersect(rect) {\r\n\t\treturn Rect.intersectRect(this, rect);\r\n\t}\r\n\r\n\tintersection(rect) {\r\n\t\tconst intersection = this.intersection_ || (this.intersection_ = {\r\n\t\t\tleft: 0,\r\n\t\t\ttop: 0,\r\n\t\t\twidth: 0,\r\n\t\t\theight: 0,\r\n\t\t\tx: 0,\r\n\t\t\ty: 0,\r\n\t\t\tpow: {\r\n\t\t\t\tx: -1,\r\n\t\t\t\ty: -1\r\n\t\t\t},\r\n\t\t\toffset: function(offset) {\r\n\t\t\t\toffset = offset || 0;\r\n\t\t\t\tconst pow = (this.top - this.rect.height / 2 + offset) / -this.height;\r\n\t\t\t\treturn pow;\r\n\t\t\t},\r\n\t\t\tscroll: function(offset) {\r\n\t\t\t\toffset = offset || 0;\r\n\t\t\t\tconst pow = (this.top - this.rect.height / 2 + offset) / -this.height;\r\n\t\t\t\treturn pow;\r\n\t\t\t}\r\n\t\t});\r\n\t\tintersection.left = this.left;\r\n\t\tintersection.top = this.top;\r\n\t\tintersection.width = this.width;\r\n\t\tintersection.height = this.height;\r\n\t\tintersection.x = this.left + this.width / 2;\r\n\t\tintersection.y = this.top + this.height / 2;\r\n\t\tintersection.rect = rect;\r\n\t\tconst pow = intersection.offset(0);\r\n\t\tintersection.pow.y = pow;\r\n\t\treturn intersection;\r\n\t}\r\n\r\n}\r\n","// import { auditTime, tap } from \"rxjs/operators\";\r\n// import AudioStreamService from \"../../audio/audio-stream.service\";\r\nimport StreamService from \"../../stream/stream.service\";\r\n\r\nexport const W = 320;\r\nexport const H = 240;\r\nexport const COLORS = [0xffcc00, 0x00ffcc, 0x00ccff, 0xccff00, 0xcc00ff, 0xffffff];\r\n\r\nexport default class AvatarElement {\r\n\r\n\tstatic get headGeometry() {\r\n\t\tif (!this.headGeometry_) {\r\n\t\t\tthis.headGeometry_ = new THREE.SphereBufferGeometry(0.2, 48, 48);\r\n\t\t}\r\n\t\treturn this.headGeometry_;\r\n\t}\r\n\r\n\tconstructor(message) {\r\n\t\tconst clientId = this.clientId = message.clientId;\r\n\t\tconst container = this.container = message.container;\r\n\t\tconst renderer = this.renderer = new THREE.WebGLRenderer({\r\n\t\t\tantialias: true,\r\n\t\t\talpha: false,\r\n\t\t\tpremultipliedAlpha: true,\r\n\t\t\t// physicallyCorrectLights: true,\r\n\t\t});\r\n\t\trenderer.setClearColor(0x000000, 1);\r\n\t\trenderer.setPixelRatio(window.devicePixelRatio);\r\n\t\trenderer.setSize(W, H);\r\n\t\trenderer.toneMapping = THREE.ACESFilmicToneMapping;\r\n\t\trenderer.toneMappingExposure = 0.8;\r\n\t\trenderer.outputEncoding = THREE.sRGBEncoding;\r\n\t\tcontainer.appendChild(renderer.domElement);\r\n\r\n\t\tconst camera = this.camera = new THREE.PerspectiveCamera(70, W / H, 0.01, 1000);\r\n\t\tcamera.position.set(0, 0, -0.5);\r\n\t\tcamera.target = new THREE.Vector3();\r\n\t\tcamera.lookAt(camera.target);\r\n\r\n\t\tconst scene = this.scene = new THREE.Scene();\r\n\r\n\t\t/*\r\n\t\tconst ambient = this.ambient = new THREE.AmbientLight(0x202020);\r\n\t\tscene.add(ambient);\r\n\t\t*/\r\n\r\n\t\tconst light = this.light = new THREE.PointLight(0xffffff, 1, 100);\r\n\t\tlight.position.set(0, 2, -2);\r\n\t\tscene.add(light);\r\n\r\n\t\tconst head = this.head = this.addHead();\r\n\t\tscene.add(head);\r\n\r\n\t\tconst remote = this.remote = StreamService.getRemoteById(clientId);\r\n\t\t/*\r\n\t\tif (remote) {\r\n\t\t\tthis.subscription = AudioStreamService.volume$(remote.stream).pipe(\r\n\t\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t\t\ttap(meter => {\r\n\t\t\t\t\tthis.chalk(meter.volume);\r\n\t\t\t\t})\r\n\t\t\t);\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\taddHead() {\r\n\t\tconst geometry = AvatarElement.headGeometry;\r\n\t\tconst canvas = this.canvas = document.createElement('canvas');\r\n\t\tcanvas.width = 1024;\r\n\t\tcanvas.height = 512;\r\n\t\tconst ctx = this.ctx = this.canvas.getContext('2d');\r\n\t\tconst map = this.map = new THREE.CanvasTexture(canvas);\r\n\t\tmap.offset.x = -0.25;\r\n\t\tconst color = COLORS[this.clientId % COLORS.length];\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\tmap: map,\r\n\t\t\tcolor: color,\r\n\t\t});\r\n\t\tthis.chalk(0);\r\n\t\treturn new THREE.Mesh(geometry, material);\r\n\t}\r\n\r\n\trender() {\r\n\t\tconst tick = this.tick_ ? ++this.tick_ : this.tick_ = 1;\r\n\t\t// if (tick % 2 === 1) {\r\n\t\tif (this.remote) {\r\n\t\t\tconst audioLevel = this.remote.getAudioLevel() * 12;\r\n\t\t\tthis.chalk(audioLevel);\r\n\t\t}\r\n\t\tconst renderer = this.renderer,\r\n\t\t\tscene = this.scene,\r\n\t\t\tcamera = this.camera;\r\n\t\trenderer.render(scene, camera);\r\n\t\t// }\r\n\t}\r\n\r\n\tupdate(message) {\r\n\t\tconst camera = message.camera;\r\n\t\tconst head = this.head;\r\n\t\thead.quaternion.set(camera[3], camera[4], camera[5], camera[6]);\r\n\t\t/*\r\n\t\thead.position.set(camera[0], camera[1], camera[2]);\r\n\t\t*/\r\n\t}\r\n\r\n\tdispose() {\r\n\t\t// !!! dispose threejs\r\n\t\tif (this.subscription) {\r\n\t\t\tthis.subscription.unsubscribe();\r\n\t\t}\r\n\t}\r\n\r\n\tchalk(i) {\r\n\t\ti = (i + Math.PI * 0.5) % (Math.PI * 2);\r\n\t\tconst vol = Math.sin(i) * 30;\r\n\t\tconst smile = Math.cos(i) * 10;\r\n\t\tconst x = 512;\r\n\t\tconst y = 256;\r\n\t\tconst ctx = this.ctx;\r\n\t\tctx.fillStyle = '#888888';\r\n\t\tctx.fillRect(0, 0, 1024, 512);\r\n\t\tctx.fillStyle = 'white';\r\n\t\tctx.beginPath();\r\n\t\tctx.arc(x - 40, y - 50, 7, 0, 2 * Math.PI);\r\n\t\tctx.arc(x + 40, y - 50, 7, 0, 2 * Math.PI);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tctx.beginPath();\r\n\t\t// ctx.quadraticCurveTo(x - 30, y + 30, x - 30, y + 30);\r\n\t\t// ctx.quadraticCurveTo(x - 30, y + 60, x, y + 60);\r\n\t\t// ctx.quadraticCurveTo(x + 30, y + 60, x + 30, y + 30);\r\n\t\t// ctx.quadraticCurveTo(x + 30, y, x, y);\r\n\t\tctx.moveTo(x - 40 - smile, y + 30);\r\n\t\tctx.bezierCurveTo(x - 40 - smile, y + 60, x + 40 + smile, y + 60, x + 40 + smile, y + 30);\r\n\t\tctx.bezierCurveTo(x + 40 + smile, y + vol, x - 40 - smile, y + vol, x - 40 - smile, y + 30);\r\n\t\t// ctx.arc(x, 256 + 50, 50, 0, 2 * Math.PI);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tthis.map.needsUpdate = true;\r\n\t}\r\n\r\n}\r\n","\r\n\r\nexport default class Camera extends THREE.PerspectiveCamera {\r\n\tconstructor(fov = 70, aspect = 1, near = 0.01, far = 1000, dolly = 70) {\r\n\t\tsuper(fov, aspect, near, far);\r\n\t\tthis.target = new THREE.Vector3();\r\n\t\tthis.box = new THREE.Group();\r\n\t\tthis.add(this.box);\r\n\t}\r\n}\r\n","import { ReplaySubject } from 'rxjs';\r\nimport { assetIsStream, AssetType } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport StateService from '../../state/state.service';\r\n\r\nexport class MediaLoaderEvent {\r\n\tconstructor(src, id) {\r\n\t\tthis.src = src;\r\n\t\tthis.id = id;\r\n\t}\r\n}\r\n\r\nexport class MediaLoaderPlayEvent extends MediaLoaderEvent { }\r\n\r\nexport class MediaLoaderPauseEvent extends MediaLoaderEvent { }\r\n\r\nexport default class MediaLoader {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn MediaLoader.loader || (MediaLoader.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getPath(item) {\r\n\t\treturn environment.getPath(item.asset.folder + item.asset.file);\r\n\t}\r\n\r\n\tstatic loadTexture(item, callback) {\r\n\t\tconst path = MediaLoader.getPath(item);\r\n\t\treturn MediaLoader.getLoader().load(path, callback);\r\n\t}\r\n\r\n\tstatic isVideo(item) {\r\n\t\treturn item.asset && item.asset.file && (item.asset.file.indexOf('.mp4') !== -1 || item.asset.file.indexOf('.webm') !== -1);\r\n\t}\r\n\r\n\tstatic isStream(item) {\r\n\t\treturn assetIsStream(item.asset);\r\n\t}\r\n\r\n\tstatic isPublisherStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.PublisherStream.name;\r\n\t}\r\n\r\n\tstatic isAttendeeStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.AttendeeStream.name;\r\n\t}\r\n\r\n\tstatic isSmartDeviceStream(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.SmartDeviceStream.name;\r\n\t}\r\n\r\n\tstatic isPublisherScreen(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.PublisherScreen.name;\r\n\t}\r\n\r\n\tstatic isAttendeeScreen(item) {\r\n\t\treturn item.asset && item.asset.type.name === AssetType.AttendeeScreen.name;\r\n\t}\r\n\r\n\tget isVideo() {\r\n\t\treturn MediaLoader.isVideo(this.item);\r\n\t}\r\n\r\n\tget isStream() {\r\n\t\treturn MediaLoader.isStream(this.item);\r\n\t}\r\n\r\n\tget isPublisherStream() {\r\n\t\treturn MediaLoader.isPublisherStream(this.item);\r\n\t}\r\n\r\n\tget isAttendeeStream() {\r\n\t\treturn MediaLoader.isAttendeeStream(this.item);\r\n\t}\r\n\r\n\tget isSmartDeviceStream() {\r\n\t\treturn MediaLoader.isSmartDeviceStream(this.item);\r\n\t}\r\n\r\n\tget isPublisherScreen() {\r\n\t\treturn MediaLoader.isPublisherScreen(this.item);\r\n\t}\r\n\r\n\tget isAttendeeScreen() {\r\n\t\treturn MediaLoader.isAttendeeScreen(this.item);\r\n\t}\r\n\r\n\tget isPlayableVideo() {\r\n\t\treturn this.isVideo && !this.item.asset.autoplay;\r\n\t}\r\n\r\n\tget isAutoplayVideo() {\r\n\t\treturn this.isStream || (this.isVideo && (this.item.asset.autoplay != null));\r\n\t}\r\n\r\n\tget muted() {\r\n\t\treturn this.muted_;\r\n\t}\r\n\r\n\tset muted(muted) {\r\n\t\tthis.muted_ = muted;\r\n\t\t// console.log('MediaLoader.muted', muted, this.video);\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.muted = muted === true;\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(item) {\r\n\t\tthis.item = item;\r\n\t\tthis.toggle = this.toggle.bind(this);\r\n\t\tthis.muted_ = false;\r\n\t\tthis.subscription = StateService.state$.subscribe(state => this.muted = state.volumeMuted);\r\n\t}\r\n\r\n\tload(callback) {\r\n\t\tconst item = this.item;\r\n\t\tlet texture;\r\n\t\t// console.log('MediaLoader.load', item, this.isStream);\r\n\t\tif (this.isStream && item.streamId) {\r\n\t\t\tconst streamId = item.streamId;\r\n\t\t\tconst target = `#stream-${streamId}`;\r\n\t\t\tconst video = document.querySelector(`${target} video`);\r\n\t\t\tif (!video) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst onCanPlay = () => {\r\n\t\t\t\tvideo.removeEventListener('canplay', onCanPlay);\r\n\t\t\t\ttexture = this.texture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\t// texture.image.width = video.videoWidth;\r\n\t\t\t\t// texture.image.height = video.videoHeight;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\t\tonCanPlay();\r\n\t\t\t} else {\r\n\t\t\t\tvideo.addEventListener('canplay', onCanPlay);\r\n\t\t\t}\r\n\t\t} else if (this.isVideo) {\r\n\t\t\t// create the video element\r\n\t\t\tconst video = this.video = document.createElement('video');\r\n\t\t\tvideo.preload = 'metadata';\r\n\t\t\tvideo.volume = 0.8;\r\n\t\t\tvideo.muted = true;\r\n\t\t\tvideo.playsInline = true;\r\n\t\t\tvideo.crossOrigin = 'anonymous';\r\n\t\t\tif (item.asset && item.asset.autoplay) {\r\n\t\t\t\tvideo.loop = true;\r\n\t\t\t}\r\n\t\t\tconst onCanPlay = () => {\r\n\t\t\t\tvideo.oncanplay = null;\r\n\t\t\t\ttexture = new THREE.VideoTexture(video);\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\t\t// texture.image.width = video.videoWidth;\r\n\t\t\t\t// texture.image.height = video.videoHeight;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t\tif (!item.asset || !item.asset.autoplay) {\r\n\t\t\t\t\tvideo.pause();\r\n\t\t\t\t}\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tvideo.oncanplay = onCanPlay;\r\n\t\t\tvideo.src = MediaLoader.getPath(item);\r\n\t\t\tvideo.load(); // must call after setting/changing source\r\n\t\t\tthis.play(true);\r\n\t\t} else if (item.asset) {\r\n\t\t\tMediaLoader.loadTexture(item, texture => {\r\n\t\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\t\t// texture.format = THREE.RGBFormat;\r\n\t\t\t\ttexture.wrapS = THREE.RepeatWrapping;\r\n\t\t\t\ttexture.wrapT = THREE.RepeatWrapping;\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(texture, this);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tcallback(null, this);\r\n\t\t}\r\n\t\treturn this;\r\n\t}\r\n\r\n\tplay(silent) {\r\n\t\t// console.log('MediaLoader.play');\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.play().then(() => {\r\n\t\t\t\t// console.log('MediaLoader.play.success', this.item.asset.file);\r\n\t\t\t}, error => {\r\n\t\t\t\tconsole.log('MediaLoader.play.error', this.item.asset.file, error);\r\n\t\t\t});\r\n\t\t\tif (!silent) {\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderPlayEvent(this.video.src, this.item.id));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tpause(silent) {\r\n\t\t// console.log('MediaLoader.pause');\r\n\t\tif (this.video) {\r\n\t\t\tthis.video.muted = true;\r\n\t\t\tthis.video.pause();\r\n\t\t\tif (!silent) {\r\n\t\t\t\tMediaLoader.events$.next(new MediaLoaderPauseEvent(this.video.src, this.item.id));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttoggle() {\r\n\t\t// console.log('MediaLoader.toggle', this.video);\r\n\t\tif (this.video) {\r\n\t\t\tif (this.video.paused) {\r\n\t\t\t\tthis.video.muted = this.muted_;\r\n\t\t\t\tthis.play();\r\n\t\t\t\treturn true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.pause();\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.subscription.unsubscribe();\r\n\t\tthis.pause();\r\n\t\tdelete this.video;\r\n\t}\r\n\r\n}\r\n\r\nMediaLoader.events$ = new ReplaySubject(1);\r\n","import { of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\nimport { assetIsStream, AssetType } from '../../asset/asset';\r\nimport { environment } from '../../environment';\r\nimport StreamService from '../../stream/stream.service';\r\nimport { RoleType } from '../../user/user';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport MediaLoader, { MediaLoaderPauseEvent, MediaLoaderPlayEvent } from './media-loader';\r\n\r\nconst VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\n\r\nconst FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform bool video;\r\nuniform float opacity;\r\nuniform float overlay;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\nuniform vec3 overlayColor;\r\n\r\nvoid main() {\r\n\tvec4 color;\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tif (video) {\r\n\t\tvec4 colorB = texture2D(textureB, vUv);\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2) + (colorB.rgb * tween * colorB.a), opacity);\r\n\t} else {\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2), opacity);\r\n\t}\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nconst FRAGMENT_CHROMA_KEY_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\n#define threshold 0.55\r\n#define padding 0.05\r\n\r\nvarying vec2 vUv;\r\nuniform bool video;\r\nuniform float opacity;\r\nuniform float overlay;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\nuniform vec3 chromaKeyColor;\r\nuniform vec3 overlayColor;\r\n\r\nvoid main() {\r\n\tvec4 color;\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tvec4 chromaKey = vec4(chromaKeyColor, 1.0);\r\n    vec3 chromaKeyDiff = colorA.rgb - chromaKey.rgb;\r\n    float chromaKeyValue = smoothstep(threshold - padding, threshold + padding, dot(chromaKeyDiff, chromaKeyDiff));\r\n\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2), opacity * chromaKeyValue);\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nexport default class MediaMesh extends InteractiveMesh {\r\n\r\n\tstatic getMaterial(useChromaKey) {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\tfragmentShader: useChromaKey ? FRAGMENT_CHROMA_KEY_SHADER : FRAGMENT_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\tvideo: { value: false },\r\n\t\t\t\ttextureA: { type: \"t\", value: null },\r\n\t\t\t\ttextureB: { type: \"t\", value: null },\r\n\t\t\t\tresolutionA: { value: new THREE.Vector2() },\r\n\t\t\t\tresolutionB: { value: new THREE.Vector2() },\r\n\t\t\t\toverlayColor: { value: new THREE.Color('#000000') },\r\n\t\t\t\toverlay: { value: 0 },\r\n\t\t\t\ttween: { value: 1 },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t},\r\n\t\t\t// side: THREE.DoubleSide\r\n\t\t});\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic getChromaKeyMaterial(chromaKeyColor = [0.0, 1.0, 0.0]) {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\tfragmentShader: FRAGMENT_CHROMA_KEY_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\tvideo: { value: false },\r\n\t\t\t\ttextureA: { type: \"t\", value: null },\r\n\t\t\t\ttextureB: { type: \"t\", value: null },\r\n\t\t\t\tresolutionA: { value: new THREE.Vector2() },\r\n\t\t\t\tresolutionB: { value: new THREE.Vector2() },\r\n\t\t\t\tchromaKeyColor: { value: new THREE.Vector3(chromaKeyColor[0], chromaKeyColor[1], chromaKeyColor[2]) },\r\n\t\t\t\toverlayColor: { value: new THREE.Color('#000000') },\r\n\t\t\t\toverlay: { value: 0 },\r\n\t\t\t\ttween: { value: 1 },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t},\r\n\t\t\tside: THREE.DoubleSide\r\n\t\t});\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic isPublisherStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Publisher;\r\n\t}\r\n\tstatic isAttendeeStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Attendee;\r\n\t}\r\n\tstatic isSmartDeviceStream(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.SmartDevice;\r\n\t}\r\n\tstatic isPublisherScreen(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Publisher && stream.clientInfo.uid !== stream.getId();\r\n\t}\r\n\tstatic isAttendeeScreen(stream) {\r\n\t\treturn stream.clientInfo && stream.clientInfo.role === RoleType.Attendee && stream.clientInfo.uid !== stream.getId();\r\n\t}\r\n\tstatic getTypeMatcher(assetType) {\r\n\t\tlet matcher;\r\n\t\tswitch (assetType.name) {\r\n\t\t\tcase AssetType.PublisherStream.name:\r\n\t\t\t\tmatcher = this.isPublisherStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.AttendeeStream.name:\r\n\t\t\t\tmatcher = this.isAttendeeStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.SmartDeviceStream.name:\r\n\t\t\t\tmatcher = this.isSmartDeviceStream;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.PublisherScreen.name:\r\n\t\t\t\tmatcher = this.isPublisherScreen;\r\n\t\t\t\tbreak;\r\n\t\t\tcase AssetType.AttendeeScreen.name:\r\n\t\t\t\tmatcher = this.isAttendeeScreen;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tmatcher = (stream) => { return false; }\r\n\t\t}\r\n\t\treturn matcher;\r\n\t}\r\n\r\n\tstatic getStreamId$(item) {\r\n\t\tif (!item.asset) {\r\n\t\t\treturn of(null);\r\n\t\t}\r\n\t\tconst assetType = item.asset.type;\r\n\t\tconst file = item.asset.file;\r\n\t\tif (assetIsStream(item.asset)) {\r\n\t\t\treturn StreamService.streams$.pipe(\r\n\t\t\t\tmap((streams) => {\r\n\t\t\t\t\tlet stream;\r\n\t\t\t\t\tlet i = 0;\r\n\t\t\t\t\tconst matchType = this.getTypeMatcher(assetType);\r\n\t\t\t\t\tstreams.forEach(x => {\r\n\t\t\t\t\t\tif (matchType(x)) {\r\n\t\t\t\t\t\t\tif (i === item.asset.index) {\r\n\t\t\t\t\t\t\t\tstream = x;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\ti++;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log('MediaMesh.getStreamId$', assetType.name, stream, streams);\r\n\t\t\t\t\tif (stream) {\r\n\t\t\t\t\t\treturn stream.getId();\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\treturn null;\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\treturn of(file);\r\n\t\t}\r\n\t}\r\n\r\n\tstatic getMaterialByItem(item) {\r\n\t\tlet material;\r\n\t\tif (item.asset && item.asset.chromaKeyColor) {\r\n\t\t\tmaterial = MediaMesh.getChromaKeyMaterial(item.asset.chromaKeyColor);\r\n\t\t} else if (item.asset) {\r\n\t\t\tmaterial = MediaMesh.getMaterial();\r\n\t\t} else {\r\n\t\t\tmaterial = new THREE.MeshBasicMaterial({ color: 0x888888 });\r\n\t\t}\r\n\t\treturn material;\r\n\t}\r\n\r\n\tstatic getUniformsByItem(item) {\r\n\t\tlet uniforms = null;\r\n\t\tif (item.asset) {\r\n\t\t\tuniforms = {\r\n\t\t\t\toverlay: 0,\r\n\t\t\t\ttween: 1,\r\n\t\t\t\topacity: 0,\r\n\t\t\t};\r\n\t\t}\r\n\t\treturn uniforms;\r\n\t}\r\n\r\n\tconstructor(item, items, geometry) {\r\n\t\tconst material = MediaMesh.getMaterialByItem(item);\r\n\t\tsuper(geometry, material);\r\n\t\tthis.item = item;\r\n\t\tthis.items = items;\r\n\t\tthis.renderOrder = environment.renderOrder.plane;\r\n\t\tthis.uniforms = MediaMesh.getUniformsByItem(item);\r\n\t\tconst mediaLoader = this.mediaLoader = new MediaLoader(item);\r\n\t\t/*\r\n\t\tif (item.asset && !mediaLoader.isVideo) {\r\n\t\t\tthis.freeze();\r\n\t\t}\r\n\t\t*/\r\n\t}\r\n\r\n\tload(callback) {\r\n\t\tif (!this.item.asset) {\r\n\t\t\tthis.onAppear();\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(this);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst material = this.material;\r\n\t\tconst mediaLoader = this.mediaLoader;\r\n\t\tmediaLoader.load((textureA) => {\r\n\t\t\t// console.log('MediaMesh.textureA', textureA);\r\n\t\t\tif (textureA) {\r\n\t\t\t\tmaterial.uniforms.textureA.value = textureA;\r\n\t\t\t\t// material.uniforms.resolutionA.value.x = textureA.image.width;\r\n\t\t\t\t// material.uniforms.resolutionA.value.y = textureA.image.height;\r\n\t\t\t\tmaterial.uniforms.resolutionA.value = new THREE.Vector2(textureA.image.width || textureA.image.videoWidth, textureA.image.height || textureA.image.videoHeight);\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\tif (mediaLoader.isPlayableVideo) {\r\n\t\t\t\t\tthis.createTextureB(textureA, (textureB) => {\r\n\t\t\t\t\t\t// console.log('MediaMesh.textureB', textureB);\r\n\t\t\t\t\t\ttextureB.minFilter = THREE.LinearFilter;\r\n\t\t\t\t\t\ttextureB.magFilter = THREE.LinearFilter;\r\n\t\t\t\t\t\ttextureB.mapping = THREE.UVMapping;\r\n\t\t\t\t\t\t// textureB.format = THREE.RGBFormat;\r\n\t\t\t\t\t\ttextureB.wrapS = THREE.RepeatWrapping;\r\n\t\t\t\t\t\ttextureB.wrapT = THREE.RepeatWrapping;\r\n\t\t\t\t\t\tmaterial.uniforms.textureB.value = textureB;\r\n\t\t\t\t\t\t// material.uniforms.resolutionB.value.x = textureB.image.width;\r\n\t\t\t\t\t\t// material.uniforms.resolutionB.value.y = textureB.image.height;\r\n\t\t\t\t\t\tmaterial.uniforms.resolutionB.value = new THREE.Vector2(textureB.image.width, textureB.image.height);\r\n\t\t\t\t\t\t// console.log(material.uniforms.resolutionB.value, textureB);\r\n\t\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.onAppear();\r\n\t\t\tif (mediaLoader.isPlayableVideo) {\r\n\t\t\t\tmaterial.uniforms.video.value = true;\r\n\t\t\t\tthis.onOver = this.onOver.bind(this);\r\n\t\t\t\tthis.onOut = this.onOut.bind(this);\r\n\t\t\t\tthis.onToggle = this.onToggle.bind(this);\r\n\t\t\t\tthis.on('over', this.onOver);\r\n\t\t\t\tthis.on('out', this.onOut);\r\n\t\t\t\tthis.on('down', this.onToggle);\r\n\t\t\t}\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(this);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tcreateTextureB(textureA, callback) {\r\n\t\tconst aw = textureA.image.width || textureA.image.videoWidth;\r\n\t\tconst ah = textureA.image.height || textureA.image.videoHeight;\r\n\t\tconst ar = aw / ah;\r\n\t\tconst scale = 0.32;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\tcanvas.width = aw;\r\n\t\tcanvas.height = ah;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.imageSmoothingEnabled = true;\r\n\t\tctx.imageSmoothingQuality = 'high';\r\n\t\tconst image = new Image();\r\n\t\timage.onload = function() {\r\n\t\t\tconst bw = image.width;\r\n\t\t\tconst bh = image.height;\r\n\t\t\tconst br = bw / bh;\r\n\t\t\tlet w;\r\n\t\t\tlet h;\r\n\t\t\tif (ar > br) {\r\n\t\t\t\tw = ah * scale;\r\n\t\t\t\th = w / br;\r\n\t\t\t} else {\r\n\t\t\t\th = aw * scale;\r\n\t\t\t\tw = h * br;\r\n\t\t\t}\r\n\t\t\tctx.drawImage(image, aw / 2 - w / 2, ah / 2 - h / 2, w, h);\r\n\t\t\tconst textureB = new THREE.CanvasTexture(canvas);\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(textureB);\r\n\t\t\t}\r\n\t\t}\r\n\t\timage.crossOrigin = 'anonymous';\r\n\t\timage.src = environment.getPath('textures/ui/play.png');\r\n\t}\r\n\r\n\tevents$() {\r\n\t\tconst item = this.item;\r\n\t\tconst items = this.items;\r\n\t\tif (item.asset && item.asset.linkedPlayId) {\r\n\t\t\tthis.freeze();\r\n\t\t}\r\n\t\treturn MediaLoader.events$.pipe(\r\n\t\t\tmap(event => {\r\n\t\t\t\tif (item.asset && item.asset.linkedPlayId) {\r\n\t\t\t\t\tconst eventItem = items.find(x => x.asset && event.src.indexOf(x.asset.file) !== -1 && event.id === item.asset.linkedPlayId);\r\n\t\t\t\t\tif (eventItem) {\r\n\t\t\t\t\t\t// console.log('MediaLoader.events$.eventItem', event, eventItem);\r\n\t\t\t\t\t\tif (event instanceof MediaLoaderPlayEvent) {\r\n\t\t\t\t\t\t\tthis.play();\r\n\t\t\t\t\t\t} else if (event instanceof MediaLoaderPauseEvent) {\r\n\t\t\t\t\t\t\tthis.pause();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn event;\r\n\t\t\t})\r\n\t\t);\r\n\t}\r\n\r\n\tonAppear() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonDisappear() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonOver() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\toverlay: 1,\r\n\t\t\t\ttween: this.playing ? 0 : 1,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.overlay.value = uniforms.overlay;\r\n\t\t\t\t\tmaterial.uniforms.tween.value = uniforms.tween;\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonOut() {\r\n\t\tconst uniforms = this.uniforms;\r\n\t\tconst material = this.material;\r\n\t\tif (material.uniforms) {\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\toverlay: 0,\r\n\t\t\t\ttween: this.playing ? 0 : 1,\r\n\t\t\t\topacity: 1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.uniforms.overlay.value = uniforms.overlay;\r\n\t\t\t\t\tmaterial.uniforms.tween.value = uniforms.tween;\r\n\t\t\t\t\tmaterial.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonToggle() {\r\n\t\tthis.playing = this.mediaLoader.toggle();\r\n\t\tthis.emit('playing', this.playing);\r\n\t\tthis.onOut();\r\n\t}\r\n\r\n\tplay() {\r\n\t\tthis.mediaLoader.play();\r\n\t\tthis.playing = true;\r\n\t\tthis.emit('playing', true);\r\n\t\tthis.onOut();\r\n\t}\r\n\r\n\tpause() {\r\n\t\tthis.mediaLoader.pause();\r\n\t\tthis.playing = false;\r\n\t\tthis.emit('playing', false);\r\n\t\tthis.onOut();\r\n\t}\r\n\r\n\tsetPlayingState(playing) {\r\n\t\tif (this.playing !== playing) {\r\n\t\t\tthis.playing = playing;\r\n\t\t\tplaying ? this.mediaLoader.play() : this.mediaLoader.pause();\r\n\t\t\tthis.onOut();\r\n\t\t}\r\n\t}\r\n\r\n\tupdateByItem(item) {\r\n\t\tthis.disposeMaterial();\r\n\t\tthis.disposeMediaLoader();\r\n\t\tthis.material = MediaMesh.getMaterialByItem(item);\r\n\t\tthis.uniforms = MediaMesh.getUniformsByItem(item);\r\n\t\tthis.mediaLoader = new MediaLoader(item);\r\n\t}\r\n\r\n\tdisposeMaterial() {\r\n\t\tif (this.material) {\r\n\t\t\tif (this.material.map && this.material.map.disposable !== false) {\r\n\t\t\t\tthis.material.map.dispose();\r\n\t\t\t}\r\n\t\t\tthis.material.dispose();\r\n\t\t\tthis.material = null;\r\n\t\t}\r\n\t}\r\n\r\n\tdisposeMediaLoader() {\r\n\t\tconst mediaLoader = this.mediaLoader;\r\n\t\tif (mediaLoader) {\r\n\t\t\tif (mediaLoader.isPlayableVideo) {\r\n\t\t\t\tthis.off('over', this.onOver);\r\n\t\t\t\tthis.off('out', this.onOut);\r\n\t\t\t\tthis.off('down', this.onToggle);\r\n\t\t\t}\r\n\t\t\tmediaLoader.dispose();\r\n\t\t\tthis.mediaLoader = null;\r\n\t\t}\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tthis.disposeMediaLoader();\r\n\t}\r\n}\r\n\r\n/*\r\nconst FRAGMENT_SHADER_BAK = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform bool video;\r\nuniform float opacity;\r\nuniform float overlay;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\nuniform vec3 overlayColor;\r\n\r\nmat3 rotate(float a) {\r\n\treturn mat3(\r\n\t\tcos(a), sin(a), 0.0,\r\n\t\t-sin(a), cos(a), 0.0,\r\n\t\t0.0, 0.0, 1.0\r\n\t);\r\n}\r\n\r\nmat3 translate(vec2 t) {\r\n\treturn mat3(\r\n\t\t1.0, 0.0, 0.0,\r\n\t\t0.0, 1.0, 0.0,\r\n\t\tt.x, t.y, 1.0\r\n\t);\r\n}\r\n\r\nmat3 scale(vec2 s) {\r\n\treturn mat3(\r\n\t\ts.x, 0.0, 0.0,\r\n\t\t0.0, s.y, 0.0,\r\n\t\t0.0, 0.0, 1.0\r\n\t);\r\n}\r\n\r\nvec2 getUV2(vec2 vUv, vec2 t, vec2 s, float a) {\r\n\tmat3 transform = scale(s) * rotate(a);\r\n\treturn (vec3(vUv + t, 0.0) * transform).xy;\r\n}\r\n\r\nvoid main() {\r\n\tvec4 color;\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tif (video) {\r\n\t\tfloat rA = resolutionA.x / resolutionA.y;\r\n\t\tfloat rB = resolutionB.x / resolutionB.y;\r\n\t\tfloat aspect = 1.0 / rA * rB;\r\n\t\tvec2 s = vec2(3.0 / aspect, 3.0);\r\n\t\tvec2 t = vec2(\r\n\t\t\t-(resolutionA.x - resolutionB.x / s.x) * 0.5 / resolutionA.x,\r\n\t\t\t-(resolutionA.y - resolutionB.y / s.y) * 0.5 / resolutionA.y\r\n\t\t);\r\n\t\tt = vec2(\r\n\t\t\t-(resolutionA.x - resolutionB.x / s.y) * 0.5 / resolutionA.x,\r\n\t\t\t-(resolutionA.y - resolutionB.y / s.y) * 0.5 / resolutionA.y\r\n\t\t);\r\n\t\t// float dx = (resolutionA.x - resolutionB.x) / resolutionA.x * 0.5;\r\n\t\t// float dy = (resolutionA.y - resolutionB.y) / resolutionA.y * 0.5;\r\n\t\t// t = vec2(-0.5 + dx, -0.5 - dy);\r\n\t\tvec2 uv2 = clamp(\r\n\t\t\tgetUV2(vUv, t, s, 0.0),\r\n\t\t\tvec2(0.0,0.0),\r\n\t\t\tvec2(1.0,1.0)\r\n\t\t);\r\n\t\tvec4 colorB = texture2D(textureB, uv2);\r\n\t\tcolorB = texture2D(textureB, vUv);\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2) + (colorB.rgb * tween * colorB.a), opacity);\r\n\t} else {\r\n\t\tcolor = vec4(colorA.rgb + (overlayColor * overlay * 0.2), opacity);\r\n\t}\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n*/\r\n","import { fromEvent, merge, ReplaySubject, Subject } from 'rxjs';\r\nimport { filter, map, startWith, switchMap, takeUntil } from 'rxjs/operators';\r\n\r\nexport class DragPoint {\r\n\tconstructor() {\r\n\t\tthis.x = 0;\r\n\t\tthis.y = 0;\r\n\t}\r\n}\r\n\r\nexport class DragEvent {\r\n\tconstructor(options) {\r\n\t\tif (options) {\r\n\t\t\tObject.assign(this, options);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport class DragDownEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.distance = new DragPoint();\r\n\t\tthis.strength = new DragPoint();\r\n\t\tthis.speed = new DragPoint();\r\n\t}\r\n}\r\n\r\nexport class DragMoveEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t\tthis.distance = new DragPoint();\r\n\t\tthis.strength = new DragPoint();\r\n\t\tthis.speed = new DragPoint();\r\n\t}\r\n}\r\n\r\nexport class DragUpEvent extends DragEvent {\r\n\tconstructor(options) {\r\n\t\tsuper(options);\r\n\t}\r\n}\r\n\r\nlet upEvent;\r\n\r\nexport default class DragService {\r\n\r\n\tstatic getPosition(event, point) {\r\n\t\tif (event instanceof MouseEvent) {\r\n\t\t\tpoint ? (\r\n\t\t\t\tpoint.x = event.clientX,\r\n\t\t\t\tpoint.y = event.clientY\r\n\t\t\t) : point = {\r\n\t\t\t\tx: event.clientX,\r\n\t\t\t\ty: event.clientY,\r\n\t\t\t};\r\n\t\t} else if (window.TouchEvent && event instanceof TouchEvent) {\r\n\t\t\tif (event.touches.length > 0) {\r\n\t\t\t\tpoint ? (\r\n\t\t\t\t\tpoint.x = event.touches[0].pageX,\r\n\t\t\t\t\tpoint.y = event.touches[0].pageY\r\n\t\t\t\t) : point = {\r\n\t\t\t\t\tx: event.touches[0].pageX,\r\n\t\t\t\t\ty: event.touches[0].pageY\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn point;\r\n\t}\r\n\r\n\tstatic down$(target, events$) {\r\n\t\tlet downEvent;\r\n\t\treturn merge(\r\n\t\t\tfromEvent(target, 'mousedown').pipe(filter(event => event.button === 0)),\r\n\t\t\tfromEvent(target, 'touchstart')\r\n\t\t).pipe(\r\n\t\t\tmap((event) => {\r\n\t\t\t\tdownEvent = downEvent || new DragDownEvent();\r\n\t\t\t\tdownEvent.node = target;\r\n\t\t\t\tdownEvent.target = event.target;\r\n\t\t\t\tdownEvent.originalEvent = event;\r\n\t\t\t\tdownEvent.down = this.getPosition(event, downEvent.down);\r\n\t\t\t\tif (downEvent.down) {\r\n\t\t\t\t\tdownEvent.distance = new DragPoint();\r\n\t\t\t\t\tdownEvent.strength = new DragPoint();\r\n\t\t\t\t\tdownEvent.speed = new DragPoint();\r\n\t\t\t\t\tevents$.next(downEvent);\r\n\t\t\t\t\treturn downEvent;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t\tfilter(event => event !== undefined),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic move$(target, events$, dismiss$, downEvent) {\r\n\t\tlet moveEvent;\r\n\t\treturn fromEvent(document, downEvent.originalEvent instanceof MouseEvent ? 'mousemove' : 'touchmove').pipe(\r\n\t\t\tstartWith(downEvent),\r\n\t\t\tmap((event) => {\r\n\t\t\t\tmoveEvent = moveEvent || new DragMoveEvent();\r\n\t\t\t\tmoveEvent.node = target;\r\n\t\t\t\tmoveEvent.target = event.target;\r\n\t\t\t\tmoveEvent.originalEvent = event;\r\n\t\t\t\tmoveEvent.position = this.getPosition(event, moveEvent.position);\r\n\t\t\t\tconst dragging = downEvent.down !== undefined && moveEvent.position !== undefined;\r\n\t\t\t\tif (dragging) {\r\n\t\t\t\t\tmoveEvent.distance.x = moveEvent.position.x - downEvent.down.x;\r\n\t\t\t\t\tmoveEvent.distance.y = moveEvent.position.y - downEvent.down.y;\r\n\t\t\t\t\tmoveEvent.strength.x = moveEvent.distance.x / window.innerWidth * 2;\r\n\t\t\t\t\tmoveEvent.strength.y = moveEvent.distance.y / window.innerHeight * 2;\r\n\t\t\t\t\tmoveEvent.speed.x = downEvent.speed.x + (moveEvent.strength.x - downEvent.strength.x) * 0.1;\r\n\t\t\t\t\tmoveEvent.speed.y = downEvent.speed.y + (moveEvent.strength.y - downEvent.strength.y) * 0.1;\r\n\t\t\t\t\tdownEvent.distance.x = moveEvent.distance.x;\r\n\t\t\t\t\tdownEvent.distance.y = moveEvent.distance.y;\r\n\t\t\t\t\tdownEvent.speed.x = moveEvent.speed.x;\r\n\t\t\t\t\tdownEvent.speed.y = moveEvent.speed.y;\r\n\t\t\t\t\tdownEvent.strength.x = moveEvent.strength.x;\r\n\t\t\t\t\tdownEvent.strength.y = moveEvent.strength.y;\r\n\t\t\t\t\tevents$.next(moveEvent);\r\n\t\t\t\t\treturn moveEvent;\r\n\t\t\t\t}\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic dismissEvent(event, events$, dismiss$, downEvent) {\r\n\t\t// console.log('DragService.dismissEvent', event);\r\n\t\tupEvent = upEvent || new DragUpEvent();\r\n\t\tevents$.next(upEvent);\r\n\t\tdismiss$.next();\r\n\t\t// console.log(downEvent.distance);\r\n\t\tif (downEvent && Math.abs(downEvent.distance.x) > 10) {\r\n\t\t\tevent.preventDefault();\r\n\t\t\tevent.stopImmediatePropagation();\r\n\t\t}\r\n\t\treturn upEvent;\r\n\t}\r\n\r\n\tstatic up$(target, events$, dismiss$, downEvent) {\r\n\t\treturn fromEvent(document, downEvent.originalEvent instanceof MouseEvent ? 'mouseup' : 'touchend').pipe(\r\n\t\t\tmap(event => this.dismissEvent(event, events$, dismiss$, downEvent)),\r\n\t\t);\r\n\t}\r\n\r\n\tstatic observe$(target) {\r\n\t\ttarget = target || document;\r\n\t\tconst events$ = DragService.events$ = new ReplaySubject(1);\r\n\t\tconst dismiss$ = DragService.dismiss$ = new Subject();\r\n\t\treturn this.down$(target, events$).pipe(\r\n\t\t\tswitchMap((downEvent) => {\r\n\t\t\t\tDragService.downEvent = downEvent;\r\n\t\t\t\treturn merge(\r\n\t\t\t\t\tthis.move$(target, events$, dismiss$, downEvent),\r\n\t\t\t\t\tthis.up$(target, events$, dismiss$, downEvent),\r\n\t\t\t\t).pipe(\r\n\t\t\t\t\ttakeUntil(dismiss$),\r\n\t\t\t\t);\r\n\t\t\t}),\r\n\t\t\tswitchMap(() => events$),\r\n\t\t);\r\n\t}\r\n\r\n}\r\n","import { combineLatest, ReplaySubject } from 'rxjs';\r\nimport { filter, map, startWith, switchMap, tap } from 'rxjs/operators';\r\nimport DragService, { DragDownEvent, DragMoveEvent, DragUpEvent } from '../../drag/drag.service';\r\nimport KeyboardService from '../../keyboard/keyboard.service';\r\nimport StateService from '../../state/state.service';\r\n\r\nexport const OrbitMode = {\r\n\tPanorama: 'panorama',\r\n\tPanoramaGrid: 'panorama-grid',\r\n\tModel: 'model',\r\n};\r\n\r\nexport class OrbitEvent { }\r\nexport class OrbitDragEvent extends OrbitEvent { }\r\nexport class OrbitResizeEvent extends OrbitEvent { }\r\nexport class OrbitMoveEvent extends OrbitEvent { }\r\nconst orbitMoveEvent = new OrbitMoveEvent();\r\nconst orbitDragEvent = new OrbitDragEvent();\r\nconst orbitResizeEvent = new OrbitResizeEvent();\r\n\r\nexport const USE_DOLLY = false;\r\nexport const DOLLY_MIN = 15;\r\nexport const DOLLY_MAX = 75; // 115\r\nexport const ZOOM_MIN = 15;\r\nexport const ZOOM_MAX = 75;\r\n\r\nexport default class OrbitService {\r\n\r\n\tget dolly() {\r\n\t\treturn this.dolly_;\r\n\t}\r\n\tset dolly(dolly) {\r\n\t\tconst clampedDolly = THREE.Math.clamp(dolly, DOLLY_MIN, DOLLY_MAX);\r\n\t\tif (this.dolly_ !== clampedDolly) {\r\n\t\t\tthis.dolly_ = clampedDolly;\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\tgetDollyValue() {\r\n\t\treturn (1 - (this.dolly_ - DOLLY_MIN) / (DOLLY_MAX - DOLLY_MIN)) - 0.5;\r\n\t}\r\n\r\n\tget zoom() {\r\n\t\treturn this.zoom_;\r\n\t}\r\n\tset zoom(zoom) {\r\n\t\tconst clampedDolly = THREE.Math.clamp(zoom, DOLLY_MIN, DOLLY_MAX);\r\n\t\tif (this.zoom_ !== clampedDolly) {\r\n\t\t\tthis.zoom_ = clampedDolly;\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\tgetZoomValue() {\r\n\t\treturn 1 + 1 - (this.zoom_ - ZOOM_MIN) / (ZOOM_MAX - ZOOM_MIN);\r\n\t}\r\n\r\n\tget mode() {\r\n\t\treturn this.mode_;\r\n\t}\r\n\tset mode(mode) {\r\n\t\tif (this.mode_ !== mode) {\r\n\t\t\tthis.mode_ = mode;\r\n\t\t\tOrbitService.mode = mode;\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor(camera) {\r\n\t\tthis.mode_ = OrbitService.mode = OrbitMode.Panorama;\r\n\t\tthis.dolly_ = 70;\r\n\t\tthis.zoom_ = 70;\r\n\t\tthis.longitude = 0;\r\n\t\tthis.latitude = 0;\r\n\t\tthis.direction = 1;\r\n\t\tthis.radius = 101;\r\n\t\tthis.position = new THREE.Vector3();\r\n\t\t// this.speed = 1;\r\n\t\tthis.inertia = new THREE.Vector2();\r\n\t\tthis.rotation = new THREE.Euler(0, 0, 0, 'XYZ');\r\n\t\tthis.target = new THREE.Vector3();\r\n\t\tthis.updatePosition = new THREE.Vector3();\r\n\t\tthis.updateTarget = new THREE.Vector3();\r\n\t\tthis.camera = camera;\r\n\t\tthis.setLongitudeLatitude(0, 0);\r\n\t\tthis.events$ = new ReplaySubject(1);\r\n\t}\r\n\r\n\tsetOrientation(orientation) {\r\n\t\tif (orientation) {\r\n\t\t\tthis.setLongitudeLatitude(orientation.longitude, orientation.latitude);\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\r\n\tgetOrientation() {\r\n\t\treturn {\r\n\t\t\tlatitude: this.latitude,\r\n\t\t\tlongitude: this.longitude,\r\n\t\t};\r\n\t}\r\n\r\n\tsetLongitudeLatitude(longitude, latitude) {\r\n\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\tthis.longitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\tthis.latitude = latitude;\r\n\t\t// console.log(this.longitude);\r\n\t\tconst phi = THREE.Math.degToRad(90 - latitude);\r\n\t\tconst theta = THREE.Math.degToRad(longitude);\r\n\t\tthis.phi = phi;\r\n\t\tthis.theta = theta;\r\n\t}\r\n\r\n\tobserve$(node) {\r\n\t\t// const camera = this.camera;\r\n\t\tlet latitude, longitude;\r\n\t\treturn combineLatest([KeyboardService.keys$(), DragService.observe$(node)]).pipe(\r\n\t\t\tfilter(event => (!StateService.state.locked && !StateService.state.spying)),\r\n\t\t\tmap((datas) => {\r\n\t\t\t\tconst keys = datas[0];\r\n\t\t\t\tconst event = datas[1];\r\n\t\t\t\t// const group = this.objects.children[this.index];\r\n\t\t\t\tif (event instanceof DragDownEvent) {\r\n\t\t\t\t\tlatitude = this.latitude;\r\n\t\t\t\t\tlongitude = this.longitude;\r\n\t\t\t\t} else if (event instanceof DragMoveEvent) {\r\n\t\t\t\t\tif (keys.Shift) {\r\n\t\t\t\t\t\tthis.events$.next(orbitDragEvent);\r\n\t\t\t\t\t} else if (keys.Control) {\r\n\t\t\t\t\t\tthis.events$.next(orbitResizeEvent);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst flip = this.mode_ === OrbitMode.Model ? -1 : 1;\r\n\t\t\t\t\t\tthis.setLongitudeLatitude(longitude - event.distance.x * 0.1 * flip, latitude + event.distance.y * 0.1);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (event instanceof DragUpEvent) {\r\n\r\n\t\t\t\t}\r\n\t\t\t\treturn event;\r\n\t\t\t}),\r\n\t\t\tfilter(event => event instanceof DragMoveEvent),\r\n\t\t\tstartWith({ latitude: this.latitude, longitude: this.longitude }),\r\n\t\t\ttap(event => this.update()),\r\n\t\t\tswitchMap(event => this.events$),\r\n\t\t);\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tlet radius, position = this.updatePosition, target = this.updateTarget;\r\n\t\tconst zoom = this.getZoomValue();\r\n\t\tconst dolly = this.getDollyValue();\r\n\t\t// console.log('dolly', dolly);\r\n\t\tconst phi = THREE.MathUtils.degToRad(90 - this.latitude);\r\n\t\tconst theta = THREE.MathUtils.degToRad(this.longitude);\r\n\t\tconst camera = this.camera;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = USE_DOLLY ? 3 + 3 * dolly : 3;\r\n\t\t\t\tposition.copy(this.position);\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tcamera.target.copy(position);\r\n\t\t\t\tcamera.position.copy(target);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tif (USE_DOLLY) {\r\n\t\t\t\t\tposition.copy(target).position.multiplyScalar(-1 * dolly);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tposition.copy(this.position);\r\n\t\t\t\t}\r\n\t\t\t\tcamera.position.copy(position);\r\n\t\t\t\tcamera.target.copy(target);\r\n\t\t}\r\n\t\t// console.log(camera.position.x, camera.position.y, camera.position.z);\r\n\t\t// console.log(camera.target.x, camera.target.y, camera.target.z);\r\n\t\t// console.log('phi', phi, 'theta', theta);\r\n\t\t// this.inverse();\r\n\t\tif (!USE_DOLLY) {\r\n\t\t\tcamera.zoom = zoom;\r\n\t\t}\r\n\t\tcamera.lookAt(camera.target);\r\n\t\tcamera.updateProjectionMatrix();\r\n\t\tthis.events$.next(orbitMoveEvent);\r\n\t}\r\n\r\n\t/*\r\n\tinverse() {\r\n\t\tlet position, radius;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = 3;\r\n\t\t\t\tposition = this.camera.position;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t\t\tposition = this.camera.target;\r\n\t\t}\r\n\t\tradius = Math.sqrt(position.x * position.x + position.y * position.y + position.z * position.z);\r\n\t\tconst phi = Math.acos(position.y / radius);\r\n\t\tconst theta = Math.atan2(position.z, position.x);\r\n\t\t// console.log('phi', phi, 'theta', theta);\r\n\t}\r\n\t*/\r\n\r\n\trender() {\r\n\t\tthis.longitude += 0.025;\r\n\t\tthis.update();\r\n\t}\r\n\r\n\twalk(position, callback) {\r\n\t\tlet radius;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = 3;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t}\r\n\t\tconst heading = new THREE.Vector2(position.x, position.y).normalize().multiplyScalar(radius);\r\n\t\tconst headingTheta = Math.atan2(heading.y, heading.x);\r\n\t\tlet headingLongitude = THREE.MathUtils.radToDeg(headingTheta);\r\n\t\theadingLongitude = (headingLongitude < 0 ? 360 + headingLongitude : headingLongitude) % 360;\r\n\t\tconst headingLatitude = 0;\r\n\t\tconst latitude = this.latitude;\r\n\t\tconst longitude = this.longitude;\r\n\t\tlet differenceLongitude = (headingLongitude - longitude);\r\n\t\tdifferenceLongitude = Math.abs(differenceLongitude) > 180 ? (differenceLongitude - 360 * (differenceLongitude / Math.abs(differenceLongitude))) : differenceLongitude;\r\n\t\tlet differenceLatitude = (headingLatitude - latitude);\r\n\t\tdifferenceLatitude = Math.abs(differenceLatitude) > 90 ? (differenceLatitude - 90 * (differenceLatitude / Math.abs(differenceLatitude))) : differenceLatitude;\r\n\t\t// console.log('headingTheta', headingTheta, 'headingLongitude', headingLongitude, 'differenceLongitude', differenceLongitude);\r\n\t\tconst from = { tween: 0 };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.7,\r\n\t\t\ttween: 1,\r\n\t\t\tdelay: 0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.setLongitudeLatitude(longitude + differenceLongitude * from.tween, latitude + differenceLatitude * from.tween);\r\n\t\t\t\tthis.position.set(position.x * from.tween, 0, position.y * from.tween);\r\n\t\t\t\tthis.update();\r\n\t\t\t},\r\n\t\t\tonComplete: () => {\r\n\t\t\t\t// this.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback(headingLongitude, headingLatitude);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\twalkComplete(headingLongitude, headingLatitude) {\r\n\t\tthis.setLongitudeLatitude(headingLongitude, headingLatitude);\r\n\t\tthis.position.set(0, 0, 0);\r\n\t\tthis.update();\r\n\t}\r\n\r\n\tlookAt(object3d) {\r\n\t\t// !!! fix\r\n\t\tif (object3d) {\r\n\t\t\t/*\r\n\t\t\tconst camera = this.camera;\r\n\t\t\tcamera.target.copy(object3d.position);\r\n\t\t\tcamera.lookAt(camera.target);\r\n\t\t\tcamera.updateProjectionMatrix();\r\n\t\t\t*/\r\n\t\t\tconst position = object3d.position;\r\n\t\t\tlet radius;\r\n\t\t\tswitch (this.mode_) {\r\n\t\t\t\tcase OrbitMode.Model:\r\n\t\t\t\t\tradius = 3;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\tradius = this.radius;\r\n\t\t\t}\r\n\t\t\tconst heading = new THREE.Vector3(position.x, position.z, position.y).normalize().multiplyScalar(radius);\r\n\t\t\tconst theta = Math.atan2(heading.y, heading.x);\r\n\t\t\tconst phi = Math.acos(heading.z / radius);\r\n\t\t\tlet longitude = THREE.MathUtils.radToDeg(theta);\r\n\t\t\tlongitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\t\tlet latitude = 90 - THREE.MathUtils.radToDeg(phi);\r\n\t\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\t\tthis.setLongitudeLatitude(longitude, latitude);\r\n\t\t\tthis.update();\r\n\t\t\t// this.events$.next(orbitMoveEvent);\r\n\t\t}\r\n\t\t/*\r\n\t\tlet radius, position = this.updatePosition, target = this.updateTarget;\r\n\t\tconst zoom = this.getZoomValue();\r\n\t\tconst dolly = this.getDollyValue();\r\n\t\t// console.log('dolly', dolly);\r\n\t\tconst phi = THREE.MathUtils.degToRad(90 - this.latitude);\r\n\t\tconst theta = THREE.MathUtils.degToRad(this.longitude);\r\n\t\tconst camera = this.camera;\r\n\t\tswitch (this.mode_) {\r\n\t\t\tcase OrbitMode.Model:\r\n\t\t\t\tradius = USE_DOLLY ? 3 + 3 * dolly : 3;\r\n\t\t\t\tposition.copy(this.position);\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tcamera.target.copy(position);\r\n\t\t\t\tcamera.position.copy(target);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tradius = this.radius;\r\n\t\t\t\ttarget.x = this.position.x + radius * Math.sin(phi) * Math.cos(theta);\r\n\t\t\t\ttarget.y = this.position.y + radius * Math.cos(phi);\r\n\t\t\t\ttarget.z = this.position.z + radius * Math.sin(phi) * Math.sin(theta);\r\n\t\t\t\tif (USE_DOLLY) {\r\n\t\t\t\t\tposition.copy(target).position.multiplyScalar(-1 * dolly);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tposition.copy(this.position);\r\n\t\t\t\t}\r\n\t\t\t\tcamera.position.copy(position);\r\n\t\t\t\tcamera.target.copy(target);\r\n\t\t}\r\n\t\t// console.log(camera.position.x, camera.position.y, camera.position.z);\r\n\t\t// console.log(camera.target.x, camera.target.y, camera.target.z);\r\n\t\t// console.log('phi', phi, 'theta', theta);\r\n\t\t// this.inverse();\r\n\t\tif (!USE_DOLLY) {\r\n\t\t\tcamera.zoom = zoom;\r\n\t\t}\r\n\t\tcamera.lookAt(camera.target);\r\n\t\tcamera.updateProjectionMatrix();\r\n\t\tthis.events$.next(orbitMoveEvent);\r\n\t\t*/\r\n\t}\r\n\r\n\tsetVRCamera(camera) {\r\n\t\tif (camera) {\r\n\t\t\t// head.quaternion.set(camera[3], camera[4], camera[5], camera[6]);\r\n\t\t\t// head.position.set(camera[0], camera[1], camera[2]);\r\n\t\t\tconst radius = this.radius;\r\n\t\t\tconst position = new THREE.Vector3(0, 0, -radius);\r\n\t\t\tconst quaternion = new THREE.Quaternion(camera[3], camera[4], camera[5], camera[6]);\r\n\t\t\tposition.applyQuaternion(quaternion);\r\n\t\t\tconst heading = new THREE.Vector3(position.x, position.z, position.y).normalize().multiplyScalar(radius);\r\n\t\t\tconst theta = Math.atan2(heading.y, heading.x);\r\n\t\t\tconst phi = Math.acos(heading.z / radius);\r\n\t\t\tlet longitude = THREE.MathUtils.radToDeg(theta);\r\n\t\t\tlongitude = (longitude < 0 ? 360 + longitude : longitude) % 360;\r\n\t\t\tlet latitude = 90 - THREE.MathUtils.radToDeg(phi);\r\n\t\t\tlatitude = Math.max(-80, Math.min(80, latitude));\r\n\t\t\tthis.setLongitudeLatitude(longitude, latitude);\r\n\t\t\tthis.update();\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import StreamService from \"../../stream/stream.service\";\r\n\r\nexport const W = 12;\r\nexport const H = 27;\r\nexport const D = 0.5;\r\nexport const R = 4 / 3;\r\nexport const COLORS = [0xffffff, 0xffcc00, 0x00ffcc, 0x00ccff, 0xccff00, 0xcc00ff];\r\n\r\nexport class PhoneStreamElement {\r\n\r\n\tstatic get geometry() {\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(0.01 * W, 0.01 * W / R, 2, 2);\r\n\t\treturn geometry;\r\n\t}\r\n\r\n\tsetRemote(remote, i, total) {\r\n\t\tthis.remote = remote;\r\n\t\tlet s, c, r, w, h, sx, sy, sz = 0.01 * D; // !!! double distance\r\n\t\tif (total < 4) {\r\n\t\t\ts = 1;\r\n\t\t\tc = 0;\r\n\t\t\tr = i;\r\n\t\t\tw = 0.01 * W * s;\r\n\t\t\th = w / R;\r\n\t\t\tsx = 0;\r\n\t\t\tsy = h / 2 - (total * h) / 2;\r\n\t\t\tthis.plane.position.set(sx, sy + h * i, sz);\r\n\t\t} else {\r\n\t\t\ts = 0.5;\r\n\t\t\tc = i % 2;\r\n\t\t\tr = Math.floor(i / 2);\r\n\t\t\tw = 0.01 * W * s;\r\n\t\t\th = w / R;\r\n\t\t\tsx = -w / 2;\r\n\t\t\tsy = h / 2 - (Math.ceil(total / 2) * h) / 2;\r\n\t\t\tthis.plane.position.set(sx + c * w, sy + r * h, sz);\r\n\t\t}\r\n\t\tthis.plane.scale.set(s, s, s);\r\n\t\t// console.log(this.plane.position);\r\n\t\tif (typeof remote === 'number') {\r\n\t\t\tthis.plane.material.color.set(COLORS[i % COLORS.length]);\r\n\t\t} else {\r\n\t\t\tif (remote.texture) {\r\n\t\t\t\tthis.plane.material.map = remote.texture;\r\n\t\t\t\tthis.plane.material.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\tthis.addStreamTexture(remote.getId(), (texture) => {\r\n\t\t\t\t\tremote.texture = texture;\r\n\t\t\t\t\tthis.plane.material.map = texture;\r\n\t\t\t\t\tthis.plane.material.needsUpdate = true;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddStreamTexture(streamId, callback) {\r\n\t\tconst target = `#stream-${streamId}`;\r\n\t\tconst video = document.querySelector(`${target} video`);\r\n\t\tif (!video) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst onPlaying = () => {\r\n\t\t\tconst texture = new THREE.VideoTexture(video);\r\n\t\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\t\ttexture.mapping = THREE.UVMapping;\r\n\t\t\ttexture.format = THREE.RGBFormat;\r\n\t\t\ttexture.needsUpdate = true;\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(texture);\r\n\t\t\t}\r\n\t\t};\r\n\t\tvideo.crossOrigin = 'anonymous';\r\n\t\tif (video.readyState >= video.HAVE_FUTURE_DATA) {\r\n\t\t\tonPlaying();\r\n\t\t} else {\r\n\t\t\tvideo.oncanplay = () => {\r\n\t\t\t\tonPlaying();\r\n\t\t\t};\r\n\t\t}\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tconst geometry = PhoneStreamElement.geometry;\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\tcolor: 0xffffff,\r\n\t\t\tside: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst plane = this.plane = new THREE.Mesh(geometry, material);\r\n\t}\r\n\r\n}\r\n\r\nexport default class PhoneElement {\r\n\r\n\tset remotes(remotes) {\r\n\t\t// console.log('PhoneElement', remotes);\r\n\t\tremotes.forEach((remote, i) => {\r\n\t\t\tlet stream = this.streams[i];\r\n\t\t\tif (!stream) {\r\n\t\t\t\tstream = new PhoneStreamElement();\r\n\t\t\t}\r\n\t\t\tstream.setRemote(remote, i, remotes.length);\r\n\t\t\tthis.phone.add(stream.plane);\r\n\t\t\tthis.streams[i] = stream;\r\n\t\t});\r\n\t\tfor (let i = remotes.length; i < this.streams.length; i++) {\r\n\t\t\tthis.phone.remove(this.streams[i].plane);\r\n\t\t}\r\n\t\tthis.streams.length = remotes.length;\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tconst mesh = this.mesh = new THREE.Group();\r\n\t\tconst phone = this.phone = this.create();\r\n\t\tmesh.add(phone);\r\n\t\tconst streams = this.streams = [];\r\n\t\tStreamService.remotes$.subscribe(remotes => {\r\n\t\t\tthis.remotes = remotes;\r\n\t\t});\r\n\t}\r\n\r\n\tcreate() {\r\n\t\tconst geometry = new THREE.BoxBufferGeometry(0.01 * W, 0.01 * H, 0.01 * D, 2, 2, 1);\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\tcolor: 0x202020,\r\n\t\t});\r\n\t\tconst phone = new THREE.Mesh(geometry, material);\r\n\t\tphone.rotation.set(-Math.PI / 4, 0, 0);\r\n\t\treturn phone;\r\n\t}\r\n\r\n}\r\n","import { environment } from '../../environment';\r\nimport Interactive from '../interactive/interactive';\r\n\r\nconst ORIGIN = new THREE.Vector3();\r\n\r\nexport default class PointerElement {\r\n\r\n\tconstructor(color = '#ffffff') {\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(1.2, 1.2, 2, 2);\r\n\t\tconst loader = new THREE.TextureLoader();\r\n\t\tconst texture = loader.load(environment.getPath('textures/ui/nav-point.png'));\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tcolor: new THREE.Color(color),\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tmap: texture,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.9,\r\n\t\t});\r\n\t\tconst mesh = this.mesh = new THREE.Mesh(geometry, material);\r\n\t\tmesh.renderOrder = environment.renderOrder.pointer;\r\n\t\tmesh.position.set(-100000, -100000, -100000);\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tif (Interactive.lastIntersectedObject) {\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tconst position = Interactive.lastIntersectedObject.intersection.point.multiplyScalar(0.99);\r\n\t\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t\tconst s = mesh.position.length() / 80;\r\n\t\t\tmesh.scale.set(s, s, s);\r\n\t\t\tmesh.lookAt(ORIGIN);\r\n\t\t}\r\n\t}\r\n\r\n\tsetPosition(x, y, z) {\r\n\t\tconst mesh = this.mesh;\r\n\t\tmesh.position.set(x, y, z).multiplyScalar(80);\r\n\t\tconst s = mesh.position.length() / 80;\r\n\t\tmesh.scale.set(s, s, s);\r\n\t\tmesh.lookAt(ORIGIN);\r\n\t\t// console.log('PointerElement.setPosition', x, y, z);\r\n\t}\r\n}\r\n","import Emittable from '../interactive/emittable';\r\n\r\nexport class Gamepad extends Emittable {\r\n\tconstructor(gamepad) {\r\n\t\tsuper();\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.buttons = {};\r\n\t\tthis.axes = {};\r\n\t}\r\n\r\n\tupdate() {\r\n\t\tthis.updateButtons();\r\n\t\tthis.updateAxes();\r\n\t}\r\n\r\n\tupdateButtons() {\r\n\t\tthis.gamepad.buttons.forEach((x, i) => {\r\n\t\t\tconst pressed = x.pressed;\r\n\t\t\tconst button = this.buttons[i] || (this.buttons[i] = new GamepadButton(i, this));\r\n\t\t\tif (button.pressed !== pressed) {\r\n\t\t\t\tbutton.pressed = pressed;\r\n\t\t\t\tif (pressed) {\r\n\t\t\t\t\tthis.emit('press', button);\r\n\t\t\t\t} else if (status !== undefined) {\r\n\t\t\t\t\tthis.emit('release', button);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tupdateAxes() {\r\n\t\tconst axes = this.gamepad.axes;\r\n\t\tfor (let i = 0; i < axes.length; i += 2) {\r\n\t\t\tconst index = Math.floor(i / 2);\r\n\t\t\tconst axis = this.axes[index] || (this.axes[index] = new GamepadAxis(index, this));\r\n\t\t\tconst x = axes[i];\r\n\t\t\tconst y = axes[i + 1];\r\n\t\t\tif (axis.x !== x || axis.y !== y) {\r\n\t\t\t\taxis.x = x;\r\n\t\t\t\taxis.y = y;\r\n\t\t\t\tif (Math.abs(x) > Math.abs(y)) {\r\n\t\t\t\t\tconst left = x < -0.85;\r\n\t\t\t\t\tconst right = x > 0.85;\r\n\t\t\t\t\tif (axis.left !== left) {\r\n\t\t\t\t\t\taxis.left = left;\r\n\t\t\t\t\t\tthis.emit((left ? 'left' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} left ${left}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (axis.right !== right) {\r\n\t\t\t\t\t\taxis.right = right;\r\n\t\t\t\t\t\tthis.emit((right ? 'right' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} right ${right}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconst up = y < -0.85;\r\n\t\t\t\t\tconst down = y > 0.85;\r\n\t\t\t\t\tif (axis.up !== up) {\r\n\t\t\t\t\t\taxis.up = up;\r\n\t\t\t\t\t\tthis.emit((up ? 'up' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} up ${up}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (axis.down !== down) {\r\n\t\t\t\t\t\taxis.down = down;\r\n\t\t\t\t\t\tthis.emit((down ? 'down' : 'none'), axis);\r\n\t\t\t\t\t\t// console.log(`${axis.gamepad.hand} ${axis.gamepad.index} down ${down}`);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.emit('axis', axis);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfeedback(strength = 0.1, duration = 50) {\r\n\t\t// !!! care for battery\r\n\t\tconst actuators = this.gamepad.hapticActuators;\r\n\t\tif (actuators && actuators.length) {\r\n\t\t\treturn actuators[0].pulse(strength, duration);\r\n\t\t} else {\r\n\t\t\treturn Promise.reject();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nclass GamepadButton {\r\n\tconstructor(index, gamepad) {\r\n\t\tthis.index = index;\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.pressed = false;\r\n\t}\r\n}\r\n\r\nclass GamepadAxis extends THREE.Vector2 {\r\n\tconstructor(index, gamepad) {\r\n\t\tsuper();\r\n\t\tthis.index = index;\r\n\t\tthis.gamepad = gamepad;\r\n\t\tthis.left = this.right = this.up = this.down = false;\r\n\t}\r\n}\r\n","export default class Emittable {\r\n\r\n\tconstructor() {\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","/**\r\n * @webxr-input-profiles/motion-controllers 1.0.0 https://github.com/immersive-web/webxr-input-profiles\r\n */\r\n\r\nconst Constants = {\r\n  Handedness: Object.freeze({\r\n    NONE: 'none',\r\n    LEFT: 'left',\r\n    RIGHT: 'right'\r\n  }),\r\n\r\n  ComponentState: Object.freeze({\r\n    DEFAULT: 'default',\r\n    TOUCHED: 'touched',\r\n    PRESSED: 'pressed'\r\n  }),\r\n\r\n  ComponentProperty: Object.freeze({\r\n    BUTTON: 'button',\r\n    X_AXIS: 'xAxis',\r\n    Y_AXIS: 'yAxis',\r\n    STATE: 'state'\r\n  }),\r\n\r\n  ComponentType: Object.freeze({\r\n    TRIGGER: 'trigger',\r\n    SQUEEZE: 'squeeze',\r\n    TOUCHPAD: 'touchpad',\r\n    THUMBSTICK: 'thumbstick',\r\n    BUTTON: 'button'\r\n  }),\r\n\r\n  ButtonTouchThreshold: 0.05,\r\n\r\n  AxisTouchThreshold: 0.1,\r\n\r\n  VisualResponseProperty: Object.freeze({\r\n    TRANSFORM: 'transform',\r\n    VISIBILITY: 'visibility'\r\n  })\r\n};\r\n\r\n/**\r\n * @description Static helper function to fetch a JSON file and turn it into a JS object\r\n * @param {string} path - Path to JSON file to be fetched\r\n */\r\nasync function fetchJsonFile(path) {\r\n  const response = await fetch(path);\r\n  if (!response.ok) {\r\n    throw new Error(response.statusText);\r\n  } else {\r\n    return response.json();\r\n  }\r\n}\r\n\r\nasync function fetchProfilesList(basePath) {\r\n  if (!basePath) {\r\n    throw new Error('No basePath supplied');\r\n  }\r\n\r\n  const profileListFileName = 'profilesList.json';\r\n  const profilesList = await fetchJsonFile(`${basePath}/${profileListFileName}`);\r\n  return profilesList;\r\n}\r\n\r\nasync function fetchProfile(xrInputSource, basePath, defaultProfile = null, getAssetPath = true) {\r\n  if (!xrInputSource) {\r\n    throw new Error('No xrInputSource supplied');\r\n  }\r\n\r\n  if (!basePath) {\r\n    throw new Error('No basePath supplied');\r\n  }\r\n\r\n  // Get the list of profiles\r\n  const supportedProfilesList = await fetchProfilesList(basePath);\r\n\r\n  // Find the relative path to the first requested profile that is recognized\r\n  let match;\r\n  xrInputSource.profiles.some((profileId) => {\r\n    const supportedProfile = supportedProfilesList[profileId];\r\n    if (supportedProfile) {\r\n      match = {\r\n        profileId,\r\n        profilePath: `${basePath}/${supportedProfile.path}`,\r\n        deprecated: !!supportedProfile.deprecated\r\n      };\r\n    }\r\n    return !!match;\r\n  });\r\n\r\n  if (!match) {\r\n    if (!defaultProfile) {\r\n      throw new Error('No matching profile name found');\r\n    }\r\n\r\n    const supportedProfile = supportedProfilesList[defaultProfile];\r\n    if (!supportedProfile) {\r\n      throw new Error(`No matching profile name found and default profile \"${defaultProfile}\" missing.`);\r\n    }\r\n\r\n    match = {\r\n      profileId: defaultProfile,\r\n      profilePath: `${basePath}/${supportedProfile.path}`,\r\n      deprecated: !!supportedProfile.deprecated\r\n    };\r\n  }\r\n\r\n  const profile = await fetchJsonFile(match.profilePath);\r\n\r\n  let assetPath;\r\n  if (getAssetPath) {\r\n    let layout;\r\n    if (xrInputSource.handedness === 'any') {\r\n      layout = profile.layouts[Object.keys(profile.layouts)[0]];\r\n    } else {\r\n      layout = profile.layouts[xrInputSource.handedness];\r\n    }\r\n    if (!layout) {\r\n      throw new Error(\r\n        `No matching handedness, ${xrInputSource.handedness}, in profile ${match.profileId}`\r\n      );\r\n    }\r\n\r\n    if (layout.assetPath) {\r\n      assetPath = match.profilePath.replace('profile.json', layout.assetPath);\r\n    }\r\n  }\r\n\r\n  return { profile, assetPath };\r\n}\r\n\r\n/** @constant {Object} */\r\nconst defaultComponentValues = {\r\n  xAxis: 0,\r\n  yAxis: 0,\r\n  button: 0,\r\n  state: Constants.ComponentState.DEFAULT\r\n};\r\n\r\n/**\r\n * @description Converts an X, Y coordinate from the range -1 to 1 (as reported by the Gamepad\r\n * API) to the range 0 to 1 (for interpolation). Also caps the X, Y values to be bounded within\r\n * a circle. This ensures that thumbsticks are not animated outside the bounds of their physical\r\n * range of motion and touchpads do not report touch locations off their physical bounds.\r\n * @param {number} x The original x coordinate in the range -1 to 1\r\n * @param {number} y The original y coordinate in the range -1 to 1\r\n */\r\nfunction normalizeAxes(x = 0, y = 0) {\r\n  let xAxis = x;\r\n  let yAxis = y;\r\n\r\n  // Determine if the point is outside the bounds of the circle\r\n  // and, if so, place it on the edge of the circle\r\n  const hypotenuse = Math.sqrt((x * x) + (y * y));\r\n  if (hypotenuse > 1) {\r\n    const theta = Math.atan2(y, x);\r\n    xAxis = Math.cos(theta);\r\n    yAxis = Math.sin(theta);\r\n  }\r\n\r\n  // Scale and move the circle so values are in the interpolation range.  The circle's origin moves\r\n  // from (0, 0) to (0.5, 0.5). The circle's radius scales from 1 to be 0.5.\r\n  const result = {\r\n    normalizedXAxis: (xAxis * 0.5) + 0.5,\r\n    normalizedYAxis: (yAxis * 0.5) + 0.5\r\n  };\r\n  return result;\r\n}\r\n\r\n/**\r\n * Contains the description of how the 3D model should visually respond to a specific user input.\r\n * This is accomplished by initializing the object with the name of a node in the 3D model and\r\n * property that need to be modified in response to user input, the name of the nodes representing\r\n * the allowable range of motion, and the name of the input which triggers the change. In response\r\n * to the named input changing, this object computes the appropriate weighting to use for\r\n * interpolating between the range of motion nodes.\r\n */\r\nclass VisualResponse {\r\n  constructor(visualResponseDescription) {\r\n    this.componentProperty = visualResponseDescription.componentProperty;\r\n    this.states = visualResponseDescription.states;\r\n    this.valueNodeName = visualResponseDescription.valueNodeName;\r\n    this.valueNodeProperty = visualResponseDescription.valueNodeProperty;\r\n\r\n    if (this.valueNodeProperty === Constants.VisualResponseProperty.TRANSFORM) {\r\n      this.minNodeName = visualResponseDescription.minNodeName;\r\n      this.maxNodeName = visualResponseDescription.maxNodeName;\r\n    }\r\n\r\n    // Initializes the response's current value based on default data\r\n    this.value = 0;\r\n    this.updateFromComponent(defaultComponentValues);\r\n  }\r\n\r\n  /**\r\n   * Computes the visual response's interpolation weight based on component state\r\n   * @param {Object} componentValues - The component from which to update\r\n   * @param {number} xAxis - The reported X axis value of the component\r\n   * @param {number} yAxis - The reported Y axis value of the component\r\n   * @param {number} button - The reported value of the component's button\r\n   * @param {string} state - The component's active state\r\n   */\r\n  updateFromComponent({\r\n    xAxis, yAxis, button, state\r\n  }) {\r\n    const { normalizedXAxis, normalizedYAxis } = normalizeAxes(xAxis, yAxis);\r\n    switch (this.componentProperty) {\r\n      case Constants.ComponentProperty.X_AXIS:\r\n        this.value = (this.states.includes(state)) ? normalizedXAxis : 0.5;\r\n        break;\r\n      case Constants.ComponentProperty.Y_AXIS:\r\n        this.value = (this.states.includes(state)) ? normalizedYAxis : 0.5;\r\n        break;\r\n      case Constants.ComponentProperty.BUTTON:\r\n        this.value = (this.states.includes(state)) ? button : 0;\r\n        break;\r\n      case Constants.ComponentProperty.STATE:\r\n        if (this.valueNodeProperty === Constants.VisualResponseProperty.VISIBILITY) {\r\n          this.value = (this.states.includes(state));\r\n        } else {\r\n          this.value = this.states.includes(state) ? 1.0 : 0.0;\r\n        }\r\n        break;\r\n      default:\r\n        throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`);\r\n    }\r\n  }\r\n}\r\n\r\nclass Component {\r\n  /**\r\n   * @param {Object} componentId - Id of the component\r\n   * @param {Object} componentDescription - Description of the component to be created\r\n   */\r\n  constructor(componentId, componentDescription) {\r\n    if (!componentId\r\n     || !componentDescription\r\n     || !componentDescription.visualResponses\r\n     || !componentDescription.gamepadIndices\r\n     || Object.keys(componentDescription.gamepadIndices).length === 0) {\r\n      throw new Error('Invalid arguments supplied');\r\n    }\r\n\r\n    this.id = componentId;\r\n    this.type = componentDescription.type;\r\n    this.rootNodeName = componentDescription.rootNodeName;\r\n    this.touchPointNodeName = componentDescription.touchPointNodeName;\r\n\r\n    // Build all the visual responses for this component\r\n    this.visualResponses = {};\r\n    Object.keys(componentDescription.visualResponses).forEach((responseName) => {\r\n      const visualResponse = new VisualResponse(componentDescription.visualResponses[responseName]);\r\n      this.visualResponses[responseName] = visualResponse;\r\n    });\r\n\r\n    // Set default values\r\n    this.gamepadIndices = Object.assign({}, componentDescription.gamepadIndices);\r\n\r\n    this.values = {\r\n      state: Constants.ComponentState.DEFAULT,\r\n      button: (this.gamepadIndices.button !== undefined) ? 0 : undefined,\r\n      xAxis: (this.gamepadIndices.xAxis !== undefined) ? 0 : undefined,\r\n      yAxis: (this.gamepadIndices.yAxis !== undefined) ? 0 : undefined\r\n    };\r\n  }\r\n\r\n  get data() {\r\n    const data = { id: this.id, ...this.values };\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @description Poll for updated data based on current gamepad state\r\n   * @param {Object} gamepad - The gamepad object from which the component data should be polled\r\n   */\r\n  updateFromGamepad(gamepad) {\r\n    // Set the state to default before processing other data sources\r\n    this.values.state = Constants.ComponentState.DEFAULT;\r\n\r\n    // Get and normalize button\r\n    if (this.gamepadIndices.button !== undefined\r\n        && gamepad.buttons.length > this.gamepadIndices.button) {\r\n      const gamepadButton = gamepad.buttons[this.gamepadIndices.button];\r\n      this.values.button = gamepadButton.value;\r\n      this.values.button = (this.values.button < 0) ? 0 : this.values.button;\r\n      this.values.button = (this.values.button > 1) ? 1 : this.values.button;\r\n\r\n      // Set the state based on the button\r\n      if (gamepadButton.pressed || this.values.button === 1) {\r\n        this.values.state = Constants.ComponentState.PRESSED;\r\n      } else if (gamepadButton.touched || this.values.button > Constants.ButtonTouchThreshold) {\r\n        this.values.state = Constants.ComponentState.TOUCHED;\r\n      }\r\n    }\r\n\r\n    // Get and normalize x axis value\r\n    if (this.gamepadIndices.xAxis !== undefined\r\n        && gamepad.axes.length > this.gamepadIndices.xAxis) {\r\n      this.values.xAxis = gamepad.axes[this.gamepadIndices.xAxis];\r\n      this.values.xAxis = (this.values.xAxis < -1) ? -1 : this.values.xAxis;\r\n      this.values.xAxis = (this.values.xAxis > 1) ? 1 : this.values.xAxis;\r\n\r\n      // If the state is still default, check if the xAxis makes it touched\r\n      if (this.values.state === Constants.ComponentState.DEFAULT\r\n        && Math.abs(this.values.xAxis) > Constants.AxisTouchThreshold) {\r\n        this.values.state = Constants.ComponentState.TOUCHED;\r\n      }\r\n    }\r\n\r\n    // Get and normalize Y axis value\r\n    if (this.gamepadIndices.yAxis !== undefined\r\n        && gamepad.axes.length > this.gamepadIndices.yAxis) {\r\n      this.values.yAxis = gamepad.axes[this.gamepadIndices.yAxis];\r\n      this.values.yAxis = (this.values.yAxis < -1) ? -1 : this.values.yAxis;\r\n      this.values.yAxis = (this.values.yAxis > 1) ? 1 : this.values.yAxis;\r\n\r\n      // If the state is still default, check if the yAxis makes it touched\r\n      if (this.values.state === Constants.ComponentState.DEFAULT\r\n        && Math.abs(this.values.yAxis) > Constants.AxisTouchThreshold) {\r\n        this.values.state = Constants.ComponentState.TOUCHED;\r\n      }\r\n    }\r\n\r\n    // Update the visual response weights based on the current component data\r\n    Object.values(this.visualResponses).forEach((visualResponse) => {\r\n      visualResponse.updateFromComponent(this.values);\r\n    });\r\n  }\r\n}\r\n\r\n/**\r\n  * @description Builds a motion controller with components and visual responses based on the\r\n  * supplied profile description. Data is polled from the xrInputSource's gamepad.\r\n  * @author Nell Waliczek / https://github.com/NellWaliczek\r\n*/\r\nclass MotionController {\r\n  /**\r\n   * @param {Object} xrInputSource - The XRInputSource to build the MotionController around\r\n   * @param {Object} profile - The best matched profile description for the supplied xrInputSource\r\n   * @param {Object} assetUrl\r\n   */\r\n  constructor(xrInputSource, profile, assetUrl) {\r\n    if (!xrInputSource) {\r\n      throw new Error('No xrInputSource supplied');\r\n    }\r\n\r\n    if (!profile) {\r\n      throw new Error('No profile supplied');\r\n    }\r\n\r\n    this.xrInputSource = xrInputSource;\r\n    this.assetUrl = assetUrl;\r\n    this.id = profile.profileId;\r\n\r\n    // Build child components as described in the profile description\r\n    this.layoutDescription = profile.layouts[xrInputSource.handedness];\r\n    this.components = {};\r\n    Object.keys(this.layoutDescription.components).forEach((componentId) => {\r\n      const componentDescription = this.layoutDescription.components[componentId];\r\n      this.components[componentId] = new Component(componentId, componentDescription);\r\n    });\r\n\r\n    // Initialize components based on current gamepad state\r\n    this.updateFromGamepad();\r\n  }\r\n\r\n  get gripSpace() {\r\n    return this.xrInputSource.gripSpace;\r\n  }\r\n\r\n  get targetRaySpace() {\r\n    return this.xrInputSource.targetRaySpace;\r\n  }\r\n\r\n  /**\r\n   * @description Returns a subset of component data for simplified debugging\r\n   */\r\n  get data() {\r\n    const data = [];\r\n    Object.values(this.components).forEach((component) => {\r\n      data.push(component.data);\r\n    });\r\n    return data;\r\n  }\r\n\r\n  /**\r\n   * @description Poll for updated data based on current gamepad state\r\n   */\r\n  updateFromGamepad() {\r\n    Object.values(this.components).forEach((component) => {\r\n      component.updateFromGamepad(this.xrInputSource.gamepad);\r\n    });\r\n  }\r\n}\r\n\r\nexport { Constants, MotionController, fetchProfile, fetchProfilesList };\r\n","\r\n// import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\n\r\nimport { Constants as MotionControllerConstants, fetchProfile, MotionController } from './motion-controllers.module.js';\r\n\r\nconst DEFAULT_PROFILES_PATH = 'https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles';\r\nconst DEFAULT_PROFILE = 'generic-trigger';\r\n\r\nfunction XRControllerModel() {\r\n\tTHREE.Object3D.call(this);\r\n\tthis.motionController = null;\r\n\tthis.envMap = null;\r\n}\r\n\r\nXRControllerModel.prototype = Object.assign(Object.create(THREE.Object3D.prototype), {\r\n\r\n\tconstructor: XRControllerModel,\r\n\r\n\tsetEnvironmentMap: function(envMap) {\r\n\r\n\t\tif (this.envMap == envMap) {\r\n\r\n\t\t\treturn this;\r\n\r\n\t\t}\r\n\r\n\t\tthis.envMap = envMap;\r\n\t\tthis.traverse((child) => {\r\n\r\n\t\t\tif (child.isMesh) {\r\n\r\n\t\t\t\tchild.material.envMap = this.envMap;\r\n\t\t\t\tchild.material.needsUpdate = true;\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t\treturn this;\r\n\r\n\t},\r\n\r\n\t/**\r\n\t * Polls data from the XRInputSource and updates the model's components to match\r\n\t * the real world data\r\n\t */\r\n\tupdateMatrixWorld: function(force) {\r\n\r\n\t\tTHREE.Object3D.prototype.updateMatrixWorld.call(this, force);\r\n\r\n\t\tif (!this.motionController) return;\r\n\r\n\t\t// Cause the MotionController to poll the Gamepad for data\r\n\t\tthis.motionController.updateFromGamepad();\r\n\r\n\t\t// Update the 3D model to reflect the button, thumbstick, and touchpad state\r\n\t\tObject.values(this.motionController.components).forEach((component) => {\r\n\r\n\t\t\t// Update node data based on the visual responses' current states\r\n\t\t\tObject.values(component.visualResponses).forEach((visualResponse) => {\r\n\r\n\t\t\t\tconst { valueNode, minNode, maxNode, value, valueNodeProperty } = visualResponse;\r\n\r\n\t\t\t\t// Skip if the visual response node is not found. No error is needed,\r\n\t\t\t\t// because it will have been reported at load time.\r\n\t\t\t\tif (!valueNode) return;\r\n\r\n\t\t\t\t// Calculate the new properties based on the weight supplied\r\n\t\t\t\tif (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.VISIBILITY) {\r\n\r\n\t\t\t\t\tvalueNode.visible = value;\r\n\r\n\t\t\t\t} else if (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.TRANSFORM) {\r\n\r\n\t\t\t\t\tTHREE.Quaternion.slerp(\r\n\t\t\t\t\t\tminNode.quaternion,\r\n\t\t\t\t\t\tmaxNode.quaternion,\r\n\t\t\t\t\t\tvalueNode.quaternion,\r\n\t\t\t\t\t\tvalue\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tvalueNode.position.lerpVectors(\r\n\t\t\t\t\t\tminNode.position,\r\n\t\t\t\t\t\tmaxNode.position,\r\n\t\t\t\t\t\tvalue\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t});\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n});\r\n\r\n/**\r\n * Walks the model's tree to find the nodes needed to animate the components and\r\n * saves them to the motionContoller components for use in the frame loop. When\r\n * touchpads are found, attaches a touch dot to them.\r\n */\r\nfunction findNodes(motionController, scene) {\r\n\r\n\t// Loop through the components and find the nodes needed for each components' visual responses\r\n\tObject.values(motionController.components).forEach((component) => {\r\n\r\n\t\tconst { type, touchPointNodeName, visualResponses } = component;\r\n\r\n\t\tif (type === MotionControllerConstants.ComponentType.TOUCHPAD) {\r\n\r\n\t\t\tcomponent.touchPointNode = scene.getObjectByName(touchPointNodeName);\r\n\t\t\tif (component.touchPointNode) {\r\n\r\n\t\t\t\t// Attach a touch dot to the touchpad.\r\n\t\t\t\tconst sphereGeometry = new THREE.SphereBufferGeometry(0.001);\r\n\t\t\t\tconst material = new THREE.MeshBasicMaterial({ color: 0x0000FF });\r\n\t\t\t\tconst sphere = new THREE.Mesh(sphereGeometry, material);\r\n\t\t\t\tcomponent.touchPointNode.add(sphere);\r\n\r\n\t\t\t} else {\r\n\r\n\t\t\t\tconsole.warn(`Could not find touch dot, ${component.touchPointNodeName}, in touchpad component ${component.id}`);\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t// Loop through all the visual responses to be applied to this component\r\n\t\tObject.values(visualResponses).forEach((visualResponse) => {\r\n\r\n\t\t\tconst { valueNodeName, minNodeName, maxNodeName, valueNodeProperty } = visualResponse;\r\n\r\n\t\t\t// If animating a transform, find the two nodes to be interpolated between.\r\n\t\t\tif (valueNodeProperty === MotionControllerConstants.VisualResponseProperty.TRANSFORM) {\r\n\r\n\t\t\t\tvisualResponse.minNode = scene.getObjectByName(minNodeName);\r\n\t\t\t\tvisualResponse.maxNode = scene.getObjectByName(maxNodeName);\r\n\r\n\t\t\t\t// If the extents cannot be found, skip this animation\r\n\t\t\t\tif (!visualResponse.minNode) {\r\n\r\n\t\t\t\t\tconsole.warn(`Could not find ${minNodeName} in the model`);\r\n\t\t\t\t\treturn;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (!visualResponse.maxNode) {\r\n\r\n\t\t\t\t\tconsole.warn(`Could not find ${maxNodeName} in the model`);\r\n\t\t\t\t\treturn;\r\n\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t// If the target node cannot be found, skip this animation\r\n\t\t\tvisualResponse.valueNode = scene.getObjectByName(valueNodeName);\r\n\t\t\tif (!visualResponse.valueNode) {\r\n\r\n\t\t\t\tconsole.warn(`Could not find ${valueNodeName} in the model`);\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t});\r\n\r\n}\r\n\r\nfunction addAssetSceneToControllerModel(controllerModel, scene) {\r\n\r\n\t// Find the nodes needed for animation and cache them on the motionController.\r\n\tfindNodes(controllerModel.motionController, scene);\r\n\r\n\t// Apply any environment map that the mesh already has set.\r\n\tif (controllerModel.envMap) {\r\n\r\n\t\tscene.traverse((child) => {\r\n\r\n\t\t\tif (child.isMesh) {\r\n\r\n\t\t\t\tchild.material.envMap = controllerModel.envMap;\r\n\t\t\t\tchild.material.needsUpdate = true;\r\n\r\n\t\t\t}\r\n\r\n\t\t});\r\n\r\n\t}\r\n\r\n\t// Add the glTF scene to the controllerModel.\r\n\tcontrollerModel.add(scene);\r\n\r\n}\r\n\r\nvar XRControllerModelFactory = (function() {\r\n\r\n\tfunction XRControllerModelFactory(gltfLoader = null) {\r\n\r\n\t\tthis.gltfLoader = gltfLoader;\r\n\t\tthis.path = DEFAULT_PROFILES_PATH;\r\n\t\tthis._assetCache = {};\r\n\r\n\t\t// If a GLTFLoader wasn't supplied to the constructor create a new one.\r\n\t\tif (!this.gltfLoader) {\r\n\t\t\tthis.gltfLoader = new THREE.GLTFLoader();\r\n\t\t}\r\n\r\n\t}\r\n\r\n\tXRControllerModelFactory.prototype = {\r\n\r\n\t\tconstructor: XRControllerModelFactory,\r\n\r\n\t\tcreateControllerModel: function(controller) {\r\n\r\n\t\t\tconst controllerModel = new XRControllerModel();\r\n\t\t\tlet scene = null;\r\n\r\n\t\t\tcontroller.addEventListener('connected', (event) => {\r\n\r\n\t\t\t\tconst xrInputSource = event.data;\r\n\r\n\t\t\t\tif (xrInputSource.targetRayMode !== 'tracked-pointer' || !xrInputSource.gamepad) return;\r\n\r\n\t\t\t\tfetchProfile(xrInputSource, this.path, DEFAULT_PROFILE).then(({ profile, assetPath }) => {\r\n\r\n\t\t\t\t\tcontrollerModel.motionController = new MotionController(\r\n\t\t\t\t\t\txrInputSource,\r\n\t\t\t\t\t\tprofile,\r\n\t\t\t\t\t\tassetPath\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\tlet cachedAsset = this._assetCache[controllerModel.motionController.assetUrl];\r\n\t\t\t\t\tif (cachedAsset) {\r\n\r\n\t\t\t\t\t\tscene = cachedAsset.scene.clone();\r\n\r\n\t\t\t\t\t\taddAssetSceneToControllerModel(controllerModel, scene);\r\n\r\n\t\t\t\t\t} else {\r\n\r\n\t\t\t\t\t\tif (!this.gltfLoader) {\r\n\r\n\t\t\t\t\t\t\tthrow new Error(`GLTFLoader not set.`);\r\n\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tthis.gltfLoader.setPath('');\r\n\t\t\t\t\t\tthis.gltfLoader.load(controllerModel.motionController.assetUrl, (asset) => {\r\n\r\n\t\t\t\t\t\t\tthis._assetCache[controllerModel.motionController.assetUrl] = asset;\r\n\r\n\t\t\t\t\t\t\tscene = asset.scene.clone();\r\n\r\n\t\t\t\t\t\t\taddAssetSceneToControllerModel(controllerModel, scene);\r\n\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tnull,\r\n\t\t\t\t\t\t\t() => {\r\n\r\n\t\t\t\t\t\t\t\tthrow new Error(`Asset ${controllerModel.motionController.assetUrl} missing or malformed.`);\r\n\r\n\t\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t}).catch((err) => {\r\n\r\n\t\t\t\t\tconsole.warn(err);\r\n\r\n\t\t\t\t});\r\n\r\n\t\t\t});\r\n\r\n\t\t\tcontroller.addEventListener('disconnected', () => {\r\n\r\n\t\t\t\tcontrollerModel.motionController = null;\r\n\t\t\t\tcontrollerModel.remove(scene);\r\n\t\t\t\tscene = null;\r\n\r\n\t\t\t});\r\n\r\n\t\t\treturn controllerModel;\r\n\r\n\t\t}\r\n\r\n\t};\r\n\r\n\treturn XRControllerModelFactory;\r\n\r\n})();\r\n\r\nexport { XRControllerModelFactory };\r\n\r\n","import { Component, getContext } from 'rxcomp';\r\nimport { ReplaySubject } from 'rxjs';\r\nimport { auditTime, filter, shareReplay, takeUntil, tap } from 'rxjs/operators';\r\nimport { MessageType } from '../agora/agora.types';\r\nimport { DEBUG } from '../environment';\r\nimport KeyboardService from '../keyboard/keyboard.service';\r\nimport MessageService from '../message/message.service';\r\nimport { Rect } from '../rect/rect';\r\nimport StateService from '../state/state.service';\r\nimport { RoleType } from '../user/user';\r\nimport { PanoramaGridView } from '../view/view';\r\nimport ViewService from '../view/view.service';\r\nimport AvatarElement from './avatar/avatar-element';\r\nimport Camera from './camera/camera';\r\n// import DebugService from './debug.service';\r\nimport Interactive from './interactive/interactive';\r\nimport MediaMesh from './media/media-mesh';\r\nimport OrbitService, { OrbitMoveEvent } from './orbit/orbit';\r\nimport Panorama from './panorama/panorama';\r\nimport PhoneElement from './phone/phone.element';\r\nimport PointerElement from './pointer/pointer.element';\r\nimport VRService from './vr.service';\r\nimport { Gamepad } from './webxr/gamepad';\r\nimport { XRControllerModelFactory } from './webxr/xr-controller-model-factory';\r\n\r\nconst ORIGIN = new THREE.Vector3();\r\nconst USE_SHADOW = false;\r\nconst USE_PHONE = true;\r\n\r\nexport default class WorldComponent extends Component {\r\n\r\n\tget error() {\r\n\t\treturn this.error_;\r\n\t}\r\n\tset error(error) {\r\n\t\tif (this.error_ !== error) {\r\n\t\t\tthis.error_ = error;\r\n\t\t\tthis.pushChanges();\r\n\t\t}\r\n\t}\r\n\tget view() {\r\n\t\treturn this.view_;\r\n\t}\r\n\tset view(view) {\r\n\t\tif (this.view_ !== view) {\r\n\t\t\tthis.view_ = view;\r\n\t\t\tthis.setView();\r\n\t\t}\r\n\t}\r\n\tget debugging() {\r\n\t\t// return STATIC || DEBUG;\r\n\t\treturn DEBUG;\r\n\t}\r\n\tget locked() {\r\n\t\treturn this.state.locked || this.state.spying;\r\n\t}\r\n\tget lockedOrXR() {\r\n\t\treturn this.locked || this.renderer.xr.isPresenting;\r\n\t}\r\n\r\n\tget showPointer() {\r\n\t\treturn this.pointer.mesh.parent != null;\r\n\t}\r\n\tset showPointer(showPointer) {\r\n\t\tif (this.showPointer !== showPointer) {\r\n\t\t\tshowPointer ? this.scene.add(this.pointer.mesh) : this.scene.remove(this.pointer.mesh);\r\n\t\t\t// console.log('showPointer', showPointer);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t// console.log('WorldComponent.onInit');\r\n\t\tthis.index = 0;\r\n\t\tthis.error_ = null;\r\n\t\tthis.loading = null;\r\n\t\tthis.waiting = null;\r\n\t\tthis.avatars = {};\r\n\t\tthis.createScene();\r\n\t\tthis.setView();\r\n\t\tthis.addListeners();\r\n\t\tthis.animate(); // !!!\r\n\t\tKeyboardService.keys$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(keys => {\r\n\t\t\tthis.keys = keys;\r\n\t\t\t// console.log(keys);\r\n\t\t});\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tif (this.view) {\r\n\t\t\tconst selected = this.view.items.find(item => item.selected);\r\n\t\t\tif (selected && selected.mesh) {\r\n\t\t\t\tif (this.view.type.name !== 'model') {\r\n\t\t\t\t\tthis.orbit.lookAt(selected.mesh);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.removeListeners();\r\n\t\tconst renderer = this.renderer;\r\n\t\trenderer.setAnimationLoop(() => { });\r\n\t}\r\n\r\n\tcreateScene() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.size = { left: 0, top: 0, width: 0, height: 0, aspect: 0 };\r\n\t\tthis.mouse = new THREE.Vector2();\r\n\t\tthis.controllerMatrix_ = new THREE.Matrix4();\r\n\t\tthis.controllerWorldPosition_ = new THREE.Vector3();\r\n\t\tthis.controllerWorldDirection_ = new THREE.Vector3();\r\n\r\n\t\tconst container = this.container = node;\r\n\t\tconst info = this.info = node.querySelector('.world__info');\r\n\r\n\t\tconst worldRect = this.worldRect = Rect.fromNode(container);\r\n\t\tconst cameraRect = this.cameraRect = new Rect();\r\n\r\n\t\t// !!! eliminabile?\r\n\t\tconst cameraGroup = this.cameraGroup = new THREE.Group();\r\n\t\t// new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, ROOM_RADIUS * 2);\r\n\t\t// const camera = this.camera = new THREE.PerspectiveCamera(70, container.offsetWidth / container.offsetHeight, 0.01, 1000);\r\n\t\tconst camera = this.camera = new Camera(70, container.offsetWidth / container.offsetHeight, 0.01, 1000);\r\n\t\t/*\r\n\t\tcamera.position.set(0, 20, 20);\r\n\t\tcamera.lookAt(camera.target);\r\n\t\t*/\r\n\t\tcameraGroup.add(camera);\r\n\t\tcameraGroup.target = new THREE.Vector3();\r\n\r\n\t\tconst orbit = this.orbit = new OrbitService(camera);\r\n\r\n\t\tconst renderer = this.renderer = new THREE.WebGLRenderer({\r\n\t\t\tantialias: true,\r\n\t\t\talpha: false,\r\n\t\t\tpremultipliedAlpha: true,\r\n\t\t\tlogarithmicDepthBuffer: true,\r\n\t\t\t// physicallyCorrectLights: true,\r\n\t\t});\r\n\t\trenderer.setClearColor(0x000000, 1);\r\n\t\trenderer.setPixelRatio(window.devicePixelRatio);\r\n\t\trenderer.setSize(container.offsetWidth, container.offsetHeight);\r\n\t\trenderer.xr.enabled = true;\r\n\t\trenderer.toneMapping = THREE.ACESFilmicToneMapping;\r\n\t\trenderer.toneMappingExposure = 0.8;\r\n\t\trenderer.outputEncoding = THREE.sRGBEncoding;\r\n\t\tif (USE_SHADOW) {\r\n\t\t\trenderer.shadowMap.enabled = true;\r\n\t\t\trenderer.shadowMap.type = THREE.PCFShadowMap; // THREE.PCFSoftShadowMap; // default THREE.PCFShadowMap\r\n\t\t}\r\n\t\tif (container.childElementCount > 0) {\r\n\t\t\tcontainer.insertBefore(renderer.domElement, container.children[0]);\r\n\t\t} else {\r\n\t\t\tcontainer.appendChild(renderer.domElement);\r\n\t\t}\r\n\r\n\t\tconst raycaster = this.raycaster = new THREE.Raycaster();\r\n\t\traycaster.setFromCamera(this.mouse, camera);\r\n\r\n\t\tconst scene = this.scene = new THREE.Scene();\r\n\t\tscene.add(cameraGroup);\r\n\r\n\t\tconst objects = this.objects = new THREE.Group();\r\n\t\tobjects.name = '[objects]';\r\n\t\tscene.add(objects);\r\n\r\n\t\tconst panorama = this.panorama = new Panorama();\r\n\t\tobjects.add(panorama.mesh);\r\n\r\n\t\tconst indicator = this.indicator = new PointerElement();\r\n\r\n\t\tconst pointer = this.pointer = new PointerElement('#ff4332');\r\n\r\n\t\tconst mainLight = new THREE.PointLight(0xffffff);\r\n\t\tmainLight.position.set(-50, 0, -50);\r\n\t\tobjects.add(mainLight);\r\n\r\n\t\tconst light2 = new THREE.DirectionalLight(0xffe699, 1.5);\r\n\t\tlight2.position.set(40, -40, 40);\r\n\t\tlight2.target.position.set(0, 0, 0);\r\n\t\tobjects.add(light2);\r\n\r\n\t\tconst light3 = new THREE.DirectionalLight(0xffe699, 1);\r\n\t\tlight3.position.set(0, 50, 0);\r\n\t\tlight3.target.position.set(0, 0, 0);\r\n\t\tobjects.add(light3);\r\n\r\n\t\tconst light = new THREE.AmbientLight(0x101010);\r\n\t\tobjects.add(light);\r\n\r\n\t\tthis.addControllers();\r\n\t\t//\r\n\t\tthis.resize();\r\n\t\t//\r\n\t\t// console.log('WorldComponent.createScene');\r\n\t}\r\n\r\n\taddOffCanvasScene(message) {\r\n\t\tconst avatar = new AvatarElement(message);\r\n\t\tthis.avatars[message.clientId] = avatar;\r\n\t\t// avatar.container.appendChild(avatar.element);\r\n\t}\r\n\r\n\tremoveOffCanvasScene(message) {\r\n\t\tconst avatar = this.avatars[message.clientId];\r\n\t\t/*\r\n\t\tif (avatar && avatar.element.parentNode) {\r\n\t\t\tavatar.element.parentNode.removeChild(avatar.element);\r\n\t\t}\r\n\t\t*/\r\n\t\tdelete this.avatars[message.clientId];\r\n\t}\r\n\r\n\tupdateOffCanvasScene(message) {\r\n\t\tconst avatar = this.avatars[message.clientId];\r\n\t\tif (avatar) {\r\n\t\t\tavatar.update(message);\r\n\t\t}\r\n\t}\r\n\r\n\tsetView() {\r\n\t\tif (!this.panorama) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst view = this.view_;\r\n\t\tif (view) {\r\n\t\t\tif (this.views) {\r\n\t\t\t\tthis.views.forEach(view => delete view.onUpdateAsset);\r\n\t\t\t}\r\n\t\t\tconst message = this.requestInfoResult;\r\n\t\t\tif (message) {\r\n\t\t\t\tif (view instanceof PanoramaGridView && message.gridIndex !== undefined) {\r\n\t\t\t\t\tview.index_ = message.gridIndex;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tview.ready = false;\r\n\t\t\t// this.loading = LOADING_BANNER;\r\n\t\t\t// this.waiting = null;\r\n\t\t\tthis.pushChanges();\r\n\t\t\tthis.panorama.change(view, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t// this.scene.background = envMap;\r\n\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t\tview.ready = true;\r\n\t\t\t\tview.onUpdateAsset = () => {\r\n\t\t\t\t\tthis.onViewAssetDidChange();\r\n\t\t\t\t};\r\n\t\t\t\t// this.waiting = (view && view.type.name === 'waiting-room') ? WAITING_BANNER : null;\r\n\t\t\t\tthis.pushChanges();\r\n\t\t\t\t// this.render();\r\n\t\t\t}, (view) => {\r\n\t\t\t\tthis.setViewOrientation(view);\r\n\t\t\t\t// this.loading = null;\r\n\t\t\t\t// this.pushChanges();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonViewAssetDidChange() {\r\n\t\tif (this.panorama) {\r\n\t\t\tthis.panorama.crossfade(this.view, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tsetViewOrientation(view) {\r\n\t\tconst message = this.requestInfoResult;\r\n\t\tthis.requestInfoResult = null;\r\n\t\tif (this.orbit) {\r\n\t\t\tthis.orbit.mode = view.type.name;\r\n\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\tif (message) {\r\n\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t} else if (!view.keepOrientation) {\r\n\t\t\t\t\tthis.orbit.setOrientation(view.orientation);\r\n\t\t\t\t\tthis.orbit.zoom = view.zoom;\r\n\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\taddControllers() {\r\n\t\tconst controllerGroup = this.controllerGroup = new THREE.Group();\r\n\t\tthis.controllers = [];\r\n\t\tthis.controllerModelFactory = new XRControllerModelFactory();\r\n\t\tthis.addController(0);\r\n\t\tthis.addController(1);\r\n\t\tthis.cameraGroup.add(controllerGroup);\r\n\t}\r\n\r\n\taddController(index) {\r\n\t\tconst showPhone = USE_PHONE && StateService.state.live;\r\n\t\tconst renderer = this.renderer;\r\n\t\tconst controllerGroup = this.controllerGroup;\r\n\t\tconst controller = renderer.xr.getController(index);\r\n\t\tconst controllerModelFactory = this.controllerModelFactory;\r\n\t\tcontroller.name = `[controller${index + 1}]`;\r\n\t\tcontrollerGroup.add(controller);\r\n\t\tconst setController = (controller) => {\r\n\t\t\t// console.log('setController', this);\r\n\t\t\tthis.controller = controller;\r\n\t\t}\r\n\t\tconst onSelectStart = (event) => {\r\n\t\t\tcontroller.userData.isSelecting = true;\r\n\t\t\tsetController(controller);\r\n\t\t};\r\n\t\tconst onSelectEnd = (event) => {\r\n\t\t\tcontroller.userData.isSelecting = false;\r\n\t\t};\r\n\t\t// const debugService = DebugService.getService();\r\n\t\t// debugService.setMessage('DebugService 1001');\r\n\t\tconst onPress = (event) => {\r\n\t\t\t// console.log('Gamepad.onPress', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onPress ' + event.index);\r\n\t\t\t// 0: select\r\n\t\t\t// 1: squeeze\r\n\t\t\t// 4: x / a\r\n\t\t\t// 5: y / b\r\n\t\t\tswitch(event.index) {\r\n\t\t\t\tcase 0:\r\n\t\t\t\t\t// select\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 1:\r\n\t\t\t\t\t// squeeze\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 4:\r\n\t\t\t\t\t// x / a\r\n\t\t\t\t\tMessageService.send({\r\n\t\t\t\t\t\ttype: MessageType.MenuToggle,\r\n\t\t\t\t\t});\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t};\r\n\t\tconst onRelease = (event) => {\r\n\t\t\tthis.onModelUp();\r\n\t\t};\r\n\t\tconst onLeft = (event) => {\r\n\t\t\t// console.log('Gamepad.onLeft', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onLeft');\r\n\t\t\tthis.cameraGroup.rotation.y += Math.PI / 180 * 45;\r\n\t\t};\r\n\t\tconst onRight = (event) => {\r\n\t\t\t// console.log('Gamepad.onRight', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onRight');\r\n\t\t\tthis.cameraGroup.rotation.y -= Math.PI / 180 * 45;\r\n\t\t};\r\n\t\t/*\r\n\t\tconst onAxis = (event) => {\r\n\t\t\t// console.log('Gamepad.onAxis', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onAxis');\r\n\t\t\tthis.cameraGroup.rotation.y += (Math.PI / 180 * event.x);\r\n\t\t};\r\n\t\t*/\r\n\t\tconst onAxis = (event) => {\r\n\t\t\t// console.log('Gamepad.onAxis', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onAxis');\r\n\t\t\tthis.onModelDistance(event.y);\r\n\t\t};\r\n\t\t/*\r\n\t\tconst onUp = (event) => {\r\n\t\t\t// console.log('Gamepad.onUp', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onUp');\r\n\t\t\tthis.cameraGroup.position.y += 1;\r\n\t\t};\r\n\t\tconst onDown = (event) => {\r\n\t\t\t// console.log('Gamepad.onDown', event, controller);\r\n\t\t\t// debugService.setMessage('Gamepad.onDown');\r\n\t\t\tthis.cameraGroup.position.y -= 1;\r\n\t\t};\r\n\t\t*/\r\n\t\t/*\r\n\t\tconst onUp = (event) => {\r\n\t\t\tthis.onModelDistance(1);\r\n\t\t};\r\n\t\tconst onDown = (event) => {\r\n\t\t\tthis.onModelDistance(-1);\r\n\t\t};\r\n\t\t*/\r\n\t\tconst onConnected = (event) => {\r\n\t\t\tcontroller.add(this.buildController(event.data));\r\n\t\t\tif (showPhone && event.data.handedness === 'left') {\r\n\t\t\t\tconst phone = this.phone = new PhoneElement();\r\n\t\t\t\tcontroller.add(phone.mesh);\r\n\t\t\t}\r\n\t\t\tif (!showPhone || event.data.handedness === 'right') {\r\n\t\t\t\tconst controllerGrip = renderer.xr.getControllerGrip(index);\r\n\t\t\t\tcontrollerGrip.name = `[controller-grip${index + 1}]`;\r\n\t\t\t\tcontrollerGrip.add(controllerModelFactory.createControllerModel(controllerGrip));\r\n\t\t\t\tcontrollerGroup.add(controllerGrip);\r\n\t\t\t}\r\n\t\t\tconst gamepad = new Gamepad(event.data.gamepad);\r\n\t\t\tgamepad.on('press', onPress);\r\n\t\t\tgamepad.on('release', onRelease);\r\n\t\t\tgamepad.on('left', onLeft);\r\n\t\t\tgamepad.on('right', onRight);\r\n\t\t\tgamepad.on('axis', onAxis);\r\n\t\t\t// gamepad.on('up', onUp);\r\n\t\t\t// gamepad.on('down', onDown);\r\n\t\t\tcontroller.userData.gamepad = gamepad;\r\n\t\t}\r\n\t\tconst onDisconnected = (event) => {\r\n\t\t\twhile (controller.children.length) {\r\n\t\t\t\tcontroller.remove(controller.children[0]);\r\n\t\t\t}\r\n\t\t\tconst controllerGrip = renderer.xr.getControllerGrip(index);\r\n\t\t\twhile (controllerGrip.children.length) {\r\n\t\t\t\tcontrollerGrip.remove(controllerGrip.children[0]);\r\n\t\t\t}\r\n\t\t\tcontrollerGroup.remove(controllerGrip);\r\n\t\t\tconst gamepad = controller.userData.gamepad;\r\n\t\t\tgamepad.off('press', onPress);\r\n\t\t\tgamepad.off('release', onRelease);\r\n\t\t\tgamepad.off('left', onLeft);\r\n\t\t\tgamepad.off('right', onRight);\r\n\t\t\tgamepad.off('axis', onAxis);\r\n\t\t\t// gamepad.off('up', onUp);\r\n\t\t\t// gamepad.off('down', onDown);\r\n\t\t}\r\n\t\tcontroller.addEventListener('selectstart', onSelectStart);\r\n\t\tcontroller.addEventListener('selectend', onSelectEnd);\r\n\t\tcontroller.addEventListener('connected', onConnected);\r\n\t\tcontroller.addEventListener('disconnected', onDisconnected);\r\n\t\tconst controllers = this.controllers;\r\n\t\tcontrollers.push(controller);\r\n\t}\r\n\r\n\tbuildController(data) {\r\n\t\tconsole.log('buildController', data);\r\n\t\tlet geometry, material;\r\n\t\tswitch (data.targetRayMode) {\r\n\t\t\tcase 'tracked-pointer':\r\n\t\t\t\tgeometry = new THREE.BufferGeometry();\r\n\t\t\t\tgeometry.setAttribute('position', new THREE.Float32BufferAttribute([0, 0, 0, 0, 0, -1], 3));\r\n\t\t\t\tgeometry.setAttribute('color', new THREE.Float32BufferAttribute([0.5, 0.5, 0.5, 0, 0, 0], 3));\r\n\t\t\t\tmaterial = new THREE.LineBasicMaterial({\r\n\t\t\t\t\tvertexColors: true,\r\n\t\t\t\t\tblending: THREE.AdditiveBlending\r\n\t\t\t\t});\r\n\t\t\t\treturn new THREE.Line(geometry, material);\r\n\t\t\tcase 'gaze':\r\n\t\t\t\tgeometry = new THREE.RingBufferGeometry(0.02, 0.04, 32).translate(0, 0, -1);\r\n\t\t\t\tmaterial = new THREE.MeshBasicMaterial({\r\n\t\t\t\t\topacity: 0.5,\r\n\t\t\t\t\ttransparent: true\r\n\t\t\t\t});\r\n\t\t\t\treturn new THREE.Mesh(geometry, material);\r\n\t\t}\r\n\t}\r\n\r\n\tonModelDown(event) {\r\n\t\t// vr controller model grab\r\n\t\tconst controller = this.controller;\r\n\t\tif (controller && this.renderer.xr.isPresenting) {\r\n\t\t\tconst target = this.tempTarget = event.mesh;\r\n\t\t\t// console.log('WorldComponent.onModelDown', target);\r\n\t\t\t// DebugService.getService().setMessage('onModelDown ', target.name);\r\n\t\t\tconst parent = this.tempParent = target.parent;\r\n\t\t\tconst position = new THREE.Vector3();\r\n\t\t\ttarget.localToWorld(position);\r\n\t\t\tcontroller.worldToLocal(position);\r\n\t\t\tcontroller.add(target);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t}\r\n\t}\r\n\r\n\tonModelDistance(direction) {\r\n\t\t// vr controller model distance\r\n\t\tconst controller = this.controller;\r\n\t\tconst target = this.tempTarget;\r\n\t\tif (controller && target && this.renderer.xr.isPresenting) {\r\n\t\t\tlet position = new THREE.Vector3();\r\n\t\t\tposition = position.copy(target.position);\r\n\t\t\tconst distance = Math.max(1, Math.min(8, position.distanceTo(ORIGIN) + 0.02 * direction));\r\n\t\t\tposition.normalize();\r\n\t\t\tposition = position.multiplyScalar(distance);\r\n\t\t\t// DebugService.getService().setMessage('onModelDistance ' + distance);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t}\r\n\t}\r\n\r\n\tonModelUp() {\r\n\t\t// vr controller model release\r\n\t\tconst target = this.tempTarget;\r\n\t\tconst parent = this.tempParent;\r\n\t\tif (target && parent) {\r\n\t\t\t// console.log('WorldComponent.onModelUp', target, parent);\r\n\t\t\tconst position = new THREE.Vector3();\r\n\t\t\ttarget.localToWorld(position);\r\n\t\t\tparent.worldToLocal(position);\r\n\t\t\tparent.add(target);\r\n\t\t\ttarget.position.copy(position);\r\n\t\t\tthis.tempTarget = null;\r\n\t\t\tthis.tempParent = null;\r\n\t\t}\r\n\t}\r\n\r\n\tonTween() {\r\n\t\t// this.render();\r\n\t}\r\n\r\n\tupdateRaycasterXR(controller, raycaster) {\r\n\t\tif (controller) {\r\n\t\t\tthis.controllerMatrix_.identity().extractRotation(controller.matrixWorld);\r\n\t\t\traycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);\r\n\t\t\traycaster.ray.direction.set(0, 0, -1).applyMatrix4(this.controllerMatrix_);\r\n\t\t\t// raycaster.camera = this.host.renderer.xr.getCamera(this.camera);\r\n\t\t\treturn raycaster;\r\n\t\t}\r\n\t}\r\n\r\n\traycasterHitTest() {\r\n\t\ttry {\r\n\t\t\tif (this.renderer.xr.isPresenting) {\r\n\t\t\t\tconst raycaster = this.updateRaycasterXR(this.controller, this.raycaster);\r\n\t\t\t\tif (raycaster) {\r\n\t\t\t\t\tconst hit = Interactive.hittest(raycaster, this.controller.userData.isSelecting);\r\n\t\t\t\t\tthis.indicator.update();\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t\t\t// controllers.feedback();\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t} else if (!this.dragItem && !this.resizeItem) {\r\n\t\t\t\treturn; // !!!\r\n\t\t\t\tconst raycaster = this.raycaster;\r\n\t\t\t\tif (raycaster) {\r\n\t\t\t\t\tconst hit = Interactive.hittest(raycaster);\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t\t\t// console.log('hit', hit);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\trepos(object, rect) {\r\n\t\tconst worldRect = this.worldRect;\r\n\t\tconst sx = 0.8;\r\n\t\t// const sx = rect.width / worldRect.width;\r\n\t\t// const sy = rect.height / worldRect.height;\r\n\t\tobject.scale.set(sx, sx, sx);\r\n\t\t// const tx = ((rect.x + rect.width / 2) - worldRect.width / 2) / worldRect.width * 2.0 * this.camera.aspect; // * cameraRect.width / worldRect.width - cameraRect.width / 2;\r\n\t\t// const ty = ((rect.y + rect.height / 2) - worldRect.height / 2) / worldRect.height * 2.0 * this.camera.aspect; // * cameraRect.height / worldRect.height - cameraRect.height / 2;\r\n\t\tconst tx = ((rect.x + rect.width / 2) - worldRect.width / 2) / worldRect.width * 2.0 * this.camera.aspect;\r\n\t\tconst ty = ((rect.y + rect.height / 2) - worldRect.height / 2) / worldRect.height * 2.0 * this.camera.aspect;\r\n\t\t// console.log(tx);\r\n\t\t// const position = new THREE.Vector3(tx, ty, 0).unproject(this.camera);\r\n\t\tobject.position.set(tx, -ty, 0);\r\n\t\t// console.log(tx, -ty, 0);\r\n\t}\r\n\r\n\trender(delta) {\r\n\t\ttry {\r\n\t\t\tconst renderer = this.renderer,\r\n\t\t\t\tscene = this.scene,\r\n\t\t\t\tcamera = this.camera;\r\n\t\t\tconst time = performance.now();\r\n\t\t\tconst tick = this.tick_ ? ++this.tick_ : this.tick_ = 1;\r\n\t\t\tthis.raycasterXRHitTest();\r\n\t\t\tthis.scene.traverse((child) => {\r\n\t\t\t\tif (typeof child.userData.render === 'function') {\r\n\t\t\t\t\tchild.userData.render(time, tick);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tthis.vrService.updateState(this);\r\n\t\t\tObject.keys(this.avatars).forEach(key => {\r\n\t\t\t\tthis.avatars[key].render();\r\n\t\t\t});\r\n\t\t\tif (renderer.xr.isPresenting) {\r\n\t\t\t\tgsap.ticker.tick();\r\n\t\t\t\tthis.controllers.forEach(controller => {\r\n\t\t\t\t\tcontroller.userData.gamepad.update();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\t/*\r\n\t\t\tconst objects = this.objects;\r\n\t\t\tfor (let i = 0; i < objects.children.length; i++) {\r\n\t\t\t\tconst x = objects.children[i];\r\n\t\t\t\tif (typeof x.userData.render === 'function') {\r\n\t\t\t\t\tx.userData.render(time, tick);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\trenderer.render(this.scene, this.camera);\r\n\t\t\tif (this.state && !this.state.hosted) {\r\n\t\t\t\tthis.orbit.render();\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tanimate() {\r\n\t\tconst renderer = this.renderer;\r\n\t\trenderer.setAnimationLoop(this.render);\r\n\t}\r\n\r\n\tresize() {\r\n\t\ttry {\r\n\t\t\tconst container = this.container,\r\n\t\t\t\trenderer = this.renderer,\r\n\t\t\t\tcamera = this.camera;\r\n\t\t\tconst size = this.size;\r\n\t\t\tconst rect = container.getBoundingClientRect();\r\n\t\t\tsize.left = Math.floor(rect.left);\r\n\t\t\tsize.top = Math.floor(rect.top);\r\n\t\t\tsize.width = Math.ceil(rect.width);\r\n\t\t\tsize.height = Math.ceil(rect.height);\r\n\t\t\tsize.aspect = size.width / size.height;\r\n\t\t\tconst worldRect = this.worldRect;\r\n\t\t\tworldRect.setSize(size.width, size.height);\r\n\t\t\tif (!renderer.xr.isPresenting) {\r\n\t\t\t\trenderer.setSize(size.width, size.height);\r\n\t\t\t\tif (camera) {\r\n\t\t\t\t\tcamera.aspect = size.width / size.height;\r\n\t\t\t\t\tconst angle = camera.fov * Math.PI / 180;\r\n\t\t\t\t\tconst height = Math.abs(camera.position.z * Math.tan(angle / 2) * 2);\r\n\t\t\t\t\tconst cameraRect = this.cameraRect;\r\n\t\t\t\t\tcameraRect.width = height * camera.aspect;\r\n\t\t\t\t\tcameraRect.height = height;\r\n\t\t\t\t\t// console.log('position', camera.position.z, 'angle', angle, 'height', height, 'aspect', camera.aspect, cameraRect);\r\n\t\t\t\t\tcamera.updateProjectionMatrix();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// this.render();\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tupdateRaycasterMouse(event) {\r\n\t\tconst w2 = this.size.width / 2;\r\n\t\tconst h2 = this.size.height / 2;\r\n\t\tthis.mouse.x = (event.clientX - this.size.left - w2) / w2;\r\n\t\tthis.mouse.y = -(event.clientY - this.size.top - h2) / h2;\r\n\t\tconst raycaster = this.raycaster;\r\n\t\traycaster.setFromCamera(this.mouse, this.camera);\r\n\t\treturn raycaster;\r\n\t}\r\n\r\n\tonMouseDown(event) {\r\n\t\ttry {\r\n\t\t\tif (event.button !== 0) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\t\tconst hit = Interactive.hittest(raycaster, true);\r\n\t\t\tif (this.editor || DEBUG) {\r\n\t\t\t\tif (this.keys.Shift || this.keys.Control) {\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.select.next({ item: null });\r\n\t\t\t\t\tif (this.panorama.mesh.intersection) {\r\n\t\t\t\t\t\tconst position = new THREE.Vector3().copy(this.panorama.mesh.intersection.point).normalize();\r\n\t\t\t\t\t\tconsole.log(JSON.stringify({ position: position.toArray() }));\r\n\t\t\t\t\t\tthis.viewHit.next(position);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\traycasterXRHitTest() {\r\n\t\tif (this.renderer.xr.isPresenting) {\r\n\t\t\tconst raycaster = this.updateRaycasterXR(this.controller, this.raycaster);\r\n\t\t\tif (raycaster) {\r\n\t\t\t\tconst hit = Interactive.hittest(raycaster, this.controller.userData.isSelecting);\r\n\t\t\t\tthis.indicator.update();\r\n\t\t\t\t/*\r\n\t\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t\t// controllers.feedback();\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\traycasterDesktopHitTest(event) {\r\n\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\tif (this.lockedOrXR) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.dragItem) {\r\n\t\t\tif (typeof this.dragItem.onDragMove === 'function') {\r\n\t\t\t\tconst intersections = raycaster.intersectObjects([this.panorama.mesh]);\r\n\t\t\t\tif (intersections.length) {\r\n\t\t\t\t\tconst intersection = intersections[0];\r\n\t\t\t\t\t// this.panorama.mesh.intersection = intersection;\r\n\t\t\t\t\tconst position = new THREE.Vector3().copy(intersection.point).normalize();\r\n\t\t\t\t\tthis.dragItem.onDragMove(position);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (this.resizeItem) {\r\n\t\t\tif (typeof this.resizeItem.onResizeMove === 'function') {\r\n\t\t\t\t/*\r\n\t\t\t\t// calc arc x & y as scale;\r\n\t\t\t\tconst intersections = raycaster.intersectObjects([this.panorama.mesh]);\r\n\t\t\t\tif (intersections.length) {\r\n\t\t\t\t\tconst intersection = intersections[0];\r\n\t\t\t\t\t// this.panorama.mesh.intersection = intersection;\r\n\t\t\t\t\tconst position = new THREE.Vector3().copy(intersection.point).normalize();\r\n\t\t\t\t\tthis.resizeItem.onResizeMove(position);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tconst hit = Interactive.hittest(raycaster);\r\n\t\t\t/*\r\n\t\t\tif (hit && hit !== this.panorama.mesh) {\r\n\t\t\t\t// console.log('hit', hit);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.controlEvent$.next(this.control);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseMove(event) {\r\n\t\ttry {\r\n\t\t\tthis.raycasterDesktopHitTest(event);\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseUp(event) {\r\n\t\ttry {\r\n\t\t\tif (this.lockedOrXR) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (this.dragItem) {\r\n\t\t\t\tif (typeof this.dragItem.onDragEnd === 'function') {\r\n\t\t\t\t\tthis.dragItem.onDragEnd();\r\n\t\t\t\t\tthis.dragEnd.next(this.dragItem);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.dragItem = null;\r\n\t\t\tif (this.resizeItem) {\r\n\t\t\t\tif (typeof this.resizeItem.onResizeEnd === 'function') {\r\n\t\t\t\t\tthis.resizeItem.onResizeEnd();\r\n\t\t\t\t\tthis.resizeEnd.next(this.resizeItem);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis.resizeItem = null;\r\n\t\t\t/*\r\n\t\t\tif (NavPointDragging) {\r\n\t\t\t\tstopDragging\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tconst raycaster = this.updateRaycasterMouse(event);\r\n\t\t\tconst hit = Interactive.hittest(raycaster, false);\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonMouseWheel(event) {\r\n\t\ttry {\r\n\t\t\tif (this.lockedOrXR) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tconst deltaY = event.deltaY * (event.wheelDeltaY !== undefined ? 1 : 37);\r\n\t\t\tconst orbit = this.orbit;\r\n\t\t\tgsap.to(orbit, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tzoom: orbit.zoom + deltaY * 0.1,\r\n\t\t\t\tease: Power4.easeOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t});\r\n\t\t} catch (error) {\r\n\t\t\tthis.error = error;\r\n\t\t\t// throw (error);\r\n\t\t}\r\n\t}\r\n\r\n\tonOrientationDidChange() {\r\n\t\tthis.controlEvent$.next(this.control);\r\n\t}\r\n\r\n\tonVRStarted() {\r\n\t\t// this.objects.rotation.y = - Math.PI / 2;\r\n\t\tthis.objects.position.y = 1.3;\r\n\t\tthis.scene.add(this.indicator.mesh);\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VRStarted,\r\n\t\t});\r\n\t}\r\n\r\n\tonVREnded() {\r\n\t\t// this.objects.rotation.y = 0;\r\n\t\tthis.objects.position.y = 0;\r\n\t\tthis.cameraGroup.rotation.y = 0;\r\n\t\tthis.cameraGroup.position.y = 0;\r\n\t\tthis.scene.remove(this.indicator.mesh);\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VREnded,\r\n\t\t});\r\n\t}\r\n\r\n\tonVRStateDidChange(state) {\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.VRState,\r\n\t\t\tcamera: state.camera.array,\r\n\t\t});\r\n\t}\r\n\r\n\tonMenuNav(event) {\r\n\t\t// console.log('WorldComponent.onMenuNav', event.id, event);\r\n\t\tthis.menu = undefined;\r\n\t\tthis.navTo.next({ viewId: event.id });\r\n\t}\r\n\r\n\tonMenuToggle(event) {\r\n\t\t// console.log('WorldComponent.onMenuToggle', event.id, event);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.menu = event;\r\n\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonNavOver(nav) {\r\n\t\t// console.log('WorldComponent.onNavOver', nav);\r\n\t\tif (this.menu) {\r\n\t\t\treturn;\r\n\t\t\t// this.menu.removeMenu();\r\n\t\t}\r\n\t\tthis.view.items.forEach(item => item.showPanel = false);\r\n\t\tnav.item.showPanel = nav.shouldShowPanel();\r\n\t\tthis.pushChanges();\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.ShowPanel,\r\n\t\t\titemId: nav.item.showPanel ? nav.item.id : null,\r\n\t\t});\r\n\t}\r\n\r\n\tonNavOut(nav) {\r\n\t\t// console.log('WorldComponent.onNavOut', nav);\r\n\t\t// nav.item.showPanel = false;\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tonNavDown(event) {\r\n\t\tevent.item.showPanel = false;\r\n\t\t// console.log('WorldComponent.onNavDown', this.keys);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.editor && this.keys.Shift) {\r\n\t\t\tthis.dragItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else if (this.editor && this.keys.Control) {\r\n\t\t\tthis.resizeItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else {\r\n\t\t\tthis.navTo.next(event.item);\r\n\t\t}\r\n\t}\r\n\r\n\tonObjectDown(event) {\r\n\t\t// console.log('WorldComponent.onObjectDown', this.keys);\r\n\t\tif (this.lockedOrXR) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (this.editor && this.keys.Shift) {\r\n\t\t\tthis.dragItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t} else if (this.editor && this.keys.Control) {\r\n\t\t\tthis.resizeItem = event;\r\n\t\t\tthis.select.next(event);\r\n\t\t}\r\n\t}\r\n\r\n\tonPlayMedia(event) {\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.PlayMedia,\r\n\t\t\titemId: event.itemId,\r\n\t\t\tplaying: event.playing,\r\n\t\t});\r\n\t}\r\n\r\n\tonPanelDown(event) {\r\n\t\t// console.log('WorldComponent.onPanelDown', href, target);\r\n\t\tconst href = event.getAttribute('href');\r\n\t\tconst target = event.getAttribute('target') || '_self';\r\n\t\tif (href) {\r\n\t\t\twindow.open(href, '_blank');\r\n\t\t}\r\n\t}\r\n\r\n\tonGridMove(event) {\r\n\t\t// console.log('WorldComponent.onGridMove', event, this.view);\r\n\t\tthis.view.items = [];\r\n\t\t// this.loading = LOADING_BANNER;\r\n\t\tthis.pushChanges();\r\n\t\tthis.orbit.walk(event.position, (headingLongitude, headingLatitude) => {\r\n\t\t\tconst tile = this.view.getTile(event.indices.x, event.indices.y);\r\n\t\t\tif (tile) {\r\n\t\t\t\tthis.panorama.crossfade(tile, this.renderer, (envMap, texture, rgbe) => {\r\n\t\t\t\t\t// this.scene.background = envMap;\r\n\t\t\t\t\tthis.scene.environment = envMap;\r\n\t\t\t\t\tthis.orbit.walkComplete(headingLongitude, headingLatitude);\r\n\t\t\t\t\tthis.view.updateCurrentItems();\r\n\t\t\t\t\t// this.loading = null;\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\t// this.render();\r\n\t\t\t\t\t// this.pushChanges();\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonGridNav(event) {\r\n\t\t// console.log('WorldComponent.onGridNav', event);\r\n\t\tif (this.locked) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMessageService.send({\r\n\t\t\ttype: MessageType.NavToGrid,\r\n\t\t\tviewId: this.view.id,\r\n\t\t\tgridIndex: event,\r\n\t\t});\r\n\t\tthis.pushChanges();\r\n\t}\r\n\r\n\tcontrol$() {\r\n\t\treturn this.controlEvent$.pipe(\r\n\t\t\tfilter(() => StateService.state.control || StateService.state.spyed || this.editor),\r\n\t\t\tauditTime(40),\r\n\t\t\ttap((control) => {\r\n\t\t\t\tcontrol.orientation.latitude = this.orbit.latitude;\r\n\t\t\t\tcontrol.orientation.longitude = this.orbit.longitude;\r\n\t\t\t\tcontrol.zoom = this.orbit.zoom;\r\n\t\t\t\tconst intersections = this.raycaster.intersectObjects([this.panorama.mesh]);\r\n\t\t\t\tconst point = intersections.length ? intersections[0].point.normalize() : null;\r\n\t\t\t\tif (point) {\r\n\t\t\t\t\tcontrol.pointer[0] = point.x;\r\n\t\t\t\t\tcontrol.pointer[1] = point.y;\r\n\t\t\t\t\tcontrol.pointer[2] = point.z;\r\n\t\t\t\t}\r\n\t\t\t\tMessageService.send(control);\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n\r\n\taddListeners() {\r\n\t\tthis.control = {\r\n\t\t\ttype: MessageType.ControlInfo,\r\n\t\t\torientation: { latitude: 0, longitude: 0 },\r\n\t\t\tzoom: 1,\r\n\t\t\tpointer: [0, 0, 0],\r\n\t\t};\r\n\t\tthis.controlEvent$ = new ReplaySubject(1);\r\n\t\tthis.control$().pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tthis.renderer.xr.setSession(session);\r\n\t\t\tif (session) {\r\n\t\t\t\tthis.onVRStarted();\r\n\t\t\t} else {\r\n\t\t\t\tthis.onVREnded();\r\n\t\t\t}\r\n\t\t});\r\n\t\tvrService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t).subscribe((state) => {\r\n\t\t\tthis.onVRStateDidChange(state);\r\n\t\t});\r\n\t\tconst orbit$ = this.orbit.observe$(this.container).pipe(\r\n\t\t\tshareReplay(1)\r\n\t\t);\r\n\t\t/*\r\n\t\tconst drag$ = orbit$.pipe(\r\n\t\t\tfilter(event => event instanceof OrbitDragEvent),\r\n\t\t);\r\n\t\t*/\r\n\t\tconst orientation$ = orbit$.pipe(\r\n\t\t\tfilter(event => event instanceof OrbitMoveEvent),\r\n\t\t\tauditTime(Math.floor(1000 / 15)),\r\n\t\t);\r\n\t\torientation$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(event => {\r\n\t\t\t// this.render();\r\n\t\t\tthis.onOrientationDidChange();\r\n\t\t});\r\n\t\tMessageService.out$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.RequestInfo:\r\n\t\t\t\t\tmessage.type = MessageType.RequestInfoResult;\r\n\t\t\t\t\tmessage.viewId = this.view.id;\r\n\t\t\t\t\tmessage.orientation = this.orbit.getOrientation();\r\n\t\t\t\t\tmessage.zoom = this.orbit.zoom;\r\n\t\t\t\t\tif (this.view instanceof PanoramaGridView) {\r\n\t\t\t\t\t\tmessage.gridIndex = this.view.index;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t// console.log('WorldComponent', 'MessageType.RequestInfo', 'from', message.clientId, 'to', StateService.state.uid, message.orientation);\r\n\t\t\t\t\tMessageService.sendBack(message);\r\n\t\t\t\t\tif (StateService.state.role !== RoleType.Publisher) {\r\n\t\t\t\t\t\tStateService.patchState({ spyed: true });\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.RequestInfoResult:\r\n\t\t\t\t\t// console.log('WorldComponent', 'MessageType.RequestInfoResult', 'from', message.clientId, 'to', StateService.state.uid, message.orientation);\r\n\t\t\t\t\tif (ViewService.viewId !== message.viewId) {\r\n\t\t\t\t\t\tViewService.viewId = message.viewId;\r\n\t\t\t\t\t\tthis.requestInfoResult = message;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this.view instanceof PanoramaGridView && message.gridIndex) {\r\n\t\t\t\t\t\t\tthis.view.index = message.gridIndex;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (!this.view || !this.view.ready) {\r\n\t\t\t\t\t\t\tthis.requestInfoResult = message;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (this.view && this.view.id === message.viewId) {\r\n\t\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\t\t\tthis.camera.updateProjectionMatrix();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (this.view instanceof PanoramaGridView && message.gridIndex) {\r\n\t\t\t\t\t\t\tthis.view.index = message.gridIndex;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tthis.requestInfoResult = message;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t\t// console.log('WorldComponent', 'MessageType.RequestInfoResult', message, StateService.state);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t// !!! old control accepted message\r\n\t\t\t\t/*\r\n\t\t\t\tcase MessageType.RequestControlAccepted:\r\n\t\t\t\t\tmessage = {\r\n\t\t\t\t\t\ttype: MessageType.NavToView,\r\n\t\t\t\t\t\tviewId: this.view.id,\r\n\t\t\t\t\t};\r\n\t\t\t\t\tif (this.view instanceof PanoramaGridView) {\r\n\t\t\t\t\t\tmessage.gridIndex = this.view.index;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tMessageService.send(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t*/\r\n\t\t\t\tcase MessageType.ShowPanel:\r\n\t\t\t\t\tif (this.menu) {\r\n\t\t\t\t\t\tthis.menu.removeMenu();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.view.items.forEach(item => item.showPanel = (item.id === message.itemId));\r\n\t\t\t\t\tthis.pushChanges();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.PlayMedia:\r\n\t\t\t\t\tconst item = this.view.items.find(item => item.id === message.itemId);\r\n\t\t\t\t\tif (item && item.mesh instanceof MediaMesh) {\r\n\t\t\t\t\t\titem.mesh.setPlayingState(message.playing);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.NavToGrid:\r\n\t\t\t\t\t// console.log('WorldComponent.NavToGrid', this.view.id, message);\r\n\t\t\t\t\tif (this.view.id === message.viewId) {\r\n\t\t\t\t\t\tthis.view.index = message.gridIndex;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VRStarted:\r\n\t\t\t\t\tthis.addOffCanvasScene(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VREnded:\r\n\t\t\t\t\tthis.removeOffCanvasScene(message);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.VRState:\r\n\t\t\t\t\tthis.updateOffCanvasScene(message);\r\n\t\t\t\t\tif (StateService.state.spying === message.clientId) {\r\n\t\t\t\t\t\tthis.orbit.setVRCamera(message.camera);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase MessageType.ControlInfo:\r\n\t\t\t\t\tif (!this.renderer.xr.isPresenting) {\r\n\t\t\t\t\t\tthis.orbit.setOrientation(message.orientation);\r\n\t\t\t\t\t\tthis.orbit.zoom = message.zoom;\r\n\t\t\t\t\t\t// this.camera.updateProjectionMatrix();\r\n\t\t\t\t\t\t// this.render();\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthis.pointer.setPosition(message.pointer[0], message.pointer[1], message.pointer[2]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t\tStateService.state$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(state => {\r\n\t\t\tthis.state = state;\r\n\t\t\tthis.showPointer = (StateService.state.locked || StateService.state.spying);\r\n\t\t\t// console.log(state);\r\n\t\t\t// this.pushChanges();\r\n\t\t});\r\n\t\tthis.resize = this.resize.bind(this);\r\n\t\tthis.render = this.render.bind(this);\r\n\t\tthis.onMouseDown = this.onMouseDown.bind(this);\r\n\t\tthis.onMouseMove = this.onMouseMove.bind(this);\r\n\t\tthis.onMouseUp = this.onMouseUp.bind(this);\r\n\t\tthis.onMouseWheel = this.onMouseWheel.bind(this);\r\n\t\t// this.controls.addEventListener('change', this.render); // use if there is no animation loop\r\n\t\twindow.addEventListener('resize', this.resize, false);\r\n\t\tthis.container.addEventListener('wheel', this.onMouseWheel, false);\r\n\t\tthis.container.addEventListener('mousedown', this.onMouseDown, false);\r\n\t\tthis.container.addEventListener('mouseup', this.onMouseUp, false);\r\n\t\tdocument.addEventListener('mousemove', this.onMouseMove, false);\r\n\t}\r\n\r\n\tremoveListeners() {\r\n\t\twindow.removeEventListener('resize', this.resize, false);\r\n\t\twindow.removeEventListener('resize', this.resize, false);\r\n\t\tdocument.removeEventListener('mousemove', this.onMouseMove, false);\r\n\t\tdocument.removeEventListener('wheel', this.onMouseWheel, false);\r\n\t\tthis.container.removeEventListener('mousedown', this.onMouseDown, false);\r\n\t\tthis.container.removeEventListener('mouseup', this.onMouseUp, false);\r\n\t}\r\n}\r\n\r\nWorldComponent.meta = {\r\n\tselector: '[world]',\r\n\tinputs: ['view', 'views', 'editor'],\r\n\toutputs: ['navTo', 'viewHit', 'dragEnd', 'resizeEnd', 'select'],\r\n};\r\n","import { Component, getContext } from 'rxcomp';\r\nimport Interactive from '../interactive/interactive';\r\n// import Ease from '../ease/ease';\r\nimport WorldComponent from '../world.component';\r\n\r\nconst deg = THREE.Math.degToRad;\r\n\r\nconst GEOMETRY = new THREE.BoxBufferGeometry(1, 1, 1);\r\n// const GEOMETRY = new THREE.IcosahedronBufferGeometry(0.5, 1);\r\n\r\nexport default class ModelComponent extends Component {\r\n\r\n\tset renderOrder(renderOrder) {\r\n\t\tthis.group.renderOrder = renderOrder;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\t// console.log('ModelComponent.onInit');\r\n\t\t// console.log('item', this.item, 'host', this.host);\r\n\t\tif (!this.host) {\r\n\t\t\tthrow ('ModelComponent host is undefined');\r\n\t\t}\r\n\t\tthis.scale = new THREE.Vector3(1.0, 1.0, 1.0);\r\n\t\tthis.position = new THREE.Vector3();\r\n\t\tconst group = this.group = new THREE.Group();\r\n\t\tgroup.name = this.getName();\r\n\t\tgroup.userData.render = (time, tick) => {\r\n\t\t\t// if (this.intersection) {\r\n\t\t\tthis.render(this, time, tick);\r\n\t\t\t// }\r\n\t\t};\r\n\t\tthis.getContainer().add(group);\r\n\t\tthis.onCreate(\r\n\t\t\t(mesh, item) => this.onMount(mesh, item),\r\n\t\t\t(mesh, item) => this.onDismount(mesh, item)\r\n\t\t);\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tconst group = this.group;\r\n\t\tthis.getContainer().remove(group);\r\n\t\tdelete group.userData.render;\r\n\t\tthis.disposeObject(group);\r\n\t\tthis.group = null;\r\n\t}\r\n\r\n\tgetContainer() {\r\n\t\treturn this.host.objects;\r\n\t}\r\n\r\n\tgetName(name) {\r\n\t\treturn `${this.constructor.meta.selector}-${this.rxcompId}${name ? `-${name}` : ''}`;\r\n\t}\r\n\r\n\tonCreate(mounth, dismount) {\r\n\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\tcolor: new THREE.Color('#ffcc00'),\r\n\t\t\troughness: 0.4,\r\n\t\t\tmetalness: 0.01,\r\n\t\t\tflatShading: true,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.9,\r\n\t\t});\r\n\t\tconst mesh = new THREE.Mesh(GEOMETRY, material);\r\n\t\tif (typeof mounth === 'function') {\r\n\t\t\tmounth(mesh);\r\n\t\t}\r\n\t\treturn mesh;\r\n\t}\r\n\r\n\tonMount(mesh, item) {\r\n\t\tif (this.mesh) {\r\n\t\t\t// console.log('ModelComponent.dismount.mesh');\r\n\t\t\tthis.onDismount(this.mesh);\r\n\t\t}\r\n\t\tmesh.name = this.getName('mesh');\r\n\t\tthis.mesh = mesh;\r\n\t\tif (item) {\r\n\t\t\titem.mesh = mesh;\r\n\t\t\titem.onUpdate = () => {\r\n\t\t\t\tthis.onUpdate(item, mesh);\r\n\t\t\t};\r\n\t\t\titem.onUpdateAsset = () => {\r\n\t\t\t\tthis.onUpdateAsset(item, mesh);\r\n\t\t\t};\r\n\t\t}\r\n\t\tthis.group.add(mesh);\r\n\t\t// this.host.render(); !!!\r\n\t\t/*\r\n\t\tconst node = this.node;\r\n\t\tDomService.scrollIntersection$(node).subscribe(event => {\r\n\t\t\tthis.scroll = event.scroll;\r\n\t\t\tthis.intersection = event.intersection;\r\n\t\t\tthis.calculateScaleAndPosition();\r\n\t\t});\r\n\t\t*/\r\n\t\t// console.log('Model.loaded', mesh);\r\n\t}\r\n\r\n\tonDismount(mesh, item) {\r\n\t\tthis.group.remove(mesh);\r\n\t\tif (typeof mesh.dispose === 'function') {\r\n\t\t\tmesh.dispose();\r\n\t\t}\r\n\t\tthis.disposeObject(mesh);\r\n\t\tthis.mesh = null;\r\n\t\tif (item) {\r\n\t\t\tdelete item.mesh;\r\n\t\t\tdelete item.onUpdate;\r\n\t\t\tdelete item.onUpdateAsset;\r\n\t\t}\r\n\t}\r\n\r\n\tdisposeObject(object) {\r\n\t\tobject.traverse(child => {\r\n\t\t\tif (child.isInteractiveMesh || child.isInteractiveSprite) {\r\n\t\t\t\tInteractive.dispose(child);\r\n\t\t\t}\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tif (child.material.map && child.material.map.disposable !== false) {\r\n\t\t\t\t\tchild.material.map.dispose();\r\n\t\t\t\t}\r\n\t\t\t\tchild.material.dispose();\r\n\t\t\t\tchild.geometry.dispose();\r\n\t\t\t} else if (child.isSprite) {\r\n\t\t\t\tif (child.material.map && child.material.map.disposable !== false) {\r\n\t\t\t\t\tchild.material.map.dispose();\r\n\t\t\t\t}\r\n\t\t\t\tchild.material.dispose();\r\n\t\t\t}\r\n\t\t});\r\n\t\t// console.log('ModelComponent.disposeObject', object);\r\n\t}\r\n\r\n\tcalculateScaleAndPosition() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.host.repos(this, node.getBoundingClientRect());\r\n\t}\r\n\r\n\trender(time, tick) {\r\n\t\t/*\r\n\t\tthis.calculateScaleAndPosition();\r\n\t\tconst group = this.group;\r\n\t\tconst scale = this.scale;\r\n\t\t// group.scale.set(scale.x, scale.y, scale.z);\r\n\t\tconst position = this.position;\r\n\t\tgroup.position.set(position.x, 0, 0);\r\n\t\t// const tween = this.tween();\r\n\t\t// group.rotation.x = deg(180) * tween;\r\n\t\t// group.rotation.y = deg(360) * tween;\r\n\t\t*/\r\n\t}\r\n\r\n\tgetScroll(offset) {\r\n\t\tconst scroll = this.intersection.scroll(offset);\r\n\t\t// console.log(scroll);\r\n\t\treturn scroll;\r\n\t}\r\n\r\n\tgetTween(offset) {\r\n\t\tlet tween = Math.min(0.0, this.intersection.offset(offset)) + 1;\r\n\t\ttween = Math.max(0.0, tween);\r\n\t\t// tween = Ease.Sine.InOut(tween);\r\n\t\ttween -= 1;\r\n\t\treturn tween;\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) { }\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) { }\r\n\r\n}\r\n\r\nModelComponent.meta = {\r\n\tselector: '[model]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { environment } from '../../environment';\r\nimport { PANORAMA_RADIUS } from '../panorama/panorama';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst PANEL_RADIUS = PANORAMA_RADIUS - 0.01;\r\nconst ORIGIN = new THREE.Vector3();\r\n\r\nexport default class ModelBannerComponent extends ModelComponent {\r\n\r\n\tget title() {\r\n\t\treturn this.title_;\r\n\t}\r\n\tset title(title) {\r\n\t\tif (this.title_ !== title) {\r\n\t\t\tconst init = this.title_ != null;\r\n\t\t\tthis.title_ = title;\r\n\t\t\tif (!init) {\r\n\t\t\t\tthis.createBanner();\r\n\t\t\t} else {\r\n\t\t\t\tthis.updateBanner();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/*\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tconsole.log('ModelBannerComponent.onInit', this.item);\r\n\t}\r\n\r\n\tonView() {\r\n\t\tconsole.log('ModelBannerComponent.onView', this.item);\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\t// this.createBanner();\r\n\t}\r\n\t*/\r\n\r\n\tonChanges() {\r\n\t\t// console.log('ModelBannerComponent.onChanges', this.item);\r\n\t\tthis.title = this.item.title;\r\n\t}\r\n\r\n\tcreateBanner() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst texture = result.texture;\r\n\t\t\tconst repeat = 24;\r\n\t\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\t\ttexture.repeat.x = repeat;\r\n\t\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\t\tconst aspect = (result.width * repeat) / result.height;\r\n\t\t\tconst arc = Math.PI / 180 * 360;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / aspect;\r\n\t\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 80, 2, true, 0, arc);\r\n\t\t\tgeometry.scale(-1, 1, 1);\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tmap: texture,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tconst banners = this.banners = new Array(1).fill(0).map(x => new THREE.Mesh(geometry, material));\r\n\t\t\tbanners.forEach((banner, i) => {\r\n\t\t\t\tbanner.rotation.y = Math.PI / 2 * i;\r\n\t\t\t\t// !!!\r\n\t\t\t\t// mesh.add(banner);\r\n\t\t\t});\r\n\t\t\tconst from = { value: 0 };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tvalue: 1,\r\n\t\t\t\tdelay: 0.0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tmesh.userData = {\r\n\t\t\t\trender: () => {\r\n\t\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.02;\r\n\t\t\t\t\t// texture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\r\n\tupdateBanner() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\t// console.log('ModelBannerComponent.updateBanner', result);\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tonViewBak() {\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst texture = result.texture;\r\n\t\t\tconst repeat = 3;\r\n\t\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\t\ttexture.repeat.x = repeat;\r\n\t\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\t\tconst aspect = (result.width * repeat) / result.height;\r\n\t\t\tconst arc = Math.PI / 180 * 45;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / aspect;\r\n\t\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 20, 2, true, 0, arc);\r\n\t\t\tgeometry.scale(-1, 1, 1);\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tmap: texture,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tconst banners = this.banners = new Array(4).fill(0).map(x => new THREE.Mesh(geometry, material));\r\n\t\t\tbanners.forEach((banner, i) => {\r\n\t\t\t\tbanner.rotation.y = Math.PI / 2 * i;\r\n\t\t\t\tmesh.add(banner);\r\n\t\t\t});\r\n\t\t\tconst from = { value: 0 };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.5,\r\n\t\t\t\tvalue: 1,\r\n\t\t\t\tdelay: 0.0,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tmesh.userData = {\r\n\t\t\t\trender: () => {\r\n\t\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.2;\r\n\t\t\t\t\ttexture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t});\r\n\t}\r\n\t*/\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tgetCanvasTexture() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst MIN_W = 512;\r\n\t\t\tlet W = MIN_W;\r\n\t\t\tlet H = 128;\r\n\t\t\tconst F = Math.floor(H * 0.8);\r\n\t\t\tconst L = Math.floor(H * 0.075);\r\n\t\t\tlet canvas;\r\n\t\t\tif (this.canvas) {\r\n\t\t\t\tcanvas = this.canvas;\r\n\t\t\t} else {\r\n\t\t\t\tcanvas = this.canvas = document.createElement('canvas');\r\n\t\t\t\t// canvas.classList.add('canvas--debug');\r\n\t\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\t}\r\n\t\t\tcanvas.width = W;\r\n\t\t\tcanvas.height = H;\r\n\t\t\tconst text = this.item.title;\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t// const ctx = text.material.map.image.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `${F}px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tW = metrics.width + 8;\r\n\t\t\tW = Math.max(MIN_W, Math.pow(2, Math.ceil(Math.log(W) / Math.log(2))));\r\n\t\t\t// const x = W / 2;\r\n\t\t\t// const y = 16;\r\n\t\t\tcanvas.width = W;\r\n\t\t\tctx.clearRect(0, 0, W, H);\r\n\t\t\tctx.fillStyle = '#0000005A'; // 35% // '#000000C0'; // 75%\r\n\t\t\tctx.fillRect(0, 0, W, H);\r\n\t\t\tctx.font = `${F}px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';\r\n\t\t\tctx.lineWidth = L;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with \"bevel\" & \"round\" for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, W / 2, H / 2);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, W / 2, H / 2, W);\r\n\t\t\t// text.material.map.needsUpdate = true;\r\n\t\t\tlet texture;\r\n\t\t\tif (this.texture) {\r\n\t\t\t\ttexture = this.texture;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\ttexture = this.texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t}\r\n\t\t\t// console.log(F, L, W, H);\r\n\t\t\tresolve({ texture: texture, width: W, height: H });\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tgetCanvasTexture_() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tif (this.item.bannerTexture) {\r\n\t\t\t\tresolve(this.item.bannerTexture);\r\n\t\t\t} else {\r\n\t\t\t\tconst { node } = getContext(this);\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\thtml2canvas(node, {\r\n\t\t\t\t\t\tbackgroundColor: '#00000000', // '#000000ff',\r\n\t\t\t\t\t\tscale: 2,\r\n\t\t\t\t\t}).then(canvas => {\r\n\t\t\t\t\t\t// !!!\r\n\t\t\t\t\t\t// document.body.appendChild(canvas);\r\n\t\t\t\t\t\t// const alpha = this.getAlphaFromCanvas(canvas);\r\n\t\t\t\t\t\t// document.body.appendChild(alpha);\r\n\t\t\t\t\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t\t\t\t// const alphaMap = new THREE.CanvasTexture(alpha);\r\n\t\t\t\t\t\tthis.item.bannerTexture = {\r\n\t\t\t\t\t\t\ttexture: texture,\r\n\t\t\t\t\t\t\twidth: canvas.width,\r\n\t\t\t\t\t\t\theight: canvas.height,\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tresolve(this.item.bannerTexture);\r\n\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t});\r\n\t\t\t\t}, 1);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\t*/\r\n}\r\n\r\nModelBannerComponent.ORIGIN = new THREE.Vector3();\r\n\r\nModelBannerComponent.meta = {\r\n\tselector: '[model-banner]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelEditableComponent extends ModelComponent {\r\n\r\n\tget editing() {\r\n\t\treturn this.editing_;\r\n\t}\r\n\tset editing(editing) {\r\n\t\tif (this.editing_ !== editing) {\r\n\t\t\tthis.editing_ = editing;\r\n\t\t\tthis.setHelper(editing);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.RADIUS = 100;\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tthis.editing = false;\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\tsetHelper(showHelper) {\r\n\t\tif (showHelper) {\r\n\t\t\tif (!this.helper) {\r\n\t\t\t\tthis.helper = new THREE.BoxHelper(this.mesh, 0x00ff00);\r\n\t\t\t}\r\n\t\t\tthis.host.scene.add(this.helper);\r\n\t\t} else if (this.helper) {\r\n\t\t\tthis.host.scene.remove(this.helper);\r\n\t\t}\r\n\t}\r\n\r\n\tupdateHelper() {\r\n\t\tif (this.helper) {\r\n\t\t\tthis.helper.setFromObject(this.mesh);\r\n\t\t\t// this.helper.update();\r\n\t\t}\r\n\t}\r\n}\r\n\r\nModelEditableComponent.meta = {\r\n\tselector: '[model-editable]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { filter, take, takeUntil } from 'rxjs/operators';\r\nimport MediaMesh from '../media/media-mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport default class ModelCurvedPlaneComponent extends ModelEditableComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelCurvedPlaneComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst item = this.item;\r\n\t\tconst items = this.items;\r\n\t\tconst geometry = this.getCurvedPanelGeometry(item);\r\n\t\tlet mesh;\r\n\t\tlet subscription;\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((streamId) => {\r\n\t\t\tif (this.streamId !== streamId) {\r\n\t\t\t\tthis.streamId = streamId;\r\n\t\t\t\t// !!! called by ModelComponent\r\n\t\t\t\t/*\r\n\t\t\t\tif (mesh) {\r\n\t\t\t\t\tdismount(mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tif (subscription) {\r\n\t\t\t\t\tsubscription.unsubscribe();\r\n\t\t\t\t\tsubscription = null;\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('ModelCurvedPanel', streamId, item.asset)\r\n\t\t\t\tif (streamId || !item.asset) {\r\n\t\t\t\t\titem.streamId = streamId;\r\n\t\t\t\t\tmesh = new MediaMesh(item, items, geometry);\r\n\t\t\t\t\tmesh.name = 'curved-plane';\r\n\t\t\t\t\tif (item.position) {\r\n\t\t\t\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.rotation) {\r\n\t\t\t\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.scale) {\r\n\t\t\t\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tmesh.load(() => {\r\n\t\t\t\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\t\t\t\tmount(mesh, item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsubscription = mesh.events$().pipe(\r\n\t\t\t\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t\t\t\t).subscribe(() => { });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('down', () => {\r\n\t\t\t\t\t\t// console.log('ModelCurvedPanelComponent.down');\r\n\t\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('playing', (playing) => {\r\n\t\t\t\t\t\t// console.log('ModelCurvedPanelComponent.playing', playing);\r\n\t\t\t\t\t\tthis.play.next({ itemId: this.item.id, playing });\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (this.mesh) {\r\n\t\t\t\t\tdismount(this.mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('streamId', streamId, mesh);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.mesh.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelCurvedPlaneComponent.onUpdate', item);\r\n\t\tif (item.position) {\r\n\t\t\tmesh.position.fromArray(item.position);\r\n\t\t}\r\n\t\tif (item.rotation) {\r\n\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t}\r\n\t\tif (item.scale) {\r\n\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t}\r\n\t\t// !!! deactivated\r\n\t\tif (true && (item.radius !== this.radius_ || item.height !== this.height_ || item.arc !== this.arc_)) {\r\n\t\t\tthis.mesh.geometry.dispose();\r\n\t\t\tconst geometry = this.getCurvedPanelGeometry(item);\r\n\t\t\tthis.mesh.geometry = geometry;\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelCurvedPlaneComponent.onUpdateAsset', item);\r\n\t\tthis.mesh.updateByItem(item);\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\tfilter(streamId => streamId !== null),\r\n\t\t\ttake(1),\r\n\t\t).subscribe((streamId) => {\r\n\t\t\titem.streamId = streamId;\r\n\t\t\tthis.mesh.load(() => {\r\n\t\t\t\t// console.log('ModelCurvedPlaneComponent.mesh.load.complete');\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\tthis.item.showPanel = false;\r\n\t\tthis.editing = true;\r\n\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(20);\r\n\t\tthis.mesh.lookAt(ModelCurvedPlaneComponent.ORIGIN);\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\tthis.item.position = this.mesh.position.toArray();\r\n\t\tthis.item.rotation = this.mesh.rotation.toArray();\r\n\t\tthis.item.scale = this.mesh.scale.toArray();\r\n\t\tthis.editing = false;\r\n\t}\r\n\r\n\tgetCurvedPanelGeometry(item) {\r\n\t\tthis.radius_ = item.radius;\r\n\t\tthis.height_ = item.height;\r\n\t\tthis.arc_ = item.arc;\r\n\t\tconst arc = Math.PI / 180 * item.arc;\r\n\t\tconst geometry = new THREE.CylinderBufferGeometry(item.radius, item.radius, item.height, 36, 2, true, 0, arc);\r\n\t\tgeometry.rotateY(-Math.PI - arc / 2);\r\n\t\tgeometry.scale(-1, 1, 1);\r\n\t\treturn geometry;\r\n\t}\r\n\r\n}\r\n\r\nModelCurvedPlaneComponent.ORIGIN = new THREE.Vector3();\r\nModelCurvedPlaneComponent.textures = {};\r\n\r\nModelCurvedPlaneComponent.meta = {\r\n\tselector: '[model-curved-plane]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play'],\r\n\tinputs: ['item', 'items'],\r\n};\r\n","import { BehaviorSubject } from \"rxjs\";\r\n\r\nexport const XRStatus = {\r\n\tWaiting: 'waiting',\r\n\tEnabled: 'enabled',\r\n\tEnded: 'ended',\r\n\tStarted: 'started',\r\n\tDisabled: 'disabled',\r\n\tNeedsHttps: 'needs-https',\r\n\tUnavailable: 'unavailable',\r\n};\r\n\r\nexport default class DebugService {\r\n\r\n\tstatic getService() {\r\n\t\tif (!this.service_) {\r\n\t\t\tthis.service_ = new DebugService();\r\n\t\t}\r\n\t\treturn this.service_;\r\n\t}\r\n\r\n\tget message() {\r\n\t\treturn this.message$.getValue();\r\n\t}\r\n\r\n\tconstructor() {\r\n\t\tif (DebugService.service_) {\r\n\t\t\tthrow ('DebugService is a singleton class!');\r\n\t\t}\r\n\t\tthis.message$ = new BehaviorSubject(null);\r\n\t}\r\n\r\n\tsetMessage(message) {\r\n\t\tif (this.message !== message) {\r\n\t\t\tthis.message$.next(message);\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","import { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport DebugService from '../debug.service';\r\nimport VRService from '../vr.service';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelDebugComponent extends ModelComponent {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelDebugComponent.loader || (ModelDebugComponent.loader = new THREE.FontLoader());\r\n\t}\r\n\r\n\tstatic getFontLoader(callback) {\r\n\t\treturn ModelDebugComponent.fontLoader || (ModelDebugComponent.fontLoader = ModelDebugComponent.getLoader().load(environment.getPath('fonts/helvetiker/helvetiker_regular.typeface.json'), callback));\r\n\t}\r\n\r\n\tget message() {\r\n\t\treturn this.message_;\r\n\t}\r\n\r\n\tset message(message) {\r\n\t\tmessage = message && message !== '' ? message : null;\r\n\t\tif (this.message_ !== message) {\r\n\t\t\tthis.message_ = message;\r\n\t\t\t// console.log('ModelDebugComponent.set.message', message);\r\n\t\t\tthis.setText(message);\r\n\t\t\t/*\r\n\t\t\tif (this.font) {\r\n\t\t\t\tthis.setText(message);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelDebugComponent.onInit');\r\n\t\t// this.loadFont();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tif (session) {\r\n\t\t\t\tif (this.text) {\r\n\t\t\t\t\tthis.textGroup.add(this.text);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (this.text) {\r\n\t\t\t\t\tthis.text.parent.remove(this.text);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tconst debugService = this.debugService = DebugService.getService();\r\n\t\tdebugService.message$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(message => this.message = message);\r\n\t}\r\n\r\n\tcreateText() {\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\tcanvas.width = ModelDebugComponent.W;\r\n\t\tcanvas.height = ModelDebugComponent.H;\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\ttexture.needsUpdate = true;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(4, 1, 2, 2);\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\tmap: texture,\r\n\t\t\tcolor: 0xffffff, // 0x33c5f6,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 1,\r\n\t\t\t// blending: THREE.AdditiveBlending,\r\n\t\t\t// side: THREE.DoubleSide\r\n\t\t});\r\n\t\tconst text = new THREE.Mesh(geometry, material);\r\n\t\ttext.renderer = environment.renderOrder.debug;\r\n\t\ttext.position.y = 0;\r\n\t\treturn text;\r\n\t}\r\n\r\n\tloadFont() {\r\n\t\tthis.fontLoader = ModelDebugComponent.getFontLoader((font) => {\r\n\t\t\tthis.font = font;\r\n\t\t\tif (this.message_) {\r\n\t\t\t\tthis.setText(this.message_);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst textGroup = this.textGroup = new THREE.Group();\r\n\t\tconst material = this.material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tcolor: 0xffffff, // 0x33c5f6,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 1,\r\n\t\t\tside: THREE.DoubleSide\r\n\t\t});\r\n\t\tconst text = this.text = this.createText();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(textGroup);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n\r\n\trender(time, tick) {\r\n\t\tconst group = this.group;\r\n\t\tlet camera = this.host.camera;\r\n\t\tconst position = this.position;\r\n\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\tcamera = this.host.renderer.xr.getCamera(camera);\r\n\t\t\t// camera.updateMatrixWorld(); // make sure the camera matrix is updated\r\n\t\t\t// camera.matrixWorldInverse.getInverse(camera.matrixWorld);\r\n\t\t}\r\n\t\tcamera.getWorldDirection(position);\r\n\t\t// console.log(position);\r\n\t\t// if (position.lengthSq() > 0.01) {\r\n\t\t// normalize so we can get a constant speed\r\n\t\t// position.normalize();\r\n\t\tposition.multiplyScalar(3);\r\n\t\t// move body, not the camera\r\n\t\t// VR.body.position.add(lookDirection);\r\n\t\t// console.log(position.x + '|' + position.y + '|' + position.z);\r\n\t\tgroup.position.copy(position);\r\n\t\tgroup.lookAt(ModelDebugComponent.ORIGIN);\r\n\t\t// }\r\n\t}\r\n\r\n\tsetText(message) {\r\n\t\tconst text = this.text;\r\n\t\tif (text) {\r\n\t\t\tif (this.host.renderer.xr.isPresenting && message != null) {\r\n\t\t\t\t// draw\r\n\t\t\t\tconst ctx = text.material.map.image.getContext('2d');\r\n\t\t\t\tctx.clearRect(0, 0, ModelDebugComponent.W, ModelDebugComponent.H);\r\n\t\t\t\t// ctx.fillRect(0, 0, 10, 10);\r\n\t\t\t\t// ctx.fillRect(ModelDebugComponent.W - 10, ModelDebugComponent.H - 10, 10, 10);\r\n\t\t\t\tctx.font = `30px ${environment.fontFamily}`;\r\n\t\t\t\tctx.textBaseline = 'middle';\r\n\t\t\t\tctx.textAlign = \"center\";\r\n\t\t\t\tctx.fillStyle = '#FFFFFF';\r\n\t\t\t\tctx.strokeStyle = '#000000';\r\n\t\t\t\tctx.lineWidth = 5;\r\n\t\t\t\tctx.fillText(message, ModelDebugComponent.W / 2, ModelDebugComponent.H / 2, ModelDebugComponent.W - 20);\r\n\t\t\t\ttext.material.map.needsUpdate = true;\r\n\t\t\t\t// draw\r\n\t\t\t\tthis.textGroup.add(text);\r\n\t\t\t} else if (text.parent) {\r\n\t\t\t\ttext.parent.remove(text);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nModelDebugComponent.ORIGIN = new THREE.Vector3();\r\nModelDebugComponent.W = 1024;\r\nModelDebugComponent.H = 256;\r\n\r\nModelDebugComponent.meta = {\r\n\tselector: '[model-debug]',\r\n\thosts: { host: WorldComponent },\r\n};\r\n","import { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\n\r\nconst FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform float opacity;\r\nuniform float tween;\r\n\r\nvoid main() {\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tvec4 colorB = texture2D(textureB, vUv);\r\n\tvec4 color = mix(colorA, colorB, tween);\r\n\tcolor.a = clamp(color.a * opacity, 0.0, 1.0);\r\n\tcolor.rgb /= color.a;\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nexport default class ModelGridComponent extends ModelComponent {\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelGridComponent.loader || (ModelGridComponent.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getTexture() {\r\n\t\treturn ModelGridComponent.texture || (ModelGridComponent.texture = ModelGridComponent.getLoader().load(environment.getPath('textures/ui/floor-nav.png')));\r\n\t}\r\n\r\n\tstatic getOverTexture() {\r\n\t\treturn ModelGridComponent.textureOver || (ModelGridComponent.textureOver = ModelGridComponent.getLoader().load(environment.getPath('textures/ui/floor-nav-over.png')));\r\n\t}\r\n\r\n\tset coords(coords) {\r\n\t\tif ((!coords && this.coords_ !== coords) || !this.coords_ || coords.x !== this.coords_.x || coords.y !== this.coords_.y) {\r\n\t\t\t// changed!\r\n\t\t\tconst tileMap = this.tileMap;\r\n\t\t\tif (this.coords_) {\r\n\t\t\t\tconst previousTile = tileMap[`${this.coords_.x}_${this.coords_.y}`];\r\n\t\t\t\tconst previousUniforms = previousTile.uniforms;\r\n\t\t\t\tgsap.to(previousUniforms, {\r\n\t\t\t\t\ttween: 0,\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tpreviousTile.material.uniforms.tween.value = previousUniforms.tween;\r\n\t\t\t\t\t\tpreviousTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tif (coords) {\r\n\t\t\t\tconst currentTile = this.currentTile = tileMap[`${coords.x}_${coords.y}`];\r\n\t\t\t\tconst currentUniforms = currentTile.uniforms;\r\n\t\t\t\tgsap.to(currentUniforms, {\r\n\t\t\t\t\ttween: 1,\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tcurrentTile.material.uniforms.tween.value = currentUniforms.tween;\r\n\t\t\t\t\t\tcurrentTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// console.log(currentTile, `${coords.x}_${coords.y}`);\r\n\t\t\t}\r\n\t\t\tthis.coords_ = coords;\r\n\t\t}\r\n\t}\r\n\r\n\tset coords__(coords) {\r\n\t\tif ((!coords && this.coords_ !== coords) || !this.coords_ || coords.x !== this.coords_.x || coords.y !== this.coords_.y) {\r\n\t\t\t// changed!\r\n\t\t\tconst tileMap = this.tileMap;\r\n\t\t\tif (this.coords_) {\r\n\t\t\t\tconst previousTile = tileMap[`${this.coords_.x}_${this.coords_.y}`];\r\n\t\t\t\tconst from = { tween: 1 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\ttween: 0,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tpreviousTile.material.opacity = from.tween;\r\n\t\t\t\t\t\t// previousTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\tif (coords) {\r\n\t\t\t\tconst currentTile = this.currentTile = tileMap[`${coords.x}_${coords.y}`];\r\n\t\t\t\tconst from = { tween: 0 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.4,\r\n\t\t\t\t\ttween: 1,\r\n\t\t\t\t\tdelay: 0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tcurrentTile.material.opacity = from.tween;\r\n\t\t\t\t\t\t// currentTile.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\t// console.log(currentTile, `${coords.x}_${coords.y}`);\r\n\t\t\t}\r\n\t\t\tthis.coords_ = coords;\r\n\t\t}\r\n\t}\r\n\r\n\tgetCoords(point) {\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst col = Math.ceil((point.x + outerTileSize / 2) / outerTileSize) - 1;\r\n\t\tconst row = Math.ceil((point.z + outerTileSize / 2) / outerTileSize) - 1;\r\n\t\tconst dx = Math.floor(ModelGridComponent.COLS / 2);\r\n\t\tconst dy = Math.floor(ModelGridComponent.ROWS / 2);\r\n\t\tconst ci = Math.min(dx, Math.abs(col)) * (col ? Math.abs(col) / col : 1);\r\n\t\tconst ri = Math.min(dy, Math.abs(row)) * (row ? Math.abs(row) / row : 1);\r\n\t\tif (this.view.hasTile(this.indices.x + ci, this.indices.y + ri)) {\r\n\t\t\t// console.log('col', col, 'row', row, 'ci', ci, 'ri', ri);\r\n\t\t\treturn new THREE.Vector2(ci, ri);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.indices = new THREE.Vector2();\r\n\t\t// console.log('ModelGridComponent.onInit', this.view);\r\n\t\tthis.view.index$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(index => {\r\n\t\t\tthis.moveToIndex(index);\r\n\t\t});\r\n\t}\r\n\r\n\taddTiles(mesh) {\r\n\t\t// console.log('addTiles');\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst innerTileSize = outerTileSize * 0.9;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(innerTileSize, innerTileSize, 2, 2);\r\n\t\tgeometry.rotateX(-Math.PI / 2);\r\n\t\tconst map = ModelGridComponent.getTexture();\r\n\t\tmap.disposable = false;\r\n\t\tmap.encoding = THREE.sRGBEncoding;\r\n\t\tconst mapOver = ModelGridComponent.getOverTexture();\r\n\t\tmapOver.disposable = false;\r\n\t\tmapOver.encoding = THREE.sRGBEncoding;\r\n\t\t// geometry.scale(-1, 1, 1);\r\n\t\tconst tileMap = this.tileMap = {};\r\n\t\tconst tiles = this.tiles = new Array(ModelGridComponent.COLS * ModelGridComponent.ROWS).fill(0).map((x, i) => {\r\n\t\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\tvertexShader: VERTEX_SHADER,\r\n\t\t\t\tfragmentShader: FRAGMENT_SHADER,\r\n\t\t\t\tuniforms: {\r\n\t\t\t\t\ttextureA: { type: \"t\", value: map },\r\n\t\t\t\t\ttextureB: { type: \"t\", value: mapOver },\r\n\t\t\t\t\ttween: { value: 0 },\r\n\t\t\t\t\topacity: { value: 0 },\r\n\t\t\t\t},\r\n\t\t\t\t// side: THREE.DoubleSide\r\n\t\t\t});\r\n\t\t\t/*\r\n\t\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\tmap: map,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\t// side: THREE.DoubleSide,\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tconst tile = new THREE.Mesh(geometry, material);\r\n\t\t\tconst dx = Math.floor(ModelGridComponent.COLS / 2);\r\n\t\t\tconst dy = Math.floor(ModelGridComponent.ROWS / 2);\r\n\t\t\tconst row = Math.floor(i / ModelGridComponent.COLS);\r\n\t\t\tconst col = i % ModelGridComponent.COLS;\r\n\t\t\tconst ci = -dx + col;\r\n\t\t\tconst ri = -dy + row;\r\n\t\t\t// console.log(ci, ri);\r\n\t\t\ttile.position.set(ci * outerTileSize, -ModelGridComponent.RADIUS * 0.15, ri * outerTileSize);\r\n\t\t\ttile.name = this.getName(`tile_${ci}_${ri}`);\r\n\t\t\tconst uniforms = tile.uniforms = {\r\n\t\t\t\ttween: 0,\r\n\t\t\t\topacity: 0,\r\n\t\t\t\tci: ci,\r\n\t\t\t\tri: ri,\r\n\t\t\t};\r\n\t\t\ttileMap[`${ci}_${ri}`] = tile;\r\n\t\t\tmesh.add(tile);\r\n\t\t\treturn tile;\r\n\t\t});\r\n\t\tthis.showTiles();\r\n\t}\r\n\r\n\tshowTiles() {\r\n\t\tthis.tiles.forEach((tile, i) => {\r\n\t\t\tconst ix = this.indices ? this.indices.x : 0;\r\n\t\t\tconst iy = this.indices ? this.indices.y : 0;\r\n\t\t\tconst visible = this.view.hasTile(ix + tile.uniforms.ci, iy + tile.uniforms.ri);\r\n\t\t\tconst uniforms = tile.uniforms;\r\n\t\t\tgsap.to(uniforms, {\r\n\t\t\t\topacity: visible ? 1 : 0,\r\n\t\t\t\tduration: 0.4,\r\n\t\t\t\t// delay: 0 + i * 0.02,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\ttile.material.uniforms.opacity.value = uniforms.opacity;\r\n\t\t\t\t\ttile.material.needsUpdate = true;\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\taddHitArea(mesh) {\r\n\t\tthis.onGroundOver = this.onGroundOver.bind(this);\r\n\t\tthis.onGroundMove = this.onGroundMove.bind(this);\r\n\t\tthis.onGroundDown = this.onGroundDown.bind(this);\r\n\t\tthis.onGroundOut = this.onGroundOut.bind(this);\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tconst innerTileSize = outerTileSize * 0.9;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(ModelGridComponent.RADIUS, ModelGridComponent.RADIUS, 20, 20);\r\n\t\tgeometry.rotateX(-Math.PI / 2);\r\n\t\t// geometry.scale(-1, 1, 1);\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst ground = this.ground = new InteractiveMesh(geometry, material);\r\n\t\tground.name = this.getName('ground');\r\n\t\tground.position.set(0, -ModelGridComponent.RADIUS * 0.15, 0);\r\n\t\tground.on('over', this.onGroundOver);\r\n\t\tground.on('move', this.onGroundMove);\r\n\t\tground.on('out', this.onGroundOut);\r\n\t\tground.on('down', this.onGroundDown);\r\n\t\tmesh.add(ground);\r\n\t}\r\n\r\n\tonGroundOver() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t}\r\n\r\n\tonGroundMove() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t}\r\n\r\n\tonGroundDown() {\r\n\t\tconst ground = this.ground;\r\n\t\tconst coords = this.getCoords(ground.intersection.point);\r\n\t\tthis.coords = coords;\r\n\t\tif (coords) {\r\n\t\t\tconst index = this.view.getTileIndex(this.indices.x + coords.x, this.indices.y + coords.y);\r\n\t\t\tthis.view.index = index;\r\n\t\t\tthis.nav.next(index);\r\n\t\t\t/*\r\n\t\t\tthis.indices.x += coords.x;\r\n\t\t\tthis.indices.y += coords.y;\r\n\t\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\t\tthis.move.next({\r\n\t\t\t\tindices: this.indices,\r\n\t\t\t\tcoords,\r\n\t\t\t\tposition: coords.clone().multiplyScalar(outerTileSize)\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t}\r\n\t}\r\n\r\n\tonGroundOut() {\r\n\t\tthis.coords = null;\r\n\t}\r\n\r\n\tmoveToIndex(index) {\r\n\t\t// console.log('ModelGridComponent.moveToIndex', index);\r\n\t\tthis.coords = null;\r\n\t\tconst tile = this.view.tiles[index];\r\n\t\tconst coords = new THREE.Vector2(tile.indices.x - this.indices.x, tile.indices.y - this.indices.y);\r\n\t\tthis.indices.x = tile.indices.x;\r\n\t\tthis.indices.y = tile.indices.y;\r\n\t\tthis.showTiles();\r\n\t\tconst outerTileSize = ModelGridComponent.RADIUS / 10; // assume room is 20m x 20m\r\n\t\tthis.move.next({\r\n\t\t\tindices: this.indices,\r\n\t\t\tcoords,\r\n\t\t\tposition: coords.clone().multiplyScalar(outerTileSize)\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.tile;\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tthis.addTiles(mesh);\r\n\t\tthis.addHitArea(mesh);\r\n\t\t/*\r\n\t\tmesh.userData = {\r\n\t\t\trender: () => {\r\n\r\n\t\t\t}\r\n\t\t};\r\n\t\t*/\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tconst ground = this.ground;\r\n\t\tground.off('over', this.onGroundOver);\r\n\t\tground.off('move', this.onGroundMove);\r\n\t\tground.off('down', this.onGroundDown);\r\n\t\tground.off('out', this.onGroundOut);\r\n\t}\r\n\r\n}\r\n\r\nModelGridComponent.ORIGIN = new THREE.Vector3();\r\nModelGridComponent.RADIUS = 101;\r\nModelGridComponent.COLS = 11;\r\nModelGridComponent.ROWS = 11;\r\n\r\nModelGridComponent.meta = {\r\n\tselector: '[model-grid]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['move', 'nav'],\r\n\tinputs: ['view'],\r\n};\r\n","import { getContext } from 'rxcomp';\r\nimport { of } from 'rxjs';\r\nimport { first, takeUntil } from 'rxjs/operators';\r\nimport { MessageType } from '../../agora/agora.types';\r\nimport MenuService from '../../editor/menu/menu.service';\r\nimport { environment } from '../../environment';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport MessageService from '../../message/message.service';\r\nimport StateService from '../../state/state.service';\r\n// import DebugService from '../debug.service';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport OrbitService, { OrbitMode } from '../orbit/orbit';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport class MenuButton extends InteractiveMesh {\r\n\r\n\tstatic getGrid(total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\treturn [rows, cols];\r\n\t}\r\n\r\n\tstatic getX(index, total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\tconst c = index % cols;\r\n\t\tconst w = (1 / MenuButton.W * (MenuButton.W + MenuButton.G));\r\n\t\treturn (w / 2 - cols * w / 2) + c * w;\r\n\t}\r\n\r\n\tstatic getY(index, total) {\r\n\t\tconst cols = Math.ceil(total / MenuButton.ROWS);\r\n\t\tconst rows = Math.ceil(total / cols);\r\n\t\tconst c = index % cols;\r\n\t\tconst r = Math.floor(index / cols);\r\n\t\tconst h = (1 / MenuButton.W * (MenuButton.H + MenuButton.G));\r\n\t\treturn (rows * h / 2 - h / 2) + r * -h; // y flipped\r\n\t}\r\n\r\n\tstatic get geometry() {\r\n\t\tif (this.geometry_) {\r\n\t\t\treturn this.geometry_;\r\n\t\t}\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(1, 1 / MenuButton.W * MenuButton.H, 2, 2);\r\n\t\t// geometry.rotateX(-Math.PI);\r\n\t\t// geometry.scale(-1, 1, 1);\r\n\t\tthis.geometry_ = geometry;\r\n\t\treturn geometry;\r\n\t}\r\n\r\n\tstatic get material() {\r\n\t\tconst material = new THREE.ShaderMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tvertexShader: ModelMenuComponent.VERTEX_SHADER,\r\n\t\t\tfragmentShader: ModelMenuComponent.FRAGMENT_SHADER,\r\n\t\t\tuniforms: {\r\n\t\t\t\ttextureA: { type: \"t\", value: null },\r\n\t\t\t\ttextureB: { type: \"t\", value: null },\r\n\t\t\t\tresolutionA: { value: new THREE.Vector2() },\r\n\t\t\t\tresolutionB: { value: new THREE.Vector2() },\r\n\t\t\t\ttween: { value: 0 },\r\n\t\t\t\topacity: { value: 0 },\r\n\t\t\t},\r\n\t\t});\r\n\t\t/*\r\n\t\tconst material = new THREE.MeshBasicMaterial({\r\n\t\t\t// depthTest: false,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.8,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\t*/\r\n\t\treturn material;\r\n\t}\r\n\r\n\tconstructor(item, index, total) {\r\n\t\tconst geometry = MenuButton.geometry;\r\n\t\tconst material = MenuButton.material;\r\n\t\tsuper(geometry, material);\r\n\t\t// this.userData.item = item;\r\n\t\t// this.userData.index = index;\r\n\t\tthis.renderOrder = environment.renderOrder.menu;\r\n\t\tthis.name = item.name;\r\n\t\tthis.item = item;\r\n\t\tthis.index = index;\r\n\t\tthis.total = total;\r\n\t\tthis.tween = 0;\r\n\t\tthis.opacity = 0;\r\n\t\tconst textureA = this.textureA = this.getTextureA(item.name);\r\n\t\t// material.map = textureA;\r\n\t\tmaterial.uniforms.textureA.value = textureA;\r\n\t\tmaterial.uniforms.resolutionA.value = new THREE.Vector2(textureA.width, textureA.height);\r\n\t\tconst textureB = this.textureB = this.getTextureB(item.name);\r\n\t\t// material.map = textureB;\r\n\t\tmaterial.uniforms.textureB.value = textureB;\r\n\t\tmaterial.uniforms.resolutionA.value = new THREE.Vector2(textureB.width, textureB.height);\r\n\t\tmaterial.uniforms.tween.value = this.tween;\r\n\t\tmaterial.uniforms.opacity.value = this.opacity;\r\n\t\tmaterial.needsUpdate = true;\r\n\t\tthis.position.set(MenuButton.getX(index, total), MenuButton.getY(index, total), 0);\r\n\t\tthis.onOver = this.onOver.bind(this);\r\n\t\tthis.onOut = this.onOut.bind(this);\r\n\t}\r\n\r\n\tgetTextureA(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tgetTextureB(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuOverBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuOverForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tonOver() {\r\n\t\t// DebugService.getService().setMessage('over ' + this.name);\r\n\t\tgsap.to(this, {\r\n\t\t\tduration: 0.4,\r\n\t\t\ttween: 1,\r\n\t\t\tease: Power2.easeOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.position.z = 0.1 * this.tween;\r\n\t\t\t\tthis.material.uniforms.tween.value = this.tween;\r\n\t\t\t\tthis.material.needsUpdate = true;\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\tonOut() {\r\n\t\tgsap.to(this, {\r\n\t\t\tduration: 0.4,\r\n\t\t\ttween: 0,\r\n\t\t\tease: Power2.easeOut,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.position.z = 0.1 * this.tween;\r\n\t\t\t\tthis.material.uniforms.tween.value = this.tween;\r\n\t\t\t\tthis.material.needsUpdate = true;\r\n\t\t\t},\r\n\t\t});\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tInteractive.dispose(this);\r\n\t\tthis.textureA.dispose();\r\n\t\tthis.textureB.dispose();\r\n\t\tthis.material.dispose();\r\n\t\tthis.geometry.dispose();\r\n\t}\r\n}\r\n\r\nMenuButton.W = 256;\r\nMenuButton.H = 64;\r\nMenuButton.G = 2;\r\nMenuButton.ROWS = 6;\r\n\r\nexport class BackButton extends MenuButton {\r\n\r\n\tconstructor(item, index, total) {\r\n\t\tsuper(item, index, total);\r\n\t}\r\n\r\n\tgetTextureA(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuBackForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.minFilter = THREE.LinearFilter;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.mapping = THREE.UVMapping;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tgetTextureB(text) {\r\n\t\tconst w = MenuButton.W;\r\n\t\tconst h = MenuButton.H;\r\n\t\tconst canvas = document.createElement('canvas');\r\n\t\tcanvas.width = w;\r\n\t\tcanvas.height = h;\r\n\t\tconst ctx = canvas.getContext('2d');\r\n\t\tctx.fillStyle = environment.colors.menuBackOverBackground;\r\n\t\tctx.fillRect(0, 0, w, h);\r\n\t\tctx.font = `20px ${environment.fontFamily}`;\r\n\t\tctx.fillStyle = environment.colors.menuBackOverForeground;\r\n\t\tctx.fillText(text, 10, 50, w - 20);\r\n\t\tconst texture = new THREE.CanvasTexture(canvas);\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\ttexture.magFilter = THREE.LinearFilter;\r\n\t\ttexture.needsUpdate = true;\r\n\t\treturn texture;\r\n\t}\r\n}\r\n\r\nexport default class ModelMenuComponent extends ModelComponent {\r\n\r\n\tget loading() {\r\n\t\treturn this.loading_;\r\n\t}\r\n\tset loading(loading) {\r\n\t\tif (this.loading_ !== loading) {\r\n\t\t\tthis.loading_ = loading;\r\n\t\t\tconst { node } = getContext(this);\r\n\t\t\tconst btn = node.querySelector('.btn--menu');\r\n\t\t\tbtn.classList.toggle('loading', loading);\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.onDown = this.onDown.bind(this);\r\n\t\tthis.onToggle = this.onToggle.bind(this);\r\n\t\t// console.log('ModelMenuComponent.onInit');\r\n\t\t/*\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => {\r\n\t\t\tif (session) {\r\n\t\t\t\tthis.addToggler();\r\n\t\t\t} else {\r\n\t\t\t\tthis.removeMenu();\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t\tLoaderService.progress$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(progress => this.loading = progress.count > 0);\r\n\t\tMessageService.in$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe(message => {\r\n\t\t\t// DebugService.getService().setMessage('ModelMenuComponent.MessageService ' + message.type);\r\n\t\t\tswitch (message.type) {\r\n\t\t\t\tcase MessageType.MenuToggle:\r\n\t\t\t\t\tthis.onToggle();\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\t// this.buildMenu();\r\n\t}\r\n\r\n\tbuildMenu() {\r\n\t\tif (!this.items) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMenuService.getModelMenu$(this.items, this.editor).pipe(\r\n\t\t\tfirst(),\r\n\t\t).subscribe(menu => this.groups = menu);\r\n\t\t/*\r\n\t\tconst menu = {};\r\n\t\tthis.items.forEach(item => {\r\n\t\t\tif (item.type.name !== ViewType.WaitingRoom.name && (!item.hidden || this.editor)) {\r\n\t\t\t\tlet group = menu[item.type.name];\r\n\t\t\t\tif (!group) {\r\n\t\t\t\t\tgroup = menu[item.type.name] = [];\r\n\t\t\t\t}\r\n\t\t\t\tgroup.push(item);\r\n\t\t\t}\r\n\t\t});\r\n\t\tthis.groups = Object.keys(menu).map(typeName => {\r\n\t\t\tlet name = 'Button';\r\n\t\t\tswitch (typeName) {\r\n\t\t\t\tcase ViewType.WaitingRoom.name:\r\n\t\t\t\t\tname = 'Waiting Room';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Panorama.name:\r\n\t\t\t\t\tname = 'Experience';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.PanoramaGrid.name:\r\n\t\t\t\t\tname = 'Virtual Tour';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Room3d.name:\r\n\t\t\t\t\tname = 'Stanze 3D';\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase ViewType.Model.name:\r\n\t\t\t\t\tname = 'Modelli 3D';\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\treturn { name, type: { name: 'menu-group' }, items: this.items.filter(x => x.type.name === typeName && (!x.hidden || this.editor)) };\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tif (this.buttons) {\r\n\t\t\tthis.buttons.forEach(x => Interactive.dispose(x));\r\n\t\t}\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\tgetContainer() {\r\n\t\treturn this.host.cameraGroup;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.menu;\r\n\t\tconst menuGroup = this.menuGroup = new THREE.Group();\r\n\t\t// menuGroup.lookAt(ModelMenuComponent.ORIGIN);\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(menuGroup);\r\n\t\t}\r\n\t}\r\n\r\n\trender(time, tick) {\r\n\t\tconst group = this.group;\r\n\t\tlet camera = this.host.camera;\r\n\t\tconst position = this.position;\r\n\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\tcamera = this.host.renderer.xr.getCamera(camera);\r\n\t\t\tcamera.getWorldDirection(position);\r\n\t\t\tposition.y += 0.5;\r\n\t\t\tposition.multiplyScalar(3);\r\n\t\t\tthis.host.cameraGroup.worldToLocal(position);\r\n\t\t\tposition.y += this.host.cameraGroup.position.y;\r\n\t\t\tgroup.position.copy(position);\r\n\t\t\tgroup.scale.set(1, 1, 1);\r\n\t\t\tgroup.lookAt(camera.position);\r\n\t\t\t// group.lookAt(ModelMenuComponent.ORIGIN);\r\n\t\t} else {\r\n\t\t\tcamera.getWorldDirection(position);\r\n\t\t\tif (OrbitService.mode === OrbitMode.Model) {\r\n\t\t\t\tposition.multiplyScalar(0.01);\r\n\t\t\t} else {\r\n\t\t\t\tposition.multiplyScalar(3);\r\n\t\t\t}\r\n\t\t\tgroup.position.copy(position);\r\n\t\t\tconst s = 1 / camera.zoom;\r\n\t\t\tgroup.scale.set(s, s, s);\r\n\t\t\tgroup.lookAt(ModelMenuComponent.ORIGIN);\r\n\t\t}\r\n\t}\r\n\r\n\titems$(item = null) {\r\n\t\tif (item) {\r\n\t\t\treturn of(item.items);\r\n\t\t} else {\r\n\t\t\treturn MenuService.getModelMenu$(this.items, this.editor).pipe(\r\n\t\t\t\tfirst(),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\taddMenu(item = null) {\r\n\t\tthis.removeMenu();\r\n\t\t// nav to view\r\n\t\tif (item && item.type.name !== 'menu-group') {\r\n\t\t\t/*\r\n\t\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\t\tthis.addToggler();\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.nav.next(item);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tMenuService.active = true;\r\n\t\tthis.items$(item).subscribe(items => {\r\n\t\t\tif (items) {\r\n\t\t\t\titems = items.slice();\r\n\t\t\t\tconst back = {\r\n\t\t\t\t\ttype: { name: 'back' },\r\n\t\t\t\t\tname: item ? 'Back' : 'Close',\r\n\t\t\t\t\tbackItem: item,\r\n\t\t\t\t};\r\n\t\t\t\titems.push(back);\r\n\t\t\t\tconst buttons = this.buttons = items.map((x, i, a) => {\r\n\t\t\t\t\tx.backItem = item;\r\n\t\t\t\t\treturn (x.type.name === 'back') ? new BackButton(x, i, a.length) : new MenuButton(x, i, a.length);\r\n\t\t\t\t});\r\n\t\t\t\tbuttons.forEach(button => {\r\n\t\t\t\t\tbutton.depthTest = false;\r\n\t\t\t\t\tbutton.on('over', button.onOver);\r\n\t\t\t\t\tbutton.on('out', button.onOut);\r\n\t\t\t\t\tbutton.on('down', this.onDown);\r\n\t\t\t\t\tthis.menuGroup.add(button);\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tvar box = new THREE.BoxHelper(button, 0xffff00);\r\n\t\t\t\t\tthis.host.scene.add(box);\r\n\t\t\t\t\t*/\r\n\t\t\t\t});\r\n\t\t\t\tgsap.to(buttons, {\r\n\t\t\t\t\tduration: 0.3,\r\n\t\t\t\t\topacity: 0.8,\r\n\t\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\t\tstagger: {\r\n\t\t\t\t\t\tgrid: MenuButton.getGrid(buttons.length),\r\n\t\t\t\t\t\tfrom: 0, // index\r\n\t\t\t\t\t\tamount: 0.02 * buttons.length\r\n\t\t\t\t\t},\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tbuttons.forEach(button => {\r\n\t\t\t\t\t\t\tbutton.material.uniforms.opacity.value = (button.opacity * (button.item.hidden ? 0.5 : 1));\r\n\t\t\t\t\t\t\t// button.material.needsUpdate = true;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tremoveMenu() {\r\n\t\tMenuService.active = false;\r\n\t\tthis.removeButtons();\r\n\t\tthis.removeToggler();\r\n\t}\r\n\r\n\tremoveButtons() {\r\n\t\tconst buttons = this.buttons;\r\n\t\tif (buttons) {\r\n\t\t\tbuttons.forEach(button => {\r\n\t\t\t\tthis.menuGroup.remove(button);\r\n\t\t\t\tbutton.off('over', button.onOver);\r\n\t\t\t\tbutton.off('out', button.onOut);\r\n\t\t\t\tbutton.off('down', this.onDown);\r\n\t\t\t\tbutton.dispose();\r\n\t\t\t});\r\n\t\t}\r\n\t\tthis.buttons = null;\r\n\t}\r\n\r\n\taddToggler() {\r\n\t\tthis.removeMenu();\r\n\t\tconst toggler = this.toggler = new MenuButton({\r\n\t\t\ttype: { name: 'menu' },\r\n\t\t\tname: 'Menu'\r\n\t\t}, 0, 1);\r\n\t\t// toggler.position.y = -0.5;\r\n\t\ttoggler.opacity = 0.8;\r\n\t\ttoggler.material.uniforms.opacity.value = toggler.opacity;\r\n\t\ttoggler.material.needsUpdate = true;\r\n\t\ttoggler.on('over', toggler.onOver);\r\n\t\ttoggler.on('out', toggler.onOut);\r\n\t\ttoggler.on('down', this.onToggle);\r\n\t\tthis.menuGroup.add(toggler);\r\n\t}\r\n\r\n\tremoveToggler() {\r\n\t\tconst toggler = this.toggler;\r\n\t\tif (toggler) {\r\n\t\t\tthis.menuGroup.remove(toggler);\r\n\t\t\ttoggler.off('over', toggler.onOver);\r\n\t\t\ttoggler.off('out', toggler.onOut);\r\n\t\t\ttoggler.off('down', this.onToggle);\r\n\t\t\ttoggler.dispose();\r\n\t\t}\r\n\t\tthis.toggler = null;\r\n\t}\r\n\r\n\tonDown(button) {\r\n\t\t// this.down.next(this.item);\r\n\t\tif (button.item && button.item.type.name === 'back') {\r\n\t\t\tthis.removeMenu();\r\n\t\t\tif (button.item.backItem) {\r\n\t\t\t\tthis.addMenu(button.item.backItem.backItem);\r\n\t\t\t} else {\r\n\t\t\t\t/*\r\n\t\t\t\tif (this.host.renderer.xr.isPresenting) {\r\n\t\t\t\t\tthis.addToggler();\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tthis.toggle.next();\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis.addMenu(button.item);\r\n\t\t}\r\n\t}\r\n\r\n\tonToggle() {\r\n\t\tif (StateService.state.locked || StateService.state.spying) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (MenuService.active) {\r\n\t\t\tthis.removeMenu();\r\n\t\t\tthis.toggle.next();\r\n\t\t} else {\r\n\t\t\tthis.addMenu();\r\n\t\t\tthis.toggle.next(this);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nModelMenuComponent.ORIGIN = new THREE.Vector3();\r\nModelMenuComponent.VERTEX_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nvoid main() {\r\n\tvUv = uv;\r\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\r\n}\r\n`;\r\nModelMenuComponent.FRAGMENT_SHADER = `\r\n#extension GL_EXT_frag_depth : enable\r\n\r\nvarying vec2 vUv;\r\nuniform float opacity;\r\nuniform float tween;\r\nuniform sampler2D textureA;\r\nuniform sampler2D textureB;\r\nuniform vec2 resolutionA;\r\nuniform vec2 resolutionB;\r\n\r\nvoid main() {\r\n\tvec4 colorA = texture2D(textureA, vUv);\r\n\tvec4 colorB = texture2D(textureB, vUv);\r\n\tvec4 color = vec4(mix(colorA.rgb, colorB.rgb, tween), opacity);\r\n\tgl_FragColor = color;\r\n}\r\n`;\r\n\r\nModelMenuComponent.meta = {\r\n\tselector: '[model-menu]',\r\n\thosts: { host: WorldComponent },\r\n\t// outputs: ['over', 'out', 'down', 'nav'],\r\n\toutputs: ['nav', 'toggle'],\r\n\tinputs: ['items', 'editor'],\r\n};\r\n","// import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\r\nimport { takeUntil } from 'rxjs/operators';\r\nimport MenuService from '../../editor/menu/menu.service';\r\nimport { environment } from '../../environment';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport { ViewType } from '../../view/view';\r\nimport EmittableMesh from '../interactive/emittable.mesh';\r\nimport FreezableMesh from '../interactive/freezable.mesh';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport default class ModelModelComponent extends ModelEditableComponent {\r\n\r\n\t/*\r\n\tstatic getInteractiveGeometry() {\r\n\t\treturn ModelModelComponent.interactiveGeometry || (ModelModelComponent.interactiveGeometry = new THREE.SphereBufferGeometry(1, 8, 8));\r\n\t}\r\n\t*/\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\tset freezed(freezed) {\r\n\t\tif (this.freezed_ !== freezed) {\r\n\t\t\tthis.freezed_ = freezed;\r\n\t\t\tconst mesh = this.mesh;\r\n\t\t\tif (mesh) {\r\n\t\t\t\tmesh.traverse((child) => {\r\n\t\t\t\t\tif (child.isInteractiveMesh) {\r\n\t\t\t\t\t\tchild.freezed = freezed;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.progress = null;\r\n\t\tthis.isPresenting = false;\r\n\t\t/*\r\n\t\tif (this.view.type.name === ViewType.Model.name) {\r\n\t\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\t\tvrService.session$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t\t).subscribe((session) => {\r\n\t\t\t\tthis.onUpdateVRSession(session);\r\n\t\t\t});\r\n\t\t}\r\n\t\t*/\r\n\t\tMenuService.active$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe(active => this.freezed = active);\r\n\t\t// console.log('ModelModelComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.model;\r\n\t\tthis.loadGlb(environment.getPath(this.item.asset.folder), this.item.asset.file, (mesh, animations) => {\r\n\t\t\tthis.onGlbLoaded(mesh, animations, mount, dismount);\r\n\t\t});\r\n\t}\r\n\r\n\tloadGlb(path, file, callback) {\r\n\t\tconst renderer = this.host.renderer;\r\n\t\t// const roughnessMipmapper = new RoughnessMipmapper(renderer); // optional\r\n\t\tconst progressRef = LoaderService.getRef();\r\n\t\t// console.log('progressRef');\r\n\t\tconst loader = new THREE.GLTFLoader().setPath(path);\r\n\t\t// Optional: Provide a DRACOLoader instance to decode compressed mesh data\r\n\t\tconst decoderPath = `${environment.assets}js/draco/`;\r\n\t\t// console.log(decoderPath);\r\n\t\tconst dracoLoader = new THREE.DRACOLoader();\r\n\t\tdracoLoader.setDecoderPath(decoderPath);\r\n\t\tloader.setDRACOLoader(dracoLoader);\r\n\t\tloader.load(file, (glb) => {\r\n\t\t\t/*\r\n\t\t\tglb.scene.traverse((child) => {\r\n\t\t\t\tif (child.isMesh) {\r\n\t\t\t\t\t// roughnessMipmapper.generateMipmaps(child.material);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(glb.scene, glb.animations);\r\n\t\t\t}\r\n\t\t\tLoaderService.setProgress(progressRef, 1);\r\n\t\t\t// this.progress = null;\r\n\t\t\t// this.pushChanges();\r\n\t\t\t// roughnessMipmapper.dispose();\r\n\t\t}, (progressEvent) => {\r\n\t\t\t/*\r\n\t\t\tlet value = this.progress ? this.progress.value : 0;\r\n\t\t\tif (progressEvent.lengthComputable) {\r\n\t\t\t\tvalue = Math.round(progressEvent.loaded / progressEvent.total * 100);\r\n\t\t\t} else {\r\n\t\t\t\tvalue = Math.floor(Math.min(100, value + 0.1));\r\n\t\t\t}\r\n\t\t\tthis.progress = { value, title: `${value}%` };\r\n\t\t\t// console.log('progressEvent', progressEvent.loaded, progressEvent.total);\r\n\t\t\tthis.pushChanges();\r\n\t\t\t*/\r\n\t\t\tLoaderService.setProgress(progressRef, progressEvent.loaded, progressEvent.total);\r\n\t\t});\r\n\t}\r\n\r\n\tparseAnimations(mesh, animations) {\r\n\t\t// animations\r\n\t\t// console.log('ModelModelComponent.onGlbLoaded', 'animations', animations);\r\n\t\tconst actionIndex = this.actionIndex = -1;\r\n\t\tconst actions = this.actions = [];\r\n\t\tif (animations && animations.length) {\r\n\t\t\tconst clock = this.clock = new THREE.Clock();\r\n\t\t\tconst mixer = this.mixer = new THREE.AnimationMixer(mesh);\r\n\t\t\tmixer.timeScale = 1;\r\n\t\t\tanimations.forEach(animation => {\r\n\t\t\t\tconst action = mixer.clipAction(animation);\r\n\t\t\t\taction.enabled = true;\r\n\t\t\t\taction.setEffectiveTimeScale(1);\r\n\t\t\t\taction.setEffectiveWeight(1);\r\n\t\t\t\t// action.setLoop(THREE.LoopPingPong);\r\n\t\t\t\taction.setLoop(THREE.LoopRepeat);\r\n\t\t\t\t// action.clampWhenFinished = true; // pause on last frame\r\n\t\t\t\tactions.push(action);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tonClipToggle() {\r\n\t\tconst actions = this.actions;\r\n\t\tif (actions.length === 1) {\r\n\t\t\tconst action = actions[0];\r\n\t\t\tif (this.actionIndex === -1) {\r\n\t\t\t\tthis.actionIndex = 0;\r\n\t\t\t\tif (action.paused || action.timeScale === 0) {\r\n\t\t\t\t\taction.paused = false;\r\n\t\t\t\t} else {\r\n\t\t\t\t\taction.play();\r\n\t\t\t\t}\r\n\t\t\t} else if (this.actionIndex === 0) {\r\n\t\t\t\tthis.actionIndex = -1;\r\n\t\t\t\taction.halt(0.3);\r\n\t\t\t}\r\n\t\t} else if (actions.length > 1) {\r\n\t\t\tif (this.actionIndex > -1 && this.actionIndex < actions.length) {\r\n\t\t\t\tconst previousClip = actions[this.actionIndex];\r\n\t\t\t\tpreviousClip.halt(0.3);\r\n\t\t\t}\r\n\t\t\tthis.actionIndex ++;\r\n\t\t\tif (this.actionIndex === actions.length) {\r\n\t\t\t\tthis.actionIndex = -1;\r\n\t\t\t\t// nothing\r\n\t\t\t} else {\r\n\t\t\t\tconst action = actions[this.actionIndex];\r\n\t\t\t\t// console.log(this.actionIndex, action);\r\n\t\t\t\tif (action.paused) {\r\n\t\t\t\t\taction.paused = false;\r\n\t\t\t\t}\r\n\t\t\t\tif (action.timeScale === 0) {\r\n\t\t\t\t\taction.timeScale = 1;\r\n\t\t\t\t}\r\n\t\t\t\taction.play();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonGlbLoaded(mesh, animations, mount, dismount) {\r\n\t\t// animations\r\n\t\tthis.parseAnimations(mesh, animations);\r\n\t\t// scale\r\n\t\tconst box = new THREE.Box3().setFromObject(mesh);\r\n\t\tconst size = box.max.clone().sub(box.min);\r\n\t\tconst max = Math.max(size.x, size.y, size.z);\r\n\t\tconst scale = 2 / max; //1.7\r\n\t\tmesh.scale.set(scale, scale, scale);\r\n\t\t// repos\r\n\t\tlet dummy;\r\n\t\tconst view = this.view;\r\n\t\tconst item = this.item;\r\n\t\tif (view.type.name === ViewType.Model.name) {\r\n\t\t\t// this.onUpdateVRSession(this.vrService.currentSession);\r\n\t\t\tdummy = new THREE.Group();\r\n\t\t\tdummy.add(mesh);\r\n\t\t\tbox.setFromObject(dummy);\r\n\t\t\tconst center = box.getCenter(new THREE.Vector3());\r\n\t\t\tdummy.position.set(\r\n\t\t\t\tmesh.position.x - center.x,\r\n\t\t\t\tmesh.position.y - center.y,\r\n\t\t\t\tmesh.position.z - center.z + (this.host.renderer.xr.isPresenting ? -2 : 0),\r\n\t\t\t\t// mesh.position.z - center.z,\r\n\t\t\t);\r\n\t\t\tconst endY = dummy.position.y;\r\n\t\t\tconst from = { tween: 1 };\r\n\t\t\tconst onUpdate = () => {\r\n\t\t\t\tdummy.position.y = endY + 3 * from.tween;\r\n\t\t\t\tdummy.rotation.y = 0 + Math.PI * from.tween;\r\n\t\t\t};\r\n\t\t\tonUpdate();\r\n\t\t\tthis.makeInteractive(mesh);\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 1.5,\r\n\t\t\t\ttween: 0,\r\n\t\t\t\tdelay: 0.1,\r\n\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\tonUpdate: onUpdate,\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\tthis.updateHelper();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tbox.setFromObject(mesh);\r\n\t\t\tconst center = box.getCenter(new THREE.Vector3());\r\n\t\t\tmesh.position.set(\r\n\t\t\t\t- center.x,\r\n\t\t\t\t- center.y,\r\n\t\t\t\t- center.z,\r\n\t\t\t);\r\n\t\t\tdummy = new THREE.Group();\r\n\t\t\tdummy.add(mesh);\r\n\t\t\tif (item.position) {\r\n\t\t\t\tdummy.position.fromArray(item.position);\r\n\t\t\t}\r\n\t\t\tif (item.rotation) {\r\n\t\t\t\tdummy.rotation.fromArray(item.rotation);\r\n\t\t\t}\r\n\t\t\tif (item.scale) {\r\n\t\t\t\tdummy.scale.fromArray(item.scale);\r\n\t\t\t}\r\n\t\t\tthis.makeInteractive(mesh);\r\n\t\t\t/*\r\n\t\t\tconst geometry = ModelModelComponent.getInteractiveGeometry();\r\n\t\t\tconst sphere = new InteractiveMesh(geometry, new THREE.MeshBasicMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\t// wireframe: true,\r\n\t\t\t\t// opacity: 1.0,\r\n\t\t\t\topacity: 0.0,\r\n\t\t\t\tcolor: 0x00ffff,\r\n\t\t\t}));\r\n\t\t\tconst radius = max * scale / 1.7;\r\n\t\t\tsphere.scale.set(radius, radius, radius);\r\n\t\t\tsphere.name = `[model] ${this.item.id}`;\r\n\t\t\t// sphere.depthTest = false;\r\n\t\t\tsphere.renderOrder = 0;\r\n\t\t\tdummy.add(sphere);\r\n\t\t\tsphere.on('down', () => {\r\n\t\t\t\t// console.log('ModelModelComponent.down');\r\n\t\t\t\tthis.down.next(this);\r\n\t\t\t});\r\n\t\t\t*/\r\n\t\t\tthis.updateHelper();\r\n\t\t}\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(dummy, this.item);\r\n\t\t\tthis.freezed = MenuService.active;\r\n\t\t}\r\n\t\t/*\r\n\t\tthis.progress = null;\r\n\t\tthis.pushChanges();\r\n\t\t*/\r\n\t}\r\n\r\n\t/*\r\n\tonUpdateVRSession(session) {\r\n\t\tconst mesh = this.mesh;\r\n\t\tif (session && mesh) {\r\n\t\t\tmesh.position.z = -2;\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n\trender(time, tick) {\r\n\t\tconst view = this.view;\r\n\t\tconst item = this.item;\r\n\t\tconst mesh = this.mesh;\r\n\t\tconst isPresenting = this.host.renderer.xr.isPresenting;\r\n\t\tconst group = this.group;\r\n\t\tif (mesh) {\r\n\t\t\tif (view.type.name === ViewType.Model.name) {\r\n\t\t\t\tif (this.isPresenting !== isPresenting) {\r\n\t\t\t\t\tthis.isPresenting = isPresenting;\r\n\t\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\t\tmesh.position.x = 0;\r\n\t\t\t\t\t\tmesh.position.y = 0;\r\n\t\t\t\t\t\tmesh.position.z = -2;\r\n\t\t\t\t\t\tmesh.rotation.y = 0;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tmesh.position.x = 0;\r\n\t\t\t\t\t\tmesh.position.y = 0;\r\n\t\t\t\t\t\tmesh.position.z = 0;\r\n\t\t\t\t\t\tmesh.rotation.y = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\tmesh.rotation.y -= (Math.PI / 180 / 60 * 5);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (isPresenting) {\r\n\t\t\t\t\tmesh.rotation.y -= (Math.PI / 180 / 60 * 5);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tconst mixer = this.mixer;\r\n\t\tconst clock = this.clock;\r\n\t\tif (mixer) {\r\n\t\t\tconst delta = clock.getDelta();\r\n\t\t\tmixer.update(delta);\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelModelComponent.onUpdate', item);\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tif (item.position) {\r\n\t\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\t}\r\n\t\t\tif (item.rotation) {\r\n\t\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t\t}\r\n\t\t\tif (item.scale) {\r\n\t\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelModelComponent.onUpdateAsset', item);\r\n\t\tthis.loadGlb(environment.getPath(item.asset.folder), item.asset.file, (mesh, animations) => {\r\n\t\t\tthis.onGlbLoaded(mesh, animations, (mesh, item) => this.onMount(mesh, item), (mesh, item) => this.onDismount(mesh, item));\r\n\t\t});\r\n\t\t/*\r\n\t\tthis.mesh.updateByItem(item);\r\n\t\tthis.mesh.load(() => {\r\n\t\t\t// console.log('ModelModelComponent.mesh.load.complete');\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\t// console.log('ModelModelComponent.onDragMove', position);\r\n\t\tthis.editing = true;\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(4);\r\n\t\t\t// this.mesh.lookAt(ModelModelComponent.ORIGIN);\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\t// console.log('ModelModelComponent.onDragEnd');\r\n\t\tconst view = this.view;\r\n\t\tif (view.type.name !== ViewType.Model.name) {\r\n\t\t\tthis.item.position = this.mesh.position.toArray();\r\n\t\t\tthis.item.rotation = this.mesh.rotation.toArray();\r\n\t\t\tthis.item.scale = this.mesh.scale.toArray();\r\n\t\t}\r\n\t\tthis.editing = false;\r\n\t}\r\n\r\n\tstatic getInteractiveDescriptors() {\r\n\t\tlet descriptors = ModelModelComponent.interactiveDescriptors;\r\n\t\tif (!descriptors) {\r\n\t\t\tconst freezableDescriptors = Object.getOwnPropertyDescriptors(FreezableMesh.prototype);\r\n\t\t\tconst emittableDescriptors = Object.getOwnPropertyDescriptors(EmittableMesh.prototype);\r\n\t\t\tconst interactiveDescriptors = Object.getOwnPropertyDescriptors(InteractiveMesh.prototype);\r\n\t\t\tdescriptors = Object.assign({}, freezableDescriptors, emittableDescriptors, interactiveDescriptors);\r\n\t\t\tModelModelComponent.interactiveDescriptors = descriptors;\r\n\t\t}\r\n\t\treturn descriptors;\r\n\t}\r\n\r\n\tmakeInteractive(mesh) {\r\n\t\tconst interactiveDescriptors = ModelModelComponent.getInteractiveDescriptors();\r\n\t\tmesh.traverse((child) => {\r\n\t\t\tif (child.isMesh) {\r\n\t\t\t\tObject.keys(interactiveDescriptors).forEach(key => {\r\n\t\t\t\t\tif (key !== 'constructor') {\r\n\t\t\t\t\t\tObject.defineProperty(child, key, interactiveDescriptors[key]);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tchild.freezed = false;\r\n\t\t\t\tchild.events = {};\r\n\t\t\t\tchild.depthTest = true;\r\n\t\t\t\tchild.over_ = false;\r\n\t\t\t\tchild.down_ = false;\r\n\t\t\t\tInteractive.items.push(child);\r\n\t\t\t\tchild.on('down', () => {\r\n\t\t\t\t\t// console.log('ModelModelComponent.down', child);\r\n\t\t\t\t\tthis.onClipToggle();\r\n\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\t/*\r\n\tmakeInteractive__(mesh) {\r\n\t\tlet newChild = null;\r\n\t\tmesh.traverse((child) => {\r\n\t\t\tif (newChild === null && child.isMesh && !(child.isInteractiveMesh)) {\r\n\t\t\t\t// roughnessMipmapper.generateMipmaps(child.material);\r\n\t\t\t\tconst parent = child.parent;\r\n\t\t\t\tnewChild = new InteractiveMesh(child.geometry, child.material);\r\n\t\t\t\t// newChild.depthTest = true;\r\n\t\t\t\t// newChild.renderOrder = 0;\r\n\t\t\t\tnewChild.name = child.name;\r\n\t\t\t\tnewChild.position.copy(child.position);\r\n\t\t\t\tnewChild.rotation.copy(child.rotation);\r\n\t\t\t\tnewChild.scale.copy(child.scale);\r\n\t\t\t\tnewChild.on('down', () => {\r\n\t\t\t\t\t// console.log('ModelModelComponent.down');\r\n\t\t\t\t\tthis.onClipToggle();\r\n\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t});\r\n\t\t\t\tparent.remove(child);\r\n\t\t\t\tparent.add(newChild);\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (newChild !== null) {\r\n\t\t\tthis.makeInteractive(mesh);\r\n\t\t}\r\n\t}\r\n\t*/\r\n\r\n}\r\n\r\nModelModelComponent.ORIGIN = new THREE.Vector3();\r\n\r\nModelModelComponent.meta = {\r\n\tselector: '[model-model]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down'],\r\n\tinputs: ['item', 'view'],\r\n};\r\n","import { environment } from '../../environment';\r\nimport Interactive from '../interactive/interactive';\r\nimport InteractiveMesh from '../interactive/interactive.mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport const NavModeType = {\r\n\tNone: 'none',\r\n\tMove: 'move',\r\n\tInfo: 'info',\r\n\tPoint: 'point',\r\n\tTitle: 'title',\r\n};\r\n\r\nexport default class ModelNavComponent extends ModelEditableComponent {\r\n\r\n\tstatic getNavGeometry() {\r\n\t\t// const geometry = new THREE.PlaneBufferGeometry(3, 2, 2, 2);\r\n\t\t// const geometry = new THREE.SphereBufferGeometry(3, 12, 12);\r\n\t\treturn ModelNavComponent.navGeometry || (ModelNavComponent.navGeometry = new THREE.SphereBufferGeometry(3, 12, 12));\r\n\t}\r\n\r\n\tstatic getLoader() {\r\n\t\treturn ModelNavComponent.loader || (ModelNavComponent.loader = new THREE.TextureLoader());\r\n\t}\r\n\r\n\tstatic getTexturePoint() {\r\n\t\treturn ModelNavComponent.texturePoint || (ModelNavComponent.texturePoint = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-point.png')));\r\n\t}\r\n\r\n\tstatic getTextureMove() {\r\n\t\treturn ModelNavComponent.textureMove || (ModelNavComponent.textureMove = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-more.png')));\r\n\t}\r\n\r\n\tstatic getTextureInfo() {\r\n\t\treturn ModelNavComponent.textureInfo || (ModelNavComponent.textureInfo = ModelNavComponent.getLoader().load(environment.getPath('textures/ui/nav-info.png')));\r\n\t}\r\n\r\n\tstatic getTexture(mode) {\r\n\t\tlet texture;\r\n\t\tswitch (mode) {\r\n\t\t\tcase NavModeType.Move:\r\n\t\t\t\ttexture = this.getTextureMove();\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Info:\r\n\t\t\t\ttexture = this.getTextureInfo();\r\n\t\t\t\tbreak;\r\n\t\t\tcase NavModeType.Point:\r\n\t\t\tcase NavModeType.Title:\r\n\t\t\t\ttexture = this.getTexturePoint();\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tstatic getTitleTexture(item, mode) {\r\n\t\tlet texture;\r\n\t\tif (mode === NavModeType.Title) {\r\n\t\t\tconst text = item.title;\r\n\t\t\tconst canvas = document.createElement('canvas');\r\n\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\tcanvas.width = 512;\r\n\t\t\tcanvas.height = 32;\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `28px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tlet w = metrics.width + 8;\r\n\t\t\tw = Math.pow(2, Math.ceil(Math.log(w) / Math.log(2)));\r\n\t\t\tconst x = w / 2;\r\n\t\t\tconst y = 16;\r\n\t\t\tcanvas.width = w;\r\n\t\t\tctx.font = `28px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';\r\n\t\t\tctx.lineWidth = 6;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with \"bevel\" & \"round\" for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, x, y);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, x, y);\r\n\t\t\ttexture = new THREE.CanvasTexture(canvas);\r\n\t\t}\r\n\t\treturn texture;\r\n\t}\r\n\r\n\tstatic getNavMode(item, view) {\r\n\t\tlet mode = NavModeType.None;\r\n\t\tif (item.viewId !== view.id) {\r\n\t\t\tmode = NavModeType.Move;\r\n\t\t\tif (this.isValidText(item.title)) {\r\n\t\t\t\tmode = NavModeType.Title;\r\n\t\t\t}\r\n\t\t\tif (this.isValidText(item.abstract) ||\r\n\t\t\t\t(item.asset && item.asset.id) ||\r\n\t\t\t\t(item.link && item.link.href)) {\r\n\t\t\t\tmode = NavModeType.Point;\r\n\t\t\t}\r\n\t\t} else if (this.isValidText(item.title) ||\r\n\t\t\tthis.isValidText(item.abstract) ||\r\n\t\t\t(item.asset && item.asset.id) ||\r\n\t\t\t(item.link && item.link.href)) {\r\n\t\t\tmode = NavModeType.Info;\r\n\t\t}\r\n\t\treturn mode;\r\n\t}\r\n\r\n\tstatic isValidText(text) {\r\n\t\treturn text && text.length > 0;\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t/*\r\n\t\tthis.debouncedOver$ = new ReplaySubject(1).pipe(\r\n\t\t\tauditTime(250),\r\n\t\t\ttap(event => this.over.next(event)),\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t);\r\n\t\tthis.debouncedOver$.subscribe();\r\n\t\t*/\r\n\t\t// console.log('ModelNavComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// this.renderOrder = environment.renderOrder.nav;\r\n\t\tconst mode = this.mode = ModelNavComponent.getNavMode(this.item, this.view);\r\n\t\tif (mode === NavModeType.None) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst nav = new THREE.Group();\r\n\t\tconst position = new THREE.Vector3().set(...this.item.position).normalize().multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\tnav.position.set(position.x, position.y, position.z);\r\n\r\n\t\tthis.onCreateSprites(nav);\r\n\r\n\t\tconst geometry = ModelNavComponent.getNavGeometry();\r\n\t\tconst sphere = new InteractiveMesh(geometry, new THREE.MeshBasicMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0.0,\r\n\t\t\tcolor: 0x00ffff,\r\n\t\t}));\r\n\t\tsphere.name = `[nav] ${this.item.id}`;\r\n\t\tsphere.lookAt(ModelNavComponent.ORIGIN);\r\n\t\tsphere.depthTest = false;\r\n\t\tsphere.renderOrder = 0;\r\n\t\tnav.add(sphere);\r\n\t\tsphere.on('over', () => {\r\n\t\t\t// console.log('ModelNavComponent.over');\r\n\t\t\t/*\r\n\t\t\tif ((mode !== NavModeType.Move && mode !== NavModeType.Title) && !this.editing) {\r\n\t\t\t\tthis.over.next(this);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tthis.over.next(this);\r\n\t\t\tconst icon = this.icon;\r\n\t\t\tconst from = { scale: icon.scale.x };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.35,\r\n\t\t\t\tscale: 0.05,\r\n\t\t\t\tdelay: 0,\r\n\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\ticon.scale.set(from.scale, from.scale, from.scale);\r\n\t\t\t\t},\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tif (!this.editing) {\r\n\t\t\t\t\t\tthis.over.next(this);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t\tsphere.on('out', () => {\r\n\t\t\tthis.out.next(this);\r\n\t\t\tconst icon = this.icon;\r\n\t\t\tconst from = { scale: icon.scale.x };\r\n\t\t\tgsap.to(from, {\r\n\t\t\t\tduration: 0.35,\r\n\t\t\t\tscale: 0.03,\r\n\t\t\t\tdelay: 0,\r\n\t\t\t\tease: Power2.easeOut,\r\n\t\t\t\toverwrite: true,\r\n\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\ticon.scale.set(from.scale, from.scale, from.scale);\r\n\t\t\t\t},\r\n\t\t\t\tonComplete: () => {\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tthis.out.next(this);\r\n\t\t\t\t\t*/\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t\tsphere.on('down', () => {\r\n\t\t\tthis.down.next(this);\r\n\t\t});\r\n\t\tconst from = { opacity: 0 };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.7,\r\n\t\t\topacity: 1,\r\n\t\t\tdelay: 0.5 + 0.1 * this.item.index,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\toverwrite: true,\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tthis.materials.forEach(material => {\r\n\t\t\t\t\tmaterial.opacity = from.opacity;\r\n\t\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(nav, this.item);\r\n\t\t}\r\n\t}\r\n\r\n\tonCreateSprites(mesh, opacity = 0) {\r\n\t\tthis.onRemoveSprite(this.icon);\r\n\t\tthis.onRemoveSprite(this.title);\r\n\t\tconst mode = this.mode = ModelNavComponent.getNavMode(this.item, this.view);\r\n\t\tif (mode === NavModeType.None) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tconst map = ModelNavComponent.getTexture(mode);\r\n\t\tmap.disposable = false;\r\n\t\tmap.encoding = THREE.sRGBEncoding;\r\n\t\tconst material = new THREE.SpriteMaterial({\r\n\t\t\tdepthTest: false,\r\n\t\t\tdepthWrite: false,\r\n\t\t\ttransparent: true,\r\n\t\t\tmap: map,\r\n\t\t\tsizeAttenuation: false,\r\n\t\t\topacity: opacity,\r\n\t\t\t// color: 0xff0000,\r\n\t\t});\r\n\t\tconst materials = [material];\r\n\t\tconst icon = this.icon = new THREE.Sprite(material);\r\n\t\ticon.scale.set(0.03, 0.03, 0.03);\r\n\t\tmesh.add(icon);\r\n\t\tlet titleMaterial;\r\n\t\tconst titleTexture = ModelNavComponent.getTitleTexture(this.item, mode);\r\n\t\tif (titleTexture) {\r\n\t\t\ttitleMaterial = new THREE.SpriteMaterial({\r\n\t\t\t\tdepthTest: false,\r\n\t\t\t\tdepthWrite: false,\r\n\t\t\t\ttransparent: true,\r\n\t\t\t\tmap: titleTexture,\r\n\t\t\t\tsizeAttenuation: false,\r\n\t\t\t\topacity: opacity,\r\n\t\t\t\t// color: 0xff0000,\r\n\t\t\t});\r\n\t\t\t// console.log(titleTexture);\r\n\t\t\tconst image = titleTexture.image;\r\n\t\t\tconst title = this.title = new THREE.Sprite(titleMaterial);\r\n\t\t\ttitle.scale.set(0.03 * image.width / image.height, 0.03, 0.03);\r\n\t\t\ttitle.position.set(0, -3.5, 0);\r\n\t\t\tmesh.add(title);\r\n\t\t\tmaterials.push(titleMaterial);\r\n\t\t}\r\n\t\tthis.materials = materials;\r\n\t}\r\n\r\n\tonRemoveSprite(sprite) {\r\n\t\tif (sprite) {\r\n\t\t\tif (sprite.parent) {\r\n\t\t\t\tsprite.parent.remove(sprite);\r\n\t\t\t}\r\n\t\t\tif (sprite.material.map && sprite.material.map.disposable !== false) {\r\n\t\t\t\tsprite.material.map.dispose();\r\n\t\t\t}\r\n\t\t\tsprite.material.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tInteractive.dispose(this.sphere);\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\tshouldShowPanel() {\r\n\t\treturn (!this.editing && this.mode !== NavModeType.Move && this.mode !== NavModeType.Title);\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\tthis.item = item;\r\n\t\tthis.onCreateSprites(this.mesh, 1);\r\n\t\tconst position = new THREE.Vector3().set(...item.position).normalize().multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\tmesh.position.set(position.x, position.y, position.z);\r\n\t\t// console.log('onUpdate', item, mesh.position);\r\n\t\tthis.updateHelper();\r\n\t\t/*\r\n\t\tthis.onCreate(\r\n\t\t\t(mesh, item) => this.onMount(mesh, item),\r\n\t\t\t(mesh, item) => this.onDismount(mesh, item)\r\n\t\t);\r\n\t\t*/\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\tthis.editing = true;\r\n\t\tthis.item.showPanel = false;\r\n\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(ModelNavComponent.RADIUS);\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\tthis.item.position = new THREE.Vector3().copy(this.mesh.position).normalize().toArray();\r\n\t\tthis.editing = false;\r\n\t}\r\n}\r\n\r\nModelNavComponent.ORIGIN = new THREE.Vector3();\r\nModelNavComponent.RADIUS = 100;\r\n\r\nModelNavComponent.meta = {\r\n\tselector: '[model-nav]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['over', 'out', 'down'],\r\n\tinputs: ['item', 'view'],\r\n};\r\n","import EmittableSprite from './emittable.sprite';\r\nimport Interactive from './interactive';\r\n\r\nexport default class InteractiveSprite extends EmittableSprite {\r\n\r\n\tconstructor(material) {\r\n\t\tsuper(material);\r\n\t\tthis.depthTest = true;\r\n\t\tthis.over_ = false;\r\n\t\tthis.down_ = false;\r\n\t\tInteractive.items.push(this);\r\n\t}\r\n\r\n\tget isInteractiveSprite() {\r\n\t\treturn true;\r\n\t}\r\n\r\n\tget over() {\r\n\t\treturn this.over_;\r\n\t}\r\n\tset over(over) {\r\n\t\tif (this.over_ != over) {\r\n\t\t\tthis.over_ = over;\r\n\t\t\t/*\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('hit', this);\r\n\t\t\t}\r\n\t\t\t*/\r\n\t\t\tif (over) {\r\n\t\t\t\tthis.emit('over', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('out', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget down() {\r\n\t\treturn this.down_;\r\n\t}\r\n\tset down(down) {\r\n\t\tdown = down && this.over;\r\n\t\tif (this.down_ != down) {\r\n\t\t\tthis.down_ = down;\r\n\t\t\tif (down) {\r\n\t\t\t\tthis.emit('down', this);\r\n\t\t\t} else {\r\n\t\t\t\tthis.emit('up', this);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n","import FreezableSprite from \"./freezable.sprite\";\r\n\r\nexport default class EmittableSprite extends FreezableSprite {\r\n\r\n\tconstructor(material) {\r\n\t\tmaterial = material || new THREE.SpriteMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(material);\r\n\t\tthis.events = {};\r\n\t}\r\n\r\n\ton(type, callback) {\r\n\t\tconst event = this.events[type] = this.events[type] || [];\r\n\t\tevent.push(callback);\r\n\t\treturn () => {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t};\r\n\t}\r\n\r\n\toff(type, callback) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tthis.events[type] = event.filter(x => x !== callback);\r\n\t\t}\r\n\t}\r\n\r\n\temit(type, data) {\r\n\t\tconst event = this.events[type];\r\n\t\tif (event) {\r\n\t\t\tevent.forEach(callback => {\r\n\t\t\t\t// callback.call(this, data);\r\n\t\t\t\tcallback(data);\r\n\t\t\t});\r\n\t\t}\r\n\t\tconst broadcast = this.events.broadcast;\r\n\t\tif (broadcast) {\r\n\t\t\tbroadcast.forEach(callback => {\r\n\t\t\t\tcallback(type, data);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n}\r\n","\r\nexport default class FreezableSprite extends THREE.Sprite {\r\n\r\n\tget freezed() {\r\n\t\treturn this.freezed_;\r\n\t}\r\n\r\n\tset freezed(freezed) {\r\n\t\t// !!! cycle through freezable and not freezable\r\n\t\tthis.freezed_ = freezed;\r\n\t\tthis.children.filter(x => x.__lookupGetter__('freezed')).forEach(x => x.freezed = freezed);\r\n\t}\r\n\r\n\tconstructor(material) {\r\n\t\tmaterial = material || new THREE.SpriteMaterial({\r\n\t\t\tcolor: 0xff00ff,\r\n\t\t\t// opacity: 1,\r\n\t\t\t// transparent: true,\r\n\t\t});\r\n\t\tsuper(material);\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n\tfreeze() {\r\n\t\tthis.freezed = true;\r\n\t}\r\n\r\n\tunfreeze() {\r\n\t\tthis.freezed = false;\r\n\t}\r\n\r\n}\r\n","import html2canvas from 'html2canvas';\r\nimport { getContext } from 'rxcomp';\r\nimport DragService from '../../drag/drag.service';\r\nimport { environment } from '../../environment';\r\nimport InteractiveSprite from '../interactive/interactive.sprite';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelPanelComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelPanelComponent.onInit', this.item);\r\n\t}\r\n\r\n\tonView() {\r\n\t\tif (this.viewed) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.viewed = true;\r\n\t\tconst { node } = getContext(this);\r\n\t\tthis.getCanvasTexture(node).then(texture => {\r\n\t\t\tif (this.mesh) {\r\n\t\t\t\tconst scale = 0.2 * (this.item.asset ? 1.5 : 1.0);\r\n\t\t\t\tconst aspect = texture.width / texture.height;\r\n\t\t\t\tconst width = ModelPanelComponent.PANEL_RADIUS * scale;\r\n\t\t\t\tconst height = ModelPanelComponent.PANEL_RADIUS * scale / aspect;\r\n\t\t\t\tconst dy = width * 0.25;\r\n\t\t\t\tconst position = this.item.mesh.position.normalize().multiplyScalar(ModelPanelComponent.PANEL_RADIUS);\r\n\t\t\t\tconst material = new THREE.SpriteMaterial({\r\n\t\t\t\t\tdepthTest: false,\r\n\t\t\t\t\ttransparent: true,\r\n\t\t\t\t\topacity: 0,\r\n\t\t\t\t\tmap: texture.map,\r\n\t\t\t\t\tsizeAttenuation: false,\r\n\t\t\t\t});\r\n\t\t\t\tconst panel = this.panel = new InteractiveSprite(material);\r\n\t\t\t\tpanel.renderOrder = environment.renderOrder.panel;\r\n\t\t\t\tpanel.scale.set(0.02 * width, 0.02 * height, 1);\r\n\t\t\t\tpanel.position.set(position.x, position.y + (height + dy * 2), position.z);\r\n\t\t\t\tpanel.on('down', (event) => {\r\n\t\t\t\t\tconst xy = { x: parseInt(event.intersection.uv.x * node.offsetWidth), y: parseInt((1 - event.intersection.uv.y) * node.offsetHeight) };\r\n\t\t\t\t\t// console.log('ModelPanelComponent.down.xy', xy);\r\n\t\t\t\t\tconst link = Array.prototype.slice.call(node.querySelectorAll('.panel__link')).find(link => {\r\n\t\t\t\t\t\treturn xy.x >= link.offsetLeft && xy.y >= link.offsetTop && xy.x <= (link.offsetLeft + link.offsetWidth) && xy.y <= (link.offsetTop + link.offsetHeight);\r\n\t\t\t\t\t});\r\n\t\t\t\t\t// console.log('ModelPanelComponent.down.link', link);\r\n\t\t\t\t\tif (link) {\r\n\t\t\t\t\t\tthis.down.next(link);\r\n\t\t\t\t\t\tconst rect = node.getBoundingClientRect();\r\n\t\t\t\t\t\tconst event = new MouseEvent('mouseup', {\r\n\t\t\t\t\t\t\tbutton: 0,\r\n\t\t\t\t\t\t\tbuttons: 0,\r\n\t\t\t\t\t\t\tclientX: xy.x + rect.left,\r\n\t\t\t\t\t\t\tclientY: xy.y + rect.top,\r\n\t\t\t\t\t\t\tmovementX: 0,\r\n\t\t\t\t\t\t\tmovementY: 0,\r\n\t\t\t\t\t\t\trelatedTarget: link,\r\n\t\t\t\t\t\t\tscreenX: xy.x,\r\n\t\t\t\t\t\t\tscreenY: xy.y,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t// console.log('ModelPanelComponent.dispatchEvent', event);\r\n\t\t\t\t\t\tlink.dispatchEvent(event);\r\n\t\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\t\tDragService.dismissEvent(event, DragService.events$, DragService.dismiss$, DragService.downEvent);\r\n\t\t\t\t\t\t}, 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t\tthis.mesh.add(panel);\r\n\t\t\t\tconst from = { value: 0 };\r\n\t\t\t\tgsap.to(from, {\r\n\t\t\t\t\tduration: 0.5,\r\n\t\t\t\t\tvalue: 1,\r\n\t\t\t\t\tdelay: 0.0,\r\n\t\t\t\t\tease: Power2.easeInOut,\r\n\t\t\t\t\tonUpdate: () => {\r\n\t\t\t\t\t\tpanel.position.set(position.x, position.y + (height + dy * 2) - dy * from.value, position.z);\r\n\t\t\t\t\t\tpanel.lookAt(ModelPanelComponent.ORIGIN);\r\n\t\t\t\t\t\tpanel.material.opacity = from.value;\r\n\t\t\t\t\t\tpanel.material.needsUpdate = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}, error => {\r\n\t\t\tconsole.log('ModelPanelComponent.getCanvasTexture.error', error);\r\n\t\t});\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\t// console.log('ModelPanelComponent.onDestroy');\r\n\t\tsuper.onDestroy();\r\n\t}\r\n\r\n\timagesLoaded() {\r\n\t\tconst { node } = getContext(this);\r\n\t\tif (node) {\r\n\t\t\tconst images = Array.prototype.slice.call(node.querySelectorAll('img'));\r\n\t\t\tconst promises = images.map(x => new Promise(function(resolve, reject) {\r\n\t\t\t\tconst cors = x.src && x.src.indexOf(location.origin) === -1;\r\n\t\t\t\tif (x.complete) {\r\n\t\t\t\t\treturn setTimeout(() => {\r\n\t\t\t\t\t\tresolve(cors);\r\n\t\t\t\t\t}, 10);\r\n\t\t\t\t}\r\n\t\t\t\tconst removeListeners = () => {\r\n\t\t\t\t\tx.removeEventListener('load', onLoad);\r\n\t\t\t\t\tx.removeEventListener('error', onError);\r\n\t\t\t\t};\r\n\t\t\t\tconst onLoad = () => {\r\n\t\t\t\t\t// console.log('loaded!');\r\n\t\t\t\t\tremoveListeners();\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tresolve(cors);\r\n\t\t\t\t\t}, 10);\r\n\t\t\t\t};\r\n\t\t\t\tconst onError = () => {\r\n\t\t\t\t\t// console.log('error!');\r\n\t\t\t\t\tremoveListeners();\r\n\t\t\t\t\tresolve(false);\r\n\t\t\t\t};\r\n\t\t\t\tconst addListeners = () => {\r\n\t\t\t\t\tx.addEventListener('load', onLoad);\r\n\t\t\t\t\tx.addEventListener('error', onError);\r\n\t\t\t\t};\r\n\t\t\t\taddListeners();\r\n\t\t\t}));\r\n\t\t\tif (promises.length) {\r\n\t\t\t\treturn Promise.all(promises);\r\n\t\t\t} else {\r\n\t\t\t\treturn Promise.resolve();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tgetCanvasTexture(node) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tif (this.item.panelTexture) {\r\n\t\t\t\t\tresolve(this.item.panelTexture);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.imagesLoaded().then((results) => {\r\n\t\t\t\t\t\tconst context = getContext(this);\r\n\t\t\t\t\t\tif (context && context.node) {\r\n\t\t\t\t\t\t\tnode = context.node;\r\n\t\t\t\t\t\t\tconst useCORS = results && (results.find(x => x === true) != null); // !!! keep loose equality\r\n\t\t\t\t\t\t\t// console.log('ModelPanelComponent.getCanvasTexture.useCORS', useCORS);\r\n\t\t\t\t\t\t\thtml2canvas(node, {\r\n\t\t\t\t\t\t\t\tbackgroundColor: '#ffffff00',\r\n\t\t\t\t\t\t\t\tscale: 2,\r\n\t\t\t\t\t\t\t\tuseCORS,\r\n\t\t\t\t\t\t\t\t// logging: true,\r\n\t\t\t\t\t\t\t}).then(canvas => {\r\n\t\t\t\t\t\t\t\t// !!!\r\n\t\t\t\t\t\t\t\t// document.body.appendChild(canvas);\r\n\t\t\t\t\t\t\t\t// const alpha = this.getAlphaFromCanvas(canvas);\r\n\t\t\t\t\t\t\t\t// document.body.appendChild(alpha);\r\n\t\t\t\t\t\t\t\tconst map = new THREE.CanvasTexture(canvas);\r\n\t\t\t\t\t\t\t\t// const alphaMap = new THREE.CanvasTexture(alpha);\r\n\t\t\t\t\t\t\t\t// console.log(canvas.width, canvas.height);\r\n\t\t\t\t\t\t\t\tthis.item.panelTexture = {\r\n\t\t\t\t\t\t\t\t\tmap: map,\r\n\t\t\t\t\t\t\t\t\twidth: canvas.width,\r\n\t\t\t\t\t\t\t\t\theight: canvas.height,\r\n\t\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\t\tresolve(this.item.panelTexture);\r\n\t\t\t\t\t\t\t}, error => {\r\n\t\t\t\t\t\t\t\treject(error);\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}, 1); // keep it for childnode images to be compiled\r\n\t\t});\r\n\t}\r\n}\r\n\r\nModelPanelComponent.ORIGIN = new THREE.Vector3();\r\nModelPanelComponent.PANEL_RADIUS = 99;\r\n\r\nModelPanelComponent.meta = {\r\n\tselector: '[model-panel]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['over', 'out', 'down'],\r\n\tinputs: ['item'],\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelPictureComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelPictureComponent.onInit');\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n}\r\n\r\nModelPictureComponent.meta = {\r\n\tselector: '[model-picture]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { filter, take, takeUntil } from 'rxjs/operators';\r\nimport MediaMesh from '../media/media-mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelEditableComponent from './model-editable.component';\r\n\r\nexport default class ModelPlaneComponent extends ModelEditableComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelPlaneComponent.onInit');\r\n\t}\r\n\r\n\tonChanges() {\r\n\t\tthis.editing = this.item.selected;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst item = this.item;\r\n\t\tconst items = this.items;\r\n\t\tconst geometry = new THREE.PlaneBufferGeometry(1, 1, 2, 2);\r\n\t\tlet mesh;\r\n\t\tlet subscription;\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t).subscribe((streamId) => {\r\n\t\t\tif (this.streamId !== streamId) {\r\n\t\t\t\tthis.streamId = streamId;\r\n\t\t\t\t// !!! called by ModelComponent\r\n\t\t\t\t/*\r\n\t\t\t\tif (mesh) {\r\n\t\t\t\t\tdismount(mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t*/\r\n\t\t\t\tif (subscription) {\r\n\t\t\t\t\tsubscription.unsubscribe();\r\n\t\t\t\t\tsubscription = null;\r\n\t\t\t\t}\r\n\t\t\t\tif (streamId || !item.asset) {\r\n\t\t\t\t\titem.streamId = streamId;\r\n\t\t\t\t\tmesh = new MediaMesh(item, items, geometry);\r\n\t\t\t\t\tif (item.position) {\r\n\t\t\t\t\t\tmesh.position.fromArray(item.position);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.rotation) {\r\n\t\t\t\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (item.scale) {\r\n\t\t\t\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tmesh.load(() => {\r\n\t\t\t\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\t\t\t\tmount(mesh, item);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsubscription = mesh.events$().pipe(\r\n\t\t\t\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t\t\t\t).subscribe(() => { });\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('down', () => {\r\n\t\t\t\t\t\t// console.log('ModelPanelComponent.down');\r\n\t\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('playing', (playing) => {\r\n\t\t\t\t\t\t// console.log('ModelPanelComponent.playing', playing);\r\n\t\t\t\t\t\tthis.play.next({ itemId: this.item.id, playing });\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (this.mesh) {\r\n\t\t\t\t\tdismount(this.mesh, item);\r\n\t\t\t\t}\r\n\t\t\t\t// console.log('streamId', streamId, mesh);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tif (this.mesh) {\r\n\t\t\tthis.mesh.dispose();\r\n\t\t}\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdate(item, mesh) {\r\n\t\t// console.log('ModelPlaneComponent.onUpdate', item);\r\n\t\tif (item.position) {\r\n\t\t\tmesh.position.fromArray(item.position);\r\n\t\t}\r\n\t\tif (item.rotation) {\r\n\t\t\tmesh.rotation.fromArray(item.rotation);\r\n\t\t}\r\n\t\tif (item.scale) {\r\n\t\t\tmesh.scale.fromArray(item.scale);\r\n\t\t}\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by UpdateViewItemComponent\r\n\tonUpdateAsset(item, mesh) {\r\n\t\t// console.log('ModelPlaneComponent.onUpdateAsset', item);\r\n\t\tthis.mesh.updateByItem(item);\r\n\t\tMediaMesh.getStreamId$(item).pipe(\r\n\t\t\tfilter(streamId => streamId !== null),\r\n\t\t\ttake(1),\r\n\t\t).subscribe((streamId) => {\r\n\t\t\titem.streamId = streamId;\r\n\t\t\tthis.mesh.load(() => {\r\n\t\t\t\t// console.log('ModelPlaneComponent.mesh.load.complete');\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragMove(position) {\r\n\t\t// console.log('ModelPlaneComponent.onDragMove', position);\r\n\t\tthis.item.showPanel = false;\r\n\t\tthis.editing = true;\r\n\t\tthis.mesh.position.set(position.x, position.y, position.z).multiplyScalar(20);\r\n\t\tthis.mesh.lookAt(ModelPlaneComponent.ORIGIN);\r\n\t\tthis.updateHelper();\r\n\t}\r\n\r\n\t// called by WorldComponent\r\n\tonDragEnd() {\r\n\t\t// console.log('ModelPlaneComponent.onDragEnd');\r\n\t\tthis.item.position = this.mesh.position.toArray();\r\n\t\tthis.item.rotation = this.mesh.rotation.toArray();\r\n\t\tthis.item.scale = this.mesh.scale.toArray();\r\n\t\tthis.editing = false;\r\n\t}\r\n\r\n}\r\n\r\nModelPlaneComponent.ORIGIN = new THREE.Vector3();\r\nModelPlaneComponent.textures = {};\r\n\r\nModelPlaneComponent.meta = {\r\n\tselector: '[model-plane]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play'],\r\n\tinputs: ['item', 'items'],\r\n};\r\n","import { takeUntil } from 'rxjs/operators';\r\nimport { environment } from '../../environment';\r\nimport LabelPipe from '../../label/label.pipe';\r\nimport LoaderService from '../../loader/loader.service';\r\nimport { ViewType } from '../../view/view';\r\nimport { PANORAMA_RADIUS } from '../panorama/panorama';\r\nimport VRService from '../vr.service';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport const LOADING_BANNER = { title: LabelPipe.transform('loading') };\r\nexport const WAITING_BANNER = { title: LabelPipe.transform('waiting_host') };\r\n\r\nconst PANEL_RADIUS = PANORAMA_RADIUS - 0.01;\r\n\r\nexport default class ModelProgressComponent extends ModelComponent {\r\n\r\n\tget title() {\r\n\t\treturn this.title_;\r\n\t}\r\n\tset title(title) {\r\n\t\tif (this.title_ !== title) {\r\n\t\t\tthis.title_ = title;\r\n\t\t\tif (title === WAITING_BANNER.title || (title !== '' && this.visible_)) {\r\n\t\t\t\tthis.updateProgress();\r\n\t\t\t\tthis.show();\r\n\t\t\t} else {\r\n\t\t\t\tthis.hide();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tget visible() {\r\n\t\treturn this.visible_;\r\n\t}\r\n\tset visible(visible) {\r\n\t\tif (this.visible_ !== visible) {\r\n\t\t\tthis.visible_ = visible;\r\n\t\t\tif (visible && this.title_ !== '') {\r\n\t\t\t\tthis.updateProgress();\r\n\t\t\t\tthis.show();\r\n\t\t\t} else {\r\n\t\t\t\tthis.hide();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tonInit() {\r\n\t\tthis.title_ = '';\r\n\t\tthis.visible_ = this.host.renderer.xr.isPresenting;\r\n\t\tsuper.onInit();\r\n\t\tconst vrService = this.vrService = VRService.getService();\r\n\t\tvrService.session$.pipe(\r\n\t\t\ttakeUntil(this.unsubscribe$),\r\n\t\t).subscribe((session) => this.visible = session != null); // loose\r\n\t\t// this.progress = LoaderService.progress;\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\t// console.log('ModelProgressComponent.onCreate');\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\tconst mesh = this.createMesh(result);\r\n\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\tmount(mesh);\r\n\t\t\t}\r\n\t\t\tLoaderService.progress$.pipe(\r\n\t\t\t\ttakeUntil(this.unsubscribe$)\r\n\t\t\t).subscribe(progress => {\r\n\t\t\t\tif (progress.count) {\r\n\t\t\t\t\tthis.title = progress.value === 0 ? LOADING_BANNER.title : progress.title;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthis.title = this.getTitle();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tgetTitle() {\r\n\t\tif (this.view && this.view.type.name === ViewType.WaitingRoom.name) {\r\n\t\t\treturn WAITING_BANNER.title;\r\n\t\t} else {\r\n\t\t\treturn '';\r\n\t\t}\r\n\t}\r\n\r\n\tshow() {\r\n\t\tthis.mesh.add(this.banner);\r\n\t\tthis.material.opacity = 1;\r\n\t\tthis.material.needsUpdate = true;\r\n\t\t/*\r\n\t\tconst material = this.material;\r\n\t\tconst from = { value: material.opacity };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.5,\r\n\t\t\tvalue: 1,\r\n\t\t\tdelay: 0.0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\toverwrite: 'all',\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\thide() {\r\n\t\tthis.mesh.remove(this.banner);\r\n\t\tthis.material.opacity = 0;\r\n\t\tthis.material.needsUpdate = true;\r\n\t\t/*\r\n\t\tconst from = { value: material.opacity };\r\n\t\tgsap.to(from, {\r\n\t\t\tduration: 0.5,\r\n\t\t\tvalue: 0,\r\n\t\t\tdelay: 0.0,\r\n\t\t\tease: Power2.easeInOut,\r\n\t\t\toverwrite: 'all',\r\n\t\t\tonUpdate: () => {\r\n\t\t\t\tmaterial.opacity = from.value;\r\n\t\t\t\tmaterial.needsUpdate = true;\r\n\t\t\t},\r\n\t\t\tonComplete: () => {\r\n\t\t\t\tthis.mesh.remove(this.banner);\r\n\t\t\t}\r\n\t\t});\r\n\t\t*/\r\n\t}\r\n\r\n\tcreateMesh(result) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\t// const repeat = 24;\r\n\t\t// const aspect = (result.width * repeat) / result.height;\r\n\t\tconst arc = Math.PI / 180 * 360;\r\n\t\tconst width = PANEL_RADIUS * arc;\r\n\t\tconst height = width / 360 * 2.4;\r\n\t\tconst w = result.width * height / result.height;\r\n\t\tconst repeat = width / w;\r\n\t\tconst geometry = new THREE.CylinderBufferGeometry(PANEL_RADIUS, PANEL_RADIUS, height, 80, 2, true, 0, arc);\r\n\t\tgeometry.scale(-1, 1, 1);\r\n\t\tconst texture = result.texture;\r\n\t\ttexture.wrapS = texture.wrapY = THREE.RepeatWrapping;\r\n\t\ttexture.repeat.x = repeat;\r\n\t\ttexture.encoding = THREE.sRGBEncoding;\r\n\t\tconst material = this.material = new THREE.MeshBasicMaterial({\r\n\t\t\tmap: texture,\r\n\t\t\ttransparent: true,\r\n\t\t\topacity: 0,\r\n\t\t\t// side: THREE.DoubleSide,\r\n\t\t});\r\n\t\tconst banner = this.banner = new THREE.Mesh(geometry, material);\r\n\t\tmesh.userData = {\r\n\t\t\trender: () => {\r\n\t\t\t\tmesh.rotation.y += Math.PI / 180 * 0.02;\r\n\t\t\t\t// texture.offset.x = (texture.offset.x - 0.01) % 1;\r\n\t\t\t\t// material.needsUpdate = true;\r\n\t\t\t}\r\n\t\t};\r\n\t\treturn mesh;\r\n\t}\r\n\r\n\tupdateProgress() {\r\n\t\tthis.getCanvasTexture().then(result => {\r\n\t\t\t// console.log('ModelProgressComponent.updateProgress', result);\r\n\t\t\tconst arc = Math.PI / 180 * 360;\r\n\t\t\tconst width = PANEL_RADIUS * arc;\r\n\t\t\tconst height = width / 360 * 2.4;\r\n\t\t\tconst w = result.width * height / result.height;\r\n\t\t\tconst repeat = width / w;\r\n\t\t\tthis.texture.repeat.x = repeat;\r\n\t\t});\r\n\t}\r\n\r\n\tgetCanvasTexture() {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tconst MIN_W = 512;\r\n\t\t\tlet W = MIN_W;\r\n\t\t\tlet H = 64;\r\n\t\t\tconst F = Math.floor(H * 0.75);\r\n\t\t\tconst L = Math.floor(H * 0.05);\r\n\t\t\tlet canvas;\r\n\t\t\tif (this.canvas) {\r\n\t\t\t\tcanvas = this.canvas;\r\n\t\t\t} else {\r\n\t\t\t\tcanvas = this.canvas = document.createElement('canvas');\r\n\t\t\t\t// canvas.classList.add('canvas--debug');\r\n\t\t\t\t// document.querySelector('body').appendChild(canvas);\r\n\t\t\t}\r\n\t\t\tcanvas.width = W;\r\n\t\t\tcanvas.height = H;\r\n\t\t\tconst text = this.title_;\r\n\t\t\t// console.log('ModelProgressComponent.getCanvasTexture', text);\r\n\t\t\tconst ctx = canvas.getContext('2d');\r\n\t\t\t// const ctx = text.material.map.image.getContext('2d');\r\n\t\t\tctx.imageSmoothingEnabled = true;\r\n\t\t\tctx.imageSmoothingQuality = 'high';\r\n\t\t\tctx.font = `300 ${F}px ${environment.fontFamily}`;\r\n\t\t\tconst metrics = ctx.measureText(text);\r\n\t\t\tW = metrics.width + 8;\r\n\t\t\tW = Math.max(MIN_W, Math.pow(2, Math.ceil(Math.log(W) / Math.log(2))));\r\n\t\t\t// const x = W / 2;\r\n\t\t\t// const y = 16;\r\n\t\t\tcanvas.width = W;\r\n\t\t\tctx.clearRect(0, 0, W, H);\r\n\t\t\tctx.fillStyle = '#0000005A'; // 35% // '#000000C0'; // 75%\r\n\t\t\tctx.fillRect(0, 0, W, H);\r\n\t\t\tctx.font = `300 ${F}px ${environment.fontFamily}`;\r\n\t\t\tctx.textAlign = 'center';\r\n\t\t\tctx.textBaseline = 'middle';\r\n\t\t\tctx.strokeStyle = 'rgba(0, 0, 0, 0.35)';\r\n\t\t\tctx.lineWidth = L;\r\n\t\t\tctx.lineJoin = 'round'; // Experiment with \"bevel\" & \"round\" for the effect you want!\r\n\t\t\tctx.miterLimit = 2;\r\n\t\t\tctx.strokeText(text, W / 2, H / 2);\r\n\t\t\tctx.fillStyle = 'white';\r\n\t\t\tctx.fillText(text, W / 2, H / 2, W);\r\n\t\t\t// text.material.map.needsUpdate = true;\r\n\t\t\tlet texture;\r\n\t\t\tif (this.texture) {\r\n\t\t\t\ttexture = this.texture;\r\n\t\t\t\ttexture.needsUpdate = true;\r\n\t\t\t} else {\r\n\t\t\t\ttexture = this.texture = new THREE.CanvasTexture(canvas);\r\n\t\t\t}\r\n\t\t\t// console.log(F, L, W, H);\r\n\t\t\tresolve({ texture: texture, width: W, height: H });\r\n\t\t});\r\n\t}\r\n}\r\n\r\nModelProgressComponent.meta = {\r\n\tselector: '[model-progress]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['view'],\r\n};\r\n","import { environment } from '../../environment';\r\nimport MediaMesh from '../media/media-mesh';\r\nimport WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nconst USE_SHADOW = false;\r\n\r\nexport default class ModelRoomComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\tthis.progress = 0;\r\n\t\t// console.log('ModelRoomComponent.onInit');\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tthis.loadModel(environment.getPath(this.item.modelFolder), this.item.modelFile, (mesh) => {\r\n\t\t\tif (typeof mount === 'function') {\r\n\t\t\t\tmount(mesh);\r\n\t\t\t}\r\n\t\t\tthis.progress = 0;\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n\r\n\tgetLoader(path, file) {\r\n\t\tlet loader;\r\n\t\tif (file.indexOf('.fbx') !== -1) {\r\n\t\t\tloader = new THREE.FBXLoader();\r\n\t\t} else {\r\n\t\t\tloader = new THREE.GLTFLoader();\r\n\t\t}\r\n\t\tloader.setPath(path);\r\n\t\treturn loader;\r\n\t}\r\n\r\n\tloadModel(path, file, callback) {\r\n\t\t// const renderer = this.host.renderer;\r\n\t\t// const roughnessMipmapper = new RoughnessMipmapper(renderer); // optional\r\n\t\tconst loader = this.getLoader(path, file);\r\n\t\tloader.load(file, (model) => {\r\n\t\t\tlet mesh;\r\n\t\t\tconst scene = model.scene;\r\n\t\t\tif (scene) {\r\n\t\t\t\tmesh = scene;\r\n\t\t\t} else {\r\n\t\t\t\tmesh = model;\r\n\t\t\t}\r\n\t\t\tconst items = this.item.items;\r\n\t\t\tmesh.scale.set(0.05, 0.05, 0.05);\r\n\t\t\t// mesh.scale.set(10, 10, 10);\r\n\t\t\tmesh.traverse((child) => {\r\n\t\t\t\tif (child.isMesh) {\r\n\t\t\t\t\t// roughnessMipmapper.generateMipmaps(child.material);\r\n\t\t\t\t\tconst item = items.find(x => x.id === child.name);\r\n\t\t\t\t\tif (item) {\r\n\t\t\t\t\t\titem.mesh = child;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tif (USE_SHADOW) {\r\n\t\t\t\t\t\t\tchild.castShadow = true;\r\n\t\t\t\t\t\t\tchild.receiveShadow = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tchild.material.dispose();\r\n\t\t\t\t\t\t// child.renderOrder = environment.renderOrder.model;\r\n\t\t\t\t\t\tconst material = new THREE.MeshStandardMaterial({\r\n\t\t\t\t\t\t\tcolor: 0x111111,\r\n\t\t\t\t\t\t\troughness: 0.6,\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tchild.material = material;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tmesh.position.y = -1.66 * 3;\r\n\t\t\titems.forEach(item => {\r\n\t\t\t\tconst previous = item.mesh;\r\n\t\t\t\tif (previous) {\r\n\t\t\t\t\tif (previous.material) {\r\n\t\t\t\t\t\tprevious.material.color.setHex(0x000000);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst parent = previous.parent;\r\n\t\t\t\t\tconst mesh = item.mesh = new MediaMesh(item, items, previous.geometry);\r\n\t\t\t\t\tmesh.depthTest = false;\r\n\t\t\t\t\tmesh.renderOrder = 0;\r\n\t\t\t\t\tmesh.name = previous.name;\r\n\t\t\t\t\tmesh.position.copy(previous.position);\r\n\t\t\t\t\tmesh.rotation.copy(previous.rotation);\r\n\t\t\t\t\tmesh.scale.copy(previous.scale);\r\n\t\t\t\t\tmesh.load(() => {\r\n\t\t\t\t\t\t// mesh.material = new THREE.MeshStandardMaterial({ color: 0xff0000 });\r\n\t\t\t\t\t\tparent.add(mesh);\r\n\t\t\t\t\t\tparent.remove(previous);\r\n\t\t\t\t\t\tif (previous.material) {\r\n\t\t\t\t\t\t\tprevious.material.dispose();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('down', () => {\r\n\t\t\t\t\t\tconsole.log('ModelRoomComponent.down');\r\n\t\t\t\t\t\tthis.down.next(this);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tmesh.on('playing', (playing) => {\r\n\t\t\t\t\t\tconsole.log('ModelRoomComponent.playing', playing);\r\n\t\t\t\t\t\tthis.play.next({ itemId: item.id, playing });\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t\tconst lights = new Array(3).fill(0).map((x, i) => {\r\n\t\t\t\tconst light = new THREE.PointLight(0xffffff, 0.1, 1000, 2);\r\n\t\t\t\tif (USE_SHADOW) {\r\n\t\t\t\t\tlight.castShadow = true;\r\n\t\t\t\t\tlight.shadow.mapSize.width = 1024;\r\n\t\t\t\t\tlight.shadow.mapSize.height = 1024;\r\n\t\t\t\t\tlight.shadow.camera.near = 0.1;\r\n\t\t\t\t\tlight.shadow.camera.far = 500;\r\n\t\t\t\t}\r\n\t\t\t\tconst radians = Math.PI / 180 * 45 + Math.PI / 180 * 120 * i;\r\n\t\t\t\tlight.position.set(Math.cos(radians) * 5, 1, Math.sin(radians) * 5);\r\n\t\t\t\t/*\r\n\t\t\t\tconst helper = new THREE.PointLightHelper(light, 0.1);\r\n\t\t\t\tthis.group.add(helper);\r\n\t\t\t\t*/\r\n\t\t\t\tthis.group.add(light);\r\n\t\t\t\treturn light;\r\n\t\t\t});\r\n\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\tcallback(mesh);\r\n\t\t\t}\r\n\t\t\tthis.progress = 0;\r\n\t\t\tthis.pushChanges();\r\n\t\t\t// roughnessMipmapper.dispose();\r\n\t\t}, (progressEvent) => {\r\n\t\t\tif (progressEvent.lengthComputable) {\r\n\t\t\t\tthis.progress = Math.round(progressEvent.loaded / progressEvent.total * 100);\r\n\t\t\t} else {\r\n\t\t\t\tthis.progress = this.progress || 0;\r\n\t\t\t\tthis.progress = Math.min(100, this.progress + 1);\r\n\t\t\t}\r\n\t\t\t// console.log('progressEvent', progressEvent.loaded, progressEvent.total);\r\n\t\t\tthis.pushChanges();\r\n\t\t});\r\n\t}\r\n\r\n\tonDestroy() {\r\n\t\tsuper.onDestroy();\r\n\t\tconst item = this.item;\r\n\t\tif (item) {\r\n\t\t\tconst items = item.items;\r\n\t\t\tif (items) {\r\n\t\t\t\titems.forEach(item => {\r\n\t\t\t\t\tif (item.mesh) {\r\n\t\t\t\t\t\titem.mesh.dispose();\r\n\t\t\t\t\t\tdelete item.mesh;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n}\r\n\r\nModelRoomComponent.textures = {};\r\n\r\nModelRoomComponent.meta = {\r\n\tselector: '[model-room]',\r\n\thosts: { host: WorldComponent },\r\n\toutputs: ['down', 'play'],\r\n\tinputs: ['item'],\r\n};\r\n","import WorldComponent from '../world.component';\r\nimport ModelComponent from './model.component';\r\n\r\nexport default class ModelTextComponent extends ModelComponent {\r\n\r\n\tonInit() {\r\n\t\tsuper.onInit();\r\n\t\t// console.log('ModelTextComponent.onInit');\r\n\t}\r\n\r\n\tonCreate(mount, dismount) {\r\n\t\tconst mesh = new THREE.Group();\r\n\t\tif (typeof mount === 'function') {\r\n\t\t\tmount(mesh);\r\n\t\t}\r\n\t}\r\n\r\n\t// onView() { const context = getContext(this); }\r\n\r\n\t// onChanges() {}\r\n}\r\n\r\nModelTextComponent.meta = {\r\n\tselector: '[model-text]',\r\n\thosts: { host: WorldComponent },\r\n\tinputs: ['item'],\r\n};\r\n","import { CoreModule, Module } from 'rxcomp';\r\nimport { FormModule } from 'rxcomp-form';\r\nimport AccessCodeComponent from './access/access-code.component';\r\nimport AccessComponent from './access/access.component';\r\nimport AgoraChatComponent from './agora/agora-chat.component';\r\nimport AgoraCheckComponent from './agora/agora-check.component';\r\nimport AgoraChecklistComponent from './agora/agora-checklist.component';\r\nimport AgoraDevicePreviewComponent from './agora/agora-device-preview.component';\r\nimport AgoraDeviceComponent from './agora/agora-device.component';\r\nimport AgoraLinkComponent from './agora/agora-link.component';\r\nimport AgoraLoginComponent from './agora/agora-login.component';\r\nimport AgoraNameComponent from './agora/agora-name.component';\r\nimport AgoraStreamComponent from './agora/agora-stream.component';\r\nimport AgoraComponent from './agora/agora.component';\r\nimport AppComponent from './app.component';\r\nimport AssetPipe from './asset/asset.pipe';\r\nimport ControlRequestModalComponent from './control-request/control-request-modal.component';\r\nimport DropDirective from './drop/drop.directive';\r\nimport DropdownItemDirective from './dropdown/dropdown-item.directive';\r\nimport DropdownDirective from './dropdown/dropdown.directive';\r\nimport { EditorModule } from './editor/editor.module';\r\nimport FlagPipe from './flag/flag.pipe';\r\nimport ControlAssetComponent from './forms/control-asset.component';\r\nimport ControlAssetsComponent from './forms/control-assets.component';\r\nimport ControlCheckboxComponent from './forms/control-checkbox.component';\r\nimport ControlCustomSelectComponent from './forms/control-custom-select.component';\r\nimport ControlLinkComponent from './forms/control-link.component';\r\nimport ControlLocalizedAssetComponent from './forms/control-localized-asset.component';\r\nimport ControlMenuComponent from './forms/control-menu.component';\r\nimport ControlModelComponent from './forms/control-model.component';\r\nimport ControlNumberComponent from './forms/control-number.component';\r\nimport ControlPasswordComponent from './forms/control-password.component';\r\nimport ControlSelectComponent from './forms/control-select.component';\r\nimport ControlTextComponent from './forms/control-text.component';\r\nimport ControlTextareaComponent from './forms/control-textarea.component';\r\nimport ControlVectorComponent from './forms/control-vector.component';\r\nimport ControlsComponent from './forms/controls.component';\r\nimport DisabledDirective from './forms/disabled.directive';\r\nimport ErrorsComponent from './forms/errors.component';\r\nimport InputValueComponent from './forms/input-value.component';\r\nimport TestComponent from './forms/test.component';\r\nimport ValueDirective from './forms/value.directive';\r\nimport HtmlPipe from './html/html.pipe';\r\nimport IdDirective from './id/id.directive';\r\nimport LabelPipe from './label/label.pipe';\r\nimport LayoutComponent from './layout/layout.component';\r\nimport LazyDirective from './lazy/lazy.directive';\r\nimport ModalOutletComponent from './modal/modal-outlet.component';\r\nimport ModalComponent from './modal/modal.component';\r\nimport SlugPipe from './slug/slug.pipe';\r\nimport SvgIconStructure from './svg/svg-icon.structure';\r\nimport TryInARModalComponent from './try-in-ar/try-in-ar-modal.component';\r\nimport TryInARComponent from './try-in-ar/try-in-ar.component';\r\nimport UploadItemComponent from './upload/upload-item.component';\r\nimport HlsDirective from './video/hls.directive';\r\nimport VirtualStructure from './virtual/virtual.structure';\r\nimport ModelBannerComponent from './world/model/model-banner.component';\r\nimport ModelCurvedPlaneComponent from './world/model/model-curved-plane.component';\r\nimport ModelDebugComponent from './world/model/model-debug.component';\r\nimport ModelGridComponent from './world/model/model-grid.component';\r\nimport ModelMenuComponent from './world/model/model-menu.component';\r\nimport ModelModelComponent from './world/model/model-model.component';\r\nimport ModelNavComponent from './world/model/model-nav.component';\r\nimport ModelPanelComponent from './world/model/model-panel.component';\r\nimport ModelPictureComponent from './world/model/model-picture.component';\r\nimport ModelPlaneComponent from './world/model/model-plane.component';\r\nimport ModelProgressComponent from './world/model/model-progress.component';\r\nimport ModelRoomComponent from './world/model/model-room.component';\r\nimport ModelTextComponent from './world/model/model-text.component';\r\nimport ModelComponent from './world/model/model.component';\r\nimport WorldComponent from './world/world.component';\r\n\r\nexport class AppModule extends Module { }\r\n\r\nAppModule.meta = {\r\n\timports: [\r\n\t\tCoreModule,\r\n\t\tFormModule,\r\n\t\tEditorModule,\r\n\t],\r\n\tdeclarations: [\r\n\t\tAccessCodeComponent,\r\n\t\tAccessComponent,\r\n\t\tAgoraChatComponent,\r\n\t\tAgoraCheckComponent,\r\n\t\tAgoraChecklistComponent,\r\n\t\tAgoraComponent,\r\n\t\tAgoraDeviceComponent,\r\n\t\tAgoraDevicePreviewComponent,\r\n\t\tAgoraLinkComponent,\r\n\t\tAgoraLoginComponent,\r\n\t\tAgoraNameComponent,\r\n\t\tAgoraStreamComponent,\r\n\t\tAssetPipe,\r\n\t\tControlAssetComponent,\r\n\t\tControlAssetsComponent,\r\n\t\tControlCheckboxComponent,\r\n\t\tControlCustomSelectComponent,\r\n\t\tControlLinkComponent,\r\n\t\tControlLocalizedAssetComponent,\r\n\t\tControlMenuComponent,\r\n\t\tControlModelComponent,\r\n\t\tControlNumberComponent,\r\n\t\tControlPasswordComponent,\r\n\t\tControlRequestModalComponent,\r\n\t\tControlsComponent,\r\n\t\tControlSelectComponent,\r\n\t\tControlTextareaComponent,\r\n\t\tControlTextComponent,\r\n\t\tControlVectorComponent,\r\n\t\tDisabledDirective,\r\n\t\tDropDirective,\r\n\t\tDropdownDirective,\r\n\t\tDropdownItemDirective,\r\n\t\tErrorsComponent,\r\n\t\tFlagPipe,\r\n\t\tHlsDirective,\r\n\t\tHtmlPipe,\r\n\t\tIdDirective,\r\n\t\tInputValueComponent,\r\n\t\tLabelPipe,\r\n\t\tLayoutComponent,\r\n\t\tLazyDirective,\r\n\t\tModalComponent,\r\n\t\tModalOutletComponent,\r\n\t\tModelBannerComponent,\r\n\t\tModelComponent,\r\n\t\tModelCurvedPlaneComponent,\r\n\t\tModelDebugComponent,\r\n\t\tModelGridComponent,\r\n\t\tModelMenuComponent,\r\n\t\tModelModelComponent,\r\n\t\tModelNavComponent,\r\n\t\tModelPanelComponent,\r\n\t\tModelPictureComponent,\r\n\t\tModelPlaneComponent,\r\n\t\tModelProgressComponent,\r\n\t\tModelRoomComponent,\r\n\t\tModelTextComponent,\r\n\t\tSlugPipe,\r\n\t\tSvgIconStructure,\r\n\t\tTestComponent,\r\n\t\tTryInARComponent,\r\n\t\tTryInARModalComponent,\r\n\t\tUploadItemComponent,\r\n\t\tValueDirective,\r\n\t\tVirtualStructure,\r\n\t\tWorldComponent\r\n\t],\r\n\tbootstrap: AppComponent,\r\n};\r\n","import { Browser } from 'rxcomp';\r\nimport { AppModule } from './app.module';\r\n\r\nBrowser.bootstrap(AppModule);\r\n"]}